
(function(){
/* "use strict"; */
!function(m,k,l){"undefined"!=typeof module&&module.exports?module.exports=l():"function"==typeof define&&define.amd?define(k,l):m[k]=l()}(this,"bowser",function(){function m(b){function c(a){return(a=b.match(a))&&1<a.length&&a[1]||""}function h(a){return(a=b.match(a))&&1<a.length&&a[2]||""}function w(a){switch(a){case "NT":return"NT";case "XP":return"XP";case "NT 5.0":return"2000";case "NT 5.1":return"XP";case "NT 5.2":return"2003";case "NT 6.0":return"Vista";case "NT 6.1":return"7";case "NT 6.2":return"8";
case "NT 6.3":return"8.1";case "NT 10.0":return"10"}}var g=c(/(ipod|iphone|ipad)/i).toLowerCase(),d=!/like android/i.test(b)&&/android/i.test(b),l=/nexus\s*[0-6]\s*/i.test(b),m=!l&&/nexus\s*[0-9]+/i.test(b),a=/CrOS/.test(b),k=/silk/i.test(b),n=/sailfish/i.test(b),q=/tizen/i.test(b),r=/(web|hpw)os/i.test(b),t=/windows phone/i.test(b);/SamsungBrowser/i.test(b);var e=!t&&/windows/i.test(b),x=!g&&!k&&/macintosh/i.test(b),y=!d&&!n&&!q&&!r&&/linux/i.test(b),p=c(/edge\/(\d+(\.\d+)?)/i),f=c(/version\/(\d+(\.\d+)?)/i),
u=/tablet/i.test(b)&&!/tablet pc/i.test(b),v=!u&&/[^-]mobi/i.test(b),z=/xbox/i.test(b);/opera/i.test(b)?a={name:"Opera",opera:!0,version:f||c(/(?:opera|opr|opios)[\s\/](\d+(\.\d+)?)/i)}:/opr|opios/i.test(b)?a={name:"Opera",opera:!0,version:c(/(?:opr|opios)[\s\/](\d+(\.\d+)?)/i)||f}:/SamsungBrowser/i.test(b)?a={name:"Samsung Internet for Android",samsungBrowser:!0,version:f||c(/(?:SamsungBrowser)[\s\/](\d+(\.\d+)?)/i)}:/coast/i.test(b)?a={name:"Opera Coast",coast:!0,version:f||c(/(?:coast)[\s\/](\d+(\.\d+)?)/i)}:
/yabrowser/i.test(b)?a={name:"Yandex Browser",yandexbrowser:!0,version:f||c(/(?:yabrowser)[\s\/](\d+(\.\d+)?)/i)}:/ucbrowser/i.test(b)?a={name:"UC Browser",ucbrowser:!0,version:c(/(?:ucbrowser)[\s\/](\d+(?:\.\d+)+)/i)}:/mxios/i.test(b)?a={name:"Maxthon",maxthon:!0,version:c(/(?:mxios)[\s\/](\d+(?:\.\d+)+)/i)}:/epiphany/i.test(b)?a={name:"Epiphany",epiphany:!0,version:c(/(?:epiphany)[\s\/](\d+(?:\.\d+)+)/i)}:/puffin/i.test(b)?a={name:"Puffin",puffin:!0,version:c(/(?:puffin)[\s\/](\d+(?:\.\d+)?)/i)}:
/sleipnir/i.test(b)?a={name:"Sleipnir",sleipnir:!0,version:c(/(?:sleipnir)[\s\/](\d+(?:\.\d+)+)/i)}:/k-meleon/i.test(b)?a={name:"K-Meleon",kMeleon:!0,version:c(/(?:k-meleon)[\s\/](\d+(?:\.\d+)+)/i)}:t?(a={name:"Windows Phone",windowsphone:!0},p?(a.msedge=!0,a.version=p):(a.msie=!0,a.version=c(/iemobile\/(\d+(\.\d+)?)/i))):/msie|trident/i.test(b)?a={name:"Internet Explorer",msie:!0,version:c(/(?:msie |rv:)(\d+(\.\d+)?)/i)}:a?a={name:"Chrome",chromeos:!0,chromeBook:!0,chrome:!0,version:c(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:
/chrome.+? edge/i.test(b)?a={name:"Microsoft Edge",msedge:!0,version:p}:/vivaldi/i.test(b)?a={name:"Vivaldi",vivaldi:!0,version:c(/vivaldi\/(\d+(\.\d+)?)/i)||f}:n?a={name:"Sailfish",sailfish:!0,version:c(/sailfish\s?browser\/(\d+(\.\d+)?)/i)}:/seamonkey\//i.test(b)?a={name:"SeaMonkey",seamonkey:!0,version:c(/seamonkey\/(\d+(\.\d+)?)/i)}:/firefox|iceweasel|fxios/i.test(b)?(a={name:"Firefox",firefox:!0,version:c(/(?:firefox|iceweasel|fxios)[ \/](\d+(\.\d+)?)/i)},/\((mobile|tablet);[^\)]*rv:[\d\.]+\)/i.test(b)&&
(a.firefoxos=!0)):k?a={name:"Amazon Silk",silk:!0,version:c(/silk\/(\d+(\.\d+)?)/i)}:/phantom/i.test(b)?a={name:"PhantomJS",phantom:!0,version:c(/phantomjs\/(\d+(\.\d+)?)/i)}:/slimerjs/i.test(b)?a={name:"SlimerJS",slimer:!0,version:c(/slimerjs\/(\d+(\.\d+)?)/i)}:/blackberry|\bbb\d+/i.test(b)||/rim\stablet/i.test(b)?a={name:"BlackBerry",blackberry:!0,version:f||c(/blackberry[\d]+\/(\d+(\.\d+)?)/i)}:r?(a={name:"WebOS",webos:!0,version:f||c(/w(?:eb)?osbrowser\/(\d+(\.\d+)?)/i)},/touchpad\//i.test(b)&&
(a.touchpad=!0)):/bada/i.test(b)?a={name:"Bada",bada:!0,version:c(/dolfin\/(\d+(\.\d+)?)/i)}:q?a={name:"Tizen",tizen:!0,version:c(/(?:tizen\s?)?browser\/(\d+(\.\d+)?)/i)||f}:/qupzilla/i.test(b)?a={name:"QupZilla",qupzilla:!0,version:c(/(?:qupzilla)[\s\/](\d+(?:\.\d+)+)/i)||f}:/chromium/i.test(b)?a={name:"Chromium",chromium:!0,version:c(/(?:chromium)[\s\/](\d+(?:\.\d+)?)/i)||f}:/chrome|crios|crmo/i.test(b)?a={name:"Chrome",chrome:!0,version:c(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:d?a={name:"Android",
version:f}:/safari|applewebkit/i.test(b)?(a={name:"Safari",safari:!0},f&&(a.version=f)):g?(a={name:"iphone"==g?"iPhone":"ipad"==g?"iPad":"iPod"},f&&(a.version=f)):a=/googlebot/i.test(b)?{name:"Googlebot",googlebot:!0,version:c(/googlebot\/(\d+(\.\d+))/i)||f}:{name:c(/^(.*)\/(.*) /),version:h(/^(.*)\/(.*) /)};!a.msedge&&/(apple)?webkit/i.test(b)?(/(apple)?webkit\/537\.36/i.test(b)?(a.name=a.name||"Blink",a.blink=!0):(a.name=a.name||"Webkit",a.webkit=!0),!a.version&&f&&(a.version=f)):!a.opera&&/gecko\//i.test(b)&&
(a.name=a.name||"Gecko",a.gecko=!0,a.version=a.version||c(/gecko\/(\d+(\.\d+)?)/i));a.windowsphone||a.msedge||!d&&!a.silk?a.windowsphone||a.msedge||!g?x?a.mac=!0:z?a.xbox=!0:e?a.windows=!0:y&&(a.linux=!0):(a[g]=!0,a.ios=!0):a.android=!0;e="";a.windows?e=w(c(/Windows ((NT|XP)( \d\d?.\d)?)/i)):a.windowsphone?e=c(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i):a.mac?(e=c(/Mac OS X (\d+([_\.\s]\d+)*)/i),e=e.replace(/[_\s]/g,".")):g?(e=c(/os (\d+([_\s]\d+)*) like mac os x/i),e=e.replace(/[_\s]/g,".")):d?e=c(/android[ \/-](\d+(\.\d+)*)/i):
a.webos?e=c(/(?:web|hpw)os\/(\d+(\.\d+)*)/i):a.blackberry?e=c(/rim\stablet\sos\s(\d+(\.\d+)*)/i):a.bada?e=c(/bada\/(\d+(\.\d+)*)/i):a.tizen&&(e=c(/tizen[\/\s](\d+(\.\d+)*)/i));e&&(a.osversion=e);e=!a.windows&&e.split(".")[0];if(u||m||"ipad"==g||d&&(3==e||4<=e&&!v)||a.silk)a.tablet=!0;else if(v||"iphone"==g||"ipod"==g||d||l||a.blackberry||a.webos||a.bada)a.mobile=!0;a.msedge||a.msie&&10<=a.version||a.yandexbrowser&&15<=a.version||a.vivaldi&&1<=a.version||a.chrome&&20<=a.version||a.samsungBrowser&&
4<=a.version||a.firefox&&20<=a.version||a.safari&&6<=a.version||a.opera&&10<=a.version||a.ios&&a.osversion&&6<=a.osversion.split(".")[0]||a.blackberry&&10.1<=a.version||a.chromium&&20<=a.version?a.a=!0:a.msie&&10>a.version||a.chrome&&20>a.version||a.firefox&&20>a.version||a.safari&&6>a.version||a.opera&&10>a.version||a.ios&&a.osversion&&6>a.osversion.split(".")[0]||a.chromium&&20>a.version?a.c=!0:a.x=!0;return a}function k(b,c){var h=[],d;if(Array.prototype.map)return Array.prototype.map.call(b,c);
for(d=0;d<b.length;d++)h.push(c(b[d]));return h}function l(b){var c=Math.max(b[0].split(".").length,b[1].split(".").length);for(b=k(b,function(b){var d=c-b.split(".").length;b+=Array(d+1).join(".0");return k(b.split("."),function(b){return Array(20-b.length).join("0")+b}).reverse()});0<=--c;){if(b[0][c]>b[1][c])return 1;if(b[0][c]===b[1][c]){if(0===c)return 0}else return-1}}function n(b,c,h){var k=d;"string"===typeof c&&(h=c,c=void 0);void 0===c&&(c=!1);h&&(k=m(h));h=""+k.version;for(var g in b)if(b.hasOwnProperty(g)&&
k[g]){if("string"!==typeof b[g])throw Error("Browser version in the minVersion map should be a string: "+g+": "+String(b));return 0>l([h,b[g]])}return c}var d=m("undefined"!==typeof navigator?navigator.userAgent||"":"");d.test=function(b){for(var c=0;c<b.length;++c){var h=b[c];if("string"===typeof h&&h in d)return!0}return!1};d.isUnsupportedBrowser=n;d.compareVersions=l;d.check=function(b,c,d){return!n(b,c,d)};d._detect=m;return d});

!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.Promise=t()}}(function(){var t,e,n;return function r(t,e,n){function i(s,a){if(!e[s]){if(!t[s]){var c="function"==typeof _dereq_&&_dereq_;if(!a&&c)return c(s,!0);if(o)return o(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var u=e[s]={exports:{}};t[s][0].call(u.exports,function(e){var n=t[s][1][e];return i(n?n:e)},u,u.exports,r,t,e,n)}return e[s].exports}for(var o="function"==typeof _dereq_&&_dereq_,s=0;s<n.length;s++)i(n[s]);return i}({1:[function(t,e,n){"use strict";e.exports=function(t){function e(t){var e=new n(t),r=e.promise();return e.setHowMany(1),e.setUnwrap(),e.init(),r}var n=t._SomePromiseArray;t.any=function(t){return e(t)},t.prototype.any=function(){return e(this)}}},{}],2:[function(t,e,n){"use strict";function r(){this._customScheduler=!1,this._isTickUsed=!1,this._lateQueue=new u(16),this._normalQueue=new u(16),this._haveDrainedQueues=!1,this._trampolineEnabled=!0;var t=this;this.drainQueues=function(){t._drainQueues()},this._schedule=l}function i(t,e,n){this._lateQueue.push(t,e,n),this._queueTick()}function o(t,e,n){this._normalQueue.push(t,e,n),this._queueTick()}function s(t){this._normalQueue._pushOne(t),this._queueTick()}var a;try{throw new Error}catch(c){a=c}var l=t("./schedule"),u=t("./queue"),p=t("./util");r.prototype.setScheduler=function(t){var e=this._schedule;return this._schedule=t,this._customScheduler=!0,e},r.prototype.hasCustomScheduler=function(){return this._customScheduler},r.prototype.enableTrampoline=function(){this._trampolineEnabled=!0},r.prototype.disableTrampolineIfNecessary=function(){p.hasDevTools&&(this._trampolineEnabled=!1)},r.prototype.haveItemsQueued=function(){return this._isTickUsed||this._haveDrainedQueues},r.prototype.fatalError=function(t,e){e?(process.stderr.write("Fatal "+(t instanceof Error?t.stack:t)+"\n"),process.exit(2)):this.throwLater(t)},r.prototype.throwLater=function(t,e){if(1===arguments.length&&(e=t,t=function(){throw e}),"undefined"!=typeof setTimeout)setTimeout(function(){t(e)},0);else try{this._schedule(function(){t(e)})}catch(n){throw new Error("No async scheduler available\n\n    See http://goo.gl/MqrFmX\n")}},p.hasDevTools?(r.prototype.invokeLater=function(t,e,n){this._trampolineEnabled?i.call(this,t,e,n):this._schedule(function(){setTimeout(function(){t.call(e,n)},100)})},r.prototype.invoke=function(t,e,n){this._trampolineEnabled?o.call(this,t,e,n):this._schedule(function(){t.call(e,n)})},r.prototype.settlePromises=function(t){this._trampolineEnabled?s.call(this,t):this._schedule(function(){t._settlePromises()})}):(r.prototype.invokeLater=i,r.prototype.invoke=o,r.prototype.settlePromises=s),r.prototype._drainQueue=function(t){for(;t.length()>0;){var e=t.shift();if("function"==typeof e){var n=t.shift(),r=t.shift();e.call(n,r)}else e._settlePromises()}},r.prototype._drainQueues=function(){this._drainQueue(this._normalQueue),this._reset(),this._haveDrainedQueues=!0,this._drainQueue(this._lateQueue)},r.prototype._queueTick=function(){this._isTickUsed||(this._isTickUsed=!0,this._schedule(this.drainQueues))},r.prototype._reset=function(){this._isTickUsed=!1},e.exports=r,e.exports.firstLineError=a},{"./queue":26,"./schedule":29,"./util":36}],3:[function(t,e,n){"use strict";e.exports=function(t,e,n,r){var i=!1,o=function(t,e){this._reject(e)},s=function(t,e){e.promiseRejectionQueued=!0,e.bindingPromise._then(o,o,null,this,t)},a=function(t,e){0===(50397184&this._bitField)&&this._resolveCallback(e.target)},c=function(t,e){e.promiseRejectionQueued||this._reject(t)};t.prototype.bind=function(o){i||(i=!0,t.prototype._propagateFrom=r.propagateFromFunction(),t.prototype._boundValue=r.boundValueFunction());var l=n(o),u=new t(e);u._propagateFrom(this,1);var p=this._target();if(u._setBoundTo(l),l instanceof t){var h={promiseRejectionQueued:!1,promise:u,target:p,bindingPromise:l};p._then(e,s,void 0,u,h),l._then(a,c,void 0,u,h),u._setOnCancel(l)}else u._resolveCallback(p);return u},t.prototype._setBoundTo=function(t){void 0!==t?(this._bitField=2097152|this._bitField,this._boundTo=t):this._bitField=-2097153&this._bitField},t.prototype._isBound=function(){return 2097152===(2097152&this._bitField)},t.bind=function(e,n){return t.resolve(n).bind(e)}}},{}],4:[function(t,e,n){"use strict";function r(){try{Promise===o&&(Promise=i)}catch(t){}return o}var i;"undefined"!=typeof Promise&&(i=Promise);var o=t("./promise")();o.noConflict=r,e.exports=o},{"./promise":22}],5:[function(t,e,n){"use strict";var r=Object.create;if(r){var i=r(null),o=r(null);i[" size"]=o[" size"]=0}e.exports=function(e){function n(t,n){var r;if(null!=t&&(r=t[n]),"function"!=typeof r){var i="Object "+a.classString(t)+" has no method '"+a.toString(n)+"'";throw new e.TypeError(i)}return r}function r(t){var e=this.pop(),r=n(t,e);return r.apply(t,this)}function i(t){return t[this]}function o(t){var e=+this;return 0>e&&(e=Math.max(0,e+t.length)),t[e]}var s,a=t("./util"),c=a.canEvaluate;a.isIdentifier;e.prototype.call=function(t){var e=[].slice.call(arguments,1);return e.push(t),this._then(r,void 0,void 0,e,void 0)},e.prototype.get=function(t){var e,n="number"==typeof t;if(n)e=o;else if(c){var r=s(t);e=null!==r?r:i}else e=i;return this._then(e,void 0,void 0,t,void 0)}}},{"./util":36}],6:[function(t,e,n){"use strict";e.exports=function(e,n,r,i){var o=t("./util"),s=o.tryCatch,a=o.errorObj,c=e._async;e.prototype["break"]=e.prototype.cancel=function(){if(!i.cancellation())return this._warn("cancellation is disabled");for(var t=this,e=t;t._isCancellable();){if(!t._cancelBy(e)){e._isFollowing()?e._followee().cancel():e._cancelBranched();break}var n=t._cancellationParent;if(null==n||!n._isCancellable()){t._isFollowing()?t._followee().cancel():t._cancelBranched();break}t._isFollowing()&&t._followee().cancel(),t._setWillBeCancelled(),e=t,t=n}},e.prototype._branchHasCancelled=function(){this._branchesRemainingToCancel--},e.prototype._enoughBranchesHaveCancelled=function(){return void 0===this._branchesRemainingToCancel||this._branchesRemainingToCancel<=0},e.prototype._cancelBy=function(t){return t===this?(this._branchesRemainingToCancel=0,this._invokeOnCancel(),!0):(this._branchHasCancelled(),this._enoughBranchesHaveCancelled()?(this._invokeOnCancel(),!0):!1)},e.prototype._cancelBranched=function(){this._enoughBranchesHaveCancelled()&&this._cancel()},e.prototype._cancel=function(){this._isCancellable()&&(this._setCancelled(),c.invoke(this._cancelPromises,this,void 0))},e.prototype._cancelPromises=function(){this._length()>0&&this._settlePromises()},e.prototype._unsetOnCancel=function(){this._onCancelField=void 0},e.prototype._isCancellable=function(){return this.isPending()&&!this._isCancelled()},e.prototype.isCancellable=function(){return this.isPending()&&!this.isCancelled()},e.prototype._doInvokeOnCancel=function(t,e){if(o.isArray(t))for(var n=0;n<t.length;++n)this._doInvokeOnCancel(t[n],e);else if(void 0!==t)if("function"==typeof t){if(!e){var r=s(t).call(this._boundValue());r===a&&(this._attachExtraTrace(r.e),c.throwLater(r.e))}}else t._resultCancelled(this)},e.prototype._invokeOnCancel=function(){var t=this._onCancel();this._unsetOnCancel(),c.invoke(this._doInvokeOnCancel,this,t)},e.prototype._invokeInternalOnCancel=function(){this._isCancellable()&&(this._doInvokeOnCancel(this._onCancel(),!0),this._unsetOnCancel())},e.prototype._resultCancelled=function(){this.cancel()}}},{"./util":36}],7:[function(t,e,n){"use strict";e.exports=function(e){function n(t,n,a){return function(c){var l=a._boundValue();t:for(var u=0;u<t.length;++u){var p=t[u];if(p===Error||null!=p&&p.prototype instanceof Error){if(c instanceof p)return o(n).call(l,c)}else if("function"==typeof p){var h=o(p).call(l,c);if(h===s)return h;if(h)return o(n).call(l,c)}else if(r.isObject(c)){for(var f=i(p),_=0;_<f.length;++_){var d=f[_];if(p[d]!=c[d])continue t}return o(n).call(l,c)}}return e}}var r=t("./util"),i=t("./es5").keys,o=r.tryCatch,s=r.errorObj;return n}},{"./es5":13,"./util":36}],8:[function(t,e,n){"use strict";e.exports=function(t){function e(){this._trace=new e.CapturedTrace(r())}function n(){return i?new e:void 0}function r(){var t=o.length-1;return t>=0?o[t]:void 0}var i=!1,o=[];return t.prototype._promiseCreated=function(){},t.prototype._pushContext=function(){},t.prototype._popContext=function(){return null},t._peekContext=t.prototype._peekContext=function(){},e.prototype._pushContext=function(){void 0!==this._trace&&(this._trace._promiseCreated=null,o.push(this._trace))},e.prototype._popContext=function(){if(void 0!==this._trace){var t=o.pop(),e=t._promiseCreated;return t._promiseCreated=null,e}return null},e.CapturedTrace=null,e.create=n,e.deactivateLongStackTraces=function(){},e.activateLongStackTraces=function(){var n=t.prototype._pushContext,o=t.prototype._popContext,s=t._peekContext,a=t.prototype._peekContext,c=t.prototype._promiseCreated;e.deactivateLongStackTraces=function(){t.prototype._pushContext=n,t.prototype._popContext=o,t._peekContext=s,t.prototype._peekContext=a,t.prototype._promiseCreated=c,i=!1},i=!0,t.prototype._pushContext=e.prototype._pushContext,t.prototype._popContext=e.prototype._popContext,t._peekContext=t.prototype._peekContext=r,t.prototype._promiseCreated=function(){var t=this._peekContext();t&&null==t._promiseCreated&&(t._promiseCreated=this)}},e}},{}],9:[function(t,e,n){"use strict";e.exports=function(e,n){function r(t,e){return{promise:e}}function i(){return!1}function o(t,e,n){var r=this;try{t(e,n,function(t){if("function"!=typeof t)throw new TypeError("onCancel must be a function, got: "+H.toString(t));r._attachCancellationCallback(t)})}catch(i){return i}}function s(t){if(!this._isCancellable())return this;var e=this._onCancel();void 0!==e?H.isArray(e)?e.push(t):this._setOnCancel([e,t]):this._setOnCancel(t)}function a(){return this._onCancelField}function c(t){this._onCancelField=t}function l(){this._cancellationParent=void 0,this._onCancelField=void 0}function u(t,e){if(0!==(1&e)){this._cancellationParent=t;var n=t._branchesRemainingToCancel;void 0===n&&(n=0),t._branchesRemainingToCancel=n+1}0!==(2&e)&&t._isBound()&&this._setBoundTo(t._boundTo)}function p(t,e){0!==(2&e)&&t._isBound()&&this._setBoundTo(t._boundTo)}function h(){var t=this._boundTo;return void 0!==t&&t instanceof e?t.isFulfilled()?t.value():void 0:t}function f(){this._trace=new S(this._peekContext())}function _(t,e){if(N(t)){var n=this._trace;if(void 0!==n&&e&&(n=n._parent),void 0!==n)n.attachExtraTrace(t);else if(!t.__stackCleaned__){var r=j(t);H.notEnumerableProp(t,"stack",r.message+"\n"+r.stack.join("\n")),H.notEnumerableProp(t,"__stackCleaned__",!0)}}}function d(t,e,n,r,i){if(void 0===t&&null!==e&&W){if(void 0!==i&&i._returnedNonUndefined())return;if(0===(65535&r._bitField))return;n&&(n+=" ");var o="",s="";if(e._trace){for(var a=e._trace.stack.split("\n"),c=w(a),l=c.length-1;l>=0;--l){var u=c[l];if(!U.test(u)){var p=u.match(M);p&&(o="at "+p[1]+":"+p[2]+":"+p[3]+" ");break}}if(c.length>0)for(var h=c[0],l=0;l<a.length;++l)if(a[l]===h){l>0&&(s="\n"+a[l-1]);break}}var f="a promise was created in a "+n+"handler "+o+"but was not returned from it, see http://goo.gl/rRqMUw"+s;r._warn(f,!0,e)}}function v(t,e){var n=t+" is deprecated and will be removed in a future version.";return e&&(n+=" Use "+e+" instead."),y(n)}function y(t,n,r){if(ot.warnings){var i,o=new L(t);if(n)r._attachExtraTrace(o);else if(ot.longStackTraces&&(i=e._peekContext()))i.attachExtraTrace(o);else{var s=j(o);o.stack=s.message+"\n"+s.stack.join("\n")}tt("warning",o)||E(o,"",!0)}}function m(t,e){for(var n=0;n<e.length-1;++n)e[n].push("From previous event:"),e[n]=e[n].join("\n");return n<e.length&&(e[n]=e[n].join("\n")),t+"\n"+e.join("\n")}function g(t){for(var e=0;e<t.length;++e)(0===t[e].length||e+1<t.length&&t[e][0]===t[e+1][0])&&(t.splice(e,1),e--)}function b(t){for(var e=t[0],n=1;n<t.length;++n){for(var r=t[n],i=e.length-1,o=e[i],s=-1,a=r.length-1;a>=0;--a)if(r[a]===o){s=a;break}for(var a=s;a>=0;--a){var c=r[a];if(e[i]!==c)break;e.pop(),i--}e=r}}function w(t){for(var e=[],n=0;n<t.length;++n){var r=t[n],i="    (No stack trace)"===r||q.test(r),o=i&&nt(r);i&&!o&&($&&" "!==r.charAt(0)&&(r="    "+r),e.push(r))}return e}function C(t){for(var e=t.stack.replace(/\s+$/g,"").split("\n"),n=0;n<e.length;++n){var r=e[n];if("    (No stack trace)"===r||q.test(r))break}return n>0&&"SyntaxError"!=t.name&&(e=e.slice(n)),e}function j(t){var e=t.stack,n=t.toString();return e="string"==typeof e&&e.length>0?C(t):["    (No stack trace)"],{message:n,stack:"SyntaxError"==t.name?e:w(e)}}function E(t,e,n){if("undefined"!=typeof console){var r;if(H.isObject(t)){var i=t.stack;r=e+Q(i,t)}else r=e+String(t);"function"==typeof D?D(r,n):("function"==typeof console.log||"object"==typeof console.log)&&console.log(r)}}function k(t,e,n,r){var i=!1;try{"function"==typeof e&&(i=!0,"rejectionHandled"===t?e(r):e(n,r))}catch(o){I.throwLater(o)}"unhandledRejection"===t?tt(t,n,r)||i||E(n,"Unhandled rejection "):tt(t,r)}function F(t){var e;if("function"==typeof t)e="[function "+(t.name||"anonymous")+"]";else{e=t&&"function"==typeof t.toString?t.toString():H.toString(t);var n=/\[object [a-zA-Z0-9$_]+\]/;if(n.test(e))try{var r=JSON.stringify(t);e=r}catch(i){}0===e.length&&(e="(empty array)")}return"(<"+x(e)+">, no stack trace)"}function x(t){var e=41;return t.length<e?t:t.substr(0,e-3)+"..."}function T(){return"function"==typeof it}function P(t){var e=t.match(rt);return e?{fileName:e[1],line:parseInt(e[2],10)}:void 0}function R(t,e){if(T()){for(var n,r,i=t.stack.split("\n"),o=e.stack.split("\n"),s=-1,a=-1,c=0;c<i.length;++c){var l=P(i[c]);if(l){n=l.fileName,s=l.line;break}}for(var c=0;c<o.length;++c){var l=P(o[c]);if(l){r=l.fileName,a=l.line;break}}0>s||0>a||!n||!r||n!==r||s>=a||(nt=function(t){if(B.test(t))return!0;var e=P(t);return e&&e.fileName===n&&s<=e.line&&e.line<=a?!0:!1})}}function S(t){this._parent=t,this._promisesCreated=0;var e=this._length=1+(void 0===t?0:t._length);it(this,S),e>32&&this.uncycle()}var O,A,D,V=e._getDomain,I=e._async,L=t("./errors").Warning,H=t("./util"),N=H.canAttachTrace,B=/[\\\/]bluebird[\\\/]js[\\\/](release|debug|instrumented)/,U=/\((?:timers\.js):\d+:\d+\)/,M=/[\/<\(](.+?):(\d+):(\d+)\)?\s*$/,q=null,Q=null,$=!1,G=!(0==H.env("BLUEBIRD_DEBUG")||!H.env("BLUEBIRD_DEBUG")&&"development"!==H.env("NODE_ENV")),z=!(0==H.env("BLUEBIRD_WARNINGS")||!G&&!H.env("BLUEBIRD_WARNINGS")),X=!(0==H.env("BLUEBIRD_LONG_STACK_TRACES")||!G&&!H.env("BLUEBIRD_LONG_STACK_TRACES")),W=0!=H.env("BLUEBIRD_W_FORGOTTEN_RETURN")&&(z||!!H.env("BLUEBIRD_W_FORGOTTEN_RETURN"));e.prototype.suppressUnhandledRejections=function(){var t=this._target();t._bitField=-1048577&t._bitField|524288},e.prototype._ensurePossibleRejectionHandled=function(){0===(524288&this._bitField)&&(this._setRejectionIsUnhandled(),I.invokeLater(this._notifyUnhandledRejection,this,void 0))},e.prototype._notifyUnhandledRejectionIsHandled=function(){k("rejectionHandled",O,void 0,this)},e.prototype._setReturnedNonUndefined=function(){this._bitField=268435456|this._bitField},e.prototype._returnedNonUndefined=function(){return 0!==(268435456&this._bitField)},e.prototype._notifyUnhandledRejection=function(){if(this._isRejectionUnhandled()){var t=this._settledValue();this._setUnhandledRejectionIsNotified(),k("unhandledRejection",A,t,this)}},e.prototype._setUnhandledRejectionIsNotified=function(){this._bitField=262144|this._bitField},e.prototype._unsetUnhandledRejectionIsNotified=function(){this._bitField=-262145&this._bitField},e.prototype._isUnhandledRejectionNotified=function(){return(262144&this._bitField)>0},e.prototype._setRejectionIsUnhandled=function(){this._bitField=1048576|this._bitField},e.prototype._unsetRejectionIsUnhandled=function(){this._bitField=-1048577&this._bitField,this._isUnhandledRejectionNotified()&&(this._unsetUnhandledRejectionIsNotified(),this._notifyUnhandledRejectionIsHandled())},e.prototype._isRejectionUnhandled=function(){return(1048576&this._bitField)>0},e.prototype._warn=function(t,e,n){return y(t,e,n||this)},e.onPossiblyUnhandledRejection=function(t){var e=V();A="function"==typeof t?null===e?t:H.domainBind(e,t):void 0},e.onUnhandledRejectionHandled=function(t){var e=V();O="function"==typeof t?null===e?t:H.domainBind(e,t):void 0};var K=function(){};e.longStackTraces=function(){if(I.haveItemsQueued()&&!ot.longStackTraces)throw new Error("cannot enable long stack traces after promises have been created\n\n    See http://goo.gl/MqrFmX\n");if(!ot.longStackTraces&&T()){var t=e.prototype._captureStackTrace,r=e.prototype._attachExtraTrace;ot.longStackTraces=!0,K=function(){if(I.haveItemsQueued()&&!ot.longStackTraces)throw new Error("cannot enable long stack traces after promises have been created\n\n    See http://goo.gl/MqrFmX\n");e.prototype._captureStackTrace=t,e.prototype._attachExtraTrace=r,n.deactivateLongStackTraces(),I.enableTrampoline(),ot.longStackTraces=!1},e.prototype._captureStackTrace=f,e.prototype._attachExtraTrace=_,n.activateLongStackTraces(),I.disableTrampolineIfNecessary()}},e.hasLongStackTraces=function(){return ot.longStackTraces&&T()};var J=function(){try{if("function"==typeof CustomEvent){var t=new CustomEvent("CustomEvent");return H.global.dispatchEvent(t),function(t,e){var n=new CustomEvent(t.toLowerCase(),{detail:e,cancelable:!0});return!H.global.dispatchEvent(n)}}if("function"==typeof Event){var t=new Event("CustomEvent");return H.global.dispatchEvent(t),function(t,e){var n=new Event(t.toLowerCase(),{cancelable:!0});return n.detail=e,!H.global.dispatchEvent(n)}}var t=document.createEvent("CustomEvent");return t.initCustomEvent("testingtheevent",!1,!0,{}),H.global.dispatchEvent(t),function(t,e){var n=document.createEvent("CustomEvent");return n.initCustomEvent(t.toLowerCase(),!1,!0,e),!H.global.dispatchEvent(n)}}catch(e){}return function(){return!1}}(),Y=function(){return H.isNode?function(){return process.emit.apply(process,arguments)}:H.global?function(t){var e="on"+t.toLowerCase(),n=H.global[e];return n?(n.apply(H.global,[].slice.call(arguments,1)),!0):!1}:function(){return!1}}(),Z={promiseCreated:r,promiseFulfilled:r,promiseRejected:r,promiseResolved:r,promiseCancelled:r,promiseChained:function(t,e,n){return{promise:e,child:n}},warning:function(t,e){return{warning:e}},unhandledRejection:function(t,e,n){return{reason:e,promise:n}},rejectionHandled:r},tt=function(t){var e=!1;try{e=Y.apply(null,arguments)}catch(n){I.throwLater(n),e=!0}var r=!1;try{r=J(t,Z[t].apply(null,arguments))}catch(n){I.throwLater(n),r=!0}return r||e};e.config=function(t){if(t=Object(t),"longStackTraces"in t&&(t.longStackTraces?e.longStackTraces():!t.longStackTraces&&e.hasLongStackTraces()&&K()),"warnings"in t){var n=t.warnings;ot.warnings=!!n,W=ot.warnings,H.isObject(n)&&"wForgottenReturn"in n&&(W=!!n.wForgottenReturn)}if("cancellation"in t&&t.cancellation&&!ot.cancellation){if(I.haveItemsQueued())throw new Error("cannot enable cancellation after promises are in use");e.prototype._clearCancellationData=l,e.prototype._propagateFrom=u,e.prototype._onCancel=a,e.prototype._setOnCancel=c,e.prototype._attachCancellationCallback=s,e.prototype._execute=o,et=u,ot.cancellation=!0}return"monitoring"in t&&(t.monitoring&&!ot.monitoring?(ot.monitoring=!0,e.prototype._fireEvent=tt):!t.monitoring&&ot.monitoring&&(ot.monitoring=!1,e.prototype._fireEvent=i)),e},e.prototype._fireEvent=i,e.prototype._execute=function(t,e,n){try{t(e,n)}catch(r){return r}},e.prototype._onCancel=function(){},e.prototype._setOnCancel=function(t){},e.prototype._attachCancellationCallback=function(t){},e.prototype._captureStackTrace=function(){},e.prototype._attachExtraTrace=function(){},e.prototype._clearCancellationData=function(){},e.prototype._propagateFrom=function(t,e){};var et=p,nt=function(){return!1},rt=/[\/<\(]([^:\/]+):(\d+):(?:\d+)\)?\s*$/;H.inherits(S,Error),n.CapturedTrace=S,S.prototype.uncycle=function(){var t=this._length;if(!(2>t)){for(var e=[],n={},r=0,i=this;void 0!==i;++r)e.push(i),i=i._parent;t=this._length=r;for(var r=t-1;r>=0;--r){var o=e[r].stack;void 0===n[o]&&(n[o]=r)}for(var r=0;t>r;++r){var s=e[r].stack,a=n[s];if(void 0!==a&&a!==r){a>0&&(e[a-1]._parent=void 0,e[a-1]._length=1),e[r]._parent=void 0,e[r]._length=1;var c=r>0?e[r-1]:this;t-1>a?(c._parent=e[a+1],c._parent.uncycle(),c._length=c._parent._length+1):(c._parent=void 0,c._length=1);for(var l=c._length+1,u=r-2;u>=0;--u)e[u]._length=l,l++;return}}}},S.prototype.attachExtraTrace=function(t){if(!t.__stackCleaned__){this.uncycle();for(var e=j(t),n=e.message,r=[e.stack],i=this;void 0!==i;)r.push(w(i.stack.split("\n"))),i=i._parent;b(r),g(r),H.notEnumerableProp(t,"stack",m(n,r)),H.notEnumerableProp(t,"__stackCleaned__",!0)}};var it=function(){var t=/^\s*at\s*/,e=function(t,e){return"string"==typeof t?t:void 0!==e.name&&void 0!==e.message?e.toString():F(e)};if("number"==typeof Error.stackTraceLimit&&"function"==typeof Error.captureStackTrace){Error.stackTraceLimit+=6,q=t,Q=e;var n=Error.captureStackTrace;return nt=function(t){return B.test(t)},function(t,e){Error.stackTraceLimit+=6,n(t,e),Error.stackTraceLimit-=6}}var r=new Error;if("string"==typeof r.stack&&r.stack.split("\n")[0].indexOf("stackDetection@")>=0)return q=/@/,Q=e,$=!0,function(t){t.stack=(new Error).stack};var i;try{throw new Error}catch(o){i="stack"in o}return"stack"in r||!i||"number"!=typeof Error.stackTraceLimit?(Q=function(t,e){return"string"==typeof t?t:"object"!=typeof e&&"function"!=typeof e||void 0===e.name||void 0===e.message?F(e):e.toString()},null):(q=t,Q=e,function(t){Error.stackTraceLimit+=6;try{throw new Error}catch(e){t.stack=e.stack}Error.stackTraceLimit-=6})}([]);"undefined"!=typeof console&&"undefined"!=typeof console.warn&&(D=function(t){console.warn(t)},H.isNode&&process.stderr.isTTY?D=function(t,e){var n=e?"[33m":"[31m";console.warn(n+t+"[0m\n")}:H.isNode||"string"!=typeof(new Error).stack||(D=function(t,e){console.warn("%c"+t,e?"color: darkorange":"color: red")}));var ot={warnings:z,longStackTraces:!1,cancellation:!1,monitoring:!1};return X&&e.longStackTraces(),{longStackTraces:function(){return ot.longStackTraces},warnings:function(){return ot.warnings},cancellation:function(){return ot.cancellation},monitoring:function(){return ot.monitoring},propagateFromFunction:function(){return et},boundValueFunction:function(){return h},checkForgottenReturns:d,setBounds:R,warn:y,deprecated:v,CapturedTrace:S,fireDomEvent:J,fireGlobalEvent:Y}}},{"./errors":12,"./util":36}],10:[function(t,e,n){"use strict";e.exports=function(t){function e(){return this.value}function n(){throw this.reason}t.prototype["return"]=t.prototype.thenReturn=function(n){return n instanceof t&&n.suppressUnhandledRejections(),this._then(e,void 0,void 0,{value:n},void 0)},t.prototype["throw"]=t.prototype.thenThrow=function(t){return this._then(n,void 0,void 0,{reason:t},void 0)},t.prototype.catchThrow=function(t){if(arguments.length<=1)return this._then(void 0,n,void 0,{reason:t},void 0);var e=arguments[1],r=function(){throw e};return this.caught(t,r)},t.prototype.catchReturn=function(n){if(arguments.length<=1)return n instanceof t&&n.suppressUnhandledRejections(),this._then(void 0,e,void 0,{value:n},void 0);var r=arguments[1];r instanceof t&&r.suppressUnhandledRejections();var i=function(){return r};return this.caught(n,i)}}},{}],11:[function(t,e,n){"use strict";e.exports=function(t,e){function n(){return o(this)}function r(t,n){return i(t,n,e,e)}var i=t.reduce,o=t.all;t.prototype.each=function(t){return i(this,t,e,0)._then(n,void 0,void 0,this,void 0)},t.prototype.mapSeries=function(t){return i(this,t,e,e)},t.each=function(t,r){return i(t,r,e,0)._then(n,void 0,void 0,t,void 0)},t.mapSeries=r}},{}],12:[function(t,e,n){"use strict";function r(t,e){function n(r){return this instanceof n?(p(this,"message","string"==typeof r?r:e),p(this,"name",t),void(Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):Error.call(this))):new n(r)}return u(n,Error),n}function i(t){return this instanceof i?(p(this,"name","OperationalError"),p(this,"message",t),this.cause=t,this.isOperational=!0,void(t instanceof Error?(p(this,"message",t.message),p(this,"stack",t.stack)):Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor))):new i(t)}var o,s,a=t("./es5"),c=a.freeze,l=t("./util"),u=l.inherits,p=l.notEnumerableProp,h=r("Warning","warning"),f=r("CancellationError","cancellation error"),_=r("TimeoutError","timeout error"),d=r("AggregateError","aggregate error");try{o=TypeError,s=RangeError}catch(v){o=r("TypeError","type error"),s=r("RangeError","range error")}for(var y="join pop push shift unshift slice filter forEach some every map indexOf lastIndexOf reduce reduceRight sort reverse".split(" "),m=0;m<y.length;++m)"function"==typeof Array.prototype[y[m]]&&(d.prototype[y[m]]=Array.prototype[y[m]]);a.defineProperty(d.prototype,"length",{value:0,configurable:!1,writable:!0,enumerable:!0}),d.prototype.isOperational=!0;var g=0;d.prototype.toString=function(){var t=Array(4*g+1).join(" "),e="\n"+t+"AggregateError of:\n";g++,t=Array(4*g+1).join(" ");for(var n=0;n<this.length;++n){for(var r=this[n]===this?"[Circular AggregateError]":this[n]+"",i=r.split("\n"),o=0;o<i.length;++o)i[o]=t+i[o];r=i.join("\n"),e+=r+"\n"}return g--,e},u(i,Error);var b=Error.__BluebirdErrorTypes__;b||(b=c({CancellationError:f,TimeoutError:_,OperationalError:i,RejectionError:i,AggregateError:d}),a.defineProperty(Error,"__BluebirdErrorTypes__",{value:b,writable:!1,enumerable:!1,configurable:!1})),e.exports={Error:Error,TypeError:o,RangeError:s,CancellationError:b.CancellationError,OperationalError:b.OperationalError,TimeoutError:b.TimeoutError,AggregateError:b.AggregateError,Warning:h}},{"./es5":13,"./util":36}],13:[function(t,e,n){var r=function(){"use strict";return void 0===this}();if(r)e.exports={freeze:Object.freeze,defineProperty:Object.defineProperty,getDescriptor:Object.getOwnPropertyDescriptor,keys:Object.keys,names:Object.getOwnPropertyNames,getPrototypeOf:Object.getPrototypeOf,isArray:Array.isArray,isES5:r,propertyIsWritable:function(t,e){var n=Object.getOwnPropertyDescriptor(t,e);return!(n&&!n.writable&&!n.set)}};else{var i={}.hasOwnProperty,o={}.toString,s={}.constructor.prototype,a=function(t){var e=[];for(var n in t)i.call(t,n)&&e.push(n);return e},c=function(t,e){return{value:t[e]}},l=function(t,e,n){return t[e]=n.value,t},u=function(t){return t},p=function(t){try{return Object(t).constructor.prototype}catch(e){return s}},h=function(t){try{return"[object Array]"===o.call(t)}catch(e){return!1}};e.exports={isArray:h,keys:a,names:a,defineProperty:l,getDescriptor:c,freeze:u,getPrototypeOf:p,isES5:r,propertyIsWritable:function(){return!0}}}},{}],14:[function(t,e,n){"use strict";e.exports=function(t,e){var n=t.map;t.prototype.filter=function(t,r){return n(this,t,r,e)},t.filter=function(t,r,i){return n(t,r,i,e)}}},{}],15:[function(t,e,n){"use strict";e.exports=function(e,n,r){function i(t,e,n){this.promise=t,this.type=e,this.handler=n,this.called=!1,this.cancelPromise=null}function o(t){this.finallyHandler=t}function s(t,e){return null!=t.cancelPromise?(arguments.length>1?t.cancelPromise._reject(e):t.cancelPromise._cancel(),t.cancelPromise=null,!0):!1}function a(){return l.call(this,this.promise._target()._settledValue())}function c(t){return s(this,t)?void 0:(h.e=t,h)}function l(t){var i=this.promise,l=this.handler;if(!this.called){this.called=!0;var u=this.isFinallyHandler()?l.call(i._boundValue()):l.call(i._boundValue(),t);if(u===r)return u;if(void 0!==u){i._setReturnedNonUndefined();var f=n(u,i);if(f instanceof e){if(null!=this.cancelPromise){if(f._isCancelled()){var _=new p("late cancellation observer");return i._attachExtraTrace(_),h.e=_,h}f.isPending()&&f._attachCancellationCallback(new o(this))}return f._then(a,c,void 0,this,void 0)}}}return i.isRejected()?(s(this),h.e=t,h):(s(this),t)}var u=t("./util"),p=e.CancellationError,h=u.errorObj,f=t("./catch_filter")(r);return i.prototype.isFinallyHandler=function(){return 0===this.type},o.prototype._resultCancelled=function(){s(this.finallyHandler)},e.prototype._passThrough=function(t,e,n,r){return"function"!=typeof t?this.then():this._then(n,r,void 0,new i(this,e,t),void 0)},e.prototype.lastly=e.prototype["finally"]=function(t){return this._passThrough(t,0,l,l)},e.prototype.tap=function(t){return this._passThrough(t,1,l)},e.prototype.tapCatch=function(t){var n=arguments.length;if(1===n)return this._passThrough(t,1,void 0,l);var r,i=new Array(n-1),o=0;for(r=0;n-1>r;++r){var s=arguments[r];if(!u.isObject(s))return e.reject(new TypeError("tapCatch statement predicate: expecting an object but got "+u.classString(s)));i[o++]=s}i.length=o;var a=arguments[r];return this._passThrough(f(i,a,this),1,void 0,l)},i}},{"./catch_filter":7,"./util":36}],16:[function(t,e,n){"use strict";e.exports=function(e,n,r,i,o,s){function a(t,n,r){for(var o=0;o<n.length;++o){r._pushContext();var s=f(n[o])(t);if(r._popContext(),s===h){r._pushContext();var a=e.reject(h.e);return r._popContext(),a}var c=i(s,r);if(c instanceof e)return c}return null}function c(t,n,i,o){if(s.cancellation()){var a=new e(r),c=this._finallyPromise=new e(r);this._promise=a.lastly(function(){return c}),a._captureStackTrace(),a._setOnCancel(this)}else{var l=this._promise=new e(r);l._captureStackTrace()}this._stack=o,this._generatorFunction=t,this._receiver=n,this._generator=void 0,this._yieldHandlers="function"==typeof i?[i].concat(_):_,this._yieldedPromise=null,this._cancellationPhase=!1}var l=t("./errors"),u=l.TypeError,p=t("./util"),h=p.errorObj,f=p.tryCatch,_=[];p.inherits(c,o),c.prototype._isResolved=function(){return null===this._promise},c.prototype._cleanup=function(){this._promise=this._generator=null,s.cancellation()&&null!==this._finallyPromise&&(this._finallyPromise._fulfill(),this._finallyPromise=null)},c.prototype._promiseCancelled=function(){if(!this._isResolved()){var t,n="undefined"!=typeof this._generator["return"];if(n)this._promise._pushContext(),t=f(this._generator["return"]).call(this._generator,void 0),this._promise._popContext();else{var r=new e.CancellationError("generator .return() sentinel");e.coroutine.returnSentinel=r,this._promise._attachExtraTrace(r),this._promise._pushContext(),t=f(this._generator["throw"]).call(this._generator,r),this._promise._popContext()}this._cancellationPhase=!0,this._yieldedPromise=null,this._continue(t)}},c.prototype._promiseFulfilled=function(t){this._yieldedPromise=null,this._promise._pushContext();var e=f(this._generator.next).call(this._generator,t);this._promise._popContext(),this._continue(e)},c.prototype._promiseRejected=function(t){this._yieldedPromise=null,this._promise._attachExtraTrace(t),this._promise._pushContext();var e=f(this._generator["throw"]).call(this._generator,t);this._promise._popContext(),this._continue(e)},c.prototype._resultCancelled=function(){if(this._yieldedPromise instanceof e){var t=this._yieldedPromise;this._yieldedPromise=null,t.cancel()}},c.prototype.promise=function(){return this._promise},c.prototype._run=function(){this._generator=this._generatorFunction.call(this._receiver),this._receiver=this._generatorFunction=void 0,this._promiseFulfilled(void 0)},c.prototype._continue=function(t){var n=this._promise;if(t===h)return this._cleanup(),this._cancellationPhase?n.cancel():n._rejectCallback(t.e,!1);var r=t.value;if(t.done===!0)return this._cleanup(),this._cancellationPhase?n.cancel():n._resolveCallback(r);var o=i(r,this._promise);if(!(o instanceof e)&&(o=a(o,this._yieldHandlers,this._promise),null===o))return void this._promiseRejected(new u("A value %s was yielded that could not be treated as a promise\n\n    See http://goo.gl/MqrFmX\n\n".replace("%s",String(r))+"From coroutine:\n"+this._stack.split("\n").slice(1,-7).join("\n")));o=o._target();var s=o._bitField;0===(50397184&s)?(this._yieldedPromise=o,o._proxy(this,null)):0!==(33554432&s)?e._async.invoke(this._promiseFulfilled,this,o._value()):0!==(16777216&s)?e._async.invoke(this._promiseRejected,this,o._reason()):this._promiseCancelled();
},e.coroutine=function(t,e){if("function"!=typeof t)throw new u("generatorFunction must be a function\n\n    See http://goo.gl/MqrFmX\n");var n=Object(e).yieldHandler,r=c,i=(new Error).stack;return function(){var e=t.apply(this,arguments),o=new r(void 0,void 0,n,i),s=o.promise();return o._generator=e,o._promiseFulfilled(void 0),s}},e.coroutine.addYieldHandler=function(t){if("function"!=typeof t)throw new u("expecting a function but got "+p.classString(t));_.push(t)},e.spawn=function(t){if(s.deprecated("Promise.spawn()","Promise.coroutine()"),"function"!=typeof t)return n("generatorFunction must be a function\n\n    See http://goo.gl/MqrFmX\n");var r=new c(t,this),i=r.promise();return r._run(e.spawn),i}}},{"./errors":12,"./util":36}],17:[function(t,e,n){"use strict";e.exports=function(e,n,r,i,o,s){var a=t("./util");a.canEvaluate,a.tryCatch,a.errorObj;e.join=function(){var t,e=arguments.length-1;if(e>0&&"function"==typeof arguments[e]){t=arguments[e];var r}var i=[].slice.call(arguments);t&&i.pop();var r=new n(i).promise();return void 0!==t?r.spread(t):r}}},{"./util":36}],18:[function(t,e,n){"use strict";e.exports=function(e,n,r,i,o,s){function a(t,e,n,r){this.constructor$(t),this._promise._captureStackTrace();var i=l();this._callback=null===i?e:u.domainBind(i,e),this._preservedValues=r===o?new Array(this.length()):null,this._limit=n,this._inFlight=0,this._queue=[],f.invoke(this._asyncInit,this,void 0)}function c(t,n,i,o){if("function"!=typeof n)return r("expecting a function but got "+u.classString(n));var s=0;if(void 0!==i){if("object"!=typeof i||null===i)return e.reject(new TypeError("options argument must be an object but it is "+u.classString(i)));if("number"!=typeof i.concurrency)return e.reject(new TypeError("'concurrency' must be a number but it is "+u.classString(i.concurrency)));s=i.concurrency}return s="number"==typeof s&&isFinite(s)&&s>=1?s:0,new a(t,n,s,o).promise()}var l=e._getDomain,u=t("./util"),p=u.tryCatch,h=u.errorObj,f=e._async;u.inherits(a,n),a.prototype._asyncInit=function(){this._init$(void 0,-2)},a.prototype._init=function(){},a.prototype._promiseFulfilled=function(t,n){var r=this._values,o=this.length(),a=this._preservedValues,c=this._limit;if(0>n){if(n=-1*n-1,r[n]=t,c>=1&&(this._inFlight--,this._drainQueue(),this._isResolved()))return!0}else{if(c>=1&&this._inFlight>=c)return r[n]=t,this._queue.push(n),!1;null!==a&&(a[n]=t);var l=this._promise,u=this._callback,f=l._boundValue();l._pushContext();var _=p(u).call(f,t,n,o),d=l._popContext();if(s.checkForgottenReturns(_,d,null!==a?"Promise.filter":"Promise.map",l),_===h)return this._reject(_.e),!0;var v=i(_,this._promise);if(v instanceof e){v=v._target();var y=v._bitField;if(0===(50397184&y))return c>=1&&this._inFlight++,r[n]=v,v._proxy(this,-1*(n+1)),!1;if(0===(33554432&y))return 0!==(16777216&y)?(this._reject(v._reason()),!0):(this._cancel(),!0);_=v._value()}r[n]=_}var m=++this._totalResolved;return m>=o?(null!==a?this._filter(r,a):this._resolve(r),!0):!1},a.prototype._drainQueue=function(){for(var t=this._queue,e=this._limit,n=this._values;t.length>0&&this._inFlight<e;){if(this._isResolved())return;var r=t.pop();this._promiseFulfilled(n[r],r)}},a.prototype._filter=function(t,e){for(var n=e.length,r=new Array(n),i=0,o=0;n>o;++o)t[o]&&(r[i++]=e[o]);r.length=i,this._resolve(r)},a.prototype.preservedValues=function(){return this._preservedValues},e.prototype.map=function(t,e){return c(this,t,e,null)},e.map=function(t,e,n,r){return c(t,e,n,r)}}},{"./util":36}],19:[function(t,e,n){"use strict";e.exports=function(e,n,r,i,o){var s=t("./util"),a=s.tryCatch;e.method=function(t){if("function"!=typeof t)throw new e.TypeError("expecting a function but got "+s.classString(t));return function(){var r=new e(n);r._captureStackTrace(),r._pushContext();var i=a(t).apply(this,arguments),s=r._popContext();return o.checkForgottenReturns(i,s,"Promise.method",r),r._resolveFromSyncValue(i),r}},e.attempt=e["try"]=function(t){if("function"!=typeof t)return i("expecting a function but got "+s.classString(t));var r=new e(n);r._captureStackTrace(),r._pushContext();var c;if(arguments.length>1){o.deprecated("calling Promise.try with more than 1 argument");var l=arguments[1],u=arguments[2];c=s.isArray(l)?a(t).apply(u,l):a(t).call(u,l)}else c=a(t)();var p=r._popContext();return o.checkForgottenReturns(c,p,"Promise.try",r),r._resolveFromSyncValue(c),r},e.prototype._resolveFromSyncValue=function(t){t===s.errorObj?this._rejectCallback(t.e,!1):this._resolveCallback(t,!0)}}},{"./util":36}],20:[function(t,e,n){"use strict";function r(t){return t instanceof Error&&u.getPrototypeOf(t)===Error.prototype}function i(t){var e;if(r(t)){e=new l(t),e.name=t.name,e.message=t.message,e.stack=t.stack;for(var n=u.keys(t),i=0;i<n.length;++i){var o=n[i];p.test(o)||(e[o]=t[o])}return e}return s.markAsOriginatingFromRejection(t),t}function o(t,e){return function(n,r){if(null!==t){if(n){var o=i(a(n));t._attachExtraTrace(o),t._reject(o)}else if(e){var s=[].slice.call(arguments,1);t._fulfill(s)}else t._fulfill(r);t=null}}}var s=t("./util"),a=s.maybeWrapAsError,c=t("./errors"),l=c.OperationalError,u=t("./es5"),p=/^(?:name|message|stack|cause)$/;e.exports=o},{"./errors":12,"./es5":13,"./util":36}],21:[function(t,e,n){"use strict";e.exports=function(e){function n(t,e){var n=this;if(!o.isArray(t))return r.call(n,t,e);var i=a(e).apply(n._boundValue(),[null].concat(t));i===c&&s.throwLater(i.e)}function r(t,e){var n=this,r=n._boundValue(),i=void 0===t?a(e).call(r,null):a(e).call(r,null,t);i===c&&s.throwLater(i.e)}function i(t,e){var n=this;if(!t){var r=new Error(t+"");r.cause=t,t=r}var i=a(e).call(n._boundValue(),t);i===c&&s.throwLater(i.e)}var o=t("./util"),s=e._async,a=o.tryCatch,c=o.errorObj;e.prototype.asCallback=e.prototype.nodeify=function(t,e){if("function"==typeof t){var o=r;void 0!==e&&Object(e).spread&&(o=n),this._then(o,i,void 0,this,t)}return this}}},{"./util":36}],22:[function(t,e,n){"use strict";e.exports=function(){function n(){}function r(t,e){if(null==t||t.constructor!==i)throw new m("the promise constructor cannot be invoked directly\n\n    See http://goo.gl/MqrFmX\n");if("function"!=typeof e)throw new m("expecting a function but got "+f.classString(e))}function i(t){t!==b&&r(this,t),this._bitField=0,this._fulfillmentHandler0=void 0,this._rejectionHandler0=void 0,this._promise0=void 0,this._receiver0=void 0,this._resolveFromExecutor(t),this._promiseCreated(),this._fireEvent("promiseCreated",this)}function o(t){this.promise._resolveCallback(t)}function s(t){this.promise._rejectCallback(t,!1)}function a(t){var e=new i(b);e._fulfillmentHandler0=t,e._rejectionHandler0=t,e._promise0=t,e._receiver0=t}var c,l=function(){return new m("circular promise resolution chain\n\n    See http://goo.gl/MqrFmX\n")},u=function(){return new i.PromiseInspection(this._target())},p=function(t){return i.reject(new m(t))},h={},f=t("./util");c=f.isNode?function(){var t=process.domain;return void 0===t&&(t=null),t}:function(){return null},f.notEnumerableProp(i,"_getDomain",c);var _=t("./es5"),d=t("./async"),v=new d;_.defineProperty(i,"_async",{value:v});var y=t("./errors"),m=i.TypeError=y.TypeError;i.RangeError=y.RangeError;var g=i.CancellationError=y.CancellationError;i.TimeoutError=y.TimeoutError,i.OperationalError=y.OperationalError,i.RejectionError=y.OperationalError,i.AggregateError=y.AggregateError;var b=function(){},w={},C={},j=t("./thenables")(i,b),E=t("./promise_array")(i,b,j,p,n),k=t("./context")(i),F=k.create,x=t("./debuggability")(i,k),T=(x.CapturedTrace,t("./finally")(i,j,C)),P=t("./catch_filter")(C),R=t("./nodeback"),S=f.errorObj,O=f.tryCatch;return i.prototype.toString=function(){return"[object Promise]"},i.prototype.caught=i.prototype["catch"]=function(t){var e=arguments.length;if(e>1){var n,r=new Array(e-1),i=0;for(n=0;e-1>n;++n){var o=arguments[n];if(!f.isObject(o))return p("Catch statement predicate: expecting an object but got "+f.classString(o));r[i++]=o}return r.length=i,t=arguments[n],this.then(void 0,P(r,t,this))}return this.then(void 0,t)},i.prototype.reflect=function(){return this._then(u,u,void 0,this,void 0)},i.prototype.then=function(t,e){if(x.warnings()&&arguments.length>0&&"function"!=typeof t&&"function"!=typeof e){var n=".then() only accepts functions but was passed: "+f.classString(t);arguments.length>1&&(n+=", "+f.classString(e)),this._warn(n)}return this._then(t,e,void 0,void 0,void 0)},i.prototype.done=function(t,e){var n=this._then(t,e,void 0,void 0,void 0);n._setIsFinal()},i.prototype.spread=function(t){return"function"!=typeof t?p("expecting a function but got "+f.classString(t)):this.all()._then(t,void 0,void 0,w,void 0)},i.prototype.toJSON=function(){var t={isFulfilled:!1,isRejected:!1,fulfillmentValue:void 0,rejectionReason:void 0};return this.isFulfilled()?(t.fulfillmentValue=this.value(),t.isFulfilled=!0):this.isRejected()&&(t.rejectionReason=this.reason(),t.isRejected=!0),t},i.prototype.all=function(){return arguments.length>0&&this._warn(".all() was passed arguments but it does not take any"),new E(this).promise()},i.prototype.error=function(t){return this.caught(f.originatesFromRejection,t)},i.getNewLibraryCopy=e.exports,i.is=function(t){return t instanceof i},i.fromNode=i.fromCallback=function(t){var e=new i(b);e._captureStackTrace();var n=arguments.length>1?!!Object(arguments[1]).multiArgs:!1,r=O(t)(R(e,n));return r===S&&e._rejectCallback(r.e,!0),e._isFateSealed()||e._setAsyncGuaranteed(),e},i.all=function(t){return new E(t).promise()},i.cast=function(t){var e=j(t);return e instanceof i||(e=new i(b),e._captureStackTrace(),e._setFulfilled(),e._rejectionHandler0=t),e},i.resolve=i.fulfilled=i.cast,i.reject=i.rejected=function(t){var e=new i(b);return e._captureStackTrace(),e._rejectCallback(t,!0),e},i.setScheduler=function(t){if("function"!=typeof t)throw new m("expecting a function but got "+f.classString(t));return v.setScheduler(t)},i.prototype._then=function(t,e,n,r,o){var s=void 0!==o,a=s?o:new i(b),l=this._target(),u=l._bitField;s||(a._propagateFrom(this,3),a._captureStackTrace(),void 0===r&&0!==(2097152&this._bitField)&&(r=0!==(50397184&u)?this._boundValue():l===this?void 0:this._boundTo),this._fireEvent("promiseChained",this,a));var p=c();if(0!==(50397184&u)){var h,_,d=l._settlePromiseCtx;0!==(33554432&u)?(_=l._rejectionHandler0,h=t):0!==(16777216&u)?(_=l._fulfillmentHandler0,h=e,l._unsetRejectionIsUnhandled()):(d=l._settlePromiseLateCancellationObserver,_=new g("late cancellation observer"),l._attachExtraTrace(_),h=e),v.invoke(d,l,{handler:null===p?h:"function"==typeof h&&f.domainBind(p,h),promise:a,receiver:r,value:_})}else l._addCallbacks(t,e,a,r,p);return a},i.prototype._length=function(){return 65535&this._bitField},i.prototype._isFateSealed=function(){return 0!==(117506048&this._bitField)},i.prototype._isFollowing=function(){return 67108864===(67108864&this._bitField)},i.prototype._setLength=function(t){this._bitField=-65536&this._bitField|65535&t},i.prototype._setFulfilled=function(){this._bitField=33554432|this._bitField,this._fireEvent("promiseFulfilled",this)},i.prototype._setRejected=function(){this._bitField=16777216|this._bitField,this._fireEvent("promiseRejected",this)},i.prototype._setFollowing=function(){this._bitField=67108864|this._bitField,this._fireEvent("promiseResolved",this)},i.prototype._setIsFinal=function(){this._bitField=4194304|this._bitField},i.prototype._isFinal=function(){return(4194304&this._bitField)>0},i.prototype._unsetCancelled=function(){this._bitField=-65537&this._bitField},i.prototype._setCancelled=function(){this._bitField=65536|this._bitField,this._fireEvent("promiseCancelled",this)},i.prototype._setWillBeCancelled=function(){this._bitField=8388608|this._bitField},i.prototype._setAsyncGuaranteed=function(){v.hasCustomScheduler()||(this._bitField=134217728|this._bitField)},i.prototype._receiverAt=function(t){var e=0===t?this._receiver0:this[4*t-4+3];return e===h?void 0:void 0===e&&this._isBound()?this._boundValue():e},i.prototype._promiseAt=function(t){return this[4*t-4+2]},i.prototype._fulfillmentHandlerAt=function(t){return this[4*t-4+0]},i.prototype._rejectionHandlerAt=function(t){return this[4*t-4+1]},i.prototype._boundValue=function(){},i.prototype._migrateCallback0=function(t){var e=(t._bitField,t._fulfillmentHandler0),n=t._rejectionHandler0,r=t._promise0,i=t._receiverAt(0);void 0===i&&(i=h),this._addCallbacks(e,n,r,i,null)},i.prototype._migrateCallbackAt=function(t,e){var n=t._fulfillmentHandlerAt(e),r=t._rejectionHandlerAt(e),i=t._promiseAt(e),o=t._receiverAt(e);void 0===o&&(o=h),this._addCallbacks(n,r,i,o,null)},i.prototype._addCallbacks=function(t,e,n,r,i){var o=this._length();if(o>=65531&&(o=0,this._setLength(0)),0===o)this._promise0=n,this._receiver0=r,"function"==typeof t&&(this._fulfillmentHandler0=null===i?t:f.domainBind(i,t)),"function"==typeof e&&(this._rejectionHandler0=null===i?e:f.domainBind(i,e));else{var s=4*o-4;this[s+2]=n,this[s+3]=r,"function"==typeof t&&(this[s+0]=null===i?t:f.domainBind(i,t)),"function"==typeof e&&(this[s+1]=null===i?e:f.domainBind(i,e))}return this._setLength(o+1),o},i.prototype._proxy=function(t,e){this._addCallbacks(void 0,void 0,e,t,null)},i.prototype._resolveCallback=function(t,e){if(0===(117506048&this._bitField)){if(t===this)return this._rejectCallback(l(),!1);var n=j(t,this);if(!(n instanceof i))return this._fulfill(t);e&&this._propagateFrom(n,2);var r=n._target();if(r===this)return void this._reject(l());var o=r._bitField;if(0===(50397184&o)){var s=this._length();s>0&&r._migrateCallback0(this);for(var a=1;s>a;++a)r._migrateCallbackAt(this,a);this._setFollowing(),this._setLength(0),this._setFollowee(r)}else if(0!==(33554432&o))this._fulfill(r._value());else if(0!==(16777216&o))this._reject(r._reason());else{var c=new g("late cancellation observer");r._attachExtraTrace(c),this._reject(c)}}},i.prototype._rejectCallback=function(t,e,n){var r=f.ensureErrorObject(t),i=r===t;if(!i&&!n&&x.warnings()){var o="a promise was rejected with a non-error: "+f.classString(t);this._warn(o,!0)}this._attachExtraTrace(r,e?i:!1),this._reject(t)},i.prototype._resolveFromExecutor=function(t){if(t!==b){var e=this;this._captureStackTrace(),this._pushContext();var n=!0,r=this._execute(t,function(t){e._resolveCallback(t)},function(t){e._rejectCallback(t,n)});n=!1,this._popContext(),void 0!==r&&e._rejectCallback(r,!0)}},i.prototype._settlePromiseFromHandler=function(t,e,n,r){var i=r._bitField;if(0===(65536&i)){r._pushContext();var o;e===w?n&&"number"==typeof n.length?o=O(t).apply(this._boundValue(),n):(o=S,o.e=new m("cannot .spread() a non-array: "+f.classString(n))):o=O(t).call(e,n);var s=r._popContext();i=r._bitField,0===(65536&i)&&(o===C?r._reject(n):o===S?r._rejectCallback(o.e,!1):(x.checkForgottenReturns(o,s,"",r,this),r._resolveCallback(o)))}},i.prototype._target=function(){for(var t=this;t._isFollowing();)t=t._followee();return t},i.prototype._followee=function(){return this._rejectionHandler0},i.prototype._setFollowee=function(t){this._rejectionHandler0=t},i.prototype._settlePromise=function(t,e,r,o){var s=t instanceof i,a=this._bitField,c=0!==(134217728&a);0!==(65536&a)?(s&&t._invokeInternalOnCancel(),r instanceof T&&r.isFinallyHandler()?(r.cancelPromise=t,O(e).call(r,o)===S&&t._reject(S.e)):e===u?t._fulfill(u.call(r)):r instanceof n?r._promiseCancelled(t):s||t instanceof E?t._cancel():r.cancel()):"function"==typeof e?s?(c&&t._setAsyncGuaranteed(),this._settlePromiseFromHandler(e,r,o,t)):e.call(r,o,t):r instanceof n?r._isResolved()||(0!==(33554432&a)?r._promiseFulfilled(o,t):r._promiseRejected(o,t)):s&&(c&&t._setAsyncGuaranteed(),0!==(33554432&a)?t._fulfill(o):t._reject(o))},i.prototype._settlePromiseLateCancellationObserver=function(t){var e=t.handler,n=t.promise,r=t.receiver,o=t.value;"function"==typeof e?n instanceof i?this._settlePromiseFromHandler(e,r,o,n):e.call(r,o,n):n instanceof i&&n._reject(o)},i.prototype._settlePromiseCtx=function(t){this._settlePromise(t.promise,t.handler,t.receiver,t.value)},i.prototype._settlePromise0=function(t,e,n){var r=this._promise0,i=this._receiverAt(0);this._promise0=void 0,this._receiver0=void 0,this._settlePromise(r,t,i,e)},i.prototype._clearCallbackDataAtIndex=function(t){var e=4*t-4;this[e+2]=this[e+3]=this[e+0]=this[e+1]=void 0},i.prototype._fulfill=function(t){var e=this._bitField;if(!((117506048&e)>>>16)){if(t===this){var n=l();return this._attachExtraTrace(n),this._reject(n)}this._setFulfilled(),this._rejectionHandler0=t,(65535&e)>0&&(0!==(134217728&e)?this._settlePromises():v.settlePromises(this))}},i.prototype._reject=function(t){var e=this._bitField;if(!((117506048&e)>>>16))return this._setRejected(),this._fulfillmentHandler0=t,this._isFinal()?v.fatalError(t,f.isNode):void((65535&e)>0?v.settlePromises(this):this._ensurePossibleRejectionHandled())},i.prototype._fulfillPromises=function(t,e){for(var n=1;t>n;n++){var r=this._fulfillmentHandlerAt(n),i=this._promiseAt(n),o=this._receiverAt(n);this._clearCallbackDataAtIndex(n),this._settlePromise(i,r,o,e)}},i.prototype._rejectPromises=function(t,e){for(var n=1;t>n;n++){var r=this._rejectionHandlerAt(n),i=this._promiseAt(n),o=this._receiverAt(n);this._clearCallbackDataAtIndex(n),this._settlePromise(i,r,o,e)}},i.prototype._settlePromises=function(){var t=this._bitField,e=65535&t;if(e>0){if(0!==(16842752&t)){var n=this._fulfillmentHandler0;this._settlePromise0(this._rejectionHandler0,n,t),this._rejectPromises(e,n)}else{var r=this._rejectionHandler0;this._settlePromise0(this._fulfillmentHandler0,r,t),this._fulfillPromises(e,r)}this._setLength(0)}this._clearCancellationData()},i.prototype._settledValue=function(){var t=this._bitField;return 0!==(33554432&t)?this._rejectionHandler0:0!==(16777216&t)?this._fulfillmentHandler0:void 0},i.defer=i.pending=function(){x.deprecated("Promise.defer","new Promise");var t=new i(b);return{promise:t,resolve:o,reject:s}},f.notEnumerableProp(i,"_makeSelfResolutionError",l),t("./method")(i,b,j,p,x),t("./bind")(i,b,j,x),t("./cancel")(i,E,p,x),t("./direct_resolve")(i),t("./synchronous_inspection")(i),t("./join")(i,E,j,b,v,c),i.Promise=i,i.version="3.5.0",t("./map.js")(i,E,p,j,b,x),t("./call_get.js")(i),t("./using.js")(i,p,j,F,b,x),t("./timers.js")(i,b,x),t("./generators.js")(i,p,b,j,n,x),t("./nodeify.js")(i),t("./promisify.js")(i,b),t("./props.js")(i,E,j,p),t("./race.js")(i,b,j,p),t("./reduce.js")(i,E,p,j,b,x),t("./settle.js")(i,E,x),t("./some.js")(i,E,p),t("./filter.js")(i,b),t("./each.js")(i,b),t("./any.js")(i),f.toFastProperties(i),f.toFastProperties(i.prototype),a({a:1}),a({b:2}),a({c:3}),a(1),a(function(){}),a(void 0),a(!1),a(new i(b)),x.setBounds(d.firstLineError,f.lastLineError),i}},{"./any.js":1,"./async":2,"./bind":3,"./call_get.js":5,"./cancel":6,"./catch_filter":7,"./context":8,"./debuggability":9,"./direct_resolve":10,"./each.js":11,"./errors":12,"./es5":13,"./filter.js":14,"./finally":15,"./generators.js":16,"./join":17,"./map.js":18,"./method":19,"./nodeback":20,"./nodeify.js":21,"./promise_array":23,"./promisify.js":24,"./props.js":25,"./race.js":27,"./reduce.js":28,"./settle.js":30,"./some.js":31,"./synchronous_inspection":32,"./thenables":33,"./timers.js":34,"./using.js":35,"./util":36}],23:[function(t,e,n){"use strict";e.exports=function(e,n,r,i,o){function s(t){switch(t){case-2:return[];case-3:return{};case-6:return new Map}}function a(t){var r=this._promise=new e(n);t instanceof e&&r._propagateFrom(t,3),r._setOnCancel(this),this._values=t,this._length=0,this._totalResolved=0,this._init(void 0,-2)}var c=t("./util");c.isArray;return c.inherits(a,o),a.prototype.length=function(){return this._length},a.prototype.promise=function(){return this._promise},a.prototype._init=function l(t,n){var o=r(this._values,this._promise);if(o instanceof e){o=o._target();var a=o._bitField;if(this._values=o,0===(50397184&a))return this._promise._setAsyncGuaranteed(),o._then(l,this._reject,void 0,this,n);if(0===(33554432&a))return 0!==(16777216&a)?this._reject(o._reason()):this._cancel();o=o._value()}if(o=c.asArray(o),null===o){var u=i("expecting an array or an iterable object but got "+c.classString(o)).reason();return void this._promise._rejectCallback(u,!1)}return 0===o.length?void(-5===n?this._resolveEmptyArray():this._resolve(s(n))):void this._iterate(o)},a.prototype._iterate=function(t){var n=this.getActualLength(t.length);this._length=n,this._values=this.shouldCopyValues()?new Array(n):this._values;for(var i=this._promise,o=!1,s=null,a=0;n>a;++a){var c=r(t[a],i);c instanceof e?(c=c._target(),s=c._bitField):s=null,o?null!==s&&c.suppressUnhandledRejections():null!==s?0===(50397184&s)?(c._proxy(this,a),this._values[a]=c):o=0!==(33554432&s)?this._promiseFulfilled(c._value(),a):0!==(16777216&s)?this._promiseRejected(c._reason(),a):this._promiseCancelled(a):o=this._promiseFulfilled(c,a)}o||i._setAsyncGuaranteed()},a.prototype._isResolved=function(){return null===this._values},a.prototype._resolve=function(t){this._values=null,this._promise._fulfill(t)},a.prototype._cancel=function(){!this._isResolved()&&this._promise._isCancellable()&&(this._values=null,this._promise._cancel())},a.prototype._reject=function(t){this._values=null,this._promise._rejectCallback(t,!1)},a.prototype._promiseFulfilled=function(t,e){this._values[e]=t;var n=++this._totalResolved;return n>=this._length?(this._resolve(this._values),!0):!1},a.prototype._promiseCancelled=function(){return this._cancel(),!0},a.prototype._promiseRejected=function(t){return this._totalResolved++,this._reject(t),!0},a.prototype._resultCancelled=function(){if(!this._isResolved()){var t=this._values;if(this._cancel(),t instanceof e)t.cancel();else for(var n=0;n<t.length;++n)t[n]instanceof e&&t[n].cancel()}},a.prototype.shouldCopyValues=function(){return!0},a.prototype.getActualLength=function(t){return t},a}},{"./util":36}],24:[function(t,e,n){"use strict";e.exports=function(e,n){function r(t){return!C.test(t)}function i(t){try{return t.__isPromisified__===!0}catch(e){return!1}}function o(t,e,n){var r=f.getDataPropertyOrDefault(t,e+n,b);return r?i(r):!1}function s(t,e,n){for(var r=0;r<t.length;r+=2){var i=t[r];if(n.test(i))for(var o=i.replace(n,""),s=0;s<t.length;s+=2)if(t[s]===o)throw new m("Cannot promisify an API that has normal methods with '%s'-suffix\n\n    See http://goo.gl/MqrFmX\n".replace("%s",e))}}function a(t,e,n,r){for(var a=f.inheritedDataKeys(t),c=[],l=0;l<a.length;++l){var u=a[l],p=t[u],h=r===j?!0:j(u,p,t);"function"!=typeof p||i(p)||o(t,u,e)||!r(u,p,t,h)||c.push(u,p)}return s(c,e,n),c}function c(t,r,i,o,s,a){function c(){var i=r;r===h&&(i=this);var o=new e(n);o._captureStackTrace();var s="string"==typeof u&&this!==l?this[u]:t,c=_(o,a);try{s.apply(i,d(arguments,c))}catch(p){o._rejectCallback(v(p),!0,!0)}return o._isFateSealed()||o._setAsyncGuaranteed(),o}var l=function(){return this}(),u=t;return"string"==typeof u&&(t=o),f.notEnumerableProp(c,"__isPromisified__",!0),c}function l(t,e,n,r,i){for(var o=new RegExp(E(e)+"$"),s=a(t,e,o,n),c=0,l=s.length;l>c;c+=2){var u=s[c],p=s[c+1],_=u+e;if(r===k)t[_]=k(u,h,u,p,e,i);else{var d=r(p,function(){return k(u,h,u,p,e,i)});f.notEnumerableProp(d,"__isPromisified__",!0),t[_]=d}}return f.toFastProperties(t),t}function u(t,e,n){return k(t,e,void 0,t,null,n)}var p,h={},f=t("./util"),_=t("./nodeback"),d=f.withAppended,v=f.maybeWrapAsError,y=f.canEvaluate,m=t("./errors").TypeError,g="Async",b={__isPromisified__:!0},w=["arity","length","name","arguments","caller","callee","prototype","__isPromisified__"],C=new RegExp("^(?:"+w.join("|")+")$"),j=function(t){return f.isIdentifier(t)&&"_"!==t.charAt(0)&&"constructor"!==t},E=function(t){return t.replace(/([$])/,"\\$")},k=y?p:c;e.promisify=function(t,e){if("function"!=typeof t)throw new m("expecting a function but got "+f.classString(t));if(i(t))return t;e=Object(e);var n=void 0===e.context?h:e.context,o=!!e.multiArgs,s=u(t,n,o);return f.copyDescriptors(t,s,r),s},e.promisifyAll=function(t,e){if("function"!=typeof t&&"object"!=typeof t)throw new m("the target of promisifyAll must be an object or a function\n\n    See http://goo.gl/MqrFmX\n");e=Object(e);var n=!!e.multiArgs,r=e.suffix;"string"!=typeof r&&(r=g);var i=e.filter;"function"!=typeof i&&(i=j);var o=e.promisifier;if("function"!=typeof o&&(o=k),!f.isIdentifier(r))throw new RangeError("suffix must be a valid identifier\n\n    See http://goo.gl/MqrFmX\n");for(var s=f.inheritedDataKeys(t),a=0;a<s.length;++a){var c=t[s[a]];"constructor"!==s[a]&&f.isClass(c)&&(l(c.prototype,r,i,o,n),l(c,r,i,o,n))}return l(t,r,i,o,n)}}},{"./errors":12,"./nodeback":20,"./util":36}],25:[function(t,e,n){"use strict";e.exports=function(e,n,r,i){function o(t){var e,n=!1;if(void 0!==a&&t instanceof a)e=p(t),n=!0;else{var r=u.keys(t),i=r.length;e=new Array(2*i);for(var o=0;i>o;++o){var s=r[o];e[o]=t[s],e[o+i]=s}}this.constructor$(e),this._isMap=n,this._init$(void 0,n?-6:-3)}function s(t){var n,s=r(t);return l(s)?(n=s instanceof e?s._then(e.props,void 0,void 0,void 0,void 0):new o(s).promise(),s instanceof e&&n._propagateFrom(s,2),n):i("cannot await properties of a non-object\n\n    See http://goo.gl/MqrFmX\n")}var a,c=t("./util"),l=c.isObject,u=t("./es5");"function"==typeof Map&&(a=Map);var p=function(){function t(t,r){this[e]=t,this[e+n]=r,e++}var e=0,n=0;return function(r){n=r.size,e=0;var i=new Array(2*r.size);return r.forEach(t,i),i}}(),h=function(t){for(var e=new a,n=t.length/2|0,r=0;n>r;++r){var i=t[n+r],o=t[r];e.set(i,o)}return e};c.inherits(o,n),o.prototype._init=function(){},o.prototype._promiseFulfilled=function(t,e){this._values[e]=t;var n=++this._totalResolved;if(n>=this._length){var r;if(this._isMap)r=h(this._values);else{r={};for(var i=this.length(),o=0,s=this.length();s>o;++o)r[this._values[o+i]]=this._values[o]}return this._resolve(r),!0}return!1},o.prototype.shouldCopyValues=function(){return!1},o.prototype.getActualLength=function(t){return t>>1},e.prototype.props=function(){return s(this)},e.props=function(t){return s(t)}}},{"./es5":13,"./util":36}],26:[function(t,e,n){"use strict";function r(t,e,n,r,i){for(var o=0;i>o;++o)n[o+r]=t[o+e],t[o+e]=void 0}function i(t){this._capacity=t,this._length=0,this._front=0}i.prototype._willBeOverCapacity=function(t){return this._capacity<t},i.prototype._pushOne=function(t){var e=this.length();this._checkCapacity(e+1);var n=this._front+e&this._capacity-1;this[n]=t,this._length=e+1},i.prototype.push=function(t,e,n){var r=this.length()+3;if(this._willBeOverCapacity(r))return this._pushOne(t),this._pushOne(e),void this._pushOne(n);var i=this._front+r-3;this._checkCapacity(r);var o=this._capacity-1;this[i+0&o]=t,this[i+1&o]=e,this[i+2&o]=n,this._length=r},i.prototype.shift=function(){var t=this._front,e=this[t];return this[t]=void 0,this._front=t+1&this._capacity-1,this._length--,e},i.prototype.length=function(){return this._length},i.prototype._checkCapacity=function(t){this._capacity<t&&this._resizeTo(this._capacity<<1)},i.prototype._resizeTo=function(t){var e=this._capacity;this._capacity=t;var n=this._front,i=this._length,o=n+i&e-1;r(this,0,this,e,o)},e.exports=i},{}],27:[function(t,e,n){"use strict";e.exports=function(e,n,r,i){function o(t,o){var c=r(t);if(c instanceof e)return a(c);if(t=s.asArray(t),null===t)return i("expecting an array or an iterable object but got "+s.classString(t));var l=new e(n);void 0!==o&&l._propagateFrom(o,3);for(var u=l._fulfill,p=l._reject,h=0,f=t.length;f>h;++h){var _=t[h];(void 0!==_||h in t)&&e.cast(_)._then(u,p,void 0,l,null)}return l}var s=t("./util"),a=function(t){return t.then(function(e){return o(e,t)})};e.race=function(t){return o(t,void 0)},e.prototype.race=function(){return o(this,void 0)}}},{"./util":36}],28:[function(t,e,n){"use strict";e.exports=function(e,n,r,i,o,s){function a(t,n,r,i){this.constructor$(t);var s=h();this._fn=null===s?n:f.domainBind(s,n),void 0!==r&&(r=e.resolve(r),r._attachCancellationCallback(this)),this._initialValue=r,this._currentCancellable=null,i===o?this._eachValues=Array(this._length):0===i?this._eachValues=null:this._eachValues=void 0,this._promise._captureStackTrace(),this._init$(void 0,-5)}function c(t,e){this.isFulfilled()?e._resolve(t):e._reject(t)}function l(t,e,n,i){if("function"!=typeof e)return r("expecting a function but got "+f.classString(e));var o=new a(t,e,n,i);return o.promise()}function u(t){this.accum=t,this.array._gotAccum(t);var n=i(this.value,this.array._promise);return n instanceof e?(this.array._currentCancellable=n,n._then(p,void 0,void 0,this,void 0)):p.call(this,n)}function p(t){var n=this.array,r=n._promise,i=_(n._fn);r._pushContext();var o;o=void 0!==n._eachValues?i.call(r._boundValue(),t,this.index,this.length):i.call(r._boundValue(),this.accum,t,this.index,this.length),o instanceof e&&(n._currentCancellable=o);var a=r._popContext();return s.checkForgottenReturns(o,a,void 0!==n._eachValues?"Promise.each":"Promise.reduce",r),o}var h=e._getDomain,f=t("./util"),_=f.tryCatch;f.inherits(a,n),a.prototype._gotAccum=function(t){void 0!==this._eachValues&&null!==this._eachValues&&t!==o&&this._eachValues.push(t)},a.prototype._eachComplete=function(t){return null!==this._eachValues&&this._eachValues.push(t),this._eachValues},a.prototype._init=function(){},a.prototype._resolveEmptyArray=function(){this._resolve(void 0!==this._eachValues?this._eachValues:this._initialValue)},a.prototype.shouldCopyValues=function(){return!1},a.prototype._resolve=function(t){this._promise._resolveCallback(t),this._values=null},a.prototype._resultCancelled=function(t){return t===this._initialValue?this._cancel():void(this._isResolved()||(this._resultCancelled$(),this._currentCancellable instanceof e&&this._currentCancellable.cancel(),this._initialValue instanceof e&&this._initialValue.cancel()))},a.prototype._iterate=function(t){this._values=t;var n,r,i=t.length;if(void 0!==this._initialValue?(n=this._initialValue,r=0):(n=e.resolve(t[0]),r=1),this._currentCancellable=n,!n.isRejected())for(;i>r;++r){var o={accum:null,value:t[r],index:r,length:i,array:this};n=n._then(u,void 0,void 0,o,void 0)}void 0!==this._eachValues&&(n=n._then(this._eachComplete,void 0,void 0,this,void 0)),n._then(c,c,void 0,n,this)},e.prototype.reduce=function(t,e){return l(this,t,e,null)},e.reduce=function(t,e,n,r){return l(t,e,n,r)}}},{"./util":36}],29:[function(t,e,n){"use strict";var r,i=t("./util"),o=function(){throw new Error("No async scheduler available\n\n    See http://goo.gl/MqrFmX\n")},s=i.getNativePromise();if(i.isNode&&"undefined"==typeof MutationObserver){var a=global.setImmediate,c=process.nextTick;r=i.isRecentNode?function(t){a.call(global,t)}:function(t){c.call(process,t)}}else if("function"==typeof s&&"function"==typeof s.resolve){var l=s.resolve();r=function(t){l.then(t)}}else r="undefined"==typeof MutationObserver||"undefined"!=typeof window&&window.navigator&&(window.navigator.standalone||window.cordova)?"undefined"!=typeof setImmediate?function(t){setImmediate(t)}:"undefined"!=typeof setTimeout?function(t){setTimeout(t,0)}:o:function(){var t=document.createElement("div"),e={attributes:!0},n=!1,r=document.createElement("div"),i=new MutationObserver(function(){t.classList.toggle("foo"),n=!1});i.observe(r,e);var o=function(){n||(n=!0,r.classList.toggle("foo"))};return function(n){var r=new MutationObserver(function(){r.disconnect(),n()});r.observe(t,e),o()}}();e.exports=r},{"./util":36}],30:[function(t,e,n){"use strict";e.exports=function(e,n,r){function i(t){this.constructor$(t)}var o=e.PromiseInspection,s=t("./util");s.inherits(i,n),i.prototype._promiseResolved=function(t,e){this._values[t]=e;var n=++this._totalResolved;return n>=this._length?(this._resolve(this._values),!0):!1},i.prototype._promiseFulfilled=function(t,e){var n=new o;return n._bitField=33554432,n._settledValueField=t,this._promiseResolved(e,n)},i.prototype._promiseRejected=function(t,e){var n=new o;return n._bitField=16777216,n._settledValueField=t,this._promiseResolved(e,n)},e.settle=function(t){return r.deprecated(".settle()",".reflect()"),new i(t).promise()},e.prototype.settle=function(){return e.settle(this)}}},{"./util":36}],31:[function(t,e,n){"use strict";e.exports=function(e,n,r){function i(t){this.constructor$(t),
this._howMany=0,this._unwrap=!1,this._initialized=!1}function o(t,e){if((0|e)!==e||0>e)return r("expecting a positive integer\n\n    See http://goo.gl/MqrFmX\n");var n=new i(t),o=n.promise();return n.setHowMany(e),n.init(),o}var s=t("./util"),a=t("./errors").RangeError,c=t("./errors").AggregateError,l=s.isArray,u={};s.inherits(i,n),i.prototype._init=function(){if(this._initialized){if(0===this._howMany)return void this._resolve([]);this._init$(void 0,-5);var t=l(this._values);!this._isResolved()&&t&&this._howMany>this._canPossiblyFulfill()&&this._reject(this._getRangeError(this.length()))}},i.prototype.init=function(){this._initialized=!0,this._init()},i.prototype.setUnwrap=function(){this._unwrap=!0},i.prototype.howMany=function(){return this._howMany},i.prototype.setHowMany=function(t){this._howMany=t},i.prototype._promiseFulfilled=function(t){return this._addFulfilled(t),this._fulfilled()===this.howMany()?(this._values.length=this.howMany(),1===this.howMany()&&this._unwrap?this._resolve(this._values[0]):this._resolve(this._values),!0):!1},i.prototype._promiseRejected=function(t){return this._addRejected(t),this._checkOutcome()},i.prototype._promiseCancelled=function(){return this._values instanceof e||null==this._values?this._cancel():(this._addRejected(u),this._checkOutcome())},i.prototype._checkOutcome=function(){if(this.howMany()>this._canPossiblyFulfill()){for(var t=new c,e=this.length();e<this._values.length;++e)this._values[e]!==u&&t.push(this._values[e]);return t.length>0?this._reject(t):this._cancel(),!0}return!1},i.prototype._fulfilled=function(){return this._totalResolved},i.prototype._rejected=function(){return this._values.length-this.length()},i.prototype._addRejected=function(t){this._values.push(t)},i.prototype._addFulfilled=function(t){this._values[this._totalResolved++]=t},i.prototype._canPossiblyFulfill=function(){return this.length()-this._rejected()},i.prototype._getRangeError=function(t){var e="Input array must contain at least "+this._howMany+" items but contains only "+t+" items";return new a(e)},i.prototype._resolveEmptyArray=function(){this._reject(this._getRangeError(0))},e.some=function(t,e){return o(t,e)},e.prototype.some=function(t){return o(this,t)},e._SomePromiseArray=i}},{"./errors":12,"./util":36}],32:[function(t,e,n){"use strict";e.exports=function(t){function e(t){void 0!==t?(t=t._target(),this._bitField=t._bitField,this._settledValueField=t._isFateSealed()?t._settledValue():void 0):(this._bitField=0,this._settledValueField=void 0)}e.prototype._settledValue=function(){return this._settledValueField};var n=e.prototype.value=function(){if(!this.isFulfilled())throw new TypeError("cannot get fulfillment value of a non-fulfilled promise\n\n    See http://goo.gl/MqrFmX\n");return this._settledValue()},r=e.prototype.error=e.prototype.reason=function(){if(!this.isRejected())throw new TypeError("cannot get rejection reason of a non-rejected promise\n\n    See http://goo.gl/MqrFmX\n");return this._settledValue()},i=e.prototype.isFulfilled=function(){return 0!==(33554432&this._bitField)},o=e.prototype.isRejected=function(){return 0!==(16777216&this._bitField)},s=e.prototype.isPending=function(){return 0===(50397184&this._bitField)},a=e.prototype.isResolved=function(){return 0!==(50331648&this._bitField)};e.prototype.isCancelled=function(){return 0!==(8454144&this._bitField)},t.prototype.__isCancelled=function(){return 65536===(65536&this._bitField)},t.prototype._isCancelled=function(){return this._target().__isCancelled()},t.prototype.isCancelled=function(){return 0!==(8454144&this._target()._bitField)},t.prototype.isPending=function(){return s.call(this._target())},t.prototype.isRejected=function(){return o.call(this._target())},t.prototype.isFulfilled=function(){return i.call(this._target())},t.prototype.isResolved=function(){return a.call(this._target())},t.prototype.value=function(){return n.call(this._target())},t.prototype.reason=function(){var t=this._target();return t._unsetRejectionIsUnhandled(),r.call(t)},t.prototype._value=function(){return this._settledValue()},t.prototype._reason=function(){return this._unsetRejectionIsUnhandled(),this._settledValue()},t.PromiseInspection=e}},{}],33:[function(t,e,n){"use strict";e.exports=function(e,n){function r(t,r){if(u(t)){if(t instanceof e)return t;var i=o(t);if(i===l){r&&r._pushContext();var c=e.reject(i.e);return r&&r._popContext(),c}if("function"==typeof i){if(s(t)){var c=new e(n);return t._then(c._fulfill,c._reject,void 0,c,null),c}return a(t,i,r)}}return t}function i(t){return t.then}function o(t){try{return i(t)}catch(e){return l.e=e,l}}function s(t){try{return p.call(t,"_promise0")}catch(e){return!1}}function a(t,r,i){function o(t){a&&(a._resolveCallback(t),a=null)}function s(t){a&&(a._rejectCallback(t,p,!0),a=null)}var a=new e(n),u=a;i&&i._pushContext(),a._captureStackTrace(),i&&i._popContext();var p=!0,h=c.tryCatch(r).call(t,o,s);return p=!1,a&&h===l&&(a._rejectCallback(h.e,!0,!0),a=null),u}var c=t("./util"),l=c.errorObj,u=c.isObject,p={}.hasOwnProperty;return r}},{"./util":36}],34:[function(t,e,n){"use strict";e.exports=function(e,n,r){function i(t){this.handle=t}function o(t){return clearTimeout(this.handle),t}function s(t){throw clearTimeout(this.handle),t}var a=t("./util"),c=e.TimeoutError;i.prototype._resultCancelled=function(){clearTimeout(this.handle)};var l=function(t){return u(+this).thenReturn(t)},u=e.delay=function(t,o){var s,a;return void 0!==o?(s=e.resolve(o)._then(l,null,null,t,void 0),r.cancellation()&&o instanceof e&&s._setOnCancel(o)):(s=new e(n),a=setTimeout(function(){s._fulfill()},+t),r.cancellation()&&s._setOnCancel(new i(a)),s._captureStackTrace()),s._setAsyncGuaranteed(),s};e.prototype.delay=function(t){return u(t,this)};var p=function(t,e,n){var r;r="string"!=typeof e?e instanceof Error?e:new c("operation timed out"):new c(e),a.markAsOriginatingFromRejection(r),t._attachExtraTrace(r),t._reject(r),null!=n&&n.cancel()};e.prototype.timeout=function(t,e){t=+t;var n,a,c=new i(setTimeout(function(){n.isPending()&&p(n,e,a)},t));return r.cancellation()?(a=this.then(),n=a._then(o,s,void 0,c,void 0),n._setOnCancel(c)):n=this._then(o,s,void 0,c,void 0),n}}},{"./util":36}],35:[function(t,e,n){"use strict";e.exports=function(e,n,r,i,o,s){function a(t){setTimeout(function(){throw t},0)}function c(t){var e=r(t);return e!==t&&"function"==typeof t._isDisposable&&"function"==typeof t._getDisposer&&t._isDisposable()&&e._setDisposable(t._getDisposer()),e}function l(t,n){function i(){if(s>=l)return u._fulfill();var o=c(t[s++]);if(o instanceof e&&o._isDisposable()){try{o=r(o._getDisposer().tryDispose(n),t.promise)}catch(p){return a(p)}if(o instanceof e)return o._then(i,a,null,null,null)}i()}var s=0,l=t.length,u=new e(o);return i(),u}function u(t,e,n){this._data=t,this._promise=e,this._context=n}function p(t,e,n){this.constructor$(t,e,n)}function h(t){return u.isDisposer(t)?(this.resources[this.index]._setDisposable(t),t.promise()):t}function f(t){this.length=t,this.promise=null,this[t-1]=null}var _=t("./util"),d=t("./errors").TypeError,v=t("./util").inherits,y=_.errorObj,m=_.tryCatch,g={};u.prototype.data=function(){return this._data},u.prototype.promise=function(){return this._promise},u.prototype.resource=function(){return this.promise().isFulfilled()?this.promise().value():g},u.prototype.tryDispose=function(t){var e=this.resource(),n=this._context;void 0!==n&&n._pushContext();var r=e!==g?this.doDispose(e,t):null;return void 0!==n&&n._popContext(),this._promise._unsetDisposable(),this._data=null,r},u.isDisposer=function(t){return null!=t&&"function"==typeof t.resource&&"function"==typeof t.tryDispose},v(p,u),p.prototype.doDispose=function(t,e){var n=this.data();return n.call(t,t,e)},f.prototype._resultCancelled=function(){for(var t=this.length,n=0;t>n;++n){var r=this[n];r instanceof e&&r.cancel()}},e.using=function(){var t=arguments.length;if(2>t)return n("you must pass at least 2 arguments to Promise.using");var i=arguments[t-1];if("function"!=typeof i)return n("expecting a function but got "+_.classString(i));var o,a=!0;2===t&&Array.isArray(arguments[0])?(o=arguments[0],t=o.length,a=!1):(o=arguments,t--);for(var c=new f(t),p=0;t>p;++p){var d=o[p];if(u.isDisposer(d)){var v=d;d=d.promise(),d._setDisposable(v)}else{var g=r(d);g instanceof e&&(d=g._then(h,null,null,{resources:c,index:p},void 0))}c[p]=d}for(var b=new Array(c.length),p=0;p<b.length;++p)b[p]=e.resolve(c[p]).reflect();var w=e.all(b).then(function(t){for(var e=0;e<t.length;++e){var n=t[e];if(n.isRejected())return y.e=n.error(),y;if(!n.isFulfilled())return void w.cancel();t[e]=n.value()}C._pushContext(),i=m(i);var r=a?i.apply(void 0,t):i(t),o=C._popContext();return s.checkForgottenReturns(r,o,"Promise.using",C),r}),C=w.lastly(function(){var t=new e.PromiseInspection(w);return l(c,t)});return c.promise=C,C._setOnCancel(c),C},e.prototype._setDisposable=function(t){this._bitField=131072|this._bitField,this._disposer=t},e.prototype._isDisposable=function(){return(131072&this._bitField)>0},e.prototype._getDisposer=function(){return this._disposer},e.prototype._unsetDisposable=function(){this._bitField=-131073&this._bitField,this._disposer=void 0},e.prototype.disposer=function(t){if("function"==typeof t)return new p(t,this,i());throw new d}}},{"./errors":12,"./util":36}],36:[function(t,e,n){"use strict";function r(){try{var t=P;return P=null,t.apply(this,arguments)}catch(e){return T.e=e,T}}function i(t){return P=t,r}function o(t){return null==t||t===!0||t===!1||"string"==typeof t||"number"==typeof t}function s(t){return"function"==typeof t||"object"==typeof t&&null!==t}function a(t){return o(t)?new Error(v(t)):t}function c(t,e){var n,r=t.length,i=new Array(r+1);for(n=0;r>n;++n)i[n]=t[n];return i[n]=e,i}function l(t,e,n){if(!F.isES5)return{}.hasOwnProperty.call(t,e)?t[e]:void 0;var r=Object.getOwnPropertyDescriptor(t,e);return null!=r?null==r.get&&null==r.set?r.value:n:void 0}function u(t,e,n){if(o(t))return t;var r={value:n,configurable:!0,enumerable:!1,writable:!0};return F.defineProperty(t,e,r),t}function p(t){throw t}function h(t){try{if("function"==typeof t){var e=F.names(t.prototype),n=F.isES5&&e.length>1,r=e.length>0&&!(1===e.length&&"constructor"===e[0]),i=A.test(t+"")&&F.names(t).length>0;if(n||r||i)return!0}return!1}catch(o){return!1}}function f(t){function e(){}e.prototype=t;for(var n=8;n--;)new e;return t}function _(t){return D.test(t)}function d(t,e,n){for(var r=new Array(t),i=0;t>i;++i)r[i]=e+i+n;return r}function v(t){try{return t+""}catch(e){return"[no string representation]"}}function y(t){return null!==t&&"object"==typeof t&&"string"==typeof t.message&&"string"==typeof t.name}function m(t){try{u(t,"isOperational",!0)}catch(e){}}function g(t){return null==t?!1:t instanceof Error.__BluebirdErrorTypes__.OperationalError||t.isOperational===!0}function b(t){return y(t)&&F.propertyIsWritable(t,"stack")}function w(t){return{}.toString.call(t)}function C(t,e,n){for(var r=F.names(t),i=0;i<r.length;++i){var o=r[i];if(n(o))try{F.defineProperty(e,o,F.getDescriptor(t,o))}catch(s){}}}function j(t){return N?process.env[t]:void 0}function E(){if("function"==typeof Promise)try{var t=new Promise(function(){});if("[object Promise]"==={}.toString.call(t))return Promise}catch(e){}}function k(t,e){return t.bind(e)}var F=t("./es5"),x="undefined"==typeof navigator,T={e:{}},P,R="undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:void 0!==this?this:null,S=function(t,e){function n(){this.constructor=t,this.constructor$=e;for(var n in e.prototype)r.call(e.prototype,n)&&"$"!==n.charAt(n.length-1)&&(this[n+"$"]=e.prototype[n])}var r={}.hasOwnProperty;return n.prototype=e.prototype,t.prototype=new n,t.prototype},O=function(){var t=[Array.prototype,Object.prototype,Function.prototype],e=function(e){for(var n=0;n<t.length;++n)if(t[n]===e)return!0;return!1};if(F.isES5){var n=Object.getOwnPropertyNames;return function(t){for(var r=[],i=Object.create(null);null!=t&&!e(t);){var o;try{o=n(t)}catch(s){return r}for(var a=0;a<o.length;++a){var c=o[a];if(!i[c]){i[c]=!0;var l=Object.getOwnPropertyDescriptor(t,c);null!=l&&null==l.get&&null==l.set&&r.push(c)}}t=F.getPrototypeOf(t)}return r}}var r={}.hasOwnProperty;return function(n){if(e(n))return[];var i=[];t:for(var o in n)if(r.call(n,o))i.push(o);else{for(var s=0;s<t.length;++s)if(r.call(t[s],o))continue t;i.push(o)}return i}}(),A=/this\s*\.\s*\S+\s*=/,D=/^[a-z$_][a-z$_0-9]*$/i,V=function(){return"stack"in new Error?function(t){return b(t)?t:new Error(v(t))}:function(t){if(b(t))return t;try{throw new Error(v(t))}catch(e){return e}}}(),I=function(t){return F.isArray(t)?t:null};if("undefined"!=typeof Symbol&&Symbol.iterator){var L="function"==typeof Array.from?function(t){return Array.from(t)}:function(t){for(var e,n=[],r=t[Symbol.iterator]();!(e=r.next()).done;)n.push(e.value);return n};I=function(t){return F.isArray(t)?t:null!=t&&"function"==typeof t[Symbol.iterator]?L(t):null}}var H="undefined"!=typeof process&&"[object process]"===w(process).toLowerCase(),N="undefined"!=typeof process&&"undefined"!=typeof process.env,B={isClass:h,isIdentifier:_,inheritedDataKeys:O,getDataPropertyOrDefault:l,thrower:p,isArray:F.isArray,asArray:I,notEnumerableProp:u,isPrimitive:o,isObject:s,isError:y,canEvaluate:x,errorObj:T,tryCatch:i,inherits:S,withAppended:c,maybeWrapAsError:a,toFastProperties:f,filledRange:d,toString:v,canAttachTrace:b,ensureErrorObject:V,originatesFromRejection:g,markAsOriginatingFromRejection:m,classString:w,copyDescriptors:C,hasDevTools:"undefined"!=typeof chrome&&chrome&&"function"==typeof chrome.loadTimes,isNode:H,hasEnvVariables:N,env:j,global:R,getNativePromise:E,domainBind:k};B.isRecentNode=B.isNode&&function(){var t=process.versions.node.split(".").map(Number);return 0===t[0]&&t[1]>10||t[0]>0}(),B.isNode&&B.toFastProperties(process);try{throw new Error}catch(U){B.lastLineError=U}e.exports=B},{"./es5":13}]},{},[4])(4)}),"undefined"!=typeof window&&null!==window?window.P=window.Promise:"undefined"!=typeof self&&null!==self&&(self.P=self.Promise);
(function(g){function z(a){switch(typeof a){case "undefined":return"undefined";case "boolean":return"boolean";case "number":return"number";case "string":return"string";default:return null===a?"null":"object"}}function A(a){return Object.prototype.toString.call(a).replace(/^\[object *|\]$/g,"")}function q(a){return"function"===typeof a}function v(a){if(null===a||void 0===a)throw TypeError();return Object(a)}function E(a){function b(b){Object.defineProperty(a,b,{get:function(){return a._getter(b)},
set:function(k){a._setter(b,k)},enumerable:!0,configurable:!1})}if(!("TYPED_ARRAY_POLYFILL_NO_ARRAY_ACCESSORS"in g)){if(1E5<a.length)throw RangeError("Array too large for polyfill");var k;for(k=0;k<a.length;k+=1)b(k)}}function w(a,b){b=32-b;return a<<b>>b}function x(a,b){b=32-b;return a<<b>>>b}function F(a){return[a&255]}function G(a){return w(a[0],8)}function H(a){return[a&255]}function B(a){return x(a[0],8)}function I(a){a=J(Number(a));return[0>a?0:255<a?255:a&255]}function K(a){return[a&255,a>>
8&255]}function L(a){return w(a[1]<<8|a[0],16)}function M(a){return[a&255,a>>8&255]}function N(a){return x(a[1]<<8|a[0],16)}function O(a){return[a&255,a>>8&255,a>>16&255,a>>24&255]}function P(a){return w(a[3]<<24|a[2]<<16|a[1]<<8|a[0],32)}function Q(a){return[a&255,a>>8&255,a>>16&255,a>>24&255]}function R(a){return x(a[3]<<24|a[2]<<16|a[1]<<8|a[0],32)}function C(a,b,k){function n(a){var b=u(a);a-=b;return.5>a?b:.5<a?b+1:b%2?b+1:b}var l=(1<<b-1)-1;if(a!==a){var d=(1<<b)-1;var m=p(2,k-1);var g=0}else Infinity===
a||-Infinity===a?(d=(1<<b)-1,m=0,g=0>a?1:0):0===a?(m=d=0,g=-Infinity===1/a?1:0):(g=0>a,a=y(a),a>=p(2,1-l)?(d=r(u(U(a)/V),1023),m=a/p(2,d),1>m&&(--d,m*=2),2<=m&&(d+=1,m/=2),a=p(2,k),m=n(m*a)-a,d+=l,1<=m/a&&(d+=1,m=0),d>2*l&&(d=(1<<b)-1,m=0)):(d=0,m=n(a/p(2,1-l-k))));for(l=[];k;--k)l.push(m%2?1:0),m=u(m/2);for(k=b;k;--k)l.push(d%2?1:0),d=u(d/2);l.push(g?1:0);l.reverse();b=l.join("");for(g=[];b.length;)g.unshift(parseInt(b.substring(0,8),2)),b=b.substring(8);return g}function D(a,b,k){var g=[],l,d;for(l=
0;l<a.length;++l){var m=a[l];for(d=8;d;--d)g.push(m%2?1:0),m>>=1}g.reverse();d=g.join("");a=(1<<b-1)-1;g=parseInt(d.substring(0,1),2)?-1:1;l=parseInt(d.substring(1,1+b),2);d=parseInt(d.substring(1+b),2);return l===(1<<b)-1?0!==d?NaN:Infinity*g:0<l?g*p(2,l-a)*(1+d/p(2,k)):0!==d?g*p(2,-(a-1))*(d/p(2,k)):0>g?-0:0}function W(a){return D(a,11,52)}function X(a){return C(a,11,52)}function Y(a){return D(a,8,23)}function Z(a){return C(a,8,23)}var V=Math.LN2,y=Math.abs,u=Math.floor,U=Math.log,t=Math.max,r=
Math.min,p=Math.pow,J=Math.round;(function(){var a=Object.defineProperty;try{var b=Object.defineProperty({},"x",{})}catch(k){b=!1}a&&b||(Object.defineProperty=function(b,g,l){if(a)try{return a(b,g,l)}catch(d){}if(b!==Object(b))throw TypeError("Object.defineProperty called on non-object");Object.prototype.__defineGetter__&&"get"in l&&Object.prototype.__defineGetter__.call(b,g,l.get);Object.prototype.__defineSetter__&&"set"in l&&Object.prototype.__defineSetter__.call(b,g,l.set);"value"in l&&(b[g]=l.value);
return b})})();(function(){function a(a){a>>=0;if(0>a)throw RangeError("ArrayBuffer size is not a small enough positive integer.");Object.defineProperty(this,"byteLength",{value:a});Object.defineProperty(this,"_bytes",{value:Array(a)});for(var e=0;e<a;e+=1)this._bytes[e]=0}function b(){if(!arguments.length||"object"!==typeof arguments[0])return function(h){h>>=0;if(0>h)throw RangeError("length is not a small enough positive integer.");Object.defineProperty(this,"length",{value:h});Object.defineProperty(this,
"byteLength",{value:h*this.BYTES_PER_ELEMENT});Object.defineProperty(this,"buffer",{value:new a(this.byteLength)});Object.defineProperty(this,"byteOffset",{value:0})}.apply(this,arguments);if(1<=arguments.length&&"object"===z(arguments[0])&&arguments[0]instanceof b)return function(h){if(this.constructor!==h.constructor)throw TypeError();var e=h.length*this.BYTES_PER_ELEMENT;Object.defineProperty(this,"buffer",{value:new a(e)});Object.defineProperty(this,"byteLength",{value:e});Object.defineProperty(this,
"byteOffset",{value:0});Object.defineProperty(this,"length",{value:h.length});for(e=0;e<this.length;e+=1)this._setter(e,h._getter(e))}.apply(this,arguments);if(1<=arguments.length&&"object"===z(arguments[0])&&!(arguments[0]instanceof b)&&!(arguments[0]instanceof a||"ArrayBuffer"===A(arguments[0])))return function(h){var e=h.length*this.BYTES_PER_ELEMENT;Object.defineProperty(this,"buffer",{value:new a(e)});Object.defineProperty(this,"byteLength",{value:e});Object.defineProperty(this,"byteOffset",
{value:0});Object.defineProperty(this,"length",{value:h.length});for(e=0;e<this.length;e+=1)this._setter(e,Number(h[e]))}.apply(this,arguments);if(1<=arguments.length&&"object"===z(arguments[0])&&(arguments[0]instanceof a||"ArrayBuffer"===A(arguments[0])))return function(a,e,f){e>>>=0;if(e>a.byteLength)throw RangeError("byteOffset out of range");if(e%this.BYTES_PER_ELEMENT)throw RangeError("buffer length minus the byteOffset is not a multiple of the element size.");if(void 0===f){var c=a.byteLength-
e;if(c%this.BYTES_PER_ELEMENT)throw RangeError("length of buffer minus byteOffset not a multiple of the element size");f=c/this.BYTES_PER_ELEMENT}else f>>>=0,c=f*this.BYTES_PER_ELEMENT;if(e+c>a.byteLength)throw RangeError("byteOffset and length reference an area beyond the end of the buffer");Object.defineProperty(this,"buffer",{value:a});Object.defineProperty(this,"byteLength",{value:c});Object.defineProperty(this,"byteOffset",{value:e});Object.defineProperty(this,"length",{value:f})}.apply(this,
arguments);throw TypeError();}function k(a,e,f){var c=function(){Object.defineProperty(this,"constructor",{value:c});b.apply(this,arguments);E(this)};"__proto__"in c?c.__proto__=b:(c.from=b.from,c.of=b.of);c.BYTES_PER_ELEMENT=a;var h=function(){};h.prototype=n;c.prototype=new h;Object.defineProperty(c.prototype,"BYTES_PER_ELEMENT",{value:a});Object.defineProperty(c.prototype,"_pack",{value:e});Object.defineProperty(c.prototype,"_unpack",{value:f});return c}g.ArrayBuffer=g.ArrayBuffer||a;Object.defineProperty(b,
"from",{value:function(a){return new this(a)}});Object.defineProperty(b,"of",{value:function(){return new this(arguments)}});var n={};b.prototype=n;Object.defineProperty(b.prototype,"_getter",{value:function(a){if(1>arguments.length)throw SyntaxError("Not enough arguments");a>>>=0;if(!(a>=this.length)){var e=[],f;var c=0;for(f=this.byteOffset+a*this.BYTES_PER_ELEMENT;c<this.BYTES_PER_ELEMENT;c+=1,f+=1)e.push(this.buffer._bytes[f]);return this._unpack(e)}}});Object.defineProperty(b.prototype,"get",
{value:b.prototype._getter});Object.defineProperty(b.prototype,"_setter",{value:function(a,e){if(2>arguments.length)throw SyntaxError("Not enough arguments");a>>>=0;if(!(a>=this.length)){var f=this._pack(e),c;var b=0;for(c=this.byteOffset+a*this.BYTES_PER_ELEMENT;b<this.BYTES_PER_ELEMENT;b+=1,c+=1)this.buffer._bytes[c]=f[b]}}});Object.defineProperty(b.prototype,"constructor",{value:b});Object.defineProperty(b.prototype,"copyWithin",{value:function(a,e,f){var c=v(this),b=c.length>>>0;b=t(b,0);a>>=
0;a=0>a?t(b+a,0):r(a,b);e>>=0;e=0>e?t(b+e,0):r(e,b);f=void 0===f?b:f>>0;f=0>f?t(b+f,0):r(f,b);b=r(f-e,b-a);e<a&&a<e+b?(f=-1,e=e+b-1,a=a+b-1):f=1;for(;0<b;)c._setter(a,c._getter(e)),e+=f,a+=f,--b;return c}});Object.defineProperty(b.prototype,"every",{value:function(a,b){if(void 0===this||null===this)throw TypeError();var e=Object(this),c=e.length>>>0;if(!q(a))throw TypeError();for(var h=0;h<c;h++)if(!a.call(b,e._getter(h),h,e))return!1;return!0}});Object.defineProperty(b.prototype,"fill",{value:function(a,
b,f){var c=v(this),e=c.length>>>0;e=t(e,0);b>>=0;b=0>b?t(e+b,0):r(b,e);f=void 0===f?e:f>>0;for(e=0>f?t(e+f,0):r(f,e);b<e;)c._setter(b,a),b+=1;return c}});Object.defineProperty(b.prototype,"filter",{value:function(a,b){if(void 0===this||null===this)throw TypeError();var e=Object(this),c=e.length>>>0;if(!q(a))throw TypeError();for(var h=[],d=0;d<c;d++){var g=e._getter(d);a.call(b,g,d,e)&&h.push(g)}return new this.constructor(h)}});Object.defineProperty(b.prototype,"find",{value:function(a){var b=v(this),
f=b.length>>>0;if(!q(a))throw TypeError();for(var c=1<arguments.length?arguments[1]:void 0,h=0;h<f;){var d=b._getter(h);if(a.call(c,d,h,b))return d;++h}}});Object.defineProperty(b.prototype,"findIndex",{value:function(a){var b=v(this),f=b.length>>>0;if(!q(a))throw TypeError();for(var c=1<arguments.length?arguments[1]:void 0,h=0;h<f;){var d=b._getter(h);if(a.call(c,d,h,b))return h;++h}return-1}});Object.defineProperty(b.prototype,"forEach",{value:function(a,b){if(void 0===this||null===this)throw TypeError();
var e=Object(this),c=e.length>>>0;if(!q(a))throw TypeError();for(var h=0;h<c;h++)a.call(b,e._getter(h),h,e)}});Object.defineProperty(b.prototype,"indexOf",{value:function(a){if(void 0===this||null===this)throw TypeError();var b=Object(this),f=b.length>>>0;if(0===f)return-1;var c=0;0<arguments.length&&(c=Number(arguments[1]),c!==c?c=0:0!==c&&c!==1/0&&c!==-(1/0)&&(c=(0<c||-1)*u(y(c))));if(c>=f)return-1;for(c=0<=c?c:t(f-y(c),0);c<f;c++)if(b._getter(c)===a)return c;return-1}});Object.defineProperty(b.prototype,
"join",{value:function(a){if(void 0===this||null===this)throw TypeError();for(var b=Object(this),f=b.length>>>0,c=Array(f),h=0;h<f;++h)c[h]=b._getter(h);return c.join(void 0===a?",":a)}});Object.defineProperty(b.prototype,"lastIndexOf",{value:function(a){if(void 0===this||null===this)throw TypeError();var b=Object(this),f=b.length>>>0;if(0===f)return-1;var c=f;1<arguments.length&&(c=Number(arguments[1]),c!==c?c=0:0!==c&&c!==1/0&&c!==-(1/0)&&(c=(0<c||-1)*u(y(c))));for(f=0<=c?r(c,f-1):f-y(c);0<=f;f--)if(b._getter(f)===
a)return f;return-1}});Object.defineProperty(b.prototype,"map",{value:function(a,b){if(void 0===this||null===this)throw TypeError();var e=Object(this),c=e.length>>>0;if(!q(a))throw TypeError();var h=[];h.length=c;for(var d=0;d<c;d++)h[d]=a.call(b,e._getter(d),d,e);return new this.constructor(h)}});Object.defineProperty(b.prototype,"reduce",{value:function(a){if(void 0===this||null===this)throw TypeError();var b=Object(this),f=b.length>>>0;if(!q(a))throw TypeError();if(0===f&&1===arguments.length)throw TypeError();
var c=0,h;for(h=2<=arguments.length?arguments[1]:b._getter(c++);c<f;)h=a.call(void 0,h,b._getter(c),c,b),c++;return h}});Object.defineProperty(b.prototype,"reduceRight",{value:function(a){if(void 0===this||null===this)throw TypeError();var b=Object(this),f=b.length>>>0;if(!q(a))throw TypeError();if(0===f&&1===arguments.length)throw TypeError();--f;var c;for(c=2<=arguments.length?arguments[1]:b._getter(f--);0<=f;)c=a.call(void 0,c,b._getter(f),f,b),f--;return c}});Object.defineProperty(b.prototype,
"reverse",{value:function(){if(void 0===this||null===this)throw TypeError();var a=Object(this),b=a.length>>>0,f=u(b/2),c=0;for(--b;c<f;++c,--b){var d=a._getter(c);a._setter(c,a._getter(b));a._setter(b,d)}return a}});Object.defineProperty(b.prototype,"set",{value:function(a,b){if(1>arguments.length)throw SyntaxError("Not enough arguments");var f;if("object"===typeof arguments[0]&&arguments[0].constructor===this.constructor){var c=arguments[0];var e=arguments[1]>>>0;if(e+c.length>this.length)throw RangeError("Offset plus length of array is out of range");
var h=this.byteOffset+e*this.BYTES_PER_ELEMENT;e=c.length*this.BYTES_PER_ELEMENT;if(c.buffer===this.buffer){var d=[];var g=0;for(f=c.byteOffset;g<e;g+=1,f+=1)d[g]=c.buffer._bytes[f];for(g=0;g<e;g+=1,h+=1)this.buffer._bytes[h]=d[g]}else for(g=0,f=c.byteOffset;g<e;g+=1,f+=1,h+=1)this.buffer._bytes[h]=c.buffer._bytes[f]}else if("object"===typeof arguments[0]&&"undefined"!==typeof arguments[0].length){c=arguments[0];d=c.length>>>0;e=arguments[1]>>>0;if(e+d>this.length)throw RangeError("Offset plus length of array is out of range");
for(g=0;g<d;g+=1)f=c[g],this._setter(e+g,Number(f))}else throw TypeError("Unexpected argument type(s)");}});Object.defineProperty(b.prototype,"slice",{value:function(a,b){var f=v(this),c=f.length>>>0;a>>=0;a=0>a?t(c+a,0):r(a,c);b=void 0===b?c:b>>0;c=0>b?t(c+b,0):r(b,c);b=new f.constructor(c-a);for(var e=0;a<c;){var d=f._getter(a);b._setter(e,d);++a;++e}return b}});Object.defineProperty(b.prototype,"some",{value:function(a,b){if(void 0===this||null===this)throw TypeError();var e=Object(this),c=e.length>>>
0;if(!q(a))throw TypeError();for(var d=0;d<c;d++)if(a.call(b,e._getter(d),d,e))return!0;return!1}});Object.defineProperty(b.prototype,"sort",{value:function(a){if(void 0===this||null===this)throw TypeError();for(var b=Object(this),f=b.length>>>0,c=Array(f),d=0;d<f;++d)c[d]=b._getter(d);a?c.sort(a):c.sort();for(d=0;d<f;++d)b._setter(d,c[d]);return b}});Object.defineProperty(b.prototype,"subarray",{value:function(a,b){a>>=0;b>>=0;1>arguments.length&&(a=0);2>arguments.length&&(b=this.length);0>a&&(a=
this.length+a);0>b&&(b=this.length+b);var d=this.length;a=0>a?0:a>d?d:a;d=this.length;d=(0>b?0:b>d?d:b)-a;0>d&&(d=0);return new this.constructor(this.buffer,this.byteOffset+a*this.BYTES_PER_ELEMENT,d)}});var l=k(1,F,G),d=k(1,H,B),m=k(1,I,B),T=k(2,K,L),p=k(2,M,N),S=k(4,O,P),aa=k(4,Q,R),w=k(4,Z,Y),x=k(8,X,W);g.Int8Array=g.Int8Array||l;g.Uint8Array=g.Uint8Array||d;g.Uint8ClampedArray=g.Uint8ClampedArray||m;g.Int16Array=g.Int16Array||T;g.Uint16Array=g.Uint16Array||p;g.Int32Array=g.Int32Array||S;g.Uint32Array=
g.Uint32Array||aa;g.Float32Array=g.Float32Array||w;g.Float64Array=g.Float64Array||x})();(function(){function a(a,b){return q(a.get)?a.get(b):a[b]}function b(a,b,g){if(!(a instanceof ArrayBuffer||"ArrayBuffer"===A(a)))throw TypeError();b>>>=0;if(b>a.byteLength)throw RangeError("byteOffset out of range");g=void 0===g?a.byteLength-b:g>>>0;if(b+g>a.byteLength)throw RangeError("byteOffset and length reference an area beyond the end of the buffer");Object.defineProperty(this,"buffer",{value:a});Object.defineProperty(this,
"byteLength",{value:g});Object.defineProperty(this,"byteOffset",{value:b})}function k(b){return function(d,g){d>>>=0;if(d+b.BYTES_PER_ELEMENT>this.byteLength)throw RangeError("Array index out of range");d+=this.byteOffset;d=new Uint8Array(this.buffer,d,b.BYTES_PER_ELEMENT);for(var k=[],m=0;m<b.BYTES_PER_ELEMENT;m+=1)k.push(a(d,m));!!g===!!l&&k.reverse();return a(new b((new Uint8Array(k)).buffer),0)}}function n(b){return function(d,g,k){d>>>=0;if(d+b.BYTES_PER_ELEMENT>this.byteLength)throw RangeError("Array index out of range");
g=new b([g]);g=new Uint8Array(g.buffer);var m=[],n;for(n=0;n<b.BYTES_PER_ELEMENT;n+=1)m.push(a(g,n));!!k===!!l&&m.reverse();(new Uint8Array(this.buffer,d,b.BYTES_PER_ELEMENT)).set(m)}}var l=function(){var b=new Uint16Array([4660]);b=new Uint8Array(b.buffer);return 18===a(b,0)}();Object.defineProperty(b.prototype,"getUint8",{value:k(Uint8Array)});Object.defineProperty(b.prototype,"getInt8",{value:k(Int8Array)});Object.defineProperty(b.prototype,"getUint16",{value:k(Uint16Array)});Object.defineProperty(b.prototype,
"getInt16",{value:k(Int16Array)});Object.defineProperty(b.prototype,"getUint32",{value:k(Uint32Array)});Object.defineProperty(b.prototype,"getInt32",{value:k(Int32Array)});Object.defineProperty(b.prototype,"getFloat32",{value:k(Float32Array)});Object.defineProperty(b.prototype,"getFloat64",{value:k(Float64Array)});Object.defineProperty(b.prototype,"setUint8",{value:n(Uint8Array)});Object.defineProperty(b.prototype,"setInt8",{value:n(Int8Array)});Object.defineProperty(b.prototype,"setUint16",{value:n(Uint16Array)});
Object.defineProperty(b.prototype,"setInt16",{value:n(Int16Array)});Object.defineProperty(b.prototype,"setUint32",{value:n(Uint32Array)});Object.defineProperty(b.prototype,"setInt32",{value:n(Int32Array)});Object.defineProperty(b.prototype,"setFloat32",{value:n(Float32Array)});Object.defineProperty(b.prototype,"setFloat64",{value:n(Float64Array)});g.DataView=g.DataView||b})()})(self);

//     Underscore.js 1.9.0
//     http://underscorejs.org
//     (c) 2009-2018 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
//     Underscore may be freely distributed under the MIT license.
!function(){var n="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||this||{},r=n._,e=Array.prototype,o=Object.prototype,s="undefined"!=typeof Symbol?Symbol.prototype:null,u=e.push,c=e.slice,p=o.toString,i=o.hasOwnProperty,t=Array.isArray,a=Object.keys,l=Object.create,f=function(){},h=function(n){return n instanceof h?n:this instanceof h?void(this._wrapped=n):new h(n)};"undefined"==typeof exports||exports.nodeType?n._=h:("undefined"!=typeof module&&!module.nodeType&&module.exports&&(exports=module.exports=h),exports._=h),h.VERSION="1.9.0";var v,y=function(u,i,n){if(void 0===i)return u;switch(null==n?3:n){case 1:return function(n){return u.call(i,n)};case 3:return function(n,r,t){return u.call(i,n,r,t)};case 4:return function(n,r,t,e){return u.call(i,n,r,t,e)}}return function(){return u.apply(i,arguments)}},d=function(n,r,t){return h.iteratee!==v?h.iteratee(n,r):null==n?h.identity:h.isFunction(n)?y(n,r,t):h.isObject(n)&&!h.isArray(n)?h.matcher(n):h.property(n)};h.iteratee=v=function(n,r){return d(n,r,1/0)};var g=function(u,i){return i=null==i?u.length-1:+i,function(){for(var n=Math.max(arguments.length-i,0),r=Array(n),t=0;t<n;t++)r[t]=arguments[t+i];switch(i){case 0:return u.call(this,r);case 1:return u.call(this,arguments[0],r);case 2:return u.call(this,arguments[0],arguments[1],r)}var e=Array(i+1);for(t=0;t<i;t++)e[t]=arguments[t];return e[i]=r,u.apply(this,e)}},m=function(n){if(!h.isObject(n))return{};if(l)return l(n);f.prototype=n;var r=new f;return f.prototype=null,r},b=function(r){return function(n){return null==n?void 0:n[r]}},j=function(n,r){for(var t=r.length,e=0;e<t;e++){if(null==n)return;n=n[r[e]]}return t?n:void 0},x=Math.pow(2,53)-1,_=b("length"),A=function(n){var r=_(n);return"number"==typeof r&&0<=r&&r<=x};h.each=h.forEach=function(n,r,t){var e,u;if(r=y(r,t),A(n))for(e=0,u=n.length;e<u;e++)r(n[e],e,n);else{var i=h.keys(n);for(e=0,u=i.length;e<u;e++)r(n[i[e]],i[e],n)}return n},h.map=h.collect=function(n,r,t){r=d(r,t);for(var e=!A(n)&&h.keys(n),u=(e||n).length,i=Array(u),o=0;o<u;o++){var a=e?e[o]:o;i[o]=r(n[a],a,n)}return i};var w=function(c){return function(n,r,t,e){var u=3<=arguments.length;return function(n,r,t,e){var u=!A(n)&&h.keys(n),i=(u||n).length,o=0<c?0:i-1;for(e||(t=n[u?u[o]:o],o+=c);0<=o&&o<i;o+=c){var a=u?u[o]:o;t=r(t,n[a],a,n)}return t}(n,y(r,e,4),t,u)}};h.reduce=h.foldl=h.inject=w(1),h.reduceRight=h.foldr=w(-1),h.find=h.detect=function(n,r,t){var e=(A(n)?h.findIndex:h.findKey)(n,r,t);if(void 0!==e&&-1!==e)return n[e]},h.filter=h.select=function(n,e,r){var u=[];return e=d(e,r),h.each(n,function(n,r,t){e(n,r,t)&&u.push(n)}),u},h.reject=function(n,r,t){return h.filter(n,h.negate(d(r)),t)},h.every=h.all=function(n,r,t){r=d(r,t);for(var e=!A(n)&&h.keys(n),u=(e||n).length,i=0;i<u;i++){var o=e?e[i]:i;if(!r(n[o],o,n))return!1}return!0},h.some=h.any=function(n,r,t){r=d(r,t);for(var e=!A(n)&&h.keys(n),u=(e||n).length,i=0;i<u;i++){var o=e?e[i]:i;if(r(n[o],o,n))return!0}return!1},h.contains=h.includes=h.include=function(n,r,t,e){return A(n)||(n=h.values(n)),("number"!=typeof t||e)&&(t=0),0<=h.indexOf(n,r,t)},h.invoke=g(function(n,t,e){var u,i;return h.isFunction(t)?i=t:h.isArray(t)&&(u=t.slice(0,-1),t=t[t.length-1]),h.map(n,function(n){var r=i;if(!r){if(u&&u.length&&(n=j(n,u)),null==n)return;r=n[t]}return null==r?r:r.apply(n,e)})}),h.pluck=function(n,r){return h.map(n,h.property(r))},h.where=function(n,r){return h.filter(n,h.matcher(r))},h.findWhere=function(n,r){return h.find(n,h.matcher(r))},h.max=function(n,e,r){var t,u,i=-1/0,o=-1/0;if(null==e||"number"==typeof e&&"object"!=typeof n[0]&&null!=n)for(var a=0,c=(n=A(n)?n:h.values(n)).length;a<c;a++)null!=(t=n[a])&&i<t&&(i=t);else e=d(e,r),h.each(n,function(n,r,t){u=e(n,r,t),(o<u||u===-1/0&&i===-1/0)&&(i=n,o=u)});return i},h.min=function(n,e,r){var t,u,i=1/0,o=1/0;if(null==e||"number"==typeof e&&"object"!=typeof n[0]&&null!=n)for(var a=0,c=(n=A(n)?n:h.values(n)).length;a<c;a++)null!=(t=n[a])&&t<i&&(i=t);else e=d(e,r),h.each(n,function(n,r,t){((u=e(n,r,t))<o||u===1/0&&i===1/0)&&(i=n,o=u)});return i},h.shuffle=function(n){return h.sample(n,1/0)},h.sample=function(n,r,t){if(null==r||t)return A(n)||(n=h.values(n)),n[h.random(n.length-1)];var e=A(n)?h.clone(n):h.values(n),u=_(e);r=Math.max(Math.min(r,u),0);for(var i=u-1,o=0;o<r;o++){var a=h.random(o,i),c=e[o];e[o]=e[a],e[a]=c}return e.slice(0,r)},h.sortBy=function(n,e,r){var u=0;return e=d(e,r),h.pluck(h.map(n,function(n,r,t){return{value:n,index:u++,criteria:e(n,r,t)}}).sort(function(n,r){var t=n.criteria,e=r.criteria;if(t!==e){if(e<t||void 0===t)return 1;if(t<e||void 0===e)return-1}return n.index-r.index}),"value")};var O=function(o,r){return function(e,u,n){var i=r?[[],[]]:{};return u=d(u,n),h.each(e,function(n,r){var t=u(n,r,e);o(i,n,t)}),i}};h.groupBy=O(function(n,r,t){h.has(n,t)?n[t].push(r):n[t]=[r]}),h.indexBy=O(function(n,r,t){n[t]=r}),h.countBy=O(function(n,r,t){h.has(n,t)?n[t]++:n[t]=1});var k=/[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g;h.toArray=function(n){return n?h.isArray(n)?c.call(n):h.isString(n)?n.match(k):A(n)?h.map(n,h.identity):h.values(n):[]},h.size=function(n){return null==n?0:A(n)?n.length:h.keys(n).length},h.partition=O(function(n,r,t){n[t?0:1].push(r)},!0),h.first=h.head=h.take=function(n,r,t){if(!(null==n||n.length<1))return null==r||t?n[0]:h.initial(n,n.length-r)},h.initial=function(n,r,t){return c.call(n,0,Math.max(0,n.length-(null==r||t?1:r)))},h.last=function(n,r,t){if(!(null==n||n.length<1))return null==r||t?n[n.length-1]:h.rest(n,Math.max(0,n.length-r))},h.rest=h.tail=h.drop=function(n,r,t){return c.call(n,null==r||t?1:r)},h.compact=function(n){return h.filter(n,Boolean)};var S=function(n,r,t,e){for(var u=(e=e||[]).length,i=0,o=_(n);i<o;i++){var a=n[i];if(A(a)&&(h.isArray(a)||h.isArguments(a)))if(r)for(var c=0,l=a.length;c<l;)e[u++]=a[c++];else S(a,r,t,e),u=e.length;else t||(e[u++]=a)}return e};h.flatten=function(n,r){return S(n,r,!1)},h.without=g(function(n,r){return h.difference(n,r)}),h.uniq=h.unique=function(n,r,t,e){h.isBoolean(r)||(e=t,t=r,r=!1),null!=t&&(t=d(t,e));for(var u=[],i=[],o=0,a=_(n);o<a;o++){var c=n[o],l=t?t(c,o,n):c;r&&!t?(o&&i===l||u.push(c),i=l):t?h.contains(i,l)||(i.push(l),u.push(c)):h.contains(u,c)||u.push(c)}return u},h.union=g(function(n){return h.uniq(S(n,!0,!0))}),h.intersection=function(n){for(var r=[],t=arguments.length,e=0,u=_(n);e<u;e++){var i=n[e];if(!h.contains(r,i)){var o;for(o=1;o<t&&h.contains(arguments[o],i);o++);o===t&&r.push(i)}}return r},h.difference=g(function(n,r){return r=S(r,!0,!0),h.filter(n,function(n){return!h.contains(r,n)})}),h.unzip=function(n){for(var r=n&&h.max(n,_).length||0,t=Array(r),e=0;e<r;e++)t[e]=h.pluck(n,e);return t},h.zip=g(h.unzip),h.object=function(n,r){for(var t={},e=0,u=_(n);e<u;e++)r?t[n[e]]=r[e]:t[n[e][0]]=n[e][1];return t};var M=function(i){return function(n,r,t){r=d(r,t);for(var e=_(n),u=0<i?0:e-1;0<=u&&u<e;u+=i)if(r(n[u],u,n))return u;return-1}};h.findIndex=M(1),h.findLastIndex=M(-1),h.sortedIndex=function(n,r,t,e){for(var u=(t=d(t,e,1))(r),i=0,o=_(n);i<o;){var a=Math.floor((i+o)/2);t(n[a])<u?i=a+1:o=a}return i};var F=function(i,o,a){return function(n,r,t){var e=0,u=_(n);if("number"==typeof t)0<i?e=0<=t?t:Math.max(t+u,e):u=0<=t?Math.min(t+1,u):t+u+1;else if(a&&t&&u)return n[t=a(n,r)]===r?t:-1;if(r!=r)return 0<=(t=o(c.call(n,e,u),h.isNaN))?t+e:-1;for(t=0<i?e:u-1;0<=t&&t<u;t+=i)if(n[t]===r)return t;return-1}};h.indexOf=F(1,h.findIndex,h.sortedIndex),h.lastIndexOf=F(-1,h.findLastIndex),h.range=function(n,r,t){null==r&&(r=n||0,n=0),t||(t=r<n?-1:1);for(var e=Math.max(Math.ceil((r-n)/t),0),u=Array(e),i=0;i<e;i++,n+=t)u[i]=n;return u},h.chunk=function(n,r){if(null==r||r<1)return[];for(var t=[],e=0,u=n.length;e<u;)t.push(c.call(n,e,e+=r));return t};var E=function(n,r,t,e,u){if(!(e instanceof r))return n.apply(t,u);var i=m(n.prototype),o=n.apply(i,u);return h.isObject(o)?o:i};h.bind=g(function(r,t,e){if(!h.isFunction(r))throw new TypeError("Bind must be called on a function");var u=g(function(n){return E(r,u,t,this,e.concat(n))});return u}),h.partial=g(function(u,i){var o=h.partial.placeholder,a=function(){for(var n=0,r=i.length,t=Array(r),e=0;e<r;e++)t[e]=i[e]===o?arguments[n++]:i[e];for(;n<arguments.length;)t.push(arguments[n++]);return E(u,a,this,this,t)};return a}),(h.partial.placeholder=h).bindAll=g(function(n,r){var t=(r=S(r,!1,!1)).length;if(t<1)throw new Error("bindAll must be passed function names");for(;t--;){var e=r[t];n[e]=h.bind(n[e],n)}}),h.memoize=function(e,u){var i=function(n){var r=i.cache,t=""+(u?u.apply(this,arguments):n);return h.has(r,t)||(r[t]=e.apply(this,arguments)),r[t]};return i.cache={},i},h.delay=g(function(n,r,t){return setTimeout(function(){return n.apply(null,t)},r)}),h.defer=h.partial(h.delay,h,1),h.throttle=function(t,e,u){var i,o,a,c,l=0;u||(u={});var f=function(){l=!1===u.leading?0:h.now(),i=null,c=t.apply(o,a),i||(o=a=null)},n=function(){var n=h.now();l||!1!==u.leading||(l=n);var r=e-(n-l);return o=this,a=arguments,r<=0||e<r?(i&&(clearTimeout(i),i=null),l=n,c=t.apply(o,a),i||(o=a=null)):i||!1===u.trailing||(i=setTimeout(f,r)),c};return n.cancel=function(){clearTimeout(i),l=0,i=o=a=null},n},h.debounce=function(t,e,u){var i,o,a=function(n,r){i=null,r&&(o=t.apply(n,r))},n=g(function(n){if(i&&clearTimeout(i),u){var r=!i;i=setTimeout(a,e),r&&(o=t.apply(this,n))}else i=h.delay(a,e,this,n);return o});return n.cancel=function(){clearTimeout(i),i=null},n},h.wrap=function(n,r){return h.partial(r,n)},h.negate=function(n){return function(){return!n.apply(this,arguments)}},h.compose=function(){var t=arguments,e=t.length-1;return function(){for(var n=e,r=t[e].apply(this,arguments);n--;)r=t[n].call(this,r);return r}},h.after=function(n,r){return function(){if(--n<1)return r.apply(this,arguments)}},h.before=function(n,r){var t;return function(){return 0<--n&&(t=r.apply(this,arguments)),n<=1&&(r=null),t}},h.once=h.partial(h.before,2),h.restArguments=g;var N=!{toString:null}.propertyIsEnumerable("toString"),I=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],T=function(n,r){var t=I.length,e=n.constructor,u=h.isFunction(e)&&e.prototype||o,i="constructor";for(h.has(n,i)&&!h.contains(r,i)&&r.push(i);t--;)(i=I[t])in n&&n[i]!==u[i]&&!h.contains(r,i)&&r.push(i)};h.keys=function(n){if(!h.isObject(n))return[];if(a)return a(n);var r=[];for(var t in n)h.has(n,t)&&r.push(t);return N&&T(n,r),r},h.allKeys=function(n){if(!h.isObject(n))return[];var r=[];for(var t in n)r.push(t);return N&&T(n,r),r},h.values=function(n){for(var r=h.keys(n),t=r.length,e=Array(t),u=0;u<t;u++)e[u]=n[r[u]];return e},h.mapObject=function(n,r,t){r=d(r,t);for(var e=h.keys(n),u=e.length,i={},o=0;o<u;o++){var a=e[o];i[a]=r(n[a],a,n)}return i},h.pairs=function(n){for(var r=h.keys(n),t=r.length,e=Array(t),u=0;u<t;u++)e[u]=[r[u],n[r[u]]];return e},h.invert=function(n){for(var r={},t=h.keys(n),e=0,u=t.length;e<u;e++)r[n[t[e]]]=t[e];return r},h.functions=h.methods=function(n){var r=[];for(var t in n)h.isFunction(n[t])&&r.push(t);return r.sort()};var B=function(c,l){return function(n){var r=arguments.length;if(l&&(n=Object(n)),r<2||null==n)return n;for(var t=1;t<r;t++)for(var e=arguments[t],u=c(e),i=u.length,o=0;o<i;o++){var a=u[o];l&&void 0!==n[a]||(n[a]=e[a])}return n}};h.extend=B(h.allKeys),h.extendOwn=h.assign=B(h.keys),h.findKey=function(n,r,t){r=d(r,t);for(var e,u=h.keys(n),i=0,o=u.length;i<o;i++)if(r(n[e=u[i]],e,n))return e};var R,q,K=function(n,r,t){return r in t};h.pick=g(function(n,r){var t={},e=r[0];if(null==n)return t;h.isFunction(e)?(1<r.length&&(e=y(e,r[1])),r=h.allKeys(n)):(e=K,r=S(r,!1,!1),n=Object(n));for(var u=0,i=r.length;u<i;u++){var o=r[u],a=n[o];e(a,o,n)&&(t[o]=a)}return t}),h.omit=g(function(n,t){var r,e=t[0];return h.isFunction(e)?(e=h.negate(e),1<t.length&&(r=t[1])):(t=h.map(S(t,!1,!1),String),e=function(n,r){return!h.contains(t,r)}),h.pick(n,e,r)}),h.defaults=B(h.allKeys,!0),h.create=function(n,r){var t=m(n);return r&&h.extendOwn(t,r),t},h.clone=function(n){return h.isObject(n)?h.isArray(n)?n.slice():h.extend({},n):n},h.tap=function(n,r){return r(n),n},h.isMatch=function(n,r){var t=h.keys(r),e=t.length;if(null==n)return!e;for(var u=Object(n),i=0;i<e;i++){var o=t[i];if(r[o]!==u[o]||!(o in u))return!1}return!0},R=function(n,r,t,e){if(n===r)return 0!==n||1/n==1/r;if(null==n||null==r)return!1;if(n!=n)return r!=r;var u=typeof n;return("function"===u||"object"===u||"object"==typeof r)&&q(n,r,t,e)},q=function(n,r,t,e){n instanceof h&&(n=n._wrapped),r instanceof h&&(r=r._wrapped);var u=p.call(n);if(u!==p.call(r))return!1;switch(u){case"[object RegExp]":case"[object String]":return""+n==""+r;case"[object Number]":return+n!=+n?+r!=+r:0==+n?1/+n==1/r:+n==+r;case"[object Date]":case"[object Boolean]":return+n==+r;case"[object Symbol]":return s.valueOf.call(n)===s.valueOf.call(r)}var i="[object Array]"===u;if(!i){if("object"!=typeof n||"object"!=typeof r)return!1;var o=n.constructor,a=r.constructor;if(o!==a&&!(h.isFunction(o)&&o instanceof o&&h.isFunction(a)&&a instanceof a)&&"constructor"in n&&"constructor"in r)return!1}e=e||[];for(var c=(t=t||[]).length;c--;)if(t[c]===n)return e[c]===r;if(t.push(n),e.push(r),i){if((c=n.length)!==r.length)return!1;for(;c--;)if(!R(n[c],r[c],t,e))return!1}else{var l,f=h.keys(n);if(c=f.length,h.keys(r).length!==c)return!1;for(;c--;)if(l=f[c],!h.has(r,l)||!R(n[l],r[l],t,e))return!1}return t.pop(),e.pop(),!0},h.isEqual=function(n,r){return R(n,r)},h.isEmpty=function(n){return null==n||(A(n)&&(h.isArray(n)||h.isString(n)||h.isArguments(n))?0===n.length:0===h.keys(n).length)},h.isElement=function(n){return!(!n||1!==n.nodeType)},h.isArray=t||function(n){return"[object Array]"===p.call(n)},h.isObject=function(n){var r=typeof n;return"function"===r||"object"===r&&!!n},h.each(["Arguments","Function","String","Number","Date","RegExp","Error","Symbol","Map","WeakMap","Set","WeakSet"],function(r){h["is"+r]=function(n){return p.call(n)==="[object "+r+"]"}}),h.isArguments(arguments)||(h.isArguments=function(n){return h.has(n,"callee")});var z=n.document&&n.document.childNodes;"function"!=typeof/./&&"object"!=typeof Int8Array&&"function"!=typeof z&&(h.isFunction=function(n){return"function"==typeof n||!1}),h.isFinite=function(n){return!h.isSymbol(n)&&isFinite(n)&&!isNaN(parseFloat(n))},h.isNaN=function(n){return h.isNumber(n)&&isNaN(n)},h.isBoolean=function(n){return!0===n||!1===n||"[object Boolean]"===p.call(n)},h.isNull=function(n){return null===n},h.isUndefined=function(n){return void 0===n},h.has=function(n,r){if(!h.isArray(r))return null!=n&&i.call(n,r);for(var t=r.length,e=0;e<t;e++){var u=r[e];if(null==n||!i.call(n,u))return!1;n=n[u]}return!!t},h.noConflict=function(){return n._=r,this},h.identity=function(n){return n},h.constant=function(n){return function(){return n}},h.noop=function(){},h.property=function(r){return h.isArray(r)?function(n){return j(n,r)}:b(r)},h.propertyOf=function(r){return null==r?function(){}:function(n){return h.isArray(n)?j(r,n):r[n]}},h.matcher=h.matches=function(r){return r=h.extendOwn({},r),function(n){return h.isMatch(n,r)}},h.times=function(n,r,t){var e=Array(Math.max(0,n));r=y(r,t,1);for(var u=0;u<n;u++)e[u]=r(u);return e},h.random=function(n,r){return null==r&&(r=n,n=0),n+Math.floor(Math.random()*(r-n+1))},h.now=Date.now||function(){return(new Date).getTime()};var D={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},L=h.invert(D),P=function(r){var t=function(n){return r[n]},n="(?:"+h.keys(r).join("|")+")",e=RegExp(n),u=RegExp(n,"g");return function(n){return n=null==n?"":""+n,e.test(n)?n.replace(u,t):n}};h.escape=P(D),h.unescape=P(L),h.result=function(n,r,t){h.isArray(r)||(r=[r]);var e=r.length;if(!e)return h.isFunction(t)?t.call(n):t;for(var u=0;u<e;u++){var i=null==n?void 0:n[r[u]];void 0===i&&(i=t,u=e),n=h.isFunction(i)?i.call(n):i}return n};var W=0;h.uniqueId=function(n){var r=++W+"";return n?n+r:r},h.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var C=/(.)^/,J={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},U=/\\|'|\r|\n|\u2028|\u2029/g,V=function(n){return"\\"+J[n]};h.template=function(i,n,r){!n&&r&&(n=r),n=h.defaults({},n,h.templateSettings);var t,e=RegExp([(n.escape||C).source,(n.interpolate||C).source,(n.evaluate||C).source].join("|")+"|$","g"),o=0,a="__p+='";i.replace(e,function(n,r,t,e,u){return a+=i.slice(o,u).replace(U,V),o=u+n.length,r?a+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'":t?a+="'+\n((__t=("+t+"))==null?'':__t)+\n'":e&&(a+="';\n"+e+"\n__p+='"),n}),a+="';\n",n.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{t=new Function(n.variable||"obj","_",a)}catch(n){throw n.source=a,n}var u=function(n){return t.call(this,n,h)},c=n.variable||"obj";return u.source="function("+c+"){\n"+a+"}",u},h.chain=function(n){var r=h(n);return r._chain=!0,r};var $=function(n,r){return n._chain?h(r).chain():r};h.mixin=function(t){return h.each(h.functions(t),function(n){var r=h[n]=t[n];h.prototype[n]=function(){var n=[this._wrapped];return u.apply(n,arguments),$(this,r.apply(h,n))}}),h},h.mixin(h),h.each(["pop","push","reverse","shift","sort","splice","unshift"],function(r){var t=e[r];h.prototype[r]=function(){var n=this._wrapped;return t.apply(n,arguments),"shift"!==r&&"splice"!==r||0!==n.length||delete n[0],$(this,n)}}),h.each(["concat","join","slice"],function(n){var r=e[n];h.prototype[n]=function(){return $(this,r.apply(this._wrapped,arguments))}}),h.prototype.value=function(){return this._wrapped},h.prototype.valueOf=h.prototype.toJSON=h.prototype.value,h.prototype.toString=function(){return String(this._wrapped)},"function"==typeof define&&define.amd&&define("underscore",[],function(){return h})}();
(function (GLOBAL,jQuery) {

var $ = jQuery;
/* w2ui 1.4.2 (c) http://w2ui.com, vitmalina@gmail.com */
var w2ui  = w2ui  || {};
var w2obj = w2obj || {}; // expose object to be able to overwrite default functions

/************************************************
*  Library: Web 2.0 UI for jQuery
*  - Following objects are defines
*        - w2ui             - object that will contain all widgets
*        - w2obj            - object with widget prototypes
*        - w2utils          - basic utilities
*        - $().w2render     - common render
*        - $().w2destroy    - common destroy
*        - $().w2marker     - marker plugin
*        - $().w2tag        - tag plugin
*        - $().w2overlay    - overlay plugin
*        - $().w2menu       - menu plugin
*        - w2utils.event    - generic event object
*        - w2utils.keyboard - object for keyboard navigation
*  - Dependencies: jQuery
*
* == NICE TO HAVE ==
*   - date has problems in FF new Date('yyyy-mm-dd') breaks
*   - bug: w2utils.formatDate('2011-31-01', 'yyyy-dd-mm'); - wrong foratter
*   - overlay should be displayed where more space (on top or on bottom)
*   - write and article how to replace certain framework functions
*   - format date and time is buggy
*   - onComplete should pass widget as context (this)
*   - add maxHeight for the w2menu
*   - user localization from another lib (make it generic), https://github.com/jquery/globalize#readme
*   - hidden and disabled in menus
*   - isTime should support seconds
*   - TEST On IOS
*
************************************************/

var w2utils = (function () {
    var tmp = {}; // for some temp variables
    var obj = {
        version  : '1.4.2',
        settings : {
            "locale"            : "en-us",
            "date_format"       : "m/d/yyyy",
            "date_display"      : "Mon d, yyyy",
            "time_format"       : "hh:mi pm",
            "currencyPrefix"    : "$",
            "currencySuffix"    : "",
            "currencyPrecision" : 2,
            "groupSymbol"       : ",",
            "decimalSymbol"     : ".",
            "shortmonths"       : ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
            "fullmonths"        : ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
            "shortdays"         : ["M", "T", "W", "T", "F", "S", "S"],
            "fulldays"          : ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
            "dataType"          : 'HTTP',   // can be HTTP, RESTFULL, JSON (case sensative)
            "phrases"           : {}        // empty object for english phrases
        },
        isInt           : isInt,
        isFloat         : isFloat,
        isMoney         : isMoney,
        isHex           : isHex,
        isAlphaNumeric  : isAlphaNumeric,
        isEmail         : isEmail,
        isDate          : isDate,
        isTime          : isTime,
        age             : age,
        date            : date,
        size            : size,
        formatNumber    : formatNumber,
        formatDate      : formatDate,
        formatTime      : formatTime,
        formatDateTime  : formatDateTime,
        stripTags       : stripTags,
        encodeTags      : encodeTags,
        escapeId        : escapeId,
        base64encode    : base64encode,
        base64decode    : base64decode,
        transition      : transition,
        lock            : lock,
        unlock          : unlock,
        lang            : lang,
        locale          : locale,
        getSize         : getSize,
        scrollBarSize   : scrollBarSize,
        checkName       : checkName,
        checkUniqueId   : checkUniqueId,
        parseRoute      : parseRoute,
        // some internal variables
        isIOS : ((navigator.userAgent.toLowerCase().indexOf('iphone') != -1 ||
                 navigator.userAgent.toLowerCase().indexOf('ipod') != -1 ||
                 navigator.userAgent.toLowerCase().indexOf('ipad') != -1) 
                 ? true : false),
        isIE : ((navigator.userAgent.toLowerCase().indexOf('msie') != -1 ||
                 navigator.userAgent.toLowerCase().indexOf('trident') != -1 )
                 ? true : false)
    };
    return obj;

    function isInt (val) {
        var re = /^[-+]?[0-9]+$/;
        return re.test(val);
    }

    function isFloat (val) {
        if (typeof val == 'string') val = val.replace(w2utils.settings.decimalSymbol, '.');
        return (typeof val === 'number' || (typeof val === 'string' && val !== '')) && !isNaN(Number(val));
    }

    function isMoney (val) {
        var se = w2utils.settings;
        var re = new RegExp('^'+ (se.currencyPrefix ? '\\' + se.currencyPrefix + '?' : '') +'[-+]?[0-9]*[\\'+ w2utils.settings.decimalSymbol +']?[0-9]+'+ (se.currencySuffix ? '\\' + se.currencySuffix + '?' : '') +'$', 'i');
        if (typeof val === 'string') {
            val = val.replace(new RegExp(se.groupSymbol, 'g'), '');
        }
        if (typeof val === 'object' || val === '') return false;
        return re.test(val);
    }

    function isHex (val) {
        var re = /^[a-fA-F0-9]+$/;
        return re.test(val);
    }

    function isAlphaNumeric (val) {
        var re = /^[a-zA-Z0-9_-]+$/;
        return re.test(val);
    }

    function isEmail (val) {
        var email = /^[a-zA-Z0-9._%-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;
        return email.test(val);
    }

    function isDate (val, format, retDate) {
        if (!val) return false;

        var dt   = 'Invalid Date';
        var month, day, year;

        if (format == null) format = w2utils.settings.date_format;

        if (typeof val.getUTCFullYear === 'function' && typeof val.getUTCMonth === 'function' && typeof val.getUTCDate === 'function') {
            year = val.getUTCFullYear();
            month = val.getUTCMonth();
            day = val.getUTCDate();
        } else if (typeof val.getFullYear === 'function' && typeof val.getMonth === 'function' && typeof val.getDate === 'function') {
            year = val.getFullYear();
            month = val.getMonth();
            day = val.getDate();
        } else {
            val = String(val);
            // convert month formats
            if (RegExp('mon', 'ig').test(format)) {
                format = format.replace(/month/ig, 'm').replace(/mon/ig, 'm').replace(/dd/ig, 'd').replace(/[, ]/ig, '/').replace(/\/\//g, '/').toLowerCase();
                val    = val.replace(/[, ]/ig, '/').replace(/\/\//g, '/').toLowerCase();
                for (var m = 0, len = w2utils.settings.fullmonths.length; m < len; m++) {
                    var t = w2utils.settings.fullmonths[m];
                    val = val.replace(RegExp(t, 'ig'), (parseInt(m) + 1)).replace(RegExp(t.substr(0, 3), 'ig'), (parseInt(m) + 1));
                }
            }
            // format date
            var tmp  = val.replace(/-/g, '/').replace(/\./g, '/').toLowerCase().split('/');
            var tmp2 = format.replace(/-/g, '/').replace(/\./g, '/').toLowerCase();
            if (tmp2 === 'mm/dd/yyyy') { month = tmp[0]; day = tmp[1]; year = tmp[2]; }
            if (tmp2 === 'm/d/yyyy')   { month = tmp[0]; day = tmp[1]; year = tmp[2]; }
            if (tmp2 === 'dd/mm/yyyy') { month = tmp[1]; day = tmp[0]; year = tmp[2]; }
            if (tmp2 === 'd/m/yyyy')   { month = tmp[1]; day = tmp[0]; year = tmp[2]; }
            if (tmp2 === 'yyyy/dd/mm') { month = tmp[2]; day = tmp[1]; year = tmp[0]; }
            if (tmp2 === 'yyyy/d/m')   { month = tmp[2]; day = tmp[1]; year = tmp[0]; }
            if (tmp2 === 'yyyy/mm/dd') { month = tmp[1]; day = tmp[2]; year = tmp[0]; }
            if (tmp2 === 'yyyy/m/d')   { month = tmp[1]; day = tmp[2]; year = tmp[0]; }
            if (tmp2 === 'mm/dd/yy')   { month = tmp[0]; day = tmp[1]; year = tmp[2]; }
            if (tmp2 === 'm/d/yy')     { month = tmp[0]; day = tmp[1]; year = parseInt(tmp[2]) + 1900; }
            if (tmp2 === 'dd/mm/yy')   { month = tmp[1]; day = tmp[0]; year = parseInt(tmp[2]) + 1900; }
            if (tmp2 === 'd/m/yy')     { month = tmp[1]; day = tmp[0]; year = parseInt(tmp[2]) + 1900; }
            if (tmp2 === 'yy/dd/mm')   { month = tmp[2]; day = tmp[1]; year = parseInt(tmp[0]) + 1900; }
            if (tmp2 === 'yy/d/m')     { month = tmp[2]; day = tmp[1]; year = parseInt(tmp[0]) + 1900; }
            if (tmp2 === 'yy/mm/dd')   { month = tmp[1]; day = tmp[2]; year = parseInt(tmp[0]) + 1900; }
            if (tmp2 === 'yy/m/d')     { month = tmp[1]; day = tmp[2]; year = parseInt(tmp[0]) + 1900; }
        }
        if (!isInt(year)) return false;
        if (!isInt(month)) return false;
        if (!isInt(day)) return false;
        year = +year;
        month = +month;
        day = +day;
        dt = new Date(year, month - 1, day);
        // do checks
        if (month == null) return false;
        if (dt === 'Invalid Date') return false;
        if ((dt.getMonth() + 1 !== month) || (dt.getDate() !== day) || (dt.getFullYear() !== year)) return false;
        if (retDate === true) return dt; else return true;
    }

    function isTime (val, retTime) {
        // Both formats 10:20pm and 22:20
        if (val == null) return false;
        var max, pm;
        // -- process american format
        val = String(val);
        val = val.toUpperCase();
        pm = val.indexOf('PM') >= 0;
        var ampm = (pm || val.indexOf('AM') >= 0);
        if (ampm) max = 12; else max = 24;
        val = val.replace('AM', '').replace('PM', '');
        val = $.trim(val);
        // ---
        var tmp = val.split(':');
        var h = parseInt(tmp[0] || 0), m = parseInt(tmp[1] || 0);
        // accept edge case: 3PM is a good timestamp, but 3 (without AM or PM) is NOT:
        if ((!ampm || tmp.length !== 1) && tmp.length !== 2) { return false; }
        if (tmp[0] === '' || h < 0 || h > max || !this.isInt(tmp[0]) || tmp[0].length > 2) { return false; }
        if (tmp.length === 2 && (tmp[1] === '' || m < 0 || m > 59 || !this.isInt(tmp[1]) || tmp[1].length !== 2)) { return false; }
        // check the edge cases: 12:01AM is ok, as is 12:01PM, but 24:01 is NOT ok while 24:00 is (midnight; equivalent to 00:00).
        // meanwhile, there is 00:00 which is ok, but 0AM nor 0PM are okay, while 0:01AM and 0:00AM are.
        if (!ampm && max === h && m !== 0) { return false; }
        if (ampm && tmp.length === 1 && h === 0) { return false; }

        if (retTime === true) {
            if (pm) h += 12;
            return {
                hours: h,
                minutes: m
            };
        }
        return true;
    }

    function age (dateStr) {
        if (dateStr === '' || dateStr == null) return '';
        var d1 = new Date(dateStr);
        if (w2utils.isInt(dateStr)) d1 = new Date(Number(dateStr)); // for unix timestamps
        if (d1 === 'Invalid Date') return '';

        var d2  = new Date();
        var sec = (d2.getTime() - d1.getTime()) / 1000;
        var amount = '';
        var type   = '';
        if (sec < 0) {
            amount = '<span style="color: #aaa">future</span>';
            type   = '';
        } else if (sec < 60) {
            amount = Math.floor(sec);
            type   = 'sec';
            if (sec < 0) { amount = 0; type = 'sec'; }
        } else if (sec < 60*60) {
            amount = Math.floor(sec/60);
            type   = 'min';
        } else if (sec < 24*60*60) {
            amount = Math.floor(sec/60/60);
            type   = 'hour';
        } else if (sec < 30*24*60*60) {
            amount = Math.floor(sec/24/60/60);
            type   = 'day';
        } else if (sec < 365.25*24*60*60) {
            amount = Math.floor(sec/365.25/24/60/60*10)/10;
            type   = 'month';
        } else if (sec >= 365.25*24*60*60) {
            amount = Math.floor(sec/365.25/24/60/60*10)/10;
            type   = 'year';
        }
        return amount + ' ' + type + (amount > 1 ? 's' : '');
    }

    function date (dateStr) {
        if (dateStr === '' || dateStr == null) return '';
        var d1 = new Date(dateStr);
        if (w2utils.isInt(dateStr)) d1 = new Date(Number(dateStr)); // for unix timestamps
        if (d1 === 'Invalid Date') return '';

        var months = w2utils.settings.shortmonths;
        var d2   = new Date(); // today
        var d3   = new Date();
        d3.setTime(d3.getTime() - 86400000); // yesterday

        var dd1  = months[d1.getMonth()] + ' ' + d1.getDate() + ', ' + d1.getFullYear();
        var dd2  = months[d2.getMonth()] + ' ' + d2.getDate() + ', ' + d2.getFullYear();
        var dd3  = months[d3.getMonth()] + ' ' + d3.getDate() + ', ' + d3.getFullYear();

        var time = (d1.getHours() - (d1.getHours() > 12 ? 12 :0)) + ':' + (d1.getMinutes() < 10 ? '0' : '') + d1.getMinutes() + ' ' + (d1.getHours() >= 12 ? 'pm' : 'am');
        var time2= (d1.getHours() - (d1.getHours() > 12 ? 12 :0)) + ':' + (d1.getMinutes() < 10 ? '0' : '') + d1.getMinutes() + ':' + (d1.getSeconds() < 10 ? '0' : '') + d1.getSeconds() + ' ' + (d1.getHours() >= 12 ? 'pm' : 'am');
        var dsp = dd1;
        if (dd1 === dd2) dsp = time;
        if (dd1 === dd3) dsp = w2utils.lang('Yesterday');

        return '<span title="'+ dd1 +' ' + time2 +'">'+ dsp +'</span>';
    }

    function size (sizeStr) {
        if (!w2utils.isFloat(sizeStr) || sizeStr === '') return '';
        sizeStr = parseFloat(sizeStr);
        if (sizeStr === 0) return 0;
        var sizes = ['Bt', 'KB', 'MB', 'GB', 'TB'];
        var i = parseInt( Math.floor( Math.log(sizeStr) / Math.log(1024) ) );
        return (Math.floor(sizeStr / Math.pow(1024, i) * 10) / 10).toFixed(i === 0 ? 0 : 1) + ' ' + sizes[i];
    }

    function formatNumber (val, groupSymbol, decimalSymbol) {
        var ret = '';
        if (groupSymbol == null) groupSymbol = w2utils.settings.groupSymbol || ',';
        if (decimalSymbol == null) decimalSymbol = w2utils.settings.decimalSymbol || '.';
        // check if this is a number
        if (w2utils.isFloat(val) || w2utils.isInt(val) || w2utils.isMoney(val)) {
            tmp = String(val).split('.');
            ret = String(tmp[0]).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1" + groupSymbol);
            if (tmp[1] != null) ret += w2utils.settings.decimalSymbol + tmp[1];
        }
        return ret;
    }

    function formatDate (dateStr, format) { // IMPORTANT dateStr HAS TO BE valid JavaScript Date String
        var months = w2utils.settings.shortmonths;
        var fullMonths = w2utils.settings.fullmonths;
        if (!format) format = this.settings.date_format;
        if (dateStr === '' || dateStr == null || (typeof dateStr == 'object' && !dateStr.getMonth)) return '';

        var dt = new Date(dateStr);
        if (w2utils.isInt(dateStr)) dt = new Date(Number(dateStr)); // for unix timestamps
        if (dt === 'Invalid Date') return '';

        var year  = dt.getFullYear();
        var month = dt.getMonth();
        var date  = dt.getDate();
        return format.toLowerCase()
            .replace('month', w2utils.settings.fullmonths[month])
            .replace('mon', w2utils.settings.shortmonths[month])
            .replace(/yyyy/g, year)
            .replace(/yyy/g, year)
            .replace(/yy/g, year > 2000 ? 100 + parseInt(String(year).substr(2)) : String(year).substr(2))
            .replace(/(^|[^a-z$])y/g, '$1' + year)            // only y's that are not preceeded by a letter
            .replace(/mm/g, (month + 1 < 10 ? '0' : '') + (month + 1))
            .replace(/dd/g, (date < 10 ? '0' : '') + date)
            .replace(/th/g, (date == 1 ? 'st' : 'th'))
            .replace(/th/g, (date == 2 ? 'nd' : 'th'))
            .replace(/th/g, (date == 3 ? 'rd' : 'th'))
            .replace(/(^|[^a-z$])m/g, '$1' + (month + 1))     // only y's that are not preceeded by a letter
            .replace(/(^|[^a-z$])d/g, '$1' + date);           // only y's that are not preceeded by a letter
    }

    function formatTime (dateStr, format) { // IMPORTANT dateStr HAS TO BE valid JavaScript Date String
        var months = w2utils.settings.shortmonths;
        var fullMonths = w2utils.settings.fullmonths;
        if (!format) format = this.settings.time_format;
        if (dateStr === '' || dateStr == null || (typeof dateStr == 'object' && !dateStr.getMonth)) return '';

        var dt = new Date(dateStr);
        if (w2utils.isInt(dateStr)) dt  = new Date(Number(dateStr)); // for unix timestamps
        if (w2utils.isTime(dateStr)) {
            var tmp = w2utils.isTime(dateStr, true);
            dt = new Date();
            dt.setHours(tmp.hours);
            dt.setMinutes(tmp.minutes);
        }
        if (dt === 'Invalid Date') return '';

        var type = 'am';
        var hour = dt.getHours();
        var h24  = dt.getHours();
        var min  = dt.getMinutes();
        var sec  = dt.getSeconds();
        if (min < 10) min = '0' + min;
        if (sec < 10) sec = '0' + sec;
        if (format.indexOf('am') !== -1 || format.indexOf('pm') !== -1) {
            if (hour >= 12) type = 'pm';
            if (hour > 12)  hour = hour - 12;
        }
        return format.toLowerCase()
            .replace('am', type)
            .replace('pm', type)
            .replace('hhh', (hour < 10 ? '0' + hour : hour))
            .replace('hh24', (h24 < 10 ? '0' + h24 : h24))
            .replace('h24', h24)
            .replace('hh', hour)
            .replace('mm', min)
            .replace('mi', min)
            .replace('ss', sec)
            .replace(/(^|[^a-z$])h/g, '$1' + hour)    // only y's that are not preceeded by a letter
            .replace(/(^|[^a-z$])m/g, '$1' + min)     // only y's that are not preceeded by a letter
            .replace(/(^|[^a-z$])s/g, '$1' + sec);    // only y's that are not preceeded by a letter
    }

    function formatDateTime(dateStr, format) {
        var fmt;
        if (dateStr === '' || dateStr == null || (typeof dateStr == 'object' && !dateStr.getMonth)) return '';
        if (typeof format !== 'string') {
            fmt = [this.settings.date_format, this.settings.time_format];
        } else {
            fmt = format.split('|');
        }
        return this.formatDate(dateStr, fmt[0]) + ' ' + this.formatTime(dateStr, fmt[1]);
    }

    function stripTags (html) {
        if (html === null) return html;
        switch (typeof html) {
            case 'number':
                break;
            case 'string':
                html = $.trim(String(html).replace(/(<([^>]+)>)/ig, ""));
                break;
            case 'object':
                for (var a in html) html[a] = this.stripTags(html[a]);
                break;
        }
        return html;
    }

    function encodeTags (html) {
        if (html === null) return html;
        switch (typeof html) {
            case 'number':
                break;
            case 'string':
                html = String(html).replace(/&/g, "&amp;").replace(/>/g, "&gt;").replace(/</g, "&lt;").replace(/"/g, "&quot;");
                break;
            case 'object':
                for (var a in html) html[a] = this.encodeTags(html[a]);
                break;
        }
        return html;
    }

    function escapeId (id) {
        if (id === '' || id == null) return '';
        return String(id).replace(/([;&,\.\+\*\~'`:"\!\^#$%@\[\]\(\)=<>\|\/? {}\\])/g, '\\$1');
    }

    function base64encode (input) {
        var output = "";
        var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
        var i = 0;
        var keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
        input = utf8_encode(input);

        while (i < input.length) {
            chr1 = input.charCodeAt(i++);
            chr2 = input.charCodeAt(i++);
            chr3 = input.charCodeAt(i++);
            enc1 = chr1 >> 2;
            enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
            enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
            enc4 = chr3 & 63;
            if (isNaN(chr2)) {
                enc3 = enc4 = 64;
            } else if (isNaN(chr3)) {
                enc4 = 64;
            }
            output = output + keyStr.charAt(enc1) + keyStr.charAt(enc2) + keyStr.charAt(enc3) + keyStr.charAt(enc4);
        }

        function utf8_encode (string) {
            var string = String(string).replace(/\r\n/g,"\n");
            var utftext = "";

            for (var n = 0; n < string.length; n++) {
                var c = string.charCodeAt(n);
                if (c < 128) {
                    utftext += String.fromCharCode(c);
                }
                else if((c > 127) && (c < 2048)) {
                    utftext += String.fromCharCode((c >> 6) | 192);
                    utftext += String.fromCharCode((c & 63) | 128);
                }
                else {
                    utftext += String.fromCharCode((c >> 12) | 224);
                    utftext += String.fromCharCode(((c >> 6) & 63) | 128);
                    utftext += String.fromCharCode((c & 63) | 128);
                }
            }
            return utftext;
        }

        return output;
    }

    function base64decode (input) {
        var output = "";
        var chr1, chr2, chr3;
        var enc1, enc2, enc3, enc4;
        var i = 0;
        var keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
        input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");

        while (i < input.length) {
            enc1 = keyStr.indexOf(input.charAt(i++));
            enc2 = keyStr.indexOf(input.charAt(i++));
            enc3 = keyStr.indexOf(input.charAt(i++));
            enc4 = keyStr.indexOf(input.charAt(i++));
            chr1 = (enc1 << 2) | (enc2 >> 4);
            chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
            chr3 = ((enc3 & 3) << 6) | enc4;
            output = output + String.fromCharCode(chr1);
            if (enc3 !== 64) {
                output = output + String.fromCharCode(chr2);
            }
            if (enc4 !== 64) {
                output = output + String.fromCharCode(chr3);
            }
        }
        output = utf8_decode(output);

        function utf8_decode (utftext) {
            var string = "";
            var i = 0;
            var c = 0, c2, c3;

            while ( i < utftext.length ) {
                c = utftext.charCodeAt(i);
                if (c < 128) {
                    string += String.fromCharCode(c);
                    i++;
                }
                else if((c > 191) && (c < 224)) {
                    c2 = utftext.charCodeAt(i+1);
                    string += String.fromCharCode(((c & 31) << 6) | (c2 & 63));
                    i += 2;
                }
                else {
                    c2 = utftext.charCodeAt(i+1);
                    c3 = utftext.charCodeAt(i+2);
                    string += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));
                    i += 3;
                }
            }

            return string;
        }

        return output;
    }

    function transition (div_old, div_new, type, callBack) {
        var width  = $(div_old).width();
        var height = $(div_old).height();
        var time   = 0.5;

        if (!div_old || !div_new) {
            console.log('ERROR: Cannot do transition when one of the divs is null');
            return;
        }

        div_old.parentNode.style.cssText += cross('perspective', '700px') +'; overflow: hidden;';
        div_old.style.cssText += '; position: absolute; z-index: 1019; '+ cross('backface-visibility', 'hidden');
        div_new.style.cssText += '; position: absolute; z-index: 1020; '+ cross('backface-visibility', 'hidden');

        switch (type) {
            case 'slide-left':
                // init divs
                div_old.style.cssText += 'overflow: hidden; '+ cross('transform', 'translate3d(0, 0, 0)', 'translate(0, 0)');
                div_new.style.cssText += 'overflow: hidden; '+ cross('transform', 'translate3d('+ width + 'px, 0, 0)', 'translate('+ width +'px, 0)');
                $(div_new).show();
                // -- need a timing function because otherwise not working
                window.setTimeout(function() {
                    div_new.style.cssText += cross('transition', time+'s') +';'+ cross('transform', 'translate3d(0, 0, 0)', 'translate(0, 0)');
                    div_old.style.cssText += cross('transition', time+'s') +';'+ cross('transform', 'translate3d(-'+ width +'px, 0, 0)', 'translate(-'+ width +'px, 0)');
                }, 1);
                break;

            case 'slide-right':
                // init divs
                div_old.style.cssText += 'overflow: hidden; '+ cross('transform', 'translate3d(0, 0, 0)', 'translate(0, 0)');
                div_new.style.cssText += 'overflow: hidden; '+ cross('transform', 'translate3d(-'+ width +'px, 0, 0)', 'translate(-'+ width +'px, 0)');
                $(div_new).show();
                // -- need a timing function because otherwise not working
                window.setTimeout(function() {
                    div_new.style.cssText += cross('transition', time+'s') +'; '+ cross('transform', 'translate3d(0px, 0, 0)', 'translate(0px, 0)');
                    div_old.style.cssText += cross('transition', time+'s') +'; '+ cross('transform', 'translate3d('+ width +'px, 0, 0)', 'translate('+ width +'px, 0)');
                }, 1);
                break;

            case 'slide-down':
                // init divs
                div_old.style.cssText += 'overflow: hidden; z-index: 1; '+ cross('transform', 'translate3d(0, 0, 0)', 'translate(0, 0)');
                div_new.style.cssText += 'overflow: hidden; z-index: 0; '+ cross('transform', 'translate3d(0, 0, 0)', 'translate(0, 0)');
                $(div_new).show();
                // -- need a timing function because otherwise not working
                window.setTimeout(function() {
                    div_new.style.cssText += cross('transition', time+'s') +'; '+ cross('transform', 'translate3d(0, 0, 0)', 'translate(0, 0)');
                    div_old.style.cssText += cross('transition', time+'s') +'; '+ cross('transform', 'translate3d(0, '+ height +'px, 0)', 'translate(0, '+ height +'px)');
                }, 1);
                break;

            case 'slide-up':
                // init divs
                div_old.style.cssText += 'overflow: hidden; '+ cross('transform', 'translate3d(0, 0, 0)', 'translate(0, 0)');
                div_new.style.cssText += 'overflow: hidden; '+ cross('transform', 'translate3d(0, '+ height +'px, 0)', 'translate(0, '+ height +'px)');
                $(div_new).show();
                // -- need a timing function because otherwise not working
                window.setTimeout(function() {
                    div_new.style.cssText += cross('transition', time+'s') +'; '+ cross('transform', 'translate3d(0, 0, 0)', 'translate(0, 0)');
                    div_old.style.cssText += cross('transition', time+'s') +'; '+ cross('transform', 'translate3d(0, 0, 0)', 'translate(0, 0)');
                }, 1);
                break;

            case 'flip-left':
                // init divs
                div_old.style.cssText += 'overflow: hidden; '+ cross('transform', 'rotateY(0deg)');
                div_new.style.cssText += 'overflow: hidden; '+ cross('transform', 'rotateY(-180deg)');
                $(div_new).show();
                // -- need a timing function because otherwise not working
                window.setTimeout(function() {
                    div_new.style.cssText += cross('transition', time+'s') +'; '+ cross('transform', 'rotateY(0deg)');
                    div_old.style.cssText += cross('transition', time+'s') +'; '+ cross('transform', 'rotateY(180deg)');
                }, 1);
                break;

            case 'flip-right':
                // init divs
                div_old.style.cssText += 'overflow: hidden; '+ cross('transform', 'rotateY(0deg)');
                div_new.style.cssText += 'overflow: hidden; '+ cross('transform', 'rotateY(180deg)');
                $(div_new).show();
                // -- need a timing function because otherwise not working
                window.setTimeout(function() {
                    div_new.style.cssText += cross('transition', time+'s') +'; '+ cross('transform', 'rotateY(0deg)');
                    div_old.style.cssText += cross('transition', time+'s') +'; '+ cross('transform', 'rotateY(-180deg)');
                }, 1);
                break;

            case 'flip-down':
                // init divs
                div_old.style.cssText += 'overflow: hidden; '+ cross('transform', 'rotateX(0deg)');
                div_new.style.cssText += 'overflow: hidden; '+ cross('transform', 'rotateX(180deg)');
                $(div_new).show();
                // -- need a timing function because otherwise not working
                window.setTimeout(function() {
                    div_new.style.cssText += cross('transition', time+'s') +'; '+ cross('transform', 'rotateX(0deg)');
                    div_old.style.cssText += cross('transition', time+'s') +'; '+ cross('transform', 'rotateX(-180deg)');
                }, 1);
                break;

            case 'flip-up':
                // init divs
                div_old.style.cssText += 'overflow: hidden; '+ cross('transform', 'rotateX(0deg)');
                div_new.style.cssText += 'overflow: hidden; '+ cross('transform', 'rotateX(-180deg)');
                $(div_new).show();
                // -- need a timing function because otherwise not working
                window.setTimeout(function() {
                    div_new.style.cssText += cross('transition', time+'s') +'; '+ cross('transform', 'rotateX(0deg)');
                    div_old.style.cssText += cross('transition', time+'s') +'; '+ cross('transform', 'rotateX(180deg)');
                }, 1);
                break;

            case 'pop-in':
                // init divs
                div_old.style.cssText += 'overflow: hidden; '+ cross('transform', 'translate3d(0, 0, 0)', 'translate(0, 0)');
                div_new.style.cssText += 'overflow: hidden; '+ cross('transform', 'translate3d(0, 0, 0)', 'translate(0, 0)') + '; '+ cross('transform', 'scale(.8)') + '; opacity: 0;';
                $(div_new).show();
                // -- need a timing function because otherwise not working
                window.setTimeout(function() {
                    div_new.style.cssText += cross('transition', time+'s') +'; '+ cross('transform', 'scale(1)') +'; opacity: 1;';
                    div_old.style.cssText += cross('transition', time+'s') +';';
                }, 1);
                break;

            case 'pop-out':
                // init divs
                div_old.style.cssText += 'overflow: hidden; '+ cross('transform', 'translate3d(0, 0, 0)', 'translate(0, 0)') +'; '+ cross('transform', 'scale(1)') +'; opacity: 1;';
                div_new.style.cssText += 'overflow: hidden; '+ cross('transform', 'translate3d(0, 0, 0)', 'translate(0, 0)') +'; opacity: 0;';
                $(div_new).show();
                // -- need a timing function because otherwise not working
                window.setTimeout(function() {
                    div_new.style.cssText += cross('transition', time+'s') +'; opacity: 1;';
                    div_old.style.cssText += cross('transition', time+'s') +'; '+ cross('transform', 'scale(1.7)') +'; opacity: 0;';
                }, 1);
                break;

            default:
                // init divs
                div_old.style.cssText += 'overflow: hidden; '+ cross('transform', 'translate3d(0, 0, 0)', 'translate(0, 0)');
                div_new.style.cssText += 'overflow: hidden; '+ cross('transform', 'translate3d(0, 0, 0)', 'translate(0, 0)') +'; opacity: 0;';
                $(div_new).show();
                // -- need a timing function because otherwise not working
                window.setTimeout(function() {
                    div_new.style.cssText += cross('transition', time +'s') +'; opacity: 1;';
                    div_old.style.cssText += cross('transition', time +'s');
                }, 1);
                break;
        }

        setTimeout(function () {
            if (type === 'slide-down') {
                $(div_old).css('z-index', '1019');
                $(div_new).css('z-index', '1020');
            }
            if (div_new) {
                $(div_new).css({
                    'opacity': '1',
                    '-webkit-transition': '',
                    '-moz-transition': '',
                    '-ms-transition': '',
                    '-o-transition': '',
                    '-webkit-transform': '',
                    '-moz-transform': '',
                    '-ms-transform': '',
                    '-o-transform': '',
                    '-webkit-backface-visibility': '',
                    '-moz-backface-visibility': '',
                    '-ms-backface-visibility': '',
                    '-o-backface-visibility': ''
                });
            }
            if (div_old) {
                $(div_old).css({
                    'opacity': '1',
                    '-webkit-transition': '',
                    '-moz-transition': '',
                    '-ms-transition': '',
                    '-o-transition': '',
                    '-webkit-transform': '',
                    '-moz-transform': '',
                    '-ms-transform': '',
                    '-o-transform': '',
                    '-webkit-backface-visibility': '',
                    '-moz-backface-visibility': '',
                    '-ms-backface-visibility': '',
                    '-o-backface-visibility': ''
                });
                if (div_old.parentNode) $(div_old.parentNode).css({
                    '-webkit-perspective': '',
                    '-moz-perspective': '',
                    '-ms-perspective': '',
                    '-o-perspective': ''
                });
            }
            if (typeof callBack === 'function') callBack();
        }, time * 1000);

        function cross(property, value, none_webkit_value) {
            var isWebkit=!!window.webkitURL; // jQuery no longer supports $.browser - RR
            if (!isWebkit && typeof none_webkit_value !== 'undefined') value = none_webkit_value;
            return ';'+ property +': '+ value +'; -webkit-'+ property +': '+ value +'; -moz-'+ property +': '+ value +'; '+
                '-ms-'+ property +': '+ value +'; -o-'+ property +': '+ value +';';
        }
    }

    function lock (box, msg, spinner) {
        var options = {};
        if (typeof msg === 'object') {
            options = msg;
        } else {
            options.msg     = msg;
            options.spinner = spinner;
        }
        if (!options.msg && options.msg !== 0) options.msg = '';
        w2utils.unlock(box);
        $(box).prepend(
            '<div class="w2ui-lock"></div>'+
            '<div class="w2ui-lock-msg"></div>'
        );
        var $lock = $(box).find('.w2ui-lock');
        var mess = $(box).find('.w2ui-lock-msg');
        if (!options.msg) mess.css({ 'background-color': 'transparent', 'border': '0px' });
        if (options.spinner === true) options.msg = '<div class="w2ui-spinner" '+ (!options.msg ? 'style="width: 35px; height: 35px"' : '') +'></div>' + options.msg;
        if (options.opacity != null) $lock.css('opacity', options.opacity);
        if (typeof $lock.fadeIn == 'function') {
            $lock.fadeIn(200);
            mess.html(options.msg).fadeIn(200);
        } else {
            $lock.show();
            mess.html(options.msg).show(0);            
        }
        // hide all tags (do not hide overlays as the form can be in overlay)
        $().w2tag();
    }

    function unlock (box) {
        $(box).find('.w2ui-lock').remove();
        $(box).find('.w2ui-lock-msg').remove();
    }

    function getSize (el, type) {
        var $el = $(el);
        var bwidth = {
            left    : parseInt($el.css('border-left-width')) || 0,
            right   : parseInt($el.css('border-right-width')) || 0,
            top     : parseInt($el.css('border-top-width')) || 0,
            bottom  : parseInt($el.css('border-bottom-width')) || 0
        };
        var mwidth = {
            left    : parseInt($el.css('margin-left')) || 0,
            right   : parseInt($el.css('margin-right')) || 0,
            top     : parseInt($el.css('margin-top')) || 0,
            bottom  : parseInt($el.css('margin-bottom')) || 0
        };
        var pwidth = {
            left    : parseInt($el.css('padding-left')) || 0,
            right   : parseInt($el.css('padding-right')) || 0,
            top     : parseInt($el.css('padding-top')) || 0,
            bottom  : parseInt($el.css('padding-bottom')) || 0
        };
        switch (type) {
            case 'top'      : return bwidth.top + mwidth.top + pwidth.top;
            case 'bottom'   : return bwidth.bottom + mwidth.bottom + pwidth.bottom;
            case 'left'     : return bwidth.left + mwidth.left + pwidth.left;
            case 'right'    : return bwidth.right + mwidth.right + pwidth.right;
            case 'width'    : return bwidth.left + bwidth.right + mwidth.left + mwidth.right + pwidth.left + pwidth.right + parseInt($el.width());
            case 'height'   : return bwidth.top + bwidth.bottom + mwidth.top + mwidth.bottom + pwidth.top + pwidth.bottom + parseInt($el.height());
            case '+width'   : return bwidth.left + bwidth.right + mwidth.left + mwidth.right + pwidth.left + pwidth.right;
            case '+height'  : return bwidth.top + bwidth.bottom + mwidth.top + mwidth.bottom + pwidth.top + pwidth.bottom;
        }
        return 0;
    }

    function lang (phrase) {
        var translation = this.settings.phrases[phrase];
        if (translation == null) return phrase; else return translation;
    }

    function locale (locale) {
        if (!locale) locale = 'en-us';
        if (locale.length === 5) locale = 'locale/'+ locale +'.json';
        // load from the file
        $.ajax({
            url      : locale,
            type     : "GET",
            dataType : "JSON",
            async    : false,
            cache    : false,
            success  : function (data, status, xhr) {
                w2utils.settings = $.extend(true, w2utils.settings, data);
                // apply translation to some prototype functions
                var p = w2obj.grid.prototype;
                for (var b in p.buttons) {
                    p.buttons[b].caption = w2utils.lang(p.buttons[b].caption);
                    p.buttons[b].hint    = w2utils.lang(p.buttons[b].hint);
                }
                p.msgDelete  = w2utils.lang(p.msgDelete);
                p.msgNotJSON = w2utils.lang(p.msgNotJSON);
                p.msgRefresh = w2utils.lang(p.msgRefresh);
            },
            error    : function (xhr, status, msg) {
                console.log('ERROR: Cannot load locale '+ locale);
            }
        });
    }

    function scrollBarSize () {
        if (tmp.scrollBarSize) return tmp.scrollBarSize;
        var html =
            '<div id="_scrollbar_width" style="position: absolute; top: -300px; width: 100px; height: 100px; overflow-y: scroll;">'+
            '    <div style="height: 120px">1</div>'+
            '</div>';
        $('body').append(html);
        tmp.scrollBarSize = 100 - $('#_scrollbar_width > div').width();
        $('#_scrollbar_width').remove();
        if (String(navigator.userAgent).indexOf('MSIE') >= 0) tmp.scrollBarSize  = tmp.scrollBarSize / 2; // need this for IE9+
        return tmp.scrollBarSize;
    }


    function checkName (params, component) { // was w2checkNameParam
        if (!params || typeof params.name === 'undefined') {
            console.log('ERROR: The parameter "name" is required but not supplied in $().'+ component +'().');
            return false;
        }
        if (typeof w2ui[params.name] !== 'undefined') {
            console.log('ERROR: The parameter "name" is not unique. There are other objects already created with the same name (obj: '+ params.name +').');
            return false;
        }
        if (!w2utils.isAlphaNumeric(params.name)) {
            console.log('ERROR: The parameter "name" has to be alpha-numeric (a-z, 0-9, dash and underscore). ');
            return false;
        }
        return true;
    }

    function checkUniqueId (id, items, itemsDecription, objName) { // was w2checkUniqueId
        if (!$.isArray(items)) items = [items];
        for (var i = 0; i < items.length; i++) {
            if (items[i].id === id) {
                console.log('ERROR: The parameter "id='+ id +'" is not unique within the current '+ itemsDecription +'. (obj: '+ objName +')');
                return false;
            }
        }
        return true;
    }

    function parseRoute(route) {
        var keys = [];
        var path = route
            .replace(/\/\(/g, '(?:/')
            .replace(/\+/g, '__plus__')
            .replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g, function(_, slash, format, key, capture, optional) {
                keys.push({ name: key, optional: !! optional });
                slash = slash || '';
                return '' + (optional ? '' : slash) + '(?:' + (optional ? slash : '') + (format || '') + (capture || (format && '([^/.]+?)' || '([^/]+?)')) + ')' + (optional || '');
            })
            .replace(/([\/.])/g, '\\$1')
            .replace(/__plus__/g, '(.+)')
            .replace(/\*/g, '(.*)');
        return {
            path  : new RegExp('^' + path + '$', 'i'),
            keys  : keys
        };
    }
})();

/***********************************************************
*  Generic Event Object
*  --- This object is reused across all other
*  --- widgets in w2ui.
*
*********************************************************/

w2utils.event = {

    on: function (eventData, handler) {
        if (!$.isPlainObject(eventData)) eventData = { type: eventData };
        eventData = $.extend({ type: null, execute: 'before', target: null, onComplete: null }, eventData);

        if (!eventData.type) { console.log('ERROR: You must specify event type when calling .on() method of '+ this.name); return; }
        if (!handler) { console.log('ERROR: You must specify event handler function when calling .on() method of '+ this.name); return; }
        if (!$.isArray(this.handlers)) this.handlers = [];
        this.handlers.push({ event: eventData, handler: handler });
    },

    off: function (eventData, handler) {
        if (!$.isPlainObject(eventData)) eventData = { type: eventData };
        eventData = $.extend({}, { type: null, execute: 'before', target: null, onComplete: null }, eventData);

        if (!eventData.type) { console.log('ERROR: You must specify event type when calling .off() method of '+ this.name); return; }
        if (!handler) { handler = null; }
        // remove handlers
        var newHandlers = [];
        for (var h = 0, len = this.handlers.length; h < len; h++) {
            var t = this.handlers[h];
            if ((t.event.type === eventData.type || eventData.type === '*') &&
                (t.event.target === eventData.target || eventData.target === null) &&
                (t.handler === handler || handler === null))
            {
                // match
            } else {
                newHandlers.push(t);
            }
        }
        this.handlers = newHandlers;
    },

    trigger: function (eventData) {
        var eventData = $.extend({ type: null, phase: 'before', target: null }, eventData, {
            isStopped: false, isCancelled: false,
            preventDefault  : function () { this.isCancelled = true; },
            stopPropagation : function () { this.isStopped   = true; }
        });
        if (eventData.phase === 'before') eventData.onComplete = null;
        var args, fun, tmp;
        if (eventData.target == null) eventData.target = null;
        if (!$.isArray(this.handlers)) this.handlers = [];
        // process events in REVERSE order
        for (var h = this.handlers.length-1; h >= 0; h--) {
            var item = this.handlers[h];
            if ((item.event.type === eventData.type || item.event.type === '*') &&
                (item.event.target === eventData.target || item.event.target === null) &&
                (item.event.execute === eventData.phase || item.event.execute === '*' || item.event.phase === '*'))
            {
                eventData = $.extend({}, item.event, eventData);
                // check handler arguments
                args = [];
                tmp  = RegExp(/\((.*?)\)/).exec(item.handler);
                if (tmp) args = tmp[1].split(/\s*,\s*/);
                if (args.length === 2) {
                    item.handler.call(this, eventData.target, eventData); // old way for back compatibility
                } else {
                    item.handler.call(this, eventData); // new way
                }
                if (eventData.isStopped === true || eventData.stop === true) return eventData; // back compatibility eventData.stop === true
            }
        }
        // main object events
        var funName = 'on' + eventData.type.substr(0,1).toUpperCase() + eventData.type.substr(1);
        if (eventData.phase === 'before' && typeof this[funName] === 'function') {
            fun = this[funName];
            // check handler arguments
            args = [];
            tmp  = RegExp(/\((.*?)\)/).exec(fun);
            if (tmp) args = tmp[1].split(/\s*,\s*/);
            if (args.length === 2) {
                fun.call(this, eventData.target, eventData); // old way for back compatibility
            } else {
                fun.call(this, eventData); // new way
            }
            if (eventData.isStopped === true || eventData.stop === true) return eventData; // back compatibility eventData.stop === true
        }
        // item object events
        if (eventData.object != null && eventData.phase === 'before' &&
            typeof eventData.object[funName] === 'function')
        {
            fun = eventData.object[funName];
            // check handler arguments
            args = [];
            tmp  = RegExp(/\((.*?)\)/).exec(fun);
            if (tmp) args = tmp[1].split(/\s*,\s*/);
            if (args.length === 2) {
                fun.call(this, eventData.target, eventData); // old way for back compatibility
            } else {
                fun.call(this, eventData); // new way
            }
            if (eventData.isStopped === true || eventData.stop === true) return eventData;
        }
        // execute onComplete
        if (eventData.phase === 'after' && typeof eventData.onComplete === 'function') eventData.onComplete.call(this, eventData);

        return eventData;
    }
};

/***********************************************************
*  Common Keyboard Handler. Supported in
*  - grid
*  - sidebar
*  - popup
*
*********************************************************/

w2utils.keyboard = (function (obj) {
    // private scope
    var w2ui_name = null;

    obj.active    = active;
    obj.clear     = clear;

    init();
    return obj;

    function init() {
        $(document).on('keydown', keydown);
        $(document).on('mousedown', mousedown);
    }

    function keydown (event) {
        var tag = event.target.tagName;
        if ($.inArray(tag, ['INPUT', 'SELECT', 'TEXTAREA']) !== -1) return;
        if ($(event.target).prop('contenteditable') === 'true') return;
        if (!w2ui_name) return;
        // pass to appropriate widget
        if (w2ui[w2ui_name] && typeof w2ui[w2ui_name].keydown === 'function') {
            w2ui[w2ui_name].keydown.call(w2ui[w2ui_name], event);
        }
    }

    function mousedown (event) {
        var tag = event.target.tagName;
        var obj = $(event.target).parents('.w2ui-reset');
        if (obj.length > 0) {
            var name = obj.attr('name');
            if (w2ui[name] && w2ui[name].keyboard) w2ui_name = name;
        }
    }

    function active (new_w2ui_name) {
        if (typeof new_w2ui_name !== 'undefined') w2ui_name = new_w2ui_name;
        return w2ui_name;
    }

    function clear () {
        w2ui_name = null;
    }

})({});

/***********************************************************
*  Commonly used plugins
*  --- used primarily in grid and form
*
*********************************************************/

(function () {

    $.fn.w2render = function (name) {
        if ($(this).length > 0) {
            if (typeof name === 'string' && w2ui[name]) w2ui[name].render($(this)[0]);
            if (typeof name === 'object') name.render($(this)[0]);
        }
    };

    $.fn.w2destroy = function (name) {
        if (!name && this.length > 0) name = this.attr('name');
        if (typeof name === 'string' && w2ui[name]) w2ui[name].destroy();
        if (typeof name === 'object') name.destroy();
    };

    $.fn.w2marker = function (str) {
        if (str === '' || str == null) { // remove marker
            return $(this).each(function (index, el) {
                el.innerHTML = el.innerHTML.replace(/\<span class=\"w2ui\-marker\"\>(.*)\<\/span\>/ig, '$1'); // unmark
            });
        } else { // add marker
            return $(this).each(function (index, el) {
                if (typeof str === 'string') str = [str];
                el.innerHTML = el.innerHTML.replace(/\<span class=\"w2ui\-marker\"\>(.*)\<\/span\>/ig, '$1'); // unmark
                for (var s in str) {
                    var tmp = str[s];
                    if (typeof tmp !== 'string') tmp = String(tmp);
                    // escape regex special chars
                    tmp = tmp.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, "\\$&").replace(/&/g, '&amp;').replace(/</g, '&gt;').replace(/>/g, '&lt;');
                    var regex = new RegExp(tmp + '(?!([^<]+)?>)', "gi"); // only outside tags
                    el.innerHTML = el.innerHTML.replace(regex, replaceValue);
                }
                function replaceValue(matched) { // mark new
                    return '<span class="w2ui-marker">' + matched + '</span>';
                }
            });
        }
    };

    // -- w2tag - appears on the right side from element, there can be multiple on screen at a time

    $.fn.w2tag = function (text, options) {
        if (!$.isPlainObject(options)) options = {};
        if (!$.isPlainObject(options.css)) options.css = {};
        if (typeof options['class'] === 'undefined') options['class'] = '';
        // remove all tags
        if ($(this).length === 0) {
            $('.w2ui-tag').each(function (index, elem) {
                var opt = $(elem).data('options');
                if (opt == null) opt = {};
                $($(elem).data('taged-el')).removeClass( opt['class'] );
                clearInterval($(elem).data('timer'));
                $(elem).remove();
            });
            return;
        }
        return $(this).each(function (index, el) {
            // show or hide tag
            var tagOrigID = el.id;
            var tagID = w2utils.escapeId(el.id);
            if (text === '' || text == null) {
                $('#w2ui-tag-'+tagID).css('opacity', 0);
                setTimeout(function () {
                    // remmove element
                    clearInterval($('#w2ui-tag-'+tagID).data('timer'));
                    $('#w2ui-tag-'+tagID).remove();
                }, 300);
            } else {
                // remove elements
                clearInterval($('#w2ui-tag-'+tagID).data('timer'));
                $('#w2ui-tag-'+tagID).remove();
                // insert
                $('body').append(
                    '<div id="w2ui-tag-'+ tagOrigID +'" class="w2ui-tag '+ ($(el).parents('.w2ui-popup').length > 0 ? 'w2ui-tag-popup' : '') +
                    '" style=""></div>');

                var timer = setInterval(function () {
                    // monitor if destroyed
                    if ($(el).length === 0 || ($(el).offset().left === 0 && $(el).offset().top === 0)) {
                        clearInterval($('#w2ui-tag-'+tagID).data('timer'));
                        tmp_hide();
                        return;
                    }
                    // monitor if moved
                    if ($('#w2ui-tag-'+tagID).data('position') !== ($(el).offset().left + el.offsetWidth) + 'x' + $(el).offset().top) {
                        $('#w2ui-tag-'+tagID).css({
                            '-webkit-transition' : '.2s',
                            '-moz-transition'    : '.2s',
                            '-ms-transition'     : '.2s',
                            '-o-transition'      : '.2s',
                            left: ($(el).offset().left + el.offsetWidth) + 'px',
                            top: $(el).offset().top + 'px'
                        }).data('position', ($(el).offset().left + el.offsetWidth) + 'x' + $(el).offset().top);
                    }
                }, 100);
                setTimeout(function () {
                    if (!$(el).offset()) return;
                    $('#w2ui-tag-'+tagID).css({
                        opacity: '1',
                        left: ($(el).offset().left + el.offsetWidth) + 'px',
                        top: $(el).offset().top + 'px'
                    }).html('<div style="margin-top: -2px 0px 0px -2px; white-space: nowrap;"> <div class="w2ui-tag-body">'+ text +'</div> </div>')
                    .data('text', text)
                    .data('taged-el', el)
                    .data('options', options)
                    .data('position', ($(el).offset().left + el.offsetWidth) + 'x' + $(el).offset().top)
                    .data('timer', timer);
                    $(el).off('keypress', tmp_hide).on('keypress', tmp_hide).off('change', tmp_hide).on('change', tmp_hide)
                        .css(options.css).addClass(options['class']);
                    if (typeof options.onShow === 'function') options.onShow();
                }, 1);
                var originalCSS = '';
                if ($(el).length > 0) originalCSS = $(el)[0].style.cssText;
                // bind event to hide it
                function tmp_hide() {
                    $tag = $('#w2ui-tag-'+tagID);
                    if ($tag.length <= 0) return;
                    clearInterval($tag.data('timer'));
                    $tag.remove();
                    $(el).off('keypress', tmp_hide).removeClass(options['class']);
                    if ($(el).length > 0) $(el)[0].style.cssText = originalCSS;
                    if (typeof options.onHide === 'function') options.onHide();
                }
            }
        });
    };

    // w2overlay - appears under the element, there can be only one at a time

    $.fn.w2overlay = function (html, options) {
        var obj  = this;
        var name = '';
        var defaults = {
            name      : null,      // it not null, then allows multiple concurent overlays
            html      : '',        // html text to display
            align     : 'none',    // can be none, left, right, both
            left      : 0,         // offset left
            top       : 0,         // offset top
            tipLeft   : 30,        // tip offset left
            width     : 0,         // fixed width
            height    : 0,         // fixed height
            maxWidth  : null,      // max width if any
            maxHeight : null,      // max height if any
            style     : '',        // additional style for main div
            'class'   : '',        // additional class name for main div
            onShow    : null,      // event on show
            onHide    : null,      // event on hide
            openAbove : false,     // show abover control
            tmp       : {}
        };
        if (arguments.length == 1) {
            if (typeof html == 'object') {
                options = html; 
            } else {
                options = { html: html };
            }
        }
        if (arguments.length == 2) options.html = html;
        if (!$.isPlainObject(options)) options = {};
        options = $.extend({}, defaults, options);
        if (options.name) name = '-' + options.name;
        // if empty then hide
        var tmp_hide;
        if (this.length === 0 || options.html === '' || options.html == null) {
            if ($('#w2ui-overlay'+ name).length > 0) {
                tmp_hide = $('#w2ui-overlay'+ name)[0].hide;
                if (typeof tmp_hide === 'function') tmp_hide();
            } else {
            $('#w2ui-overlay'+ name).remove();
            }
            return $(this);
        }
        if ($('#w2ui-overlay'+ name).length > 0) {
            tmp_hide = $('#w2ui-overlay'+ name)[0].hide;
            $(document).off('click', tmp_hide);
            if (typeof tmp_hide === 'function') tmp_hide();
        }
        $('body').append(
            '<div id="w2ui-overlay'+ name +'" style="display: none"'+
            '        class="w2ui-reset w2ui-overlay '+ ($(this).parents('.w2ui-popup, .w2ui-overlay-popup').length > 0 ? 'w2ui-overlay-popup' : '') +'">'+
            '    <style></style>'+
            '    <div style="'+ options.style +'" class="'+ options['class'] +'"></div>'+
            '</div>'
        );
        // init
        var div1 = $('#w2ui-overlay'+ name);
        var div2 = div1.find(' > div');
        div2.html(options.html);
        // pick bg color of first div
        var bc  = div2.css('background-color');
        if (bc != null && bc !== 'rgba(0, 0, 0, 0)' && bc !== 'transparent') div1.css('background-color', bc);

        div1.data('element', obj.length > 0 ? obj[0] : null)
            .data('options', options)
            .data('position', $(obj).offset().left + 'x' + $(obj).offset().top)
            .fadeIn('fast').on('mousedown', function (event) {
                $('#w2ui-overlay'+ name).data('keepOpen', true);
                if (['INPUT', 'TEXTAREA', 'SELECT'].indexOf(event.target.tagName) === -1) event.preventDefault();
            });
        div1[0].hide    = hide;
        div1[0].resize    = resize;

        // need time to display
        resize();
        setTimeout(function () {
            resize();
            $(document).off('click', hide).on('click', hide);
            if (typeof options.onShow === 'function') options.onShow();
        }, 10);

        monitor();
        return $(this);

        // monitor position
        function monitor() {
            var tmp = $('#w2ui-overlay'+ name);
            if (tmp.data('element') !== obj[0]) return; // it if it different overlay
            if (tmp.length === 0) return;
            var pos = $(obj).offset().left + 'x' + $(obj).offset().top;
            if (tmp.data('position') !== pos) {
                hide();
            } else {
                setTimeout(monitor, 250);
            }
        }

        // click anywhere else hides the drop down
        function hide () {
            var div1 = $('#w2ui-overlay'+ name);
            if (div1.data('keepOpen') === true) {
                div1.removeData('keepOpen');
                return;
            }
            var result;
            if (typeof options.onHide === 'function') result = options.onHide();
            if (result === false) return;
            div1.remove();
            $(document).off('click', hide);
            clearInterval(div1.data('timer'));
        }

        function resize () {
            var div1 = $('#w2ui-overlay'+ name);
            var div2 = div1.find(' > div');
            // if goes over the screen, limit height and width
            if (div1.length > 0) {
                div2.height('auto').width('auto');
                // width/height
                var overflowX = false;
                var overflowY = false;
                var h = div2.height();
                var w = div2.width();
                if (options.width && options.width < w) w = options.width;
                if (w < 30) w = 30;
                // if content of specific height
                if (options.tmp.contentHeight) {
                    h = options.tmp.contentHeight;
                    div2.height(h);
                    setTimeout(function () {
                        if (div2.height() > div2.find('div.menu > table').height()) {
                            div2.find('div.menu').css('overflow-y', 'hidden');
                        }
                    }, 1);
                    setTimeout(function () { div2.find('div.menu').css('overflow-y', 'auto'); }, 10);
                }
                if (options.tmp.contentWidth) {
                    w = options.tmp.contentWidth;
                    div2.width(w);
                    setTimeout(function () {
                        if (div2.width() > div2.find('div.menu > table').width()) {
                            div2.find('div.menu').css('overflow-x', 'hidden');
                        }
                    }, 1);
                    setTimeout(function () { div2.find('div.menu').css('overflow-y', 'auto'); }, 10);
                }
                // alignment
                switch (options.align) {
                    case 'both':
                        options.left = 17;
                        if (options.width === 0) options.width = w2utils.getSize($(obj), 'width');
                        break;
                    case 'left':
                        options.left = 17;
                        break;
                    case 'right':
                        options.tipLeft = w - 45;
                        options.left = w2utils.getSize($(obj), 'width') - w + 10;
                        break;
                }
                // adjust position
                var tmp = (w - 17) / 2;
                var boxLeft  = options.left;
                var boxWidth = options.width;
                var tipLeft  = options.tipLeft;
                if (w === 30 && !boxWidth) boxWidth = 30; else boxWidth = (options.width ? options.width : 'auto');
                if (tmp < 25) {
                    boxLeft = 25 - tmp;
                    tipLeft = Math.floor(tmp);
                }
                // Y coord
                div1.css({
                    top         : (obj.offset().top + w2utils.getSize(obj, 'height') + options.top + 7) + 'px',
                    left        : ((obj.offset().left > 25 ? obj.offset().left : 25) + boxLeft) + 'px',
                    'min-width' : boxWidth,
                    'min-height': (options.height ? options.height : 'auto')
                });
                // $(window).height() - has a problem in FF20
                var maxHeight = window.innerHeight + $(document).scrollTop() - div2.offset().top - 7;
                var maxWidth  = window.innerWidth + $(document).scrollLeft() - div2.offset().left - 7;
                if ((maxHeight > -50 && maxHeight < 210) || options.openAbove === true) {
                    // show on top
                    maxHeight = div2.offset().top - $(document).scrollTop() - 7;
                    if (options.maxHeight && maxHeight > options.maxHeight) maxHeight = options.maxHeight;
                    if (h > maxHeight) {
                        overflowY = true;
                        div2.height(maxHeight).width(w).css({ 'overflow-y': 'auto' });
                        h = maxHeight;
                    }
                    div1.css('top', ($(obj).offset().top - h - 24 + options.top) + 'px');
                    div1.find('>style').html(
                        '#w2ui-overlay'+ name +':before { display: none; margin-left: '+ parseInt(tipLeft) +'px; }'+
                        '#w2ui-overlay'+ name +':after { display: block; margin-left: '+ parseInt(tipLeft) +'px; }'
                    );
                } else {
                    // show under
                    if (options.maxHeight && maxHeight > options.maxHeight) maxHeight = options.maxHeight;
                    if (h > maxHeight) {
                        overflowY = true;
                        div2.height(maxHeight).width(w).css({ 'overflow-y': 'auto' });
                    }
                    div1.find('>style').html(
                        '#w2ui-overlay'+ name +':before { display: block; margin-left: '+ parseInt(tipLeft) +'px; }'+
                        '#w2ui-overlay'+ name +':after { display: none; margin-left: '+ parseInt(tipLeft) +'px; }'
                    );
                }
                // check width
                w = div2.width();
                maxWidth = window.innerWidth + $(document).scrollLeft() - div2.offset().left - 7;
                if (options.maxWidth && maxWidth > options.maxWidth) maxWidth = options.maxWidth;
                if (w > maxWidth && options.align !== 'both') {
                    options.align = 'right';
                    setTimeout(function () { resize(); }, 1);
                }
                // check scroll bar
                if (overflowY && overflowX) div2.width(w + w2utils.scrollBarSize() + 2);
            }
        }
    };

    $.fn.w2menu = function (menu, options) {
        /*
        ITEM STRUCTURE
            item : {
                id       : null,
                text     : '',
                style    : '',
                img      : '',
                icon     : '',
                count    : '',
                hidden   : false,
                disabled : false
                ...
            }
        */
        var defaults = {
            index      : null,        // current selected
            items      : [],
            render     : null,
            msgNoItems : 'No items',
            onSelect   : null,
            tmp        : {}
        };
        var obj  = this;
        var name = '';
        if (menu === 'refresh') {
            // if not show - call blur
            if ($('#w2ui-overlay'+ name).length > 0) {
                options = $.extend($.fn.w2menuOptions, options);
                var scrTop = $('#w2ui-overlay'+ name +' div.menu').scrollTop();
                $('#w2ui-overlay'+ name +' div.menu').html(getMenuHTML());
                $('#w2ui-overlay'+ name +' div.menu').scrollTop(scrTop);
                mresize();
            } else {
                $(this).w2menu(options);
            }
        } else {
            if (arguments.length === 1) options = menu; else options.items = menu;
            if (typeof options !== 'object') options = {};
            options = $.extend({}, defaults, options);
            $.fn.w2menuOptions = options;
            if (options.name) name = '-' + options.name;
            if (typeof options.select === 'function' && typeof options.onSelect !== 'function') options.onSelect = options.select;
            if (typeof options.onRender === 'function' && typeof options.render !== 'function') options.render = options.onRender;
            // since only one overlay can exist at a time
            $.fn.w2menuHandler = function (event, index) {
                if (typeof options.onSelect === 'function') {
                    // need time so that menu first hides
                    setTimeout(function () {
                        options.onSelect({
                            index : index,
                            item  : options.items[index],
                            originalEvent: event
                        });
                    }, 10);
                }
                // do not uncomment (enum in grid search will not work)
                // setTimeout(function () { $(document).click(); }, 50);
            };
            var html = '';
            if (options.search) {
                html +=
                    '<div style="position: absolute; top: 0px; height: 40px; left: 0px; right: 0px; border-bottom: 1px solid silver; background-color: #ECECEC; padding: 8px 5px;">'+
                    '    <div class="w2ui-icon icon-search" style="position: absolute; margin-top: 4px; margin-left: 6px; width: 11px; background-position: left !important;"></div>'+
                    '    <input id="menu-search" type="text" style="width: 100%; outline: none; padding-left: 20px;" onclick="event.stopPropagation();">'+
                    '</div>';
                options.style += ';background-color: #ECECEC';
                options.index = 0;
                for (var i in options.items) options.items[i].hidden = false;
            }
            html += '<div class="menu" style="position: absolute; top: '+ (options.search ? 40 : 0) + 'px; bottom: 0px; width: 100%; overflow: auto;">' +
                        getMenuHTML() +
                    '</div>';
            var ret = $(this).w2overlay(html, options);
            setTimeout(function () {
                $('#w2ui-overlay'+ name +' #menu-search')
                    .on('keyup', change)
                    .on('keydown', function (event) {
                        // cancel tab key
                        if (event.keyCode === 9) { event.stopPropagation(); event.preventDefault(); }
                    });
                if (options.search) {
                    if (['text', 'password'].indexOf($(obj)[0].type) != -1 || $(obj)[0].tagName == 'texarea') return;
                    $('#w2ui-overlay'+ name +' #menu-search').focus();                    
                }
            }, 200);
            mresize();
            return ret;
        }

        function mresize() {
            setTimeout(function () {
                // show selected
                $('#w2ui-overlay'+ name +' tr.w2ui-selected').removeClass('w2ui-selected');
                var cur        = $('#w2ui-overlay'+ name +' tr[index='+ options.index +']');
                var scrTop    = $('#w2ui-overlay'+ name +' div.menu').scrollTop();
                cur.addClass('w2ui-selected');
                if (options.tmp) options.tmp.contentHeight = $('#w2ui-overlay'+ name +' table').height() + (options.search ? 50 : 10);
                if (options.tmp) options.tmp.contentWidth  = $('#w2ui-overlay'+ name +' table').width();
                if ($('#w2ui-overlay'+ name).length > 0) $('#w2ui-overlay'+ name)[0].resize();
                // scroll into view
                if (cur.length > 0) {
                    var top    = cur[0].offsetTop - 5; // 5 is margin top
                    var el     = $('#w2ui-overlay'+ name +' div.menu');
                    var height = el.height();
                    $('#w2ui-overlay'+ name +' div.menu').scrollTop(scrTop);
                    if (top < scrTop || top + cur.height() > scrTop + height) {
                        $('#w2ui-overlay'+ name +' div.menu').animate({ 'scrollTop': top - (height - cur.height() * 2) / 2 }, 200, 'linear');
                    }
                }
            }, 1);
        }

        function change(event) {
            var search  = this.value;
            var key     = event.keyCode;
            var cancel  = false;
            switch (key) {
                case 13: // enter
                    $('#w2ui-overlay'+ name).remove();
                    $.fn.w2menuHandler(event, options.index);
                    break;
                case 9:  // tab
                case 27: // escape
                    $('#w2ui-overlay'+ name).remove();
                    $.fn.w2menuHandler(event, -1);
                    break;
                case 38: // up
                    options.index = w2utils.isInt(options.index) ? parseInt(options.index) : 0;
                    options.index--;
                    while (options.index > 0 && options.items[options.index].hidden) options.index--;
                    if (options.index === 0 && options.items[options.index].hidden) {
                        while (options.items[options.index] && options.items[options.index].hidden) options.index++;
                    }
                    if (options.index < 0) options.index = 0;
                    cancel = true;
                    break;
                case 40: // down
                    options.index = w2utils.isInt(options.index) ? parseInt(options.index) : 0;
                    options.index++;
                    while (options.index < options.items.length-1 && options.items[options.index].hidden) options.index++;
                    if (options.index === options.items.length-1 && options.items[options.index].hidden) {
                        while (options.items[options.index] && options.items[options.index].hidden) options.index--;
                    }
                    if (options.index >= options.items.length) options.index = options.items.length - 1;
                    cancel = true;
                    break;
            }
            // filter
            if (!cancel) {
                var shown  = 0;
                for (var i in options.items) {
                    var item = options.items[i];
                    var prefix = '';
                    var suffix = '';
                    if (['is', 'begins with'].indexOf(options.match) !== -1) prefix = '^';
                    if (['is', 'ends with'].indexOf(options.match) !== -1) suffix = '$';
                    try {
                        var re = new RegExp(prefix + search + suffix, 'i');
                        if (re.test(item.text) || item.text === '...') item.hidden = false; else item.hidden = true;
                    } catch (e) {}
                    // do not show selected items
                    if (obj.type === 'enum' && $.inArray(item.id, ids) !== -1) item.hidden = true;
                    if (item.hidden !== true) shown++;
                }
                options.index = 0;
                while (options.index < options.items.length-1 && options.items[options.index].hidden) options.index++;
                if (shown <= 0) options.index = -1;
            }
            $(obj).w2menu('refresh', options);
            mresize();
        }

        function getMenuHTML () {
            if (options.spinner) {
                return  '<table class="w2ui-drop-menu"><tr><td style="padding: 5px 10px 10px 10px; text-align: center">'+
                        '    <div class="w2ui-spinner" style="width: 18px; height: 18px; position: relative; top: 5px;"></div> '+
                        '    <div style="display: inline-block; padding: 3px; color: #999;">'+ w2utils.lang('Loading...') +'</div>'+
                        '</td></tr></table>';
            }
            var count        = 0;
            var menu_html    = '<table cellspacing="0" cellpadding="0" class="w2ui-drop-menu">';
            var img = null, icon = null;
            for (var f = 0; f < options.items.length; f++) {
                var mitem = options.items[f];
                if (typeof mitem === 'string') {
                    mitem = { id: mitem, text: mitem };
                } else {
                    if (mitem.text != null && mitem.id == null) mitem.id = mitem.text;
                    if (mitem.text == null && mitem.id != null) mitem.text = mitem.id;
                    if (mitem.caption != null) mitem.text = mitem.caption;
                    img  = mitem.img;
                    icon = mitem.icon;
                    if (img  == null) img  = null;
                    if (icon == null) icon = null;
                }
                if (mitem.hidden !== true) {
                    var imgd = '';
                    var txt = mitem.text;
                    if (typeof options.render === 'function') txt = options.render(mitem, options);
                    if (img)  imgd = '<td class="menu-icon"><div class="w2ui-tb-image w2ui-icon '+ img +'"></div></td>';
                    if (icon) imgd = '<td class="menu-icon" align="center"><span class="w2ui-icon '+ icon +'"></span></td>';
                    // render only if non-empty
                    if (typeof txt !== 'undefined' && txt !== '' && !(/^-+$/.test(txt))) {
                        var bg = (count % 2 === 0 ? 'w2ui-item-even' : 'w2ui-item-odd');
                        if (options.altRows !== true) bg = '';
                        var colspan = 1;
                        if (imgd == '') colspan++;
                        if (mitem.count == null) colspan++;
                        menu_html +=
                            '<tr index="'+ f + '" style="'+ (mitem.style ? mitem.style : '') +'" '+
                            '        class="'+ bg +' '+ (options.index === f ? 'w2ui-selected' : '') + ' ' + (mitem.disabled === true ? 'w2ui-disabled' : '') +'"'+
                            '        onmousedown="$(this).parent().find(\'tr\').removeClass(\'w2ui-selected\'); $(this).addClass(\'w2ui-selected\');"'+
                            '        onclick="event.stopPropagation(); '+
                            '               if ('+ (mitem.disabled === true ? 'true' : 'false') + ') return;'+
                            '               $(\'#w2ui-overlay'+ name +'\').remove(); '+
                            '               $.fn.w2menuHandler(event, \''+ f +'\');">'+
                                imgd +
                            '   <td class="menu-text" colspan="'+ colspan +'">'+ txt +'</td>'+
                            '   <td class="menu-count">'+ (mitem.count != null ? '<span>' + mitem.count + '</span>' : '') + '</td>' +
                            '</tr>';
                        count++;
                    } else {
                        // horizontal line
                        menu_html += '<tr><td colspan="2" style="padding: 6px; pointer-events: none"><div style="border-top: 1px solid silver;"></div></td></tr>';
                    }
                }
                options.items[f] = mitem;
            }
            if (count === 0) {
                menu_html += '<tr><td style="padding: 13px; color: #999; text-align: center">'+ options.msgNoItems +'</div></td></tr>';
            }
            menu_html += "</table>";
            return menu_html;
        }
    };
})();


/************************************************************************
*   Library: Web 2.0 UI for jQuery (using prototypical inheritance)
*   - Following objects defined
*        - w2grid        - grid widget
*        - $().w2grid    - jQuery wrapper
*   - Dependencies: jQuery, w2utils, w2toolbar, w2fields, w2alert, w2confirm
*
* == NICE TO HAVE == 
*   - frozen columns
*   - add colspans
*   - allow this.total to be unknown (-1)
*   - column autosize based on largest content
*   - easy bubbles in the grid
*   - More than 2 layers of header groups
*   - reorder columns/records
*   - hidden searches could not be clearned by the user
*   - problem with .set() and arrays, array get extended too, but should be replaced
*   - move events into prototype
*   - add grid.focus()
*   - add showExtra, KickIn Infinite scroll when so many records
*   - after edit stay on the same record option
*   - allow render: function to be filters
*
************************************************************************/

(function () {
    var w2grid = function(options) {

        // public properties
        this.name         = null;
        this.box          = null;     // HTML element that hold this element
        this.header       = '';
        this.url          = '';
        this.routeData    = {};       // data for dynamic routes
        this.columns      = [];       // { field, caption, size, attr, render, hidden, gridMinWidth, editable }
        this.columnGroups = [];       // { span: int, caption: 'string', master: true/false }
        this.records      = [];       // { recid: int(requied), field1: 'value1', ... fieldN: 'valueN', style: 'string', editable: true/false, summary: true/false, changes: object }
        this.summary      = [];       // arry of summary records, same structure as records array
        this.searches     = [];       // { type, caption, field, inTag, outTag, hidden }
        this.searchData   = [];
        this.sortData     = [];
        this.postData     = {};
        this.toolbar      = {};       // if not empty object; then it is toolbar object

        this.show = {
            header          : false,
            toolbar         : false,
            footer          : false,
            columnHeaders   : true,
            lineNumbers     : false,
            expandColumn    : false,
            selectColumn    : false,
            emptyRecords    : true,
            toolbarReload   : true,
            toolbarColumns  : true,
            toolbarSearch   : true,
            toolbarAdd      : false,
            toolbarEdit     : false,
            toolbarDelete   : false,
            toolbarSave     : false,
            selectionBorder : true,
            recordTitles    : true,
            skipRecords     : true
        };

        this.autoLoad       = true;     // for infinite scroll
        this.fixedBody      = true;     // if false; then grid grows with data
        this.recordHeight   = 24;
        this.keyboard       = true;
        this.selectType     = 'row';    // can be row|cell
        this.multiSearch    = true;
        this.multiSelect    = true;
        this.multiSort      = true;
        this.reorderColumns = false;
        this.reorderRows    = false;
        this.markSearch     = true;

        this.total   = 0;     // server total
        this.limit   = 100;
        this.offset  = 0;     // how many records to skip (for infinite scroll) when pulling from server
        this.style   = '';
        this.ranges  = [];
        this.menu    = [];
        this.method  = null;         // if defined, then overwrited ajax method
        this.recid   = null;
        this.parser  = null;

        // events
        this.onAdd              = null;
        this.onEdit             = null;
        this.onRequest          = null;        // called on any server event
        this.onLoad             = null;
        this.onDelete           = null;
        this.onDeleted          = null;
        this.onSubmit           = null;
        this.onSave             = null;
        this.onSelect           = null;
        this.onUnselect         = null;
        this.onClick            = null;
        this.onDblClick         = null;
        this.onContextMenu      = null;
        this.onMenuClick        = null;        // when context menu item selected
        this.onColumnClick      = null;
        this.onColumnResize     = null;
        this.onSort             = null;
        this.onSearch           = null;
        this.onChange           = null;        // called when editable record is changed
        this.onRestore          = null;        // called when editable record is restored
        this.onExpand           = null;
        this.onCollapse         = null;
        this.onError            = null;
        this.onKeydown          = null;
        this.onToolbar          = null;     // all events from toolbar
        this.onColumnOnOff      = null;
        this.onCopy             = null;
        this.onPaste            = null;
        this.onSelectionExtend  = null;
        this.onEditField        = null;
        this.onRender           = null;
        this.onRefresh          = null;
        this.onReload           = null;
        this.onResize           = null;
        this.onDestroy          = null;
        this.onStateSave        = null;
        this.onStateRestore     = null;

        // internal
        this.last = {
            field     : 'all',
            caption   : w2utils.lang('All Fields'),
            logic     : 'OR',
            search    : '',
            searchIds : [],
            selection : {
                indexes : [],
                columns : {}
            },
            multi       : false,
            scrollTop   : 0,
            scrollLeft  : 0,
            sortData    : null,
            sortCount   : 0,
            xhr         : null,
            range_start : null,
            range_end   : null,
            sel_ind     : null,
            sel_col     : null,
            sel_type    : null,
            edit_col    : null
        };

        $.extend(true, this, w2obj.grid, options);
    };

    // ====================================================
    // -- Registers as a jQuery plugin

    $.fn.w2grid = function(method) {
        if (typeof method === 'object' || !method ) {
            // check name parameter
            if (!w2utils.checkName(method, 'w2grid')) return;
            // remember items
            var columns      = method.columns;
            var columnGroups = method.columnGroups;
            var records      = method.records;
            var searches     = method.searches;
            var searchData   = method.searchData;
            var sortData     = method.sortData;
            var postData     = method.postData;
            var toolbar      = method.toolbar;
            // extend items
            var object = new w2grid(method);
            $.extend(object, { postData: {}, records: [], columns: [], searches: [], toolbar: {}, sortData: [], searchData: [], handlers: [] });
            if (object.onExpand != null) object.show.expandColumn = true;
            $.extend(true, object.toolbar, toolbar);
            // reassign variables
            for (var p in columns)      object.columns[p]       = $.extend(true, {}, columns[p]);
            for (var p in columnGroups) object.columnGroups[p]  = $.extend(true, {}, columnGroups[p]);
            for (var p in searches)     object.searches[p]      = $.extend(true, {}, searches[p]);
            for (var p in searchData)   object.searchData[p]    = $.extend(true, {}, searchData[p]);
            for (var p in sortData)     object.sortData[p]      = $.extend(true, {}, sortData[p]);
            object.postData = $.extend(true, {}, postData);

            // check if there are records without recid
            for (var r in records) {
                if (records[r].recid == null || typeof records[r].recid == 'undefined') {
                    console.log('ERROR: Cannot add records without recid. (obj: '+ object.name +')');
                    return;
                }
                object.records[r] = $.extend(true, {}, records[r]);
            }
            // add searches
            for (var c in object.columns) {
                var col = object.columns[c];
                if (typeof col.searchable == 'undefined' || object.getSearch(col.field) != null) continue;
                var stype = col.searchable;
                var attr  = '';
                if (col.searchable === true) { stype = 'text'; attr = 'size="20"'; }
                object.addSearch({ field: col.field, caption: col.caption, type: stype, attr: attr });
            }
            // init toolbar
            object.initToolbar();
            // render if necessary
            if ($(this).length !== 0) {
                object.render($(this)[0]);
            }
            // register new object
            w2ui[object.name] = object;
            return object;

        } else if (w2ui[$(this).attr('name')]) {
            var obj = w2ui[$(this).attr('name')];
            obj[method].apply(obj, Array.prototype.slice.call(arguments, 1));
            return this;
        } else {
            console.log('ERROR: Method ' +  method + ' does not exist on jQuery.w2grid');
        }
    }

    // ====================================================
    // -- Implementation of core functionality

    w2grid.prototype = {
        // ----
        // properties that need to be in prototype

        msgDelete       : w2utils.lang('Are you sure you want to delete selected records?'),
        msgNotJSON      : w2utils.lang('Returned data is not in valid JSON format.'),
        msgAJAXerror    : w2utils.lang('AJAX error. See console for more details.'),
        msgRefresh      : w2utils.lang('Refreshing...'),

        // for easy button overwrite
        buttons: {
            'reload'   : { type: 'button', id: 'w2ui-reload', icon: 'w2ui-icon-reload', hint: w2utils.lang('Reload data in the list') },
            'columns'  : { type: 'drop', id: 'w2ui-column-on-off', icon: 'w2ui-icon-columns', hint: w2utils.lang('Show/hide columns'), arrow: false, html: '' },
            'search'   : { type: 'html',   id: 'w2ui-search',
                            html: '<div class="w2ui-icon icon-search-down w2ui-search-down" title="'+ 'Select Search Field' +'" '+
                                  'onclick="var obj = w2ui[$(this).parents(\'div.w2ui-grid\').attr(\'name\')]; obj.searchShowFields();"></div>'
                          },
            'search-go': { type: 'check',  id: 'w2ui-search-advanced', caption: w2utils.lang('Search...'), hint: w2utils.lang('Open Search Fields') },
            'add'      : { type: 'button', id: 'w2ui-add', caption: w2utils.lang('Add New'), hint: w2utils.lang('Add new record'), icon: 'w2ui-icon-plus' },
            'edit'     : { type: 'button', id: 'w2ui-edit', caption: w2utils.lang('Edit'), hint: w2utils.lang('Edit selected record'), icon: 'w2ui-icon-pencil', disabled: true },
            'delete'   : { type: 'button', id: 'w2ui-delete', caption: w2utils.lang('Delete'), hint: w2utils.lang('Delete selected records'), icon: 'w2ui-icon-cross', disabled: true },
            'save'     : { type: 'button', id: 'w2ui-save', caption: w2utils.lang('Save'), hint: w2utils.lang('Save changed records'), icon: 'w2ui-icon-check' }
        },

        add: function (record) {
            if (!$.isArray(record)) record = [record];
            var added = 0;
            for (var o in record) {
                if (!this.recid && typeof record[o].recid == 'undefined') record[o].recid = record[o][this.recid];
                if (record[o].recid == null || typeof record[o].recid == 'undefined') {
                    console.log('ERROR: Cannot add record without recid. (obj: '+ this.name +')');
                    continue;
                }
                this.records.push(record[o]);
                added++;
            }
            var url = (typeof this.url != 'object' ? this.url : this.url.get);
            if (!url) {
                this.total = this.records.length;
                this.localSort();
                this.localSearch();
            }
            this.refresh(); // ??  should it be reload?
            return added;
        },

        find: function (obj, returnIndex) {
            if (typeof obj == 'undefined' || obj == null) obj = {};
            var recs    = [];
            var hasDots    = false;
            // check if property is nested - needed for speed
            for (var o in obj) if (String(o).indexOf('.') != -1) hasDots = true;
            // look for an item
            for (var i = 0; i < this.records.length; i++) {
                var match = true;
                for (var o in obj) {
                    var val = this.records[i][o];
                    if (hasDots && String(o).indexOf('.') != -1) val = this.parseField(this.records[i], o);
                    if (obj[o] != val) match = false;
                }
                if (match && returnIndex !== true) recs.push(this.records[i].recid);
                if (match && returnIndex === true) recs.push(i);
            }
            return recs;
        },

        set: function (recid, record, noRefresh) { // does not delete existing, but overrides on top of it
            if (typeof recid == 'object') {
                noRefresh = record;
                record    = recid;
                recid     = null;
            }
            // update all records
            if (recid == null) {
                for (var r in this.records) {
                    $.extend(true, this.records[r], record); // recid is the whole record
                }
                if (noRefresh !== true) this.refresh();
            } else { // find record to update
                var ind = this.get(recid, true);
                if (ind == null) return false;
                var isSummary = (this.records[ind] && this.records[ind].recid == recid ? false : true);
                if (isSummary) {
                    $.extend(true, this.summary[ind], record);
                } else {
                    $.extend(true, this.records[ind], record);
                }
                if (noRefresh !== true) this.refreshRow(recid); // refresh only that record
            }
            return true;
        },

        get: function (recid, returnIndex) {
            // search records
            for (var i = 0; i < this.records.length; i++) {
                if (this.records[i].recid == recid) {
                    if (returnIndex === true) return i; else return this.records[i];
                }
            }
            // search summary
            for (var i = 0; i < this.summary.length; i++) {
                if (this.summary[i].recid == recid) {
                    if (returnIndex === true) return i; else return this.summary[i];
                }
            }
            return null;
        },

        remove: function () {
            var removed = 0;
            for (var a = 0; a < arguments.length; a++) {
                for (var r = this.records.length-1; r >= 0; r--) {
                    if (this.records[r].recid == arguments[a]) { this.records.splice(r, 1); removed++; }
                }
            }
            var url = (typeof this.url != 'object' ? this.url : this.url.get);
            if (!url) {
                this.localSort();
                this.localSearch();
            }
            this.refresh();
            return removed;
        },

        addColumn: function (before, columns) {
            var added = 0;
            if (arguments.length == 1) {
                columns = before;
                before  = this.columns.length;
            } else {
                if (typeof before == 'string') before = this.getColumn(before, true);
                if (before === null) before = this.columns.length;
            }
            if (!$.isArray(columns)) columns = [columns];
            for (var o in columns) {
                this.columns.splice(before, 0, columns[o]);
                before++;
                added++;
            }
            this.refresh();
            return added;
        },

        removeColumn: function () {
            var removed = 0;
            for (var a = 0; a < arguments.length; a++) {
                for (var r = this.columns.length-1; r >= 0; r--) {
                    if (this.columns[r].field == arguments[a]) { this.columns.splice(r, 1); removed++; }
                }
            }
            this.refresh();
            return removed;
        },

        getColumn: function (field, returnIndex) {
            for (var i = 0; i < this.columns.length; i++) {
                if (this.columns[i].field == field) {
                    if (returnIndex === true) return i; else return this.columns[i];
                }
            }
            return null;
        },

        toggleColumn: function () {
            var effected = 0;
            for (var a = 0; a < arguments.length; a++) {
                for (var r = this.columns.length-1; r >= 0; r--) {
                    var col = this.columns[r];
                    if (col.field == arguments[a]) {
                        col.hidden = !col.hidden;
                        effected++;
                    }
                }
            }
            this.refresh();
            return effected;
        },

        showColumn: function () {
            var shown = 0;
            for (var a = 0; a < arguments.length; a++) {
                for (var r = this.columns.length-1; r >= 0; r--) {
                    var col = this.columns[r];
                    if (col.gridMinWidth) delete col.gridMinWidth;
                    if (col.field == arguments[a] && col.hidden !== false) {
                        col.hidden = false;
                        shown++;
                    }
                }
            }
            this.refresh();
            return shown;
        },

        hideColumn: function () {
            var hidden = 0;
            for (var a = 0; a < arguments.length; a++) {
                for (var r = this.columns.length-1; r >= 0; r--) {
                    var col = this.columns[r];
                    if (col.field == arguments[a] && col.hidden !== true) {
                        col.hidden = true;
                        hidden++;
                    }
                }
            }
            this.refresh();
            return hidden;
        },

        addSearch: function (before, search) {
            var added = 0;
            if (arguments.length == 1) {
                search = before;
                before = this.searches.length;
            } else {
                if (typeof before == 'string') before = this.getSearch(before, true);
                if (before === null) before = this.searches.length;
            }
            if (!$.isArray(search)) search = [search];
            for (var o in search) {
                this.searches.splice(before, 0, search[o]);
                before++;
                added++;
            }
            this.searchClose();
            return added;
        },

        removeSearch: function () {
            var removed = 0;
            for (var a = 0; a < arguments.length; a++) {
                for (var r = this.searches.length-1; r >= 0; r--) {
                    if (this.searches[r].field == arguments[a]) { this.searches.splice(r, 1); removed++; }
                }
            }
            this.searchClose();
            return removed;
        },

        getSearch: function (field, returnIndex) {
            for (var i = 0; i < this.searches.length; i++) {
                if (this.searches[i].field == field) {
                    if (returnIndex === true) return i; else return this.searches[i];
                }
            }
            return null;
        },

        toggleSearch: function () {
            var effected = 0;
            for (var a = 0; a < arguments.length; a++) {
                for (var r = this.searches.length-1; r >= 0; r--) {
                    if (this.searches[r].field == arguments[a]) {
                        this.searches[r].hidden = !this.searches[r].hidden;
                        effected++;
                    }
                }
            }
            this.searchClose();
            return effected;
        },

        showSearch: function () {
            var shown = 0;
            for (var a = 0; a < arguments.length; a++) {
                for (var r = this.searches.length-1; r >= 0; r--) {
                    if (this.searches[r].field == arguments[a] && this.searches[r].hidden !== false) {
                        this.searches[r].hidden = false;
                        shown++;
                    }
                }
            }
            this.searchClose();
            return shown;
        },

        hideSearch: function () {
            var hidden = 0;
            for (var a = 0; a < arguments.length; a++) {
                for (var r = this.searches.length-1; r >= 0; r--) {
                    if (this.searches[r].field == arguments[a] && this.searches[r].hidden !== true) {
                        this.searches[r].hidden = true;
                        hidden++;
                    }
                }
            }
            this.searchClose();
            return hidden;
        },

        getSearchData: function (field) {
            for (var s in this.searchData) {
                if (this.searchData[s].field == field) return this.searchData[s];
            }
            return null;
        },

        localSort: function (silent) {
            var url = (typeof this.url != 'object' ? this.url : this.url.get);
            if (url) {
                console.log('ERROR: grid.localSort can only be used on local data source, grid.url should be empty.');
                return;
            }
            if ($.isEmptyObject(this.sortData)) return;
            var time = (new Date()).getTime();
            var obj = this;
            // process date fields
            obj.prepareData();
            // process sortData
            for (var s in this.sortData) {
                var column = this.getColumn(this.sortData[s].field); 
                if (!column) return;
                if (typeof column.render == 'string') {
                    if (['date', 'age'].indexOf(column.render.split(':')[0]) != -1) {
                        this.sortData[s]['field_'] = column.field + '_';
                    }
                    if (['time'].indexOf(column.render.split(':')[0]) != -1) {
                        this.sortData[s]['field_'] = column.field + '_';
                    }
                }
            }
            // process sort
            this.records.sort(function (a, b) {
                var ret = 0;
                for (var s in obj.sortData) {
                    var fld = obj.sortData[s].field;
                    if (obj.sortData[s].field_) fld = obj.sortData[s].field_;
                    var aa = a[fld];
                    var bb = b[fld];
                    if (String(fld).indexOf('.') != -1) {
                        aa = obj.parseField(a, fld);
                        bb = obj.parseField(b, fld);
                    }
                    if (typeof aa == 'string') aa = $.trim(aa.toLowerCase());
                    if (typeof bb == 'string') bb = $.trim(bb.toLowerCase());
                    if (aa > bb) ret = (obj.sortData[s].direction == 'asc' ? 1 : -1);
                    if (aa < bb) ret = (obj.sortData[s].direction == 'asc' ? -1 : 1);
                    if (typeof aa != 'object' && typeof bb == 'object') ret = -1;
                    if (typeof bb != 'object' && typeof aa == 'object') ret = 1;
                    if (aa == null && bb != null) ret = 1;    // all nuls and undefined on bottom
                    if (aa != null && bb == null) ret = -1;
                    if (ret != 0) break;
                }
                return ret;
            });
            time = (new Date()).getTime() - time;
            if (silent !== true) setTimeout(function () { obj.status(w2utils.lang('Sorting took') + ' ' + time/1000 + ' ' + w2utils.lang('sec')); }, 10);
            return time;
        },

        localSearch: function (silent) {
            var url = (typeof this.url != 'object' ? this.url : this.url.get);
            if (url) {
                console.log('ERROR: grid.localSearch can only be used on local data source, grid.url should be empty.');
                return;
            }
            var time = (new Date()).getTime();
            var obj = this;
            this.total = this.records.length;
            // mark all records as shown
            this.last.searchIds = [];
            // prepare date/time fields
            this.prepareData();
            // hide records that did not match
            if (this.searchData.length > 0 && !url) {
                this.total = 0;
                for (var r in this.records) {
                    var rec = this.records[r];
                    var fl  = 0;
                    for (var s in this.searchData) {
                        var sdata      = this.searchData[s];
                        var search     = this.getSearch(sdata.field);
                        if (sdata  == null) continue;
                        if (search == null) search = { field: sdata.field, type: sdata.type };
                        var val1 = String(obj.parseField(rec, search.field)).toLowerCase();
                        if (typeof sdata.value != 'undefined') {
                            if (!$.isArray(sdata.value)) {
                                var val2 = String(sdata.value).toLowerCase();
                            } else {
                                var val2 = sdata.value[0];
                                var val3 = sdata.value[1];
                            }
                        }
                        switch (sdata.operator) {
                            case 'is':
                                 if (rec[search.field] == sdata.value) fl++; // do not hide record
                                if (search.type == 'date') {
                                    var val1 = w2utils.formatDate(rec[search.field + '_'], 'yyyy-mm-dd');
                                    var val2 = w2utils.formatDate(val2, 'yyyy-mm-dd');
                                    if (val1 == val2) fl++;
                                }
                                if (search.type == 'time') {
                                    var val1 = w2utils.formatTime(rec[search.field + '_'], 'h24:mi');
                                    var val2 = w2utils.formatTime(val2, 'h24:mi');
                                    if (val1 == val2) fl++;
                                }
                                break;
                            case 'between':
                                if (['int', 'float', 'money', 'currency', 'percent'].indexOf(search.type) != -1) {
                                    if (parseFloat(rec[search.field]) >= parseFloat(val2) && parseFloat(rec[search.field]) <= parseFloat(val3)) fl++;
                                }
                                if (search.type == 'date') {
                                    var val1 = rec[search.field + '_'];
                                    var val2 = w2utils.isDate(val2, w2utils.settings.date_format, true);
                                    var val3 = w2utils.isDate(val3, w2utils.settings.date_format, true);
                                    if (val3 != null) val3 = new Date(val3.getTime() + 86400000); // 1 day
                                    if (val1 >= val2 && val1 < val3) fl++;
                                }
                                if (search.type == 'time') {
                                    var val1 = rec[search.field + '_'];
                                    var val2 = w2utils.isTime(val2, true);
                                    var val3 = w2utils.isTime(val3, true);
                                    val2 = (new Date()).setHours(val2.hours, val2.minutes, val2.seconds ? val2.seconds : 0, 0);
                                    val3 = (new Date()).setHours(val3.hours, val3.minutes, val3.seconds ? val3.seconds : 0, 0);
                                    if (val1 >= val2 && val1 < val3) fl++;
                                }
                                break;
                            case 'in':
                                var tmp = sdata.value;
                                if (sdata.svalue) tmp = sdata.svalue;
                                if (tmp.indexOf(val1) !== -1) fl++;
                                break;
                            case 'not in':
                                var tmp = sdata.value;
                                if (sdata.svalue) tmp = sdata.svalue;
                                if (tmp.indexOf(val1) == -1) fl++;
                                break;
                            case 'begins':
                            case 'begins with': // need for back compatib.
                                if (val1.indexOf(val2) == 0) fl++; // do not hide record
                                break;
                            case 'contains':
                                if (val1.indexOf(val2) >= 0) fl++; // do not hide record
                                break;
                            case 'ends':
                            case 'ends with': // need for back compatib.
                                if (val1.indexOf(val2) == val1.length - val2.length) fl++; // do not hide record
                                break;
                        }
                    }
                    if ((this.last.logic == 'OR' && fl != 0) || (this.last.logic == 'AND' && fl == this.searchData.length)) this.last.searchIds.push(parseInt(r));
                }
                this.total = this.last.searchIds.length;
            }
            time = (new Date()).getTime() - time;
            if (silent !== true) setTimeout(function () { obj.status(w2utils.lang('Search took') + ' ' + time/1000 + ' ' + w2utils.lang('sec')); }, 10);
            return time;
        },

        getRangeData: function (range, extra) {
            var rec1 = this.get(range[0].recid, true);
            var rec2 = this.get(range[1].recid, true);
            var col1 = range[0].column;
            var col2 = range[1].column;

            var res = [];
            if (col1 == col2) { // one row
                for (var r = rec1; r <= rec2; r++) {
                    var record = this.records[r];
                    var dt = record[this.columns[col1].field] || null;
                    if (extra !== true) {
                        res.push(dt);
                    } else {
                        res.push({ data: dt, column: col1, index: r, record: record });
                    }
                }
            } else if (rec1 == rec2) { // one line
                var record = this.records[rec1];
                for (var i = col1; i <= col2; i++) {
                    var dt = record[this.columns[i].field] || null;
                    if (extra !== true) {
                        res.push(dt);
                    } else {
                        res.push({ data: dt, column: i, index: rec1, record: record });
                    }
                }
            } else {
                for (var r = rec1; r <= rec2; r++) {
                    var record = this.records[r];
                    res.push([]);
                    for (var i = col1; i <= col2; i++) {
                        var dt = record[this.columns[i].field];
                        if (extra !== true) {
                            res[res.length-1].push(dt);
                        } else {
                            res[res.length-1].push({ data: dt, column: i, index: r, record: record });
                        }
                    }
                }
            }
            return res;
        },

        addRange: function (ranges) {
            var added = 0;
            if (this.selectType == 'row') return added;
            if (!$.isArray(ranges)) ranges = [ranges];
            // if it is selection
            for (var r in ranges) {
                if (typeof ranges[r] != 'object') ranges[r] = { name: 'selection' };
                if (ranges[r].name == 'selection') {
                    if (this.show.selectionBorder === false) continue;
                    var sel = this.getSelection();
                    if (sel.length == 0) {
                        this.removeRange(ranges[r].name);
                        continue;
                    } else {
                        var first = sel[0];
                        var last  = sel[sel.length-1];
                        var td1   = $('#grid_'+ this.name +'_rec_'+ first.recid + ' td[col='+ first.column +']');
                        var td2   = $('#grid_'+ this.name +'_rec_'+ last.recid + ' td[col='+ last.column +']');
                    }
                } else { // other range
                    var first = ranges[r].range[0];
                    var last  = ranges[r].range[1];
                    var td1   = $('#grid_'+ this.name +'_rec_'+ first.recid + ' td[col='+ first.column +']');
                    var td2   = $('#grid_'+ this.name +'_rec_'+ last.recid + ' td[col='+ last.column +']');
                }
                if (first) {
                    var rg = {
                        name: ranges[r].name,
                        range: [{ recid: first.recid, column: first.column }, { recid: last.recid, column: last.column }],
                        style: ranges[r].style || ''
                    };
                    // add range
                    var ind = false;
                    for (var t in this.ranges) if (this.ranges[t].name == ranges[r].name) { ind = r; break; }
                    if (ind !== false) {
                        this.ranges[ind] = rg;
                    } else {
                        this.ranges.push(rg);
                    }
                    added++
                }
            }
            this.refreshRanges();
            return added;
        },

        removeRange: function () {
            var removed = 0;
            for (var a = 0; a < arguments.length; a++) {
                var name = arguments[a];
                $('#grid_'+ this.name +'_'+ name).remove();
                for (var r = this.ranges.length-1; r >= 0; r--) {
                    if (this.ranges[r].name == name) {
                        this.ranges.splice(r, 1);
                        removed++;
                    }
                }
            }
            return removed;
        },

        refreshRanges: function () {
            var obj  = this;
            var time = (new Date()).getTime();
            var rec  = $('#grid_'+ this.name +'_records');
            for (var r in this.ranges) {
                var rg    = this.ranges[r];
                var first = rg.range[0];
                var last  = rg.range[1];
                var td1   = $('#grid_'+ this.name +'_rec_'+ first.recid + ' td[col='+ first.column +']');
                var td2   = $('#grid_'+ this.name +'_rec_'+ last.recid + ' td[col='+ last.column +']');
                if ($('#grid_'+ this.name +'_'+ rg.name).length == 0) {
                    rec.append('<div id="grid_'+ this.name +'_' + rg.name +'" class="w2ui-selection" style="'+ rg.style +'">'+
                                    (rg.name == 'selection' ?  '<div id="grid_'+ this.name +'_resizer" class="w2ui-selection-resizer"></div>' : '')+
                                '</div>');
                } else {
                    $('#grid_'+ this.name +'_'+ rg.name).attr('style', rg.style);
                }
                if (td1.length > 0 && td2.length > 0) {
                    $('#grid_'+ this.name +'_'+ rg.name).css({
                        left     : (td1.position().left - 1 + rec.scrollLeft()) + 'px',
                        top     : (td1.position().top - 1 + rec.scrollTop()) + 'px',
                        width     : (td2.position().left - td1.position().left + td2.width() + 3) + 'px',
                        height     : (td2.position().top - td1.position().top + td2.height() + 3) + 'px'
                    });
                }
            }

            // add resizer events
            $(this.box).find('#grid_'+ this.name +'_resizer').off('mousedown').on('mousedown', mouseStart);
            //$(this.box).find('#grid_'+ this.name +'_resizer').off('selectstart').on('selectstart', function () { return false; }); // fixes chrome cursror bug

            var eventData = { phase: 'before', type: 'selectionExtend', target: obj.name, originalRange: null, newRange: null };

            function mouseStart (event) {
                var sel = obj.getSelection();
                obj.last.move = {
                    type   : 'expand',
                    x      : event.screenX,
                    y      : event.screenY,
                    divX   : 0,
                    divY   : 0,
                    recid  : sel[0].recid,
                    column : sel[0].column,
                    originalRange : [{ recid: sel[0].recid, column: sel[0].column }, { recid: sel[sel.length-1].recid, column: sel[sel.length-1].column }],
                    newRange      : [{ recid: sel[0].recid, column: sel[0].column }, { recid: sel[sel.length-1].recid, column: sel[sel.length-1].column }]
                };
                $(document).off('mousemove', mouseMove).on('mousemove', mouseMove);
                $(document).off('mouseup', mouseStop).on('mouseup', mouseStop);
            }

            function mouseMove (event) {
                var mv = obj.last.move;
                if (!mv || mv.type != 'expand') return;
                mv.divX = (event.screenX - mv.x);
                mv.divY = (event.screenY - mv.y);
                // find new cell
                var recid, column;
                var tmp = event.originalEvent.target;
                if (tmp.tagName != 'TD') tmp = $(tmp).parents('td')[0];
                if (typeof $(tmp).attr('col') != 'undefined') column = parseInt($(tmp).attr('col'));
                tmp = $(tmp).parents('tr')[0];
                recid = $(tmp).attr('recid');
                // new range
                if (mv.newRange[1].recid == recid && mv.newRange[1].column == column) return;
                var prevNewRange = $.extend({}, mv.newRange);
                mv.newRange = [{ recid: mv.recid, column: mv.column }, { recid: recid, column: column }];
                // event before
                eventData = obj.trigger($.extend(eventData, { originalRange: mv.originalRange, newRange : mv.newRange }));
                if (eventData.isCancelled === true) {
                    mv.newRange        = prevNewRange;
                    eventData.newRange = prevNewRange;
                    return;
                } else {
                    // default behavior
                    obj.removeRange('grid-selection-expand');
                    obj.addRange({
                        name  : 'grid-selection-expand',
                        range : eventData.newRange,
                        style : 'background-color: rgba(100,100,100,0.1); border: 2px dotted rgba(100,100,100,0.5);'
                    });
                }
            }

            function mouseStop (event) {
                // default behavior
                obj.removeRange('grid-selection-expand');
                delete obj.last.move;
                $(document).off('mousemove', mouseMove);
                $(document).off('mouseup', mouseStop);
                // event after
                obj.trigger($.extend(eventData, { phase: 'after' }));
            }

            return (new Date()).getTime() - time;
        },

        select: function () {
            var selected = 0;
            var sel    = this.last.selection;
            if (!this.multiSelect) this.selectNone();
            for (var a = 0; a < arguments.length; a++) {
                var recid  = typeof arguments[a] == 'object' ? arguments[a].recid : arguments[a];
                var record = this.get(recid);
                if (record == null) continue;
                var index  = this.get(recid, true);
                var recEl  = $('#grid_'+ this.name +'_rec_'+ w2utils.escapeId(recid));
                if (this.selectType == 'row') {
                    if (sel.indexes.indexOf(index) >= 0) continue;
                    // event before
                    var eventData = this.trigger({ phase: 'before', type: 'select', target: this.name, recid: recid, index: index });
                    if (eventData.isCancelled === true) continue;
                    // default action
                    sel.indexes.push(index);
                    sel.indexes.sort(function(a, b) { return a-b });
                    recEl.addClass('w2ui-selected').data('selected', 'yes');
                    recEl.find('.w2ui-grid-select-check').prop("checked", true);
                    selected++;
                } else {
                    var col  = arguments[a].column;
                    if (!w2utils.isInt(col)) { // select all columns
                        var cols = [];
                        for (var c in this.columns) { if (this.columns[c].hidden) continue; cols.push({ recid: recid, column: parseInt(c) }); }
                        if (!this.multiSelect) cols = cols.splice(0, 1);
                        return this.select.apply(this, cols);
                    }
                    var s = sel.columns[index] || [];
                    if ($.isArray(s) && s.indexOf(col) != -1) continue;
                    // event before
                    var eventData = this.trigger({ phase: 'before', type: 'select', target: this.name, recid: recid, index: index, column: col });
                    if (eventData.isCancelled === true) continue;
                    // default action
                    if (sel.indexes.indexOf(index) == -1) {
                        sel.indexes.push(index);
                        sel.indexes.sort(function(a, b) { return a-b });
                    }
                    s.push(col);
                    s.sort(function(a, b) { return a-b }); // sort function must be for numerical sort
                    recEl.find(' > td[col='+ col +']').addClass('w2ui-selected');
                    selected++;
                    recEl.data('selected', 'yes');
                    recEl.find('.w2ui-grid-select-check').prop("checked", true);
                    // save back to selection object
                    sel.columns[index] = s;
                }
                // event after
                this.trigger($.extend(eventData, { phase: 'after' }));
            }
            // all selected?
            if (sel.indexes.length == this.records.length || (this.searchData.length !== 0 && sel.indexes.length == this.last.searchIds.length)) {
                $('#grid_'+ this.name +'_check_all').prop('checked', true);
            } else {
                $('#grid_'+ this.name +'_check_all').prop('checked', false);
            }
            this.status();
            this.addRange('selection');
            return selected;
        },

        unselect: function () {
            var unselected = 0;
            var sel = this.last.selection;
            for (var a = 0; a < arguments.length; a++) {
                var recid  = typeof arguments[a] == 'object' ? arguments[a].recid : arguments[a];
                var record = this.get(recid);
                if (record == null) continue;
                var index  = this.get(record.recid, true);
                var recEl  = $('#grid_'+ this.name +'_rec_'+ w2utils.escapeId(recid));
                if (this.selectType == 'row') {
                    if (sel.indexes.indexOf(index) == -1) continue;
                    // event before
                    var eventData = this.trigger({ phase: 'before', type: 'unselect', target: this.name, recid: recid, index: index });
                    if (eventData.isCancelled === true) continue;
                    // default action
                    sel.indexes.splice(sel.indexes.indexOf(index), 1);
                    recEl.removeClass('w2ui-selected').removeData('selected');
                    if (recEl.length != 0) recEl[0].style.cssText = 'height: '+ this.recordHeight +'px; ' + recEl.attr('custom_style');
                    recEl.find('.w2ui-grid-select-check').prop("checked", false);
                    unselected++;
                } else {
                    var col  = arguments[a].column;
                    if (!w2utils.isInt(col)) { // unselect all columns
                        var cols = [];
                        for (var c in this.columns) { if (this.columns[c].hidden) continue; cols.push({ recid: recid, column: parseInt(c) }); }
                        return this.unselect.apply(this, cols);
                    }
                    var s = sel.columns[index];
                    if (!$.isArray(s) || s.indexOf(col) == -1) continue;
                    // event before
                    var eventData = this.trigger({ phase: 'before', type: 'unselect', target: this.name, recid: recid, column: col });
                    if (eventData.isCancelled === true) continue;
                    // default action
                    s.splice(s.indexOf(col), 1);
                    $('#grid_'+ this.name +'_rec_'+ w2utils.escapeId(recid) + ' > td[col='+ col +']').removeClass('w2ui-selected');
                    unselected++;
                    if (s.length == 0) {
                        delete sel.columns[index];
                        sel.indexes.splice(sel.indexes.indexOf(index), 1);
                        recEl.removeData('selected');
                        recEl.find('.w2ui-grid-select-check').prop("checked", false);
                    }
                }
                // event after
                this.trigger($.extend(eventData, { phase: 'after' }));
            }
            // all selected?
            if (sel.indexes.length == this.records.length || (this.searchData.length !== 0 && sel.indexes.length == this.last.searchIds.length)) {
                $('#grid_'+ this.name +'_check_all').prop('checked', true);
            } else {
                $('#grid_'+ this.name +'_check_all').prop('checked', false);
            }
            // show number of selected
            this.status();
            this.addRange('selection');
            return unselected;
        },

        selectAll: function () {
            if (this.multiSelect === false) return;
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'select', target: this.name, all: true });
            if (eventData.isCancelled === true) return;
            // default action
            var url  = (typeof this.url != 'object' ? this.url : this.url.get);
            var sel  = this.last.selection;
            var cols = [];
            for (var c in this.columns) cols.push(parseInt(c));
            // if local data source and searched
            sel.indexes = [];
            if (!url && this.searchData.length !== 0) {
                // local search applied
                for (var i = 0; i < this.last.searchIds.length; i++) {
                    sel.indexes.push(this.last.searchIds[i]);
                    if (this.selectType != 'row') sel.columns[this.last.searchIds[i]] = cols.slice(); // .slice makes copy of the array
                }
            } else {
                var buffered = this.records.length;
                if (this.searchData.length != 0 && !this.url) buffered = this.last.searchIds.length;
                for (var i = 0; i < buffered; i++) {
                    sel.indexes.push(i);
                    if (this.selectType != 'row') sel.columns[i] = cols.slice(); // .slice makes copy of the array
                }
            }
            this.refresh();
            // enable/disable toolbar buttons
            var sel = this.getSelection();
            if (sel.length == 1) this.toolbar.enable('w2ui-edit'); else this.toolbar.disable('w2ui-edit');
            if (sel.length >= 1) this.toolbar.enable('w2ui-delete'); else this.toolbar.disable('w2ui-delete');
            this.addRange('selection');
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        selectNone: function () {
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'unselect', target: this.name, all: true });
            if (eventData.isCancelled === true) return;
            // default action
            var sel = this.last.selection;
            for (var s in sel.indexes) {
                var index = sel.indexes[s];
                var rec   = this.records[index];
                var recid = rec ? rec.recid : null;
                var recEl = $('#grid_'+ this.name +'_rec_'+ w2utils.escapeId(recid));
                recEl.removeClass('w2ui-selected').removeData('selected');
                recEl.find('.w2ui-grid-select-check').prop("checked", false);
                // for not rows
                if (this.selectType != 'row') {
                    var cols = sel.columns[index];
                    for (var c in cols) recEl.find(' > td[col='+ cols[c] +']').removeClass('w2ui-selected');
                }
            }
            sel.indexes = [];
            sel.columns = {};
            this.toolbar.disable('w2ui-edit', 'w2ui-delete');
            this.removeRange('selection');
            $('#grid_'+ this.name +'_check_all').prop('checked', false);
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        getSelection: function (returnIndex) {
            var ret = [];
            var sel = this.last.selection;
            if (this.selectType == 'row') {
                for (var s in sel.indexes) {
                    if (!this.records[sel.indexes[s]]) continue;
                    if (returnIndex === true) ret.push(sel.indexes[s]); else ret.push(this.records[sel.indexes[s]].recid);
                }
                return ret;
            } else {
                for (var s in sel.indexes) {
                    var cols = sel.columns[sel.indexes[s]];
                    if (!this.records[sel.indexes[s]]) continue;
                    for (var c in cols) {
                        ret.push({ recid: this.records[sel.indexes[s]].recid, index: parseInt(sel.indexes[s]), column: cols[c] });
                    }
                }
                return ret;
            }
        },

        search: function (field, value) {
            var obj         = this;
            var url         = (typeof this.url != 'object' ? this.url : this.url.get);
            var searchData  = [];
            var last_multi  = this.last.multi;
            var last_logic  = this.last.logic;
            var last_field  = this.last.field;
            var last_search = this.last.search;
            // 1: search() - advanced search (reads from popup)
            if (arguments.length == 0) {
                last_search = '';
                // advanced search
                for (var s in this.searches) {
                    var search   = this.searches[s];
                    var operator = $('#grid_'+ this.name + '_operator_'+s).val();
                    var field1   = $('#grid_'+ this.name + '_field_'+s);
                    var field2   = $('#grid_'+ this.name + '_field2_'+s);
                    var value1   = field1.val();
                    var value2   = field2.val();
                    var svalue   = null;
                    if (['int', 'float', 'money', 'currency', 'percent'].indexOf(search.type) != -1) {
                        var fld1 = field1.data('w2field');
                        var fld2 = field2.data('w2field');
                        if (fld1) value1 = fld1.clean(value1);
                        if (fld2) value2 = fld2.clean(value2);
                    }
                    if (['list', 'enum'].indexOf(search.type) != -1) {
                        value1 = field1.data('selected') || {};
                        if ($.isArray(value1)) {
                            svalue = [];
                            for (var v in value1) {
                                svalue.push(w2utils.isFloat(value1[v].id) ? parseFloat(value1[v].id) : String(value1[v].id).toLowerCase());
                                delete value1[v].hidden;
                            }
                        } else {
                            value1 = value1.id || '';
                        }
                    }
                    if ((value1 != '' && value1 != null) || (typeof value2 != 'undefined' && value2 != '')) {
                        var tmp = {
                            field    : search.field,
                            type     : search.type,
                            operator : operator
                        }
                        if (operator == 'between') {
                            $.extend(tmp, { value: [value1, value2] });
                        } else if (operator == 'in' && typeof value1 == 'string') {
                            $.extend(tmp, { value: value1.split(',') });
                        } else if (operator == 'not in' && typeof value1 == 'string') {
                            $.extend(tmp, { value: value1.split(',') });
                        } else {
                            $.extend(tmp, { value: value1 });
                        }
                        if (svalue) $.extend(tmp, { svalue: svalue });
                        // conver date to unix time
                        try {
                            if (search.type == 'date' && operator == 'between') {
                                tmp.value[0] = value1; // w2utils.isDate(value1, w2utils.settings.date_format, true).getTime();
                                tmp.value[1] = value2; // w2utils.isDate(value2, w2utils.settings.date_format, true).getTime();
                            }
                            if (search.type == 'date' && operator == 'is') {
                                tmp.value = value1; // w2utils.isDate(value1, w2utils.settings.date_format, true).getTime();
                            }
                        } catch (e) {

                        }
                        searchData.push(tmp);
                    }
                }
                if (searchData.length > 0 && !url) {
                    last_multi = true;
                    last_logic = 'AND';
                } else {
                    last_multi = true;
                    last_logic = 'AND';
                }
            }
            // 2: search(field, value) - regular search
            if (typeof field == 'string') {
                last_field  = field;
                last_search = value;
                last_multi  = false;
                last_logic  = 'OR';
                // loop through all searches and see if it applies
                if (typeof value != 'undefined') {
                    if (field.toLowerCase() == 'all') {
                        // if there are search fields loop thru them
                        if (this.searches.length > 0) {
                            for (var s in this.searches) {
                                var search = this.searches[s];
                                if (search.type == 'text' || (search.type == 'alphanumeric' && w2utils.isAlphaNumeric(value))
                                        || (search.type == 'int' && w2utils.isInt(value)) || (search.type == 'float' && w2utils.isFloat(value))
                                        || (search.type == 'percent' && w2utils.isFloat(value)) || (search.type == 'hex' && w2utils.isHex(value))
                                        || (search.type == 'currency' && w2utils.isMoney(value)) || (search.type == 'money' && w2utils.isMoney(value))
                                        || (search.type == 'date' && w2utils.isDate(value)) ) {
                                    var tmp = {
                                        field    : search.field,
                                        type     : search.type,
                                        operator : (search.type == 'text' ? 'contains' : 'is'),
                                        value    : value
                                    };
                                    searchData.push(tmp);
                                }
                                // range in global search box
                                if (['int', 'float', 'money', 'currency', 'percent'].indexOf(search.type) != -1 && String(value).indexOf('-') != -1) {
                                    var t = String(value).split('-');
                                    var tmp = {
                                        field    : search.field,
                                        type     : search.type,
                                        operator : 'between',
                                        value    : [t[0], t[1]]
                                    };
                                    searchData.push(tmp);
                                }
                            }
                        } else {
                            // no search fields, loop thru columns
                            for (var c in this.columns) {
                                var tmp = {
                                    field    : this.columns[c].field,
                                    type     : 'text',
                                    operator : 'contains',
                                    value    : value
                                };
                                searchData.push(tmp);
                            }
                        }
                    } else {
                        var el = $('#grid_'+ this.name +'_search_all');
                        var search = this.getSearch(field);
                        if (search == null) search = { field: field, type: 'text' };
                        if (search.field == field) this.last.caption = search.caption;
                        if (search.type == 'list') {
                            var tmp = el.data('selected');
                            if (tmp && !$.isEmptyObject(tmp)) value = tmp.id;
                        }
                        if (value != '') {
                            var op  = 'contains';
                            var val = value;
                            if (['date', 'time', 'list'].indexOf(search.type) != -1) op = 'is';
                            if (search.type == 'int' && value != '') {
                                op = 'is';
                                if (String(value).indexOf('-') != -1) {
                                    var tmp = value.split('-');
                                    if (tmp.length == 2) {
                                        op = 'between';
                                        val = [parseInt(tmp[0]), parseInt(tmp[1])];
                                    }
                                }
                                if (String(value).indexOf(',') != -1) {
                                    var tmp = value.split(',');
                                    op  = 'in';
                                    val = [];
                                    for (var t in tmp) val.push(tmp[t]);
                                }
                            }
                            var tmp = {
                                field    : search.field,
                                type     : search.type,
                                operator : op,
                                value    : val
                            }
                            searchData.push(tmp);
                        }
                    }
                }
            }
            // 3: search([ { field, value, [operator,] [type] }, { field, value, [operator,] [type] } ], logic) - submit whole structure
            if ($.isArray(field)) {
                var logic = 'AND';
                if (typeof value == 'string') {
                    logic = value.toUpperCase();
                    if (logic != 'OR' && logic != 'AND') logic = 'AND';
                }
                last_search = '';
                last_multi  = true;
                last_logic  = logic;
                for (var f in field) {
                    var data   = field[f];
                    var search = this.getSearch(data.field);
                    if (search == null) search = { type: 'text', operator: 'contains' };
                    // merge current field and search if any
                    searchData.push($.extend(true, {}, search, data));
                }
            }
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'search', target: this.name, searchData: searchData,
                    searchField: (field ? field : 'multi'), searchValue: (value ? value : 'multi') });
            if (eventData.isCancelled === true) return;
            // default action
            this.searchData  = eventData.searchData;
            this.last.field  = last_field;
            this.last.search = last_search;
            this.last.multi  = last_multi;
            this.last.logic  = last_logic;
            this.last.scrollTop         = 0;
            this.last.scrollLeft        = 0;
            this.last.selection.indexes = [];
            this.last.selection.columns = {};
            // -- clear all search field
            this.searchClose();
            this.set({ expanded: false }, true);
            // apply search
            if (url) {
                this.last.xhr_offset = 0;
                this.reload();
            } else {
                // local search
                this.localSearch();
                this.refresh();
            }
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        searchOpen: function () {
            if (!this.box) return;
            if (this.searches.length == 0) return;
            var obj = this;
            // show search
            $('#tb_'+ this.name +'_toolbar_item_w2ui-search-advanced').w2overlay(
                this.getSearchesHTML(),    {
                    name    : 'searches-'+ this.name,
                    left    : -10,
                    'class' : 'w2ui-grid-searches',
                    onShow  : function () {
                        if (obj.last.logic == 'OR') obj.searchData = [];
                        obj.initSearches();
                        $('#w2ui-overlay-searches-'+ this.name +' .w2ui-grid-searches').data('grid-name', obj.name);
                        var sfields = $('#w2ui-overlay-searches-'+ this.name +' .w2ui-grid-searches *[rel=search]');
                        if (sfields.length > 0) sfields[0].focus();
                    }
                }
            );
        },

        searchClose: function () {
            if (!this.box) return;
            if (this.searches.length == 0) return;
            if (this.toolbar) this.toolbar.uncheck('w2ui-search-advanced')
            // hide search
            if ($('#w2ui-overlay-searches-'+ this.name +' .w2ui-grid-searches').length > 0) {
                $().w2overlay('', { name: 'searches-'+ this.name });
            }
        },

        searchShowFields: function () {
            var el   = $('#grid_'+ this.name +'_search_all');
            var html = '<div class="w2ui-select-field"><table>';
            for (var s = -1; s < this.searches.length; s++) {
                var search = this.searches[s];
                if (s == -1) {
                    if (!this.multiSearch) continue;
                    search = { field: 'all', caption: w2utils.lang('All Fields') };
                } else {
                    if (this.searches[s].hidden === true) continue;
                }
                html += '<tr '+ (w2utils.isIOS ? 'onTouchStart' : 'onClick') +'="w2ui[\''+ this.name +'\'].initAllField(\''+ search.field +'\')">'+
                        '    <td><input type="radio" tabIndex="-1" '+ (search.field == this.last.field ? 'checked' : '') +'></td>'+
                        '    <td>'+ search.caption +'</td>'+
                        '</tr>';
            }
            html += "</table></div>";
            // need timer otherwise does nto show with list type
            setTimeout(function () {
                $(el).w2overlay(html, { left: -10 });
            }, 1);
        },

        initAllField: function (field, value) {
            var el     = $('#grid_'+ this.name +'_search_all');
            var search = this.getSearch(field);
            if (field == 'all') {
                search = { field: 'all', caption: w2utils.lang('All Fields') };
                el.w2field('clear');
                el.change().focus();
            } else {
                var st = search.type;
                if (['enum', 'select'].indexOf(st) != -1) st = 'list';
                el.w2field(st, $.extend({}, search.options, { suffix: '', autoFormat: false, selected: value }));
                if (['list', 'enum'].indexOf(search.type) != -1) {
                    this.last.search = '';
                    this.last.item   = '';
                    el.val('');
                }
                // set focus
                setTimeout(function () { 
                    el.focus(); /* do not do el.change() as it will refresh grid and pull from server */ 
                }, 1);
            }
            // update field
            if (this.last.search != '') {
                this.search(search.field, this.last.search);
            } else {
                this.last.field   = search.field;
                this.last.caption = search.caption;
            }
            el.attr('placeholder', search.caption);
            $().w2overlay();
        },

        searchReset: function (noRefresh) {
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'search', target: this.name, searchData: [] });
            if (eventData.isCancelled === true) return;
            // default action
            this.searchData  = [];
            this.last.search = '';
            this.last.logic  = 'OR';
            // --- do not reset to All Fields (I think)
            // if (this.last.multi) {
            //     if (!this.multiSearch) {
            //         this.last.field     = this.searches[0].field;
            //         this.last.caption     = this.searches[0].caption;
            //     } else {
            //         this.last.field      = 'all';
            //         this.last.caption     = w2utils.lang('All Fields');
            //     }
            // }
            this.last.multi      = false;
            this.last.xhr_offset = 0;
            // reset scrolling position
            this.last.scrollTop  = 0;
            this.last.scrollLeft = 0;
            this.last.selection.indexes = [];
            this.last.selection.columns = {};
            // -- clear all search field
            this.searchClose();
            $('#grid_'+ this.name +'_search_all').val('');
            // apply search
            if (!noRefresh) this.reload();
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        clear: function (noRefresh) {
            // this.offset              = 0;   // clear should not reset offset
            // this.total               = 0;   // clear should not reset total
            this.records                = [];
            this.summary                = [];
            this.last.scrollTop         = 0;
            this.last.scrollLeft        = 0;
            this.last.selection.indexes = [];
            this.last.selection.columns = {};
            this.last.range_start       = null;
            this.last.range_end         = null;
            this.last.xhr_offset        = 0;
            if (!noRefresh) this.refresh();
        },

        reset: function (noRefresh) {
            // reset last remembered state
            this.offset                 = 0;
            this.total                  = 0;
            this.last.scrollTop         = 0;
            this.last.scrollLeft        = 0;
            this.last.selection.indexes = [];
            this.last.selection.columns = {};
            this.last.range_start       = null;
            this.last.range_end         = null;
            this.last.xhr_offset        = 0;
            this.searchReset(noRefresh);
            // initial sort
            if (this.last.sortData != null ) this.sortData = this.last.sortData;
            // select none without refresh
            this.set({ expanded: false }, true);
            // refresh
            if (!noRefresh) this.refresh();
        },

        skip: function (offset) {
            var url = (typeof this.url != 'object' ? this.url : this.url.get);
            if (url) {
                this.offset = parseInt(offset);
                if (this.offset > this.total) this.offset = this.total - this.limit;
                if (this.offset < 0 || !w2utils.isInt(this.offset)) this.offset = 0;
                this.records  = [];
                this.last.xhr_offset = 0;
                this.last.pull_more  = true;
                this.last.scrollTop  = 0;
                this.last.scrollLeft = 0;
                $('#grid_'+ this.name +'_records').prop('scrollTop',  0);
                this.reload();
            } else {
                console.log('ERROR: grid.skip() can only be called when you have remote data source.');
            }
        },

        load: function (url, callBack) {
            if (typeof url == 'undefined') {
                console.log('ERROR: You need to provide url argument when calling .load() method of "'+ this.name +'" object.');
                return;
            }
            // default action
            this.request('get-records', {}, url, callBack);
        },

        reload: function (callBack) {
            var url = (typeof this.url != 'object' ? this.url : this.url.get);
            if (url) {
                this.clear(true);
                this.request('get-records', {}, null, callBack);
            } else {
                this.last.scrollTop   = 0;
                this.last.scrollLeft  = 0;
                this.last.range_start = null;
                this.last.range_end   = null;
                this.localSearch();
                this.refresh();
                if (typeof callBack == 'function') callBack({ status: 'success' });
            }
        },

        request: function (cmd, add_params, url, callBack) {
            if (typeof add_params == 'undefined') add_params = {};
            if (typeof url == 'undefined' || url == '' || url == null) url = this.url;
            if (url == '' || url == null) return;
            // build parameters list
            var params = {};
            if (!w2utils.isInt(this.offset)) this.offset = 0;
            if (!w2utils.isInt(this.last.xhr_offset)) this.last.xhr_offset = 0;
            // add list params
            params['cmd']         = cmd;
            params['selected']    = this.getSelection();
            params['limit']       = this.limit;
            params['offset']      = parseInt(this.offset) + this.last.xhr_offset;
            params['search']      = this.searchData;
            params['searchLogic'] = this.last.logic;
            params['sort']        = this.sortData;
            if (this.searchData.length == 0) {
                delete params['search'];
                delete params['searchLogic'];
            }
            if (this.sortData.length == 0) {
                delete params['sort'];
            }
            // append other params
            $.extend(params, this.postData);
            $.extend(params, add_params);
            // event before
            if (cmd == 'get-records') {
                var eventData = this.trigger({ phase: 'before', type: 'request', target: this.name, url: url, postData: params });
                if (eventData.isCancelled === true) { if (typeof callBack == 'function') callBack({ status: 'error', message: 'Request aborted.' }); return; }
            } else {
                var eventData = { url: url, postData: params };
            }
            // call server to get data
            var obj = this;
            if (this.last.xhr_offset == 0) {
                this.lock(this.msgRefresh, true);
            } else {
                var more = $('#grid_'+ this.name +'_rec_more');
                if (this.autoLoad === true) {
                    more.show().find('td').html('<div><div style="width: 20px; height: 20px;" class="w2ui-spinner"></div></div>');
                } else {
                    more.find('td').html('<div>'+ w2utils.lang('Load') + ' ' + obj.limit + ' ' + w2utils.lang('More') + '...</div>');
                }
            }
            if (this.last.xhr) try { this.last.xhr.abort(); } catch (e) {};
            // URL
            var url = (typeof eventData.url != 'object' ? eventData.url : eventData.url.get);
            if (params.cmd == 'save-records' && typeof eventData.url == 'object')   url = eventData.url.save;
            if (params.cmd == 'delete-records' && typeof eventData.url == 'object') url = eventData.url.remove;
            // process url with routeData
            if (!$.isEmptyObject(obj.routeData)) {
                var info  = w2utils.parseRoute(url);
                if (info.keys.length > 0) {
                    for (var k = 0; k < info.keys.length; k++) {
                        if (obj.routeData[info.keys[k].name] == null) continue;
                        url = url.replace((new RegExp(':'+ info.keys[k].name, 'g')), obj.routeData[info.keys[k].name]);
                    }
                }
            }
            // ajax ptions
            var ajaxOptions = {
                type     : 'POST',
                url      : url,
                data     : eventData.postData, 
                dataType : 'text'  // expected data type from server
            };
            if (w2utils.settings.dataType == 'HTTP') {
                ajaxOptions.data = (typeof ajaxOptions.data == 'object' ? String($.param(ajaxOptions.data, false)).replace(/%5B/g, '[').replace(/%5D/g, ']') : ajaxOptions.data);
            }
            if (w2utils.settings.dataType == 'RESTFULL') {
                ajaxOptions.type = 'GET';
                if (params.cmd == 'save-records')   ajaxOptions.type = 'PUT';  // so far it is always update
                if (params.cmd == 'delete-records') ajaxOptions.type = 'DELETE';
                ajaxOptions.data = (typeof ajaxOptions.data == 'object' ? String($.param(ajaxOptions.data, false)).replace(/%5B/g, '[').replace(/%5D/g, ']') : ajaxOptions.data);
            }
            if (w2utils.settings.dataType == 'JSON') {
                ajaxOptions.type        = 'POST';
                ajaxOptions.data        = JSON.stringify(ajaxOptions.data);
                ajaxOptions.contentType = 'application/json';
            }
            if (this.method) ajaxOptions.type = this.method;

            this.last.xhr_cmd   = params.cmd;
            this.last.xhr_start = (new Date()).getTime();
            this.last.xhr = $.ajax(ajaxOptions)
                .done(function (data, status, xhr) {
                    obj.requestComplete(status, cmd, callBack);
                })
                .fail(function (xhr, status, error) {
                    // trigger event
                    var errorObj = { status: status, error: error, rawResponseText: xhr.responseText };
                    var eventData2 = obj.trigger({ phase: 'before', type: 'error', error: errorObj, xhr: xhr });
                    if (eventData2.isCancelled === true) return;
                    // default behavior
                    if (status != 'abort') {
                        var data;
                        try { data = $.parseJSON(xhr.responseText) } catch (e) {}
                        console.log('ERROR: Server communication failed.', 
                            '\n   EXPECTED:', { status: 'success', total: 5, records: [{ recid: 1, field: 'value' }] }, 
                            '\n         OR:', { status: 'error', message: 'error message' },
                            '\n   RECEIVED:', typeof data == 'object' ? data : xhr.responseText);
                        obj.requestComplete('error', cmd, callBack);
                    }
                    // event after
                    obj.trigger($.extend(eventData2, { phase: 'after' }));
                });
            if (cmd == 'get-records') {
                // event after
                this.trigger($.extend(eventData, { phase: 'after' }));
            }
        },

        requestComplete: function(status, cmd, callBack) {
            var obj = this;
            this.unlock();
            setTimeout(function () { obj.status(w2utils.lang('Server Response') + ' ' + ((new Date()).getTime() - obj.last.xhr_start)/1000 +' ' + w2utils.lang('sec')); }, 10);
            this.last.pull_more    = false;
            this.last.pull_refresh = true;

            // event before
            var event_name = 'load';
            if (this.last.xhr_cmd == 'save-records') event_name   = 'save';
            if (this.last.xhr_cmd == 'delete-records') event_name = 'deleted';
            var eventData = this.trigger({ phase: 'before', target: this.name, type: event_name, xhr: this.last.xhr, status: status });
            if (eventData.isCancelled === true) {
                if (typeof callBack == 'function') callBack({ status: 'error', message: 'Request aborted.' });
                return;
            }
            // parse server response
            var data;
            var responseText = this.last.xhr.responseText;
            if (status != 'error') {
                // default action
                if (typeof responseText != 'undefined' && responseText != '') {
                    // check if the onLoad handler has not already parsed the data
                    if (typeof responseText == "object") {
                        data = responseText;
                    } else {
                        if (typeof obj.parser == 'function') {
                            data = obj.parser(responseText);
                            if (typeof data != 'object') {
                                console.log('ERROR: Your parser did not return proper object');
                            }
                        } else {
                            // $.parseJSON or $.getJSON did not work because those expect perfect JSON data - where everything is in double quotes
                            //
                            // TODO: avoid (potentially malicious) code injection from the response.
                            try { eval('data = '+ responseText); } catch (e) { }
                        }
                    }
                    // convert recids
                    if (obj.recid) {
                        for (var r in data.records) {
                            data.records[r]['recid'] = data.records[r][obj.recid];
                        }
                    }
                    if (typeof data == 'undefined') {
                        data = {
                            status       : 'error',
                            message      : this.msgNotJSON,
                            responseText : responseText
                        };
                    }
                    if (data['status'] == 'error') {
                        obj.error(data['message']);
                    } else {
                        if (cmd == 'get-records') {
                            if (this.last.xhr_offset == 0) {
                                this.records = [];
                                this.summary = [];
                                //data.xhr_status=data.status;
                                delete data.status;
                                $.extend(true, this, data);
                            } else {
                                var records = data.records;
                                delete data.records;
                                //data.xhr_status=data.status;
                                delete data.status;
                                $.extend(true, this, data);
                                for (var r in records) {
                                    this.records.push(records[r]);
                                }
                            }
                        }
                        if (cmd == 'delete-records') {
                            // reset() also triggers reload
                            this.reset(); // unselect old selections
                            return;
                        }
                    }
                }
            } else {
                data = {
                    status       : 'error',
                    message      : this.msgAJAXerror,
                    responseText : responseText
                };
                obj.error(this.msgAJAXerror);
            }
            // event after
            var url = (typeof this.url != 'object' ? this.url : this.url.get);
            if (!url) {
                this.localSort();
                this.localSearch();
            }
            this.total = parseInt(this.total);
            this.trigger($.extend(eventData, { phase: 'after' }));
            // do not refresh if loading on infinite scroll
            if (this.last.xhr_offset == 0) this.refresh(); else this.scroll();
            // call back
            if (typeof callBack == 'function') callBack(data);
        },

        error: function (msg) {
            var obj = this;
            // let the management of the error outside of the grid
            var eventData = this.trigger({ target: this.name, type: 'error', message: msg , xhr: this.last.xhr });
            if (eventData.isCancelled === true) {
                if (typeof callBack == 'function') callBack({ status: 'error', message: 'Request aborted.' });
                return;
            }
            w2alert(msg, 'Error');
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        getChanges: function () {
            var changes = [];
            for (var r in this.records) {
                var rec = this.records[r];
                if (typeof rec['changes'] != 'undefined') {
                    changes.push($.extend(true, { recid: rec.recid }, rec.changes));
                }
            }
            return changes;
        },

        mergeChanges: function () {
            var changes = this.getChanges();
            for (var c in changes) {
                var record = this.get(changes[c].recid);
                for (var s in changes[c]) {
                    if (s == 'recid') continue; // do not allow to change recid
                    try { eval('record.' + s + ' = changes[c][s]'); } catch (e) {}
                    delete record.changes;
                }
            }
            this.refresh();
        },

        // ===================================================
        // --  Action Handlers

        save: function () {
            var obj = this;
            var changes = this.getChanges();
            // event before
            var eventData = this.trigger({ phase: 'before', target: this.name, type: 'submit', changes: changes });
            if (eventData.isCancelled === true) return;
            var url = (typeof this.url != 'object' ? this.url : this.url.save);
            if (url) {
                this.request('save-records', { 'changes' : eventData.changes }, null,
                    function (data) {
                        if (data.status !== 'error') {
                            // only merge changes, if save was successful
                            obj.mergeChanges();
                        }
                        // event after
                        obj.trigger($.extend(eventData, { phase: 'after' }));
                    }
                );
            } else {
                this.mergeChanges();
                // event after
                this.trigger($.extend(eventData, { phase: 'after' }));
            }
        },

        editField: function (recid, column, value, event) {
            var obj   = this;
            var index = obj.get(recid, true);
            var rec   = obj.records[index];
            var col   = obj.columns[column];
            var edit  = col ? col.editable : null;
            if (!rec || !col || !edit || rec.editable === false) return;
            if (['enum', 'file'].indexOf(edit.type) != -1) {
                console.log('ERROR: input types "enum" and "file" are not supported in inline editing.');
                return;
            }
            // event before
            var eventData = obj.trigger({ phase: 'before', type: 'editField', target: obj.name, recid: recid, column: column, value: value,
                index: index, originalEvent: event });
            if (eventData.isCancelled === true) return;
            value = eventData.value;
            // default behaviour
            this.selectNone();
            this.select({ recid: recid, column: column });
            this.last.edit_col = column;
            if (['checkbox', 'check'].indexOf(edit.type) != -1) return;
            // create input element
            var tr = $('#grid_'+ obj.name +'_rec_'+ w2utils.escapeId(recid));
            var el = tr.find('[col='+ column +'] > div');
            if (typeof edit.inTag   == 'undefined') edit.inTag   = '';
            if (typeof edit.outTag  == 'undefined') edit.outTag  = '';
            if (typeof edit.style   == 'undefined') edit.style   = '';
            if (typeof edit.items   == 'undefined') edit.items   = [];
            var val = (rec.changes && typeof rec.changes[col.field] != 'undefined' ? w2utils.stripTags(rec.changes[col.field]) : w2utils.stripTags(rec[col.field]));
            if (val == null || typeof val == 'undefined') val = '';
            if (typeof value != 'undefined' && value != null) val = value;
            var addStyle = (typeof col.style != 'undefined' ? col.style + ';' : '');
            if (typeof col.render == 'string' && ['number', 'int', 'float', 'money', 'percent'].indexOf(col.render.split(':')[0]) != -1) {
                addStyle += 'text-align: right;';
            }
            // mormalize items
            if (edit.items.length > 0 && !$.isPlainObject(edit.items[0])) {
                edit.items = w2obj.field.prototype.normMenu(edit.items);
            }
            if (edit.type == 'select') {
                var html = '';
                for (var i in edit.items) {
                    html += '<option value="'+ edit.items[i].id +'" '+ (edit.items[i].id == val ? 'selected' : '') +'>'+ edit.items[i].text +'</option>';
                }
                el.addClass('w2ui-editable')
                    .html('<select id="grid_'+ obj.name +'_edit_'+ recid +'_'+ column +'" column="'+ column +'" '+
                        '    style="width: 100%; '+ addStyle + edit.style +'" field="'+ col.field +'" recid="'+ recid +'" '+
                        '    '+ edit.inTag +
                        '>'+ html +'</select>' + edit.outTag);
                el.find('select').focus()
                    .on('change', function (event) {
                        delete obj.last.move;
                    })
                    .on('blur', function (event) {
                        obj.editChange.call(obj, this, index, column, event);
                    });
            } else {
                el.addClass('w2ui-editable')
                    .html('<input id="grid_'+ obj.name +'_edit_'+ recid +'_'+ column +'" '+
                        '    type="text" style="font-family: inherit; font-size: inherit; outline: none; '+ addStyle + edit.style +'" field="'+ col.field +'" recid="'+ recid +'" '+
                        '    column="'+ column +'" '+ edit.inTag +
                        '>' + edit.outTag);
                if (value == null) el.find('input').val(val != 'object' ? val : '');
                // init w2field
                var input = el.find('input').get(0);
                $(input).w2field(edit.type, $.extend(edit, { selected: val }))
                // add blur listener
                setTimeout(function () {
                    var tmp = input;
                    if (edit.type == 'list') {
                        tmp = $($(input).data('w2field').helpers.focus).find('input');
                        if (typeof val != 'object' && val != '') tmp.val(val).css({ opacity: 1 }).prev().css({ opacity: 1 });
                    }
                    $(tmp).on('blur', function (event) {
                        obj.editChange.call(obj, input, index, column, event);
                    });
                }, 10);
                if (value != null) $(input).val(val != 'object' ? val : '');
            }
            setTimeout(function () {
                el.find('input, select')
                    .on('click', function (event) {
                        event.stopPropagation();
                    })
                    .on('keydown', function (event) {
                        var cancel = false;
                        switch (event.keyCode) {
                            case 9:  // tab
                                cancel = true;
                                var next_rec = recid;
                                var next_col = event.shiftKey ? obj.prevCell(column, true) : obj.nextCell(column, true);
                                // next or prev row
                                if (next_col == null) {
                                    var tmp = event.shiftKey ? obj.prevRow(index) : obj.nextRow(index);
                                    if (tmp != null && tmp != index) {
                                        next_rec = obj.records[tmp].recid;
                                        // find first editable row
                                        for (var c in obj.columns) {
                                            var tmp = obj.columns[c].editable;
                                            if (typeof tmp != 'undefined' && ['checkbox', 'check'].indexOf(tmp.type) == -1) {
                                                next_col = parseInt(c);
                                                if (!event.shiftKey) break;
                                            }
                                        }
                                    }

                                }
                                if (next_rec === false) next_rec = recid;
                                if (next_col == null) next_col = column;
                                // init new or same record
                                this.blur();
                                setTimeout(function () {
                                    if (obj.selectType != 'row') {
                                        obj.selectNone();
                                        obj.select({ recid: next_rec, column: next_col });
                                    } else {
                                        obj.editField(next_rec, next_col, null, event);
                                    }
                                }, 1);
                                break;

                            case 13: // enter
                                this.blur();
                                var next = event.shiftKey ? obj.prevRow(index) : obj.nextRow(index);
                                if (next != null && next != index) {
                                    setTimeout(function () {
                                        if (obj.selectType != 'row') {
                                            obj.selectNone();
                                            obj.select({ recid: obj.records[next].recid, column: column });
                                        } else {
                                            obj.editField(obj.records[next].recid, column, null, event);
                                        }
                                    }, 100);
                                }
                                break;

                            case 38: // up arrow
                                if (!event.shiftKey) break;
                                cancel = true;
                                var next = obj.prevRow(index);
                                if (next != index) {
                                    this.blur();
                                    setTimeout(function () {
                                        if (obj.selectType != 'row') {
                                            obj.selectNone();
                                            obj.select({ recid: obj.records[next].recid, column: column });
                                        } else {
                                            obj.editField(obj.records[next].recid, column, null, event);
                                        }
                                    }, 1);
                                }
                                break;

                            case 40: // down arrow
                                if (!event.shiftKey) break;
                                cancel = true;
                                var next = obj.nextRow(index);
                                if (next != null && next != index) {
                                    this.blur();
                                    setTimeout(function () {
                                        if (obj.selectType != 'row') {
                                            obj.selectNone();
                                            obj.select({ recid: obj.records[next].recid, column: column });
                                        } else {
                                            obj.editField(obj.records[next].recid, column, null, event);
                                        }
                                    }, 1);
                                }
                                break;

                            case 27: // escape
                                var old = obj.parseField(rec, col.field);
                                if (rec.changes && typeof rec.changes[col.field] != 'undefined') old = rec.changes[col.field];
                                this.value = typeof old != 'undefined' ? old : '';
                                this.blur();
                                setTimeout(function () { obj.select({ recid: recid, column: column }) }, 1);
                                break;
                        }
                        if (cancel) if (event.preventDefault) event.preventDefault();
                    });
                // focus and select
                var tmp = el.find('input').focus();
                if (value != null) {
                    // set cursor to the end
                    tmp[0].setSelectionRange(tmp.val().length, tmp.val().length);
                } else {
                    tmp.select();
                }

            }, 1);
            // event after
            obj.trigger($.extend(eventData, { phase: 'after' }));
        },

        editChange: function (el, index, column, event) {
            // all other fields
            var summary = index < 0;
            index = index < 0 ? -index - 1 : index;
            var records = summary ? this.summary : this.records;
            var rec     = records[index];
            var tr      = $('#grid_'+ this.name +'_rec_'+ w2utils.escapeId(rec.recid));
            var col     = this.columns[column];
            var new_val = el.value;
            var old_val = this.parseField(rec, col.field);
            var tmp     = $(el).data('w2field');
            if (tmp) {
                new_val = tmp.clean(new_val);
                if (tmp.type == 'list' && new_val != '') new_val = $(el).data('selected');
            }
            if (el.type == 'checkbox') new_val = el.checked;
            // change/restore event
            var eventData = {
                phase: 'before', type: 'change', target: this.name, input_id: el.id, recid: rec.recid, index: index, column: column,
                value_new: new_val, value_previous: (rec.changes && rec.changes.hasOwnProperty(col.field) ? rec.changes[col.field]: old_val), value_original: old_val
            };
            while (true) {
                new_val = eventData.value_new;
                if ((typeof new_val != 'object' && String(old_val) != String(new_val)) || 
                    (typeof new_val == 'object' && (typeof old_val != 'object' || new_val.id != old_val.id))) {
                    // change event
                    eventData = this.trigger($.extend(eventData, { type: 'change', phase: 'before' }));
                    if (eventData.isCancelled !== true) {
                        if (new_val !== eventData.value_new) {
                            // re-evaluate the type of change to be made
                            continue;
                        }
                        // default action
                        rec.changes = rec.changes || {};
                        rec.changes[col.field] = eventData.value_new;
                        // event after
                        this.trigger($.extend(eventData, { phase: 'after' }));
                    }
                } else {
                    // restore event
                    eventData = this.trigger($.extend(eventData, { type: 'restore', phase: 'before' }));
                    if (eventData.isCancelled !== true) {
                        if (new_val !== eventData.value_new) {
                            // re-evaluate the type of change to be made
                            continue;
                        }
                        // default action
                        if (rec.changes) delete rec.changes[col.field];
                        if ($.isEmptyObject(rec.changes)) delete rec.changes;
                        // event after
                        this.trigger($.extend(eventData, { phase: 'after' }));
                    }
                }
                break;
            }
            // refresh cell
            var cell = this.getCellHTML(index, column, summary);
            if (!summary) {
                if (rec.changes && typeof rec.changes[col.field] != 'undefined') {
                    $(tr).find('[col='+ column +']').addClass('w2ui-changed').html(cell);
                } else {
                    $(tr).find('[col='+ column +']').removeClass('w2ui-changed').html(cell);
                }
            }
        },

        "delete": function (force) {
            var obj = this;
            // event before
            var eventData = this.trigger({ phase: 'before', target: this.name, type: 'delete', force: force });
            if (eventData.isCancelled === true) return;
            force = eventData.force;
            // default action
            var recs = this.getSelection();
            if (recs.length == 0) return;
            if (this.msgDelete != '' && !force) {
                w2confirm({
                    title   : w2utils.lang('Delete Confirmation'), 
                    msg     : obj.msgDelete, 
                    btn_yes : { "class": 'btn-red' },
                    callBack: function (result) {
                        if (result == 'Yes') w2ui[obj.name]['delete'](true);
                    }
                });
                return;
            }
            // call delete script
            var url = (typeof this.url != 'object' ? this.url : this.url.remove);
            if (url) {
                this.request('delete-records');
            } else {
                this.selectNone();
                if (typeof recs[0] != 'object') {
                    this.remove.apply(this, recs);
                } else {
                    // clear cells
                    for (var r in recs) {
                        var fld = this.columns[recs[r].column].field;
                        var ind = this.get(recs[r].recid, true);
                        if (ind != null && fld != 'recid') {
                            this.records[ind][fld] = '';
                            if (this.records[ind].changes) delete this.records[ind].changes[fld];
                        }
                    }
                    this.refresh();
                }
            }
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        click: function (recid, event) {
            var time = (new Date()).getTime();
            var column = null;
            if (this.last.cancelClick == true || (event && event.altKey)) return;
            if (typeof recid == 'object') {
                column = recid.column;
                recid  = recid.recid;
            }
            if (typeof event == 'undefined') event = {};
            // check for double click
            if (time - parseInt(this.last.click_time) < 350 && event.type == 'click') {
                this.dblClick(recid, event);
                return;
            }
            this.last.click_time = time;
            // column user clicked on
            if (column == null && event.target) {
                var tmp = event.target;
                if (tmp.tagName != 'TD') tmp = $(tmp).parents('td')[0];
                if (typeof $(tmp).attr('col') != 'undefined') column = parseInt($(tmp).attr('col'));
            }
            // event before
            var eventData = this.trigger({ phase: 'before', target: this.name, type: 'click', recid: recid, column: column, originalEvent: event });
            if (eventData.isCancelled === true) return;
            // if it is subgrid unselect top grid
            var parent = $('#grid_'+ this.name +'_rec_'+ w2utils.escapeId(recid)).parents('tr');
            if (parent.length > 0 && String(parent.attr('id')).indexOf('expanded_row') != -1) {
                var grid  = parent.parents('.w2ui-grid').attr('name');
                w2ui[grid].selectNone();
                // all subgrids
                parent.parents('.w2ui-grid').find('.w2ui-expanded-row .w2ui-grid').each(function (index, el) {
                    var grid = $(el).attr('name');
                    if (w2ui[grid]) w2ui[grid].selectNone();
                });
            }
            // unselect all subgrids
            $(this.box).find('.w2ui-expanded-row .w2ui-grid').each(function (index, el) {
                var grid = $(el).attr('name');
                if (w2ui[grid]) w2ui[grid].selectNone();
            });
            // default action
            var obj = this;
            var sel = this.getSelection();
            $('#grid_'+ this.name +'_check_all').prop("checked", false);
            var ind    = this.get(recid, true);
            var record = this.records[ind];
            var selectColumns  = [];
            obj.last.sel_ind   = ind;
            obj.last.sel_col   = column;
            obj.last.sel_recid = recid;
            obj.last.sel_type  = 'click';
            // multi select with shif key
            if (event.shiftKey && sel.length > 0 && obj.multiSelect) {
                if (sel[0].recid) {
                    var start = this.get(sel[0].recid, true);
                    var end   = this.get(recid, true);
                    if (column > sel[0].column) {
                        var t1 = sel[0].column;
                        var t2 = column;
                    } else {
                        var t1 = column;
                        var t2 = sel[0].column;
                    }
                    for (var c = t1; c <= t2; c++) selectColumns.push(c);
                } else {
                    var start = this.get(sel[0], true);
                    var end   = this.get(recid, true);
                }
                var sel_add = []
                if (start > end) { var tmp = start; start = end; end = tmp; }
                var url = (typeof this.url != 'object' ? this.url : this.url.get);
                for (var i = start; i <= end; i++) {
                    if (this.searchData.length > 0 && !url && $.inArray(i, this.last.searchIds) == -1) continue;
                    if (this.selectType == 'row') {
                        sel_add.push(this.records[i].recid);
                    } else {
                        for (var sc in selectColumns) sel_add.push({ recid: this.records[i].recid, column: selectColumns[sc] });
                    }
                    //sel.push(this.records[i].recid);
                }
                this.select.apply(this, sel_add);
            } else {
                var last = this.last.selection;
                var flag = (last.indexes.indexOf(ind) != -1 ? true : false);
                // clear other if necessary
                if (((!event.ctrlKey && !event.shiftKey && !event.metaKey) || !this.multiSelect) && !this.showSelectColumn) {
                    if (this.selectType != 'row' && $.inArray(column, last.columns[ind]) == -1) flag = false;
                    if (sel.length > 300) this.selectNone(); else this.unselect.apply(this, sel);
                    if (flag === true) {
                        this.unselect({ recid: recid, column: column });
                    } else {
                        this.select({ recid: recid, column: column });
                    }
                } else {
                    if (this.selectType != 'row' && $.inArray(column, last.columns[ind]) == -1) flag = false;
                    if (flag === true) {
                        this.unselect({ recid: recid, column: column });
                    } else {
                        this.select({ recid: recid, column: column });
                    }
                }
            }
            this.status();
            obj.initResize();
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        columnClick: function (field, event) {
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'columnClick', target: this.name, field: field, originalEvent: event });
            if (eventData.isCancelled === true) return;
            // default behaviour
            var column = this.getColumn(field);
            if (column.sortable) this.sort(field, null, (event && (event.ctrlKey || event.metaKey) ? true : false) );
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        keydown: function (event) {
            // this method is called from w2utils
            var obj = this;
            if (obj.keyboard !== true) return;
            // trigger event
            var eventData = obj.trigger({ phase: 'before', type: 'keydown', target: obj.name, originalEvent: event });
            if (eventData.isCancelled === true) return;
            // default behavior
            var empty   = false;
            var records = $('#grid_'+ obj.name +'_records');
            var sel     = obj.getSelection();
            if (sel.length == 0) empty = true;
            var recid   = sel[0] || null;
            var columns = [];
            var recid2  = sel[sel.length-1];
            if (typeof recid == 'object' && recid != null) {
                recid   = sel[0].recid;
                columns = [];
                var ii  = 0;
                while (true) {
                    if (!sel[ii] || sel[ii].recid != recid) break;
                    columns.push(sel[ii].column);
                    ii++;
                }
                recid2  = sel[sel.length-1].recid;
            }
            var ind    = obj.get(recid, true);
            var ind2   = obj.get(recid2, true);
            var rec    = obj.get(recid);
            var recEL  = $('#grid_'+ obj.name +'_rec_'+ (ind !== null ? w2utils.escapeId(obj.records[ind].recid) : 'none'));
            var cancel = false;
            var key    = event.keyCode;
            var shiftKey= event.shiftKey;
            if (key == 9) { // tab key
                if (event.shiftKey) key = 37; else key = 39; // replace with arrows
                shiftKey = false;
                cancel   = true;
            }
            switch (key) {
                case 8:  // backspace
                case 46: // delete
                    if (this.show.toolbarDelete) obj["delete"]();
                    cancel = true;
                    event.stopPropagation();
                    break;

                case 27: // escape
                    obj.selectNone();
                    if (sel.length > 0 && typeof sel[0] == 'object') {
                        obj.select({ recid: sel[0].recid, column: sel[0].column });
                    }
                    cancel = true;
                    break;

                case 65: // cmd + A
                    if (!event.metaKey && !event.ctrlKey) break;
                    obj.selectAll();
                    cancel = true;
                    break;

                case 70: // cmd + F
                    if (!event.metaKey && !event.ctrlKey) break;
                    $('#grid_'+ obj.name + '_search_all').focus();
                    cancel = true;
                    break;

                case 13: // enter
                    // if expandable columns - expand it
                    if (this.selectType == 'row' && obj.show.expandColumn === true) {
                        if (recEL.length <= 0) break;
                        obj.toggle(recid, event);
                        cancel = true;
                    } else { // or enter edit
                        for (var c in this.columns) {
                            if (this.columns[c].editable) {
                                columns.push(parseInt(c));
                                break;
                            }
                        }
                        // edit last column that was edited
                        if (this.selectType == 'row' && this.last.edit_col) columns = [this.last.edit_col];
                        if (columns.length > 0) {
                            obj.editField(recid, columns[0], null, event);
                            cancel = true;
                        }
                    }
                    break;

                case 37: // left
                    if (empty) break;
                    // check if this is subgrid
                    var parent = $('#grid_'+ this.name +'_rec_'+ w2utils.escapeId(obj.records[ind].recid)).parents('tr');
                    if (parent.length > 0 && String(parent.attr('id')).indexOf('expanded_row') != -1) {
                        var recid = parent.prev().attr('recid');
                        var grid  = parent.parents('.w2ui-grid').attr('name');
                        obj.selectNone();
                        w2utils.keyboard.active(grid);
                        w2ui[grid].set(recid, { expanded: false });
                        w2ui[grid].collapse(recid);
                        w2ui[grid].click(recid);
                        cancel = true;
                        break;
                    }
                    if (this.selectType == 'row') {
                        if (recEL.length <= 0 || rec.expanded !== true ) break;
                        obj.set(recid, { expanded: false }, true);
                        obj.collapse(recid, event);
                    } else {
                        var prev = obj.prevCell(columns[0]);
                        if (prev != null) {
                            if (shiftKey && obj.multiSelect) {
                                if (tmpUnselect()) return;
                                var tmp    = [];
                                var newSel = [];
                                var unSel  = [];
                                if (columns.indexOf(this.last.sel_col) == 0 && columns.length > 1) {
                                    for (var i in sel) {
                                        if (tmp.indexOf(sel[i].recid) == -1) tmp.push(sel[i].recid);
                                        unSel.push({ recid: sel[i].recid, column: columns[columns.length-1] });
                                    }
                                } else {
                                    for (var i in sel) {
                                        if (tmp.indexOf(sel[i].recid) == -1) tmp.push(sel[i].recid);
                                        newSel.push({ recid: sel[i].recid, column: prev });
                                    }
                                }
                                obj.unselect.apply(obj, unSel);
                                obj.select.apply(obj, newSel);
                            } else {
                                event.shiftKey = false;
                                obj.click({ recid: recid, column: prev }, event);
                            }
                        } else {
                            // if selected more then one, then select first
                            if (!shiftKey) {
                                for (var s=1; s<sel.length; s++) obj.unselect(sel[s]);
                            }
                        }
                    }
                    cancel = true;
                    break;

                case 39: // right
                    if (empty) break;
                    if (this.selectType == 'row') {
                        if (recEL.length <= 0 || rec.expanded === true || obj.show.expandColumn !== true) break;
                        obj.expand(recid, event);
                    } else {
                        var next = obj.nextCell(columns[columns.length-1]);
                        if (next !== null) {
                            if (shiftKey && key == 39 && obj.multiSelect) {
                                if (tmpUnselect()) return;
                                var tmp    = [];
                                var newSel = [];
                                var unSel  = [];
                                if (columns.indexOf(this.last.sel_col) == columns.length-1 && columns.length > 1) {
                                    for (var i in sel) {
                                        if (tmp.indexOf(sel[i].recid) == -1) tmp.push(sel[i].recid);
                                        unSel.push({ recid: sel[i].recid, column: columns[0] });
                                    }
                                } else {
                                    for (var i in sel) {
                                        if (tmp.indexOf(sel[i].recid) == -1) tmp.push(sel[i].recid);
                                        newSel.push({ recid: sel[i].recid, column: next });
                                    }
                                }
                                obj.unselect.apply(obj, unSel);
                                obj.select.apply(obj, newSel);
                            } else {
                                obj.click({ recid: recid, column: next }, event);
                            }
                        } else {
                            // if selected more then one, then select first
                            if (!shiftKey) {
                                for (var s=0; s<sel.length-1; s++) obj.unselect(sel[s]);
                            }
                        }
                    }
                    cancel = true;
                    break;

                case 38: // up
                    if (empty) selectTopRecord();
                    if (recEL.length <= 0) break;
                    // move to the previous record
                    var prev = obj.prevRow(ind);
                    if (prev != null) {
                        // jump into subgrid
                        if (obj.records[prev].expanded) {
                            var subgrid = $('#grid_'+ obj.name +'_rec_'+ w2utils.escapeId(obj.records[prev].recid) +'_expanded_row').find('.w2ui-grid');
                            if (subgrid.length > 0 && w2ui[subgrid.attr('name')]) {
                                obj.selectNone();
                                var grid = subgrid.attr('name');
                                var recs = w2ui[grid].records;
                                w2utils.keyboard.active(grid);
                                w2ui[grid].click(recs[recs.length-1].recid);
                                cancel = true;
                                break;
                            }
                        }
                        if (shiftKey && obj.multiSelect) { // expand selection
                            if (tmpUnselect()) return;
                            if (obj.selectType == 'row') {
                                if (obj.last.sel_ind > prev && obj.last.sel_ind != ind2) {
                                    obj.unselect(obj.records[ind2].recid);
                                } else {
                                    obj.select(obj.records[prev].recid);
                                }
                            } else {
                                if (obj.last.sel_ind > prev && obj.last.sel_ind != ind2) {
                                    prev = ind2;
                                    var tmp = [];
                                    for (var c in columns) tmp.push({ recid: obj.records[prev].recid, column: columns[c] });
                                    obj.unselect.apply(obj, tmp);
                                } else {
                                    var tmp = [];
                                    for (var c in columns) tmp.push({ recid: obj.records[prev].recid, column: columns[c] });
                                    obj.select.apply(obj, tmp);
                                }
                            }
                        } else { // move selected record
                            obj.selectNone();
                            obj.click({ recid: obj.records[prev].recid, column: columns[0] }, event);
                        }
                        obj.scrollIntoView(prev);
                        if (event.preventDefault) event.preventDefault();
                    } else {
                        // if selected more then one, then select first
                        if (!shiftKey) {
                            for (var s=1; s<sel.length; s++) obj.unselect(sel[s]);
                        }
                        // jump out of subgird (if first record)
                        var parent = $('#grid_'+ obj.name +'_rec_'+ w2utils.escapeId(obj.records[ind].recid)).parents('tr');
                        if (parent.length > 0 && String(parent.attr('id')).indexOf('expanded_row') != -1) {
                            var recid = parent.prev().attr('recid');
                            var grid  = parent.parents('.w2ui-grid').attr('name');
                            obj.selectNone();
                            w2utils.keyboard.active(grid);
                            w2ui[grid].click(recid);
                            cancel = true;
                            break;
                        }
                    }
                    break;

                case 40: // down
                    if (empty) selectTopRecord();
                    if (recEL.length <= 0) break;
                    // jump into subgrid
                    if (obj.records[ind2].expanded) {
                        var subgrid = $('#grid_'+ this.name +'_rec_'+ w2utils.escapeId(obj.records[ind2].recid) +'_expanded_row').find('.w2ui-grid');
                        if (subgrid.length > 0 && w2ui[subgrid.attr('name')]) {
                            obj.selectNone();
                            var grid = subgrid.attr('name');
                            var recs = w2ui[grid].records;
                            w2utils.keyboard.active(grid);
                            w2ui[grid].click(recs[0].recid);
                            cancel = true;
                            break;
                        }
                    }
                    // move to the next record
                    var next = obj.nextRow(ind2);
                    if (next != null) {
                        if (shiftKey && obj.multiSelect) { // expand selection
                            if (tmpUnselect()) return;
                            if (obj.selectType == 'row') {
                                if (this.last.sel_ind < next && this.last.sel_ind != ind) {
                                    obj.unselect(obj.records[ind].recid);
                                } else {
                                    obj.select(obj.records[next].recid);
                                }
                            } else {
                                if (this.last.sel_ind < next && this.last.sel_ind != ind) {
                                    next = ind;
                                    var tmp = [];
                                    for (var c in columns) tmp.push({ recid: obj.records[next].recid, column: columns[c] });
                                    obj.unselect.apply(obj, tmp);
                                } else {
                                    var tmp = [];
                                    for (var c in columns) tmp.push({ recid: obj.records[next].recid, column: columns[c] });
                                    obj.select.apply(obj, tmp);
                                }
                            }
                        } else { // move selected record
                            obj.selectNone();
                            obj.click({ recid: obj.records[next].recid, column: columns[0] }, event);
                        }
                        obj.scrollIntoView(next);
                        cancel = true;
                    } else {
                        // if selected more then one, then select first
                        if (!shiftKey) {
                            for (var s=0; s<sel.length-1; s++) obj.unselect(sel[s]);
                        }
                        // jump out of subgrid (if last record in subgrid)
                        var parent = $('#grid_'+ this.name +'_rec_'+ w2utils.escapeId(obj.records[ind2].recid)).parents('tr');
                        if (parent.length > 0 && String(parent.attr('id')).indexOf('expanded_row') != -1) {
                            var recid = parent.next().attr('recid');
                            var grid  = parent.parents('.w2ui-grid').attr('name');
                            obj.selectNone();
                            w2utils.keyboard.active(grid);
                            w2ui[grid].click(recid);
                            cancel = true;
                            break;
                        }
                    }
                    break;

                // copy & paste

                case 17: // ctrl key
                case 91: // cmd key
                    if (empty) break;
                    var text = obj.copy();
                    $('body').append('<textarea id="_tmp_copy_data" '+
                        '   onpaste="var obj = this; setTimeout(function () { w2ui[\''+ obj.name + '\'].paste(obj.value); }, 1);" '+
                        '   onkeydown="w2ui[\''+ obj.name +'\'].keydown(event)"'+
                        '   style="position: absolute; top: -100px; height: 1px; width: 1px">'+ text +'</textarea>');
                    $('#_tmp_copy_data').focus().select();
                    // remove _tmp_copy_data textarea
                    $(document).on('keyup', tmp_key_down);
                    function tmp_key_down() { 
                        $('#_tmp_copy_data').remove(); 
                        $(document).off('keyup', tmp_key_down); 
                    }
                    break;

                case 88: // x - cut
                    if (empty) break;
                    if (event.ctrlKey || event.metaKey) {
                        setTimeout(function () { obj["delete"](true); }, 100);
                    }
                    break;
            }
            var tmp = [187, 189, 32]; // =-spacebar
            for (var i=48; i<=90; i++) tmp.push(i); // 0-9,a-z,A-Z
            if (tmp.indexOf(key) != -1 && !event.ctrlKey && !event.metaKey && !cancel) {
                if (columns.length == 0) columns.push(0);
                var tmp = String.fromCharCode(key);
                if (key == 187) tmp = '=';
                if (key == 189) tmp = '-';
                if (!shiftKey)  tmp = tmp.toLowerCase();
                obj.editField(recid, columns[0], tmp, event);
                cancel = true;
            }
            if (cancel) { // cancel default behaviour
                if (event.preventDefault) event.preventDefault();
            }
            // event after
            obj.trigger($.extend(eventData, { phase: 'after' }));

            function selectTopRecord() {
                var ind = Math.floor((records[0].scrollTop + (records.height() / 2.1)) / obj.recordHeight);
                if (!obj.records[ind]) ind = 0;
                obj.select({ recid: obj.records[ind].recid, column: 0});
            }

            function tmpUnselect () {
                if (obj.last.sel_type != 'click') return false;
                if (obj.selectType != 'row') {
                    obj.last.sel_type = 'key';
                    if (sel.length > 1) {
                        for (var s in sel) {
                            if (sel[s].recid == obj.last.sel_recid && sel[s].column == obj.last.sel_col) {
                                sel.splice(s, 1);
                                break;
                            }
                        }
                        obj.unselect.apply(obj, sel);
                        return true;
                    }
                    return false;
                } else {
                    obj.last.sel_type = 'key';
                    if (sel.length > 1) {
                        sel.splice(sel.indexOf(obj.records[obj.last.sel_ind].recid), 1);
                        obj.unselect.apply(obj, sel);
                        return true;
                    }
                    return false;
                }
            }
        },

        scrollIntoView: function (ind) {
            var buffered = this.records.length;
            if (this.searchData.length != 0 && !this.url) buffered = this.last.searchIds.length;
            if (typeof ind == 'undefined') {
                var sel = this.getSelection();
                if (sel.length == 0) return;
                ind = this.get(sel[0], true);
            }
            var records = $('#grid_'+ this.name +'_records');
            if (buffered == 0) return;
            // if all records in view
            var len = this.last.searchIds.length;
            if (records.height() > this.recordHeight * (len > 0 ? len : buffered)) return;
            if (len > 0) ind = this.last.searchIds.indexOf(ind); // if seach is applied
            // scroll to correct one
            var t1 = Math.floor(records[0].scrollTop / this.recordHeight);
            var t2 = t1 + Math.floor(records.height() / this.recordHeight);
            if (ind == t1) records.animate({ 'scrollTop': records.scrollTop() - records.height() / 1.3 }, 250, 'linear');
            if (ind == t2) records.animate({ 'scrollTop': records.scrollTop() + records.height() / 1.3 }, 250, 'linear');
            if (ind < t1 || ind > t2) records.animate({ 'scrollTop': (ind - 1) * this.recordHeight });
        },

        dblClick: function (recid, event) {
            //if (window.getSelection) window.getSelection().removeAllRanges(); // clear selection
            // find columns
            var column = null;
            if (typeof recid == 'object') {
                column = recid.column;
                recid  = recid.recid;
            }
            if (typeof event == 'undefined') event = {};
            // column user clicked on
            if (column == null && event.target) {
                var tmp = event.target;
                if (tmp.tagName != 'TD') tmp = $(tmp).parents('td')[0];
                column = parseInt($(tmp).attr('col'));
            }
            // event before
            var eventData = this.trigger({ phase: 'before', target: this.name, type: 'dblClick', recid: recid, column: column, originalEvent: event });
            if (eventData.isCancelled === true) return;
            // default action
            this.selectNone();
            var col = this.columns[column];
            if (col && $.isPlainObject(col.editable)) {
                this.editField(recid, column, null, event);
            } else {
                this.select({ recid: recid, column: column });
            }
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        contextMenu: function (recid, event) {
            var obj = this;
            if (obj.last.userSelect == 'text') return;
            if (typeof event == 'undefined') event = { offsetX: 0, offsetY: 0, target: $('#grid_'+ obj.name +'_rec_'+ recid)[0] };
            if (typeof event.offsetX === 'undefined') {
                event.offsetX = event.layerX - event.target.offsetLeft;
                event.offsetY = event.layerY - event.target.offsetTop;
            }
            if (w2utils.isFloat(recid)) recid = parseFloat(recid);
            if (this.getSelection().indexOf(recid) == -1) obj.click(recid);
            // need timeout to allow click to finish first
            setTimeout(function () {
                // event before
                var eventData = obj.trigger({ phase: 'before', type: 'contextMenu', target: obj.name, originalEvent: event, recid: recid });
                if (eventData.isCancelled === true) return;
                // default action
                if (obj.menu.length > 0) {
                    $(obj.box).find(event.target)
                        .w2menu(obj.menu, {
                            left    : event.offsetX,
                            onSelect: function (event) { 
                                obj.menuClick(recid, parseInt(event.index), event.originalEvent); 
                            }
                        }
                    );
                }
                // event after
                obj.trigger($.extend(eventData, { phase: 'after' }));
            }, 150); // need timer 150 for FF
            // cancel event
            if (event.preventDefault) event.preventDefault();
        },

        menuClick: function (recid, index, event) {
            var obj = this;
            // event before
            var eventData = obj.trigger({ phase: 'before', type: 'menuClick', target: obj.name, originalEvent: event, 
                recid: recid, menuIndex: index, menuItem: obj.menu[index] });
            if (eventData.isCancelled === true) return;
            // default action
            // -- empty
            // event after
            obj.trigger($.extend(eventData, { phase: 'after' }));
        },

        toggle: function (recid) {
            var rec = this.get(recid);
            if (rec.expanded === true) return this.collapse(recid); else return this.expand(recid);
        },

        expand: function (recid) {
            var rec = this.get(recid);
            var obj = this;
            var id  = w2utils.escapeId(recid);
            if ($('#grid_'+ this.name +'_rec_'+ id +'_expanded_row').length > 0) return false;
            if (rec.expanded == 'none') return false;
            // insert expand row
            var tmp = 1 + (this.show.selectColumn ? 1 : 0);
            var addClass = ''; // ($('#grid_'+this.name +'_rec_'+ w2utils.escapeId(recid)).hasClass('w2ui-odd') ? 'w2ui-odd' : 'w2ui-even');
            $('#grid_'+ this.name +'_rec_'+ id).after(
                    '<tr id="grid_'+ this.name +'_rec_'+ recid +'_expanded_row" class="w2ui-expanded-row '+ addClass +'">'+
                        (this.show.lineNumbers ? '<td class="w2ui-col-number"></td>' : '') +
                    '    <td class="w2ui-grid-data w2ui-expanded1" colspan="'+ tmp +'"><div style="display: none"></div></td>'+
                    '    <td colspan="100" class="w2ui-expanded2">'+
                    '        <div id="grid_'+ this.name +'_rec_'+ recid +'_expanded" style="opacity: 0"></div>'+
                    '    </td>'+
                    '</tr>');
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'expand', target: this.name, recid: recid,
                box_id: 'grid_'+ this.name +'_rec_'+ recid +'_expanded', ready: ready });
            if (eventData.isCancelled === true) {
                $('#grid_'+ this.name +'_rec_'+ id +'_expanded_row').remove();
                return;
            }
            // default action
            $('#grid_'+ this.name +'_rec_'+ id).attr('expanded', 'yes').addClass('w2ui-expanded');
            $('#grid_'+ this.name +'_rec_'+ id +'_expanded_row').show();
            $('#grid_'+ this.name +'_cell_'+ this.get(recid, true) +'_expand div').html('<div class="w2ui-spinner" style="width: 16px; height: 16px; margin: -2px 2px;"></div>');
            rec.expanded = true;
            // check if height of expanded row > 5 then remove spinner
            setTimeout(ready, 300);
            function ready() {
                var div1 = $('#grid_'+ obj.name +'_rec_'+ id +'_expanded');
                var div2 = $('#grid_'+ obj.name +'_rec_'+ id +'_expanded_row .w2ui-expanded1 > div');
                if (div1.height() < 5) return;
                div1.css('opacity', 1);
                div2.show().css('opacity', 1);
                $('#grid_'+ obj.name +'_cell_'+ obj.get(recid, true) +'_expand div').html('-');
            }
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            this.resizeRecords();
            return true;
        },

        collapse: function (recid) {
            var rec = this.get(recid);
            var obj = this;
            var id  = w2utils.escapeId(recid);
            if ($('#grid_'+ this.name +'_rec_'+ id +'_expanded_row').length == 0) return false;
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'collapse', target: this.name, recid: recid,
                box_id: 'grid_'+ this.name +'_rec_'+ id +'_expanded' });
            if (eventData.isCancelled === true) return;
            // default action
            $('#grid_'+ this.name +'_rec_'+ id).removeAttr('expanded').removeClass('w2ui-expanded');
            $('#grid_'+ this.name +'_rec_'+ id +'_expanded').css('opacity', 0);
            $('#grid_'+ this.name +'_cell_'+ this.get(recid, true) +'_expand div').html('+');
            setTimeout(function () {
                $('#grid_'+ obj.name +'_rec_'+ id +'_expanded').height('0px');
                setTimeout(function () {
                    $('#grid_'+ obj.name +'_rec_'+ id +'_expanded_row').remove();
                    delete rec.expanded;
                    // event after
                    obj.trigger($.extend(eventData, { phase: 'after' }));
                    obj.resizeRecords();
                }, 300);
            }, 200);
            return true;
        },

        sort: function (field, direction, multiField) { // if no params - clears sort
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'sort', target: this.name, field: field, direction: direction, multiField: multiField });
            if (eventData.isCancelled === true) return;
            // check if needed to quit
            if (typeof field != 'undefined') {
                // default action
                var sortIndex = this.sortData.length;
                for (var s in this.sortData) {
                    if (this.sortData[s].field == field) { sortIndex = s; break; }
                }
                if (typeof direction == 'undefined' || direction == null) {
                    if (typeof this.sortData[sortIndex] == 'undefined') {
                        direction = 'asc';
                    } else {
                        switch (String(this.sortData[sortIndex].direction)) {
                            case 'asc'  : direction = 'desc'; break;
                            case 'desc' : direction = 'asc';  break;
                            default     : direction = 'asc';  break;
                        }
                    }
                }
                if (this.multiSort === false) { this.sortData = []; sortIndex = 0; }
                if (multiField != true) { this.sortData = []; sortIndex = 0; }
                // set new sort
                if (typeof this.sortData[sortIndex] == 'undefined') this.sortData[sortIndex] = {};
                this.sortData[sortIndex].field        = field;
                this.sortData[sortIndex].direction = direction;
            } else {
                this.sortData = [];
            }
            this.selectNone();
            // if local
            var url = (typeof this.url != 'object' ? this.url : this.url.get);
            if (!url) {
                this.localSort();
                if (this.searchData.length > 0) this.localSearch(true);
                // event after
                this.trigger($.extend(eventData, { phase: 'after' }));
                this.refresh();
            } else {
                // event after
                this.trigger($.extend(eventData, { phase: 'after' }));
                this.last.xhr_offset = 0;
                this.reload();
            }
        },

        copy: function () {
            var sel = this.getSelection();
            if (sel.length == 0) return '';
            var text = '';
            if (typeof sel[0] == 'object') { // cell copy
                // find min/max column
                var minCol = sel[0].column;
                var maxCol = sel[0].column;
                var recs   = [];
                for (var s in sel) {
                    if (sel[s].column < minCol) minCol = sel[s].column;
                    if (sel[s].column > maxCol) maxCol = sel[s].column;
                    if (recs.indexOf(sel[s].index) == -1) recs.push(sel[s].index);
                }
                recs.sort();
                for (var r in recs) {
                    var ind = recs[r];
                    for (var c = minCol; c <= maxCol; c++) {
                        var col = this.columns[c];
                        if (col.hidden === true) continue;
                        text += w2utils.stripTags(this.getCellHTML(ind, c)) + '\t';
                    }
                    text = text.substr(0, text.length-1); // remove last \t
                    text += '\n';
                }
            } else { // row copy
                // copy headers
                for (var c in this.columns) {
                    var col = this.columns[c];
                    if (col.hidden === true) continue;
                    text += '"' + w2utils.stripTags(col.caption ? col.caption : col.field) + '"\t';
                }
                text = text.substr(0, text.length-1); // remove last \t
                text += '\n';
                // copy selected text                
                for (var s in sel) {
                    var ind = this.get(sel[s], true);
                    for (var c in this.columns) {
                        var col = this.columns[c];
                        if (col.hidden === true) continue;
                        text += '"' + w2utils.stripTags(this.getCellHTML(ind, c)) + '"\t';
                    }
                    text = text.substr(0, text.length-1); // remove last \t
                    text += '\n';
                }
            }
            text = text.substr(0, text.length - 1);
            // before event
            var eventData = this.trigger({ phase: 'before', type: 'copy', target: this.name, text: text });
            if (eventData.isCancelled === true) return '';
            text = eventData.text;
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            return text;
        },

        paste: function (text) {
            var sel = this.getSelection();
            var ind = this.get(sel[0].recid, true);
            var col = sel[0].column;
            // before event
            var eventData = this.trigger({ phase: 'before', type: 'paste', target: this.name, text: text, index: ind, column: col });
            if (eventData.isCancelled === true) return;
            text = eventData.text;
            // default action
            if (this.selectType == 'row' || sel.length == 0) {
                console.log('ERROR: You can paste only if grid.selectType = \'cell\' and when at least one cell selected.');
                // event after
                this.trigger($.extend(eventData, { phase: 'after' }));
                return;
            }
            var newSel = [];
            var text   = text.split('\n');
            for (var t in text) {
                var tmp  = text[t].split('\t');
                var cnt  = 0;
                var rec  = this.records[ind];
                var cols = [];
                for (var dt in tmp) {
                    if (!this.columns[col + cnt]) continue;
                    var field = this.columns[col + cnt].field;
                    rec.changes = rec.changes || {};
                    rec.changes[field] = tmp[dt];
                    cols.push(col + cnt);
                    cnt++;
                }
                for (var c in cols) newSel.push({ recid: rec.recid, column: cols[c] });
                ind++;
            }
            this.selectNone();
            this.select.apply(this, newSel);
            this.refresh();
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        // ==================================================
        // --- Common functions

        resize: function () {
            var obj  = this;
            var time = (new Date()).getTime();
            //if (window.getSelection) window.getSelection().removeAllRanges(); // clear selection
            // make sure the box is right
            if (!this.box || $(this.box).attr('name') != this.name) return;
            // determine new width and height
            $(this.box).find('> div')
                .css('width', $(this.box).width())
                .css('height', $(this.box).height());
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'resize', target: this.name });
            if (eventData.isCancelled === true) return;
            // resize
            obj.resizeBoxes();
            obj.resizeRecords();
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            return (new Date()).getTime() - time;
        },

        refreshCell: function (recid, field) {
            var index     = this.get(recid, true);
            var isSummary = (this.records[index] && this.records[index].recid == recid ? false : true);
            var col_ind   = this.getColumn(field, true);
            var rec       = (isSummary ? this.summary[index] : this.records[index]);
            var col       = this.columns[col_ind];
            var cell      = $('#grid_'+ this.name + '_rec_'+ recid +' [col='+ col_ind +']');
            // set cell html and changed flag
            cell.html(this.getCellHTML(index, col_ind, isSummary));
            if (rec.changes && typeof rec.changes[col.field] != 'undefined') {
                cell.addClass('w2ui-changed');
            } else {
                cell.removeClass('w2ui-changed');
            }
        },

        refreshRow: function (recid) {
            var tr = $('#grid_'+ this.name +'_rec_'+ w2utils.escapeId(recid));
            if (tr.length != 0) {
                var ind  = this.get(recid, true);
                var line = tr.attr('line');
                var isSummary = (this.records[ind] && this.records[ind].recid == recid ? false : true);
                // if it is searched, find index in search array
                var url = (typeof this.url != 'object' ? this.url : this.url.get);
                if (this.searchData.length > 0 && !url) for (var s in this.last.searchIds) if (this.last.searchIds[s] == ind) ind = s;
                $(tr).replaceWith(this.getRecordHTML(ind, line, isSummary));
                if (isSummary) this.resize();
            }
        },

        refresh: function () {
            var obj  = this;
            var time = (new Date()).getTime();
            var url = (typeof this.url != 'object' ? this.url : this.url.get);
            if (this.total <= 0 && !url && this.searchData.length == 0) {
                this.total = this.records.length;
            }
            //if (window.getSelection) window.getSelection().removeAllRanges(); // clear selection
            this.toolbar.disable('w2ui-edit', 'w2ui-delete');
            if (!this.box) return;
            // event before
            var eventData = this.trigger({ phase: 'before', target: this.name, type: 'refresh' });
            if (eventData.isCancelled === true) return;
            // -- header
            if (this.show.header) {
                $('#grid_'+ this.name +'_header').html(this.header +'&nbsp;').show();
            } else {
                $('#grid_'+ this.name +'_header').hide();
            }
            // -- toolbar
            if (this.show.toolbar) {
                // if select-collumn is checked - no toolbar refresh
                if (this.toolbar && this.toolbar.get('w2ui-column-on-off') && this.toolbar.get('w2ui-column-on-off').checked) {
                    // no action
                } else {
                    $('#grid_'+ this.name +'_toolbar').show();
                    // refresh toolbar all but search field
                    if (typeof this.toolbar == 'object') {
                        var tmp = this.toolbar.items;
                        for (var t in tmp) {
                            if (tmp[t].id == 'w2ui-search' || tmp[t].type == 'break') continue;
                            this.toolbar.refresh(tmp[t].id);
                        }
                    }
                }
            } else {
                $('#grid_'+ this.name +'_toolbar').hide();
            }
            // -- make sure search is closed
            this.searchClose();
            // search placeholder
            var el = $('#grid_'+ obj.name +'_search_all');
            if (!this.multiSearch && this.last.field == 'all' && this.searches.length > 0) {
                this.last.field   = this.searches[0].field;
                this.last.caption = this.searches[0].caption;
            }
            for (var s in this.searches) {
                if (this.searches[s].field == this.last.field) this.last.caption = this.searches[s].caption;
            }
            if (this.last.multi) {
                el.attr('placeholder', '[' + w2utils.lang('Multiple Fields') + ']');
            } else {
                el.attr('placeholder', this.last.caption);
            }
            if (el.val() != this.last.search) {
                var val = this.last.search;
                var tmp = el.data('w2field');
                if (tmp) val = tmp.format(val);
                el.val(val);
            }

            // -- separate summary
            var tmp = this.find({ summary: true }, true);
            if (tmp.length > 0) {
                for (var t in tmp) this.summary.push(this.records[tmp[t]]);
                for (var t=tmp.length-1; t>=0; t--) this.records.splice(tmp[t], 1);
                this.total = this.total - tmp.length;
            }

            // -- body
            var bodyHTML = '';
            bodyHTML +=  '<div id="grid_'+ this.name +'_records" class="w2ui-grid-records"'+
                        '    onscroll="var obj = w2ui[\''+ this.name + '\']; '+
                        '        obj.last.scrollTop = this.scrollTop; '+
                        '        obj.last.scrollLeft = this.scrollLeft; '+
                        '        $(\'#grid_'+ this.name +'_columns\')[0].scrollLeft = this.scrollLeft;'+
                        '        $(\'#grid_'+ this.name +'_summary\')[0].scrollLeft = this.scrollLeft;'+
                        '        obj.scroll(event);">'+
                            this.getRecordsHTML() +
                        '</div>'+
                        '<div id="grid_'+ this.name +'_columns" class="w2ui-grid-columns">'+
                        '    <table>'+ this.getColumnsHTML() +'</table>'+
                        '</div>'; // Columns need to be after to be able to overlap
            $('#grid_'+ this.name +'_body').html(bodyHTML);
            // show summary records
            if (this.summary.length > 0) {
                $('#grid_'+ this.name +'_summary').html(this.getSummaryHTML()).show();
            } else {
                $('#grid_'+ this.name +'_summary').hide();
            }
            // -- footer
            if (this.show.footer) {
                $('#grid_'+ this.name +'_footer').html(this.getFooterHTML()).show();
            } else {
                $('#grid_'+ this.name +'_footer').hide();
            }
            // show/hide clear search link
             if (this.searchData.length > 0) {
                $('#grid_'+ this.name +'_searchClear').show();
            } else {
                $('#grid_'+ this.name +'_searchClear').hide();
            }
            // all selected?
            var sel = this.last.selection;
            if (sel.indexes.length == this.records.length || (this.searchData.length !== 0 && sel.indexes.length == this.last.searchIds.length)) {
                $('#grid_'+ this.name +'_check_all').prop('checked', true);
            } else {
                $('#grid_'+ this.name +'_check_all').prop('checked', false);
            }
            // show number of selected
            this.status();
            // collapse all records
            var rows = obj.find({ expanded: true }, true);
            for (var r in rows) obj.records[rows[r]].expanded = false;
            // mark selection
            setTimeout(function () {
                var str  = $.trim($('#grid_'+ obj.name +'_search_all').val());
                if (str != '') $(obj.box).find('.w2ui-grid-data > div').w2marker(str);
            }, 50);
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            obj.resize();
            obj.addRange('selection');
            setTimeout(function () { obj.resize(); obj.scroll(); }, 1); // allow to render first

            if ( obj.reorderColumns && !obj.last.columnDrag ) {
                obj.last.columnDrag = obj.initColumnDrag();
            } else if ( !obj.reorderColumns && obj.last.columnDrag ) {
                obj.last.columnDrag.remove();
            }

            return (new Date()).getTime() - time;
        },

        render: function (box) {
            var obj  = this;
            var time = (new Date()).getTime();
            //if (window.getSelection) window.getSelection().removeAllRanges(); // clear selection
            if (typeof box != 'undefined' && box != null) {
                if ($(this.box).find('#grid_'+ this.name +'_body').length > 0) {
                    $(this.box)
                        .removeAttr('name')
                        .removeClass('w2ui-reset w2ui-grid')
                        .html('');
                }
                this.box = box;
            }
            if (!this.box) return;
            if (this.last.sortData == null) this.last.sortData = this.sortData;
            // event before
            var eventData = this.trigger({ phase: 'before', target: this.name, type: 'render', box: box });
            if (eventData.isCancelled === true) return;
            // insert Elements
            $(this.box)
                .attr('name', this.name)
                .addClass('w2ui-reset w2ui-grid')
                .html('<div>'+
                      '    <div id="grid_'+ this.name +'_header" class="w2ui-grid-header"></div>'+
                      '    <div id="grid_'+ this.name +'_toolbar" class="w2ui-grid-toolbar"></div>'+
                      '    <div id="grid_'+ this.name +'_body" class="w2ui-grid-body"></div>'+
                      '    <div id="grid_'+ this.name +'_summary" class="w2ui-grid-body w2ui-grid-summary"></div>'+
                      '    <div id="grid_'+ this.name +'_footer" class="w2ui-grid-footer"></div>'+
                      '</div>');
            if (this.selectType != 'row') $(this.box).addClass('w2ui-ss');
            if ($(this.box).length > 0) $(this.box)[0].style.cssText += this.style;
            // init toolbar
            this.initToolbar();
            if (this.toolbar != null) this.toolbar.render($('#grid_'+ this.name +'_toolbar')[0]);
            // reinit search_all
            if (this.last.field && this.last.field != 'all') {
                var sd = this.searchData;
                this.initAllField(this.last.field, (sd.length == 1 ? sd[0].value : null));
            }
            // init footer
            $('#grid_'+ this.name +'_footer').html(this.getFooterHTML());            
            // refresh
            if (!this.last.state) this.last.state = this.stateSave(true); // initial default state
            this.stateRestore();
            if (this.url) this.refresh(); // show empty grid (need it) - should it be only for remote data source
            this.reload();

            // init mouse events for mouse selection
            $(this.box).on('mousedown', mouseStart);
            $(this.box).on('selectstart', function () { return false; }); // fixes chrome cursor bug

            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            // attach to resize event
            if ($('.w2ui-layout').length == 0) { // if there is layout, it will send a resize event
                this.tmp_resize = function (event) { w2ui[obj.name].resize(); }
                $(window).off('resize', this.tmp_resize).on('resize', this.tmp_resize);
            }
            return (new Date()).getTime() - time;

            function mouseStart (event) {
                if (event.which != 1) return; // if not left mouse button
                // restore css user-select
                if (obj.last.userSelect == 'text') {
                    delete obj.last.userSelect;
                    $(obj.box).find('.w2ui-grid-body')
                        .css('user-select', 'none')
                        .css('-webkit-user-select', 'none')
                        .css('-moz-user-select', 'none')
                        .css('-ms-user-select', 'none');
                    $(this.box).on('selectstart', function () { return false; });
                }
                // regular record select
                if ($(event.target).parents().hasClass('w2ui-head') || $(event.target).hasClass('w2ui-head')) return;
                if (obj.last.move && obj.last.move.type == 'expand') return;
                // if altKey - alow text selection
                if (event.altKey) {
                    $(obj.box).off('selectstart');
                    $(obj.box).find('.w2ui-grid-body')
                        .css('user-select', 'text')
                        .css('-webkit-user-select', 'text')
                        .css('-moz-user-select', 'text')
                        .css('-ms-user-select', 'text');
                    obj.selectNone();
                    obj.last.move       = { type: 'text-select' };
                    obj.last.userSelect = 'text';
                } else {
                    if (!obj.multiSelect) return;
                    obj.last.move = {
                        x      : event.screenX,
                        y      : event.screenY,
                        divX   : 0,
                        divY   : 0,
                        recid  : $(event.target).parents('tr').attr('recid'),
                        column : (event.target.tagName == 'TD' ? $(event.target).attr('col') : $(event.target).parents('td').attr('col')),
                        type   : 'select',
                        ghost  : false,
                        start  : true
                    };
                }
                $(document).on('mousemove', mouseMove);
                $(document).on('mouseup', mouseStop);
            }

            function mouseMove (event) {
                var mv = obj.last.move;
                if (!mv || mv.type != 'select') return;
                mv.divX = (event.screenX - mv.x);
                mv.divY = (event.screenY - mv.y);
                if (Math.abs(mv.divX) <= 1 && Math.abs(mv.divY) <= 1) return; // only if moved more then 1px
                obj.last.cancelClick = true;
                if (obj.reorderRows == true) {
                    if (!mv.ghost) {
                        var row    = $('#grid_'+ obj.name + '_rec_'+ mv.recid);
                        var tmp    = row.parents('table').find('tr:first-child').clone();
                        mv.offsetY = event.offsetY;
                        mv.from    = mv.recid;
                        mv.pos     = row.position();
                        mv.ghost   = $(row).clone(true);
                        mv.ghost.removeAttr('id');
                        row.find('td:first-child').replaceWith('<td colspan="1000" style="height: '+ obj.recordHeight +'px; background-color: #ddd"></td>');
                        var recs = $(obj.box).find('.w2ui-grid-records');
                        recs.append('<table id="grid_'+ obj.name + '_ghost" style="position: absolute; z-index: 999999; opacity: 0.8; border-bottom: 2px dashed #aaa; border-top: 2px dashed #aaa; pointer-events: none;"></table>');
                        $('#grid_'+ obj.name + '_ghost').append(tmp).append(mv.ghost);
                    }
                    var recid = $(event.target).parents('tr').attr('recid');
                    if (recid != mv.from) {
                        var row1 = $('#grid_'+ obj.name + '_rec_'+ mv.recid);
                        var row2 = $('#grid_'+ obj.name + '_rec_'+ recid);
                        if (event.screenY - mv.lastY < 0) row1.after(row2); else row2.after(row1);
                        mv.lastY = event.screenY;
                        mv.to      = recid;
                    }
                    var ghost = $('#grid_'+ obj.name + '_ghost');
                    var recs  = $(obj.box).find('.w2ui-grid-records');
                    ghost.css({
                        top     : mv.pos.top + mv.divY + recs.scrollTop(), // + mv.offsetY - obj.recordHeight / 2,
                        left : mv.pos.left
                    });
                    return;
                }
                if (mv.start && mv.recid) {
                    obj.selectNone();
                    mv.start = false;
                }
                var newSel= [];
                var recid = (event.target.tagName == 'TR' ? $(event.target).attr('recid') : $(event.target).parents('tr').attr('recid'));
                if (typeof recid == 'undefined') return;
                var ind1  = obj.get(mv.recid, true);
                // |:wolfmanx:| this happens when selection is started on summary row
                if (ind1 === null) return;
                var ind2  = obj.get(recid, true);
                // this happens when selection is extended into summary row (a good place to implement scrolling)
                if (ind2 === null) return;
                var col1 = parseInt(mv.column);
                var col2 = parseInt(event.target.tagName == 'TD' ? $(event.target).attr('col') : $(event.target).parents('td').attr('col'));
                if (ind1 > ind2) { var tmp = ind1; ind1 = ind2; ind2 = tmp; }
                // check if need to refresh
                var tmp = 'ind1:'+ ind1 +',ind2;'+ ind2 +',col1:'+ col1 +',col2:'+ col2;
                if (mv.range == tmp) return;
                mv.range = tmp;
                for (var i = ind1; i <= ind2; i++) {
                    if (obj.last.searchIds.length > 0 && obj.last.searchIds.indexOf(i) == -1) continue;
                    if (obj.selectType != 'row') {
                        if (col1 > col2) { var tmp = col1; col1 = col2; col2 = tmp; }
                        var tmp = [];
                        for (var c = col1; c <= col2; c++) {
                            if (obj.columns[c].hidden) continue;
                            newSel.push({ recid: obj.records[i].recid, column: parseInt(c) });
                        }
                    } else {
                        newSel.push(obj.records[i].recid);
                    }
                }
                if (obj.selectType != 'row') {
                    var sel = obj.getSelection();
                    // add more items
                    var tmp = [];
                    for (var ns in newSel) {
                        var flag = false;
                        for (var s in sel) if (newSel[ns].recid == sel[s].recid && newSel[ns].column == sel[s].column) flag = true;
                        if (!flag) tmp.push({ recid: newSel[ns].recid, column: newSel[ns].column });
                    }
                    obj.select.apply(obj, tmp);
                    // remove items
                    var tmp = [];
                    for (var s in sel) {
                        var flag = false;
                        for (var ns in newSel) if (newSel[ns].recid == sel[s].recid && newSel[ns].column == sel[s].column) flag = true;
                        if (!flag) tmp.push({ recid: sel[s].recid, column: sel[s].column });
                    }
                    obj.unselect.apply(obj, tmp);
                } else {
                    if (obj.multiSelect) {
                        var sel = obj.getSelection();
                        for (var ns in newSel) if (sel.indexOf(newSel[ns]) == -1) obj.select(newSel[ns]); // add more items
                        for (var s in sel) if (newSel.indexOf(sel[s]) == -1) obj.unselect(sel[s]); // remove items
                    }
                }
            }

            function mouseStop (event) {
                var mv = obj.last.move;
                setTimeout(function () { delete obj.last.cancelClick; }, 1);
                if ($(event.target).parents().hasClass('.w2ui-head') || $(event.target).hasClass('.w2ui-head')) return;
                if (mv && mv.type == 'select') {
                    if (obj.reorderRows == true) {
                        var ind1 = obj.get(mv.from, true);
                        var tmp  = obj.records[ind1];
                        obj.records.splice(ind1, 1);
                        var ind2 = obj.get(mv.to, true);
                        if (ind1 > ind2) obj.records.splice(ind2, 0, tmp); else obj.records.splice(ind2+1, 0, tmp);
                        $('#grid_'+ obj.name + '_ghost').remove();
                        obj.refresh();
                    }
                }
                delete obj.last.move;
                $(document).off('mousemove', mouseMove);
                $(document).off('mouseup', mouseStop);
            }
        },

        destroy: function () {
            // event before
            var eventData = this.trigger({ phase: 'before', target: this.name, type: 'destroy' });
            if (eventData.isCancelled === true) return;
            // remove events
            $(window).off('resize', this.tmp_resize);
            // clean up
            if (typeof this.toolbar == 'object' && this.toolbar.destroy) this.toolbar.destroy();
            if ($(this.box).find('#grid_'+ this.name +'_body').length > 0) {
                $(this.box)
                    .removeAttr('name')
                    .removeClass('w2ui-reset w2ui-grid')
                    .html('');
            }
            delete w2ui[this.name];
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        // ===========================================
        // --- Internal Functions

        initColumnOnOff: function () {
            if (!this.show.toolbarColumns) return;
            var obj = this;
            var col_html =  '<div class="w2ui-col-on-off">'+
                            '<table><tr>'+
                            '<td style="width: 30px">'+
                            '    <input id="grid_'+ this.name +'_column_ln_check" type="checkbox" tabIndex="-1" '+ (obj.show.lineNumbers ? 'checked' : '') +
                            '        onclick="w2ui[\''+ obj.name +'\'].columnOnOff(this, event, \'line-numbers\');">'+
                            '</td>'+
                            '<td onclick="w2ui[\''+ obj.name +'\'].columnOnOff(this, event, \'line-numbers\'); $(\'#w2ui-overlay\')[0].hide();">'+
                            '    <label for="grid_'+ this.name +'_column_ln_check">'+ w2utils.lang('Line #') +'</label>'+
                            '</td></tr>';
            for (var c in this.columns) {
                var col = this.columns[c];
                var tmp = this.columns[c].caption;
                if (col.hideable === false) continue;
                if (!tmp && this.columns[c].hint) tmp = this.columns[c].hint;
                if (!tmp) tmp = '- column '+ (parseInt(c) + 1) +' -';
                col_html += '<tr>'+
                    '<td style="width: 30px">'+
                    '    <input id="grid_'+ this.name +'_column_'+ c +'_check" type="checkbox" tabIndex="-1" '+ (col.hidden ? '' : 'checked') +
                    '        onclick="w2ui[\''+ obj.name +'\'].columnOnOff(this, event, \''+ col.field +'\');">'+
                    '</td>'+
                    '<td>'+
                    '    <label for="grid_'+ this.name +'_column_'+ c +'_check">'+ tmp +    '</label>'+
                    '</td>'+
                    '</tr>';
            }
            col_html += '<tr><td colspan="2"><div style="border-top: 1px solid #ddd;"></div></td></tr>';
            var url = (typeof this.url != 'object' ? this.url : this.url.get);
            if (url && obj.show.skipRecords) {
                col_html +=
                        '<tr><td colspan="2" style="padding: 0px">'+
                        '    <div style="cursor: pointer; padding: 2px 8px; cursor: default">'+ w2utils.lang('Skip') +
                        '        <input type="text" style="width: 45px" value="'+ this.offset +'" '+
                        '            onkeypress="if (event.keyCode == 13) { '+
                        '               w2ui[\''+ obj.name +'\'].skip(this.value); '+
                        '               $(\'#w2ui-overlay\')[0].hide(); '+
                        '            }"> '+ w2utils.lang('Records')+
                        '    </div>'+
                        '</td></tr>';
            }
            col_html += '<tr><td colspan="2" onclick="w2ui[\''+ obj.name +'\'].stateSave(); $(\'#w2ui-overlay\')[0].hide();">'+
                        '    <div style="cursor: pointer; padding: 4px 8px; cursor: default">'+ w2utils.lang('Save Grid State') + '</div>'+
                        '</td></tr>'+
                        '<tr><td colspan="2" onclick="w2ui[\''+ obj.name +'\'].stateReset(); $(\'#w2ui-overlay\')[0].hide();">'+
                        '    <div style="cursor: pointer; padding: 4px 8px; cursor: default">'+ w2utils.lang('Restore Default State') + '</div>'+
                        '</td></tr>';
            col_html += "</table></div>";
            this.toolbar.get('w2ui-column-on-off').html = col_html;
        },

        /**
         *
         * @param box, grid object
         * @returns {{remove: Function}} contains a closure around all events to ensure they are removed from the dom
         */
        initColumnDrag: function ( box ) {
            //throw error if using column groups
            if ( this.columnGroups && this.columnGroups.length ) throw 'Draggable columns are not currently supported with column groups.';

            var obj = this,
                _dragData = {};
                _dragData.lastInt = null;
                _dragData.pressed = false;
                _dragData.timeout = null;_dragData.columnHead = null;

            //attach orginal event listener
            $(obj.box).on('mousedown', dragColStart);
            $(obj.box).on('mouseup', catchMouseup);

            function catchMouseup(){
                _dragData.pressed = false;
                clearTimeout( _dragData.timeout );
            }
            /**
             *
             * @param event, mousedown
             * @returns {boolean} false, preventsDefault
             */
            function dragColStart ( event ) {
                if ( _dragData.timeout ) clearTimeout( _dragData.timeout );
                var self = this;
                _dragData.pressed = true;

                _dragData.timeout = setTimeout(function(){
                    if ( !_dragData.pressed ) return;

                    var eventData,
                        columns,
                        selectedCol,
                        origColumn,
                        origColumnNumber,
                        invalidPreColumns = [ 'w2ui-col-number', 'w2ui-col-expand', 'w2ui-col-select' ],
                        invalidPostColumns = [ 'w2ui-head-last' ],
                        invalidColumns = invalidPreColumns.concat( invalidPostColumns ),
                        preColumnsSelector = '.w2ui-col-number, .w2ui-col-expand, .w2ui-col-select',
                        preColHeadersSelector = '.w2ui-head.w2ui-col-number, .w2ui-head.w2ui-col-expand, .w2ui-head.w2ui-col-select';

                    // do nothing if it is not a header
                    if ( !$( event.originalEvent.target ).parents().hasClass( 'w2ui-head' ) ) return;

                    // do nothing if it is an invalid column
                    for ( var i = 0, l = invalidColumns.length; i < l; i++ ){
                        if ( $( event.originalEvent.target ).parents().hasClass( invalidColumns[ i ] ) ) return;
                    }

                    _dragData.numberPreColumnsPresent = $( obj.box ).find( preColHeadersSelector ).length;

                    //start event for drag start
                    _dragData.columnHead = origColumn = $( event.originalEvent.target ).parents( '.w2ui-head' );
                    origColumnNumber = parseInt( origColumn.attr( 'col' ), 10);
                    eventData = obj.trigger({ type: 'columnDragStart', phase: 'before', originalEvent: event, origColumnNumber: origColumnNumber, target: origColumn[0] });
                    if ( eventData.isCancelled === true ) return false;

                    columns = _dragData.columns = $( obj.box ).find( '.w2ui-head:not(.w2ui-head-last)' );

                    //add events
                    $( document ).on( 'mouseup', dragColEnd );
                    $( document ).on( 'mousemove', dragColOver );

                    _dragData.originalPos = parseInt( $( event.originalEvent.target ).parent( '.w2ui-head' ).attr( 'col' ), 10 );
                    //_dragData.columns.css({ overflow: 'visible' }).children( 'div' ).css({ overflow: 'visible' });

                    //configure and style ghost image
                    _dragData.ghost = $( self ).clone( true );

                    //hide other elements on ghost except the grid body
                    $( _dragData.ghost ).find( '[col]:not([col="' + _dragData.originalPos + '"]), .w2ui-toolbar, .w2ui-grid-header' ).remove();
                    $( _dragData.ghost ).find( preColumnsSelector ).remove();
                    $( _dragData.ghost ).find( '.w2ui-grid-body' ).css({ top: 0 });

                    selectedCol = $( _dragData.ghost ).find( '[col="' + _dragData.originalPos + '"]' );
                    $( document.body ).append( _dragData.ghost );

                    $( _dragData.ghost ).css({
                        width: 0,
                        height: 0,
                        margin: 0,
                        position: 'fixed',
                        zIndex: 999999,
                        opacity: 0
                    }).addClass( '.w2ui-grid-ghost' ).animate({
                            width: selectedCol.width(),
                            height: $(obj.box).find('.w2ui-grid-body:first').height(),
                            left : event.pageX,
                            top : event.pageY,
                            opacity: .8
                        }, 0 );

                    //establish current offsets
                    _dragData.offsets = [];
                    for ( var i = 0, l = columns.length; i < l; i++ ) {
                        _dragData.offsets.push( $( columns[ i ] ).offset().left );
                    }

                    //conclude event
                    obj.trigger( $.extend( eventData, { phase: 'after' } ) );
                }, 150 );//end timeout wrapper
            }

            function dragColOver ( event ) {
                if ( !_dragData.pressed ) return;

                var cursorX = event.originalEvent.pageX,
                    cursorY = event.originalEvent.pageY,
                    offsets = _dragData.offsets,
                    lastWidth = $( '.w2ui-head:not(.w2ui-head-last)' ).width();

                _dragData.targetInt = Math.max(_dragData.numberPreColumnsPresent,targetIntersection( cursorX, offsets, lastWidth ));

                markIntersection( _dragData.targetInt );
                trackGhost( cursorX, cursorY );
            }

            function dragColEnd ( event ) {
                _dragData.pressed = false;

                var eventData,
                    target,
                    selected,
                    columnConfig,
                    targetColumn,
                    ghosts = $( '.w2ui-grid-ghost' );

                //start event for drag start
                eventData = obj.trigger({ type: 'columnDragEnd', phase: 'before', originalEvent: event, target: _dragData.columnHead[0] });
                if ( eventData.isCancelled === true ) return false;

                selected = obj.columns[ _dragData.originalPos ];
                columnConfig = obj.columns;
                targetColumn =  $( _dragData.columns[ Math.min(_dragData.lastInt, _dragData.columns.length - 1) ] );
                target = (_dragData.lastInt < _dragData.columns.length) ? parseInt(targetColumn.attr('col')) : columnConfig.length;

                if ( target !== _dragData.originalPos + 1 && target !== _dragData.originalPos && targetColumn && targetColumn.length ) {
                    $( _dragData.ghost ).animate({
                        top: $( obj.box ).offset().top,
                        left: targetColumn.offset().left,
                        width: 0,
                        height: 0,
                        opacity:.2
                    }, 300, function(){
                        $( this ).remove();
                        ghosts.remove();
                    });

                    columnConfig.splice( target, 0, $.extend( {}, selected ) );
                    columnConfig.splice( columnConfig.indexOf( selected ), 1);

                } else {
                    $( _dragData.ghost ).remove();
                    ghosts.remove();
                }

                //_dragData.columns.css({ overflow: '' }).children( 'div' ).css({ overflow: '' });

                $( document ).off( 'mouseup', dragColEnd );
                $( document ).off( 'mousemove', dragColOver );
                if ( _dragData.marker ) _dragData.marker.remove();
                _dragData = {};

                obj.refresh();

                //conclude event
                obj.trigger( $.extend( eventData, { phase: 'after', targetColumnNumber: target - 1 } ) );
            }

            function markIntersection( intersection ){
                if ( !_dragData.marker && !_dragData.markerLeft ) {
                    _dragData.marker = $('<div class="col-intersection-marker">' +
                        '<div class="top-marker"></div>' +
                        '<div class="bottom-marker"></div>' +
                        '</div>');
                    _dragData.markerLeft = $('<div class="col-intersection-marker">' +
                        '<div class="top-marker"></div>' +
                        '<div class="bottom-marker"></div>' +
                        '</div>');
                }

                if ( !_dragData.lastInt || _dragData.lastInt !== intersection ){
                    _dragData.lastInt = intersection;
                    _dragData.marker.remove();
                    _dragData.markerLeft.remove();
                    $('.w2ui-head').removeClass('w2ui-col-intersection');

                    //if the current intersection is greater than the number of columns add the marker to the end of the last column only
                    if ( intersection >= _dragData.columns.length ) {
                        $( _dragData.columns[ _dragData.columns.length - 1 ] ).children( 'div:last' ).append( _dragData.marker.addClass( 'right' ).removeClass( 'left' ) );
                        $( _dragData.columns[ _dragData.columns.length - 1 ] ).addClass('w2ui-col-intersection');
                    } else if ( intersection <= _dragData.numberPreColumnsPresent ) {
                        //if the current intersection is on the column numbers place marker on first available column only
                        $( _dragData.columns[ _dragData.numberPreColumnsPresent ] ).prepend( _dragData.marker.addClass( 'left' ).removeClass( 'right' ) ).css({ position: 'relative' });
                        $( _dragData.columns[ _dragData.numberPreColumnsPresent ] ).prev().addClass('w2ui-col-intersection');
                    } else {
                        //otherwise prepend the marker to the targeted column and append it to the previous column
                        $( _dragData.columns[intersection] ).children( 'div:last' ).prepend( _dragData.marker.addClass( 'left' ).removeClass( 'right' ) );
                        $( _dragData.columns[intersection] ).prev().children( 'div:last' ).append( _dragData.markerLeft.addClass( 'right' ).removeClass( 'left' ) ).css({ position: 'relative' });
                        $( _dragData.columns[intersection - 1] ).addClass('w2ui-col-intersection');
                    }
                }
            }

            function targetIntersection( cursorX, offsets, lastWidth ){
                if ( cursorX <= offsets[0] ) {
                    return 0;
                } else if ( cursorX >= offsets[offsets.length - 1] + lastWidth ) {
                    return offsets.length;
                } else {
                    for ( var i = 0, l = offsets.length; i < l; i++ ) {
                        var thisOffset = offsets[ i ];
                        var nextOffset = offsets[ i + 1 ] || offsets[ i ] + lastWidth;
                        var midpoint = ( nextOffset - offsets[ i ]) / 2 + offsets[ i ];

                        if ( cursorX > thisOffset && cursorX <= midpoint ) {
                            return i;
                        } else if ( cursorX > midpoint && cursorX <= nextOffset ) {
                            return i + 1;
                        }
                    }
                    return intersection;
                }
            }

            function trackGhost( cursorX, cursorY ){
                $( _dragData.ghost ).css({
                    left: cursorX - 10,
                    top: cursorY - 10
                });
            }

            //return an object to remove drag if it has ever been enabled
            return {
                remove: function(){
                    $( obj.box ).off( 'mousedown', dragColStart );
                    $( obj.box ).off( 'mouseup', catchMouseup );
                    $( obj.box ).find( '.w2ui-head' ).removeAttr( 'draggable' );
                    obj.last.columnDrag = false;
                }
            }
        },

        columnOnOff: function (el, event, field) {
            // event before
            var eventData = this.trigger({ phase: 'before', target: this.name, type: 'columnOnOff', checkbox: el, field: field, originalEvent: event });
            if (eventData.isCancelled === true) return;
            // regular processing
            var obj = this;
            // collapse expanded rows
            for (var r in this.records) {
                if (this.records[r].expanded === true) this.records[r].expanded = false
            }
            // show/hide
            var hide = true;
            if (field == 'line-numbers') {
                this.show.lineNumbers = !this.show.lineNumbers;
                this.refresh();
            } else {
                var col = this.getColumn(field);
                if (col.hidden) {
                    $(el).prop('checked', true);
                    this.showColumn(col.field);
                } else {
                    $(el).prop('checked', false);
                    this.hideColumn(col.field);
                }
                hide = false;
            }
            if (hide) {
                setTimeout(function () {
                    $().w2overlay('', { name: 'searches-'+ this.name });
                    obj.toolbar.uncheck('column-on-off');
                }, 100);
            }
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        initToolbar: function () {
            // -- if toolbar is true
            if (typeof this.toolbar['render'] == 'undefined') {
                var tmp_items = this.toolbar.items;
                this.toolbar.items = [];
                this.toolbar = $().w2toolbar($.extend(true, {}, this.toolbar, { name: this.name +'_toolbar', owner: this }));

                // =============================================
                // ------ Toolbar Generic buttons

                if (this.show.toolbarReload) {
                    this.toolbar.items.push($.extend(true, {}, this.buttons['reload']));
                }
                if (this.show.toolbarColumns) {
                    this.toolbar.items.push($.extend(true, {}, this.buttons['columns']));
                }
                if (this.show.toolbarReload || this.show.toolbarColumn) {
                    this.toolbar.items.push({ type: 'break', id: 'w2ui-break0' });
                }
                if (this.show.toolbarSearch) {
                    var html =
                        '<div class="w2ui-toolbar-search">'+
                        '<table cellpadding="0" cellspacing="0"><tr>'+
                        '    <td>'+ this.buttons['search'].html +'</td>'+
                        '    <td>'+
                        '        <input id="grid_'+ this.name +'_search_all" class="w2ui-search-all" '+
                        '            placeholder="'+ this.last.caption +'" value="'+ this.last.search +'"'+
                        '            onkeydown="if (event.keyCode == 13 && w2utils.isIE) this.onchange();"'+
                        '            onchange="'+
                        '                var val = this.value; '+
                        '                var fld = $(this).data(\'w2field\'); '+
                        '                var dat = $(this).data(\'selected\'); '+
                        '                if (fld) val = fld.clean(val);'+
                        '                if (dat != null && $.isPlainObject(dat)) val = dat.id;'+
                        '                w2ui[\''+ this.name +'\'].search(w2ui[\''+ this.name +'\'].last.field, val); '+
                        '            ">'+
                        '    </td>'+
                        '    <td>'+
                        '        <div title="'+ w2utils.lang('Clear Search') +'" class="w2ui-search-clear" id="grid_'+ this.name +'_searchClear"  '+
                        '             onclick="var obj = w2ui[\''+ this.name +'\']; obj.searchReset();" '+
                        '        >&nbsp;&nbsp;</div>'+
                        '    </td>'+
                        '</tr></table>'+
                        '</div>';
                    this.toolbar.items.push({ type: 'html', id: 'w2ui-search', html: html });
                    if (this.multiSearch && this.searches.length > 0) {
                        this.toolbar.items.push($.extend(true, {}, this.buttons['search-go']));
                    }
                }
                if (this.show.toolbarSearch && (this.show.toolbarAdd || this.show.toolbarEdit || this.show.toolbarDelete || this.show.toolbarSave)) {
                    this.toolbar.items.push({ type: 'break', id: 'w2ui-break1' });
                }
                if (this.show.toolbarAdd) {
                    this.toolbar.items.push($.extend(true, {}, this.buttons['add']));
                }
                if (this.show.toolbarEdit) {
                    this.toolbar.items.push($.extend(true, {}, this.buttons['edit']));
                }
                if (this.show.toolbarDelete) {
                    this.toolbar.items.push($.extend(true, {}, this.buttons['delete']));
                }
                if (this.show.toolbarSave) {
                    if (this.show.toolbarAdd || this.show.toolbarDelete || this.show.toolbarEdit) {
                        this.toolbar.items.push({ type: 'break', id: 'w2ui-break2' });
                    }
                    this.toolbar.items.push($.extend(true, {}, this.buttons['save']));
                }
                // add original buttons
                for (var i in tmp_items) this.toolbar.items.push(tmp_items[i]);

                // =============================================
                // ------ Toolbar onClick processing

                var obj = this;
                this.toolbar.on('click', function (event) {
                    var eventData = obj.trigger({ phase: 'before', type: 'toolbar', target: event.target, originalEvent: event });
                    if (eventData.isCancelled === true) return;
                    var id = event.target;
                    switch (id) {
                        case 'w2ui-reload':
                            var eventData2 = obj.trigger({ phase: 'before', type: 'reload', target: obj.name });
                            if (eventData2.isCancelled === true) return false;
                            obj.reload();
                            obj.trigger($.extend(eventData2, { phase: 'after' }));
                            break;
                        case 'w2ui-column-on-off':
                            obj.initColumnOnOff();
                            obj.initResize();
                            obj.resize();
                            break;
                        case 'w2ui-search-advanced':
                            var tb = this;
                            var it = this.get(id);
                            if (it.checked) {
                                obj.searchClose();
                                setTimeout(function () { tb.uncheck(id); }, 1);
                            } else {
                                obj.searchOpen();
                                event.originalEvent.stopPropagation();
                                function tmp_close() {
                                    if ($('#w2ui-overlay-searches-'+ obj.name).data('keepOpen') === true) return;
                                    tb.uncheck(id);
                                    $(document).off('click', 'body', tmp_close);
                                }
                                $(document).on('click', 'body', tmp_close);
                            }
                            break;
                        case 'w2ui-add':
                            // events
                            var eventData = obj.trigger({ phase: 'before', target: obj.name, type: 'add', recid: null });
                            obj.trigger($.extend(eventData, { phase: 'after' }));
                            break;
                        case 'w2ui-edit':
                            var sel     = obj.getSelection();
                            var recid     = null;
                            if (sel.length == 1) recid = sel[0];
                            // events
                            var eventData = obj.trigger({ phase: 'before', target: obj.name, type: 'edit', recid: recid });
                            obj.trigger($.extend(eventData, { phase: 'after' }));
                            break;
                        case 'w2ui-delete':
                            obj["delete"]();
                            break;
                        case 'w2ui-save':
                            obj.save();
                            break;
                    }
                    // no default action
                    obj.trigger($.extend(eventData, { phase: 'after' }));
                });
            }
            return;
        },

        initResize: function () {
            var obj = this;
            //if (obj.resizing === true) return;
            $(this.box).find('.w2ui-resizer')
                .off('click')
                .on('click', function (event) {
                    if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;
                    if (event.preventDefault) event.preventDefault();
                })
                .off('mousedown')
                .on('mousedown', function (event) {
                    if (!event) event = window.event;
                    if (!window.addEventListener) { window.document.attachEvent('onselectstart', function() { return false; } ); }
                    obj.resizing = true;
                    obj.last.tmp = {
                        x   : event.screenX,
                        y   : event.screenY,
                        gx  : event.screenX,
                        gy  : event.screenY,
                        col : parseInt($(this).attr('name'))
                    };
                    if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;
                    if (event.preventDefault) event.preventDefault();
                    // fix sizes
                    for (var c in obj.columns) {
                        if (typeof obj.columns[c].sizeOriginal == 'undefined') obj.columns[c].sizeOriginal = obj.columns[c].size;
                        obj.columns[c].size = obj.columns[c].sizeCalculated;
                    }
                    var eventData = { phase: 'before', type: 'columnResize', target: obj.name, column: obj.last.tmp.col, field: obj.columns[obj.last.tmp.col].field };
                    eventData = obj.trigger($.extend(eventData, { resizeBy: 0, originalEvent: event }));
                    // set move event
                    var mouseMove = function (event) {
                        if (obj.resizing != true) return;
                        if (!event) event = window.event;
                        // event before
                        eventData = obj.trigger($.extend(eventData, { resizeBy: (event.screenX - obj.last.tmp.gx), originalEvent: event }));
                        if (eventData.isCancelled === true) { eventData.isCancelled = false; return; }
                        // default action
                        obj.last.tmp.x = (event.screenX - obj.last.tmp.x);
                        obj.last.tmp.y = (event.screenY - obj.last.tmp.y);
                        obj.columns[obj.last.tmp.col].size = (parseInt(obj.columns[obj.last.tmp.col].size) + obj.last.tmp.x) + 'px';
                        obj.resizeRecords();
                        // reset
                        obj.last.tmp.x = event.screenX;
                        obj.last.tmp.y = event.screenY;
                    }
                    var mouseUp = function (event) {
                        delete obj.resizing;
                        $(document).off('mousemove', 'body');
                        $(document).off('mouseup', 'body');
                        obj.resizeRecords();
                        // event before
                        obj.trigger($.extend(eventData, { phase: 'after', originalEvent: event }));
                    }
                    $(document).on('mousemove', 'body', mouseMove);
                    $(document).on('mouseup', 'body', mouseUp);
                })
                .each(function (index, el) {
                    var td  = $(el).parent();
                    $(el).css({
                        "height"         : '25px',
                        "margin-left"     : (td.width() - 3) + 'px'
                    })
                });
        },

        resizeBoxes: function () {
            // elements
            var main     = $(this.box).find('> div');
            var header   = $('#grid_'+ this.name +'_header');
            var toolbar  = $('#grid_'+ this.name +'_toolbar');
            var summary  = $('#grid_'+ this.name +'_summary');
            var footer   = $('#grid_'+ this.name +'_footer');
            var body     = $('#grid_'+ this.name +'_body');
            var columns  = $('#grid_'+ this.name +'_columns');
            var records  = $('#grid_'+ this.name +'_records');

            if (this.show.header) {
                header.css({
                    top:   '0px',
                    left:  '0px',
                    right: '0px'
                });
            }

            if (this.show.toolbar) {
                toolbar.css({
                    top:   ( 0 + (this.show.header ? w2utils.getSize(header, 'height') : 0) ) + 'px',
                    left:  '0px',
                    right: '0px'
                });
            }
            if (this.show.footer) {
                footer.css({
                    bottom: '0px',
                    left:  '0px',
                    right: '0px'
                });
            }
            if (this.summary.length > 0) {
                summary.css({
                    bottom: ( 0 + (this.show.footer ? w2utils.getSize(footer, 'height') : 0) ) + 'px',
                    left:  '0px',
                    right: '0px'
                });
            }
            body.css({
                top: ( 0 + (this.show.header ? w2utils.getSize(header, 'height') : 0) + (this.show.toolbar ? w2utils.getSize(toolbar, 'height') : 0) ) + 'px',
                bottom: ( 0 + (this.show.footer ? w2utils.getSize(footer, 'height') : 0) + (this.summary.length > 0 ? w2utils.getSize(summary, 'height') : 0) ) + 'px',
                left:   '0px',
                right:  '0px'
            });
        },

        resizeRecords: function () {
            var obj = this;
            // remove empty records
            $(this.box).find('.w2ui-empty-record').remove();
            // -- Calculate Column size in PX
            var box     = $(this.box);
            var grid    = $(this.box).find('> div');
            var header  = $('#grid_'+ this.name +'_header');
            var toolbar = $('#grid_'+ this.name +'_toolbar');
            var summary = $('#grid_'+ this.name +'_summary');
            var footer  = $('#grid_'+ this.name +'_footer');
            var body    = $('#grid_'+ this.name +'_body');
            var columns = $('#grid_'+ this.name +'_columns');
            var records = $('#grid_'+ this.name +'_records');

            // body might be expanded by data
            if (!this.fixedBody) {
                // allow it to render records, then resize
                var calculatedHeight = w2utils.getSize(columns, 'height')
                    + w2utils.getSize($('#grid_'+ obj.name +'_records table'), 'height');
                obj.height = calculatedHeight
                    + w2utils.getSize(grid, '+height')
                    + (obj.show.header ? w2utils.getSize(header, 'height') : 0)
                    + (obj.show.toolbar ? w2utils.getSize(toolbar, 'height') : 0)
                    + (summary.css('display') != 'none' ? w2utils.getSize(summary, 'height') : 0)
                    + (obj.show.footer ? w2utils.getSize(footer, 'height') : 0);
                grid.css('height', obj.height);
                body.css('height', calculatedHeight);
                box.css('height', w2utils.getSize(grid, 'height') + w2utils.getSize(box, '+height'));
            } else {
                // fixed body height
                var calculatedHeight =  grid.height()
                    - (this.show.header ? w2utils.getSize(header, 'height') : 0)
                    - (this.show.toolbar ? w2utils.getSize(toolbar, 'height') : 0)
                    - (summary.css('display') != 'none' ? w2utils.getSize(summary, 'height') : 0)
                    - (this.show.footer ? w2utils.getSize(footer, 'height') : 0);
                body.css('height', calculatedHeight);
            }

            var buffered = this.records.length;
            if (this.searchData.length != 0 && !this.url) buffered = this.last.searchIds.length;
            // check overflow
            var bodyOverflowX = false;
            var bodyOverflowY = false;
            if (body.width() < $(records).find('>table').width()) bodyOverflowX = true;
            if (body.height() - columns.height() < $(records).find('>table').height() + (bodyOverflowX ? w2utils.scrollBarSize() : 0)) bodyOverflowY = true;
            if (!this.fixedBody) { bodyOverflowY = false; bodyOverflowX = false; }
            if (bodyOverflowX || bodyOverflowY) {
                columns.find('> table > tbody > tr:nth-child(1) td.w2ui-head-last').css('width', w2utils.scrollBarSize()).show();
                records.css({
                    top: ((this.columnGroups.length > 0 && this.show.columns ? 1 : 0) + w2utils.getSize(columns, 'height')) +'px',
                    "-webkit-overflow-scrolling": "touch",
                    "overflow-x": (bodyOverflowX ? 'auto' : 'hidden'),
                    "overflow-y": (bodyOverflowY ? 'auto' : 'hidden') });
            } else {
                columns.find('> table > tbody > tr:nth-child(1) td.w2ui-head-last').hide();
                records.css({
                    top: ((this.columnGroups.length > 0 && this.show.columns ? 1 : 0) + w2utils.getSize(columns, 'height')) +'px',
                    overflow: 'hidden'
                });
                if (records.length > 0) { this.last.scrollTop  = 0; this.last.scrollLeft = 0; } // if no scrollbars, always show top
            }
            if (this.show.emptyRecords && !bodyOverflowY) {
                var max = Math.floor(records.height() / this.recordHeight) + 1;
                if (this.fixedBody) {
                    for (var di = buffered; di <= max; di++) {
                        var html  = '';
                        html += '<tr class="'+ (di % 2 ? 'w2ui-even' : 'w2ui-odd') + ' w2ui-empty-record" style="height: '+ this.recordHeight +'px">';
                        if (this.show.lineNumbers)  html += '<td class="w2ui-col-number"></td>';
                        if (this.show.selectColumn) html += '<td class="w2ui-grid-data w2ui-col-select"></td>';
                        if (this.show.expandColumn) html += '<td class="w2ui-grid-data w2ui-col-expand"></td>';
                        var j = 0;
                        while (true && this.columns.length > 0) {
                            var col = this.columns[j];
                            if (col.hidden) { j++; if (typeof this.columns[j] == 'undefined') break; else continue; }
                            html += '<td class="w2ui-grid-data" '+ (typeof col.attr != 'undefined' ? col.attr : '') +' col="'+ j +'"></td>';
                            j++;
                            if (typeof this.columns[j] == 'undefined') break;
                        }
                        html += '<td class="w2ui-grid-data-last"></td>';
                        html += '</tr>';
                        $('#grid_'+ this.name +'_records > table').append(html);
                    }
                }
            }
            if (body.length > 0) {
                var width_max = parseInt(body.width())
                    - (bodyOverflowY ? w2utils.scrollBarSize() : 0)
                    - (this.show.lineNumbers ? 34 : 0)
                    - (this.show.selectColumn ? 26 : 0)
                    - (this.show.expandColumn ? 26 : 0);
                var width_box = width_max;
                var percent = 0;
                // gridMinWidth processiong
                var restart = false;
                for (var i = 0; i < this.columns.length; i++) {
                    var col = this.columns[i];
                    if (col.gridMinWidth > 0) {
                        if (col.gridMinWidth > width_box && col.hidden !== true) {
                            col.hidden = true;
                            restart = true;
                        }
                        if (col.gridMinWidth < width_box && col.hidden === true) {
                            col.hidden = false;
                            restart = true;
                        }
                    }
                }
                if (restart === true) {
                    this.refresh();
                    return;
                }
                // assign PX column s
                for (var i = 0; i < this.columns.length; i++) {
                    var col = this.columns[i];
                    if (col.hidden) continue;
                    if (String(col.size).substr(String(col.size).length-2).toLowerCase() == 'px') {
                        width_max -= parseFloat(col.size);
                        this.columns[i].sizeCalculated = col.size;
                        this.columns[i].sizeType = 'px';
                    } else {
                        percent += parseFloat(col.size);
                        this.columns[i].sizeType = '%';
                        delete col.sizeCorrected;
                    }
                }
                // if sum != 100% -- reassign proportionally
                if (percent != 100 && percent > 0) {
                    for (var i = 0; i < this.columns.length; i++) {
                        var col = this.columns[i];
                        if (col.hidden) continue;
                        if (col.sizeType == '%') {
                            col.sizeCorrected = Math.round(parseFloat(col.size) * 100 * 100 / percent) / 100 + '%';
                        }
                    }
                }
                // calculate % columns
                for (var i = 0; i < this.columns.length; i++) {
                    var col = this.columns[i];
                    if (col.hidden) continue;
                    if (col.sizeType == '%') {
                        if (typeof this.columns[i].sizeCorrected != 'undefined') {
                            // make it 1px smaller, so margin of error can be calculated correctly
                            this.columns[i].sizeCalculated = Math.floor(width_max * parseFloat(col.sizeCorrected) / 100) - 1 + 'px';
                        } else {
                            // make it 1px smaller, so margin of error can be calculated correctly
                            this.columns[i].sizeCalculated = Math.floor(width_max * parseFloat(col.size) / 100) - 1 + 'px';
                        }
                    }
                }
            }
            // fix margin of error that is due percentage calculations
            var width_cols = 0;
            for (var i = 0; i < this.columns.length; i++) {
                var col = this.columns[i];
                if (col.hidden) continue;
                if (typeof col.min == 'undefined') col.min = 20;
                if (parseInt(col.sizeCalculated) < parseInt(col.min)) col.sizeCalculated = col.min + 'px';
                if (parseInt(col.sizeCalculated) > parseInt(col.max)) col.sizeCalculated = col.max + 'px';
                width_cols += parseInt(col.sizeCalculated);
            }
            var width_diff = parseInt(width_box) - parseInt(width_cols);
            if (width_diff > 0 && percent > 0) {
                var i = 0;
                while (true) {
                    var col = this.columns[i];
                    if (typeof col == 'undefined') { i = 0; continue; }
                    if (col.hidden || col.sizeType == 'px') { i++; continue; }
                    col.sizeCalculated = (parseInt(col.sizeCalculated) + 1) + 'px';
                    width_diff--;
                    if (width_diff == 0) break;
                    i++;
                }
            } else if (width_diff > 0) {
                columns.find('> table > tbody > tr:nth-child(1) td.w2ui-head-last').css('width', w2utils.scrollBarSize()).show();
            }
            // resize columns
            columns.find('> table > tbody > tr:nth-child(1) td').each(function (index, el) {
                var ind = $(el).attr('col');
                if (typeof ind != 'undefined' && obj.columns[ind]) $(el).css('width', obj.columns[ind].sizeCalculated);
                // last column
                if ($(el).hasClass('w2ui-head-last')) {
                    $(el).css('width', w2utils.scrollBarSize() + (width_diff > 0 && percent == 0 ? width_diff : 0) + 'px');
                }
            });
            // if there are column groups - hide first row (needed for sizing)
            if (columns.find('> table > tbody > tr').length == 3) {
                columns.find('> table > tbody > tr:nth-child(1) td').html('').css({
                    'height' : '0px',
                    'border' : '0px',
                    'padding': '0px',
                    'margin' : '0px'
                });
            }
            // resize records
            records.find('> table > tbody > tr:nth-child(1) td').each(function (index, el) {
                var ind = $(el).attr('col');
                if (typeof ind != 'undefined' && obj.columns[ind]) $(el).css('width', obj.columns[ind].sizeCalculated);
                // last column
                if ($(el).hasClass('w2ui-grid-data-last')) {
                    $(el).css('width', (width_diff > 0 && percent == 0 ? width_diff : 0) + 'px');
                }
            });
            // resize summary
            summary.find('> table > tbody > tr:nth-child(1) td').each(function (index, el) {
                var ind = $(el).attr('col');
                if (typeof ind != 'undefined' && obj.columns[ind]) $(el).css('width', obj.columns[ind].sizeCalculated);
                // last column
                if ($(el).hasClass('w2ui-grid-data-last')) {
                    $(el).css('width', w2utils.scrollBarSize() + (width_diff > 0 && percent == 0 ? width_diff : 0) + 'px');
                }
            });
            this.initResize();
            this.refreshRanges();
            // apply last scroll if any
            if ((this.last.scrollTop || this.last.scrollLeft) && records.length > 0) {
                columns.prop('scrollLeft', this.last.scrollLeft);
                records.prop('scrollTop',  this.last.scrollTop);
                records.prop('scrollLeft', this.last.scrollLeft);
            }
        },

        getSearchesHTML: function () {
            var html = '<table cellspacing="0">';
            var showBtn = false;
            for (var i = 0; i < this.searches.length; i++) {
                var s = this.searches[i];
                s.type = String(s.type).toLowerCase();
                if (s.hidden) continue;
                var btn = '';
                if (showBtn == false) {
                    btn = '<button class="btn close-btn" onclick="obj = w2ui[\''+ this.name +'\']; if (obj) { obj.searchClose(); }">X</button';
                    showBtn = true;
                }
                if (typeof s.inTag   == 'undefined') s.inTag     = '';
                if (typeof s.outTag  == 'undefined') s.outTag     = '';
                if (typeof s.type    == 'undefined') s.type     = 'text';
                if (['text', 'alphanumeric', 'combo'].indexOf(s.type) != -1) {
                    var operator =  '<select id="grid_'+ this.name +'_operator_'+ i +'" onclick="event.stopPropagation();">'+
                        '    <option value="is">'+ w2utils.lang('is') +'</option>'+
                        '    <option value="begins">'+ w2utils.lang('begins') +'</option>'+
                        '    <option value="contains">'+ w2utils.lang('contains') +'</option>'+
                        '    <option value="ends">'+ w2utils.lang('ends') +'</option>'+
                        '</select>';
                }
                if (['int', 'float', 'money', 'currency', 'percent', 'date', 'time'].indexOf(s.type) != -1) {
                    var operator =  '<select id="grid_'+ this.name +'_operator_'+ i +'" '+
                        '        onchange="w2ui[\''+ this.name + '\'].initOperator(this, '+ i +');" onclick="event.stopPropagation();">'+
                        '    <option value="is">'+ w2utils.lang('is') +'</option>'+
                        (['int'].indexOf(s.type) != -1 ? '<option value="in">'+ w2utils.lang('in') +'</option>' : '') +
                        (['int'].indexOf(s.type) != -1 ? '<option value="not in">'+ w2utils.lang('not in') +'</option>' : '') +
                        '<option value="between">'+ w2utils.lang('between') +'</option>'+
                        '</select>';
                }
                if (['select', 'list', 'hex'].indexOf(s.type) != -1) {
                    var operator =  '<select id="grid_'+ this.name +'_operator_'+ i +'" onclick="event.stopPropagation();">'+
                        '    <option value="is">'+ w2utils.lang('is') +'</option>'+
                        '</select>';
                }
                if (['enum'].indexOf(s.type) != -1) {
                    var operator =  '<select id="grid_'+ this.name +'_operator_'+ i +'" onclick="event.stopPropagation();">'+
                        '    <option value="in">'+ w2utils.lang('in') +'</option>'+
                        '    <option value="not in">'+ w2utils.lang('not in') +'</option>'+
                        '</select>';
                }
                html += '<tr>'+
                        '    <td class="close-btn">'+ btn +'</td>' +
                        '    <td class="caption">'+ s.caption +'</td>' +
                        '    <td class="operator">'+ operator +'</td>'+
                        '    <td class="value">';

                switch (s.type) {
                    case 'text':
                    case 'alphanumeric':
                    case 'hex':
                    case 'list':
                    case 'combo':
                    case 'enum':
                        html += '<input rel="search" type="text" style="width: 300px;" id="grid_'+ this.name +'_field_'+ i +'" name="'+ s.field +'" '+ s.inTag +'>';
                        break;

                    case 'int':
                    case 'float':
                    case 'money':
                    case 'currency':
                    case 'percent':
                    case 'date':
                    case 'time':
                        html += '<input rel="search" type="text" size="12" id="grid_'+ this.name +'_field_'+ i +'" name="'+ s.field +'" '+ s.inTag +'>'+
                                '<span id="grid_'+ this.name +'_range_'+ i +'" style="display: none">'+
                                '&nbsp;-&nbsp;&nbsp;<input rel="search" type="text" style="width: 90px" id="grid_'+ this.name +'_field2_'+i+'" name="'+ s.field +'" '+ s.inTag +'>'+
                                '</span>';
                        break;

                    case 'select':
                        html += '<select rel="search" id="grid_'+ this.name +'_field_'+ i +'" name="'+ s.field +'" '+ s.inTag +'  onclick="event.stopPropagation();"></select>';
                        break;

                }
                html += s.outTag +
                        '    </td>' +
                        '</tr>';
            }
            html += '<tr>'+
                    '    <td colspan="4" class="actions">'+
                    '        <div>'+
                    '        <button class="btn" onclick="obj = w2ui[\''+ this.name +'\']; if (obj) { obj.searchReset(); }">'+ w2utils.lang('Reset') + '</button>'+
                    '        <button class="btn btn-blue" onclick="obj = w2ui[\''+ this.name +'\']; if (obj) { obj.search(); }">'+ w2utils.lang('Search') + '</button>'+
                    '        </div>'+
                    '    </td>'+
                    '</tr></table>';
            return html;
        },

        initOperator: function (el, search_ind) {
            var obj     = this;
            var search  = obj.searches[search_ind];
            var range   = $('#grid_'+ obj.name + '_range_'+ search_ind);
            var fld1    = $('#grid_'+ obj.name +'_field_'+ search_ind);
            var fld2    = fld1.parent().find('span input');
            if ($(el).val() == 'in' || $(el).val() == 'not in') { fld1.w2field('clear'); } else { fld1.w2field(search.type); }
            if ($(el).val() == 'between') { range.show(); fld2.w2field(search.type); } else { range.hide(); }
        },

        initSearches: function () {
            var obj = this;
            // init searches
            for (var s in this.searches) {
                var search = this.searches[s];
                var sdata  = this.getSearchData(search.field);
                search.type = String(search.type).toLowerCase();
                if (typeof search.options != 'object') search.options = {};
                // init types
                switch (search.type) {
                    case 'text':
                    case 'alphanumeric':
                        $('#grid_'+ this.name +'_operator_'+s).val('begins');
                        if (['alphanumeric', 'hex'].indexOf(search.type) != -1) {
                            $('#grid_'+ this.name +'_field_' + s).w2field(search.type, search.options);
                        }
                        break;

                    case 'int':
                    case 'float':
                    case 'money':
                    case 'currency':
                    case 'percent':
                    case 'date':
                    case 'time':
                        if (sdata && sdata.type == 'int' && ['in', 'not in'].indexOf(sdata.operator) != -1) break;
                        $('#grid_'+ this.name +'_field_'+s).w2field(search.type, search.options);
                        $('#grid_'+ this.name +'_field2_'+s).w2field(search.type, search.options);
                        setTimeout(function () { // convert to date if it is number
                            $('#grid_'+ obj.name +'_field_'+s).keydown(); 
                            $('#grid_'+ obj.name +'_field2_'+s).keydown(); 
                        }, 1);
                        break;

                    case 'hex':
                        break;

                    case 'list':
                    case 'combo':
                    case 'enum':
                        var options = search.options;
                        if (search.type == 'list') options.selected = {};
                        if (search.type == 'enum') options.selected = [];
                        if (sdata) options.selected = sdata.value;
                        $('#grid_'+ this.name +'_field_'+s).w2field(search.type, options);
                        if (search.type == 'combo') {
                            $('#grid_'+ this.name +'_operator_'+s).val('begins');
                        }
                        break;

                    case 'select':
                        // build options
                        var options = '<option value="">--</option>';
                        for (var i in search.options.items) {
                            var si = search.options.items[i];
                            if ($.isPlainObject(search.options.items[i])) {
                                var val = si.id;
                                var txt = si.text;
                                if (typeof val == 'undefined' && typeof si.value != 'undefined')   val = si.value;
                                if (typeof txt == 'undefined' && typeof si.caption != 'undefined') txt = si.caption;
                                if (val == null) val = '';
                                options += '<option value="'+ val +'">'+ txt +'</option>';
                            } else {
                                options += '<option value="'+ si +'">'+ si +'</option>';
                            }
                        }
                        $('#grid_'+ this.name +'_field_'+s).html(options);
                        break;
                }
                if (sdata != null) {
                    if (sdata.type == 'int' && ['in', 'not in'].indexOf(sdata.operator) != -1) {
                        $('#grid_'+ this.name +'_field_'+ s).w2field('clear').val(sdata.value);
                    }
                    $('#grid_'+ this.name +'_operator_'+ s).val(sdata.operator).trigger('change');
                    if (!$.isArray(sdata.value)) {
                        if (typeof sdata.value != 'udefined') $('#grid_'+ this.name +'_field_'+ s).val(sdata.value).trigger('change');
                    } else {
                        if (['in', 'not in'].indexOf(sdata.operator) != -1) {
                            $('#grid_'+ this.name +'_field_'+ s).val(sdata.value).trigger('change');
                        } else {
                            $('#grid_'+ this.name +'_field_'+ s).val(sdata.value[0]).trigger('change');
                            $('#grid_'+ this.name +'_field2_'+ s).val(sdata.value[1]).trigger('change');
                        }
                    }
                }
            }
            // add on change event
            $('#w2ui-overlay-searches-'+ this.name +' .w2ui-grid-searches *[rel=search]').on('keypress', function (evnt) {
                if (evnt.keyCode == 13) {
                    obj.search();
                    $().w2overlay();
                }
            });
        },

        getColumnsHTML: function () {
            var obj  = this;
            var html = '';
            if (this.show.columnHeaders) {
                if (this.columnGroups.length > 0) {
                    html = getColumns(true) + getGroups() + getColumns(false);
                } else {
                    html = getColumns(true);
                }
            }
            return html;

            function getGroups () {
                var html = '<tr>';
                // add empty group at the end
                if (obj.columnGroups[obj.columnGroups.length-1].caption != '') obj.columnGroups.push({ caption: '' });

                if (obj.show.lineNumbers) {
                    html += '<td class="w2ui-head w2ui-col-number">'+
                            '    <div>&nbsp;</div>'+
                            '</td>';
                }
                if (obj.show.selectColumn) {
                    html += '<td class="w2ui-head w2ui-col-select">'+
                            '    <div>&nbsp;</div>'+
                            '</td>';
                }
                if (obj.show.expandColumn) {
                    html += '<td class="w2ui-head w2ui-col-expand">'+
                            '    <div>&nbsp;</div>'+
                            '</td>';
                }
                var ii = 0;
                for (var i=0; i<obj.columnGroups.length; i++) {
                    var colg = obj.columnGroups[i];
                    var col  = obj.columns[ii];
                    if (typeof colg.span == 'undefined' || colg.span != parseInt(colg.span)) colg.span = 1;
                    if (typeof colg.colspan != 'undefined') colg.span = colg.colspan;
                    if (colg.master === true) {
                        var sortStyle = '';
                        for (var si in obj.sortData) {
                            if (obj.sortData[si].field == col.field) {
                                if (RegExp('asc', 'i').test(obj.sortData[si].direction))  sortStyle = 'w2ui-sort-up';
                                if (RegExp('desc', 'i').test(obj.sortData[si].direction)) sortStyle = 'w2ui-sort-down';
                            }
                        }
                        var resizer = "";
                        if (col.resizable !== false) {
                            resizer = '<div class="w2ui-resizer" name="'+ ii +'"></div>';
                        }
                        html += '<td class="w2ui-head '+ sortStyle +'" col="'+ ii + '" rowspan="2" colspan="'+ (colg.span + (i == obj.columnGroups.length-1 ? 1 : 0) ) +'" '+
                                '    onclick="w2ui[\''+ obj.name +'\'].columnClick(\''+ col.field +'\', event);">'+
                                    resizer +
                                '    <div class="w2ui-col-group w2ui-col-header '+ (sortStyle ? 'w2ui-col-sorted' : '') +'">'+
                                '        <div class="'+ sortStyle +'"></div>'+
                                        (!col.caption ? '&nbsp;' : col.caption) +
                                '    </div>'+
                                '</td>';
                    } else {
                        html += '<td class="w2ui-head" col="'+ ii + '" '+
                                '        colspan="'+ (colg.span + (i == obj.columnGroups.length-1 ? 1 : 0) ) +'">'+
                                '    <div class="w2ui-col-group">'+
                                    (!colg.caption ? '&nbsp;' : colg.caption) +
                                '    </div>'+
                                '</td>';
                    }
                    ii += colg.span;
                }
                html += '</tr>';
                return html;
            }

            function getColumns (master) {
                var html = '<tr>',
                    reorderCols = (obj.reorderColumns && (!obj.columnGroups || !obj.columnGroups.length)) ? ' w2ui-reorder-cols-head ' : '';
                if (obj.show.lineNumbers) {
                    html += '<td class="w2ui-head w2ui-col-number" onclick="w2ui[\''+ obj.name +'\'].columnClick(\'line-number\', event);">'+
                            '    <div>#</div>'+
                            '</td>';
                }
                if (obj.show.selectColumn) {
                    html += '<td class="w2ui-head w2ui-col-select" '+
                            '        onclick="if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;">'+
                            '    <div>'+
                            '        <input type="checkbox" id="grid_'+ obj.name +'_check_all" tabIndex="-1"'+
                            '            style="' + (obj.multiSelect == false ? 'display: none;' : '') + '"'+
                            '            onclick="if (this.checked) w2ui[\''+ obj.name +'\'].selectAll(); '+
                            '                     else w2ui[\''+ obj.name +'\'].selectNone(); '+
                            '                     if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;">'+
                            '    </div>'+
                            '</td>';
                }
                if (obj.show.expandColumn) {
                    html += '<td class="w2ui-head w2ui-col-expand">'+
                            '    <div>&nbsp;</div>'+
                            '</td>';
                }
                var ii = 0;
                var id = 0;
                for (var i=0; i<obj.columns.length; i++) {
                    var col  = obj.columns[i];
                    var colg = {};
                    if (i == id) {
                        id = id + (typeof obj.columnGroups[ii] != 'undefined' ? parseInt(obj.columnGroups[ii].span) : 0);
                        ii++;
                    }
                    if (typeof obj.columnGroups[ii-1] != 'undefined') var colg = obj.columnGroups[ii-1];
                    if (col.hidden) continue;
                    var sortStyle = '';
                    for (var si in obj.sortData) {
                        if (obj.sortData[si].field == col.field) {
                            if (RegExp('asc', 'i').test(obj.sortData[si].direction))  sortStyle = 'w2ui-sort-up';
                            if (RegExp('desc', 'i').test(obj.sortData[si].direction)) sortStyle = 'w2ui-sort-down';
                        }
                    }
                    if (colg['master'] !== true || master) { // grouping of columns
                        var resizer = "";
                        if (col.resizable !== false) {
                            resizer = '<div class="w2ui-resizer" name="'+ i +'"></div>';
                        }
                        html += '<td col="'+ i +'" class="w2ui-head '+ sortStyle + reorderCols + '" ' +
                                '    onclick="w2ui[\''+ obj.name +'\'].columnClick(\''+ col.field +'\', event);">'+
                                    resizer +
                                '    <div class="w2ui-col-header '+ (sortStyle ? 'w2ui-col-sorted' : '') +'">'+
                                '        <div class="'+ sortStyle +'"></div>'+
                                        (!col.caption ? '&nbsp;' : col.caption) +
                                '    </div>'+
                                '</td>';
                    }
                }
                html += '<td class="w2ui-head w2ui-head-last"><div>&nbsp;</div></td>';
                html += '</tr>';
                return html;
            }
        },

        getRecordsHTML: function () {
            var buffered = this.records.length;
            if (this.searchData.length != 0 && !this.url) buffered = this.last.searchIds.length;
            // larget number works better with chrome, smaller with FF.
            if (buffered > 300) this.show_extra = 30; else this.show_extra = 300;
            var records  = $('#grid_'+ this.name +'_records');
            var limit    = Math.floor(records.height() / this.recordHeight) + this.show_extra + 1;
            if (!this.fixedBody || limit > buffered) limit = buffered;
            // always need first record for resizing purposes
            var html = '<table>' + this.getRecordHTML(-1, 0);
            // first empty row with height
            html += '<tr id="grid_'+ this.name + '_rec_top" line="top" style="height: '+ 0 +'px">'+
                    '    <td colspan="200"></td>'+
                    '</tr>';
            for (var i = 0; i < limit; i++) {
                html += this.getRecordHTML(i, i+1);
            }
            html += '<tr id="grid_'+ this.name + '_rec_bottom" line="bottom" style="height: '+ ((buffered - limit) * this.recordHeight) +'px">'+
                    '    <td colspan="200"></td>'+
                    '</tr>'+
                    '<tr id="grid_'+ this.name +'_rec_more" style="display: none">'+
                    '    <td colspan="200" class="w2ui-load-more"></td>'+
                    '</tr>'+
                    '</table>';
            this.last.range_start = 0;
            this.last.range_end   = limit;
            return html;
        },

        getSummaryHTML: function () {
            if (this.summary.length == 0) return;
            var html = '<table>';
            for (var i = 0; i < this.summary.length; i++) {
                html += this.getRecordHTML(i, i+1, true);
            }
            html += '</table>';
            return html;
        },

        scroll: function (event) {
            var time    = (new Date()).getTime();
            var obj     = this;
            var records = $('#grid_'+ this.name +'_records');
            var buffered = this.records.length;
            if (this.searchData.length != 0 && !this.url) buffered = this.last.searchIds.length;
            if (buffered == 0 || records.length == 0 || records.height() == 0) return;
            if (buffered > 300) this.show_extra = 30; else this.show_extra = 300;
            // need this to enable scrolling when this.limit < then a screen can fit
            if (records.height() < buffered * this.recordHeight && records.css('overflow-y') == 'hidden') {
                if (this.total > 0) this.refresh();
                return;
            }
            // update footer
            var t1 = Math.round(records[0].scrollTop / this.recordHeight + 1);
            var t2 = t1 + (Math.round(records.height() / this.recordHeight) - 1);
            if (t1 > buffered) t1 = buffered;
            if (t2 > buffered) t2 = buffered;
            var url = (typeof this.url != 'object' ? this.url : this.url.get);
            $('#grid_'+ this.name + '_footer .w2ui-footer-right').html(w2utils.formatNumber(this.offset + t1) + '-' + w2utils.formatNumber(this.offset + t2) + ' ' + w2utils.lang('of') + ' ' +    w2utils.formatNumber(this.total) +
                    (url ? ' ('+ w2utils.lang('buffered') + ' '+ w2utils.formatNumber(buffered) + (this.offset > 0 ? ', skip ' + w2utils.formatNumber(this.offset) : '') + ')' : '')
            );
            // only for local data source, else no extra records loaded
            if (!url && (!this.fixedBody || this.total <= 300)) return;
            // regular processing
            var start     = Math.floor(records[0].scrollTop / this.recordHeight) - this.show_extra;
            var end        = start + Math.floor(records.height() / this.recordHeight) + this.show_extra * 2 + 1;
            // var div     = start - this.last.range_start;
            if (start < 1) start = 1;
            if (end > this.total) end = this.total;
            var tr1 = records.find('#grid_'+ this.name +'_rec_top');
            var tr2 = records.find('#grid_'+ this.name +'_rec_bottom');
            // if row is expanded
            if (String(tr1.next().prop('id')).indexOf('_expanded_row') != -1) tr1.next().remove();
            if (this.total > end && String(tr2.prev().prop('id')).indexOf('_expanded_row') != -1) tr2.prev().remove();
            var first = parseInt(tr1.next().attr('line'));
            var last  = parseInt(tr2.prev().attr('line'));
            //$('#log').html('buffer: '+ this.buffered +' start-end: ' + start + '-'+ end + ' ===> first-last: ' + first + '-' + last);
            if (first < start || first == 1 || this.last.pull_refresh) { // scroll down
                // console.log('end', end, 'last', last, 'show_extre', this.show_extra, this.last.pull_refresh);
                if (end <= last + this.show_extra - 2 && end != this.total) return;
                this.last.pull_refresh = false;
                // remove from top
                while (true) {
                    var tmp = records.find('#grid_'+ this.name +'_rec_top').next();
                    if (tmp.attr('line') == 'bottom') break;
                    if (parseInt(tmp.attr('line')) < start) tmp.remove(); else break;
                }
                // add at bottom
                var tmp = records.find('#grid_'+ this.name +'_rec_bottom').prev();
                var rec_start = tmp.attr('line');
                if (rec_start == 'top') rec_start = start;
                for (var i = parseInt(rec_start) + 1; i <= end; i++) {
                    if (!this.records[i-1]) continue;
                    if (this.records[i-1].expanded === true) this.records[i-1].expanded = false;
                    tr2.before(this.getRecordHTML(i-1, i));
                }
                markSearch();
                setTimeout(function() { obj.refreshRanges(); }, 0);
            } else { // scroll up
                if (start >= first - this.show_extra + 2 && start > 1) return;
                // remove from bottom
                while (true) {
                    var tmp = records.find('#grid_'+ this.name +'_rec_bottom').prev();
                    if (tmp.attr('line') == 'top') break;
                    if (parseInt(tmp.attr('line')) > end) tmp.remove(); else break;
                }
                // add at top
                var tmp = records.find('#grid_'+ this.name +'_rec_top').next();
                var rec_start = tmp.attr('line');
                if (rec_start == 'bottom') rec_start = end;
                for (var i = parseInt(rec_start) - 1; i >= start; i--) {
                    if (!this.records[i-1]) continue;
                    if (this.records[i-1].expanded === true) this.records[i-1].expanded = false;
                    tr1.after(this.getRecordHTML(i-1, i));
                }
                markSearch();
                setTimeout(function() { obj.refreshRanges(); }, 0);
            }
            // first/last row size
            var h1 = (start - 1) * obj.recordHeight;
            var h2 = (buffered - end) * obj.recordHeight;
            if (h2 < 0) h2 = 0;
            tr1.css('height', h1 + 'px');
            tr2.css('height', h2 + 'px');
            obj.last.range_start = start;
            obj.last.range_end   = end;
            // load more if needed
            var s = Math.floor(records[0].scrollTop / this.recordHeight);
            var e = s + Math.floor(records.height() / this.recordHeight);
            if (e + 10 > buffered && this.last.pull_more !== true && buffered < this.total - this.offset) {
                if (this.autoLoad === true) {
                    this.last.pull_more = true;
                    this.last.xhr_offset += this.limit;
                    this.request('get-records');
                } else {
                    var more = $('#grid_'+ this.name +'_rec_more');
                    if (more.css('display') == 'none') {
                        more.show()
                            .on('click', function () {
                                obj.last.pull_more = true;
                                obj.last.xhr_offset += obj.limit;
                                obj.request('get-records');
                                // show spinner the last
                                $(this).find('td').html('<div><div style="width: 20px; height: 20px;" class="w2ui-spinner"></div></div>');
                            });
                    }
                    if (more.find('td').text().indexOf('Load') == -1) {
                        more.find('td').html('<div>'+ w2utils.lang('Load') + ' ' + obj.limit + ' ' + w2utils.lang('More') + '...</div>');
                    }
                }
            }
            // check for grid end
            if (buffered >= this.total - this.offset) $('#grid_'+ this.name +'_rec_more').hide();
            return;

            function markSearch() {
                // mark search
                if(obj.markSearch === false) return;
                clearTimeout(obj.last.marker_timer);
                obj.last.marker_timer = setTimeout(function () {
                    // mark all search strings
                    var str = [];
                    for (var s in obj.searchData) {
                        var tmp = obj.searchData[s];
                        if ($.inArray(tmp.value, str) == -1) str.push(tmp.value);
                    }
                    if (str.length > 0) $(obj.box).find('.w2ui-grid-data > div').w2marker(str);
                }, 50);
            }
        },

        getRecordHTML: function (ind, lineNum, summary) {
            var rec_html = '';
            var sel = this.last.selection;
            var record;
            // first record needs for resize purposes
            if (ind == -1) {
                rec_html += '<tr line="0">';
                if (this.show.lineNumbers)  rec_html += '<td class="w2ui-col-number" style="height: 0px;"></td>';
                if (this.show.selectColumn) rec_html += '<td class="w2ui-col-select" style="height: 0px;"></td>';
                if (this.show.expandColumn) rec_html += '<td class="w2ui-col-expand" style="height: 0px;"></td>';
                for (var i in this.columns) {
                    if (this.columns[i].hidden) continue;
                    rec_html += '<td class="w2ui-grid-data" col="'+ i +'" style="height: 0px;"></td>';
                }
                rec_html += '<td class="w2ui-grid-data-last" style="height: 0px;"></td>';
                rec_html += '</tr>';
                return rec_html;
            }
            // regular record
            var url = (typeof this.url != 'object' ? this.url : this.url.get);
            if (summary !== true) {
                if (this.searchData.length > 0 && !url) {
                    if (ind >= this.last.searchIds.length) return '';
                    ind = this.last.searchIds[ind];
                    record = this.records[ind];
                } else {
                    if (ind >= this.records.length) return '';
                    record = this.records[ind];
                }
            } else {
                if (ind >= this.summary.length) return '';
                record = this.summary[ind];
            }
            if (!record) return '';
            var id = w2utils.escapeId(record.recid);
            var isRowSelected = false;
            if (sel.indexes.indexOf(ind) != -1) isRowSelected = true;
            // render TR
            rec_html += '<tr id="grid_'+ this.name +'_rec_'+ record.recid +'" recid="'+ record.recid +'" line="'+ lineNum +'" '+
                ' class="'+ (lineNum % 2 == 0 ? 'w2ui-even' : 'w2ui-odd') + (isRowSelected && this.selectType == 'row' ? ' w2ui-selected' : '') + (record.expanded === true ? ' w2ui-expanded' : '') + '" ' +
                (summary !== true ?
                    (w2utils.isIOS ?
                        '    onclick  = "w2ui[\''+ this.name +'\'].dblClick(\''+ record.recid +'\', event);"'
                        :
                        '    onclick  = "w2ui[\''+ this.name +'\'].click(\''+ record.recid +'\', event);"'+
                        '    oncontextmenu = "w2ui[\''+ this.name +'\'].contextMenu(\''+ record.recid +'\', event);"'
                     )
                    : ''
                ) +
                ' style="height: '+ this.recordHeight +'px; '+ (!isRowSelected && typeof record['style'] == 'string' ? record['style'] : '') +'" '+
                    ( typeof record['style'] == 'string' ? 'custom_style="'+ record['style'] +'"' : '') +
                '>';
            if (this.show.lineNumbers) {
                rec_html += '<td id="grid_'+ this.name +'_cell_'+ ind +'_number' + (summary ? '_s' : '') + '" class="w2ui-col-number">'+
                                (summary !== true ? '<div>'+ lineNum +'</div>' : '') +
                            '</td>';
            }
            if (this.show.selectColumn) {
                rec_html +=
                        '<td id="grid_'+ this.name +'_cell_'+ ind +'_select' + (summary ? '_s' : '') + '" class="w2ui-grid-data w2ui-col-select" '+
                        '        onclick="if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;">'+
                            (summary !== true ?
                            '    <div>'+
                            '        <input class="w2ui-grid-select-check" type="checkbox" tabIndex="-1"'+
                            '            '+ (isRowSelected ? 'checked="checked"' : '') +
                            '            onclick="var obj = w2ui[\''+ this.name +'\']; '+
                            '                if (!obj.multiSelect) { obj.selectNone(); }'+
                            '                if (this.checked) obj.select(\''+ record.recid + '\'); else obj.unselect(\''+ record.recid + '\'); '+
                            '                if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;">'+
                            '    </div>'
                            :
                            '' ) +
                        '</td>';
            }
            if (this.show.expandColumn) {
                var tmp_img = '';
                if (record.expanded === true)  tmp_img = '-'; else tmp_img = '+';
                if (record.expanded == 'none') tmp_img = '';
                if (record.expanded == 'spinner') tmp_img = '<div class="w2ui-spinner" style="width: 16px; margin: -2px 2px;"></div>';
                rec_html +=
                        '<td id="grid_'+ this.name +'_cell_'+ ind +'_expand' + (summary ? '_s' : '') + '" class="w2ui-grid-data w2ui-col-expand">'+
                            (summary !== true ?
                            '    <div ondblclick="if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;" '+
                            '            onclick="w2ui[\''+ this.name +'\'].toggle(\''+ record.recid +'\', event); '+
                            '                if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;">'+
                            '        '+ tmp_img +' </div>'
                            :
                            '' ) +
                        '</td>';
            }
            var col_ind = 0;
            while (true) {
                var col = this.columns[col_ind];
                if (col.hidden) { col_ind++; if (typeof this.columns[col_ind] == 'undefined') break; else continue; }
                var isChanged = !summary && record.changes && typeof record.changes[col.field] != 'undefined';
                var rec_cell  = this.getCellHTML(ind, col_ind, summary);
                var addStyle  = '';
                if (typeof col.render == 'string') {
                    var tmp = col.render.toLowerCase().split(':');
                    if (['number', 'int', 'float', 'money', 'currency', 'percent'].indexOf(tmp[0]) != -1) addStyle += 'text-align: right;';
                }
                if (typeof record.style == 'object' && typeof record.style[col_ind] == 'string') {
                    addStyle += record.style[col_ind] + ';';
                }
                var isCellSelected = false;
                if (isRowSelected && $.inArray(col_ind, sel.columns[ind]) != -1) isCellSelected = true;
                rec_html += '<td class="w2ui-grid-data'+ (isCellSelected ? ' w2ui-selected' : '') + (isChanged ? ' w2ui-changed' : '') +'" col="'+ col_ind +'" '+
                            '    style="'+ addStyle + (typeof col.style != 'undefined' ? col.style : '') +'" '+
                                          (typeof col.attr != 'undefined' ? col.attr : '') +'>'+
                                rec_cell +
                            '</td>';
                col_ind++;
                if (typeof this.columns[col_ind] == 'undefined') break;
            }
            rec_html += '<td class="w2ui-grid-data-last"></td>';
            rec_html += '</tr>';
            return rec_html;
        },

        getCellHTML: function (ind, col_ind, summary) {
            var col    = this.columns[col_ind];
            var record = (summary !== true ? this.records[ind] : this.summary[ind]);
            var data   = this.getCellValue(ind, col_ind, summary);
            var edit   = col.editable;
            // various renderers
            if (typeof col.render != 'undefined') {
                if (typeof col.render == 'function') {
                    data = $.trim(col.render.call(this, record, ind, col_ind));
                    if (data.length < 4 || data.substr(0, 4).toLowerCase() != '<div') data = '<div>' + data + '</div>';
                }
                if (typeof col.render == 'object')   data = '<div>' + (col.render[data] || '') + '</div>';
                if (typeof col.render == 'string') {
                    var tmp = col.render.toLowerCase().split(':');
                    var prefix = '';
                    var suffix = '';
                    if (['number', 'int', 'float', 'money', 'currency', 'percent'].indexOf(tmp[0]) != -1) {
                        if (typeof tmp[1] == 'undefined' || !w2utils.isInt(tmp[1])) tmp[1] = 0;
                        if (tmp[1] > 20) tmp[1] = 20;
                        if (tmp[1] < 0)  tmp[1] = 0;
                        if (['money', 'currency'].indexOf(tmp[0]) != -1) { tmp[1] = w2utils.settings.currencyPrecision; prefix = w2utils.settings.currencyPrefix; suffix = w2utils.settings.currencySuffix }
                        if (tmp[0] == 'percent') { suffix = '%'; if (tmp[1] !== '0') tmp[1] = 1; }
                        if (tmp[0] == 'int')     { tmp[1] = 0; }
                        // format
                        data = '<div>' + (data !== '' ? prefix + w2utils.formatNumber(Number(data).toFixed(tmp[1])) + suffix : '') + '</div>';
                    }
                    if (tmp[0] == 'time') {
                        if (typeof tmp[1] == 'undefined' || tmp[1] == '') tmp[1] = w2utils.settings.time_format;
                        data = '<div>' + prefix + w2utils.formatTime(data, tmp[1] == 'h12' ? 'hh:mi pm': 'h24:min') + suffix + '</div>';
                    }
                    if (tmp[0] == 'date') {
                        if (typeof tmp[1] == 'undefined' || tmp[1] == '') tmp[1] = w2utils.settings.date_display;
                        data = '<div>' + prefix + w2utils.formatDate(data, tmp[1]) + suffix + '</div>';
                    }
                    if (tmp[0] == 'age') {
                        data = '<div>' + prefix + w2utils.age(data) + suffix + '</div>';
                    }
                    if (tmp[0] == 'toggle') {
                        data = '<div>' + prefix + (data ? 'Yes' : '') + suffix + '</div>';
                    }
                }
            } else {
                // if editable checkbox
                var addStyle = '';
                if (edit && ['checkbox', 'check'].indexOf(edit.type) != -1) {
                    var changeInd = summary ? -(ind + 1) : ind;
                    addStyle = 'text-align: center';
                    data = '<input type="checkbox" '+ (data ? 'checked' : '') +' onclick="' +
                           '    var obj = w2ui[\''+ this.name + '\']; '+
                           '    obj.editChange.call(obj, this, '+ changeInd +', '+ col_ind +', event); ' +
                           '">';
                }
                if (!this.show.recordTitles) {
                    var data = '<div style="'+ addStyle +'">'+ data +'</div>';
                } else {
                    // title overwrite
                    var title = String(data).replace(/"/g, "''");
                    if (typeof col.title != 'undefined') {
                        if (typeof col.title == 'function') title = col.title.call(this, record, ind, col_ind);
                        if (typeof col.title == 'string')   title = col.title;
                    }
                    var data = '<div title="'+ w2utils.stripTags(title) +'" style="'+ addStyle +'">'+ data +'</div>';
                }
            }
            if (data == null || typeof data == 'undefined') data = '';
            return data;
        },

        getCellValue: function (ind, col_ind, summary) {
            var col    = this.columns[col_ind];
            var record = (summary !== true ? this.records[ind] : this.summary[ind]);
            var data   = this.parseField(record, col.field);
            if (record.changes && typeof record.changes[col.field] != 'undefined') data = record.changes[col.field];
            if (data == null || typeof data == 'undefined') data = '';
            return data;
        },

        getFooterHTML: function () {
            return '<div>'+
                '    <div class="w2ui-footer-left"></div>'+
                '    <div class="w2ui-footer-right"></div>'+
                '    <div class="w2ui-footer-center"></div>'+
                '</div>';
        },

        status: function (msg) {
            if (typeof msg != 'undefined') {
                $('#grid_'+ this.name +'_footer').find('.w2ui-footer-left').html(msg);
            } else {
                // show number of selected
                var msgLeft = '';
                var sel = this.getSelection();
                if (sel.length > 0) {
                    msgLeft = String(sel.length).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,") + ' ' + w2utils.lang('selected');
                    var tmp = sel[0];
                    if (typeof tmp == 'object') tmp = tmp.recid + ', '+ w2utils.lang('Column') +': '+ tmp.column;
                    if (sel.length == 1) msgLeft = w2utils.lang('Record ID') + ': '+ tmp + ' ';
                }
                $('#grid_'+ this.name +'_footer .w2ui-footer-left').html(msgLeft);
                // toolbar
                if (sel.length == 1) this.toolbar.enable('w2ui-edit'); else this.toolbar.disable('w2ui-edit');
                if (sel.length >= 1) this.toolbar.enable('w2ui-delete'); else this.toolbar.disable('w2ui-delete');
            }
        },

        lock: function (msg, showSpinner) {
            var box  = $(this.box).find('> div:first-child');
            var args = Array.prototype.slice.call(arguments, 0);
            args.unshift(box);
            setTimeout(function () { w2utils.lock.apply(window, args); }, 10);
        },

        unlock: function () {
            var box = this.box;
            setTimeout(function () { w2utils.unlock(box); }, 25); // needed timer so if server fast, it will not flash
        },

        stateSave: function (returnOnly) {
            if (!localStorage) return null;
            var state = {
                columns     : [],
                show        : $.extend({}, this.show),
                last        : {
                    search      : this.last.search,
                    multi       : this.last.multi,
                    logic       : this.last.logic,
                    caption     : this.last.caption,
                    field       : this.last.field,
                    scrollTop   : this.last.scrollTop,
                    scrollLeft  : this.last.scrollLeft
                },
                sortData    : [],
                searchData  : []
            };
            for (var i in this.columns) {
                var col = this.columns[i];
                state.columns.push({
                    field           : col.field,
                    hidden          : col.hidden,
                    size            : col.size,
                    sizeCalculated  : col.sizeCalculated,
                    sizeOriginal    : col.sizeOriginal,
                    sizeType        : col.sizeType
                });
            }
            for (var i in this.sortData) state.sortData.push($.extend({}, this.sortData[i]));
            for (var i in this.searchData) state.searchData.push($.extend({}, this.searchData[i]));
            // save into local storage
            if (returnOnly !== true) {
                // event before
                var eventData = this.trigger({ phase: 'before', type: 'stateSave', target: this.name, state: state });
                if (eventData.isCancelled === true) { if (typeof callBack == 'function') callBack({ status: 'error', message: 'Request aborted.' }); return; }
                try {
                    var savedState = $.parseJSON(localStorage.w2ui || '{}');
                    if (!savedState) savedState = {};
                    if (!savedState.states) savedState.states = {};
                    savedState.states[this.name] = state;
                    localStorage.w2ui = JSON.stringify(savedState);
                } catch (e) {
                    delete localStorage.w2ui;
                    return null;
                }
                // event after
                this.trigger($.extend(eventData, { phase: 'after' }));
            }
            return state;
        },

        stateRestore: function (newState) {
            var obj = this;
            if (!newState) {
                // read it from local storage
                try {
                    if (!localStorage) return false;
                    var tmp = $.parseJSON(localStorage.w2ui || '{}');
                    if (!tmp) tmp = {};
                    if (!tmp.states) tmp.states = {};
                    newState = tmp.states[this.name];
                } catch (e) {
                    delete localStorage.w2ui;
                    return null;
                }
            }
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'stateRestore', target: this.name, state: newState });
            if (eventData.isCancelled === true) { if (typeof callBack == 'function') callBack({ status: 'error', message: 'Request aborted.' }); return; }
            // default behavior
            if ($.isPlainObject(newState)) {
                $.extend(this.show, newState.show);
                $.extend(this.last, newState.last);
                var sTop  = this.last.scrollTop;
                var sLeft = this.last.scrollLeft;
                for (var c in newState.columns) {
                    var tmp = newState.columns[c];
                    var col = this.getColumn(tmp.field);
                    if (col) $.extend(col, tmp);
                }
                this.sortData.splice(0, this.sortData.length);
                for (var c in newState.sortData) this.sortData.push(newState.sortData[c]);
                this.searchData.splice(0, this.searchData.length);
                for (var c in newState.searchData) this.searchData.push(newState.searchData[c]);
                // apply sort and search
                setTimeout(function () {
                    // needs timeout as records need to be populated
                    if (obj.sortData.length > 0) obj.localSort();
                    if (obj.searchData.length > 0) obj.localSearch();
                    obj.last.scrollTop  = sTop;
                    obj.last.scrollLeft = sLeft;
                    obj.refresh();
                }, 1);
            }
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            return true;
        },

        stateReset: function () {
            this.stateRestore(this.last.state);
            // remove from local storage
            if (localStorage) {
                try {
                    var tmp = $.parseJSON(localStorage.w2ui || '{}');
                    if (tmp.states && tmp.states[this.name]) {
                        delete tmp.states[this.name];
                    }
                    localStorage.w2ui = JSON.stringify(tmp);
                } catch (e) {
                    delete localStorage.w2ui;
                    return null;
                }                
            }
        },

        parseField: function (obj, field) {
            var val = '';
            try { // need this to make sure no error in fields
                val = obj;
                var tmp = String(field).split('.');
                for (var i in tmp) {
                    val = val[tmp[i]];
                }
            } catch (event) {
                val = '';
            }
            return val;
        },

        prepareData: function () {
            // loops thru records and prepares date and time objects
            for (var r in this.records) {
                var rec = this.records[r];
                for (var c in this.columns) {
                    var column = this.columns[c];
                    if (rec[column.field] == null || typeof column.render != 'string') continue;
                    // number
                    if (['number', 'int', 'float', 'money', 'currency', 'percent'].indexOf(column.render.split(':')[0])  != -1) {
                        if (typeof rec[column.field] != 'number') rec[column.field] = parseFloat(rec[column.field]);
                    }
                    // date
                    if (['date', 'age'].indexOf(column.render.split(':')[0]) != -1) {
                        if (!rec[column.field + '_']) {
                            var dt = rec[column.field];
                            if (w2utils.isInt(dt)) dt = parseInt(dt);
                            rec[column.field + '_'] = new Date(dt);
                        }
                    }
                    // time
                    if (['time'].indexOf(column.render) != -1) {
                        if (w2utils.isTime(rec[column.field])) { // if string
                            var tmp = w2utils.isTime(rec[column.field], true);
                            var dt = new Date();
                            dt.setHours(tmp.hours, tmp.minutes, (tmp.seconds ? tmp.seconds : 0), 0); // sets hours, min, sec, mills
                            if (!rec[column.field + '_']) rec[column.field + '_'] = dt;
                        } else { // if date object
                            var tmp = rec[column.field];
                            if (w2utils.isInt(tmp)) tmp = parseInt(tmp);
                            var tmp = (tmp != null ? new Date(tmp) : new Date());
                            var dt  = new Date();
                            dt.setHours(tmp.getHours(), tmp.getMinutes(), tmp.getSeconds(), 0); // sets hours, min, sec, mills
                            if (!rec[column.field + '_']) rec[column.field + '_'] = dt;
                        }
                    }
                }
            }
        },

        nextCell: function (col_ind, editable) {
            var check = col_ind + 1;
            if (this.columns.length == check) return null;
            if (editable === true) {
                var edit = this.columns[check].editable;
                if (this.columns[check].hidden || typeof edit == 'undefined'
                    || (edit && ['checkbox', 'check'].indexOf(edit.type) != -1)) return this.nextCell(check, editable);
            }
            return check;
        },

        prevCell: function (col_ind, editable) {
            var check = col_ind - 1;
            if (check < 0) return null;
            if (editable === true) {
                var edit = this.columns[check].editable;
                if (this.columns[check].hidden || typeof edit == 'undefined'
                    || (edit && ['checkbox', 'check'].indexOf(edit.type) != -1)) return this.prevCell(check, editable);
            }
            return check;
        },

        nextRow: function (ind) {
            if ((ind + 1 < this.records.length && this.last.searchIds.length == 0) // if there are more records
                    || (this.last.searchIds.length > 0 && ind < this.last.searchIds[this.last.searchIds.length-1])) {
                ind++;
                if (this.last.searchIds.length > 0) {
                    while (true) {
                        if ($.inArray(ind, this.last.searchIds) != -1 || ind > this.records.length) break;
                        ind++;
                    }
                }
                return ind;
            } else {
                return null;
            }
        },

        prevRow: function (ind) {
            if ((ind > 0 && this.last.searchIds.length == 0)  // if there are more records
                    || (this.last.searchIds.length > 0 && ind > this.last.searchIds[0])) {
                ind--;
                if (this.last.searchIds.length > 0) {
                    while (true) {
                        if ($.inArray(ind, this.last.searchIds) != -1 || ind < 0) break;
                        ind--;
                    }
                }
                return ind;
            } else {
                return null;
            }
        }
    };

    $.extend(w2grid.prototype, w2utils.event);
    w2obj.grid = w2grid;
})();

/************************************************************************
*   Library: Web 2.0 UI for jQuery (using prototypical inheritance)
*   - Following objects defined
*        - w2layout        - layout widget
*        - $().w2layout    - jQuery wrapper
*   - Dependencies: jQuery, w2utils, w2toolbar, w2tabs
*
* == NICE TO HAVE ==
*   - onResize for the panel
*   - add more panel title positions (left=rotated, right=rotated, bottom)
*   - bug: resizer is visible (and onHover) when panel is hidden.
*   - bug: when you assign content before previous transition completed.
*
************************************************************************/

(function () {
    var w2layout = function (options) {
        this.box     = null;        // DOM Element that holds the element
        this.name    = null;        // unique name for w2ui
        this.panels  = [];
        this.tmp     = {};

        this.padding = 1;        // panel padding
        this.resizer = 4;        // resizer width or height
        this.style   = '';

        this.onShow         = null;
        this.onHide         = null;
        this.onResizing     = null;
        this.onResizerClick = null;
        this.onRender       = null;
        this.onRefresh      = null;
        this.onResize       = null;
        this.onDestroy      = null;

        $.extend(true, this, w2obj.layout, options);
    };

    /* @const */ var w2layout_panels = ['top', 'left', 'main', 'preview', 'right', 'bottom'];

    // ====================================================
    // -- Registers as a jQuery plugin

    $.fn.w2layout = function(method) {
        if (typeof method === 'object' || !method ) {
            // check name parameter
            if (!w2utils.checkName(method, 'w2layout')) return;
            var panels = method.panels || [];
            var object = new w2layout(method);
            $.extend(object, { handlers: [], panels: [] });
            // add defined panels
            for (var p = 0, len = panels.length; p < len; p++) {
                object.panels[p] = $.extend(true, {}, w2layout.prototype.panel, panels[p]);
                if ($.isPlainObject(object.panels[p].tabs) || $.isArray(object.panels[p].tabs)) initTabs(object, panels[p].type);
                if ($.isPlainObject(object.panels[p].toolbar) || $.isArray(object.panels[p].toolbar)) initToolbar(object, panels[p].type);
            }
            // add all other panels
            for (var p1 in w2layout_panels) {
                p1 = w2layout_panels[p1];
                if (object.get(p1) !== null) continue;
                object.panels.push($.extend(true, {}, w2layout.prototype.panel, { type: p1, hidden: (p1 !== 'main'), size: 50 }));
            }
            if ($(this).length > 0) {
                object.render($(this)[0]);
            }
            w2ui[object.name] = object;
            return object;

        } else if (w2ui[$(this).attr('name')]) {
            var obj = w2ui[$(this).attr('name')];
            obj[method].apply(obj, Array.prototype.slice.call(arguments, 1));
            return this;
        } else {
            console.log('ERROR: Method ' +  method + ' does not exist on jQuery.w2layout' );
        }

        function initTabs(object, panel, tabs) {
            var pan = object.get(panel);
            if (pan !== null && typeof tabs == 'undefined') tabs = pan.tabs;
            if (pan === null || tabs === null) return false;
            // instanciate tabs
            if ($.isArray(tabs)) tabs = { tabs: tabs };
            $().w2destroy(object.name + '_' + panel + '_tabs'); // destroy if existed
            pan.tabs = $().w2tabs($.extend({}, tabs, { owner: object, name: object.name + '_' + panel + '_tabs' }));
            pan.show.tabs = true;
            return true;
        }

        function initToolbar(object, panel, toolbar) {
            var pan = object.get(panel);
            if (pan !== null && typeof toolbar == 'undefined') toolbar = pan.toolbar;
            if (pan === null || toolbar === null) return false;
            // instanciate toolbar
            if ($.isArray(toolbar)) toolbar = { items: toolbar };
            $().w2destroy(object.name + '_' + panel + '_toolbar'); // destroy if existed
            pan.toolbar = $().w2toolbar($.extend({}, toolbar, { owner: object, name: object.name + '_' + panel + '_toolbar' }));
            pan.show.toolbar = true;
            return true;
        }
    };

    // ====================================================
    // -- Implementation of core functionality

    w2layout.prototype = {
        // default setting for a panel
        panel: {
            type      : null,        // left, right, top, bottom
            title     : '',
            size      : 100,        // width or height depending on panel name
            minSize   : 20,
            maxSize   : false,
            hidden    : false,
            resizable : false,
            overflow  : 'auto',
            style     : '',
            content   : '',        // can be String or Object with .render(box) method
            tabs      : null,
            toolbar   : null,
            width     : null,        // read only
            height    : null,        // read only
            show : {
                toolbar : false,
                tabs    : false
            },
            onRefresh : null,
            onShow    : null,
            onHide    : null
        },

        // alias for content
        html: function (panel, data, transition) {
            return this.content(panel, data, transition);
        },

        content: function (panel, data, transition) {
            var obj = this;
            var p = this.get(panel);
            // if it is CSS panel
            if (panel == 'css') {
                $('#layout_'+ obj.name +'_panel_css').html('<style>'+ data +'</style>');
                return true;
            }
            if (p === null) return false;
            if (typeof data == 'undefined' || data === null) {
                return p.content;
            } else {
                if (data instanceof jQuery) {
                    console.log('ERROR: You can not pass jQuery object to w2layout.content() method');
                    return false;
                }
                var pname     = '#layout_'+ this.name + '_panel_'+ p.type;
                var current = $(pname + '> .w2ui-panel-content');
                var panelTop = 0;
                if (current.length > 0) {
                    $(pname).scrollTop(0);
                    panelTop = $(current).position().top;
                }
                if (p.content === '') {
                    p.content = data;
                    this.refresh(panel);
                } else {
                    p.content = data;
                    if (!p.hidden) {
                        if (transition !== null && transition !== '' && typeof transition != 'undefined') {
                            // apply transition
                            var div1 = $(pname + '> .w2ui-panel-content');
                            div1.after('<div class="w2ui-panel-content new-panel" style="'+ div1[0].style.cssText +'"></div>');
                            var div2 = $(pname + '> .w2ui-panel-content.new-panel');
                            div1.css('top', panelTop);
                            div2.css('top', panelTop);
                            if (typeof data == 'object') {
                                data.box = div2[0]; // do not do .render(box);
                                data.render();
                            } else {
                                div2.html(data);
                            }
                            w2utils.transition(div1[0], div2[0], transition, function () {
                                div1.remove();
                                div2.removeClass('new-panel');
                                div2.css('overflow', p.overflow);
                                // IE Hack
                                obj.resize();
                                if (window.navigator.userAgent.indexOf('MSIE') != -1) setTimeout(function () { obj.resize(); }, 100);
                            });
                        }
                    }
                    this.refresh(panel);
                }
            }
            // IE Hack
            obj.resize();
            if (window.navigator.userAgent.indexOf('MSIE') != -1) setTimeout(function () { obj.resize(); }, 100);
            return true;
        },

        load: function (panel, url, transition, onLoad) {
            var obj = this;
            if (panel == 'css') {
                $.get(url, function (data, status, xhr) { // should always be $.get as it is template
                    obj.content(panel, xhr.responseText);
                    if (onLoad) onLoad();
                });
                return true;
            }
            if (this.get(panel) !== null) {
                $.get(url, function (data, status, xhr) { // should always be $.get as it is template
                    obj.content(panel, xhr.responseText, transition);
                    if (onLoad) onLoad();
                    // IE Hack
                    obj.resize();
                    if (window.navigator.userAgent.indexOf('MSIE') != -1) setTimeout(function () { obj.resize(); }, 100);
                });
                return true;
            }
            return false;
        },

        sizeTo: function (panel, size) {
            var obj = this;
            var pan = obj.get(panel);
            if (pan === null) return false;
            // resize
            $(obj.box).find(' > div > .w2ui-panel').css({
                '-webkit-transition' : '.2s',
                '-moz-transition'    : '.2s',
                '-ms-transition'     : '.2s',
                '-o-transition'      : '.2s'
            });
            setTimeout(function () {
                obj.set(panel, { size: size });
            }, 1);
            // clean
            setTimeout(function () {
                $(obj.box).find(' > div > .w2ui-panel').css({
                    '-webkit-transition' : '0s',
                    '-moz-transition'    : '0s',
                    '-ms-transition'     : '0s',
                    '-o-transition'      : '0s'
                });
                obj.resize();
            }, 500);
            return true;
        },

        show: function (panel, immediate) {
            var obj = this;
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'show', target: panel, object: this.get(panel), immediate: immediate });
            if (eventData.isCancelled === true) return;

            var p = obj.get(panel);
            if (p === null) return false;
            p.hidden = false;
            if (immediate === true) {
                $('#layout_'+ obj.name +'_panel_'+panel).css({ 'opacity': '1' });
                if (p.resizable) $('#layout_'+ obj.name +'_resizer_'+panel).show();
                obj.trigger($.extend(eventData, { phase: 'after' }));
                obj.resize();
            } else {
                if (p.resizable) $('#layout_'+ obj.name +'_resizer_'+panel).show();
                // resize
                $('#layout_'+ obj.name +'_panel_'+panel).css({ 'opacity': '0' });
                $(obj.box).find(' > div > .w2ui-panel').css({
                    '-webkit-transition' : '.2s',
                    '-moz-transition'    : '.2s',
                    '-ms-transition'     : '.2s',
                    '-o-transition'      : '.2s'
                });
                setTimeout(function () { obj.resize(); }, 1);
                // show
                setTimeout(function() {
                    $('#layout_'+ obj.name +'_panel_'+ panel).css({ 'opacity': '1' });
                }, 250);
                // clean
                setTimeout(function () {
                    $(obj.box).find(' > div > .w2ui-panel').css({
                        '-webkit-transition' : '0s',
                        '-moz-transition'    : '0s',
                        '-ms-transition'     : '0s',
                        '-o-transition'      : '0s'
                    });
                    obj.trigger($.extend(eventData, { phase: 'after' }));
                    obj.resize();
                }, 500);
            }
            return true;
        },

        hide: function (panel, immediate) {
            var obj = this;
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'hide', target: panel, object: this.get(panel), immediate: immediate });
            if (eventData.isCancelled === true) return;

            var p = obj.get(panel);
            if (p === null) return false;
            p.hidden = true;
            if (immediate === true) {
                $('#layout_'+ obj.name +'_panel_'+panel).css({ 'opacity': '0'    });
                $('#layout_'+ obj.name +'_resizer_'+panel).hide();
                obj.trigger($.extend(eventData, { phase: 'after' }));
                obj.resize();
            } else {
                $('#layout_'+ obj.name +'_resizer_'+panel).hide();
                // hide
                $(obj.box).find(' > div > .w2ui-panel').css({
                    '-webkit-transition' : '.2s',
                    '-moz-transition'    : '.2s',
                    '-ms-transition'     : '.2s',
                    '-o-transition'      : '.2s'
                });
                $('#layout_'+ obj.name +'_panel_'+panel).css({ 'opacity': '0'    });
                setTimeout(function () { obj.resize(); }, 1);
                // clean
                setTimeout(function () {
                    $(obj.box).find(' > div > .w2ui-panel').css({
                        '-webkit-transition' : '0s',
                        '-moz-transition'    : '0s',
                        '-ms-transition'     : '0s',
                        '-o-transition'      : '0s'
                    });
                    obj.trigger($.extend(eventData, { phase: 'after' }));
                    obj.resize();
                }, 500);
            }
            return true;
        },

        toggle: function (panel, immediate) {
            var p = this.get(panel);
            if (p === null) return false;
            if (p.hidden) return this.show(panel, immediate); else return this.hide(panel, immediate);
        },

        set: function (panel, options) {
            var obj = this.get(panel, true);
            if (obj === null) return false;
            $.extend(this.panels[obj], options);
            if (typeof options['content'] != 'undefined') this.refresh(panel); // refresh only when content changed
            this.resize(); // resize is needed when panel size is changed
            return true;
        },

        get: function (panel, returnIndex) {
            for (var p in this.panels) {
                if (this.panels[p].type == panel) {
                    if (returnIndex === true) return p; else return this.panels[p];
                }
            }
            return null;
        },

        el: function (panel) {
            var el = $('#layout_'+ this.name +'_panel_'+ panel +'> .w2ui-panel-content');
            if (el.length != 1) return null;
            return el[0];
        },

        hideToolbar: function (panel) {
            var pan = this.get(panel);
            if (!pan) return;
            pan.show.toolbar = false;
            $('#layout_'+ this.name +'_panel_'+ panel +'> .w2ui-panel-toolbar').hide();
            this.resize();
        },

        showToolbar: function (panel) {
            var pan = this.get(panel);
            if (!pan) return;
            pan.show.toolbar = true;
            $('#layout_'+ this.name +'_panel_'+ panel +'> .w2ui-panel-toolbar').show();
            this.resize();
        },

        toggleToolbar: function (panel) {
            var pan = this.get(panel);
            if (!pan) return;
            if (pan.show.toolbar) this.hideToolbar(panel); else this.showToolbar(panel);
        },

        hideTabs: function (panel) {
            var pan = this.get(panel);
            if (!pan) return;
            pan.show.tabs = false;
            $('#layout_'+ this.name +'_panel_'+ panel +'> .w2ui-panel-tabs').hide();
            this.resize();
        },

        showTabs: function (panel) {
            var pan = this.get(panel);
            if (!pan) return;
            pan.show.tabs = true;
            $('#layout_'+ this.name +'_panel_'+ panel +'> .w2ui-panel-tabs').show();
            this.resize();
        },

        toggleTabs: function (panel) {
            var pan = this.get(panel);
            if (!pan) return;
            if (pan.show.tabs) this.hideTabs(panel); else this.showTabs(panel);
        },

        render: function (box) {
            var obj = this;
            // if (window.getSelection) window.getSelection().removeAllRanges(); // clear selection
            var time = (new Date()).getTime();
            // event before
            var eventData = obj.trigger({ phase: 'before', type: 'render', target: obj.name, box: box });
            if (eventData.isCancelled === true) return;

            if (typeof box != 'undefined' && box !== null) {
                if ($(obj.box).find('#layout_'+ obj.name +'_panel_main').length > 0) {
                    $(obj.box)
                        .removeAttr('name')
                        .removeClass('w2ui-layout')
                        .html('');
                }
                obj.box = box;
            }
            if (!obj.box) return false;
            $(obj.box)
                .attr('name', obj.name)
                .addClass('w2ui-layout')
                .html('<div></div>');
            if ($(obj.box).length > 0) $(obj.box)[0].style.cssText += obj.style;
            // create all panels
            for (var p1 in w2layout_panels) {
                p1 = w2layout_panels[p1];
                var pan  = obj.get(p1);
                var html =  '<div id="layout_'+ obj.name + '_panel_'+ p1 +'" class="w2ui-panel">'+
                            '    <div class="w2ui-panel-title"></div>'+
                            '    <div class="w2ui-panel-tabs"></div>'+
                            '    <div class="w2ui-panel-toolbar"></div>'+
                            '    <div class="w2ui-panel-content"></div>'+
                            '</div>'+
                            '<div id="layout_'+ obj.name + '_resizer_'+ p1 +'" class="w2ui-resizer"></div>';
                $(obj.box).find(' > div').append(html);
                // tabs are rendered in refresh()
            }
            $(obj.box).find(' > div')
                .append('<div id="layout_'+ obj.name + '_panel_css" style="position: absolute; top: 10000px;"></div');
            obj.refresh(); // if refresh is not called here, the layout will not be available right after initialization
            // process event
            obj.trigger($.extend(eventData, { phase: 'after' }));
            // reinit events
            setTimeout(function () { // needed this timeout to allow browser to render first if there are tabs or toolbar
                initEvents();
                obj.resize();
            }, 0);
            return (new Date()).getTime() - time;

            function initEvents() {
                obj.tmp.events = {
                    resize : function (event) {
                        w2ui[obj.name].resize();
                    },
                    resizeStart : resizeStart,
                    mouseMove   : resizeMove,
                    mouseUp     : resizeStop
                };
                $(window).on('resize', obj.tmp.events.resize);
            }

            function resizeStart(type, evnt) {
                if (!obj.box) return;
                if (!evnt) evnt = window.event;
                if (!window.addEventListener) { window.document.attachEvent('onselectstart', function() { return false; } ); }
                $(document).off('mousemove', obj.tmp.events.mouseMove).on('mousemove', obj.tmp.events.mouseMove);
                $(document).off('mouseup', obj.tmp.events.mouseUp).on('mouseup', obj.tmp.events.mouseUp);
                obj.tmp.resize = {
                    type    : type,
                    x       : evnt.screenX,
                    y       : evnt.screenY,
                    diff_x  : 0,
                    diff_y  : 0,
                    value   : 0
                };
                // lock all panels
                for (var p1 in w2layout_panels) {
                    p1 = w2layout_panels[p1];
                    obj.lock(p1, { opacity: 0 });
                }
                if (type == 'left' || type == 'right') {
                    obj.tmp.resize.value = parseInt($('#layout_'+ obj.name +'_resizer_'+ type)[0].style.left);
                }
                if (type == 'top' || type == 'preview' || type == 'bottom') {
                    obj.tmp.resize.value = parseInt($('#layout_'+ obj.name +'_resizer_'+ type)[0].style.top);
                }
            }

            function resizeStop(evnt) {
                if (!obj.box) return;
                if (!evnt) evnt = window.event;
                if (!window.addEventListener) { window.document.attachEvent('onselectstart', function() { return false; } ); }
                $(document).off('mousemove', obj.tmp.events.mouseMove);
                $(document).off('mouseup', obj.tmp.events.mouseUp);
                if (typeof obj.tmp.resize == 'undefined') return;
                // unlock all panels
                for (var p1 in w2layout_panels) {
                    obj.unlock(w2layout_panels[p1]);
                }
                // set new size
                if (obj.tmp.diff_x !== 0 || obj.tmp.resize.diff_y !== 0) { // only recalculate if changed
                    var ptop    = obj.get('top');
                    var pbottom = obj.get('bottom');
                    var panel   = obj.get(obj.tmp.resize.type);
                    var height  = parseInt($(obj.box).height());
                    var width   = parseInt($(obj.box).width());
                    var str     = String(panel.size);
                    var ns, nd;
                    switch (obj.tmp.resize.type) {
                        case 'top':
                            ns = parseInt(panel.sizeCalculated) + obj.tmp.resize.diff_y;
                            nd = 0;
                            break;
                        case 'bottom':
                            ns = parseInt(panel.sizeCalculated) - obj.tmp.resize.diff_y;
                            nd = 0;
                            break;
                        case 'preview':
                            ns = parseInt(panel.sizeCalculated) - obj.tmp.resize.diff_y;
                            nd = (ptop && !ptop.hidden ? ptop.sizeCalculated : 0) +
                                (pbottom && !pbottom.hidden ? pbottom.sizeCalculated : 0);
                            break;
                        case 'left':
                            ns = parseInt(panel.sizeCalculated) + obj.tmp.resize.diff_x;
                            nd = 0;
                            break;
                        case 'right':
                            ns = parseInt(panel.sizeCalculated) - obj.tmp.resize.diff_x;
                            nd = 0;
                            break;
                    }
                    // set size
                    if (str.substr(str.length-1) == '%') {
                        panel.size = Math.floor(ns * 100 /
                            (panel.type == 'left' || panel.type == 'right' ? width : height - nd) * 100) / 100 + '%';
                    } else {
                        panel.size = ns;
                    }
                    obj.resize();
                }
                $('#layout_'+ obj.name + '_resizer_'+ obj.tmp.resize.type).removeClass('active');
                delete obj.tmp.resize;
            }

            function resizeMove(evnt) {
                if (!obj.box) return;
                if (!evnt) evnt = window.event;
                if (typeof obj.tmp.resize == 'undefined') return;
                var panel = obj.get(obj.tmp.resize.type);
                // event before
                var tmp = obj.tmp.resize;
                var eventData = obj.trigger({ phase: 'before', type: 'resizing', target: obj.name, object: panel, originalEvent: evnt,
                    panel: tmp ? tmp.type : 'all', diff_x: tmp ? tmp.diff_x : 0, diff_y: tmp ? tmp.diff_y : 0 });
                if (eventData.isCancelled === true) return;

                var p         = $('#layout_'+ obj.name + '_resizer_'+ tmp.type);
                var resize_x  = (evnt.screenX - tmp.x);
                var resize_y  = (evnt.screenY - tmp.y);
                var mainPanel = obj.get('main');

                if (!p.hasClass('active')) p.addClass('active');

                switch (tmp.type) {
                    case 'left':
                        if (panel.minSize - resize_x > panel.width) {
                            resize_x = panel.minSize - panel.width;
                        }
                        if (panel.maxSize && (panel.width + resize_x > panel.maxSize)) {
                            resize_x = panel.maxSize - panel.width;
                        }
                        if (mainPanel.minSize + resize_x > mainPanel.width) {
                            resize_x = mainPanel.width - mainPanel.minSize;
                        }
                        break;

                    case 'right':
                        if (panel.minSize + resize_x > panel.width) {
                            resize_x = panel.width - panel.minSize;
                        }
                        if (panel.maxSize && (panel.width - resize_x > panel.maxSize)) {
                            resize_x = panel.width - panel.maxSize;
                        }
                        if (mainPanel.minSize - resize_x > mainPanel.width) {
                            resize_x = mainPanel.minSize - mainPanel.width;
                        }
                        break;

                    case 'top':
                        if (panel.minSize - resize_y > panel.height) {
                            resize_y = panel.minSize - panel.height;
                        }
                        if (panel.maxSize && (panel.height + resize_y > panel.maxSize)) {
                            resize_y = panel.maxSize - panel.height;
                        }
                        if (mainPanel.minSize + resize_y > mainPanel.height) {
                            resize_y = mainPanel.height - mainPanel.minSize;
                        }
                        break;

                    case 'preview':
                    case 'bottom':
                        if (panel.minSize + resize_y > panel.height) {
                            resize_y = panel.height - panel.minSize;
                        }
                        if (panel.maxSize && (panel.height - resize_y > panel.maxSize)) {
                            resize_y = panel.height - panel.maxSize;
                        }
                        if (mainPanel.minSize - resize_y > mainPanel.height) {
                            resize_y = mainPanel.minSize - mainPanel.height;
                        }
                        break;
                }
                tmp.diff_x = resize_x;
                tmp.diff_y = resize_y;

                switch (tmp.type) {
                    case 'top':
                    case 'preview':
                    case 'bottom':
                        tmp.diff_x = 0;
                        if (p.length > 0) p[0].style.top = (tmp.value + tmp.diff_y) + 'px';
                        break;

                    case 'left':
                    case 'right':
                        tmp.diff_y = 0;
                        if (p.length > 0) p[0].style.left = (tmp.value + tmp.diff_x) + 'px';
                        break;
                }
                // event after
                obj.trigger($.extend(eventData, { phase: 'after' }));
            }
        },

        refresh: function (panel) {
            var obj = this;
            // if (window.getSelection) window.getSelection().removeAllRanges(); // clear selection
            if (typeof panel == 'undefined') panel = null;
            var time = (new Date()).getTime();
            // event before
            var eventData = obj.trigger({ phase: 'before', type: 'refresh', target: (typeof panel != 'undefined' ? panel : obj.name), object: obj.get(panel) });
            if (eventData.isCancelled === true) return;
            // obj.unlock(panel);
            if (typeof panel == 'string') {
                var p = obj.get(panel);
                if (p === null) return;
                var pname = '#layout_'+ obj.name + '_panel_'+ p.type;
                var rname = '#layout_'+ obj.name +'_resizer_'+ p.type;
                // apply properties to the panel
                $(pname).css({ display: p.hidden ? 'none' : 'block' });
                if (p.resizable) $(rname).show(); else $(rname).hide();
                // insert content
                if (typeof p.content == 'object' && typeof p.content.render === 'function') {
                    p.content.box = $(pname +'> .w2ui-panel-content')[0];
                    setTimeout(function () {
                        // need to remove unnecessary classes
                        if ($(pname +'> .w2ui-panel-content').length > 0) {
                            $(pname +'> .w2ui-panel-content')
                                .removeClass()
                                .removeAttr('name')
                                .addClass('w2ui-panel-content')
                                .css('overflow', p.overflow)[0].style.cssText += ';' + p.style;
                        }
                        p.content.render(); // do not do .render(box);
                    }, 1);
                } else {
                    // need to remove unnecessary classes
                    if ($(pname +'> .w2ui-panel-content').length > 0) {
                        $(pname +'> .w2ui-panel-content')
                            .removeClass()
                            .removeAttr('name')
                            .addClass('w2ui-panel-content')
                            .html(p.content)
                            .css('overflow', p.overflow)[0].style.cssText += ';' + p.style;
                    }
                }
                // if there are tabs and/or toolbar - render it
                var tmp = $(obj.box).find(pname +'> .w2ui-panel-tabs');
                if (p.show.tabs) {
                    if (tmp.find('[name='+ p.tabs.name +']').length === 0 && p.tabs !== null) tmp.w2render(p.tabs); else p.tabs.refresh();
                } else {
                    tmp.html('').removeClass('w2ui-tabs').hide();
                }
                tmp = $(obj.box).find(pname +'> .w2ui-panel-toolbar');
                if (p.show.toolbar) {
                    if (tmp.find('[name='+ p.toolbar.name +']').length === 0 && p.toolbar !== null) tmp.w2render(p.toolbar); else p.toolbar.refresh();
                } else {
                    tmp.html('').removeClass('w2ui-toolbar').hide();
                }
                // show title
                tmp = $(obj.box).find(pname +'> .w2ui-panel-title');
                if (p.title) {
                    tmp.html(p.title).show();
                } else {
                    tmp.html('').hide();
                }
            } else {
                if ($('#layout_'+ obj.name +'_panel_main').length == 0) {
                    obj.render();
                    return;
                }
                obj.resize();
                // refresh all of them
                for (var p1 in this.panels) { obj.refresh(this.panels[p1].type); }
            }
            obj.trigger($.extend(eventData, { phase: 'after' }));
            return (new Date()).getTime() - time;
        },

        resize: function () {
            // if (window.getSelection) window.getSelection().removeAllRanges();    // clear selection
            if (!this.box) return false;
            var time = (new Date()).getTime();
            // event before
            var tmp = this.tmp.resize;
            var eventData = this.trigger({ phase: 'before', type: 'resize', target: this.name,
                panel: tmp ? tmp.type : 'all', diff_x: tmp ? tmp.diff_x : 0, diff_y: tmp ? tmp.diff_y : 0  });
            if (eventData.isCancelled === true) return;
            if (this.padding < 0) this.padding = 0;

            // layout itself
            var width  = parseInt($(this.box).width());
            var height = parseInt($(this.box).height());
            $(this.box).find(' > div').css({
                width    : width + 'px',
                height    : height + 'px'
            });
            var obj = this;
            // panels
            var pmain   = this.get('main');
            var pprev   = this.get('preview');
            var pleft   = this.get('left');
            var pright  = this.get('right');
            var ptop    = this.get('top');
            var pbottom = this.get('bottom');
            var smain   = true; // main always on
            var sprev   = (pprev !== null && pprev.hidden !== true ? true : false);
            var sleft   = (pleft !== null && pleft.hidden !== true ? true : false);
            var sright  = (pright !== null && pright.hidden !== true ? true : false);
            var stop    = (ptop !== null && ptop.hidden !== true ? true : false);
            var sbottom = (pbottom !== null && pbottom.hidden !== true ? true : false);
            var l, t, w, h, e;
            // calculate %
            for (var p in w2layout_panels) {
                p = w2layout_panels[p];
                if (p === 'main') continue;
                var tmp = this.get(p);
                if (!tmp) continue;
                var str = String(tmp.size || 0);
                if (str.substr(str.length-1) == '%') {
                    var tmph = height;
                    if (tmp.type == 'preview') {
                        tmph = tmph -
                            (ptop && !ptop.hidden ? ptop.sizeCalculated : 0) -
                            (pbottom && !pbottom.hidden ? pbottom.sizeCalculated : 0);
                    }
                    tmp.sizeCalculated = parseInt((tmp.type == 'left' || tmp.type == 'right' ? width : tmph) * parseFloat(tmp.size) / 100);
                } else {
                    tmp.sizeCalculated = parseInt(tmp.size);
                }
                tmp.sizeCalculated = Math.max(tmp.sizeCalculated, parseInt(tmp.minSize));
            }
            // top if any
            if (ptop !== null && ptop.hidden !== true) {
                l = 0;
                t = 0;
                w = width;
                h = ptop.sizeCalculated;
                $('#layout_'+ this.name +'_panel_top').css({
                    'display': 'block',
                    'left': l + 'px',
                    'top': t + 'px',
                    'width': w + 'px',
                    'height': h + 'px'
                }).show();
                ptop.width  = w;
                ptop.height = h;
                // resizer
                if (ptop.resizable) {
                    t = ptop.sizeCalculated - (this.padding === 0 ? this.resizer : 0);
                    h = (this.resizer > this.padding ? this.resizer : this.padding);
                    $('#layout_'+ this.name +'_resizer_top').show().css({
                        'display': 'block',
                        'left': l + 'px',
                        'top': t + 'px',
                        'width': w + 'px',
                        'height': h + 'px',
                        'cursor': 'ns-resize'
                    }).off('mousedown').on('mousedown', function (event) {
                        // event before
                        var eventData = obj.trigger({ phase: 'before', type: 'resizerClick', target: 'top', originalEvent: event });
                        if (eventData.isCancelled === true) return;
                        // default action
                        w2ui[obj.name].tmp.events.resizeStart('top', event);
                        // event after
                        obj.trigger($.extend(eventData, { phase: 'after' }));
                        return false;
                    });
                }
            } else {
                $('#layout_'+ this.name +'_panel_top').hide();
            }
            // left if any
            if (pleft !== null && pleft.hidden !== true) {
                l = 0;
                t = 0 + (stop ? ptop.sizeCalculated + this.padding : 0);
                w = pleft.sizeCalculated;
                h = height - (stop ? ptop.sizeCalculated + this.padding : 0) -
                        (sbottom ? pbottom.sizeCalculated + this.padding : 0);
                e = $('#layout_'+ this.name +'_panel_left');
                if (window.navigator.userAgent.indexOf('MSIE') != -1 && e.length > 0 && e[0].clientHeight < e[0].scrollHeight) w += 17; // IE hack
                e.css({
                    'display': 'block',
                    'left': l + 'px',
                    'top': t + 'px',
                    'width': w + 'px',
                    'height': h + 'px'
                }).show();
                pleft.width  = w;
                pleft.height = h;
                // resizer
                if (pleft.resizable) {
                    l = pleft.sizeCalculated - (this.padding === 0 ? this.resizer : 0);
                    w = (this.resizer > this.padding ? this.resizer : this.padding);
                    $('#layout_'+ this.name +'_resizer_left').show().css({
                        'display': 'block',
                        'left': l + 'px',
                        'top': t + 'px',
                        'width': w + 'px',
                        'height': h + 'px',
                        'cursor': 'ew-resize'
                    }).off('mousedown').on('mousedown', function (event) {
                        // event before
                        var eventData = obj.trigger({ phase: 'before', type: 'resizerClick', target: 'left', originalEvent: event });
                        if (eventData.isCancelled === true) return;
                        // default action
                        w2ui[obj.name].tmp.events.resizeStart('left', event);
                        // event after
                        obj.trigger($.extend(eventData, { phase: 'after' }));
                        return false;
                    });
                }
            } else {
                $('#layout_'+ this.name +'_panel_left').hide();
                $('#layout_'+ this.name +'_resizer_left').hide();
            }
            // right if any
            if (pright !== null && pright.hidden !== true) {
                l = width - pright.sizeCalculated;
                t = 0 + (stop ? ptop.sizeCalculated + this.padding : 0);
                w = pright.sizeCalculated;
                h = height - (stop ? ptop.sizeCalculated + this.padding : 0) -
                    (sbottom ? pbottom.sizeCalculated + this.padding : 0);
                $('#layout_'+ this.name +'_panel_right').css({
                    'display': 'block',
                    'left': l + 'px',
                    'top': t + 'px',
                    'width': w + 'px',
                    'height': h + 'px'
                }).show();
                pright.width  = w;
                pright.height = h;
                // resizer
                if (pright.resizable) {
                    l = l - this.padding;
                    w = (this.resizer > this.padding ? this.resizer : this.padding);
                    $('#layout_'+ this.name +'_resizer_right').show().css({
                        'display': 'block',
                        'left': l + 'px',
                        'top': t + 'px',
                        'width': w + 'px',
                        'height': h + 'px',
                        'cursor': 'ew-resize'
                    }).off('mousedown').on('mousedown', function (event) {
                        // event before
                        var eventData = obj.trigger({ phase: 'before', type: 'resizerClick', target: 'right', originalEvent: event });
                        if (eventData.isCancelled === true) return;
                        // default action
                        w2ui[obj.name].tmp.events.resizeStart('right', event);
                        // event after
                        obj.trigger($.extend(eventData, { phase: 'after' }));
                        return false;
                    });
                }
            } else {
                $('#layout_'+ this.name +'_panel_right').hide();
            }
            // bottom if any
            if (pbottom !== null && pbottom.hidden !== true) {
                l = 0;
                t = height - pbottom.sizeCalculated;
                w = width;
                h = pbottom.sizeCalculated;
                $('#layout_'+ this.name +'_panel_bottom').css({
                    'display': 'block',
                    'left': l + 'px',
                    'top': t + 'px',
                    'width': w + 'px',
                    'height': h + 'px'
                }).show();
                pbottom.width  = w;
                pbottom.height = h;
                // resizer
                if (pbottom.resizable) {
                    t = t - (this.padding === 0 ? 0 : this.padding);
                    h = (this.resizer > this.padding ? this.resizer : this.padding);
                    $('#layout_'+ this.name +'_resizer_bottom').show().css({
                        'display': 'block',
                        'left': l + 'px',
                        'top': t + 'px',
                        'width': w + 'px',
                        'height': h + 'px',
                        'cursor': 'ns-resize'
                    }).off('mousedown').on('mousedown', function (event) {
                        // event before
                        var eventData = obj.trigger({ phase: 'before', type: 'resizerClick', target: 'bottom', originalEvent: event });
                        if (eventData.isCancelled === true) return;
                        // default action
                        w2ui[obj.name].tmp.events.resizeStart('bottom', event);
                        // event after
                        obj.trigger($.extend(eventData, { phase: 'after' }));
                        return false;
                    });
                }
            } else {
                $('#layout_'+ this.name +'_panel_bottom').hide();
            }
            // main - always there
            l = 0 + (sleft ? pleft.sizeCalculated + this.padding : 0);
            t = 0 + (stop ? ptop.sizeCalculated + this.padding : 0);
            w = width  - (sleft ? pleft.sizeCalculated + this.padding : 0) -
                (sright ? pright.sizeCalculated + this.padding: 0);
            h = height - (stop ? ptop.sizeCalculated + this.padding : 0) -
                (sbottom ? pbottom.sizeCalculated + this.padding : 0) -
                (sprev ? pprev.sizeCalculated + this.padding : 0);
            e = $('#layout_'+ this.name +'_panel_main');
            if (window.navigator.userAgent.indexOf('MSIE') != -1 && e.length > 0 && e[0].clientHeight < e[0].scrollHeight) w += 17; // IE hack
            e.css({
                'display': 'block',
                'left': l + 'px',
                'top': t + 'px',
                'width': w + 'px',
                'height': h + 'px'
            });
            pmain.width  = w;
            pmain.height = h;

            // preview if any
            if (pprev !== null && pprev.hidden !== true) {
                l = 0 + (sleft ? pleft.sizeCalculated + this.padding : 0);
                t = height - (sbottom ? pbottom.sizeCalculated + this.padding : 0) - pprev.sizeCalculated;
                w = width  - (sleft ? pleft.sizeCalculated + this.padding : 0) -
                    (sright ? pright.sizeCalculated + this.padding : 0);
                h = pprev.sizeCalculated;
                e = $('#layout_'+ this.name +'_panel_preview');
                if (window.navigator.userAgent.indexOf('MSIE') != -1 && e.length > 0 && e[0].clientHeight < e[0].scrollHeight) w += 17; // IE hack
                e.css({
                    'display': 'block',
                    'left': l + 'px',
                    'top': t + 'px',
                    'width': w + 'px',
                    'height': h + 'px'
                }).show();
                pprev.width  = w;
                pprev.height = h;
                // resizer
                if (pprev.resizable) {
                    t = t - (this.padding === 0 ? 0 : this.padding);
                    h = (this.resizer > this.padding ? this.resizer : this.padding);
                    $('#layout_'+ this.name +'_resizer_preview').show().css({
                        'display': 'block',
                        'left': l + 'px',
                        'top': t + 'px',
                        'width': w + 'px',
                        'height': h + 'px',
                        'cursor': 'ns-resize'
                    }).off('mousedown').on('mousedown', function (event) {
                        // event before
                        var eventData = obj.trigger({ phase: 'before', type: 'resizerClick', target: 'preview', originalEvent: event });
                        if (eventData.isCancelled === true) return;
                        // default action
                        w2ui[obj.name].tmp.events.resizeStart('preview', event);
                        // event after
                        obj.trigger($.extend(eventData, { phase: 'after' }));
                        return false;
                    });
                }
            } else {
                $('#layout_'+ this.name +'_panel_preview').hide();
            }

            // display tabs and toolbar if needed
            for (var p1 in w2layout_panels) {
                p1 = w2layout_panels[p1];
                var pan = this.get(p1);
                var tmp2 = '#layout_'+ this.name +'_panel_'+ p1 +' > .w2ui-panel-';
                var tabHeight = 0;
                if (pan) {
                    if (pan.title) {
                        tabHeight += w2utils.getSize($(tmp2 + 'title').css({ top: tabHeight + 'px', display: 'block' }), 'height');
                    }
                    if (pan.show.tabs) {
                        if (pan.tabs !== null && w2ui[this.name +'_'+ p1 +'_tabs']) w2ui[this.name +'_'+ p1 +'_tabs'].resize();
                        tabHeight += w2utils.getSize($(tmp2 + 'tabs').css({ top: tabHeight + 'px', display: 'block' }), 'height');
                    }
                    if (pan.show.toolbar) {
                        if (pan.toolbar !== null && w2ui[this.name +'_'+ p1 +'_toolbar']) w2ui[this.name +'_'+ p1 +'_toolbar'].resize();
                        tabHeight += w2utils.getSize($(tmp2 + 'toolbar').css({ top: tabHeight + 'px', display: 'block' }), 'height');
                    }
                }
                $(tmp2 + 'content').css({ display: 'block' }).css({ top: tabHeight + 'px' });
            }
            // send resize to all objects
            clearTimeout(this._resize_timer);
            this._resize_timer = setTimeout(function () {
                for (var e in w2ui) {
                    if (typeof w2ui[e].resize == 'function') {
                        // sent to all none-layouts
                        if (w2ui[e].panels == 'undefined') w2ui[e].resize();
                        // only send to nested layouts
                        var parent = $(w2ui[e].box).parents('.w2ui-layout');
                        if (parent.length > 0 && parent.attr('name') == obj.name) w2ui[e].resize();
                    }
                }
            }, 100);
            this.trigger($.extend(eventData, { phase: 'after' }));
            return (new Date()).getTime() - time;
        },

        destroy: function () {
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'destroy', target: this.name });
            if (eventData.isCancelled === true) return;
            if (typeof w2ui[this.name] == 'undefined') return false;
            // clean up
            if ($(this.box).find('#layout_'+ this.name +'_panel_main').length > 0) {
                $(this.box)
                    .removeAttr('name')
                    .removeClass('w2ui-layout')
                    .html('');
            }
            delete w2ui[this.name];
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            if (this.tmp.events && this.tmp.events.resize) $(window).off('resize', this.tmp.events.resize);
            return true;
        },

        lock: function (panel, msg, showSpinner) {
            if (w2layout_panels.indexOf(panel) == -1) {
                console.log('ERROR: First parameter needs to be the a valid panel name.');
                return;
            }
            var args = Array.prototype.slice.call(arguments, 0);
            args[0]  = '#layout_'+ this.name + '_panel_' + panel;
            w2utils.lock.apply(window, args);
        },

        unlock: function (panel) {
            if (w2layout_panels.indexOf(panel) == -1) {
                console.log('ERROR: First parameter needs to be the a valid panel name.');
                return;
            }
            var nm = '#layout_'+ this.name + '_panel_' + panel;
            w2utils.unlock(nm);
        }
    };

    $.extend(w2layout.prototype, w2utils.event);
    w2obj.layout = w2layout;
})();

/************************************************************************
*   Library: Web 2.0 UI for jQuery (using prototypical inheritance)
*   - Following objects defined
*        - w2popup      - popup widget
*        - $().w2popup  - jQuery wrapper
*   - Dependencies: jQuery, w2utils
*
* == NICE TO HAVE ==
*   - transition should include title, body and buttons, not just body
*
************************************************************************/

var w2popup = {};

(function () {

    // ====================================================
    // -- Registers as a jQuery plugin

    $.fn.w2popup = function(method, options) {
        if (typeof method === 'undefined') {
            options = {};
            method  = 'open';
        }
        if ($.isPlainObject(method)) {
            options = method;
            method  = 'open';
        }
        method = method.toLowerCase();
        if (method === 'load' && typeof options === 'string') {
            options = $.extend({ url: options }, arguments.length > 2 ? arguments[2] : {});
        }
        if (method === 'open' && options.url != null) method = 'load';
        options = options || {};
        // load options from markup
        var dlgOptions = {};
        if ($(this).length > 0) {
            if ($(this).find('div[rel=title], div[rel=body], div[rel=buttons]').length > 0) {
                if ($(this).find('div[rel=title]').length > 0) {
                    dlgOptions['title'] = $(this).find('div[rel=title]').html();
                }
                if ($(this).find('div[rel=body]').length > 0) {
                    dlgOptions['body']  = $(this).find('div[rel=body]').html();
                    dlgOptions['style'] = $(this).find('div[rel=body]')[0].style.cssText;
                }
                if ($(this).find('div[rel=buttons]').length > 0) {
                    dlgOptions['buttons'] = $(this).find('div[rel=buttons]').html();
                }
            } else {
                dlgOptions['title'] = '&nbsp;';
                dlgOptions['body']  = $(this).html();
            }
            if (parseInt($(this).css('width')) != 0)  dlgOptions['width']  = parseInt($(this).css('width'));
            if (parseInt($(this).css('height')) != 0) dlgOptions['height'] = parseInt($(this).css('height'));
        }
        // show popup
        return w2popup[method]($.extend({}, dlgOptions, options));
    };

    // ====================================================
    // -- Implementation of core functionality (SINGELTON)

    w2popup = {
        defaults: {
            title     : '',
            body      : '',
            buttons   : '',
            style     : '',
            color     : '#000',
            opacity   : 0.4,
            speed     : 0.3,
            modal     : false,
            maximized : false,
            keyboard  : true,     // will close popup on esc if not modal
            width     : 500,
            height    : 300,
            showClose : true,
            showMax   : false,
            transition: null
        },
        status    : 'closed',     // string that describes current status
        handlers  : [],
        onOpen    : null,
        onClose   : null,
        onMax     : null,
        onMin     : null,
        onToggle  : null,
        onKeydown : null,

        open: function (options) {
            var obj = this;
            if (w2popup.status == 'closing') {
                setTimeout(function () { obj.open.call(obj, options); }, 100);
                return;
            }
            // get old options and merge them
            var old_options = $('#w2ui-popup').data('options');
            var options = $.extend({}, this.defaults, old_options, { title: '', body : '', buttons: '' }, options, { maximized: false });
            // need timer because popup might not be open
            setTimeout(function () { $('#w2ui-popup').data('options', options); }, 100);
            // if new - reset event handlers
            if ($('#w2ui-popup').length == 0) {
                w2popup.handlers  = [];
                w2popup.onMax     = null;
                w2popup.onMin     = null;
                w2popup.onToggle  = null;
                w2popup.onOpen    = null;
                w2popup.onClose   = null;
                w2popup.onKeydown = null;
            }
            if (options.onOpen)    w2popup.onOpen    = options.onOpen;
            if (options.onClose)   w2popup.onClose   = options.onClose;
            if (options.onMax)     w2popup.onMax     = options.onMax;
            if (options.onMin)     w2popup.onMin     = options.onMin;
            if (options.onToggle)  w2popup.onToggle  = options.onToggle;
            if (options.onKeydown) w2popup.onKeydown = options.onKeydown;

            if (window.innerHeight == undefined) {
                var width  = document.documentElement.offsetWidth;
                var height = document.documentElement.offsetHeight;
                if (w2utils.engine === 'IE7') { width += 21; height += 4; }
            } else {
                var width  = window.innerWidth;
                var height = window.innerHeight;
            }
            if (parseInt(width)  - 10 < parseInt(options.width))  options.width  = parseInt(width)  - 10;
            if (parseInt(height) - 10 < parseInt(options.height)) options.height = parseInt(height) - 10;
            var top  = parseInt(((parseInt(height) - parseInt(options.height)) / 2) * 0.6);
            var left = parseInt((parseInt(width) - parseInt(options.width)) / 2);
            // check if message is already displayed
            if ($('#w2ui-popup').length == 0) {
                // trigger event
                var eventData = this.trigger({ phase: 'before', type: 'open', target: 'popup', options: options, present: false });
                if (eventData.isCancelled === true) return;
                w2popup.status = 'opening';
                // output message
                w2popup.lockScreen(options);
                var btn = '';
                if (options.showClose) {
                    btn += '<div class="w2ui-msg-button w2ui-msg-close" onmousedown="event.stopPropagation()" onclick="w2popup.close()">Close</div>';
                }
                if (options.showMax) {
                    btn += '<div class="w2ui-msg-button w2ui-msg-max" onmousedown="event.stopPropagation()" onclick="w2popup.toggle()">Max</div>';
                }
                var msg='<div id="w2ui-popup" class="w2ui-popup" style="opacity: 0; left: '+ left +'px; top: '+ top +'px;'+
                        '     width: ' + parseInt(options.width) + 'px; height: ' + parseInt(options.height) + 'px; '+
                        '    -webkit-transform: scale(0.8); -moz-transform: scale(0.8); -ms-transform: scale(0.8); -o-transform: scale(0.8); "'+
                        '>'+
                        '   <div class="w2ui-msg-title" style="'+ (options.title == '' ? 'display: none' : '') +'">' + btn + options.title + '</div>'+
                        '   <div class="w2ui-box1" style="'+ (options.title == '' ? 'top: 0px !important;' : '') + 
                                    (options.buttons == '' ? 'bottom: 0px !important;' : '') + '">'+
                        '       <div class="w2ui-msg-body' + (!options.title != '' ? ' w2ui-msg-no-title' : '') + 
                                    (!options.buttons != '' ? ' w2ui-msg-no-buttons' : '') + '" style="' + options.style + '">' + options.body + '</div>'+
                        '   </div>'+
                        '   <div class="w2ui-box2" style="' + (options.title == '' ? 'top: 0px !important;' : '') +
                                    (options.buttons == '' ? 'bottom: 0px !important;' : '') + '">'+
                        '       <div class="w2ui-msg-body' + (!options.title != '' ? ' w2ui-msg-no-title' : '') + 
                                    (!options.buttons != '' ? ' w2ui-msg-no-buttons' : '') + '" style="' + options.style + '"></div>'+
                        '       </div>'+
                        '   <div class="w2ui-msg-buttons" style="'+ (options.buttons == '' ? 'display: none' : '') +'">' + options.buttons + '</div>'+
                        '</div>';
                $('body').append(msg);
                // allow element to render
                setTimeout(function () {
                    $('#w2ui-popup .w2ui-box2').hide();
                    $('#w2ui-popup').css({
                        '-webkit-transition': options.speed + 's opacity, ' + options.speed + 's -webkit-transform',
                        '-webkit-transform': 'scale(1)',
                        '-moz-transition': options.speed + 's opacity, ' + options.speed + 's -moz-transform',
                        '-moz-transform': 'scale(1)',
                        '-ms-transition': options.speed + 's opacity, ' + options.speed + 's -ms-transform',
                        '-ms-transform': 'scale(1)',
                        '-o-transition': options.speed + 's opacity, ' + options.speed + 's -o-transform',
                        '-o-transform': 'scale(1)',
                        'opacity': '1'
                    });
                }, 1);
                // clean transform
                setTimeout(function () {
                    $('#w2ui-popup').css({
                        '-webkit-transform': '',
                        '-moz-transform': '',
                        '-ms-transform': '',
                        '-o-transform': ''
                    });
                    // event after
                    w2popup.status = 'open';
                    setTimeout(function () {
                        obj.trigger($.extend(eventData, { phase: 'after' }));
                    }, 100);
                }, options.speed * 1000);
            } else {
                // trigger event
                var eventData = this.trigger({ phase: 'before', type: 'open', target: 'popup', options: options, present: true });
                if (eventData.isCancelled === true) return;
                // check if size changed
                w2popup.status = 'opening';
                if (typeof old_options == 'undefined' || old_options['width'] != options['width'] || old_options['height'] != options['height']) {
                    w2popup.resize(options.width, options.height);
                }
                if (typeof old_options != 'undefined') {
                    options.prevSize  = options.width + ':' + options.height;
                    options.maximized = old_options.maximized;
                }
                // show new items
                var body = $('#w2ui-popup .w2ui-box2 > .w2ui-msg-body').html(options.body);
                if (body.length > 0) body[0].style.cssText = options.style;
                if (options.buttons != '') {
                    $('#w2ui-popup .w2ui-msg-buttons').show().html(options.buttons);
                    $('#w2ui-popup .w2ui-msg-body').removeClass('w2ui-msg-no-buttons');
                    $('#w2ui-popup .w2ui-box1, #w2ui-popup .w2ui-box2').css('bottom', '');
                } else {
                    $('#w2ui-popup .w2ui-msg-buttons').hide().html('');
                    $('#w2ui-popup .w2ui-msg-body').addClass('w2ui-msg-no-buttons');
                    $('#w2ui-popup .w2ui-box1, #w2ui-popup .w2ui-box2').css('bottom', '0px');
                }
                if (options.title != '') {
                    $('#w2ui-popup .w2ui-msg-title').show().html(
                          (options.showClose ? '<div class="w2ui-msg-button w2ui-msg-close" onmousedown="event.stopPropagation()" onclick="w2popup.close()">Close</div>' : '') +
                          (options.showMax ? '<div class="w2ui-msg-button w2ui-msg-max" onmousedown="event.stopPropagation()" onclick="w2popup.toggle()">Max</div>' : '') +
                          options.title);
                    $('#w2ui-popup .w2ui-msg-body').removeClass('w2ui-msg-no-title');
                    $('#w2ui-popup .w2ui-box1, #w2ui-popup .w2ui-box2').css('top', '');
                } else {
                    $('#w2ui-popup .w2ui-msg-title').hide().html('');
                    $('#w2ui-popup .w2ui-msg-body').addClass('w2ui-msg-no-title');
                    $('#w2ui-popup .w2ui-box1, #w2ui-popup .w2ui-box2').css('top', '0px');
                }
                // transition
                var div_old = $('#w2ui-popup .w2ui-box1')[0];
                var div_new = $('#w2ui-popup .w2ui-box2')[0];
                w2utils.transition(div_old, div_new, options.transition);
                div_new.className = 'w2ui-box1';
                div_old.className = 'w2ui-box2';
                $(div_new).addClass('w2ui-current-box');
                // remove max state
                $('#w2ui-popup').data('prev-size', null);
                // call event onChange
                setTimeout(function () {
                    w2popup.status = 'open';
                    obj.trigger($.extend(eventData, { phase: 'after' }));
                }, 100);
            }
            // save new options
            options._last_w2ui_name = w2utils.keyboard.active();
            w2utils.keyboard.active(null);
            // keyboard events
            if (options.keyboard) $(document).on('keydown', this.keydown);

            // initialize move
            var tmp = {
                resizing : false,
                mvMove   : mvMove,
                mvStop   : mvStop
            };
            $('#w2ui-popup .w2ui-msg-title').on('mousedown', function (event) { mvStart(event); })

            // handlers
            function mvStart(evnt) {
                if (!evnt) evnt = window.event;
                if (!window.addEventListener) { window.document.attachEvent('onselectstart', function() { return false; } ); }
                w2popup.status = 'moving';
                tmp.resizing = true;
                tmp.x = evnt.screenX;
                tmp.y = evnt.screenY;
                tmp.pos_x = $('#w2ui-popup').position().left;
                tmp.pos_y = $('#w2ui-popup').position().top;
                w2popup.lock({ opacity: 0 });
                $(document).on('mousemove', tmp.mvMove);
                $(document).on('mouseup', tmp.mvStop);
                if (evnt.stopPropagation) evnt.stopPropagation(); else evnt.cancelBubble = true;
                if (evnt.preventDefault) evnt.preventDefault(); else return false;
            }

            function mvMove(evnt) {
                if (tmp.resizing != true) return;
                if (!evnt) evnt = window.event;
                tmp.div_x = evnt.screenX - tmp.x;
                tmp.div_y = evnt.screenY - tmp.y;
                $('#w2ui-popup').css({
                    '-webkit-transition': 'none',
                    '-webkit-transform': 'translate3d('+ tmp.div_x +'px, '+ tmp.div_y +'px, 0px)',
                    '-moz-transition': 'none',
                    '-moz-transform': 'translate('+ tmp.div_x +'px, '+ tmp.div_y +'px)',
                    '-ms-transition': 'none',
                    '-ms-transform': 'translate('+ tmp.div_x +'px, '+ tmp.div_y +'px)',
                    '-o-transition': 'none',
                    '-o-transform': 'translate('+ tmp.div_x +'px, '+ tmp.div_y +'px)'
                });
            }

            function mvStop(evnt) {
                if (tmp.resizing != true) return;
                if (!evnt) evnt = window.event;
                w2popup.status = 'open';
                tmp.div_x = (evnt.screenX - tmp.x);
                tmp.div_y = (evnt.screenY - tmp.y);
                $('#w2ui-popup').css({
                    'left': (tmp.pos_x + tmp.div_x) + 'px',
                    'top':    (tmp.pos_y  + tmp.div_y) + 'px',
                    '-webkit-transition': 'none',
                    '-webkit-transform': 'translate3d(0px, 0px, 0px)',
                    '-moz-transition': 'none',
                    '-moz-transform': 'translate(0px, 0px)',
                    '-ms-transition': 'none',
                    '-ms-transform': 'translate(0px, 0px)',
                    '-o-transition': 'none',
                    '-o-transform': 'translate(0px, 0px)'
                });
                tmp.resizing = false;
                $(document).off('mousemove', tmp.mvMove);
                $(document).off('mouseup', tmp.mvStop);
                w2popup.unlock();
            }
            return this;
        },

        keydown: function (event) {
            var options = $('#w2ui-popup').data('options');
            if (!options.keyboard) return;
            // trigger event
            var eventData = w2popup.trigger({ phase: 'before', type: 'keydown', target: 'popup', options: options, originalEvent: event });
            if (eventData.isCancelled === true) return;
            // default behavior
            switch (event.keyCode) {
                case 27:
                    event.preventDefault();
                    if ($('#w2ui-popup .w2ui-popup-message').length > 0) w2popup.message(); else w2popup.close();
                    break;
            }
            // event after
            w2popup.trigger($.extend(eventData, { phase: 'after'}));
        },

        close: function (options) {
            var obj = this;
            var options = $.extend({}, $('#w2ui-popup').data('options'), options);
            if ($('#w2ui-popup').length == 0) return;
            // trigger event
            var eventData = this.trigger({ phase: 'before', type: 'close', target: 'popup', options: options });
            if (eventData.isCancelled === true) return;
            // default behavior
            w2popup.status = 'closing';
            $('#w2ui-popup').css({
                '-webkit-transition': options.speed + 's opacity, ' + options.speed + 's -webkit-transform',
                '-webkit-transform': 'scale(0.9)',
                '-moz-transition': options.speed + 's opacity, ' + options.speed + 's -moz-transform',
                '-moz-transform': 'scale(0.9)',
                '-ms-transition': options.speed + 's opacity, ' + options.speed + 's -ms-transform',
                '-ms-transform': 'scale(0.9)',
                '-o-transition': options.speed + 's opacity, ' + options.speed + 's -o-transform',
                '-o-transform': 'scale(0.9)',
                'opacity': '0'
            });
            w2popup.unlockScreen(options);
            setTimeout(function () {
                $('#w2ui-popup').remove();
                w2popup.status = 'closed';
                // event after
                obj.trigger($.extend(eventData, { phase: 'after'}));
            }, options.speed * 1000);
            // restore active
            w2utils.keyboard.active(options._last_w2ui_name);
            // remove keyboard events
            if (options.keyboard) $(document).off('keydown', this.keydown);
        },

        toggle: function () {
            var obj     = this;
            var options = $('#w2ui-popup').data('options');
            // trigger event
            var eventData = this.trigger({ phase: 'before', type: 'toggle', target: 'popup', options: options });
            if (eventData.isCancelled === true) return;
            // defatul action
            if (options.maximized === true) w2popup.min(); else w2popup.max();
            // event after
            setTimeout(function () {
                obj.trigger($.extend(eventData, { phase: 'after'}));
            }, (options.speed * 1000) + 50);
        },

        max: function () {
            var obj = this;
            var options = $('#w2ui-popup').data('options');
            if (options.maximized === true) return;
            // trigger event
            var eventData = this.trigger({ phase: 'before', type: 'max', target: 'popup', options: options });
            if (eventData.isCancelled === true) return;
            // default behavior
            w2popup.status   = 'resizing';
            options.prevSize = $('#w2ui-popup').css('width') + ':' + $('#w2ui-popup').css('height');
            // do resize
            w2popup.resize(10000, 10000, function () {
                w2popup.status    = 'open';
                options.maximized = true;
                obj.trigger($.extend(eventData, { phase: 'after'}));
            });
        },

        min: function () {
            var obj = this;
            var options = $('#w2ui-popup').data('options');
            if (options.maximized !== true) return;
            var size = options.prevSize.split(':');
            // trigger event
            var eventData = this.trigger({ phase: 'before', type: 'min', target: 'popup', options: options });
            if (eventData.isCancelled === true) return;
            // default behavior
            w2popup.status = 'resizing';
            // do resize
            w2popup.resize(size[0], size[1], function () {
                w2popup.status = 'open';
                options.maximized = false;
                options.prevSize  = null;
                obj.trigger($.extend(eventData, { phase: 'after'}));
            });
        },

        get: function () {
            return $('#w2ui-popup').data('options');
        },

        set: function (options) {
            w2popup.open(options);
        },

        clear: function() {
            $('#w2ui-popup .w2ui-msg-title').html('');
            $('#w2ui-popup .w2ui-msg-body').html('');
            $('#w2ui-popup .w2ui-msg-buttons').html('');
        },

        reset: function () {
            w2popup.open(w2popup.defaults);
        },

        load: function (options) {
            w2popup.status = 'loading';
            if (String(options.url) == 'undefined') {
                console.log('ERROR: The url parameter is empty.');
                return;
            }
            var tmp = String(options.url).split('#');
            var url = tmp[0];
            var selector = tmp[1];
            if (String(options) == 'undefined') options = {};
            // load url
            var html = $('#w2ui-popup').data(url);
            if (typeof html != 'undefined' && html != null) {
                popup(html, selector);
            } else {
                $.get(url, function (data, status, obj) { // should always be $.get as it is template
                    popup(obj.responseText, selector);
                    $('#w2ui-popup').data(url, obj.responseText); // remember for possible future purposes
                });
            }
            function popup(html, selector) {
                delete options.url;
                $('body').append('<div id="w2ui-tmp" style="display: none">' + html + '</div>');
                if (typeof selector != 'undefined' && $('#w2ui-tmp #'+selector).length > 0) {
                    $('#w2ui-tmp #' + selector).w2popup(options);
                } else {
                    $('#w2ui-tmp > div').w2popup(options);
                }
                // link styles
                if ($('#w2ui-tmp > style').length > 0) {
                    var style = $('<div>').append($('#w2ui-tmp > style').clone()).html();
                    if ($('#w2ui-popup #div-style').length == 0) {
                        $('#w2ui-popup').append('<div id="div-style" style="position: absolute; left: -100; width: 1px"></div>');
                    }
                    $('#w2ui-popup #div-style').html(style);
                }
                $('#w2ui-tmp').remove();
            }
        },

        message: function (options) {
            $().w2tag(); // hide all tags
            if (!options) options = { width: 200, height: 100 };
            if (parseInt(options.width) < 10)  options.width  = 10;
            if (parseInt(options.height) < 10) options.height = 10;
            if (typeof options.hideOnClick == 'undefined') options.hideOnClick = false;
            var poptions = $('#w2ui-popup').data('options') || {};
            if (typeof options.width == 'undefined' || options.width > poptions.width - 10) options.width = poptions.width - 10;
            if (typeof options.height == 'undefined' || options.height > poptions.height - 40) options.height = poptions.height - 40; // title is 30px or so

            var head     = $('#w2ui-popup .w2ui-msg-title');
            var pwidth   = parseInt($('#w2ui-popup').width());
            var msgCount = $('#w2ui-popup .w2ui-popup-message').length;
            // remove message
            if ($.trim(options.html) == '') {
                $('#w2ui-popup #w2ui-message'+ (msgCount-1)).css('z-Index', 250);
                var options = $('#w2ui-popup #w2ui-message'+ (msgCount-1)).data('options') || {};
                $('#w2ui-popup #w2ui-message'+ (msgCount-1)).remove();
                if (typeof options.onClose == 'function') options.onClose();
                if (msgCount == 1) {
                    w2popup.unlock();
                } else {
                    $('#w2ui-popup #w2ui-message'+ (msgCount-2)).show();
                }
            } else {
                // hide previous messages
                $('#w2ui-popup .w2ui-popup-message').hide();
                // add message
                $('#w2ui-popup .w2ui-box1')
                    .before('<div id="w2ui-message' + msgCount + '" class="w2ui-popup-message" style="display: none; ' +
                                (head.length == 0 ? 'top: 0px;' : 'top: ' + w2utils.getSize(head, 'height') + 'px;') +
                                (typeof options.width  != 'undefined' ? 'width: ' + options.width + 'px; left: ' + ((pwidth - options.width) / 2) + 'px;' : 'left: 10px; right: 10px;') +
                                (typeof options.height != 'undefined' ? 'height: ' + options.height + 'px;' : 'bottom: 6px;') +
                                '-webkit-transition: .3s; -moz-transition: .3s; -ms-transition: .3s; -o-transition: .3s;"' +
                                (options.hideOnClick === true ? 'onclick="w2popup.message();"' : '') + '>' +
                            '</div>');
                $('#w2ui-popup #w2ui-message'+ msgCount).data('options', options);
                var display = $('#w2ui-popup #w2ui-message'+ msgCount).css('display');
                $('#w2ui-popup #w2ui-message'+ msgCount).css({
                    '-webkit-transform': (display == 'none' ? 'translateY(-' + options.height + 'px)' : 'translateY(0px)'),
                    '-moz-transform': (display == 'none' ? 'translateY(-' + options.height + 'px)' : 'translateY(0px)'),
                    '-ms-transform': (display == 'none' ? 'translateY(-' + options.height + 'px)' : 'translateY(0px)'),
                    '-o-transform': (display == 'none' ? 'translateY(-' + options.height + 'px)' : 'translateY(0px)')
                });
                if (display == 'none') {
                    $('#w2ui-popup #w2ui-message'+ msgCount).show().html(options.html);
                    // timer needs to animation
                    setTimeout(function () {
                        $('#w2ui-popup #w2ui-message'+ msgCount).css({
                            '-webkit-transform': (display == 'none' ? 'translateY(0px)' : 'translateY(-' + options.height + 'px)'),
                            '-moz-transform': (display == 'none' ? 'translateY(0px)' : 'translateY(-' + options.height + 'px)'),
                            '-ms-transform': (display == 'none' ? 'translateY(0px)' : 'translateY(-' + options.height + 'px)'),
                            '-o-transform': (display == 'none' ? 'translateY(0px)' : 'translateY(-' + options.height + 'px)')
                        });
                    }, 1);
                    // timer for lock
                    setTimeout(function() {
                        $('#w2ui-popup #w2ui-message'+ msgCount).css({
                            '-webkit-transition': '0s',    '-moz-transition': '0s', '-ms-transition': '0s', '-o-transition': '0s',
                            'z-Index': 1500
                        }); // has to be on top of lock
                        if (msgCount == 0) w2popup.lock();
                        if (typeof options.onOpen == 'function') options.onOpen();
                    }, 300);
                }
            }
        },

        lock: function (msg, showSpinner) {
            var args = Array.prototype.slice.call(arguments, 0);
            args.unshift($('#w2ui-popup'));
            w2utils.lock.apply(window, args);
        },

        unlock: function () {
            w2utils.unlock($('#w2ui-popup'));
        },

        // --- INTERNAL FUNCTIONS

        lockScreen: function (options) {
            if ($('#w2ui-lock').length > 0) return false;
            if (typeof options == 'undefined') options = $('#w2ui-popup').data('options');
            if (typeof options == 'undefined') options = {};
            options = $.extend({}, w2popup.defaults, options);
            // show element
            $('body').append('<div id="w2ui-lock" ' +
                '    onmousewheel="if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true; if (event.preventDefault) event.preventDefault(); else return false;"'+
                '    style="position: ' + (w2utils.engine == 'IE5' ? 'absolute' : 'fixed') + '; z-Index: 1199; left: 0px; top: 0px; ' +
                '           padding: 0px; margin: 0px; background-color: ' + options.color + '; width: 100%; height: 100%; opacity: 0;"></div>');
            // lock screen
            setTimeout(function () {
                $('#w2ui-lock').css({
                    '-webkit-transition': options.speed + 's opacity',
                    '-moz-transition': options.speed + 's opacity',
                    '-ms-transition': options.speed + 's opacity',
                    '-o-transition': options.speed + 's opacity',
                    'opacity': options.opacity
                });
            }, 1);
            // add events
            if (options.modal == true) {
                $('#w2ui-lock').on('mousedown', function () {
                    $('#w2ui-lock').css({
                        '-webkit-transition': '.1s',
                        '-moz-transition': '.1s',
                        '-ms-transition': '.1s',
                        '-o-transition': '.1s',
                        'opacity': '0.6'
                    });
                    // if (window.getSelection) window.getSelection().removeAllRanges();
                });
                $('#w2ui-lock').on('mouseup', function () {
                    setTimeout(function () {
                        $('#w2ui-lock').css({
                            '-webkit-transition': '.1s',
                            '-moz-transition': '.1s',
                            '-ms-transition': '.1s',
                            '-o-transition': '.1s',
                            'opacity': options.opacity
                        });
                    }, 100);
                    // if (window.getSelection) window.getSelection().removeAllRanges();
                });
            } else {
                $('#w2ui-lock').on('mouseup', function () { w2popup.close(); });
            }
            return true;
        },

        unlockScreen: function (options) {
            if ($('#w2ui-lock').length == 0) return false;
            if (typeof options == 'undefined') options = $('#w2ui-popup').data('options');
            if (typeof options == 'undefined') options = {};
            options = $.extend({}, w2popup.defaults, options);
            $('#w2ui-lock').css({
                '-webkit-transition': options.speed + 's opacity',
                '-moz-transition': options.speed + 's opacity',
                '-ms-transition': options.speed + 's opacity',
                '-o-transition': options.speed + 's opacity',
                'opacity': 0
            });
            setTimeout(function () {
                $('#w2ui-lock').remove();
            }, options.speed * 1000);
            return true;
        },

        resize: function (width, height, callBack) {
            var options = $('#w2ui-popup').data('options');
            // calculate new position
            if (parseInt($(window).width())  - 10 < parseInt(width))  width  = parseInt($(window).width())  - 10;
            if (parseInt($(window).height()) - 10 < parseInt(height)) height = parseInt($(window).height()) - 10;
            var top  = ((parseInt($(window).height()) - parseInt(height)) / 2) * 0.8;
            var left = (parseInt($(window).width()) - parseInt(width)) / 2;
            // resize there
            $('#w2ui-popup').css({
                '-webkit-transition': options.speed + 's width, ' + options.speed + 's height, ' + options.speed + 's left, ' + options.speed + 's top',
                '-moz-transition': options.speed + 's width, ' + options.speed + 's height, ' + options.speed + 's left, ' + options.speed + 's top',
                '-ms-transition': options.speed + 's width, ' + options.speed + 's height, ' + options.speed + 's left, ' + options.speed + 's top',
                '-o-transition': options.speed + 's width, ' + options.speed + 's height, ' + options.speed + 's left, ' + options.speed + 's top',
                'top': top,
                'left': left,
                'width': width,
                'height': height
            });
            setTimeout(function () {
                options.width  = width;
                options.height = height;
                if (typeof callBack == 'function') callBack();
            }, (options.speed * 1000) + 50); // give extra 50 ms
        }
    }

    // merge in event handling
    $.extend(w2popup, w2utils.event);

})();

// ============================================
// --- Common dialogs

var w2alert = function (msg, title, callBack) {
    if (title == null) title = w2utils.lang('Notification');
    if ($('#w2ui-popup').length > 0 && w2popup.status != 'closing') {
        w2popup.message({
            width   : 400,
            height  : 170,
            html    : '<div style="position: absolute; top: 0px; left: 0px; right: 0px; bottom: 45px; overflow: auto">' +
                      '        <div class="w2ui-centered" style="font-size: 13px;">' + msg + '</div>' +
                      '</div>' +
                      '<div style="position: absolute; bottom: 7px; left: 0px; right: 0px; text-align: center; padding: 5px">' +
                      '        <button onclick="w2popup.message();" class="w2ui-popup-btn btn">' + w2utils.lang('Ok') + '</button>' +
                      '</div>',
            onClose : function () {
                if (typeof callBack == 'function') callBack();
            }
        });
    } else {
        w2popup.open({
            width     : 450,
            height    : 220,
            showMax   : false,
            showClose : false,
            title     : title,
            body      : '<div class="w2ui-centered" style="font-size: 13px;">' + msg + '</div>',
            buttons   : '<button onclick="w2popup.close();" class="w2ui-popup-btn btn">' + w2utils.lang('Ok') + '</button>',
            onClose   : function () {
                if (typeof callBack == 'function') callBack();
            }
        });
    }
};

var w2confirm = function (msg, title, callBack) {
    var options  = {};
    var defaults = {
        msg         : '',
        title       : w2utils.lang('Confirmation'),
        width       : ($('#w2ui-popup').length > 0 ? 400 : 450),
        height      : ($('#w2ui-popup').length > 0 ? 170 : 220),
        yes_text    : 'Yes',
        yes_class   : '',
        yes_style   : '',
        yes_callBack: null,
        no_text     : 'No',
        no_class    : '',
        no_style    : '',
        no_callBack : null,
        callBack    : null
    };
    if (arguments.length == 1 && typeof msg == 'object') {
        $.extend(options, defaults, msg);
    } else {
        if (typeof title == 'function') {
            $.extend(options, defaults, {
                msg     : msg,
                callBack: title
            })            
        } else {
            $.extend(options, defaults, {
                msg     : msg,
                title   : title, 
                callBack: callBack
            })            
        }
    }
    if ($('#w2ui-popup').length > 0 && w2popup.status != 'closing') {
        if (options.width > w2popup.get().width) options.width = w2popup.get().width;
        if (options.height > (w2popup.get().height - 50)) options.height = w2popup.get().height - 50;
          w2popup.message({
            width   : options.width,
            height  : options.height,
            html    : '<div style="position: absolute; top: 0px; left: 0px; right: 0px; bottom: 40px; overflow: auto">' +
                      '        <div class="w2ui-centered" style="font-size: 13px;">' + options.msg + '</div>' +
                      '</div>' +
                      '<div style="position: absolute; bottom: 7px; left: 0px; right: 0px; text-align: center; padding: 5px">' +
                      '        <button id="Yes" class="w2ui-popup-btn btn '+ options.yes_class +'" style="'+ options.yes_style +'">' + w2utils.lang(options.yes_text) + '</button>' +
                      '        <button id="No" class="w2ui-popup-btn btn '+ options.no_class +'" style="'+ options.no_style +'">' + w2utils.lang(options.no_text) + '</button>' +
                      '</div>',
            onOpen: function () {
                $('#w2ui-popup .w2ui-popup-message .btn').on('click', function (event) {
                    w2popup.message();
                    if (typeof options.callBack == 'function') options.callBack(event.target.id);
                    if (event.target.id == 'Yes' && typeof options.yes_callBack == 'function') options.yes_callBack();
                    if (event.target.id == 'No'  && typeof options.no_callBack == 'function') options.no_callBack();
                });
            },
            onKeydown: function (event) {
                switch (event.originalEvent.keyCode) {
                    case 13: // enter
                        if (typeof options.callBack == 'function') options.callBack('Yes');
                        if (typeof options.yes_callBack == 'function') options.yes_callBack();
                        w2popup.message();
                        break
                    case 27: // esc
                        if (typeof options.callBack == 'function') options.callBack('No');
                        if (typeof options.no_callBack == 'function') options.no_callBack();
                        w2popup.message();
                        break
                }
            }
        });

    } else {

        if (!w2utils.isInt(options.height)) options.height = options.height + 50;
        w2popup.open({
            width      : options.width,
            height     : options.height,
            title      : options.title,
            modal      : true,
            showClose  : false,
            body       : '<div class="w2ui-centered" style="font-size: 13px;">' + options.msg + '</div>',
            buttons    : '<button id="Yes" class="w2ui-popup-btn btn '+ options.yes_class +'" style="'+ options.yes_style +'">'+ w2utils.lang(options.yes_text) +'</button>'+
                         '<button id="No" class="w2ui-popup-btn btn '+ options.no_class +'" style="'+ options.no_style +'">'+ w2utils.lang(options.no_text) +'</button>',
            onOpen: function (event) {
                event.onComplete = function () {
                    $('#w2ui-popup .w2ui-popup-btn').on('click', function (event) {
                        w2popup.close();
                        if (typeof options.callBack == 'function') options.callBack(event.target.id);
                        if (event.target.id == 'Yes' && typeof options.yes_callBack == 'function') options.yes_callBack();
                        if (event.target.id == 'No'  && typeof options.no_callBack == 'function') options.no_callBack();
                    });
                }
            },
            onKeydown: function (event) {
                switch (event.originalEvent.keyCode) {
                    case 13: // enter
                        if (typeof options.callBack == 'function') options.callBack('Yes');
                        if (typeof options.yes_callBack == 'function') options.yes_callBack();
                        w2popup.close();
                        break
                    case 27: // esc
                        if (typeof options.callBack == 'function') options.callBack('No');
                        if (typeof options.no_callBack == 'function') options.no_callBack();
                        w2popup.close();
                        break
                }
            }
        });
    }

    return {
        yes: function (fun) {
            options.yes_callBack = fun;
            return this;
        },
        no: function (fun) {
            options.no_callBack = fun;
            return this;
        }
    };
};
/************************************************************************
*   Library: Web 2.0 UI for jQuery (using prototypical inheritance)
*   - Following objects defined
*        - w2tabs        - tabs widget
*        - $().w2tabs    - jQuery wrapper
*   - Dependencies: jQuery, w2utils
*
* == NICE TO HAVE ==
*   - on overflow display << >>
*
************************************************************************/

(function () {
    var w2tabs = function (options) {
        this.box       = null;      // DOM Element that holds the element
        this.name      = null;      // unique name for w2ui
        this.active    = null;
        this.tabs      = [];
        this.routeData = {};        // data for dynamic routes
        this.right     = '';
        this.style     = '';
        this.onClick   = null;
        this.onClose   = null;
        this.onRender  = null;
        this.onRefresh = null;
        this.onResize  = null;
        this.onDestroy = null;

        $.extend(this, { handlers: [] });
        $.extend(true, this, w2obj.tabs, options);
    };

    // ====================================================
    // -- Registers as a jQuery plugin

    $.fn.w2tabs = function(method) {
        if (typeof method === 'object' || !method ) {
            // check name parameter
            if (!w2utils.checkName(method, 'w2tabs')) return;
            // extend tabs
            var tabs   = method.tabs || [];
            var object = new w2tabs(method);
            for (var i = 0; i < tabs.length; i++) {
                object.tabs[i] = $.extend({}, w2tabs.prototype.tab, tabs[i]);
            }
            if ($(this).length !== 0) {
                object.render($(this)[0]);
            }
            // register new object
            w2ui[object.name] = object;
            return object;
        } else if (w2ui[$(this).attr('name')]) {
            var obj = w2ui[$(this).attr('name')];
            obj[method].apply(obj, Array.prototype.slice.call(arguments, 1));
            return this;
        } else {
            console.log('ERROR: Method ' +  method + ' does not exist on jQuery.w2tabs' );
            return undefined;
        }
    };

    // ====================================================
    // -- Implementation of core functionality

    w2tabs.prototype = {
        tab : {
            id        : null,        // command to be sent to all event handlers
            text      : '',
            route     : null,
            hidden    : false,
            disabled  : false,
            closable  : false,
            hint      : '',
            onClick   : null,
            onRefresh : null,
            onClose   : null
        },

        add: function (tab) {
            return this.insert(null, tab);
        },

        insert: function (id, tab) {
            if (!$.isArray(tab)) tab = [tab];
            // assume it is array
            for (var i = 0; i < tab.length; i++) {
                // checks
                if (typeof tab[i].id === 'undefined') {
                    console.log('ERROR: The parameter "id" is required but not supplied. (obj: '+ this.name +')');
                    return;
                }
                if (!w2utils.checkUniqueId(tab[i].id, this.tabs, 'tabs', this.name)) return;
                // add tab
                var newTab = $.extend({}, w2tabs.prototype.tab, tab[i]);
                if (id === null || typeof id === 'undefined') {
                    this.tabs.push(newTab);
                } else {
                    var middle = this.get(id, true);
                    this.tabs = this.tabs.slice(0, middle).concat([newTab], this.tabs.slice(middle));
                }
                this.refresh(tab[i].id);
            }
        },

        remove: function () {
            var removed = 0;
            for (var a = 0; a < arguments.length; a++) {
                var tab = this.get(arguments[a]);
                if (!tab) return false;
                removed++;
                // remove from array
                this.tabs.splice(this.get(tab.id, true), 1);
                // remove from screen
                $(this.box).find('#tabs_'+ this.name +'_tab_'+ w2utils.escapeId(tab.id)).remove();
            }
            return removed;
        },

        select: function (id) {
            if (this.active == id || this.get(id) === null) return false;
            this.active = id;
            this.refresh();
            return true;
        },

        set: function (id, tab) {
            var index = this.get(id, true);
            if (index === null) return false;
            $.extend(this.tabs[index], tab);
            this.refresh(id);
            return true;
        },

        get: function (id, returnIndex) {
            if (arguments.length === 0) {
                var all = [];
                for (var i1 = 0; i1 < this.tabs.length; i1++) {
                    if (this.tabs[i1].id != null) {
                        all.push(this.tabs[i1].id);
                    }
                }
                return all;
            } else {
                for (var i2 = 0; i2 < this.tabs.length; i2++) {
                    if (this.tabs[i2].id == id) { // need to be == since id can be numeric
                        return (returnIndex === true ? i2 : this.tabs[i2]);
                    }
                }
            }
            return null;
        },

        show: function () {
            var obj   = this;
            var shown = 0;
            var tmp   = [];
            for (var a = 0; a < arguments.length; a++) {
                var tab = this.get(arguments[a]);
                if (!tab || tab.hidden === false) continue;
                shown++;
                tab.hidden = false;
                tmp.push(tab.id);
            }
            setTimeout(function () { for (var t in tmp) obj.refresh(tmp[t]); }, 15); // needs timeout 
            return shown;
        },

        hide: function () {
            var obj   = this;
            var hidden= 0;
            var tmp   = [];
            for (var a = 0; a < arguments.length; a++) {
                var tab = this.get(arguments[a]);
                if (!tab || tab.hidden === true) continue;
                hidden++;
                tab.hidden = true;
                tmp.push(tab.id);
            }
            setTimeout(function () { for (var t in tmp) obj.refresh(tmp[t]); }, 15); // needs timeout 
            return hidden;
        },

        enable: function () {
            var obj   = this;
            var enabled = 0;
            var tmp   = [];
            for (var a = 0; a < arguments.length; a++) {
                var tab = this.get(arguments[a]);
                if (!tab || tab.disabled === false) continue;
                enabled++;
                tab.disabled = false;
                tmp.push(tab.id);
            }
            setTimeout(function () { for (var t in tmp) obj.refresh(tmp[t]); }, 15); // needs timeout 
            return enabled;
        },

        disable: function () {
            var obj   = this;
            var disabled = 0;
            var tmp   = [];
            for (var a = 0; a < arguments.length; a++) {
                var tab = this.get(arguments[a]);
                if (!tab || tab.disabled === true) continue;
                disabled++;
                tab.disabled = true;
                tmp.push(tab.id);
            }
            setTimeout(function () { for (var t in tmp) obj.refresh(tmp[t]); }, 15); // needs timeout 
            return disabled;
        },

        refresh: function (id) {
            var time = (new Date()).getTime();
            // if (window.getSelection) window.getSelection().removeAllRanges(); // clear selection
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'refresh', target: (typeof id !== 'undefined' ? id : this.name), object: this.get(id) });
            if (eventData.isCancelled === true) return;
            if (typeof id === 'undefined') {
                // refresh all
                for (var i = 0; i < this.tabs.length; i++) this.refresh(this.tabs[i].id);
            } else {
                // create or refresh only one item
                var tab = this.get(id);
                if (tab === null) return false;
                if (typeof tab.caption !== 'undefined') tab.text = tab.caption;

                var jq_el   = $(this.box).find('#tabs_'+ this.name +'_tab_'+ w2utils.escapeId(tab.id));
                var tabHTML = (tab.closable ? '<div class="w2ui-tab-close" onclick="w2ui[\''+ this.name +'\'].animateClose(\''+ tab.id +'\', event);"></div>' : '') +
                    '    <div class="w2ui-tab'+ (this.active === tab.id ? ' active' : '') + (tab.closable ? ' closable' : '') +'" '+
                    '        title="'+ (typeof tab.hint !== 'undefined' ? tab.hint : '') +'"'+
                    '        onclick="w2ui[\''+ this.name +'\'].click(\''+ tab.id +'\', event);">' + tab.text + '</div>';
                if (jq_el.length === 0) {
                    // does not exist - create it
                    var addStyle = '';
                    if (tab.hidden) { addStyle += 'display: none;'; }
                    if (tab.disabled) { addStyle += 'opacity: 0.2; -moz-opacity: 0.2; -webkit-opacity: 0.2; -o-opacity: 0.2; filter:alpha(opacity=20);'; }
                    var html = '<td id="tabs_'+ this.name + '_tab_'+ tab.id +'" style="'+ addStyle +'" valign="middle">'+ tabHTML + '</td>';
                    if (this.get(id, true) !== this.tabs.length-1 && $(this.box).find('#tabs_'+ this.name +'_tab_'+ w2utils.escapeId(this.tabs[parseInt(this.get(id, true))+1].id)).length > 0) {
                        $(this.box).find('#tabs_'+ this.name +'_tab_'+ w2utils.escapeId(this.tabs[parseInt(this.get(id, true))+1].id)).before(html);
                    } else {
                        $(this.box).find('#tabs_'+ this.name +'_right').before(html);
                    }
                } else {
                    // refresh
                    jq_el.html(tabHTML);
                    if (tab.hidden) { jq_el.css('display', 'none'); }
                    else { jq_el.css('display', ''); }
                    if (tab.disabled) { jq_el.css({ 'opacity': '0.2', '-moz-opacity': '0.2', '-webkit-opacity': '0.2', '-o-opacity': '0.2', 'filter': 'alpha(opacity=20)' }); }
                    else { jq_el.css({ 'opacity': '1', '-moz-opacity': '1', '-webkit-opacity': '1', '-o-opacity': '1', 'filter': 'alpha(opacity=100)' }); }
                }
            }
            // right html
            $('#tabs_'+ this.name +'_right').html(this.right);
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            return (new Date()).getTime() - time;
        },

        render: function (box) {
            var time = (new Date()).getTime();
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'render', target: this.name, box: box });
            if (eventData.isCancelled === true) return;
            // default action
            // if (window.getSelection) window.getSelection().removeAllRanges(); // clear selection
            if (typeof box !== 'undefined' && box !== null) {
                if ($(this.box).find('> table #tabs_'+ this.name + '_right').length > 0) {
                    $(this.box)
                        .removeAttr('name')
                        .removeClass('w2ui-reset w2ui-tabs')
                        .html('');
                }
                this.box = box;
            }
            if (!this.box) return false;
            // render all buttons
            var html =    '<table cellspacing="0" cellpadding="1" width="100%">'+
                        '    <tr><td width="100%" id="tabs_'+ this.name +'_right" align="right">'+ this.right +'</td></tr>'+
                        '</table>';
            $(this.box)
                .attr('name', this.name)
                .addClass('w2ui-reset w2ui-tabs')
                .html(html);
            if ($(this.box).length > 0) $(this.box)[0].style.cssText += this.style;
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            this.refresh();
            return (new Date()).getTime() - time;
        },

        resize: function () {
            var time = (new Date()).getTime();
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'resize', target: this.name });
            if (eventData.isCancelled === true) return;

            // intentionaly blank

            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            return (new Date()).getTime() - time;
        },

        destroy: function () {
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'destroy', target: this.name });
            if (eventData.isCancelled === true) return;
            // clean up
            if ($(this.box).find('> table #tabs_'+ this.name + '_right').length > 0) {
                $(this.box)
                    .removeAttr('name')
                    .removeClass('w2ui-reset w2ui-tabs')
                    .html('');
            }
            delete w2ui[this.name];
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        // ===================================================
        // -- Internal Event Handlers

        click: function (id, event) {
            var tab = this.get(id);
            if (tab === null || tab.disabled) return false;
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'click', target: id, tab: tab, object: tab, originalEvent: event });
            if (eventData.isCancelled === true) return;
            // default action
            $(this.box).find('#tabs_'+ this.name +'_tab_'+ w2utils.escapeId(this.active) +' .w2ui-tab').removeClass('active');
            this.active = tab.id;
            // route processing
            if (tab.route) {
                var route = String('/'+ tab.route).replace(/\/{2,}/g, '/');
                var info  = w2utils.parseRoute(route);
                if (info.keys.length > 0) {
                    for (var k = 0; k < info.keys.length; k++) {
                        if (this.routeData[info.keys[k].name] == null) continue;
                        route = route.replace((new RegExp(':'+ info.keys[k].name, 'g')), this.routeData[info.keys[k].name]);
                    }
                }
                setTimeout(function () { window.location.hash = route; }, 1);
            }
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            this.refresh(id);
        },

        animateClose: function(id, event) {
            var tab = this.get(id);
            if (tab === null || tab.disabled) return false;
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'close', target: id, object: this.get(id), originalEvent: event });
            if (eventData.isCancelled === true) return;
            // default action
            var obj = this;
            $(this.box).find('#tabs_'+ this.name +'_tab_'+ w2utils.escapeId(tab.id)).css({
                '-webkit-transition': '.2s',
                '-moz-transition': '2s',
                '-ms-transition': '.2s',
                '-o-transition': '.2s',
                opacity: '0' });
            setTimeout(function () {
                var width = $(obj.box).find('#tabs_'+ obj.name +'_tab_'+ w2utils.escapeId(tab.id)).width();
                $(obj.box).find('#tabs_'+ obj.name +'_tab_'+ w2utils.escapeId(tab.id))
                    .html('<div style="width: '+ width +'px; -webkit-transition: .2s; -moz-transition: .2s; -ms-transition: .2s; -o-transition: .2s"></div>');
                setTimeout(function () {
                    $(obj.box).find('#tabs_'+ obj.name +'_tab_'+ w2utils.escapeId(tab.id)).find(':first-child').css({ 'width': '0px' });
                }, 50);
            }, 200);
            setTimeout(function () {
                obj.remove(id);
            }, 450);
            // event before
            this.trigger($.extend(eventData, { phase: 'after' }));
            this.refresh();
        },

        animateInsert: function(id, tab) {
            if (this.get(id) === null) return;
            if (!$.isPlainObject(tab)) return;
            // check for unique
            if (!w2utils.checkUniqueId(tab.id, this.tabs, 'tabs', this.name)) return;
            // insert simple div
            var jq_el   = $(this.box).find('#tabs_'+ this.name +'_tab_'+ w2utils.escapeId(tab.id));
            if (jq_el.length !== 0) return; // already exists
            // measure width
            if (typeof tab.caption !== 'undefined') tab.text = tab.caption;
            var tmp = '<div id="_tmp_tabs" class="w2ui-reset w2ui-tabs" style="position: absolute; top: -1000px;">'+
                '<table cellspacing="0" cellpadding="1" width="100%"><tr>'+
                '<td id="_tmp_simple_tab" style="" valign="middle">'+
                    (tab.closable ? '<div class="w2ui-tab-close"></div>' : '') +
                '    <div class="w2ui-tab '+ (this.active === tab.id ? 'active' : '') +'">'+ tab.text +'</div>'+
                '</td></tr></table>'+
                '</div>';
            $('body').append(tmp);
            // create dummy element
            var tabHTML = '<div style="width: 1px; -webkit-transition: 0.2s; -moz-transition: 0.2s; -ms-transition: 0.2s; -o-transition: 0.2s;">&nbsp;</div>';
            var addStyle = '';
            if (tab.hidden) { addStyle += 'display: none;'; }
            if (tab.disabled) { addStyle += 'opacity: 0.2; -moz-opacity: 0.2; -webkit-opacity: 0.2; -o-opacity: 0.2; filter:alpha(opacity=20);'; }
            var html = '<td id="tabs_'+ this.name +'_tab_'+ tab.id +'" style="'+ addStyle +'" valign="middle">'+ tabHTML +'</td>';
            if (this.get(id, true) !== this.tabs.length && $(this.box).find('#tabs_'+ this.name +'_tab_'+ w2utils.escapeId(this.tabs[parseInt(this.get(id, true))].id)).length > 0) {
                $(this.box).find('#tabs_'+ this.name +'_tab_'+ w2utils.escapeId(this.tabs[parseInt(this.get(id, true))].id)).before(html);
            } else {
                $(this.box).find('#tabs_'+ this.name +'_right').before(html);
            }
            // -- move
            var obj = this;
            setTimeout(function () {
                var width = $('#_tmp_simple_tab').width();
                $('#_tmp_tabs').remove();
                $('#tabs_'+ obj.name +'_tab_'+ w2utils.escapeId(tab.id) +' > div').css('width', width+'px');
            }, 1);
            setTimeout(function () {
                // insert for real
                obj.insert(id, tab);
            }, 200);
        }
    };

    $.extend(w2tabs.prototype, w2utils.event);
    w2obj.tabs = w2tabs;
})();


/************************************************************************
*   Library: Web 2.0 UI for jQuery (using prototypical inheritance)
*   - Following objects defined
*        - w2toolbar        - toolbar widget
*        - $().w2toolbar    - jQuery wrapper
*   - Dependencies: jQuery, w2utils
*
* == NICE TO HAVE ==
*   - on overflow display << >>
*   - verticle toolbar
*
************************************************************************/

(function () {
    var w2toolbar = function (options) {
        this.box       = null;      // DOM Element that holds the element
        this.name      = null;      // unique name for w2ui
        this.routeData = {};        // data for dynamic routes
        this.items     = [];
        this.right     = '';        // HTML text on the right of toolbar
        this.onClick   = null;
        this.onRender  = null;
        this.onRefresh = null;
        this.onResize  = null;
        this.onDestroy = null;

        $.extend(true, this, w2obj.toolbar, options);
    };

    // ====================================================
    // -- Registers as a jQuery plugin

    $.fn.w2toolbar = function(method) {
        if (typeof method === 'object' || !method ) {
            // check name parameter
            if (!w2utils.checkName(method, 'w2toolbar')) return;
            // extend items
            var items = method.items || [];
            var object = new w2toolbar(method);
            $.extend(object, { items: [], handlers: [] });
            for (var i = 0; i < items.length; i++) {
                object.items[i] = $.extend({}, w2toolbar.prototype.item, items[i]);
            }
            if ($(this).length !== 0) {
                object.render($(this)[0]);
            }
            // register new object
            w2ui[object.name] = object;
            return object;

        } else if (w2ui[$(this).attr('name')]) {
            var obj = w2ui[$(this).attr('name')];
            obj[method].apply(obj, Array.prototype.slice.call(arguments, 1));
            return this;
        } else {
            console.log('ERROR: Method ' +  method + ' does not exist on jQuery.w2toolbar' );
        }
    };

    // ====================================================
    // -- Implementation of core functionality

    w2toolbar.prototype = {
        item: {
            id       : null,        // command to be sent to all event handlers
            type     : 'button',    // button, check, radio, drop, menu, break, html, spacer
            text     : '',
            route    : null,        // if not null, it is route to go
            html     : '',
            img      : null,
            icon     : null,
            count    : null,
            hidden   : false,
            disabled : false,
            checked  : false,       // used for radio buttons
            arrow    : true,        // arrow down for drop/menu types
            hint     : '',
            group    : null,        // used for radio buttons
            items    : null,        // for type menu it is an array of items in the menu
            overlay  : {},
            onClick  : null
        },

        add: function (items) {
            this.insert(null, items);
        },

        insert: function (id, items) {
            if (!$.isArray(items)) items = [items];
            for (var o = 0; o < items.length; o++) {
                // checks
                if (typeof items[o].type === 'undefined') {
                    console.log('ERROR: The parameter "type" is required but not supplied in w2toolbar.add() method.');
                    return;
                }
                if ($.inArray(String(items[o].type), ['button', 'check', 'radio', 'drop', 'menu', 'break', 'html', 'spacer']) === -1) {
                    console.log('ERROR: The parameter "type" should be one of the following [button, check, radio, drop, menu, break, html, spacer] '+
                            'in w2toolbar.add() method.');
                    return;
                }
                if (typeof items[o].id === 'undefined') {
                    console.log('ERROR: The parameter "id" is required but not supplied in w2toolbar.add() method.');
                    return;
                }
                if (!w2utils.checkUniqueId(items[o].id, this.items, 'toolbar items', this.name)) return;
                // add item
                var it = $.extend({}, w2toolbar.prototype.item, items[o]);
                if (id == null) {
                    this.items.push(it);
                } else {
                    var middle = this.get(id, true);
                    this.items = this.items.slice(0, middle).concat([it], this.items.slice(middle));
                }
                this.refresh(it.id);
            }
        },

        remove: function () {
            var removed = 0;
            for (var a = 0; a < arguments.length; a++) {
                var it = this.get(arguments[a]);
                if (!it) continue;
                removed++;
                // remove from screen
                $(this.box).find('#tb_'+ this.name +'_item_'+ w2utils.escapeId(it.id)).remove();
                // remove from array
                var ind = this.get(it.id, true);
                if (ind) this.items.splice(ind, 1);
            }
            return removed;
        },

        set: function (id, item) {
            var index = this.get(id, true);
            if (index === null) return false;
            $.extend(this.items[index], item);
            this.refresh(id);
            return true;
        },

        get: function (id, returnIndex) {
            if (arguments.length === 0) {
                var all = [];
                for (var i1 = 0; i1 < this.items.length; i1++) if (this.items[i1].id !== null) all.push(this.items[i1].id);
                return all;
            }
            for (var i2 = 0; i2 < this.items.length; i2++) {
                if (this.items[i2].id === id) {
                    if (returnIndex === true) return i2; else return this.items[i2];
                }
            }
            return null;
        },

        show: function () {
            var obj   = this;
            var items = 0;
            var tmp   = [];
            for (var a = 0; a < arguments.length; a++) {
                var it = this.get(arguments[a]);
                if (!it) continue;
                items++;
                it.hidden = false;
                tmp.push(it.id);
            }
            setTimeout(function () { for (var t in tmp) obj.refresh(tmp[t]); }, 15); // needs timeout 
            return items;
        },

        hide: function () {
            var obj   = this;
            var items = 0;
            var tmp   = [];
            for (var a = 0; a < arguments.length; a++) {
                var it = this.get(arguments[a]);
                if (!it) continue;
                items++;
                it.hidden = true;
                tmp.push(it.id);
            }
            setTimeout(function () { for (var t in tmp) obj.refresh(tmp[t]); }, 15); // needs timeout 
            return items;
        },

        enable: function () {
            var obj   = this;
            var items = 0;
            var tmp   = [];
            for (var a = 0; a < arguments.length; a++) {
                var it = this.get(arguments[a]);
                if (!it) continue;
                items++;
                it.disabled = false;
                tmp.push(it.id);
            }
            setTimeout(function () { for (var t in tmp) obj.refresh(tmp[t]); }, 15); // needs timeout 
            return items;
        },

        disable: function () {
            var obj   = this;
            var items = 0;
            var tmp   = [];
            for (var a = 0; a < arguments.length; a++) {
                var it = this.get(arguments[a]);
                if (!it) continue;
                items++;
                it.disabled = true;
                tmp.push(it.id);
            }
            setTimeout(function () { for (var t in tmp) obj.refresh(tmp[t]); }, 15); // needs timeout 
            return items;
        },

        check: function () {
            var obj   = this;
            var items = 0;
            var tmp   = [];
            for (var a = 0; a < arguments.length; a++) {
                var it = this.get(arguments[a]);
                if (!it) continue;
                items++;
                it.checked = true;
                tmp.push(it.id);
            }
            setTimeout(function () { for (var t in tmp) obj.refresh(tmp[t]); }, 15); // needs timeout 
            return items;
        },

        uncheck: function () {
            var obj   = this;
            var items = 0;
            var tmp   = [];
            for (var a = 0; a < arguments.length; a++) {
                var it = this.get(arguments[a]);
                if (!it) continue;
                items++;
                it.checked = false;
                tmp.push(it.id);
            }
            setTimeout(function () { for (var t in tmp) obj.refresh(tmp[t]); }, 15); // needs timeout 
            return items;
        },

        render: function (box) {
            var time = (new Date()).getTime();
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'render', target: this.name, box: box });
            if (eventData.isCancelled === true) return;

            if (box != null) {
                if ($(this.box).find('> table #tb_'+ this.name + '_right').length > 0) {
                    $(this.box)
                        .removeAttr('name')
                        .removeClass('w2ui-reset w2ui-toolbar')
                        .html('');
                }
                this.box = box;
            }
            if (!this.box) return;
            // render all buttons
            var html = '<table cellspacing="0" cellpadding="0" width="100%">'+
                       '<tr>';
            for (var i = 0; i < this.items.length; i++) {
                var it = this.items[i];
                if (it.id == null) it.id = "item_" + i;
                if (it === null)  continue;
                if (it.type === 'spacer') {
                    html += '<td width="100%" id="tb_'+ this.name +'_item_'+ it.id +'" align="right"></td>';
                } else {
                    html += '<td id="tb_'+ this.name + '_item_'+ it.id +'" style="'+ (it.hidden ? 'display: none' : '') +'" '+
                            '    class="'+ (it.disabled ? 'disabled' : '') +'" valign="middle">'+ this.getItemHTML(it) +
                            '</td>';
                }
            }
            html += '<td width="100%" id="tb_'+ this.name +'_right" align="right">'+ this.right +'</td>';
            html += '</tr>'+
                    '</table>';
            $(this.box)
                .attr('name', this.name)
                .addClass('w2ui-reset w2ui-toolbar')
                .html(html);
            if ($(this.box).length > 0) $(this.box)[0].style.cssText += this.style;
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            return (new Date()).getTime() - time;
        },

        refresh: function (id) {
            var time = (new Date()).getTime();
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'refresh', target: (typeof id !== 'undefined' ? id : this.name), item: this.get(id) });
            if (eventData.isCancelled === true) return;

            if (id == null) {
                // refresh all
                for (var i = 0; i < this.items.length; i++) {
                    var it1 = this.items[i];
                    if (it1.id == null) it1.id = "item_" + i;
                    this.refresh(it1.id);
                }
            }
            // create or refresh only one item
            var it = this.get(id);
            if (it === null) return false;

            var el = $(this.box).find('#tb_'+ this.name +'_item_'+ w2utils.escapeId(it.id));
            var html  = this.getItemHTML(it);
            if (el.length === 0) {
                // does not exist - create it
                if (it.type === 'spacer') {
                    html = '<td width="100%" id="tb_'+ this.name +'_item_'+ it.id +'" align="right"></td>';
                } else {
                    html = '<td id="tb_'+ this.name + '_item_'+ it.id +'" style="'+ (it.hidden ? 'display: none' : '') +'" '+
                        '    class="'+ (it.disabled ? 'disabled' : '') +'" valign="middle">'+ html +
                        '</td>';
                }
                if (this.get(id, true) === this.items.length-1) {
                    $(this.box).find('#tb_'+ this.name +'_right').before(html);
                } else {
                    $(this.box).find('#tb_'+ this.name +'_item_'+ w2utils.escapeId(this.items[parseInt(this.get(id, true))+1].id)).before(html);
                }
            } else {
                // refresh
                el.html(html);
                if (it.hidden) { el.css('display', 'none'); } else { el.css('display', ''); }
                if (it.disabled) { el.addClass('disabled'); } else { el.removeClass('disabled'); }
            }
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            return (new Date()).getTime() - time;
        },

        resize: function () {
            var time = (new Date()).getTime();
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'resize', target: this.name });
            if (eventData.isCancelled === true) return;

            // intentionaly blank

            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            return (new Date()).getTime() - time;
        },

        destroy: function () {
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'destroy', target: this.name });
            if (eventData.isCancelled === true) return;
            // clean up
            if ($(this.box).find('> table #tb_'+ this.name + '_right').length > 0) {
                $(this.box)
                    .removeAttr('name')
                    .removeClass('w2ui-reset w2ui-toolbar')
                    .html('');
            }
            $(this.box).html('');
            delete w2ui[this.name];
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        // ========================================
        // --- Internal Functions

        getItemHTML: function (item) {
            var html = '';

            if (typeof item.caption !== 'undefined') item.text = item.caption;
            if (typeof item.hint === 'undefined') item.hint = '';
            if (typeof item.text === 'undefined') item.text = '';

            switch (item.type) {
                case 'menu':
                case 'button':
                case 'check':
                case 'radio':
                case 'drop':
                    var img = '<td>&nbsp;</td>';
                    if (item.img)  img = '<td><div class="w2ui-tb-image w2ui-icon '+ item.img +'"></div></td>';
                    if (item.icon) img = '<td><div class="w2ui-tb-image"><span class="'+ item.icon +'"></span></div></td>';
                    html += '<table cellpadding="0" cellspacing="0" title="'+ item.hint +'" class="w2ui-button '+ (item.checked ? 'checked' : '') +'" '+
                            '       onclick     = "var el=w2ui[\''+ this.name + '\']; if (el) el.click(\''+ item.id +'\', event);" '+
                            '       onmouseover = "' + (!item.disabled ? "$(this).addClass('over');" : "") + '"'+
                            '       onmouseout  = "' + (!item.disabled ? "$(this).removeClass('over').removeClass('down');" : "") + '"'+
                            '       onmousedown = "' + (!item.disabled ? "$(this).addClass('down');" : "") + '"'+
                            '       onmouseup   = "' + (!item.disabled ? "$(this).removeClass('down');" : "") + '"'+
                            '>'+
                            '<tr><td>'+
                            '  <table cellpadding="1" cellspacing="0">'+
                            '  <tr>' +
                                    img +
                                    (item.text !== '' ? '<td class="w2ui-tb-caption" nowrap>'+ item.text +'</td>' : '') +
                                    (item.count != null ? '<td class="w2ui-tb-count" nowrap><span>'+ item.count +'</span></td>' : '') +
                                    (((item.type === 'drop' || item.type === 'menu') && item.arrow !== false) ?
                                        '<td class="w2ui-tb-down" nowrap><div></div></td>' : '') +
                            '  </tr></table>'+
                            '</td></tr></table>';
                    break;

                case 'break':
                    html +=    '<table cellpadding="0" cellspacing="0"><tr>'+
                            '    <td><div class="w2ui-break">&nbsp;</div></td>'+
                            '</tr></table>';
                    break;

                case 'html':
                    html +=    '<table cellpadding="0" cellspacing="0"><tr>'+
                            '    <td nowrap>' + item.html + '</td>'+
                            '</tr></table>';
                    break;
            }

            var newHTML = '';
            if (typeof item.onRender === 'function') newHTML = item.onRender.call(this, item.id, html);
            if (typeof this.onRender === 'function') newHTML = this.onRender(item.id, html);
            if (newHTML !== '' && newHTML != null) html = newHTML;
            return html;
        },

        menuClick: function (event) {
            var obj = this;
            if (event.item && !event.item.disabled) {
                // event before
                var eventData = this.trigger({ phase: 'before', type: 'click', target: event.item.id + ':' + event.subItem.id, item: event.item,
                    subItem: event.subItem, originalEvent: event.originalEvent });
                if (eventData.isCancelled === true) return;

                // route processing
                var it = event.subItem;
                if (it.route) {
                    var route = String('/'+ it.route).replace(/\/{2,}/g, '/');
                    var info  = w2utils.parseRoute(route);
                    if (info.keys.length > 0) {
                        for (var k = 0; k < info.keys.length; k++) {
                            if (obj.routeData[info.keys[k].name] == null) continue;
                            route = route.replace((new RegExp(':'+ info.keys[k].name, 'g')), this.routeData[info.keys[k].name]);
                        }
                    }
                    setTimeout(function () { window.location.hash = route; }, 1);
                }

                // event after
                this.trigger($.extend(eventData, { phase: 'after' }));
            }
        },

        click: function (id, event) {
            var obj = this;
            var it  = this.get(id);
            if (it && !it.disabled) {
                // event before
                var eventData = this.trigger({ phase: 'before', type: 'click', target: (typeof id !== 'undefined' ? id : this.name),
                    item: it, object: it, originalEvent: event });
                if (eventData.isCancelled === true) return;

                var btn = $('#tb_'+ this.name +'_item_'+ w2utils.escapeId(it.id) +' table.w2ui-button');
                btn.removeClass('down');

                if (it.type === 'radio') {
                    for (var i = 0; i < this.items.length; i++) {
                        var itt = this.items[i];
                        if (itt == null || itt.id === it.id || itt.type !== 'radio') continue;
                        if (itt.group === it.group && itt.checked) {
                            itt.checked = false;
                            this.refresh(itt.id);
                        }
                    }
                    it.checked = true;
                    btn.addClass('checked');
                }

                if (it.type === 'drop' || it.type === 'menu') {
                    if (it.checked) {
                        // if it was already checked, second click will hide it
                        it.checked = false;
                    } else {
                        // show overlay
                        setTimeout(function () {
                            var el = $('#tb_'+ obj.name +'_item_'+ w2utils.escapeId(it.id));
                            if (!$.isPlainObject(it.overlay)) it.overlay = {};
                            var left = (el.width() - 50) / 2;
                            if (left > 19) left = 19;
                            if (it.type === 'drop') {
                                el.w2overlay(it.html, $.extend({ left: left, top: 3 }, it.overlay));
                            }
                            if (it.type === 'menu') {
                                el.w2menu(it.items, $.extend({ left: left, top: 3 }, it.overlay, {
                                    select: function (event) {
                                        obj.menuClick({ item: it, subItem: event.item, originalEvent: event.originalEvent });
                                        hideDrop();
                                    }
                                }));
                            }
                            // window.click to hide it
                            $(document).on('click', hideDrop);
                            function hideDrop() {
                                $(document).off('click', hideDrop);
                                it.checked = false;
                                btn.removeClass('checked');
                            }
                        }, 1);
                    }
                }

                if (it.type === 'check' || it.type === 'drop' || it.type === 'menu') {
                    it.checked = !it.checked;
                    if (it.checked) {
                        btn.addClass('checked');
                    } else {
                        btn.removeClass('checked');
                    }
                }
                // route processing
                if (it.route) {
                    var route = String('/'+ it.route).replace(/\/{2,}/g, '/');
                    var info  = w2utils.parseRoute(route);
                    if (info.keys.length > 0) {
                        for (var k = 0; k < info.keys.length; k++) {
                            route = route.replace((new RegExp(':'+ info.keys[k].name, 'g')), this.routeData[info.keys[k].name]);
                        }
                    }
                    setTimeout(function () { window.location.hash = route; }, 1);
                }
                // event after
                this.trigger($.extend(eventData, { phase: 'after' }));
            }
        }
    };

    $.extend(w2toolbar.prototype, w2utils.event);
    w2obj.toolbar = w2toolbar;
})();


/************************************************************************
*   Library: Web 2.0 UI for jQuery (using prototypical inheritance)
*   - Following objects defined
*        - w2sidebar        - sidebar widget
*        - $().w2sidebar    - jQuery wrapper
*   - Dependencies: jQuery, w2utils
*
* == NICE TO HAVE ==
*   - return ids of all subitems
*   - add find() method to find nodes by a specific criteria (I want all nodes for exampe)
*   - dbl click should be like it is in grid (with timer not HTML dbl click event)
*   - reorder with grag and drop
*   - add route property that would navigate to a #route
*   - node.style is missleading - should be there to apply color for example
*
************************************************************************/

(function () {
    var w2sidebar = function (options) {
        this.name          = null;
        this.box           = null;
        this.sidebar       = null;
        this.parent        = null;
        this.nodes         = [];        // Sidebar child nodes
        this.menu          = [];
        this.routeData     = {};        // data for dynamic routes
        this.selected      = null;      // current selected node (readonly)
        this.img           = null;
        this.icon          = null;
        this.style         = '';
        this.topHTML       = '';
        this.bottomHTML    = '';
        this.keyboard      = true;
        this.onClick       = null;      // Fire when user click on Node Text
        this.onDblClick    = null;      // Fire when user dbl clicks
        this.onContextMenu = null;
        this.onMenuClick   = null;      // when context menu item selected
        this.onExpand      = null;      // Fire when node Expands
        this.onCollapse    = null;      // Fire when node Colapses
        this.onKeydown     = null;
        this.onRender      = null;
        this.onRefresh     = null;
        this.onResize      = null;
        this.onDestroy     = null;

        $.extend(true, this, w2obj.sidebar, options);
    };

    // ====================================================
    // -- Registers as a jQuery plugin

    $.fn.w2sidebar = function(method) {
        if (typeof method === 'object' || !method ) {
            // check name parameter
            if (!w2utils.checkName(method, 'w2sidebar')) return;
            // extend items
            var nodes  = method.nodes;
            var object = new w2sidebar(method);
            $.extend(object, { handlers: [], nodes: [] });
            if (typeof nodes != 'undefined') {
                object.add(object, nodes);
            }
            if ($(this).length !== 0) {
                object.render($(this)[0]);
            }
            object.sidebar = object;
            // register new object
            w2ui[object.name] = object;
            return object;

        } else if (w2ui[$(this).attr('name')]) {
            var obj = w2ui[$(this).attr('name')];
            obj[method].apply(obj, Array.prototype.slice.call(arguments, 1));
            return this;
        } else {
            console.log('ERROR: Method ' +  method + ' does not exist on jQuery.w2sidebar' );
        }
    };

    // ====================================================
    // -- Implementation of core functionality

    w2sidebar.prototype = {

        node: {
            id              : null,
            text            : '',
            count           : null,
            img             : null,
            icon            : null,
            nodes           : [],
            style           : '',            // additional style for subitems
            route           : null,
            selected        : false,
            expanded        : false,
            hidden          : false,
            disabled        : false,
            group           : false,        // if true, it will build as a group
            groupShowHide   : true,
            plus            : false,        // if true, plus will be shown even if there is no sub nodes
            // events
            onClick         : null,
            onDblClick      : null,
            onContextMenu   : null,
            onExpand        : null,
            onCollapse      : null,
            // internal
            parent          : null,    // node object
            sidebar         : null
        },

        add: function (parent, nodes) {
            if (arguments.length == 1) {
                // need to be in reverse order
                nodes  = arguments[0];
                parent = this;
            }
            if (typeof parent == 'string') parent = this.get(parent);
            return this.insert(parent, null, nodes);
        },

        insert: function (parent, before, nodes) {
            var txt, ind, tmp, node, nd;
            if (arguments.length == 2) {
                // need to be in reverse order
                nodes  = arguments[1];
                before = arguments[0];
                ind    = this.get(before);
                if (ind === null) {
                    if (!$.isArray(nodes)) nodes = [nodes];
                    txt = (nodes[0].caption != null ? nodes[0].caption : nodes[0].text);
                    console.log('ERROR: Cannot insert node "'+ txt +'" because cannot find node "'+ before +'" to insert before.');
                    return null;
                }
                parent = this.get(before).parent;
            }
            if (typeof parent == 'string') parent = this.get(parent);
            if (!$.isArray(nodes)) nodes = [nodes];
            for (var o in nodes) {
                node = nodes[o];
                if (typeof node.id == null) {
                    txt = (node.caption != null ? node.caption : node.text);
                    console.log('ERROR: Cannot insert node "'+ txt +'" because it has no id.');
                    continue;
                }
                if (this.get(this, node.id) !== null) {
                    txt = (node.caption != null ? node.caption : node.text);
                    console.log('ERROR: Cannot insert node with id='+ node.id +' (text: '+ txt + ') because another node with the same id already exists.');
                    continue;
                }
                tmp = $.extend({}, w2sidebar.prototype.node, node);
                tmp.sidebar = this;
                tmp.parent  = parent;
                nd = tmp.nodes || [];
                tmp.nodes = []; // very important to re-init empty nodes array
                if (before === null) { // append to the end
                    parent.nodes.push(tmp);
                } else {
                    ind = this.get(parent, before, true);
                    if (ind === null) {
                        txt = (node.caption != null ? node.caption : node.text);
                        console.log('ERROR: Cannot insert node "'+ txt +'" because cannot find node "'+ before +'" to insert before.');
                        return null;
                }
                    parent.nodes.splice(ind, 0, tmp);
                }
                if (nd.length > 0) {
                    this.insert(tmp, null, nd);
                }
            }
            this.refresh(parent.id);
            return tmp;
        },

        remove: function () { // multiple arguments
            var deleted = 0;
            var tmp;
            for (var a = 0; a < arguments.length; a++) {
                tmp = this.get(arguments[a]);
                if (tmp === null) continue;
                if (this.selected !== null && this.selected === tmp.id) {
                    this.selected = null;
                }
                var ind  = this.get(tmp.parent, arguments[a], true);
                if (ind === null) continue;
                if (tmp.parent.nodes[ind].selected)    tmp.sidebar.unselect(tmp.id);
                tmp.parent.nodes.splice(ind, 1);
                deleted++;
            }
            if (deleted > 0 && arguments.length == 1) this.refresh(tmp.parent.id); else this.refresh();
            return deleted;
        },

        set: function (parent, id, node) {
            if (arguments.length == 2) {
                // need to be in reverse order
                node    = id;
                id        = parent;
                parent    = this;
            }
            // searches all nested nodes
            if (typeof parent == 'string') parent = this.get(parent);
            if (parent.nodes == null) return null;
            for (var i = 0; i < parent.nodes.length; i++) {
                if (parent.nodes[i].id === id) {
                    // make sure nodes inserted correctly
                    var nodes = node.nodes;
                    $.extend(parent.nodes[i], node, { nodes: [] });
                    if (nodes != null) {
                        this.add(parent.nodes[i], nodes);
                    }
                    this.refresh(id);
                    return true;
                } else {
                    var rv = this.set(parent.nodes[i], id, node);
                    if (rv) return true;
                }
            }
            return false;
        },

        get: function (parent, id, returnIndex) { // can be just called get(id) or get(id, true)
            if (arguments.length === 0) {
                var all = [];
                var tmp = this.find({});
                for (var t = 0; t < tmp.length; t++) {
                    if (tmp[t].id != null) all.push(tmp[t].id);
                }
                return all;
            } else {
                if (arguments.length == 1 || (arguments.length == 2 && id === true) ) {
                    // need to be in reverse order
                    returnIndex    = id;
                    id            = parent;
                    parent        = this;
                }
                // searches all nested nodes
                if (typeof parent == 'string') parent = this.get(parent);
                if (parent.nodes == null) return null;
                for (var i = 0; i < parent.nodes.length; i++) {
                    if (parent.nodes[i].id == id) {
                        if (returnIndex === true) return i; else return parent.nodes[i];
                    } else {
                        var rv = this.get(parent.nodes[i], id, returnIndex);
                        if (rv || rv === 0) return rv;
                    }
                }
                return null;
            }
        },

        find: function (parent, params, results) { // can be just called find({ selected: true })
            if (arguments.length == 1) {
                // need to be in reverse order
                params = parent;
                parent = this;
            }
            if (!results) results = [];
            // searches all nested nodes
            if (typeof parent == 'string') parent = this.get(parent);
            if (parent.nodes == null) return results;
            for (var i = 0; i < parent.nodes.length; i++) {
                var match = true;
                for (var prop in params) {
                    if (parent.nodes[i][prop] != params[prop]) match = false;
                }
                if (match) results.push(parent.nodes[i]);
                if (parent.nodes[i].nodes.length > 0) results = this.find(parent.nodes[i], params, results);
            }
            return results;
        },

        hide: function () { // multiple arguments
            var hidden = 0;
            for (var a = 0; a < arguments.length; a++) {
                var tmp = this.get(arguments[a]);
                if (tmp === null) continue;
                tmp.hidden = true;
                hidden++;
            }
            if (arguments.length == 1) this.refresh(arguments[0]); else this.refresh();
            return hidden;
        },

        show: function () { // multiple arguments
            var shown = 0;
            for (var a = 0; a < arguments.length; a++) {
                var tmp = this.get(arguments[a]);
                if (tmp === null) continue;
                tmp.hidden = false;
                shown++;
            }
            if (arguments.length == 1) this.refresh(arguments[0]); else this.refresh();
            return shown;
        },

        disable: function () { // multiple arguments
            var disabled = 0;
            for (var a = 0; a < arguments.length; a++) {
                var tmp = this.get(arguments[a]);
                if (tmp === null) continue;
                tmp.disabled = true;
                if (tmp.selected) this.unselect(tmp.id);
                disabled++;
            }
            if (arguments.length == 1) this.refresh(arguments[0]); else this.refresh();
            return disabled;
        },

        enable: function () { // multiple arguments
            var enabled = 0;
            for (var a = 0; a < arguments.length; a++) {
                var tmp = this.get(arguments[a]);
                if (tmp === null) continue;
                tmp.disabled = false;
                enabled++;
            }
            if (arguments.length == 1) this.refresh(arguments[0]); else this.refresh();
            return enabled;
        },

        select: function (id) {
            var new_node = this.get(id);
            if (!new_node) return false;
            if (this.selected == id && new_node.selected) return false;
            this.unselect(this.selected);
            $(this.box).find('#node_'+ w2utils.escapeId(id))
                .addClass('w2ui-selected')
                .find('.w2ui-icon').addClass('w2ui-icon-selected');
            new_node.selected = true;
            this.selected = id;
            return true;
        },

        unselect: function (id) {
            var current = this.get(id);
            if (!current) return false;
            current.selected = false;
            $(this.box).find('#node_'+ w2utils.escapeId(id))
                .removeClass('w2ui-selected')
                .find('.w2ui-icon').removeClass('w2ui-icon-selected');
            if (this.selected == id) this.selected = null;
            return true;
        },

        toggle: function(id) {
            var nd = this.get(id);
            if (nd === null) return false;
            if (nd.plus) {
                this.set(id, { plus: false });
                this.expand(id);
                this.refresh(id);
                return;
            }
            if (nd.nodes.length === 0) return false;
            if (this.get(id).expanded) return this.collapse(id); else return this.expand(id);
        },

        collapse: function (id) {
            var obj = this;
            var nd  = this.get(id);
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'collapse', target: id, object: nd });
            if (eventData.isCancelled === true) return;
            // default action
            $(this.box).find('#node_'+ w2utils.escapeId(id) +'_sub').slideUp(200);
            $(this.box).find('#node_'+ w2utils.escapeId(id) +' .w2ui-node-dots:first-child').html('<div class="w2ui-expand">+</div>');
            nd.expanded = false;
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            setTimeout(function () { obj.refresh(id); }, 200);
            return true;
        },

        collapseAll: function (parent) {
            if (typeof parent == 'undefined') parent = this;
            if (typeof parent == 'string') parent = this.get(parent);
            if (parent.nodes == null) return false;
            for (var i = 0; i < parent.nodes.length; i++) {
                if (parent.nodes[i].expanded === true) parent.nodes[i].expanded = false;
                if (parent.nodes[i].nodes && parent.nodes[i].nodes.length > 0) this.collapseAll(parent.nodes[i]);
            }
            this.refresh(parent.id);
            return true;
        },

        expand: function (id) {
            var obj = this;
            var nd  = this.get(id);
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'expand', target: id, object: nd });
            if (eventData.isCancelled === true) return;
            // default action
            $(this.box).find('#node_'+ w2utils.escapeId(id) +'_sub').slideDown(200);
            $(this.box).find('#node_'+ w2utils.escapeId(id) +' .w2ui-node-dots:first-child').html('<div class="w2ui-expand">-</div>');
            nd.expanded = true;
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            setTimeout(function () { obj.refresh(id); }, 200);
            return true;
        },

        expandAll: function (parent) {
            if (typeof parent == 'undefined') parent = this;
            if (typeof parent == 'string') parent = this.get(parent);
            if (parent.nodes == null) return false;
            for (var i = 0; i < parent.nodes.length; i++) {
                if (parent.nodes[i].expanded === false) parent.nodes[i].expanded = true;
                if (parent.nodes[i].nodes && parent.nodes[i].nodes.length > 0) this.collapseAll(parent.nodes[i]);
            }
            this.refresh(parent.id);
        },

        expandParents: function (id) {
            var node = this.get(id);
            if (node === null) return false;
            if (node.parent) {
                node.parent.expanded = true;
                this.expandParents(node.parent.id);
            }
            this.refresh(id);
            return true;
        },

        click: function (id, event) {
            var obj = this;
            var nd  = this.get(id);
            if (nd === null) return;
            if (nd.disabled || nd.group) return; // should click event if already selected
            // unselect all previsously
            $(obj.box).find('.w2ui-node.w2ui-selected').each(function (index, el) {
                var oldID     = $(el).attr('id').replace('node_', '');
                var oldNode = obj.get(oldID);
                if (oldNode != null) oldNode.selected = false;
                $(el).removeClass('w2ui-selected').find('.w2ui-icon').removeClass('w2ui-icon-selected');
            });
            // select new one
            var newNode = $(obj.box).find('#node_'+ w2utils.escapeId(id));
            var oldNode = $(obj.box).find('#node_'+ w2utils.escapeId(obj.selected));
            newNode.addClass('w2ui-selected').find('.w2ui-icon').addClass('w2ui-icon-selected');
            // need timeout to allow rendering
            setTimeout(function () {
                // event before
                var eventData = obj.trigger({ phase: 'before', type: 'click', target: id, originalEvent: event, node: nd, object: nd });
                if (eventData.isCancelled === true) {
                    // restore selection
                    newNode.removeClass('w2ui-selected').find('.w2ui-icon').removeClass('w2ui-icon-selected');
                    oldNode.addClass('w2ui-selected').find('.w2ui-icon').addClass('w2ui-icon-selected');
                    return;
                }
                // default action
                if (oldNode !== null) oldNode.selected = false;
                obj.get(id).selected = true;
                obj.selected = id;
                // route processing
                if (nd.route) {
                    var route = String('/'+ nd.route).replace(/\/{2,}/g, '/');
                    var info  = w2utils.parseRoute(route);
                    if (info.keys.length > 0) {
                        for (var k = 0; k < info.keys.length; k++) {
                            if (obj.routeData[info.keys[k].name] == null) continue;
                            route = route.replace((new RegExp(':'+ info.keys[k].name, 'g')), obj.routeData[info.keys[k].name]);
                        }
                    }
                    setTimeout(function () { window.location.hash = route; }, 1);
                }
                // event after
                obj.trigger($.extend(eventData, { phase: 'after' }));
            }, 1);
        },

        keydown: function (event) {
            var obj = this;
            var nd  = obj.get(obj.selected);
            if (!nd || obj.keyboard !== true) return;
            // trigger event
            var eventData = obj.trigger({ phase: 'before', type: 'keydown', target: obj.name, originalEvent: event });
            if (eventData.isCancelled === true) return;
            // default behaviour
            if (event.keyCode == 13 || event.keyCode == 32) { // enter or space
                if (nd.nodes.length > 0) obj.toggle(obj.selected);
            }
            if (event.keyCode == 37) { // left
                if (nd.nodes.length > 0 && nd.expanded) {
                    obj.collapse(obj.selected);
                } else {
                    selectNode(nd.parent);
                    if (!nd.parent.group) obj.collapse(nd.parent.id);
                }
            }
            if (event.keyCode == 39) { // right
                if ((nd.nodes.length > 0 || nd.plus) && !nd.expanded) obj.expand(obj.selected);
            }
            if (event.keyCode == 38) { // up
                selectNode(neighbor(nd, prev));
            }
            if (event.keyCode == 40) { // down
                selectNode(neighbor(nd, next));
            }
            // cancel event if needed
            if ($.inArray(event.keyCode, [13, 32, 37, 38, 39, 40]) != -1) {
                if (event.preventDefault) event.preventDefault();
                if (event.stopPropagation) event.stopPropagation();
            }
            // event after
            obj.trigger($.extend(eventData, { phase: 'after' }));

            function selectNode (node, event) {
                if (node !== null && !node.hidden && !node.disabled && !node.group) {
                    obj.click(node.id, event);
                    setTimeout(function () { obj.scrollIntoView(); }, 50);
                }
            }

            function neighbor (node, neighborFunc) {
                node = neighborFunc(node);
                while (node !== null && (node.hidden || node.disabled)) {
                    if (node.group) break; else node = neighborFunc(node);
                }
                return node;
            }

            function next (node, noSubs) {
                if (node === null) return null;
                var parent   = node.parent;
                var ind      = obj.get(node.id, true);
                var nextNode = null;
                // jump inside
                if (node.expanded && node.nodes.length > 0 && noSubs !== true) {
                    var t = node.nodes[0];
                    if (t.hidden || t.disabled || t.group) nextNode = next(t); else nextNode = t;
                } else {
                    if (parent && ind + 1 < parent.nodes.length) {
                        nextNode = parent.nodes[ind + 1];
                    } else {
                        nextNode = next(parent, true); // jump to the parent
                    }
                }
                if (nextNode !== null && (nextNode.hidden || nextNode.disabled || nextNode.group)) nextNode = next(nextNode);
                return nextNode;
            }

            function prev (node) {
                if (node === null) return null;
                var parent   = node.parent;
                var ind      = obj.get(node.id, true);
                var prevNode = (ind > 0) ? lastChild(parent.nodes[ind - 1]) : parent;
                if (prevNode !== null && (prevNode.hidden || prevNode.disabled || prevNode.group)) prevNode = prev(prevNode);
                return prevNode;
            }

            function lastChild (node) {
                if (node.expanded && node.nodes.length > 0) {
                    var t = node.nodes[node.nodes.length - 1];
                    if (t.hidden || t.disabled || t.group) return prev(t); else return lastChild(t);
                }
                return node;
            }
        },

        scrollIntoView: function (id) {
            if (typeof id == 'undefined') id = this.selected;
            var nd = this.get(id);
            if (nd === null) return;
            var body   = $(this.box).find('.w2ui-sidebar-div');
            var item   = $(this.box).find('#node_'+ w2utils.escapeId(id));
            var offset = item.offset().top - body.offset().top;
            if (offset + item.height() > body.height()) {
                body.animate({ 'scrollTop': body.scrollTop() + body.height() / 1.3 }, 250, 'linear');
            }
            if (offset <= 0) {
                body.animate({ 'scrollTop': body.scrollTop() - body.height() / 1.3 }, 250, 'linear');
            }
        },

        dblClick: function (id, event) {
            // if (window.getSelection) window.getSelection().removeAllRanges(); // clear selection
            var nd = this.get(id);
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'dblClick', target: id, originalEvent: event, object: nd });
            if (eventData.isCancelled === true) return;
            // default action
            this.toggle(id);
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        contextMenu: function (id, event) {
            var obj = this;
            var nd  = obj.get(id);
            if (id != obj.selected) obj.click(id);
            // need timeout to allow click to finish first
            setTimeout(function () {
                // event before
                var eventData = obj.trigger({ phase: 'before', type: 'contextMenu', target: id, originalEvent: event, object: nd });
                if (eventData.isCancelled === true) return;
                // default action
                if (nd.group || nd.disabled) return;
                if (obj.menu.length > 0) {
                    $(obj.box).find('#node_'+ w2utils.escapeId(id))
                        .w2menu(obj.menu, {
                            left    : (event ? event.offsetX || event.pageX : 50) - 25,
                            onSelect: function (event) { 
                                obj.menuClick(id, parseInt(event.index), event.originalEvent); 
                            }
                        }
                    );
                }
                // event after
                obj.trigger($.extend(eventData, { phase: 'after' }));
            }, 150); // need timer 150 for FF
        },

        menuClick: function (itemId, index, event) {
            var obj = this;
            // event before
            var eventData = obj.trigger({ phase: 'before', type: 'menuClick', target: itemId, originalEvent: event, menuIndex: index, menuItem: obj.menu[index] });
            if (eventData.isCancelled === true) return;
            // default action
            // -- empty
            // event after
            obj.trigger($.extend(eventData, { phase: 'after' }));
        },

        render: function (box) {
            var time = (new Date()).getTime();
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'render', target: this.name, box: box });
            if (eventData.isCancelled === true) return;
            // default action
            if (typeof box != 'undefined' && box !== null) {
                if ($(this.box).find('> div > div.w2ui-sidebar-div').length > 0) {
                    $(this.box)
                        .removeAttr('name')
                        .removeClass('w2ui-reset w2ui-sidebar')
                        .html('');
                }
                this.box = box;
            }
            if (!this.box) return;
            $(this.box)
                .attr('name', this.name)
                .addClass('w2ui-reset w2ui-sidebar')
                .html('<div>'+
                        '<div class="w2ui-sidebar-top"></div>' +
                        '<div class="w2ui-sidebar-div"></div>'+
                        '<div class="w2ui-sidebar-bottom"></div>'+
                    '</div>'
                );
            $(this.box).find('> div').css({
                width    : $(this.box).width() + 'px',
                height: $(this.box).height() + 'px'
            });
            if ($(this.box).length > 0) $(this.box)[0].style.cssText += this.style;
            // adjust top and bottom
            if (this.topHTML !== '') {
                $(this.box).find('.w2ui-sidebar-top').html(this.topHTML);
                $(this.box).find('.w2ui-sidebar-div')
                    .css('top', $(this.box).find('.w2ui-sidebar-top').height() + 'px');
            }
            if (this.bottomHTML !== '') {
                $(this.box).find('.w2ui-sidebar-bottom').html(this.bottomHTML);
                $(this.box).find('.w2ui-sidebar-div')
                    .css('bottom', $(this.box).find('.w2ui-sidebar-bottom').height() + 'px');
            }
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            // ---
            this.refresh();
            return (new Date()).getTime() - time;
        },

        refresh: function (id) {
            var time = (new Date()).getTime();
            // if (window.getSelection) window.getSelection().removeAllRanges(); // clear selection
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'refresh', target: (typeof id != 'undefined' ? id : this.name) });
            if (eventData.isCancelled === true) return;
            // adjust top and bottom
            if (this.topHTML !== '') {
                $(this.box).find('.w2ui-sidebar-top').html(this.topHTML);
                $(this.box).find('.w2ui-sidebar-div')
                    .css('top', $(this.box).find('.w2ui-sidebar-top').height() + 'px');
            }
            if (this.bottomHTML !== '') {
                $(this.box).find('.w2ui-sidebar-bottom').html(this.bottomHTML);
                $(this.box).find('.w2ui-sidebar-div')
                    .css('bottom', $(this.box).find('.w2ui-sidebar-bottom').height() + 'px');
            }
            // default action
            $(this.box).find('> div').css({
                width : $(this.box).width() + 'px',
                height: $(this.box).height() + 'px'
            });
            var obj = this;
            var node, nd;
            var nm;
            if (typeof id == 'undefined') {
                node = this;
                nm   = '.w2ui-sidebar-div';
            } else {
                node = this.get(id);
                if (node === null) return;
                nm   = '#node_'+ w2utils.escapeId(node.id) + '_sub';
            }
            var nodeHTML;
            if (node !== this) {
                var tmp    = '#node_'+ w2utils.escapeId(node.id);
                nodeHTML    = getNodeHTML(node);
                $(this.box).find(tmp).before('<div id="sidebar_'+ this.name + '_tmp"></div>');
                $(this.box).find(tmp).remove();
                $(this.box).find(nm).remove();
                $('#sidebar_'+ this.name + '_tmp').before(nodeHTML);
                $('#sidebar_'+ this.name + '_tmp').remove();
            }
            // refresh sub nodes
            $(this.box).find(nm).html('');
            for (var i = 0; i < node.nodes.length; i++) {
                nd = node.nodes[i];
                nodeHTML = getNodeHTML(nd);
                $(this.box).find(nm).append(nodeHTML);
                if (nd.nodes.length !== 0) { this.refresh(nd.id); }
            }
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            return (new Date()).getTime() - time;

            function getNodeHTML(nd) {
                var html = '';
                var img  = nd.img;
                if (img === null) img = this.img;
                var icon = nd.icon;
                if (icon === null) icon = this.icon;
                // -- find out level
                var tmp   = nd.parent;
                var level = 0;
                while (tmp && tmp.parent !== null) {
                    if (tmp.group) level--;
                    tmp = tmp.parent;
                    level++;
                }
                if (typeof nd.caption != 'undefined') nd.text = nd.caption;
                if (nd.group) {
                    html =
                        '<div class="w2ui-node-group"  id="node_'+ nd.id +'"'+
                        '        onclick="w2ui[\''+ obj.name +'\'].toggle(\''+ nd.id +'\')"'+
                        '        onmouseout="$(this).find(\'span:nth-child(1)\').css(\'color\', \'transparent\')" '+
                        '        onmouseover="$(this).find(\'span:nth-child(1)\').css(\'color\', \'inherit\')">'+
                        (nd.groupShowHide ? '<span>'+ (!nd.hidden && nd.expanded ? w2utils.lang('Hide') : w2utils.lang('Show')) +'</span>' : '<span></span>') +
                        '    <span>'+ nd.text +'</span>'+
                        '</div>'+
                        '<div class="w2ui-node-sub" id="node_'+ nd.id +'_sub" style="'+ nd.style +';'+ (!nd.hidden && nd.expanded ? '' : 'display: none;') +'"></div>';
                } else {
                    if (nd.selected && !nd.disabled) obj.selected = nd.id;
                    tmp = '';
                    if (img) tmp = '<div class="w2ui-node-image w2ui-icon '+ img +    (nd.selected && !nd.disabled ? " w2ui-icon-selected" : "") +'"></div>';
                    if (icon) tmp = '<div class="w2ui-node-image"><span class="'+ icon +'"></span></div>';
                    html =
                    '<div class="w2ui-node '+ (nd.selected ? 'w2ui-selected' : '') +' '+ (nd.disabled ? 'w2ui-disabled' : '') +'" id="node_'+ nd.id +'" style="'+ (nd.hidden ? 'display: none;' : '') +'"'+
                        '    ondblclick="w2ui[\''+ obj.name +'\'].dblClick(\''+ nd.id +'\', event);"'+
                        '    oncontextmenu="w2ui[\''+ obj.name +'\'].contextMenu(\''+ nd.id +'\', event); '+
                        '        if (event.preventDefault) event.preventDefault();"'+
                        '    onClick="w2ui[\''+ obj.name +'\'].click(\''+ nd.id +'\', event); ">'+
                        '<table cellpadding="0" cellspacing="0" style="margin-left:'+ (level*18) +'px; padding-right:'+ (level*18) +'px"><tr>'+
                        '<td class="w2ui-node-dots" nowrap onclick="w2ui[\''+ obj.name +'\'].toggle(\''+ nd.id +'\'); '+
                        '        if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;">'+
                        '    <div class="w2ui-expand">'    + (nd.nodes.length > 0 ? (nd.expanded ? '-' : '+') : (nd.plus ? '+' : '')) + '</div>' +
                        '</td>'+
                        '<td class="w2ui-node-data" nowrap>'+
                            tmp +
                            (nd.count || nd.count === 0 ? '<div class="w2ui-node-count">'+ nd.count +'</div>' : '') +
                            '<div class="w2ui-node-caption">'+ nd.text +'</div>'+
                        '</td>'+
                        '</tr></table>'+
                    '</div>'+
                    '<div class="w2ui-node-sub" id="node_'+ nd.id +'_sub" style="'+ nd.style +';'+ (!nd.hidden && nd.expanded ? '' : 'display: none;') +'"></div>';
                }
                return html;
            }
        },

        resize: function () {
            var time = (new Date()).getTime();
            // if (window.getSelection) window.getSelection().removeAllRanges(); // clear selection
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'resize', target: this.name });
            if (eventData.isCancelled === true) return;
            // default action
            $(this.box).css('overflow', 'hidden');    // container should have no overflow
            //$(this.box).find('.w2ui-sidebar-div').css('overflow', 'hidden');
            $(this.box).find('> div').css({
                width        : $(this.box).width() + 'px',
                height    : $(this.box).height() + 'px'
            });
            //$(this.box).find('.w2ui-sidebar-div').css('overflow', 'auto');
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            return (new Date()).getTime() - time;
        },

        destroy: function () {
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'destroy', target: this.name });
            if (eventData.isCancelled === true) return;
            // clean up
            if ($(this.box).find('> div > div.w2ui-sidebar-div').length > 0) {
                $(this.box)
                    .removeAttr('name')
                    .removeClass('w2ui-reset w2ui-sidebar')
                    .html('');
            }
            delete w2ui[this.name];
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        lock: function (msg, showSpinner) {
            var box = $(this.box).find('> div:first-child');
            var args = Array.prototype.slice.call(arguments, 0);
            args.unshift(box);
            w2utils.lock.apply(window, args);
        },

        unlock: function () {
            w2utils.unlock(this.box);
        }
    };

    $.extend(w2sidebar.prototype, w2utils.event);
    w2obj.sidebar = w2sidebar;
})();

/************************************************************************
*   Library: Web 2.0 UI for jQuery (using prototypical inheritance)
*   - Following objects defined
*        - w2field        - various field controls
*        - $().w2field    - jQuery wrapper
*   - Dependencies: jQuery, w2utils
*
* == NICE TO HAVE ==
*   - upload (regular files)
*   - BUG with prefix/postfix and arrows (test in different contexts)
*   - prefix and suffix are slow (100ms or so)
*   - multiple date selection
*   - month selection, year selections
*   - arrows no longer work (for int)
*   - form to support custom types
*   - bug: if input is hidden and then enum is applied, then when it becomes visible, it will be 110px
*
************************************************************************/

(function ($) {

    var w2field = function (options) {
        // public properties
        this.el          = null
        this.helpers     = {}; // object or helper elements
        this.type        = options.type || 'text';
        this.options     = $.extend(true, {}, options);
        this.onSearch    = options.onSearch    || null;
        this.onRequest   = options.onRequest   || null;
        this.onLoad      = options.onLoad      || null;
        this.onError     = options.onError     || null;
        this.onClick     = options.onClick     || null;
        this.onAdd       = options.onAdd       || null;
        this.onNew       = options.onNew       || null;
        this.onRemove    = options.onRemove    || null;
        this.onMouseOver = options.onMouseOver || null;
        this.onMouseOut  = options.onMouseOut  || null;
        this.onIconClick = options.onIconClick || null;
        this.tmp         = {}; // temp object
        // clean up some options
        delete this.options.type;
        delete this.options.onSearch;
        delete this.options.onRequest;
        delete this.options.onLoad;
        delete this.options.onError;
        delete this.options.onClick;
        delete this.options.onMouseOver;
        delete this.options.onMouseOut;
        delete this.options.onIconClick;
        // extend with defaults
        $.extend(true, this, w2obj.field);
    };

    // ====================================================
    // -- Registers as a jQuery plugin

    $.fn.w2field = function (method, options) {
        // call direct
        if (this.length == 0) {
            var pr = w2field.prototype;
            if (pr[method]) {
                return pr[method].apply(pr, Array.prototype.slice.call(arguments, 1));
            }
        } else {
            // if without arguments - return the object
            if (arguments.length == 0) {
                var obj = $(this).data('w2field');
                return obj;
            }
            if (typeof method == 'string' && typeof options == 'object') {
                method = $.extend(true, {}, options, { type: method });
            }
            if (typeof method == 'string' && typeof options == 'undefined') {
                method = { type: method };
            }
            method.type = String(method.type).toLowerCase();
            return this.each(function (index, el) {
                var obj = $(el).data('w2field');
                // if object is not defined, define it
                if (typeof obj == 'undefined') {
                    var obj = new w2field(method);
                    $.extend(obj, { handlers: [] });
                    if (el) obj.el = $(el)[0];
                    obj.init();
                    $(el).data('w2field', obj);
                    return obj;
                } else { // fully re-init
                    obj.clear();
                    if (method.type == 'clear') return;
                    var obj = new w2field(method);
                    $.extend(obj, { handlers: [] });
                    if (el) obj.el = $(el)[0];
                    obj.init();
                    $(el).data('w2field', obj);
                    return obj;
                }
                return null;
            });
        }
    }

    // ====================================================
    // -- Implementation of core functionality

    /*     To add custom types
        $().w2field('addType', 'myType', function (options) {
            $(this.el).on('keypress', function (event) {
                if (event.metaKey || event.ctrlKey || event.altKey
                    || (event.charCode != event.keyCode && event.keyCode > 0)) return;
                var ch = String.fromCharCode(event.charCode);
                if (ch != 'a' && ch != 'b' && ch != 'c') {
                    if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;
                    return false;
                }
            });
            $(this.el).on('blur', function (event)  { // keyCode & charCode differ in FireFox
                var ch = this.value;
                if (ch != 'a' && ch != 'b' && ch != 'c') {
                    $(this).w2tag(w2utils.lang("Not a single charecter from the set of 'abc'"));
                }
            });
        });
    */

    w2field.prototype = {

        custom: {},  // map of custom types

        pallete: [
            ['000000', '444444', '666666', '999999', 'CCCCCC', 'EEEEEE', 'F3F3F3', 'FFFFFF'],
            ['FF011B', 'FF9838', 'FFFD59', '01FD55', '00FFFE', '0424F3', '9B24F4', 'FF21F5'],
            ['F4CCCC', 'FCE5CD', 'FFF2CC', 'D9EAD3', 'D0E0E3', 'CFE2F3', 'D9D1E9', 'EAD1DC'],
            ['EA9899', 'F9CB9C', 'FEE599', 'B6D7A8', 'A2C4C9', '9FC5E8', 'B4A7D6', 'D5A6BD'],
            ['E06666', 'F6B26B', 'FED966', '93C47D', '76A5AF', '6FA8DC', '8E7CC3', 'C27BA0'],
            ['CC0814', 'E69138', 'F1C232', '6AA84F', '45818E', '3D85C6', '674EA7', 'A54D79'],
            ['99050C', 'B45F17', 'BF901F', '37761D', '124F5C', '0A5394', '351C75', '741B47'],
            ['660205', '783F0B', '7F6011', '274E12', '0C343D', '063762', '20124D', '4C1030']
        ],

        addType: function (type, handler) {
            type = String(type).toLowerCase();
            this.custom[type] = handler;
            return true;
        },

        removeType: function (type) {
            type = String(type).toLowerCase();
            if (!this.custom[type]) return false;
            delete this.custom[type];
            return true
        },

        init: function () {
            var obj     = this;
            var options = this.options;
            var defaults;

            // Custom Types
            if (typeof this.custom[this.type] == 'function') {
                this.custom[this.type].call(this, options);
                return;
            }
            // only for INPUT or TEXTAREA
            if (['INPUT', 'TEXTAREA'].indexOf(this.el.tagName) == -1) {
                console.log('ERROR: w2field could only be applied to INPUT or TEXTAREA.', this.el);
                return;
            }

            switch (this.type) {
                case 'text':
                case 'int':
                case 'float':
                case 'money':
                case 'currency':
                case 'percent':
                case 'alphanumeric':
                case 'hex':
                    defaults = {
                        min                : null,
                        max                : null,
                        step               : 1,
                        placeholder        : '',
                        autoFormat         : true,
                        currencyPrefix     : w2utils.settings.currencyPrefix,
                        currencySuffix     : w2utils.settings.currencySuffix,
                        currencyPrecision  : w2utils.settings.currencyPrecision,
                        decimalSymbol      : w2utils.settings.decimalSymbol,
                        groupSymbol        : w2utils.settings.groupSymbol,
                        arrows             : false,
                        keyboard           : true,
                        precision          : null,
                        silent             : true,
                        prefix             : '',
                        suffix             : ''
                    };
                    this.options = $.extend(true, {}, defaults, options);
                    options = this.options; // since object is re-created, need to re-assign
                    options.numberRE  = new RegExp('['+ options.groupSymbol + ']', 'g');
                    options.moneyRE   = new RegExp('['+ options.currencyPrefix + options.currencySuffix + options.groupSymbol +']', 'g');
                    options.percentRE = new RegExp('['+ options.groupSymbol + '%]', 'g');
                    // no keyboard support needed
                    if (['text', 'alphanumeric', 'hex'].indexOf(this.type) != -1) {
                        options.arrows   = false;
                        options.keyboard = false;
                    }
                    this.addPrefix(); // only will add if needed
                    this.addSuffix();
                    if ($(this.el).attr('placeholder') && options.placeholder == '') options.placeholder = $(this.el).attr('placeholder');
                    $(this.el).attr('placeholder', options.placeholder);
                    break;

                case 'color':
                    defaults = {
                        prefix      : '#',
                        suffix      : '<div style="width: '+ (parseInt($(this.el).css('font-size')) || 12) +'px">&nbsp;</div>',
                        placeholder : '',
                        arrows      : false,
                        keyboard    : false
                    };
                    $.extend(options, defaults);
                    this.addPrefix();    // only will add if needed
                    this.addSuffix();    // only will add if needed
                    // additional checks
                    $(this.el).attr('maxlength', 6);
                    if ($(this.el).val() != '') setTimeout(function () { $(obj.el).change(); }, 1);
                    if ($(this.el).attr('placeholder') && options.placeholder == '') options.placeholder = $(this.el).attr('placeholder');
                    $(this.el).attr('placeholder', options.placeholder);
                    break;

                case 'date':
                    defaults = {
                        format      : w2utils.settings.date_format, // date format
                        placeholder : '',
                        keyboard    : true,
                        silent      : true,
                        start       : '',       // string or jquery object
                        end         : '',       // string or jquery object
                        blocked     : {},       // { '4/11/2011': 'yes' }
                        colored     : {}        // { '4/11/2011': 'red:white' }
                    };
                    this.options = $.extend(true, {}, defaults, options);
                    options = this.options; // since object is re-created, need to re-assign
                    if ($(this.el).attr('placeholder') && options.placeholder == '') options.placeholder = $(this.el).attr('placeholder');
                    $(this.el).attr('placeholder', options.placeholder ? options.placeholder : options.format);
                    break;

                case 'time':
                    defaults = {
                        format      : w2utils.settings.time_format,
                        placeholder : '',
                        keyboard    : true,
                        silent      : true,
                        start       : '',
                        end         : ''
                    };
                    this.options = $.extend(true, {}, defaults, options);
                    options = this.options; // since object is re-created, need to re-assign
                    if ($(this.el).attr('placeholder') && options.placeholder == '') options.placeholder = $(this.el).attr('placeholder');
                    $(this.el).attr('placeholder', options.placeholder ? options.placeholder : (options.format == 'h12' ? 'hh:mi pm' : 'hh:mi'));
                    break;

                case 'datetime':
                    break;

                case 'list':
                case 'combo':
                    defaults = {
                        items           : [],
                        selected        : {},
                        placeholder     : '',
                        url             : null,         // url to pull data from
                        postData        : {},
                        minLength       : 1,
                        cacheMax        : 250,
                        maxDropHeight   : 350,          // max height for drop down menu
                        match           : 'begins',     // ['contains', 'is', 'begins', 'ends']
                        silent          : true,
                        icon            : null,
                        iconStyle       : '',
                        onSearch        : null,         // when search needs to be performed
                        onRequest       : null,         // when request is submitted
                        onLoad          : null,         // when data is received
                        onError         : null,         // when data fails to load due to server error or other failure modes
                        onIconClick     : null,
                        renderDrop      : null,         // render function for drop down item
                        prefix          : '',
                        suffix          : '',
                        openOnFocus     : false,        // if to show overlay onclick or when typing
                        markSearch      : false
                    };
                    options.items = this.normMenu(options.items); // need to be first
                    if (this.type == 'list') {
                        // defaults.search = (options.items && options.items.length >= 10 ? true : false);
                        defaults.openOnFocus = true;
                        defaults.suffix = '<div class="arrow-down" style="margin-top: '+ ((parseInt($(this.el).height()) - 6) / 2) +'px;"></div>';
                        $(this.el).addClass('w2ui-select');
                        // if simple value - look it up
                        if (!$.isPlainObject(options.selected)) {
                            for (var i in options.items) {
                                var item = options.items[i];
                                if (item && item.id == options.selected) {
                                    options.selected = $.extend(true, {}, item);
                                    break;
                                }
                            }
                        }
                    }
                    options = $.extend({}, defaults, options, {
                        align   : 'both',      // same width as control
                        altRows : true         // alternate row color
                    });
                    this.options = options;
                    if (!$.isPlainObject(options.selected)) options.selected = {};
                    $(this.el).data('selected', options.selected);
                    if (options.url) this.request(0);
                    if (this.type == 'list') this.addFocus();
                    this.addPrefix();
                    this.addSuffix();
                    setTimeout(function () { obj.refresh(); }, 10); // need this for icon refresh
                    if ($(this.el).attr('placeholder') && options.placeholder == '') options.placeholder = $(this.el).attr('placeholder');
                    $(this.el).attr('placeholder', options.placeholder).attr('autocomplete', 'off');
                    if (typeof options.selected.text != 'undefined') $(this.el).val(options.selected.text);
                    break;

                case 'enum':
                    defaults = {
                        items           : [],
                        selected        : [],
                        placeholder     : '',
                        max             : 0,             // max number of selected items, 0 - unlim
                        url             : null,          // not implemented
                        postData        : {},
                        minLength       : 1, 
                        cacheMax        : 250,
                        maxWidth        : 250,           // max width for a single item
                        maxHeight       : 350,           // max height for input control to grow
                        maxDropHeight   : 350,           // max height for drop down menu
                        match           : 'contains',    // ['contains', 'is', 'begins', 'ends']
                        silent          : true,
                        openOnFocus     : false,         // if to show overlay onclick or when typing
                        markSearch      : true,
                        renderDrop      : null,          // render function for drop down item
                        renderItem      : null,          // render selected item
                        style           : '',            // style for container div
                        onSearch        : null,          // when search needs to be performed
                        onRequest       : null,          // when request is submitted
                        onLoad          : null,          // when data is received
                        onError         : null,          // when data fails to load due to server error or other failure modes
                        onClick         : null,          // when an item is clicked
                        onAdd           : null,          // when an item is added
                        onNew           : null,          // when new item should be added
                        onRemove        : null,          // when an item is removed
                        onMouseOver     : null,          // when an item is mouse over
                        onMouseOut      : null           // when an item is mouse out
                    };
                    options = $.extend({}, defaults, options, {
                        align    : 'both',    // same width as control
                        suffix   : '',
                        altRows  : true       // alternate row color
                    });
                    options.items      = this.normMenu(options.items);
                    options.selected = this.normMenu(options.selected);
                    this.options = options;
                    if (!$.isArray(options.selected)) options.selected = [];
                    $(this.el).data('selected', options.selected);
                    if (options.url) this.request(0);
                    this.addSuffix();
                    this.addMulti();
                    break;

                case 'file':
                    defaults = {
                        selected      : [],
                        placeholder   : w2utils.lang('Attach files by dragging and dropping or Click to Select'),
                        max           : 0,
                        maxSize       : 0,        // max size of all files, 0 - unlim
                        maxFileSize   : 0,        // max size of a single file, 0 -unlim
                        maxWidth      : 250,      // max width for a single item
                        maxHeight     : 350,      // max height for input control to grow
                        maxDropHeight : 350,      // max height for drop down menu
                        silent        : true,
                        renderItem    : null,     // render selected item
                        style         : '',       // style for container div
                        onClick       : null,     // when an item is clicked
                        onAdd         : null,     // when an item is added
                        onRemove      : null,     // when an item is removed
                        onMouseOver   : null,     // when an item is mouse over
                        onMouseOut    : null      // when an item is mouse out
                    };
                    options = $.extend({}, defaults, options, {
                        align         : 'both',   // same width as control
                        altRows        : true     // alternate row color
                    });
                    this.options = options;
                    if (!$.isArray(options.selected)) options.selected = [];
                    $(this.el).data('selected', options.selected);
                    if ($(this.el).attr('placeholder')) options.placeholder = $(this.el).attr('placeholder');
                    this.addMulti();
                    break;
            }
            // attach events
            this.tmp = {
                onChange    : function (event) { obj.change.call(obj, event) },
                onClick     : function (event) { obj.click.call(obj, event) },
                onFocus     : function (event) { obj.focus.call(obj, event) },
                onBlur      : function (event) { obj.blur.call(obj, event) },
                onKeydown   : function (event) { obj.keyDown.call(obj, event) },
                onKeyup     : function (event) { obj.keyUp.call(obj, event) },
                onKeypress  : function (event) { obj.keyPress.call(obj, event) }
            }
            $(this.el)
                .addClass('w2field')
                .data('w2field', this)
                .on('change',   this.tmp.onChange)
                .on('click',    this.tmp.onClick)         // ignore click because it messes overlays
                .on('focus',    this.tmp.onFocus)
                .on('blur',     this.tmp.onBlur)
                .on('keydown',  this.tmp.onKeydown)
                .on('keyup',    this.tmp.onKeyup)
                .on('keypress', this.tmp.onKeypress)
                .css({
                    'box-sizing'         : 'border-box',
                    '-webkit-box-sizing' : 'border-box',
                    '-moz-box-sizing'    : 'border-box',
                    '-ms-box-sizing'     : 'border-box',
                    '-o-box-sizing'      : 'border-box'
                });
            // format initial value
            this.change($.Event('change'));
        },

        clear: function () {
            var obj        = this;
            var options    = this.options;
            // if money then clear value
            if (['money', 'currency'].indexOf(this.type) != -1) {
                $(this.el).val($(this.el).val().replace(options.moneyRE, ''));
            }
            if (this.type == 'percent') {
                $(this.el).val($(this.el).val().replace(/%/g, ''));
            }
            if (this.type == 'color') {
                $(this.el).removeAttr('maxlength');
            }
            if (this.type == 'list') {
                $(this.el).removeClass('w2ui-select');
            }
            if (['date', 'time'].indexOf(this.type) != -1) {
                if ($(this.el).attr('placeholder') == options.format) $(this.el).attr('placeholder', '');
            }
            this.type = 'clear';
            var tmp = $(this.el).data('tmp');
            if (!this.tmp) return;
            // restore paddings
            if (typeof tmp != 'undefined') {
                if (tmp && tmp['old-padding-left'])  $(this.el).css('padding-left',  tmp['old-padding-left']);
                if (tmp && tmp['old-padding-right']) $(this.el).css('padding-right', tmp['old-padding-right']);
            }
            // remove events and data
            $(this.el)
                .val(this.clean($(this.el).val()))
                .removeClass('w2field')
                .removeData() // removes all attached data
                .off('change',   this.tmp.onChange)
                .off('click',    this.tmp.onClick)
                .off('focus',    this.tmp.onFocus)
                .off('blur',     this.tmp.onBlur)
                .off('keydown',  this.tmp.onKeydown)
                .off('keyup',    this.tmp.onKeyup)
                .off('keypress', this.tmp.onKeypress);
            // remove helpers
            for (var h in this.helpers) $(this.helpers[h]).remove();
            this.helpers = {};
        },

        refresh: function () {
            var obj       = this;
            var options   = this.options;
            var selected  = $(this.el).data('selected');
            var time      = (new Date()).getTime();
            // enum
            if (['list'].indexOf(this.type) != -1) {
                $(obj.el).parent().css('white-space', 'nowrap'); // needs this for arrow alway to appear on the right side
                // hide focus and show text
                if (obj.helpers.prefix) obj.helpers.prefix.hide();
                setTimeout(function () {
                    if (!obj.helpers.focus) return;
                    // if empty show no icon
                    if (!$.isEmptyObject(selected) && options.icon) {
                        options.prefix = '<span class="w2ui-icon '+ options.icon +'"style="cursor: pointer; font-size: 14px;' + 
                                         ' display: inline-block; margin-top: -1px; color: #7F98AD;'+ options.iconStyle +'">'+
                            '</span>';
                        obj.addPrefix();                        
                    } else {
                        options.prefix = '';
                        obj.addPrefix();
                    }
                    // focus helpder
                    var focus = obj.helpers.focus.find('input');
                    if ($(focus).val() == '') {
                        $(focus).css('opacity', 0).prev().css('opacity', 0);
                        $(obj.el).val(selected && selected.text != null ? selected.text : '');
                        $(obj.el).attr('placeholder', options.placeholder || '');
                    } else {
                        $(focus).css('opacity', 1).prev().css('opacity', 1);
                        $(obj.el).val('');
                        $(obj.el).removeAttr('placeholder');
                        setTimeout(function () {
                            if (obj.helpers.prefix) obj.helpers.prefix.hide(); 
                            var tmp = 'position: absolute; opacity: 0; margin: 4px 0px 0px 2px; background-position: left !important;';
                            if (options.icon) {
                                $(focus).css('margin-left', '17px');
                                $(obj.helpers.focus).find('.icon-search').attr('style', tmp + 'width: 11px !important; opacity: 1');
                            } else {
                                $(focus).css('margin-left', '0px');
                                $(obj.helpers.focus).find('.icon-search').attr('style', tmp + 'width: 0px !important; opacity: 0');
                            }
                        }, 1);
                    }
                    // if readonly or disabled
                    if ($(obj.el).prop('readonly') || $(obj.el).prop('disabled')) {
                        setTimeout(function () { 
                            $(obj.helpers.prefix).css('opacity', '0.6'); 
                            $(obj.helpers.suffix).css('opacity', '0.6');
                        }, 1);
                    } else {
                        setTimeout(function () { 
                            $(obj.helpers.prefix).css('opacity', '1'); 
                            $(obj.helpers.suffix).css('opacity', '1');
                        }, 1);
                    }
                }, 1);
            }
            if (['enum', 'file'].indexOf(this.type) != -1) {
                var html = '';
                for (var s in selected) {
                    var it  = selected[s];
                    var ren = '';
                    if (typeof options.renderItem == 'function') {
                        ren = options.renderItem(it, s, '<div class="w2ui-list-remove" title="'+ w2utils.lang('Remove') +'" index="'+ s +'">&nbsp;&nbsp;</div>');
                    } else {
                        ren = '<div class="w2ui-list-remove" title="'+ w2utils.lang('Remove') +'" index="'+ s +'">&nbsp;&nbsp;</div>'+
                              (obj.type == 'enum' ? it.text : it.name + '<span class="file-size"> - '+ w2utils.size(it.size) +'</span>');
                    }
                    html += '<li index="'+ s +'" style="max-width: '+ parseInt(options.maxWidth) + 'px; '+ (it.style ? it.style : '') +'">'+
                            ren +'</li>';
                }
                var div = obj.helpers.multi;
                var ul  = div.find('ul');
                div.attr('style', div.attr('style') + ';' + options.style);
                if ($(obj.el).prop('readonly') || $(obj.el).prop('disabled')) {
                    div.addClass('w2ui-readonly'); 
                    div.css('pointer-events', 'none').find('li').css('opacity', '0.6');
                    $(obj.helpers.multi).find('input').prop('readonly', true);                    
                } else {
                    div.removeClass('w2ui-readonly');
                    div.css('pointer-events', 'auto').find('li').css('opacity', '1');
                    $(obj.helpers.multi).find('input').prop('readonly', false);
                }
                // celan
                div.find('.w2ui-enum-placeholder').remove();
                ul.find('li').not('li.nomouse').remove();
                // add new list
                if (html != '') {
                    ul.prepend(html);
                } else if (typeof options.placeholder != 'undefined') {
                    var style =
                        'padding-top: ' + $(this.el).css('padding-top') + ';'+
                        'padding-left: ' + $(this.el).css('padding-left') + '; ' +
                        'box-sizing: ' + $(this.el).css('box-sizing') + '; ' +
                        'line-height: ' + $(this.el).css('line-height') + '; ' +
                        'font-size: ' + $(this.el).css('font-size') + '; ' +
                        'font-family: ' + $(this.el).css('font-family') + '; ';
                    div.prepend('<div class="w2ui-enum-placeholder" style="'+ style +'">'+ options.placeholder + '</div>');
                }
                // ITEMS events
                div.find('li')
                    .data('mouse', 'out')
                    .on('click', function (event) {
                        var item = selected[$(event.target).attr('index')];
                        if ($(event.target).hasClass('nomouse')) return;
                        event.stopPropagation();
                        // trigger event
                        var eventData = obj.trigger({ phase: 'before', type: 'click', target: obj.el, originalEvent: event.originalEvent, item: item });
                        if (eventData.isCancelled === true) return;
                        // default behavior
                        if ($(event.target).hasClass('w2ui-list-remove')) {
                            if ($(obj.el).attr('readonly') || $(obj.el).attr('disabled')) return;
                            // trigger event
                            var eventData = obj.trigger({ phase: 'before', type: 'remove', target: obj.el, originalEvent: event.originalEvent, item: item });
                            if (eventData.isCancelled === true) return;
                            // default behavior
                            $().w2overlay();
                            selected.splice($(event.target).attr('index'), 1);
                            $(obj.el).trigger('change');
                            $(event.target).parent().fadeOut('fast');
                            setTimeout(function () {
                                obj.refresh();
                                // event after
                                obj.trigger($.extend(eventData, { phase: 'after' }));
                            }, 300);
                        }
                        if (obj.type == 'file' && !$(event.target).hasClass('w2ui-list-remove')) {
                            var preview = '';
                            if ((/image/i).test(item.type)) { // image
                                preview = '<div style="padding: 3px;">'+
                                    '    <img src="'+ (item.content ? 'data:'+ item.type +';base64,'+ item.content : '') +'" style="max-width: 300px;" '+
                                    '        onload="var w = $(this).width(); var h = $(this).height(); '+
                                    '            if (w < 300 & h < 300) return; '+
                                    '            if (w >= h && w > 300) $(this).width(300);'+
                                    '            if (w < h && h > 300) $(this).height(300);"'+
                                    '        onerror="this.style.display = \'none\'"'+
                                    '    >'+
                                    '</div>';
                            }
                            var td1 = 'style="padding: 3px; text-align: right; color: #777;"';
                            var td2 = 'style="padding: 3px"';
                            preview += '<div style="padding: 8px;">'+
                                '    <table cellpadding="2">'+
                                '    <tr><td '+ td1 +'>'+ w2utils.lang('Name') +':</td><td '+ td2 +'>'+ item.name +'</td></tr>'+
                                '    <tr><td '+ td1 +'>'+ w2utils.lang('Size') +':</td><td '+ td2 +'>'+ w2utils.size(item.size) +'</td></tr>'+
                                '    <tr><td '+ td1 +'>'+ w2utils.lang('Type') +':</td><td '+ td2 +'>' +
                                '        <span style="width: 200px; display: block-inline; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">'+ item.type +'</span>'+
                                '    </td></tr>'+
                                '    <tr><td '+ td1 +'>'+ w2utils.lang('Modified') +':</td><td '+ td2 +'>'+ w2utils.date(item.modified) +'</td></tr>'+
                                '    </table>'+
                                '</div>';
                                $(event.target).w2overlay(preview);
                        }
                        // event after
                        obj.trigger($.extend(eventData, { phase: 'after' }));
                    })
                    .on('mouseover', function (event) {
                        var tmp = event.target;
                        if (tmp.tagName != 'LI') tmp = tmp.parentNode;
                        if ($(tmp).hasClass('nomouse')) return;
                        if ($(tmp).data('mouse') == 'out') {
                            var item = selected[$(tmp).attr('index')];
                            // trigger event
                            var eventData = obj.trigger({ phase: 'before', type: 'mouseOver', target: obj.el, originalEvent: event.originalEvent, item: item });
                            if (eventData.isCancelled === true) return;
                            // event after
                            obj.trigger($.extend(eventData, { phase: 'after' }));
                        }
                        $(tmp).data('mouse', 'over');
                    })
                    .on('mouseout', function (event) {
                        var tmp = event.target;
                        if (tmp.tagName != 'LI') tmp = tmp.parentNode;
                        if ($(tmp).hasClass('nomouse')) return;
                        $(tmp).data('mouse', 'leaving');
                        setTimeout(function () {
                            if ($(tmp).data('mouse') == 'leaving') {
                                $(tmp).data('mouse', 'out');
                                var item = selected[$(tmp).attr('index')];
                                // trigger event
                                var eventData = obj.trigger({ phase: 'before', type: 'f', target: obj.el, originalEvent: event.originalEvent, item: item });
                                if (eventData.isCancelled === true) return;
                                // event after
                                obj.trigger($.extend(eventData, { phase: 'after' }));
                            }
                        }, 0);
                    });
                // adjust height
                $(this.el).height('auto');
                var cntHeight = $(div).find('> div').height() + w2utils.getSize(div, '+height') * 2;
                if (cntHeight < 26) cntHeight = 26;
                if (cntHeight > options.maxHeight) cntHeight = options.maxHeight;
                if (div.length > 0) div[0].scrollTop = 1000;
                var inpHeight = w2utils.getSize($(this.el), 'height') - 2;
                if (inpHeight > cntHeight) cntHeight = inpHeight
                $(div).css({ 'height': cntHeight + 'px', overflow: (cntHeight == options.maxHeight ? 'auto' : 'hidden') });
                if (cntHeight < options.maxHeight) $(div).prop('scrollTop', 0);
                $(this.el).css({ 'height' : (cntHeight + 2) + 'px' });
            }
            return (new Date()).getTime() - time;
        },

        reset: function () {
            var obj  = this;
            var type = this.type;
            this.clear();
            this.type = type;
            this.init();
        },

        clean: function (val) {
            var options = this.options;
            val = String(val).trim();
            // clean
            if (['int', 'float', 'money', 'currency', 'percent'].indexOf(this.type) != -1) {
                if (typeof val == 'string') val = val.replace(options.decimalSymbol, '.');
                if (options.autoFormat && ['money', 'currency'].indexOf(this.type) != -1) val = String(val).replace(options.moneyRE, '');
                if (options.autoFormat && this.type == 'percent') val = String(val).replace(options.percentRE, '');
                if (options.autoFormat && ['int', 'float'].indexOf(this.type) != -1) val = String(val).replace(options.numberRE, '');
                if (parseFloat(val) == val) {
                    if (options.min !== null && val < options.min) { val = options.min; $(this.el).val(options.min); }
                    if (options.max !== null && val > options.max) { val = options.max; $(this.el).val(options.max); }
                }
                if (val !== '' && w2utils.isFloat(val)) val = Number(val); else val = '';
            }
            return val;
        },

        format: function (val) {
            var options = this.options;
            // autoformat numbers or money
            if (options.autoFormat && val != '') {
                switch (this.type) {
                    case 'money':
                    case 'currency':
                        val = w2utils.formatNumber(Number(val).toFixed(options.currencyPrecision), options.groupSymbol);
                        if (val != '') val = options.currencyPrefix + val + options.currencySuffix;
                        break;
                    case 'percent':
                        val = w2utils.formatNumber(options.precision ? Number(val).toFixed(options.precision) : val, options.groupSymbol);
                        if (val != '') val += '%';
                        break;
                    case 'float':
                        val = w2utils.formatNumber(options.precision ? Number(val).toFixed(options.precision) : val, options.groupSymbol);
                        break;
                    case 'int':
                        val = w2utils.formatNumber(val, options.groupSymbol);
                        break;
                }
            }
            return val;
        },

        change: function (event) {
            var obj     = this;
            var options = obj.options;
            // numeric
            if (['int', 'float', 'money', 'currency', 'percent'].indexOf(this.type) != -1) {
                // check max/min
                var val     =  $(this.el).val();
                var new_val = this.format(this.clean($(this.el).val()));
                // if was modified
                if (val != '' && val != new_val) {
                    $(this.el).val(new_val).change();
                    // cancel event
                    event.stopPropagation();
                    event.preventDefault();
                    return false;
                }
            }
            // color
            if (this.type == 'color') {
                var color = '#' + $(this.el).val();
                if ($(this.el).val().length != 6 && $(this.el).val().length != 3) color = '';
                $(this.el).next().find('div').css('background-color', color);
                if ($(obj.el).is(':focus')) this.updateOverlay();
            }
            // list, enum
            if (['list', 'enum', 'file'].indexOf(this.type) != -1) {
                obj.refresh();
                // need time out to show icon indent properly
                setTimeout(function () { obj.refresh(); }, 5); 
            }
            // date, time
            if (['date', 'time'].indexOf(this.type) != -1) {
                // convert linux timestamps
                var tmp = parseInt(obj.el.value);
                if (w2utils.isInt(tmp) && tmp > 1000) {
                    if (this.type == 'time') $(obj.el).val(w2utils.formatTime(new Date(tmp), options.format)).change();
                    if (this.type == 'date') $(obj.el).val(w2utils.formatDate(new Date(tmp), options.format)).change();
                }
            }
        },

        click: function (event) {
            event.stopPropagation();
            // lists
            if (['list', 'combo', 'enum'].indexOf(this.type) != -1) {
                if (!$(this.el).is(':focus')) this.focus(event);
            }
            // other fields with drops
            if (['date', 'time', 'color'].indexOf(this.type) != -1) {
                this.updateOverlay();
            }
        },

        focus: function (event) {
            var obj     = this;
            var options = this.options;
            // color, date, time
            if (['color', 'date', 'time'].indexOf(obj.type) !== -1) {
                if ($(obj.el).attr('readonly') || $(obj.el).attr('disabled')) return;
                if ($("#w2ui-overlay").length > 0) $('#w2ui-overlay')[0].hide();
                setTimeout(function () { obj.updateOverlay(); }, 150);
            }
            // menu
            if (['list', 'combo', 'enum'].indexOf(obj.type) != -1) {
                if ($(obj.el).attr('readonly') || $(obj.el).attr('disabled')) return;
                if ($("#w2ui-overlay").length > 0) $('#w2ui-overlay')[0].hide();
                setTimeout(function () {
                    if (obj.type == 'list' && $(obj.el).is(':focus')) {
                        $(obj.helpers.focus).find('input').focus();
                        return;
                    }
                    obj.search();
                    setTimeout(function () { obj.updateOverlay(); }, 1);
                }, 1);
            }
            // file
            if (obj.type == 'file') {
                $(obj.helpers.multi).css({ 'outline': 'auto 5px #7DB4F3', 'outline-offset': '-2px' });
            }
        },

        blur: function (event) {
            var obj     = this;
            var options = obj.options;
            var val     = $(obj.el).val().trim();
            // hide overlay
            if (['color', 'date', 'time', 'list', 'combo', 'enum'].indexOf(obj.type) != -1) {
                if ($("#w2ui-overlay").length > 0) $('#w2ui-overlay')[0].hide();
            }
            if (['int', 'float', 'money', 'currency', 'percent'].indexOf(obj.type) != -1) {
                if (val !== '' && !obj.checkType(val)) {
                    $(obj.el).val('').change();
                    if (options.silent === false) {
                        $(obj.el).w2tag('Not a valid number');
                        setTimeout(function () { $(obj.el).w2tag(''); }, 3000);
                    }
                }
            }
            // date or time
            if (['date', 'time'].indexOf(obj.type) != -1) {
                // check if in range
                if (val !== '' && !obj.inRange(obj.el.value)) {
                    $(obj.el).val('').removeData('selected').change();
                    if (options.silent === false) {
                        $(obj.el).w2tag('Not in range');
                        setTimeout(function () { $(obj.el).w2tag(''); }, 3000);
                    }
                } else {
                    if (obj.type == 'date' && val !== '' && !w2utils.isDate(obj.el.value, options.format)) {
                        $(obj.el).val('').removeData('selected').change();
                        if (options.silent === false) {
                            $(obj.el).w2tag('Not a valid date');
                            setTimeout(function () { $(obj.el).w2tag(''); }, 3000);
                        }
                    }
                    if (obj.type == 'time' && val !== '' && !w2utils.isTime(obj.el.value)) {
                        $(obj.el).val('').removeData('selected').change();
                        if (options.silent === false) {
                            $(obj.el).w2tag('Not a valid time');
                            setTimeout(function () { $(obj.el).w2tag(''); }, 3000);
                        }
                    }
                }
            }
            // clear search input
            if (obj.type == 'enum') {
                $(obj.helpers.multi).find('input').val('').width(20);
            }
            // file
            if (obj.type == 'file') {
                $(obj.helpers.multi).css({ 'outline': 'none' });
            }
        },

        keyPress: function (event) {
            var obj     = this;
            var options = obj.options;
            // ignore wrong pressed key
            if (['int', 'float', 'money', 'currency', 'percent', 'hex', 'color', 'alphanumeric'].indexOf(obj.type) != -1) {
                // keyCode & charCode differ in FireFox
                if (event.metaKey || event.ctrlKey || event.altKey || (event.charCode != event.keyCode && event.keyCode > 0)) return;
                var ch = String.fromCharCode(event.charCode);
                if (!obj.checkType(ch, true) && event.keyCode != 13) {
                    event.preventDefault();
                    if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;
                    return false;
                }
            }
            // update date popup
            if (['date', 'time'].indexOf(obj.type) != -1) {
                setTimeout(function () { obj.updateOverlay(); }, 1);
            }
        },

        keyDown: function (event, extra) {
            var obj     = this;
            var options = obj.options;
            var key     = event.keyCode || (extra && extra.keyCode);
            // numeric
            if (['int', 'float', 'money', 'currency', 'percent'].indexOf(obj.type) != -1) {
                if (!options.keyboard || $(obj.el).attr('readonly')) return;
                var cancel = false;
                var val = parseFloat($(obj.el).val().replace(options.moneyRE, '')) || 0;
                var inc = options.step;
                if (event.ctrlKey || event.metaKey) inc = 10;
                switch (key) {
                    case 38: // up
                        if (event.shiftKey) break; // no action if shift key is pressed
                        $(obj.el).val((val + inc <= options.max || options.max === null ? Number((val + inc).toFixed(12)) : options.max)).change();
                        cancel = true;
                        break;
                    case 40: // down
                        if (event.shiftKey) break; // no action if shift key is pressed
                        $(obj.el).val((val - inc >= options.min || options.min === null ? Number((val - inc).toFixed(12)) : options.min)).change();
                        cancel = true;
                        break;
                }
                if (cancel) {
                    event.preventDefault();
                    setTimeout(function () {
                        // set cursor to the end
                        obj.el.setSelectionRange(obj.el.value.length, obj.el.value.length);
                    }, 0);
                }
            }
            // date
            if (obj.type == 'date') {
                if (!options.keyboard || $(obj.el).attr('readonly')) return;
                var cancel  = false;
                var daymil  = 24*60*60*1000;
                var inc        = 1;
                if (event.ctrlKey || event.metaKey) inc = 10;
                var dt = w2utils.isDate($(obj.el).val(), options.format, true);
                if (!dt) { dt = new Date(); daymil = 0; }
                switch (key) {
                    case 38: // up
                        if (event.shiftKey) break; // no action if shift key is pressed
                        var newDT = w2utils.formatDate(dt.getTime() + daymil, options.format);
                        if (inc == 10) newDT = w2utils.formatDate(new Date(dt.getFullYear(), dt.getMonth()+1, dt.getDate()), options.format);
                        $(obj.el).val(newDT).change();
                        cancel = true;
                        break;
                    case 40: // down
                        if (event.shiftKey) break; // no action if shift key is pressed
                        var newDT = w2utils.formatDate(dt.getTime() - daymil, options.format);
                        if (inc == 10) newDT = w2utils.formatDate(new Date(dt.getFullYear(), dt.getMonth()-1, dt.getDate()), options.format);
                        $(obj.el).val(newDT).change();
                        cancel = true;
                        break;
                }
                if (cancel) {
                    event.preventDefault();
                    setTimeout(function () {
                        // set cursor to the end
                        obj.el.setSelectionRange(obj.el.value.length, obj.el.value.length);
                        obj.updateOverlay();
                    }, 0);
                }
            }
            // time
            if (obj.type == 'time') {
                if (!options.keyboard || $(obj.el).attr('readonly')) return;
                var cancel  = false;
                var inc     = (event.ctrlKey || event.metaKey ? 60 : 1);
                var val     = $(obj.el).val();
                var time    = obj.toMin(val) || obj.toMin((new Date()).getHours() + ':' + ((new Date()).getMinutes() - 1));
                switch (key) {
                    case 38: // up
                        if (event.shiftKey) break; // no action if shift key is pressed
                        time += inc;
                        cancel = true;
                        break;
                    case 40: // down
                        if (event.shiftKey) break; // no action if shift key is pressed
                        time -= inc;
                        cancel = true;
                        break;
                }
                if (cancel) {
                    $(obj.el).val(obj.fromMin(time)).change();
                    event.preventDefault();
                    setTimeout(function () {
                        // set cursor to the end
                        obj.el.setSelectionRange(obj.el.value.length, obj.el.value.length);
                    }, 0);
                }
            }
            // color
            if (obj.type == 'color') {
                if ($(obj.el).attr('readonly')) return;
                // paste
                if (event.keyCode == 86 && (event.ctrlKey || event.metaKey)) {
                    $(obj.el).prop('maxlength', 7);
                    setTimeout(function () {
                        var val = $(obj).val();
                        if (val.substr(0, 1) == '#') val = val.substr(1);
                        if (!w2utils.isHex(val)) val = '';
                        $(obj).val(val).prop('maxlength', 6).change();
                    }, 20);
                }
                if ((event.ctrlKey || event.metaKey) && !event.shiftKey) {
                    if (typeof obj.tmp.cind1 == 'undefined') {
                        obj.tmp.cind1 = -1;
                        obj.tmp.cind2 = -1;
                    } else {
                        switch (key) {
                            case 38: // up
                                obj.tmp.cind1--;
                                break;
                            case 40: // down
                                obj.tmp.cind1++;
                                break;
                            case 39: // right
                                obj.tmp.cind2++;
                                break;
                            case 37: // left
                                obj.tmp.cind2--;
                                break;
                        }
                        if (obj.tmp.cind1 < 0) obj.tmp.cind1 = 0;
                        if (obj.tmp.cind1 > this.pallete.length - 1) obj.tmp.cind1 = this.pallete.length - 1;
                        if (obj.tmp.cind2 < 0) obj.tmp.cind2 = 0;
                        if (obj.tmp.cind2 > this.pallete[0].length - 1) obj.tmp.cind2 = this.pallete[0].length - 1;
                    }
                    if ([37, 38, 39, 40].indexOf(key) != -1) {
                        $(obj.el).val(this.pallete[obj.tmp.cind1][obj.tmp.cind2]).change();
                        event.preventDefault();
                    }
                }
            }
            // list/select/combo
            if (['list', 'combo', 'enum'].indexOf(obj.type) != -1) {
                if ($(obj.el).attr('readonly')) return;
                var cancel    = false;
                var selected  = $(obj.el).data('selected');
                var focus     = $(obj.helpers.focus).find('input');
                if (obj.type == 'list') {
                    if ([37, 38, 39, 40].indexOf(key) == -1) obj.refresh(); // arrows
                }
                // apply arrows
                switch (key) {
                    case 27: // escape
                        if (obj.type == 'list') {
                            if ($(focus).val() != '') $(focus).val('');
                            event.stopPropagation(); // escape in field should not close popup
                        }
                        break;
                    case 37: // left
                    case 39: // right
                        // cancel = true;
                        break;
                    case 13: // enter
                        if ($('#w2ui-overlay').length == 0) break; // no action if overlay not open
                        var item  = options.items[options.index];
                        var multi = $(obj.helpers.multi).find('input');
                        if (obj.type == 'enum') {
                            if (item != null) {
                                // trigger event
                                var eventData = obj.trigger({ phase: 'before', type: 'add', target: obj.el, originalEvent: event.originalEvent, item: item });
                                if (eventData.isCancelled === true) return;
                                item = eventData.item; // need to reassign because it could be recreated by user
                                // default behavior
                                if (selected.length >= options.max && options.max > 0) selected.pop();
                                delete item.hidden;
                                delete obj.tmp.force_open;
                                selected.push(item);
                                $(obj.el).change();
                                multi.val('').width(20);
                                obj.refresh();
                                // event after
                                obj.trigger($.extend(eventData, { phase: 'after' }));
                            } else {
                                // trigger event
                                item = { id: multi.val(), text: multi.val() }
                                var eventData = obj.trigger({ phase: 'before', type: 'new', target: obj.el, originalEvent: event.originalEvent, item: item });
                                if (eventData.isCancelled === true) return;
                                item = eventData.item; // need to reassign because it could be recreated by user
                                // default behavior
                                if (typeof obj.onNew == 'function') {
                                    if (selected.length >= options.max && options.max > 0) selected.pop();
                                    delete obj.tmp.force_open;
                                    selected.push(item);
                                    $(obj.el).change();
                                    multi.val('').width(20);
                                    obj.refresh();
                                }
                                // event after
                                obj.trigger($.extend(eventData, { phase: 'after' }));
                            }
                        } else {
                            if (item) $(obj.el).data('selected', item).val(item.text).change();
                            if ($(obj.el).val() == '' && $(obj.el).data('selected')) $(obj.el).removeData('selected').val('').change();
                            if (obj.type == 'list') {
                                focus.val('');
                                obj.refresh();
                            }
                            // hide overlay
                            obj.tmp.force_hide = true;
                        }
                        break;
                    case 8:  // backspace
                    case 46: // delete
                        if (obj.type == 'enum' && key == 8) {
                            if ($(obj.helpers.multi).find('input').val() == '' && selected.length > 0) {
                                var item = selected[selected.length - 1];
                                // trigger event
                                var eventData = obj.trigger({ phase: 'before', type: 'remove', target: obj.el, originalEvent: event.originalEvent, item: item });
                                if (eventData.isCancelled === true) return;
                                // default behavior
                                selected.pop();
                                $(obj.el).trigger('change');
                                obj.refresh();
                                // event after
                                obj.trigger($.extend(eventData, { phase: 'after' }));
                            }
                        }
                        if (obj.type == 'list' && $(focus).val() == '') {
                            $(obj.el).data('selected', {}).change();
                            obj.refresh();
                        }
                        break;
                    case 38: // up
                        options.index = w2utils.isInt(options.index) ? parseInt(options.index) : 0;
                        options.index--;
                        while (options.index > 0 && options.items[options.index].hidden) options.index--;
                        if (options.index == 0 && options.items[options.index].hidden) {
                            while (options.items[options.index] && options.items[options.index].hidden) options.index++;
                        }
                        cancel = true;
                        break;
                    case 40: // down
                        options.index = w2utils.isInt(options.index) ? parseInt(options.index) : -1;
                        options.index++;
                        while (options.index < options.items.length-1 && options.items[options.index].hidden) options.index++;
                        if (options.index == options.items.length-1 && options.items[options.index].hidden) {
                            while (options.items[options.index] && options.items[options.index].hidden) options.index--;
                        }
                        // show overlay if not shown
                        var input = obj.el;
                        if (['enum'].indexOf(obj.type) != -1) input = obj.helpers.multi.find('input');
                        if ($(input).val() == '' && $('#w2ui-overlay').length == 0) {
                            obj.tmp.force_open = true;
                        } else {
                            cancel = true;
                        }
                        break;
                }
                if (cancel) {
                    if (options.index < 0) options.index = 0;
                    if (options.index >= options.items.length) options.index = options.items.length -1;
                    obj.updateOverlay();
                    // cancel event
                    event.preventDefault();
                    setTimeout(function () {
                        // set cursor to the end
                        if (obj.type == 'enum') {
                            var tmp = obj.helpers.multi.find('input').get(0);
                            tmp.setSelectionRange(tmp.value.length, tmp.value.length);
                        } else if (obj.type == 'list') {
                            var tmp = obj.helpers.focus.find('input').get(0);
                            tmp.setSelectionRange(tmp.value.length, tmp.value.length);
                        } else {
                            obj.el.setSelectionRange(obj.el.value.length, obj.el.value.length);
                        }
                    }, 0);
                    return;
                }
                // expand input
                if (obj.type == 'enum') {
                    var input  = obj.helpers.multi.find('input');
                    var search = input.val();
                    input.width(((search.length + 2) * 8) + 'px');
                }
                // run search
                if ([16, 17, 18, 20, 37, 39, 91].indexOf(key) == -1) { // no refreah on crtl, shift, left/right arrows, etc
                    setTimeout(function () {
                        if (!obj.tmp.force_hide) obj.request();
                        obj.search();
                    }, 1);
                }
            }
        },

        keyUp: function (event) {
            if (this.type == 'color') {
                if (event.keyCode == 86 && (event.ctrlKey || event.metaKey)) $(this).prop('maxlength', 6);
            }
        },

        clearCache: function () {
            var options          = this.options;
            options.items        = [];
            this.tmp.xhr_loading = false;
            this.tmp.xhr_search  = '';
            this.tmp.xhr_total   = -1;
            this.search();
        },

        request: function (interval) {
            var obj      = this;
            var options  = this.options;
            var search   = $(obj.el).val() || '';
            // if no url - do nothing
            if (!options.url) return;
            // --
            if (obj.type == 'enum') {
                var tmp = $(obj.helpers.multi).find('input');
                if (tmp.length == 0) search = ''; else search = tmp.val();
            }
            if (obj.type == 'list') {
                var tmp = $(obj.helpers.focus).find('input');
                if (tmp.length == 0) search = ''; else search = tmp.val();
            }
            if (options.minLength != 0 && search.length < options.minLength) {
                options.items = []; // need to empty the list
                this.updateOverlay();
                return;
            }
            if (typeof interval == 'undefined') interval = 350;
            if (typeof obj.tmp.xhr_search == 'undefined') obj.tmp.xhr_search = '';
            if (typeof obj.tmp.xhr_total == 'undefined') obj.tmp.xhr_total = -1;
            // check if need to search
            if (options.url && $(obj.el).prop('readonly') != true && (
                    (options.items.length === 0 && obj.tmp.xhr_total !== 0) ||
                    (obj.tmp.xhr_total == options.cacheMax && search.length > obj.tmp.xhr_search.length) ||
                    (search.length >= obj.tmp.xhr_search.length && search.substr(0, obj.tmp.xhr_search.length) != obj.tmp.xhr_search) ||
                    (search.length < obj.tmp.xhr_search.length)
                )) {
                // empty list
                obj.tmp.xhr_loading = true;
                obj.search();
                // timeout
                clearTimeout(obj.tmp.timeout);
                obj.tmp.timeout = setTimeout(function () {
                    // trigger event
                    var url      = options.url;
                    var postData = {
                        search : search,
                        max    : options.cacheMax
                    };
                    $.extend(postData, options.postData);
                    var eventData = obj.trigger({ phase: 'before', type: 'request', target: obj.el, url: url, postData: postData });
                    if (eventData.isCancelled === true) return;
                    url      = eventData.url;
                    postData = eventData.postData;
                    // console.log('REMOTE SEARCH:', search);
                    if (obj.tmp.xhr) obj.tmp.xhr.abort();
                    var ajaxOptions = {
                        type     : 'GET',
                        url      : url,
                        data     : postData,
                        dataType : 'JSON' // expected from server
                    };
                    if (w2utils.settings.dataType == 'JSON') {
                        ajaxOptions.type        = 'POST';
                        ajaxOptions.data        = JSON.stringify(ajaxOptions.data);
                        ajaxOptions.contentType = 'application/json';
                    }
                    obj.tmp.xhr = $.ajax(ajaxOptions)
                        .done(function (data, status, xhr) {
                            // trigger event
                            var eventData2 = obj.trigger({ phase: 'before', type: 'load', target: obj.el, search: postData.search, data: data, xhr: xhr });
                            if (eventData2.isCancelled === true) return;
                            // default behavior
                            data = eventData2.data;
                            if (typeof data == 'string') data = JSON.parse(data);
                            if (data.status != 'success') {
                                console.log('ERROR: server did not return proper structure. It should return', { status: 'success', items: [{ id: 1, text: 'item' }] });
                                return;
                            }
                            // remove all extra items if more then needed for cache
                            if (data.items.length > options.cacheMax) data.items.splice(options.cacheMax, 100000);
                            // remember stats
                            obj.tmp.xhr_loading = false;
                            obj.tmp.xhr_search  = search;
                            obj.tmp.xhr_total   = data.items.length;
                            options.items       = obj.normMenu(data.items);
                            if (search == '' && data.items.length == 0) obj.tmp.emptySet = true; else obj.tmp.emptySet = false;
                            obj.search();
                            // console.log('-->', 'retrieved:', obj.tmp.xhr_total);
                            // event after
                            obj.trigger($.extend(eventData2, { phase: 'after' }));
                        })
                        .fail(function (xhr, status, error) {
                            // trigger event
                            var errorObj = { status: status, error: error, rawResponseText: xhr.responseText };
                            var eventData2 = obj.trigger({ phase: 'before', type: 'error', target: obj.el, search: search, error: errorObj, xhr: xhr });
                            if (eventData2.isCancelled === true) return;
                            // default behavior
                            if (status != 'abort') {
                                var data;
                                try { data = $.parseJSON(xhr.responseText) } catch (e) {}
                                console.log('ERROR: Server communication failed.', 
                                    '\n   EXPECTED:', { status: 'success', items: [{ id: 1, text: 'item' }] }, 
                                    '\n         OR:', { status: 'error', message: 'error message' },
                                    '\n   RECEIVED:', typeof data == 'object' ? data : xhr.responseText);
                            }
                            // reset stats
                            obj.clearCache();
                            // event after
                            obj.trigger($.extend(eventData2, { phase: 'after' }));
                        });
                    // event after
                    obj.trigger($.extend(eventData, { phase: 'after' }));
                }, interval);
            }
        },

        search: function () {
            var obj     = this;
            var options = this.options;
            var search  = $(obj.el).val();
            var target  = obj.el;
            var ids     = [];
            var selected= $(obj.el).data('selected');
            if (obj.type == 'enum') {
                target = $(obj.helpers.multi).find('input');
                search = target.val();
                for (var s in selected) { if (selected[s]) ids.push(selected[s].id); }
            }
            if (obj.type == 'list') {
                target = $(obj.helpers.focus).find('input');
                search = target.val();
                for (var s in selected) { if (selected[s]) ids.push(selected[s].id); }
            }
            // trigger event
            var eventData = obj.trigger({ phase: 'before', type: 'search', target: target, search: search });
            if (eventData.isCancelled === true) return;
            if (obj.tmp.xhr_loading !== true) {
                var shown = 0;
                for (var i in options.items) {
                    var item = options.items[i];
                    var prefix = '';
                    var suffix = '';
                    if (['is', 'begins'].indexOf(options.match) != -1) prefix = '^';
                    if (['is', 'ends'].indexOf(options.match) != -1) suffix = '$';
                    try {
                        var re = new RegExp(prefix + search + suffix, 'i');
                        if (re.test(item.text) || item.text == '...') item.hidden = false; else item.hidden = true;
                    } catch (e) {}
                    // do not show selected items
                    if (obj.type == 'enum' && $.inArray(item.id, ids) != -1) item.hidden = true;
                    if (item.hidden !== true) shown++;
                }
                if (obj.type != 'combo') { // don't preselect first for combo
                    options.index = 0;
                    while (options.items[options.index] && options.items[options.index].hidden) options.index++;
                } else {
                    options.index = -1;
                }
                if (shown <= 0) options.index = -1;
                options.spinner = false;
                obj.updateOverlay();
                setTimeout(function () { 
                    var html = $('#w2ui-overlay').html() || '';
                    if (options.markSearch && html.indexOf('$.fn.w2menuHandler') != -1) { // do not highlight when no items
                        $('#w2ui-overlay').w2marker(search); 
                    }
                }, 1);
            } else {
                options.items.splice(0, options.cacheMax);
                options.spinner = true;
                obj.updateOverlay();
            }
            // event after
            obj.trigger($.extend(eventData, { phase: 'after' }));
        },

        updateOverlay: function () {
            var obj     = this;
            var options = this.options;
            // color
            if (this.type == 'color') {
                if ($(obj.el).attr('readonly')) return;
                if ($('#w2ui-overlay').length == 0) {
                    $(obj.el).w2overlay(obj.getColorHTML());
                } else {
                    $('#w2ui-overlay').html(obj.getColorHTML());
                }
                // bind events
                $('#w2ui-overlay .color')
                    .on('mousedown', function (event) {
                        var color = $(event.originalEvent.target).attr('name');
                        var index = $(event.originalEvent.target).attr('index').split(':');
                        obj.tmp.cind1 = index[0];
                        obj.tmp.cind2 = index[1];
                        $(obj.el).val(color).change();
                        $(this).html('&#149;');
                    })
                    .on('mouseup', function () {
                        setTimeout(function () {
                            if ($("#w2ui-overlay").length > 0) $('#w2ui-overlay').removeData('keepOpen')[0].hide();
                        }, 10);
                    });
            }
            // date
            if (this.type == 'date') {
                if ($(obj.el).attr('readonly')) return;
                if ($('#w2ui-overlay').length == 0) {
                    $(obj.el).w2overlay('<div class="w2ui-reset w2ui-calendar" onclick="event.stopPropagation();"></div>', {
                        css: { "background-color": "#f5f5f5" }
                    });
                }
                var month, year;
                var dt = w2utils.isDate($(obj.el).val(), obj.options.format, true);
                if (dt) { month = dt.getMonth() + 1; year = dt.getFullYear(); }
                (function refreshCalendar(month, year) {
                    $('#w2ui-overlay > div > div').html(obj.getMonthHTML(month, year));
                    $('#w2ui-overlay .w2ui-calendar-title')
                        .on('mousedown', function () {
                            if ($(this).next().hasClass('w2ui-calendar-jump')) {
                                $(this).next().remove();
                            } else {
                                var selYear, selMonth;
                                $(this).after('<div class="w2ui-calendar-jump" style=""></div>');
                                $(this).next().hide().html(obj.getYearHTML()).fadeIn(200);
                                setTimeout(function () {
                                    $('#w2ui-overlay .w2ui-calendar-jump')
                                        .find('.w2ui-jump-month, .w2ui-jump-year')
                                        .on('click', function () {
                                            if ($(this).hasClass('w2ui-jump-month')) {
                                                $(this).parent().find('.w2ui-jump-month').removeClass('selected');
                                                $(this).addClass('selected');
                                                selMonth = $(this).attr('name');
                                            }
                                            if ($(this).hasClass('w2ui-jump-year')) {
                                                $(this).parent().find('.w2ui-jump-year').removeClass('selected');
                                                $(this).addClass('selected');
                                                selYear = $(this).attr('name');
                                            }
                                            if (selYear != null && selMonth != null) {
                                                $('#w2ui-overlay .w2ui-calendar-jump').fadeOut(100);
                                                setTimeout(function () { refreshCalendar(parseInt(selMonth)+1, selYear); }, 100);
                                            }
                                        });
                                    $('#w2ui-overlay .w2ui-calendar-jump >:last-child').prop('scrollTop', 2000);
                                }, 1);
                            }
                        });
                    $('#w2ui-overlay .w2ui-date')
                        .on('mousedown', function () {
                            var day = $(this).attr('date');
                            $(obj.el).val(day).change();
                            $(this).css({ 'background-color': '#B6D5FB', 'border-color': '#aaa' });
                        })
                        .on('mouseup', function () {
                            setTimeout(function () {
                                if ($("#w2ui-overlay").length > 0) $('#w2ui-overlay').removeData('keepOpen')[0].hide();
                            }, 10);
                        });
                    $('#w2ui-overlay .previous').on('mousedown', function () {
                        var tmp = obj.options.current.split('/');
                        tmp[0]  = parseInt(tmp[0]) - 1;
                        refreshCalendar(tmp[0], tmp[1]);
                    });
                    $('#w2ui-overlay .next').on('mousedown', function () {
                        var tmp = obj.options.current.split('/');
                        tmp[0]  = parseInt(tmp[0]) + 1;
                        refreshCalendar(tmp[0], tmp[1]);
                    });
                }) (month, year);
            }
            // date
            if (this.type == 'time') {
                if ($(obj.el).attr('readonly')) return;
                if ($('#w2ui-overlay').length == 0) {
                    $(obj.el).w2overlay('<div class="w2ui-reset w2ui-calendar-time" onclick="event.stopPropagation();"></div>', {
                        css: { "background-color": "#fff" }
                    });
                }
                var h24 = (this.options.format == 'h24' ? true : false);
                $('#w2ui-overlay > div').html(obj.getHourHTML());
                $('#w2ui-overlay .w2ui-time')
                    .on('mousedown', function (event) {
                        $(this).css({ 'background-color': '#B6D5FB', 'border-color': '#aaa' });
                        var hour = $(this).attr('hour');
                        $(obj.el).val((hour > 12 && !h24 ? hour - 12 : hour) + ':00' + (!h24 ? (hour < 12 ? ' am' : ' pm') : '')).change();
                    })
                    .on('mouseup', function () {
                        var hour = $(this).attr('hour');
                        if ($("#w2ui-overlay").length > 0) $('#w2ui-overlay')[0].hide();
                        $(obj.el).w2overlay('<div class="w2ui-reset w2ui-calendar-time"></div>', { css: { "background-color": "#fff" } });
                        $('#w2ui-overlay > div').html(obj.getMinHTML(hour));
                        $('#w2ui-overlay .w2ui-time')
                            .on('mousedown', function () {
                                $(this).css({ 'background-color': '#B6D5FB', 'border-color': '#aaa' });
                                var min = $(this).attr('min');
                                $(obj.el).val((hour > 12 && !h24 ? hour - 12 : hour) + ':' + (min < 10 ? 0 : '') + min + (!h24 ? (hour < 12 ? ' am' : ' pm') : '')).change();
                            })
                            .on('mouseup', function () {
                                setTimeout(function () { if ($("#w2ui-overlay").length > 0) $('#w2ui-overlay').removeData('keepOpen')[0].hide(); }, 10);
                            });
                    });
            }
            // list
            if (['list', 'combo', 'enum'].indexOf(this.type) != -1) {
                var el    = this.el;
                var input = this.el;
                if (this.type == 'enum') {
                    el    = $(this.helpers.multi);
                    input = $(el).find('input');
                }
                if (this.type == 'list') {
                    input = $(this.helpers.focus).find('input');
                }
                if ($(input).is(':focus')) {
                    if (options.openOnFocus === false && $(input).val() == '' && obj.tmp.force_open !== true) {
                        $().w2overlay();
                        return;
                    }
                    if (obj.tmp.force_hide) {
                        $().w2overlay();
                        setTimeout(function () {
                            delete obj.tmp.force_hide;
                        }, 1);                        
                        return;
                    }
                    if ($(input).val() != '') delete obj.tmp.force_open;
                    if ($('#w2ui-overlay').length == 0) options.index = 0;
                    var msgNoItems = w2utils.lang('No matches');
                    if (options.url != null && $(input).val().length < options.minLength && obj.tmp.emptySet !== true) msgNoItems = options.minLength + ' ' + w2utils.lang('letters or more...');
                    if (options.url != null && $(input).val() == '' && obj.tmp.emptySet !== true) msgNoItems = w2utils.lang('Type to search....');
                    $(el).w2menu('refresh', $.extend(true, {}, options, {
                        search     : false,
                        render     : options.renderDrop,
                        maxHeight  : options.maxDropHeight,
                        msgNoItems : msgNoItems,
                        // selected with mouse
                        onSelect: function (event) {
                            if (obj.type == 'enum') {
                                var selected = $(obj.el).data('selected');
                                if (event.item) {
                                    // trigger event
                                    var eventData = obj.trigger({ phase: 'before', type: 'add', target: obj.el, originalEvent: event.originalEvent, item: event.item });
                                    if (eventData.isCancelled === true) return;
                                    // default behavior
                                    if (selected.length >= options.max && options.max > 0) selected.pop();
                                    delete event.item.hidden;
                                    selected.push(event.item);
                                    $(obj.el).data('selected', selected).change();
                                    $(obj.helpers.multi).find('input').val('').width(20);
                                    obj.refresh();
                                    if ($("#w2ui-overlay").length > 0) $('#w2ui-overlay')[0].hide();
                                    // event after
                                    obj.trigger($.extend(eventData, { phase: 'after' }));
                                }
                            } else {
                                $(obj.el).data('selected', event.item).val(event.item.text).change();
                                if (obj.helpers.focus) obj.helpers.focus.find('input').val('');
                            }
                        }
                    }));
                }
            }
        },

        inRange: function (str) {
            var inRange = false;
            if (this.type == 'date') {
                var dt = w2utils.isDate(str, this.options.format, true);
                if (dt) {
                    // enable range
                    if (this.options.start || this.options.end) {
                        var st = (typeof this.options.start == 'string' ? this.options.start : $(this.options.start).val());
                        var en = (typeof this.options.end == 'string' ? this.options.end : $(this.options.end).val());
                        var start   = w2utils.isDate(st, this.options.format, true);
                        var end     = w2utils.isDate(en, this.options.format, true);
                        var current = new Date(dt);
                        if (!start) start = current;
                        if (!end) end = current;
                        if (current >= start && current <= end) inRange = true;
                    } else {
                        inRange = true;
                    }
                    // block predefined dates
                    if (this.options.blocked && $.inArray(str, this.options.blocked) != -1) inRange = false;
                }
            }
            if (this.type == 'time') {
                if (this.options.start || this.options.end) {
                    var tm  = this.toMin(str);
                    var tm1 = this.toMin(this.options.start);
                    var tm2 = this.toMin(this.options.end);
                    if (!tm1) tm1 = tm;
                    if (!tm2) tm2 = tm;
                    if (tm >= tm1 && tm <= tm2) inRange = true;
                } else {
                    inRange = true;
                }
            }
            return inRange;
        },

        /*
        *  INTERNAL FUNCTIONS
        */

        checkType: function (ch, loose) {
            var obj = this;
            switch (obj.type) {
                case 'int':
                    if (loose && ['-', obj.options.groupSymbol].indexOf(ch) != -1) return true;
                    return w2utils.isInt(ch.replace(obj.options.numberRE, ''));
                case 'percent':
                    ch = ch.replace(/%/g, '');
                case 'float':
                    if (loose && ['-', w2utils.settings.decimalSymbol, obj.options.groupSymbol].indexOf(ch) != -1) return true;
                    return w2utils.isFloat(ch.replace(obj.options.numberRE, ''));
                case 'money':
                case 'currency':
                    if (loose && ['-', obj.options.decimalSymbol, obj.options.groupSymbol, obj.options.currencyPrefix, obj.options.currencySuffix].indexOf(ch) != -1) return true;
                    return w2utils.isFloat(ch.replace(obj.options.moneyRE, ''));
                case 'hex':
                case 'color':
                    return w2utils.isHex(ch);
                case 'alphanumeric':
                    return w2utils.isAlphaNumeric(ch);
            }
            return true;
        },

        addPrefix: function () {
            var obj = this;
            setTimeout(function () {
                if (obj.type === 'clear') return;
                var helper;
                var tmp = $(obj.el).data('tmp') || {};
                if (tmp['old-padding-left']) $(obj.el).css('padding-left', tmp['old-padding-left']);
                tmp['old-padding-left'] = $(obj.el).css('padding-left');
                $(obj.el).data('tmp', tmp);
                // remove if already displaed
                if (obj.helpers.prefix) $(obj.helpers.prefix).remove();
                if (obj.options.prefix !== '') {
                    // add fresh
                    $(obj.el).before(
                        '<div class="w2ui-field-helper">'+
                            obj.options.prefix +
                        '</div>'
                    );
                    helper = $(obj.el).prev();
                    helper
                        .css({
                            'color'          : $(obj.el).css('color'),
                            'font-family'    : $(obj.el).css('font-family'),
                            'font-size'      : $(obj.el).css('font-size'),
                            'padding-top'    : $(obj.el).css('padding-top'),
                            'padding-bottom' : $(obj.el).css('padding-bottom'),
                            'padding-left'   : $(obj.el).css('padding-left'),
                            'padding-right'  : 0,
                            'margin-top'     : (parseInt($(obj.el).css('margin-top'), 10) + 2) + 'px',
                            'margin-bottom'  : (parseInt($(obj.el).css('margin-bottom'), 10) + 1) + 'px',
                            'margin-left'    : $(obj.el).css('margin-left'),
                            'margin-right'   : 0
                        })
                        .on('click', function (event) {
                            if (obj.options.icon && typeof obj.onIconClick == 'function') {
                                // event before
                                var eventData = obj.trigger({ phase: 'before', type: 'iconClick', target: obj.el, el: $(this).find('span.w2ui-icon')[0] });
                                if (eventData.isCancelled === true) return;
                                
                                // intentionally empty

                                // event after
                                obj.trigger($.extend(eventData, { phase: 'after' }));                                
                            } else {
                                if (obj.type == 'list') {
                                    $(obj.helpers.focus).find('input').focus();
                                } else {
                                    $(obj.el).focus();
                                }
                            }
                        });
                    $(obj.el).css('padding-left', (helper.width() + parseInt($(obj.el).css('padding-left'), 10)) + 'px');
                    // remember helper
                    obj.helpers.prefix = helper;
                }
            }, 1);
        },

        addSuffix: function () {
            var obj = this;
            var helper, pr;
            setTimeout(function () {
                if (obj.type === 'clear') return;
                var tmp = $(obj.el).data('tmp') || {};
                if (tmp['old-padding-right']) $(obj.el).css('padding-right', tmp['old-padding-right']);
                tmp['old-padding-right'] = $(obj.el).css('padding-right');
                $(obj.el).data('tmp', tmp);
                pr = parseInt($(obj.el).css('padding-right'), 10);
                if (obj.options.arrows) {
                    // remove if already displaed
                    if (obj.helpers.arrows) $(obj.helpers.arrows).remove();
                    // add fresh
                    $(obj.el).after(
                        '<div class="w2ui-field-helper" style="border: 1px solid transparent">&nbsp;'+
                        '    <div class="w2ui-field-up" type="up">'+
                        '        <div class="arrow-up" type="up"></div>'+
                        '    </div>'+
                        '    <div class="w2ui-field-down" type="down">'+
                        '        <div class="arrow-down" type="down"></div>'+
                        '    </div>'+
                        '</div>');
                    var height = w2utils.getSize(obj.el, 'height');
                    helper = $(obj.el).next();
                    helper.css({
                            'color'         : $(obj.el).css('color'),
                            'font-family'   : $(obj.el).css('font-family'),
                            'font-size'     : $(obj.el).css('font-size'),
                            'height'        : ($(obj.el).height() + parseInt($(obj.el).css('padding-top'), 10) + parseInt($(obj.el).css('padding-bottom'), 10) ) + 'px',
                            'padding'       : 0,
                            'margin-top'    : (parseInt($(obj.el).css('margin-top'), 10) + 1) + 'px',
                            'margin-bottom' : 0,
                            'border-left'   : '1px solid silver'
                        })
                        .css('margin-left', '-'+ (helper.width() + parseInt($(obj.el).css('margin-right'), 10) + 12) + 'px')
                        .on('mousedown', function (event) {
                            $('body').on('mouseup', tmp);
                            $('body').data('_field_update_timer', setTimeout(update, 700));
                            update(false);
                            // timer function
                            function tmp() {
                                clearTimeout($('body').data('_field_update_timer'));
                                $('body').off('mouseup', tmp);
                            }
                            // update function
                            function update(notimer) {
                                $(obj.el).focus();
                                obj.keyDown($.Event("keydown"), {
                                    keyCode : ($(event.target).attr('type') == 'up' ? 38 : 40)
                                });
                                if (notimer !== false) $('body').data('_field_update_timer', setTimeout(update, 60));
                            }
                        });
                    pr += helper.width() + 12;
                    $(obj.el).css('padding-right', pr + 'px');
                    // remember helper
                    obj.helpers.arrows = helper;
                }
                if (obj.options.suffix !== '') {
                    // remove if already displaed
                    if (obj.helpers.suffix) $(obj.helpers.suffix).remove();
                    // add fresh
                    $(obj.el).after(
                        '<div class="w2ui-field-helper">'+
                            obj.options.suffix +
                        '</div>');
                    helper = $(obj.el).next();
                    helper
                        .css({
                            'color'          : $(obj.el).css('color'),
                            'font-family'    : $(obj.el).css('font-family'),
                            'font-size'      : $(obj.el).css('font-size'),
                            'padding-top'    : $(obj.el).css('padding-top'),
                            'padding-bottom' : $(obj.el).css('padding-bottom'),
                            'padding-left'   : '3px',
                            'padding-right'  : $(obj.el).css('padding-right'),
                            'margin-top'     : (parseInt($(obj.el).css('margin-top'), 10) + 2) + 'px',
                            'margin-bottom'  : (parseInt($(obj.el).css('margin-bottom'), 10) + 1) + 'px'
                        })
                        .on('click', function (event) {
                            if (obj.type == 'list') {
                                $(obj.helpers.focus).find('input').focus();
                            } else {
                                $(obj.el).focus();
                            }
                        });

                    helper.css('margin-left', '-'+ (w2utils.getSize(helper, 'width') + parseInt($(obj.el).css('margin-right'), 10) + 2) + 'px');
                    pr += helper.width() + 3;
                    $(obj.el).css('padding-right', pr + 'px');
                    // remember helper
                    obj.helpers.suffix = helper;
                }
            }, 1);
        },

        addFocus: function () {
            var obj      = this;
            var options  = this.options;
            var width    = 0; // 11 - show search icon, 0 do not show
            // clean up & init
            $(obj.helpers.focus).remove();
            // build helper
            var html =
                '<div class="w2ui-field-helper">'+ 
                '    <div class="w2ui-icon icon-search"></div>'+
                '    <input type="text" autocomplete="off">'+
                '<div>';
            $(obj.el).attr('tabindex', -1).before(html);
            var helper = $(obj.el).prev();
            obj.helpers.focus = helper;
            helper.css({
                    width           : $(obj.el).width(),
                    "margin-top"    : $(obj.el).css('margin-top'),
                    "margin-left"   : (parseInt($(obj.el).css('margin-left')) + parseInt($(obj.el).css('padding-left'))) + 'px',
                    "margin-bottom" : $(obj.el).css('margin-bottom'),
                    "margin-right"  : $(obj.el).css('margin-right')
                })
                .find('input')
                .css({
                    cursor   : 'default',
                    width    : '100%',
                    outline  : 'none',
                    opacity  : 1,
                    margin   : 0,
                    border   : '1px solid transparent',
                    padding  : $(obj.el).css('padding-top'),
                    "padding-left"     : 0,
                    "margin-left"      : (width > 0 ? width + 6 : 0),
                    "background-color" : 'transparent'
                });
            // INPUT events
            helper.find('input')
                .on('click', function (event) {
                    if ($('#w2ui-overlay').length == 0) obj.focus(event);
                    event.stopPropagation();
                })
                .on('focus', function (event) {
                    $(obj.el).css({ 'outline': 'auto 5px #7DB4F3', 'outline-offset': '-2px' });
                    $(this).val('');
                    $(obj.el).triggerHandler('focus');
                    if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;
                })
                .on('blur', function (event) {
                    $(obj.el).css('outline', 'none');
                    $(this).val('');
                    obj.refresh(); 
                    $(obj.el).triggerHandler('blur');
                    if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;
                })
                .on('keyup',    function (event) { obj.keyUp(event) })
                .on('keydown',  function (event) { obj.keyDown(event) })
                .on('keypress', function (event) { obj.keyPress(event); });
            // MAIN div
            helper.on('click', function (event) { $(this).find('input').focus(); });
            obj.refresh();
        },    

        addMulti: function () {
            var obj         = this;
            var options     = this.options;
            // clean up & init
            $(obj.helpers.multi).remove();
            // build helper
            var html   = '';
            var margin =
                'margin-top     : 0px; ' +
                'margin-bottom  : 0px; ' +
                'margin-left    : ' + $(obj.el).css('margin-left') + '; ' +
                'margin-right   : ' + $(obj.el).css('margin-right') + '; '+
                'width          : ' + (w2utils.getSize(obj.el, 'width')
                                    - parseInt($(obj.el).css('margin-left'), 10)
                                    - parseInt($(obj.el).css('margin-right'), 10))
                                    + 'px;';
            if (obj.type == 'enum') {
                html =  '<div class="w2ui-field-helper w2ui-list" style="'+ margin + '; box-sizing: border-box">'+
                        '    <div style="padding: 0px; margin: 0px; margin-right: 20px; display: inline-block">'+
                        '    <ul>'+
                        '        <li style="padding-left: 0px; padding-right: 0px" class="nomouse">'+
                        '            <input type="text" style="width: 20px" autocomplete="off" '+ ($(obj.el).attr('readonly') ? 'readonly': '') + '>'+
                        '        </li>'
                        '    </ul>'+
                        '    </div>'+
                        '</div>';
            }
            if (obj.type == 'file') {
                html =  '<div class="w2ui-field-helper w2ui-list" style="'+ margin + '; box-sizing: border-box">'+
                        '    <div style="padding: 0px; margin: 0px; margin-right: 20px; display: inline-block">'+
                        '    <ul><li style="padding-left: 0px; padding-right: 0px" class="nomouse"></li></ul>'+
                        '    <input class="file-input" type="file" name="attachment" multiple style="display: none" tabindex="-1">'
                        '    </div>'+
                        '</div>';
            }
            $(obj.el)
                .before(html)
                .css({
                    'background-color' : 'transparent',
                    'border-color'     : 'transparent'
                });

            var div    = $(obj.el).prev();
            obj.helpers.multi = div;
            if (obj.type == 'enum') {
                $(obj.el).attr('tabindex', -1);
                // INPUT events
                div.find('input')
                    .on('click', function (event) {
                        if ($('#w2ui-overlay').length == 0) obj.focus(event);
                        $(obj.el).triggerHandler('click');
                    })
                    .on('focus', function (event) {
                        $(div).css({ 'outline': 'auto 5px #7DB4F3', 'outline-offset': '-2px' });
                        $(obj.el).triggerHandler('focus');
                        if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;
                    })
                    .on('blur', function (event) {
                        $(div).css('outline', 'none');
                        $(obj.el).triggerHandler('blur');
                        if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;
                    })
                    .on('keyup',    function (event) { obj.keyUp(event) })
                    .on('keydown',  function (event) { obj.keyDown(event) })
                    .on('keypress', function (event) { div.find('.w2ui-enum-placeholder').remove(); obj.keyPress(event); });
                // MAIN div
                div.on('click', function (event) { $(this).find('input').focus(); });
            }
            if (obj.type == 'file') {
                $(obj.el).css('outline', 'none');
                div.on('click', function (event) {
                        $(obj.el).focus();
                        if ($(obj.el).attr('readonly')) return;
                        obj.blur(event);
                        div.find('input').click();
                    })
                    .on('dragenter', function (event) {
                        if ($(obj.el).attr('readonly')) return;
                        $(div).addClass('w2ui-file-dragover');
                    })
                    .on('dragleave', function (event) {
                        if ($(obj.el).attr('readonly')) return;
                        var tmp = $(event.target).parents('.w2ui-field-helper');
                        if (tmp.length == 0) $(div).removeClass('w2ui-file-dragover');
                    })
                    .on('drop', function (event) {
                        if ($(obj.el).attr('readonly')) return;
                        $(div).removeClass('w2ui-file-dragover');
                        var files = event.originalEvent.dataTransfer.files;
                        for (var i=0, l=files.length; i<l; i++) obj.addFile.call(obj, files[i]);
                        // cancel to stop browser behaviour
                        event.preventDefault();
                        event.stopPropagation();
                    })
                    .on('dragover', function (event) {
                        // cancel to stop browser behaviour
                        event.preventDefault();
                        event.stopPropagation();
                    });
                div.find('input')
                    .on('click', function (event) {
                        event.stopPropagation();
                    })
                    .on('change', function () {
                        if (typeof this.files !== "undefined") {
                            for (var i = 0, l = this.files.length; i < l; i++) {
                                obj.addFile.call(obj, this.files[i]);
                            }
                        }
                    });
            }
            obj.refresh();
        },    

        addFile: function (file) {
            var obj      = this;
            var options  = this.options;
            var selected = $(obj.el).data('selected');
            var newItem  = {
                name     : file.name,
                type     : file.type,
                modified : file.lastModifiedDate,
                size     : file.size,
                content  : null
            };
            var size = 0;
            var cnt  = 0;
            var err;
            for (var s in selected) { 
                // check for dups
                if (selected[s].name == file.name && selected[s].size == file.size) return;
                size += selected[s].size; cnt++; 
            }
            // trigger event
            var eventData = obj.trigger({ phase: 'before', type: 'add', target: obj.el, file: newItem, total: cnt, totalSize: size });
            if (eventData.isCancelled === true) return;
            // check params
            if (options.maxFileSize !== 0 && newItem.size > options.maxFileSize) {
                err = 'Maximum file size is '+ w2utils.size(options.maxFileSize);
                if (options.silent === false) $(obj.el).w2tag(err);
                console.log('ERROR: '+ err);
                return;
            }
            if (options.maxSize !== 0 && size + newItem.size > options.maxSize) {
                err = 'Maximum total size is '+ w2utils.size(options.maxSize);
                if (options.silent === false) $(obj.el).w2tag(err);
                console.log('ERROR: '+ err);
                return;
            }
            if (options.max !== 0 && cnt >= options.max) {
                err = 'Maximum number of files is '+ options.max;
                if (options.silent === false) $(obj.el).w2tag(err);
                console.log('ERROR: '+ err);
                return;
            }
            selected.push(newItem);
            // read file as base64
            if (typeof FileReader !== "undefined") {
                var reader = new FileReader();
                // need a closure
                reader.onload = (function () {
                    return function (event) {
                        var fl  = event.target.result;
                        var ind = fl.indexOf(',');
                        newItem.content = fl.substr(ind+1);
                        obj.refresh();
                        $(obj.el).trigger('change');
                        // event after
                        obj.trigger($.extend(eventData, { phase: 'after' }));
                    };
                })();
                reader.readAsDataURL(file);
            } else {
                obj.refresh();
                $(obj.el).trigger('change');
            }
        },

        normMenu: function (menu) {
            if ($.isArray(menu)) {
                for (var m = 0; m < menu.length; m++) {
                    if (typeof menu[m] == 'string') {
                        menu[m] = { id: menu[m], text: menu[m] };
                    } else {
                        if (typeof menu[m].text != 'undefined' && typeof menu[m].id == 'undefined') menu[m].id = menu[m].text;
                        if (typeof menu[m].text == 'undefined' && typeof menu[m].id != 'undefined') menu[m].text = menu[m].id;
                        if (typeof menu[m].caption != 'undefined') menu[m].text = menu[m].caption;
                    }
                }
                return menu;
            } else if (typeof menu == 'object') {
                var tmp = []
                for (var m in menu) tmp.push({ id: m, text: menu[m] });
                return tmp;
            }
        },

        getColorHTML: function () {
            var html =  '<div class="w2ui-color">'+
                        '<table cellspacing="5">';
            for (var i = 0; i < 8; i++) {
                html += '<tr>';
                for (var j = 0; j < 8; j++) {
                    html += '<td>'+
                            '    <div class="color" style="background-color: #'+ this.pallete[i][j] +';" name="'+ this.pallete[i][j] +'" index="'+ i + ':' + j +'">'+
                            '        '+ ($(this.el).val() == this.pallete[i][j] ? '&#149;' : '&nbsp;')+
                            '    </div>'+
                            '</td>';
                }
                html += '</tr>';
                if (i < 2) html += '<tr><td style="height: 8px" colspan="8"></td></tr>';
            }
            html += '</table></div>';
            return html;
        },

        getMonthHTML: function (month, year) {
            var td         = new Date();
            var months     = w2utils.settings.fullmonths;
            var days       = w2utils.settings.fulldays;
            var daysCount  = ['31', '28', '31', '30', '31', '30', '31', '31', '30', '31', '30', '31'];
            var today      = td.getFullYear() + '/' + (Number(td.getMonth()) + 1) + '/' + td.getDate();
            // normalize date
            year  = w2utils.isInt(year)  ? parseInt(year)  : td.getFullYear();
            month = w2utils.isInt(month) ? parseInt(month) : td.getMonth() + 1;
            if (month > 12) { month -= 12; year++; }
            if (month < 1 || month === 0)  { month += 12; year--; }
            if (year/4 == Math.floor(year/4)) { daysCount[1] = '29'; } else { daysCount[1] = '28'; }
            this.options.current = month + '/' + year;

            // start with the required date
            td = new Date(year, month-1, 1);
            var weekDay = td.getDay();
            var tabDays = w2utils.settings.shortdays;
            var dayTitle = '';
            for ( var i = 0, len = tabDays.length; i < len; i++) {
                dayTitle += '<td>' + tabDays[i] + '</td>';
            }
            var html  =
                '<div class="w2ui-calendar-title title">'+
                '    <div class="w2ui-calendar-previous previous"> <div></div> </div>'+
                '    <div class="w2ui-calendar-next next"> <div></div> </div> '+
                        months[month-1] +', '+ year +
                '</div>'+
                '<table class="w2ui-calendar-days" cellspacing="0">'+
                '    <tr class="w2ui-day-title">' + dayTitle + '</tr>'+
                '    <tr>';

            var day = 1;
            for (var ci=1; ci<43; ci++) {
                if (weekDay === 0 && ci == 1) {
                    for (var ti=0; ti<6; ti++) html += '<td class="w2ui-day-empty">&nbsp;</td>';
                    ci += 6;
                } else {
                    if (ci < weekDay || day > daysCount[month-1]) {
                        html += '<td class="w2ui-day-empty">&nbsp;</td>';
                        if ((ci) % 7 === 0) html += '</tr><tr>';
                        continue;
                    }
                }
                var dt  = year + '/' + month + '/' + day;

                var className = '';
                if (ci % 7 == 6)  className  = ' w2ui-saturday';
                if (ci % 7 === 0) className  = ' w2ui-sunday';
                if (dt == today)  className += ' w2ui-today';

                var dspDay  = day;
                var col     = '';
                var bgcol   = '';
                var tmp_dt  = w2utils.formatDate(dt, this.options.format);
                if (this.options.colored && this.options.colored[tmp_dt] !== undefined) { // if there is predefined colors for dates
                    tmp   = this.options.colored[tmp_dt].split(':');
                    bgcol = 'background-color: ' + tmp[0] + ';';
                    col   = 'color: ' + tmp[1] + ';';
                }
                html += '<td class="'+ (this.inRange(tmp_dt) ? 'w2ui-date ' : 'w2ui-blocked') + className + '" style="'+ col + bgcol + '" date="'+ tmp_dt +'">'+
                            dspDay +
                        '</td>';
                if (ci % 7 === 0 || (weekDay === 0 && ci == 1)) html += '</tr><tr>';
                day++;
            }
            html += '</tr></table>';
            return html;
        },

        getYearHTML: function () {
            var months = w2utils.settings.shortmonths;
            var mhtml  = '';
            var yhtml  = '';
            for (var m in months) {
                mhtml += '<div class="w2ui-jump-month" name="'+ m +'">'+ months[m] + '</div>';
            }
            for (var y = 1950; y <= 2020; y++) {
                yhtml += '<div class="w2ui-jump-year" name="'+ y +'">'+ y + '</div>'
            }
            return '<div>'+ mhtml +'</div><div>'+ yhtml +'</div>';
        },

        getHourHTML: function () {
            var tmp = [];
            var h24 = (this.options.format == 'h24' ? true : false);
            for (var a=0; a<24; a++) {
                var time = (a >= 12 && !h24 ? a - 12 : a) + ':00' + (!h24 ? (a < 12 ? ' am' : ' pm') : '');
                if (a == 12 && !h24) time = '12:00 pm';
                if (!tmp[Math.floor(a/8)]) tmp[Math.floor(a/8)] = '';
                var tm1 = this.fromMin(this.toMin(time));
                var tm2 = this.fromMin(this.toMin(time) + 59);
                tmp[Math.floor(a/8)] += '<div class="'+ (this.inRange(tm1) || this.inRange(tm2) ? 'w2ui-time ' : 'w2ui-blocked') + '" hour="'+ a +'">'+ time +'</div>';
            }
            var html =
                '<div class="w2ui-calendar-time"><table><tr>'+
                '    <td>'+ tmp[0] +'</td>' +
                '    <td>'+ tmp[1] +'</td>' +
                '    <td>'+ tmp[2] +'</td>' +
                '</tr></table></div>';
            return html;
        },

        getMinHTML: function (hour) {
            if (typeof hour == 'undefined') hour = 0;
            var h24 = (this.options.format == 'h24' ? true : false);
            var tmp = [];
            for (var a=0; a<60; a+=5) {
                var time = (hour > 12 && !h24 ? hour - 12 : hour) + ':' + (a < 10 ? 0 : '') + a + ' ' + (!h24 ? (hour < 12 ? 'am' : 'pm') : '');
                var ind = a < 20 ? 0 : (a < 40 ? 1 : 2);
                if (!tmp[ind]) tmp[ind] = '';
                tmp[ind] += '<div class="'+ (this.inRange(time) ? 'w2ui-time ' : 'w2ui-blocked') + '" min="'+ a +'">'+ time +'</div>';
            }
            var html =
                '<div class="w2ui-calendar-time"><table><tr>'+
                '    <td>'+ tmp[0] +'</td>' +
                '    <td>'+ tmp[1] +'</td>' +
                '    <td>'+ tmp[2] +'</td>' +
                '</tr></table></div>';
            return html;
        },

        toMin: function (str) {
            if (typeof str != 'string') return null;
            var tmp = str.split(':');
            if (tmp.length == 2) {
                tmp[0] = parseInt(tmp[0]);
                tmp[1] = parseInt(tmp[1]);
                if (str.indexOf('pm') != -1 && tmp[0] != 12) tmp[0] += 12;
            } else {
                return null;
            }
            return tmp[0] * 60 + tmp[1];
        },

        fromMin: function (time) {
            var ret = '';
            if (time >= 24 * 60) time = time % (24 * 60);
            if (time < 0) time = 24 * 60 + time;
            var hour = Math.floor(time/60);
            var min  = ((time % 60) < 10 ? '0' : '') + (time % 60);
            if (this.options.format.indexOf('h24') != -1) {
                ret = hour + ':' + min;
            } else {
                ret = (hour <= 12 ? hour : hour - 12) + ':' + min + ' ' + (hour >= 12 ? 'pm' : 'am');
            }
            return ret;
        }
    }

    $.extend(w2field.prototype, w2utils.event);
    w2obj.field = w2field;

}) (jQuery);

/************************************************************************
*   Library: Web 2.0 UI for jQuery (using prototypical inheritance)
*   - Following objects defined
*        - w2form      - form widget
*        - $().w2form  - jQuery wrapper
*   - Dependencies: jQuery, w2utils, w2fields, w2tabs, w2toolbar, w2alert
*
* == NICE TO HAVE ==
*   - refresh(field) - would refresh only one field
*   - include delta on save
*   - create an example how to do cascadic dropdown
*   - form should read <select> <options> into items
*   - two way data bindings
*   - verify validation of fields
*   - when field is blank, set record.field = null
*   - show/hide a field
*   - added getChanges() - not complete
*
************************************************************************/


(function () {
    var w2form = function(options) {
        // public properties
        this.name      = null;
        this.header    = '';
        this.box       = null;     // HTML element that hold this element
        this.url       = '';
        this.routeData = {};       // data for dynamic routes
        this.formURL   = '';       // url where to get form HTML
        this.formHTML  = '';       // form HTML (might be loaded from the url)
        this.page      = 0;        // current page
        this.recid     = 0;        // can be null or 0
        this.fields    = [];
        this.actions   = {};
        this.record    = {};
        this.original  = {};
        this.postData  = {};
        this.toolbar   = {};       // if not empty, then it is toolbar
        this.tabs      = {};       // if not empty, then it is tabs object

        this.style         = '';
        this.focus         = 0;    // focus first or other element
        this.msgNotJSON    = w2utils.lang('Return data is not in JSON format.');
        this.msgAJAXerror  = w2utils.lang('AJAX error. See console for more details.');
        this.msgRefresh    = w2utils.lang('Refreshing...');
        this.msgSaving     = w2utils.lang('Saving...');

        // events
        this.onRequest   = null;
        this.onLoad      = null;
        this.onValidate  = null;
        this.onSubmit    = null;
        this.onSave      = null;
        this.onChange    = null;
        this.onRender    = null;
        this.onRefresh   = null;
        this.onResize    = null;
        this.onDestroy   = null;
        this.onAction    = null;
        this.onToolbar   = null;
        this.onError     = null;

        // internal
        this.isGenerated = false;
        this.last = {
            xhr: null        // jquery xhr requests
        }

        $.extend(true, this, w2obj.form, options);
    };

    // ====================================================
    // -- Registers as a jQuery plugin

    $.fn.w2form = function(method) {
        if (typeof method === 'object' || !method ) {
            var obj = this;
            // check name parameter
            if (!w2utils.checkName(method, 'w2form')) return;
            // remember items
            var record   = method.record;
            var original = method.original;
            var fields   = method.fields;
            var toolbar  = method.toolbar;
            var tabs     = method.tabs;
            // extend items
            var object = new w2form(method);
            $.extend(object, { record: {}, original: {}, fields: [], tabs: {}, toolbar: {}, handlers: [] });
            if ($.isArray(tabs)) {
                $.extend(true, object.tabs, { tabs: [] });
                for (var t in tabs) {
                    var tmp = tabs[t];
                    if (typeof tmp === 'object') object.tabs.tabs.push(tmp); else object.tabs.tabs.push({ id: tmp, caption: tmp });
                }
            } else {
                $.extend(true, object.tabs, tabs);
            }
            $.extend(true, object.toolbar, toolbar);
            // reassign variables
            for (var p in fields) {
                var field = $.extend(true, {}, fields[p]);
                if (typeof field.name == 'undefined' && typeof field.field != 'undefined') field.name = field.field;
                if (typeof field.field == 'undefined' && typeof field.name != 'undefined') field.field = field.name;
                object.fields[p] = field;
            }
            for (var p in record) {
                if ($.isPlainObject(record[p])) {
                    object.record[p] = $.extend(true, {}, record[p]);
                } else {
                    object.record[p] = record[p];
                }
            }
            for (var p in original) {
                if ($.isPlainObject(original[p])) {
                    object.original[p] = $.extend(true, {}, original[p]);
                } else {
                    object.original[p] = original[p];
                }
            }
            if (obj.length > 0) object.box = obj[0];
            // render if necessary
            if (object.formURL != '') {
                $.get(object.formURL, function (data) { // should always be $.get as it is template
                    object.formHTML = data;
                    object.isGenerated = true;
                    if ($(object.box).length != 0 || data.length != 0) {
                        $(object.box).html(data);
                        object.render(object.box);
                    }
                });
            } else if (object.formHTML != '') {
                // it is already loaded into formHTML
            } else if ($(this).length != 0 && $.trim($(this).html()) != '') {
                object.formHTML = $(this).html();
            }  else { // try to generate it
                object.formHTML = object.generateHTML();
            }
            // register new object
            w2ui[object.name] = object;
            // render if not loaded from url
            if (object.formURL == '') {
                if (String(object.formHTML).indexOf('w2ui-page') == -1) {
                    object.formHTML = '<div class="w2ui-page page-0">'+ object.formHTML +'</div>';
                }
                $(object.box).html(object.formHTML);
                object.isGenerated = true;
                object.render(object.box);
            }
            return object;

        } else if (w2ui[$(this).attr('name')]) {
            var obj = w2ui[$(this).attr('name')];
            obj[method].apply(obj, Array.prototype.slice.call(arguments, 1));
            return this;
        } else {
            console.log('ERROR: Method ' +  method + ' does not exist on jQuery.w2form');
        }
    };

    // ====================================================
    // -- Implementation of core functionality

    w2form.prototype = {

        get: function (field, returnIndex) {
            if (arguments.length === 0) {
                var all = [];
                for (var f1 in this.fields) {
                    if (this.fields[f1].name != null) all.push(this.fields[f1].name);
                }
                return all;
            } else {
                for (var f2 in this.fields) {
                    if (this.fields[f2].name == field) {
                        if (returnIndex === true) return f2; else return this.fields[f2];
                    }
                }
                return null;
            }
        },

        set: function (field, obj) {
            for (var f in this.fields) {
                if (this.fields[f].name == field) {
                    $.extend(this.fields[f] , obj);
                    this.refresh();
                    return true;
                }
            }
            return false;
        },

        reload: function (callBack) {
            var url = (typeof this.url != 'object' ? this.url : this.url.get);
            if (url && this.recid != 0) {
                // this.clear();
                this.request(callBack);
            } else {
                // this.refresh(); // no need to refresh
                if (typeof callBack == 'function') callBack();
            }
        },

        clear: function () {
            this.recid  = 0;
            this.record = {};
            $().w2tag();
            this.refresh();
        },

        error: function (msg) {
            var obj = this;
            // let the management of the error outside of the grid
            var eventData = this.trigger({ target: this.name, type: 'error', message: msg , xhr: this.last.xhr });
            if (eventData.isCancelled === true) {
                if (typeof callBack == 'function') callBack();
                return;
            }
            // need a time out because message might be already up)
            setTimeout(function () { w2alert(msg, 'Error');    }, 1);
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        validate: function (showErrors) {
            if (typeof showErrors == 'undefined') showErrors = true;
            $().w2tag(); // hide all tags before validating
            // validate before saving
            var errors = [];
            for (var f in this.fields) {
                var field = this.fields[f];
                if (this.record[field.name] == null) this.record[field.name] = '';
                switch (field.type) {
                    case 'int':
                        if (this.record[field.name] && !w2utils.isInt(this.record[field.name])) {
                            errors.push({ field: field, error: w2utils.lang('Not an integer') });
                        }
                        break;
                    case 'float':
                        if (this.record[field.name] && !w2utils.isFloat(this.record[field.name])) {
                            errors.push({ field: field, error: w2utils.lang('Not a float') });
                        }
                        break;
                    case 'money':
                        if (this.record[field.name] && !w2utils.isMoney(this.record[field.name])) {
                            errors.push({ field: field, error: w2utils.lang('Not in money format') });
                        }
                        break;
                    case 'color':
                    case 'hex':
                        if (this.record[field.name] && !w2utils.isHex(this.record[field.name])) {
                            errors.push({ field: field, error: w2utils.lang('Not a hex number') });
                        }
                        break;
                    case 'email':
                        if (this.record[field.name] && !w2utils.isEmail(this.record[field.name])) {
                            errors.push({ field: field, error: w2utils.lang('Not a valid email') });
                        }
                        break;
                    case 'checkbox':
                        // convert true/false
                        if (this.record[field.name] == true) this.record[field.name] = 1; else this.record[field.name] = 0;
                        break;
                    case 'date':
                        // format date before submit
                        if (!field.options.format) field.options.format = w2utils.settings.date_format;
                        if (this.record[field.name] && !w2utils.isDate(this.record[field.name], field.options.format)) {
                            errors.push({ field: field, error: w2utils.lang('Not a valid date') + ': ' + field.options.format });
                        } else {
                        }
                        break;
                    case 'list':
                    case 'combo':
                        break;
                    case 'enum':
                        break;
                }
                // === check required - if field is '0' it should be considered not empty
                var val = this.record[field.name];
                if (field.required && (val === '' || ($.isArray(val) && val.length == 0) || ($.isPlainObject(val) && $.isEmptyObject(val)))) {
                    errors.push({ field: field, error: w2utils.lang('Required field') });
                }
                if (field.equalto && this.record[field.name] != this.record[field.equalto]) {
                    errors.push({ field: field, error: w2utils.lang('Field should be equal to ') + field.equalto });
                }
            }
            // event before
            var eventData = this.trigger({ phase: 'before', target: this.name, type: 'validate', errors: errors });
            if (eventData.isCancelled === true) return;
            // show error
            if (showErrors) for (var e in eventData.errors) {
                var err = eventData.errors[e];
                if (err.field.type == 'radio') { // for radio and checkboxes
                    $($(err.field.el).parents('div')[0]).w2tag(err.error, { "class": 'w2ui-error' });
                } else if (['enum', 'file'].indexOf(err.field.type) != -1) {
                    (function (err) {
                        setTimeout(function () {
                            var fld = $(err.field.el).data('w2field').helpers.multi;
                            $(err.field.el).w2tag(err.error);
                            $(fld).addClass('w2ui-error');
                        }, 1);
                    })(err);
                } else {
                    $(err.field.el).w2tag(err.error, { "class": 'w2ui-error' });
                }
                this.goto(errors[0].field.page);                
            }
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            return errors;
        },

        getChanges: function () {
            var differ = function(record, original, result) {
                for (var i in record) {
                    if (typeof record[i] == "object") {
                        result[i] = differ(record[i], original[i] || {}, {});
                        if (!result[i] || $.isEmptyObject(result[i])) delete result[i];
                    } else if (record[i] != original[i]) {
                        result[i] = record[i];
                    }
                }
                return result;
            }
            return differ(this.record, this.original, {});
        },

        request: function (postData, callBack) { // if (1) param then it is call back if (2) then postData and callBack
            var obj = this;
            // check for multiple params
            if (typeof postData == 'function') {
                callBack = postData;
                postData = null;
            }
            if (typeof postData == 'undefined' || postData == null) postData = {};
            if (!this.url || (typeof this.url == 'object' && !this.url.get)) return;
            if (this.recid == null || typeof this.recid == 'undefined') this.recid = 0;
            // build parameters list
            var params = {};
            // add list params
            params['cmd']   = 'get-record';
            params['recid'] = this.recid;
            // append other params
            $.extend(params, this.postData);
            $.extend(params, postData);
            // event before
            var eventData = this.trigger({ phase: 'before', type: 'request', target: this.name, url: this.url, postData: params });
            if (eventData.isCancelled === true) { if (typeof callBack == 'function') callBack({ status: 'error', message: 'Request aborted.' }); return; }
            // default action
            this.record   = {};
            this.original = {};
            // call server to get data
            this.lock(this.msgRefresh);
            var url = eventData.url;
            if (typeof eventData.url == 'object' && eventData.url.get) url = eventData.url.get;
            if (this.last.xhr) try { this.last.xhr.abort(); } catch (e) {};
            // process url with routeData
            if (!$.isEmptyObject(obj.routeData)) {
                var info  = w2utils.parseRoute(url);
                if (info.keys.length > 0) {
                    for (var k = 0; k < info.keys.length; k++) {
                        if (obj.routeData[info.keys[k].name] == null) continue;
                        url = url.replace((new RegExp(':'+ info.keys[k].name, 'g')), obj.routeData[info.keys[k].name]);
                    }
                }
            }
            var ajaxOptions = {
                type     : 'POST',
                url      : url,
                data     : eventData.postData, 
                dataType : 'text'   // expected from server
            };
            if (w2utils.settings.dataType == 'HTTP') {
                ajaxOptions.data = String($.param(ajaxOptions.data, false)).replace(/%5B/g, '[').replace(/%5D/g, ']');
            }
            if (w2utils.settings.dataType == 'RESTFULL') {
                ajaxOptions.type = 'GET';
                ajaxOptions.data = String($.param(ajaxOptions.data, false)).replace(/%5B/g, '[').replace(/%5D/g, ']');
            }
            if (w2utils.settings.dataType == 'JSON') {
                ajaxOptions.type        = 'POST';
                ajaxOptions.data        = JSON.stringify(ajaxOptions.data);
                ajaxOptions.contentType = 'application/json';
            }
            this.last.xhr = $.ajax(ajaxOptions)
                .done(function (data, status, xhr) {
                    obj.unlock();
                    // event before
                    var eventData = obj.trigger({ phase: 'before', target: obj.name, type: 'load', xhr: xhr });
                    if (eventData.isCancelled === true) {
                        if (typeof callBack == 'function') callBack({ status: 'error', message: 'Request aborted.' });
                        return;
                    }
                    // parse server response
                    var data;
                    var responseText = obj.last.xhr.responseText;
                    if (status != 'error') {
                        // default action
                        if (typeof responseText != 'undefined' && responseText != '') {
                            // check if the onLoad handler has not already parsed the data
                            if (typeof responseText == "object") {
                                data = responseText;
                            } else {
                                // $.parseJSON or $.getJSON did not work because those expect perfect JSON data - where everything is in double quotes
                                //
                                // TODO: avoid (potentially malicious) code injection from the response.
                                try { eval('data = '+ responseText); } catch (e) { }
                            }
                            if (typeof data == 'undefined') {
                                data = {
                                    status       : 'error',
                                    message      : obj.msgNotJSON,
                                    responseText : responseText
                                }
                            }
                            if (data['status'] == 'error') {
                                obj.error(data['message']);
                            } else {
                                obj.record   = $.extend({}, data.record);
                                obj.original = $.extend({}, data.record);
                            }
                        }
                    } else {
                        obj.error('AJAX Error ' + xhr.status + ': '+ xhr.statusText);
                        data = {
                            status       : 'error',
                            message      : obj.msgAJAXerror,
                            responseText : responseText
                        };
                    }
                    // event after
                    obj.trigger($.extend(eventData, { phase: 'after' }));
                    obj.refresh();
                    // call back
                    if (typeof callBack == 'function') callBack(data);
                })
                .fail(function (xhr, status, error) {
                    // trigger event
                    var errorObj = { status: status, error: error, rawResponseText: xhr.responseText };
                    var eventData2 = obj.trigger({ phase: 'before', type: 'error', error: errorObj, xhr: xhr });
                    if (eventData2.isCancelled === true) return;
                    // default behavior
                    if (status != 'abort') {
                        var data;
                        try { data = $.parseJSON(xhr.responseText) } catch (e) {}
                        console.log('ERROR: Server communication failed.', 
                            '\n   EXPECTED:', { status: 'success', items: [{ id: 1, text: 'item' }] }, 
                            '\n         OR:', { status: 'error', message: 'error message' },
                            '\n   RECEIVED:', typeof data == 'object' ? data : xhr.responseText);
                    }
                    // event after
                    obj.trigger($.extend(eventData2, { phase: 'after' }));
                });
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        submit: function (postData, callBack) {
            return this.save(postData, callBack);
        },

        save: function (postData, callBack) {
            var obj = this;
            $(this.box).find(':focus').change(); // trigger onchange
            // check for multiple params
            if (typeof postData == 'function') {
                callBack = postData;
                postData = null;
            }
            // validation
            var errors = obj.validate(true);
            if (errors.length !== 0) return;
            // submit save
            if (typeof postData == 'undefined' || postData == null) postData = {};
            if (!obj.url || (typeof obj.url == 'object' && !obj.url.save)) {
                console.log("ERROR: Form cannot be saved because no url is defined.");
                return;
            }
            obj.lock(obj.msgSaving + ' <span id="'+ obj.name +'_progress"></span>');
            // need timer to allow to lock
            setTimeout(function () {
                // build parameters list
                var params = {};
                // add list params
                params['cmd']   = 'save-record';
                params['recid'] = obj.recid;
                // append other params
                $.extend(params, obj.postData);
                $.extend(params, postData);
                params.record = $.extend(true, {}, obj.record);
                // event before
                var eventData = obj.trigger({ phase: 'before', type: 'submit', target: obj.name, url: obj.url, postData: params });
                if (eventData.isCancelled === true) return;
                // default action
                var url = eventData.url;
                if (typeof eventData.url == 'object' && eventData.url.save) url = eventData.url.save;
                if (obj.last.xhr) try { obj.last.xhr.abort(); } catch (e) {};
                // process url with routeData
                if (!$.isEmptyObject(obj.routeData)) {
                    var info  = w2utils.parseRoute(url);
                    if (info.keys.length > 0) {
                        for (var k = 0; k < info.keys.length; k++) {
                            if (obj.routeData[info.keys[k].name] == null) continue;
                            url = url.replace((new RegExp(':'+ info.keys[k].name, 'g')), obj.routeData[info.keys[k].name]);
                        }
                    }
                }
                var ajaxOptions = {
                    type     : 'POST',
                    url      : url,
                    data     : eventData.postData, 
                    dataType : 'text',   // expected from server
                    xhr : function() {
                        var xhr = new window.XMLHttpRequest();
                        // upload
                        xhr.upload.addEventListener("progress", function(evt) {
                            if (evt.lengthComputable) {
                                var percent = Math.round(evt.loaded / evt.total * 100);
                                $('#'+ obj.name + '_progress').text(''+ percent + '%');
                            }
                        }, false);
                        return xhr;
                    }
                };
                if (w2utils.settings.dataType == 'HTTP') {
                    ajaxOptions.data = String($.param(ajaxOptions.data, false)).replace(/%5B/g, '[').replace(/%5D/g, ']');
                }
                if (w2utils.settings.dataType == 'RESTFULL') {
                    if (obj.recid != 0) ajaxOptions.type = 'PUT';
                    ajaxOptions.data = String($.param(ajaxOptions.data, false)).replace(/%5B/g, '[').replace(/%5D/g, ']');
                }
                if (w2utils.settings.dataType == 'JSON') {
                    ajaxOptions.type        = 'POST';
                    ajaxOptions.data        = JSON.stringify(ajaxOptions.data);
                    ajaxOptions.contentType = 'application/json';
                }

                obj.last.xhr = $.ajax(ajaxOptions)
                    .done(function (data, status, xhr) {
                        obj.unlock();
                        // event before
                        var eventData = obj.trigger({ phase: 'before', target: obj.name, type: 'save', xhr: xhr, status: status });
                        if (eventData.isCancelled === true) return;
                        // parse server response
                        var data;
                        var responseText = xhr.responseText;
                        if (status != 'error') {
                            // default action
                            if (typeof responseText != 'undefined' && responseText != '') {
                                // check if the onLoad handler has not already parsed the data
                                if (typeof responseText == "object") {
                                    data = responseText;
                                } else {
                                    // $.parseJSON or $.getJSON did not work because those expect perfect JSON data - where everything is in double quotes
                                    //
                                    // TODO: avoid (potentially malicious) code injection from the response.
                                    try { eval('data = '+ responseText); } catch (e) { }
                                }
                                if (typeof data == 'undefined') {
                                    data = {
                                        status       : 'error',
                                        message      : obj.msgNotJSON,
                                        responseText : responseText
                                    }
                                }
                                if (data['status'] == 'error') {
                                    obj.error(data['message']);
                                } else {
                                    obj.original = $.extend({}, obj.record);
                                }
                            }
                        } else {
                            obj.error('AJAX Error ' + xhr.status + ': '+ xhr.statusText);
                            data = {
                                status       : 'error',
                                message      : obj.msgAJAXerror,
                                responseText : responseText
                            };
                        }
                        // event after
                        obj.trigger($.extend(eventData, { phase: 'after' }));
                        obj.refresh();
                        // call back
                        if (data.status == 'success' && typeof callBack == 'function') callBack(data);
                    })
                    .fail(function (xhr, status, error) {
                        // trigger event
                        var errorObj = { status: status, error: error, rawResponseText: xhr.responseText };
                        var eventData2 = obj.trigger({ phase: 'before', type: 'error', error: errorObj, xhr: xhr });
                        if (eventData2.isCancelled === true) return;
                        // default behavior
                        console.log('ERROR: server communication failed. The server should return', 
                            { status: 'success' }, 'OR', { status: 'error', message: 'error message' }, 
                            ', instead the AJAX request produced this: ', errorObj);
                        // event after
                        obj.trigger($.extend(eventData2, { phase: 'after' }));
                    });
                // event after
                obj.trigger($.extend(eventData, { phase: 'after' }));
            }, 50);
        },

        lock: function (msg, showSpinner) {
            var box = $(this.box).find('> div:first-child');
            var args = Array.prototype.slice.call(arguments, 0);
            args.unshift(box);
            w2utils.lock.apply(window, args);
        },

        unlock: function () {
            var obj = this;
            setTimeout(function () { w2utils.unlock(obj.box); }, 25); // needed timer so if server fast, it will not flash
        },

        goto: function (page) {
            if (typeof page != 'undefined') this.page = page;
            // if it was auto size, resize it
            if ($(this.box).data('auto-size') === true) $(this.box).height(0);
            this.refresh();
        },

        generateHTML: function () {
            var pages = []; // array for each page
            var group = '';
            var page;
            for (var f in this.fields) {
                var html = '';
                var field = this.fields[f];
                if (typeof field.html == 'undefined') field.html = {};
                field.html = $.extend(true, { caption: '', span: 6, attr: '', text: '', page: 0 }, field.html);
                if (typeof page == 'undefined') page = field.html.page;
                if (field.html.caption == '') field.html.caption = field.name;
                var input = '<input name="'+ field.name +'" type="text" '+ field.html.attr +'/>';
                if ((field.type === 'pass') || (field.type === 'password')){
                    input = '<input name="' + field.name + '" type = "password" ' + field.html.attr + '/>';
                }
                if (field.type == 'checkbox') input = '<input name="'+ field.name +'" type="checkbox" '+ field.html.attr +'/>';
                if (field.type == 'textarea') input = '<textarea name="'+ field.name +'" '+ field.html.attr +'></textarea>';
                if (field.type == 'toggle')   input = '<input name="'+ field.name +'" type="checkbox" '+ field.html.attr +' class="w2ui-toggle"/><div><div></div></div>';
                if (field.html.group) {
                    if (group != '') html += '\n   </div>';
                    html += '\n   <div class="w2ui-group-title">'+ field.html.group + '</div>\n   <div class="w2ui-group">';
                    group = field.html.group;
                }
                if (field.html.page != page && group != '') {
                    pages[pages.length-1] += '\n   </div>';
                    group = '';
                }
                html += '\n      <div class="w2ui-field '+ (typeof field.html.span != 'undefined' ? 'w2ui-span'+ field.html.span : '') +'">'+ 
                        '\n         <label>' + w2utils.lang(field.html.caption) +'</label>'+
                        '\n         <div>'+ input + w2utils.lang(field.html.text) + '</div>'+
                        '\n      </div>';
                if (typeof pages[field.html.page] == 'undefined') pages[field.html.page] = '';
                pages[field.html.page] += html;
                page = field.html.page;
            }
            if (group != '') pages[pages.length-1] += '\n   </div>';
            if (this.tabs.tabs) {
                for (var i = 0; i < this.tabs.tabs.length; i++) if (typeof pages[i] == 'undefined') pages[i] = '';
            }
            for (var p in pages) pages[p] = '<div class="w2ui-page page-'+ p +'">' + pages[p] + '\n</div>';
            // buttons if any
            var buttons = '';
            if (!$.isEmptyObject(this.actions)) {
                var addClass = '';
                buttons += '\n<div class="w2ui-buttons">';
                for (var a in this.actions) {
                    if (['save', 'update', 'create'].indexOf(a.toLowerCase()) != -1) addClass = 'btn-green'; else addClass = '';
                    buttons += '\n    <button name="'+ a +'" class="btn '+ addClass +'">'+ w2utils.lang(a) +'</button>';
                }
                buttons += '\n</div>';
            }
            return pages.join('') + buttons;
        },

        action: function (action, event) {
            // event before
            var eventData = this.trigger({ phase: 'before', target: action, type: 'action', originalEvent: event });
            if (eventData.isCancelled === true) return;
            // default actions
            if (typeof (this.actions[action]) == 'function') {
                this.actions[action].call(this, event);
            }
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
        },

        resize: function () {
            var obj = this;
            // event before
            var eventData = this.trigger({ phase: 'before', target: this.name, type: 'resize' });
            if (eventData.isCancelled === true) return;
            // default behaviour
            var main    = $(this.box).find('> div');
            var header  = $(this.box).find('> div .w2ui-form-header');
            var toolbar = $(this.box).find('> div .w2ui-form-toolbar');
            var tabs    = $(this.box).find('> div .w2ui-form-tabs');
            var page    = $(this.box).find('> div .w2ui-page');
            var cpage   = $(this.box).find('> div .w2ui-page.page-'+ this.page);
            var dpage   = $(this.box).find('> div .w2ui-page.page-'+ this.page + ' > div');
            var buttons = $(this.box).find('> div .w2ui-buttons');
            // if no height, calculate it
            resizeElements();
            if (parseInt($(this.box).height()) == 0 || $(this.box).data('auto-size') === true) {
                $(this.box).height(
                    (header.length > 0 ? w2utils.getSize(header, 'height') : 0) +
                    ((typeof this.tabs === 'object' && $.isArray(this.tabs.tabs) && this.tabs.tabs.length > 0) ? w2utils.getSize(tabs, 'height') : 0) +
                    ((typeof this.toolbar == 'object' && $.isArray(this.toolbar.items) && this.toolbar.items.length > 0) ? w2utils.getSize(toolbar, 'height') : 0) +
                    (page.length > 0 ? w2utils.getSize(dpage, 'height') + w2utils.getSize(cpage, '+height') + 12 : 0) +  // why 12 ???
                    (buttons.length > 0 ? w2utils.getSize(buttons, 'height') : 0)
                );
                $(this.box).data('auto-size', true);
            }
            resizeElements();
            // event after
            obj.trigger($.extend(eventData, { phase: 'after' }));

            function resizeElements() {
                // resize elements
                main.width($(obj.box).width()).height($(obj.box).height());
                toolbar.css('top', (obj.header != '' ? w2utils.getSize(header, 'height') : 0));
                tabs.css('top', (obj.header != '' ? w2utils.getSize(header, 'height') : 0)
                              + ((typeof obj.toolbar == 'object' && $.isArray(obj.toolbar.items) && obj.toolbar.items.length > 0) ? w2utils.getSize(toolbar, 'height') : 0));
                page.css('top', (obj.header != '' ? w2utils.getSize(header, 'height') : 0)
                              + ((typeof obj.toolbar == 'object' && $.isArray(obj.toolbar.items) && obj.toolbar.items.length > 0) ? w2utils.getSize(toolbar, 'height') + 5 : 0)
                              + ((typeof obj.tabs === 'object' && $.isArray(obj.tabs.tabs) && obj.tabs.tabs.length > 0) ? w2utils.getSize(tabs, 'height') + 5 : 0));
                page.css('bottom', (buttons.length > 0 ? w2utils.getSize(buttons, 'height') : 0));
            }
        },

        refresh: function () {
            var time = (new Date()).getTime();
            var obj = this;
            if (!this.box) return;
            if (!this.isGenerated || typeof $(this.box).html() == 'undefined') return;
            // update what page field belongs
            $(this.box).find('input, textarea, select').each(function (index, el) {
                var name  = (typeof $(el).attr('name') != 'undefined' ? $(el).attr('name') : $(el).attr('id'));
                var field = obj.get(name);
                if (field) {
                    // find page
                    var div = $(el).parents('.w2ui-page');
                    if (div.length > 0) {
                        for (var i = 0; i < 100; i++) {
                            if (div.hasClass('page-'+i)) { field.page = i; break; }
                        }
                    }
                }
            });
            // event before
            var eventData = this.trigger({ phase: 'before', target: this.name, type: 'refresh', page: this.page })
            if (eventData.isCancelled === true) return;
            // default action
            $(this.box).find('.w2ui-page').hide();
            $(this.box).find('.w2ui-page.page-' + this.page).show();
            $(this.box).find('.w2ui-form-header').html(this.header);
            // refresh tabs if needed
            if (typeof this.tabs === 'object' && $.isArray(this.tabs.tabs) && this.tabs.tabs.length > 0) {
                $('#form_'+ this.name +'_tabs').show();
                this.tabs.active = this.tabs.tabs[this.page].id;
                this.tabs.refresh();
            } else {
                $('#form_'+ this.name +'_tabs').hide();
            }
            // refresh tabs if needed
            if (typeof this.toolbar == 'object' && $.isArray(this.toolbar.items) && this.toolbar.items.length > 0) {
                $('#form_'+ this.name +'_toolbar').show();
                this.toolbar.refresh();
            } else {
                $('#form_'+ this.name +'_toolbar').hide();
            }
            // refresh values of all fields
            for (var f in this.fields) {
                var field = this.fields[f];
                if (typeof field.name == 'undefined' && typeof field.field != 'undefined') field.name = field.field;
                if (typeof field.field == 'undefined' && typeof field.name != 'undefined') field.field = field.name;
                field.$el = $(this.box).find('[name="'+ String(field.name).replace(/\\/g, '\\\\') +'"]');
                field.el  = field.$el[0];
                if (typeof field.el == 'undefined') {
                    console.log('ERROR: Cannot associate field "'+ field.name + '" with html control. Make sure html control exists with the same name.');
                    //return;
                }
                if (field.el) field.el.id = field.name;
                var tmp = $(field).data('w2field');
                if (tmp) tmp.clear();
                $(field.$el).off('change').on('change', function () {
                    var value_new      = this.value;
                    var value_previous = obj.record[this.name] ? obj.record[this.name] : '';
                    var field          = obj.get(this.name);
                    if (['list', 'enum', 'file'].indexOf(field.type) != -1 && $(this).data('selected')) {
                        var nv = $(this).data('selected');
                        var cv = obj.record[this.name];
                        if ($.isArray(nv)) {
                            value_new = [];
                            for (var i in nv) value_new[i] = $.extend(true, {}, nv[i]); // clone array
                        }
                        if ($.isPlainObject(nv)) {
                            value_new = $.extend(true, {}, nv); // clone object
                        }
                        if ($.isArray(cv)) {
                            value_previous = [];
                            for (var i in cv) value_previous[i] = $.extend(true, {}, cv[i]); // clone array
                        }
                        if ($.isPlainObject(cv)) {
                            value_previous = $.extend(true, {}, cv); // clone object
                        }
                    }
                    if (field.type == 'toggle') value_new = ($(this).prop('checked') ? 1 : 0);
                    // clean extra chars
                    if (['int', 'float', 'percent', 'money', 'currency'].indexOf(field.type) != -1) {
                        value_new = $(this).data('w2field').clean(value_new);
                    }
                    if (value_new === value_previous) return;
                    // event before
                    var eventData = obj.trigger({ phase: 'before', target: this.name, type: 'change', value_new: value_new, value_previous: value_previous });
                    if (eventData.isCancelled === true) {
                        $(this).val(obj.record[this.name]); // return previous value
                        return;
                    }
                    // default action
                    var val = this.value;
                    if (this.type == 'select')   val = this.value;
                    if (this.type == 'checkbox') val = this.checked ? true : false;
                    if (this.type == 'radio') {
                        field.$el.each(function (index, el) {
                            if (el.checked) val = el.value;
                        });
                    }
                    if (['int', 'float', 'percent', 'money', 'currency', 'list', 'combo', 'enum', 'file', 'toggle'].indexOf(field.type) != -1) {
                        val = value_new;
                    }
                    if (['enum', 'file'].indexOf(field.type) != -1) {
                        if (val.length > 0) {
                            var fld = $(field.el).data('w2field').helpers.multi;
                            $(fld).removeClass('w2ui-error');
                        }
                    }
                    obj.record[this.name] = val;
                    // event after
                    obj.trigger($.extend(eventData, { phase: 'after' }));
                });
                if (field.required) {
                    $(field.el).parent().parent().addClass('w2ui-required');
                } else {
                    $(field.el).parent().parent().removeClass('w2ui-required');
                }
            }
            // attach actions on buttons
            $(this.box).find('button, input[type=button]').each(function (index, el) {
                $(el).off('click').on('click', function (event) {
                    var action = this.value;
                    if (this.id)   action = this.id;
                    if (this.name) action = this.name;
                    obj.action(action, event);
                });
            });
            // init controls with record
            for (var f in this.fields) {
                var field = this.fields[f];
                var value = (typeof this.record[field.name] != 'undefined' ? this.record[field.name] : '');
                if (!field.el) continue;
                field.type = String(field.type).toLowerCase();
                if (!field.options) field.options = {};
                switch (field.type) {
                    case 'text':
                    case 'textarea':
                    case 'email':
                    case 'pass':
                    case 'password':
                        field.el.value = value;
                        break;
                    case 'int':
                    case 'float':
                    case 'money':
                    case 'currency':
                    case 'percent':
                    case 'hex':
                    case 'alphanumeric':
                    case 'color':
                    case 'date':
                    case 'time':
                        field.el.value = value;
                        $(field.el).w2field($.extend({}, field.options, { type: field.type }));
                        break;
                    case 'toggle':
                        if (w2utils.isFloat(value)) value = parseFloat(value);
                        $(field.el).prop('checked', (value ? true : false));
                        this.record[field.name] = (value ? 1 : 0);
                        break;
                    // enums
                    case 'list':
                    case 'combo':
                        if (field.type == 'list') {
                            var tmp_value = ($.isPlainObject(value) ? value.id : value);
                            // normalized options
                            var items = field.options.items;
                            if ($.isArray(items) && items.length > 0 && !$.isPlainObject(items[0])) {
                                field.options.items = w2obj.field.prototype.normMenu(items);
                            }
                            // find value from items 
                            for (var i in field.options.items) {
                                var item = field.options.items[i];
                                if (item.id == tmp_value) {
                                    value = $.extend(true, {}, item);
                                    obj.record[field.name] = value;
                                    break;
                                }
                            }
                        } else if (field.type == 'combo' && !$.isPlainObject(value)) {
                            field.el.value = value;
                        } else if ($.isPlainObject(value) && typeof value.text != 'undefined') {
                            field.el.value = value.text;
                        } else {
                            field.el.value = '';
                        }
                        if (!$.isPlainObject(value)) value = {};
                        $(field.el).w2field($.extend({}, field.options, { type: field.type, selected: value }));
                        break;
                    case 'enum':
                    case 'file':
                        if (!$.isArray(value)) value = [];
                        $(field.el).w2field($.extend({}, field.options, { type: field.type, selected: value }));
                        break;

                    // standard HTML
                    case 'select':
                        // generate options
                        var items = field.options.items;
                        if (typeof items != 'undefined' && items.length > 0) {
                            items = w2obj.field.prototype.normMenu(items);
                            $(field.el).html('');
                            for (var it in items) {
                                $(field.el).append('<option value="'+ items[it].id +'">' + items[it].text + '</option');
                            }
                        }
                        $(field.el).val(value);
                        break;
                    case 'radio':
                        $(field.$el).prop('checked', false).each(function (index, el) {
                            if ($(el).val() == value) $(el).prop('checked', true);
                        });
                        break;
                    case 'checkbox':
                        $(field.el).prop('checked', value ? true : false);
                        break;
                    default:
                        $(field.el).w2field($.extend({}, field.options, { type: field.type }));
                        break;
                }
            }
            // wrap pages in div
            var tmp = $(this.box).find('.w2ui-page');
            for (var i = 0; i < tmp.length; i++) {
                if ($(tmp[i]).find('> *').length > 1) $(tmp[i]).wrapInner('<div></div>');
            }
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            this.resize();
            return (new Date()).getTime() - time;
        },

        render: function (box) {
            var time = (new Date()).getTime();
            var obj = this;
            if (typeof box == 'object') {
                // remove from previous box
                if ($(this.box).find('#form_'+ this.name +'_tabs').length > 0) {
                    $(this.box).removeAttr('name')
                        .removeClass('w2ui-reset w2ui-form')
                        .html('');
                }
                this.box = box;
            }
            if (!this.isGenerated) return;
            if (!this.box) return;
            // event before
            var eventData = this.trigger({ phase: 'before', target: this.name, type: 'render', box: (typeof box != 'undefined' ? box : this.box) });
            if (eventData.isCancelled === true) return;
            // default actions
            if ($.isEmptyObject(this.original) && !$.isEmptyObject(this.record)) {
                this.original = $.extend(true, {}, this.record);
            }
            var html =  '<div>' +
                        (this.header != '' ? '<div class="w2ui-form-header">' + this.header + '</div>' : '') +
                        '    <div id="form_'+ this.name +'_toolbar" class="w2ui-form-toolbar"></div>' +
                        '    <div id="form_'+ this.name +'_tabs" class="w2ui-form-tabs"></div>' +
                            this.formHTML +
                        '</div>';
            $(this.box).attr('name', this.name)
                .addClass('w2ui-reset w2ui-form')
                .html(html);
            if ($(this.box).length > 0) $(this.box)[0].style.cssText += this.style;

            // init toolbar regardless it is defined or not
            if (typeof this.toolbar.render !== 'function') {
                this.toolbar = $().w2toolbar($.extend({}, this.toolbar, { name: this.name +'_toolbar', owner: this }));
                this.toolbar.on('click', function (event) {
                    var eventData = obj.trigger({ phase: 'before', type: 'toolbar', target: event.target, originalEvent: event });
                    if (eventData.isCancelled === true) return;
                    // no default action
                    obj.trigger($.extend(eventData, { phase: 'after' }));
                });
            }
            if (typeof this.toolbar == 'object' && typeof this.toolbar.render == 'function') {
                this.toolbar.render($('#form_'+ this.name +'_toolbar')[0]);
            }
            // init tabs regardless it is defined or not
            if (typeof this.tabs.render !== 'function') {
                this.tabs = $().w2tabs($.extend({}, this.tabs, { name: this.name +'_tabs', owner: this }));
                this.tabs.on('click', function (event) {
                    obj.goto(this.get(event.target, true));
                });
            }
            if (typeof this.tabs == 'object' && typeof this.tabs.render == 'function') {
                this.tabs.render($('#form_'+ this.name +'_tabs')[0]);
            }
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            // after render actions
            this.resize();
            var url = (typeof this.url != 'object' ? this.url : this.url.get);
            if (url && this.recid != 0) {
                this.request();
            } else {
                this.refresh();
            }
            // attach to resize event
            if ($('.w2ui-layout').length == 0) { // if there is layout, it will send a resize event
                this.tmp_resize = function (event) { w2ui[obj.name].resize(); }
                $(window).off('resize', 'body').on('resize', 'body', this.tmp_resize);
            }
            setTimeout(function () { obj.resize(); obj.refresh(); }, 150); // need timer because resize is on timer
            // focus on load
            function focusEl() {
                var inputs = $(obj.box).find('input, select, textarea');
                if (inputs.length > obj.focus) inputs[obj.focus].focus();
            }
            if (this.focus >= 0) setTimeout(focusEl, 500); // need timeout to allow form to render
            return (new Date()).getTime() - time;
        },

        destroy: function () {
            // event before
            var eventData = this.trigger({ phase: 'before', target: this.name, type: 'destroy' });
            if (eventData.isCancelled === true) return;
            // clean up
            if (typeof this.toolbar == 'object' && this.toolbar.destroy) this.toolbar.destroy();
            if (typeof this.tabs == 'object' && this.tabs.destroy) this.tabs.destroy();
            if ($(this.box).find('#form_'+ this.name +'_tabs').length > 0) {
                $(this.box)
                    .removeAttr('name')
                    .removeClass('w2ui-reset w2ui-form')
                    .html('');
            }
            delete w2ui[this.name];
            // event after
            this.trigger($.extend(eventData, { phase: 'after' }));
            $(window).off('resize', 'body')
        }
    };

    $.extend(w2form.prototype, w2utils.event);
    w2obj.form = w2form;
})();

GLOBAL.w2ui= w2ui;
GLOBAL.w2obj= w2obj;
GLOBAL.w2utils = w2utils;
})(window,jQuery);


/************************************************************************
* w2ui-popup을 멀티로 쓸수 있도록 최소한의 수정을 가함
************************************************************************/

var w2popup = {};

(function (GLOBAL,jQuery) {
    var $ = jQuery;
    // ====================================================
    // -- Registers as a jQuery plugin

    $.fn.w2popup = function(method, options) {
        if (typeof method === 'undefined') {
            options = {};
            method  = 'open';
        }
        if ($.isPlainObject(method)) {
            options = method;
            method  = 'open';
        }
        method = method.toLowerCase();
        if (method === 'load' && typeof options === 'string') {
            options = $.extend({ url: options }, arguments.length > 2 ? arguments[2] : {});
        }
        if (method === 'open' && options.url != null) method = 'load';
        options = options || {};
        // load options from markup
        var dlgOptions = {};
        if ($(this).length > 0) {
            if ($(this).find('div[rel=title], div[rel=body], div[rel=buttons]').length > 0) {
                if ($(this).find('div[rel=title]').length > 0) {
                    dlgOptions['title'] = $(this).find('div[rel=title]').html();
                }
                if ($(this).find('div[rel=body]').length > 0) {
                    dlgOptions['body']  = $(this).find('div[rel=body]').html();
                    dlgOptions['style'] = $(this).find('div[rel=body]')[0].style.cssText;
                }
                if ($(this).find('div[rel=buttons]').length > 0) {
                    dlgOptions['buttons'] = $(this).find('div[rel=buttons]').html();
                }
            } else {
                dlgOptions['title'] = '&nbsp;';
                dlgOptions['body']  = $(this).html();
            }
            if (parseInt($(this).css('width')) != 0)  dlgOptions['width']  = parseInt($(this).css('width'));
            if (parseInt($(this).css('height')) != 0) dlgOptions['height'] = parseInt($(this).css('height'));
        }
        // show popup
        return w2popup[method]($.extend({}, dlgOptions, options));
    };

    // ====================================================
    // -- Implementation of core functionality (SINGELTON)

    var id= 0;
    w2popup.open = function (options) {
        var _id = "_" + id;
        var w2popup = {
            _id : _id,
            defaults: {
                title     : '',
                body      : '',
                buttons   : '',
                style     : '',
                color     : '#000',
                opacity   : 0.01,
                speed     : 0.3,
                modal     : false,
                maximized : false,
                keyboard  : false,     // will close popup on esc if not modal
                width     : 500,
                height    : 300,
                showClose : true,
                showMax   : false,
                transition: null
            },
            status    : 'closed',     // string that describes current status
            handlers  : [],
            onOpen    : null,
            onClose   : null,
            onMax     : null,
            onMin     : null,
            onToggle  : null,
            onKeydown : null,

            open: function (options) {
                var obj = this;
                if (w2popup.status == 'closing') {
                    setTimeout(function () { obj.open.call(obj, options); }, 100);
                    return;
                }
                // get old options and merge them
                var old_options = $('#w2ui-popup'+_id+'').data('options');
                var options = $.extend({}, this.defaults, old_options, { title: '', body : '', buttons: '' }, options, { maximized: false });
                // need timer because popup might not be open
                setTimeout(function () { $('#w2ui-popup'+_id+'').data('options', options); }, 100);
                // if new - reset event handlers
                if ($('#w2ui-popup'+_id+'').length == 0) {
                    w2popup.handlers  = [];
                    w2popup.onMax     = null;
                    w2popup.onMin     = null;
                    w2popup.onToggle  = null;
                    w2popup.onOpen    = null;
                    w2popup.onClose   = null;
                    w2popup.onKeydown = null;
                }
                if (options.onOpen)    w2popup.onOpen    = options.onOpen;
                if (options.onClose)   w2popup.onClose   = options.onClose;
                if (options.onMax)     w2popup.onMax     = options.onMax;
                if (options.onMin)     w2popup.onMin     = options.onMin;
                if (options.onToggle)  w2popup.onToggle  = options.onToggle;
                if (options.onKeydown) w2popup.onKeydown = options.onKeydown;

                if (options.title != '') {
                    options.height += 32;
                }

                if (window.innerHeight == undefined) {
                    var width  = document.documentElement.offsetWidth;
                    var height = document.documentElement.offsetHeight;
                    if (w2utils.engine === 'IE7') { width += 21; height += 4; }
                } else {
                    var width  = window.innerWidth;
                    var height = window.innerHeight;
                }
                //if (parseInt(width)  - 10 < parseInt(options.width))  options.width  = parseInt(width)  - 10;
                //if (parseInt(height) - 10 < parseInt(options.height)) {
                    //options.height = parseInt(height) - 10;
                    //options.width += 15; // for vertical scrollbar space
                //}

                var top ;
                var left;

                if (options.top !== undefined) {
                    top = options.top;
                } else {
                    top  = Math.max(parseInt(((parseInt(height) - parseInt(options.height)) / 2) * 0.6), 10);
                }

                if (options.left !== undefined) {
                    left = options.left;
                } else {
                    left = Math.max(parseInt((parseInt(width) - parseInt(options.width)) / 2), 10);
                }

                // check if message is already displayed
                //if ($('#w2ui-popup').length == 0)

                //if (true) {
                if ($('#w2ui-popup'+this._id).length == 0) {
                    // trigger event
                    var eventData = this.trigger({ phase: 'after', type: 'open', target: 'popup', options: options, present: false });
                    if (eventData.isCancelled === true) return;
                    w2popup.status = 'opening';
                    // output message
                    w2popup.lockScreen(options);
                    var btn = '';
                    if (options.showClose) {
                        btn += '<div class="w2ui-msg-button w2ui-msg-close" onmousedown="event.stopPropagation()" onclick="//w2popup'+_id+'.close()">Close</div>';
                    }
                    if (options.showMax) {
                        btn += '<div class="w2ui-msg-button w2ui-msg-max" onmousedown="event.stopPropagation()" onclick="w2popup.toggle()">Max</div>';
                    }

                    var leftValue = left+"px";
                    var topValue = top+"px";
                    var widthValue = parseInt(options.width)+"px";
                    var heightValue = parseInt(options.height) +"px";

                    if(bowser.mobile === true) {
                        var leftValue = "0px";
                        var topValue = "0px";
                        var widthValue = "100%";
                        var heightValue = "100%";
                    }


                    var msg='<div id="w2ui-popup'+_id+'" class="w2ui-popup" style="opacity: 0; left: '+ leftValue +'; top: '+ topValue +';'+
                            '     width: ' + widthValue + '; height: ' + heightValue + '; '+
                            '    -webkit-transform: scale(0.8); -moz-transform: scale(0.8); -ms-transform: scale(0.8); -o-transform: scale(0.8); "'+
                            '>'+
                            '   <div class="w2ui-msg-title" style="'+ (options.title == '' ? 'opacity:0; /* display: none */' : '') +'">' + btn + options.title + '</div>'+
                            '   <div class="w2ui-box1" style="'+ (options.title == '' ? 'top: 0px !important;' : '') +
                                        (options.buttons == '' ? 'bottom: 0px !important;' : '') + '">'+
                            '       <div class="w2ui-msg-body' + (!options.title != '' ? ' w2ui-msg-no-title' : '') +
                                        (!options.buttons != '' ? ' w2ui-msg-no-buttons' : '') + '" style="' + options.style + '">' + options.body + '</div>'+
                            '   </div>'+
                            '   <div class="w2ui-box2" style="' + (options.title == '' ? 'top: 0px !important;' : '') +
                                        (options.buttons == '' ? 'bottom: 0px !important;' : '') + '">'+
                            '       <div class="w2ui-msg-body' + (!options.title != '' ? ' w2ui-msg-no-title' : '') +
                                        (!options.buttons != '' ? ' w2ui-msg-no-buttons' : '') + '" style="' + options.style + '"></div>'+
                            '       </div>'+
                            '   <div class="w2ui-msg-buttons" style="'+ (options.buttons == '' ? 'display: none' : '') +'">' + options.buttons + '</div>'+
                            '</div>';


                    $('body').append(msg);
                    // allow element to render
                    setTimeout(function () {
                        $('#w2ui-popup'+_id+' .w2ui-box2').hide();
                        $('#w2ui-popup'+_id+'').css({
                            '-webkit-transition': options.speed + 's opacity, ' + options.speed + 's -webkit-transform',
                            '-webkit-transform': 'scale(1)',
                            '-moz-transition': options.speed + 's opacity, ' + options.speed + 's -moz-transform',
                            '-moz-transform': 'scale(1)',
                            '-ms-transition': options.speed + 's opacity, ' + options.speed + 's -ms-transform',
                            '-ms-transform': 'scale(1)',
                            '-o-transition': options.speed + 's opacity, ' + options.speed + 's -o-transform',
                            '-o-transform': 'scale(1)',
                            'opacity': '1'
                        });
                    }, 1);
                    // clean transform
                    setTimeout(function () {
                        $('#w2ui-popup').css({
                            '-webkit-transform': '',
                            '-moz-transform': '',
                            '-ms-transform': '',
                            '-o-transform': ''
                        });
                        // event after
                        w2popup.status = 'open';
                        setTimeout(function () {
                            obj.trigger($.extend(eventData, { phase: 'after' }));
                        }, 100);
                    }, options.speed * 1000);
                } else {
                    // trigger event
                    var eventData = this.trigger({ phase: 'before', type: 'open', target: 'popup', options: options, present: true });
                    if (eventData.isCancelled === true) return;
                    // check if size changed
                    w2popup.status = 'opening';
                    if (typeof old_options == 'undefined' || old_options['width'] != options['width'] || old_options['height'] != options['height']) {
                        w2popup.resize(options.width, options.height);
                    }
                    if (typeof old_options != 'undefined') {
                        options.prevSize  = options.width + ':' + options.height;
                        options.maximized = old_options.maximized;
                    }
                    // show new items
                    var body = $('#w2ui-popup'+_id+' .w2ui-box2 > .w2ui-msg-body').html(options.body);
                    if (body.length > 0) body[0].style.cssText = options.style;
                    if (options.buttons != '') {
                        $('#w2ui-popup'+_id+' .w2ui-msg-buttons').show().html(options.buttons);
                        $('#w2ui-popup'+_id+' .w2ui-msg-body').removeClass('w2ui-msg-no-buttons');
                        $('#w2ui-popup'+_id+' .w2ui-box1, #w2ui-popup'+_id+' .w2ui-box2').css('bottom', '');
                    } else {
                        $('#w2ui-popup'+_id+' .w2ui-msg-buttons').hide().html('');
                        $('#w2ui-popup'+_id+' .w2ui-msg-body').addClass('w2ui-msg-no-buttons');
                        $('#w2ui-popup'+_id+' .w2ui-box1, #w2ui-popup'+_id+' .w2ui-box2').css('bottom', '0px');
                    }
                    if (options.title != '') {
                        $('#w2ui-popup'+_id+' .w2ui-msg-title').show().html(
                              (options.showClose ? '<div class="w2ui-msg-button w2ui-msg-close" onmousedown="event.stopPropagation()" onclick="w2popup.close()">Close</div>' : '') +
                              (options.showMax ? '<div class="w2ui-msg-button w2ui-msg-max" onmousedown="event.stopPropagation()" onclick="w2popup.toggle()">Max</div>' : '') +
                              options.title);
                        $('#w2ui-popup'+_id+' .w2ui-msg-body').removeClass('w2ui-msg-no-title');
                        $('#w2ui-popup'+_id+' .w2ui-box1, #w2ui-popup'+_id+' .w2ui-box2').css('top', '');
                    } else {
                        $('#w2ui-popup'+_id+' .w2ui-msg-title').hide().html('');
                        $('#w2ui-popup'+_id+' .w2ui-msg-body').addClass('w2ui-msg-no-title');
                        $('#w2ui-popup'+_id+' .w2ui-box1, #w2ui-popup'+_id+' .w2ui-box2').css('top', '0px');
                    }
                    // transition
                    var div_old = $('#w2ui-popup'+_id+' .w2ui-box1')[0];
                    var div_new = $('#w2ui-popup'+_id+' .w2ui-box2')[0];
                    w2utils.transition(div_old, div_new, options.transition);
                    div_new.className = 'w2ui-box1';
                    div_old.className = 'w2ui-box2';
                    $(div_new).addClass('w2ui-current-box');
                    // remove max state
                    $('#w2ui-popup'+_id+'').data('prev-size', null);
                    // call event onChange
                    setTimeout(function () {
                        w2popup.status = 'open';
                        obj.trigger($.extend(eventData, { phase: 'after' }));
                    }, 100);
                }
                // save new options
                options._last_w2ui_name = w2utils.keyboard.active();
                w2utils.keyboard.active(null);
                // keyboard events
                if (options.keyboard) $(document).on('keydown', this.keydown);

                // initialize move
                var tmp = {
                    resizing : false,
                    mvMove   : mvMove,
                    mvStop   : mvStop
                };
                if (!options.embed) $('#w2ui-popup'+_id+' .w2ui-msg-title').on('mousedown', function (event) { mvStart(event); })

                // handlers
                function mvStart(evnt) {
                    if (!evnt) evnt = window.event;
                    if (!window.addEventListener) { window.document.attachEvent('onselectstart', function() { return false; } ); }
                    w2popup.status = 'moving';
                    tmp.resizing = true;
                    tmp.x = evnt.screenX;
                    tmp.y = evnt.screenY;
                    tmp.pos_x = $('#w2ui-popup'+_id+'').position().left;
                    tmp.pos_y = $('#w2ui-popup'+_id+'').position().top;
                    w2popup.lock({ opacity: 0 });
                    $(document).on('mousemove', tmp.mvMove);
                    $(document).on('mouseup', tmp.mvStop);
                    if (evnt.stopPropagation) evnt.stopPropagation(); else evnt.cancelBubble = true;
                    if (evnt.preventDefault) evnt.preventDefault(); else return false;
                }

                function mvMove(evnt) {
                    if (tmp.resizing != true) return;
                    if (!evnt) evnt = window.event;
                    tmp.div_x = evnt.screenX - tmp.x;
                    tmp.div_y = evnt.screenY - tmp.y;
                    $('#w2ui-popup'+_id+'').css({
                        '-webkit-transition': 'none',
                        '-webkit-transform': 'translate3d('+ tmp.div_x +'px, '+ tmp.div_y +'px, 0px)',
                        '-moz-transition': 'none',
                        '-moz-transform': 'translate('+ tmp.div_x +'px, '+ tmp.div_y +'px)',
                        '-ms-transition': 'none',
                        '-ms-transform': 'translate('+ tmp.div_x +'px, '+ tmp.div_y +'px)',
                        '-o-transition': 'none',
                        '-o-transform': 'translate('+ tmp.div_x +'px, '+ tmp.div_y +'px)'
                    });
                }

                function mvStop(evnt) {
                    if (tmp.resizing != true) return;
                    if (!evnt) evnt = window.event;
                    w2popup.status = 'open';
                    tmp.div_x = (evnt.screenX - tmp.x);
                    tmp.div_y = (evnt.screenY - tmp.y);
                    $('#w2ui-popup'+_id+'').css({
                        'left': (tmp.pos_x + tmp.div_x) + 'px',
                        'top':    (tmp.pos_y  + tmp.div_y) + 'px',
                        '-webkit-transition': 'none',
                        '-webkit-transform': 'translate3d(0px, 0px, 0px)',
                        '-moz-transition': 'none',
                        '-moz-transform': 'translate(0px, 0px)',
                        '-ms-transition': 'none',
                        '-ms-transform': 'translate(0px, 0px)',
                        '-o-transition': 'none',
                        '-o-transform': 'translate(0px, 0px)'
                    });
                    tmp.resizing = false;
                    $(document).off('mousemove', tmp.mvMove);
                    $(document).off('mouseup', tmp.mvStop);
                    w2popup.unlock();
                }
                return this;
            },

            keydown: function (event) {
                var options = $('#w2ui-popup'+_id+'').data('options');
                if (!options.keyboard) return;
                // trigger event
                var eventData = w2popup.trigger({ phase: 'before', type: 'keydown', target: 'popup', options: options, originalEvent: event });
                if (eventData.isCancelled === true) return;
                // default behavior
                switch (event.keyCode) {
                    case 27:
                        event.preventDefault();
                        if ($('#w2ui-popup'+_id+' .w2ui-popup-message').length > 0) w2popup.message(); else w2popup.close();
                        break;
                }
                // event after
                w2popup.trigger($.extend(eventData, { phase: 'after'}));
            },

            close: function (options) {
                var obj = this;
                var options = $.extend({}, $('#w2ui-popup'+_id+'').data('options'), options);
                if ($('#w2ui-popup'+_id+'').length == 0) return;
                // trigger event
                var eventData = this.trigger({ phase: 'before', type: 'close', target: 'popup', options: options });
                if (eventData.isCancelled === true) return;
                // default behavior
                w2popup.status = 'closing';
                $('#w2ui-popup'+_id+'').css({
                    '-webkit-transition': options.speed + 's opacity, ' + options.speed + 's -webkit-transform',
                    '-webkit-transform': 'scale(0.9)',
                    '-moz-transition': options.speed + 's opacity, ' + options.speed + 's -moz-transform',
                    '-moz-transform': 'scale(0.9)',
                    '-ms-transition': options.speed + 's opacity, ' + options.speed + 's -ms-transform',
                    '-ms-transform': 'scale(0.9)',
                    '-o-transition': options.speed + 's opacity, ' + options.speed + 's -o-transform',
                    '-o-transform': 'scale(0.9)',
                    'opacity': '0'
                });
                setTimeout(function () {
                    $('#w2ui-popup'+_id+'').remove();
                    w2popup.status = 'closed';
                    // event after
                    obj.trigger($.extend(eventData, { phase: 'after'}));
                    w2popup.unlockScreen(options);
                }, options.speed * 1000);
                // restore active
                w2utils.keyboard.active(options._last_w2ui_name);
                // remove keyboard events
                if (options.keyboard) $(document).off('keydown', this.keydown);
            },

            toggle: function () {
                var obj     = this;
                var options = $('#w2ui-popup'+_id+'').data('options');
                // trigger event
                var eventData = this.trigger({ phase: 'before', type: 'toggle', target: 'popup', options: options });
                if (eventData.isCancelled === true) return;
                // defatul action
                if (options.maximized === true) w2popup.min(); else w2popup.max();
                // event after
                setTimeout(function () {
                    obj.trigger($.extend(eventData, { phase: 'after'}));
                }, (options.speed * 1000) + 50);
            },

            max: function () {
                var obj = this;
                var options = $('#w2ui-popup'+_id+'').data('options');
                if (options.maximized === true) return;
                // trigger event
                var eventData = this.trigger({ phase: 'before', type: 'max', target: 'popup', options: options });
                if (eventData.isCancelled === true) return;
                // default behavior
                w2popup.status   = 'resizing';
                options.prevSize = $('#w2ui-popup'+_id+'').css('width') + ':' + $('#w2ui-popup'+_id+'').css('height');
                // do resize
                w2popup.resize(10000, 10000, function () {
                    w2popup.status    = 'open';
                    options.maximized = true;
                    obj.trigger($.extend(eventData, { phase: 'after'}));
                });
            },

            min: function () {
                var obj = this;
                var options = $('#w2ui-popup'+_id+'').data('options');
                if (options.maximized !== true) return;
                var size = options.prevSize.split(':');
                // trigger event
                var eventData = this.trigger({ phase: 'before', type: 'min', target: 'popup', options: options });
                if (eventData.isCancelled === true) return;
                // default behavior
                w2popup.status = 'resizing';
                // do resize
                w2popup.resize(size[0], size[1], function () {
                    w2popup.status = 'open';
                    options.maximized = false;
                    options.prevSize  = null;
                    obj.trigger($.extend(eventData, { phase: 'after'}));
                });
            },

            get: function () {
                return $('#w2ui-popup'+_id+'').data('options');
            },

            set: function (options) {
                w2popup.open(options);
            },

            clear: function() {
                $('#w2ui-popup'+_id+' .w2ui-msg-title').html('');
                $('#w2ui-popup'+_id+' .w2ui-msg-body').html('');
                $('#w2ui-popup'+_id+' .w2ui-msg-buttons').html('');
            },

            reset: function () {
                w2popup.open(w2popup.defaults);
            },

            load: function (options) {
                w2popup.status = 'loading';
                if (String(options.url) == 'undefined') {
                    console.log('ERROR: The url parameter is empty.');
                    return;
                }
                var tmp = String(options.url).split('#');
                var url = tmp[0];
                var selector = tmp[1];
                if (String(options) == 'undefined') options = {};
                // load url
                var html = $('#w2ui-popup'+_id+'').data(url);
                if (typeof html != 'undefined' && html != null) {
                    popup(html, selector);
                } else {
                    $.get(url, function (data, status, obj) { // should always be $.get as it is template
                        popup(obj.responseText, selector);
                        $('#w2ui-popup'+_id+'').data(url, obj.responseText); // remember for possible future purposes
                    });
                }
                function popup(html, selector) {
                    delete options.url;
                    $('body').append('<div id="w2ui-tmp" style="display: none">' + html + '</div>');
                    if (typeof selector != 'undefined' && $('#w2ui-tmp #'+selector).length > 0) {
                        $('#w2ui-tmp #' + selector).w2popup(options);
                    } else {
                        $('#w2ui-tmp > div').w2popup(options);
                    }
                    // link styles
                    if ($('#w2ui-tmp > style').length > 0) {
                        var style = $('<div>').append($('#w2ui-tmp > style').clone()).html();
                        if ($('#w2ui-popup'+_id+' #div-style').length == 0) {
                            $('#w2ui-popup'+_id+'').append('<div id="div-style" style="position: absolute; left: -100px; width: 1px"></div>');
                        }
                        $('#w2ui-popup #div-style').html(style);
                    }
                    $('#w2ui-tmp').remove();
                }
            },

            message: function (options) {
                $().w2tag(); // hide all tags
                if (!options) options = { width: 200, height: 100 };
                if (parseInt(options.width) < 10)  options.width  = 10;
                if (parseInt(options.height) < 10) options.height = 10;
                if (typeof options.hideOnClick == 'undefined') options.hideOnClick = false;
                var poptions = $('#w2ui-popup'+_id+'').data('options') || {};
                if (typeof options.width == 'undefined' || options.width > poptions.width - 10) options.width = poptions.width - 10;
                if (typeof options.height == 'undefined' || options.height > poptions.height - 40) options.height = poptions.height - 40; // title is 30px or so

                var head     = $('#w2ui-popup'+_id+' .w2ui-msg-title');
                var pwidth   = parseInt($('#w2ui-popup'+_id+'').width());
                var msgCount = $('#w2ui-popup'+_id+' .w2ui-popup-message').length;
                // remove message
                if ($.trim(options.html) == '') {
                    $('#w2ui-popup'+_id+' #w2ui-message'+ (msgCount-1)).css('z-Index', 250);
                    var options = $('#w2ui-popup'+_id+' #w2ui-message'+ (msgCount-1)).data('options') || {};
                    $('#w2ui-popup'+_id+' #w2ui-message'+ (msgCount-1)).remove();
                    if (typeof options.onClose == 'function') options.onClose();
                    if (msgCount == 1) {
                        w2popup.unlock();
                    } else {
                        $('#w2ui-popup'+_id+' #w2ui-message'+ (msgCount-2)).show();
                    }
                } else {
                    // hide previous messages
                    $('#w2ui-popup'+_id+' .w2ui-popup-message').hide();
                    // add message
                    $('#w2ui-popup'+_id+' .w2ui-box1')
                        .before('<div id="w2ui-message' + msgCount + '" class="w2ui-popup-message" style="display: none; ' +
                                    (head.length == 0 ? 'top: 0px;' : 'top: ' + w2utils.getSize(head, 'height') + 'px;') +
                                    (typeof options.width  != 'undefined' ? 'width: ' + options.width + 'px; left: ' + ((pwidth - options.width) / 2) + 'px;' : 'left: 10px; right: 10px;') +
                                    (typeof options.height != 'undefined' ? 'height: ' + options.height + 'px;' : 'bottom: 6px;') +
                                    '-webkit-transition: .3s; -moz-transition: .3s; -ms-transition: .3s; -o-transition: .3s;"' +
                                    (options.hideOnClick === true ? 'onclick="w2popup.message();"' : '') + '>' +
                                '</div>');
                    $('#w2ui-popup'+_id+' #w2ui-message'+ msgCount).data('options', options);
                    var display = $('#w2ui-popup'+_id+' #w2ui-message'+ msgCount).css('display');
                    $('#w2ui-popup'+_id+' #w2ui-message'+ msgCount).css({
                        '-webkit-transform': (display == 'none' ? 'translateY(-' + options.height + 'px)' : 'translateY(0px)'),
                        '-moz-transform': (display == 'none' ? 'translateY(-' + options.height + 'px)' : 'translateY(0px)'),
                        '-ms-transform': (display == 'none' ? 'translateY(-' + options.height + 'px)' : 'translateY(0px)'),
                        '-o-transform': (display == 'none' ? 'translateY(-' + options.height + 'px)' : 'translateY(0px)')
                    });
                    if (display == 'none') {
                        $('#w2ui-popup'+_id+' #w2ui-message'+ msgCount).show().html(options.html);
                        // timer needs to animation
                        setTimeout(function () {
                            $('#w2ui-popup'+_id+' #w2ui-message'+ msgCount).css({
                                '-webkit-transform': (display == 'none' ? 'translateY(0px)' : 'translateY(-' + options.height + 'px)'),
                                '-moz-transform': (display == 'none' ? 'translateY(0px)' : 'translateY(-' + options.height + 'px)'),
                                '-ms-transform': (display == 'none' ? 'translateY(0px)' : 'translateY(-' + options.height + 'px)'),
                                '-o-transform': (display == 'none' ? 'translateY(0px)' : 'translateY(-' + options.height + 'px)')
                            });
                        }, 1);
                        // timer for lock
                        setTimeout(function() {
                            $('#w2ui-popup'+_id+' #w2ui-message'+ msgCount).css({
                                '-webkit-transition': '0s',    '-moz-transition': '0s', '-ms-transition': '0s', '-o-transition': '0s',
                                'z-Index': 1500
                            }); // has to be on top of lock
                            if (msgCount == 0) w2popup.lock();
                            if (typeof options.onOpen == 'function') options.onOpen();
                        }, 300);
                    }
                }
            },

            lock: function (msg, showSpinner) {
                var args = Array.prototype.slice.call(arguments, 0);
                args.unshift($('#w2ui-popup'+_id+''));
                w2utils.lock.apply(window, args);
            },

            unlock: function () {
                w2utils.unlock($('#w2ui-popup'+_id+''));
            },

            // --- INTERNAL FUNCTIONS

            lockScreen: function (options) {
                if ($('#w2ui-lock').length > 0) return false;
                if (typeof options == 'undefined') options = $('#w2ui-popup'+_id+'').data('options');
                if (typeof options == 'undefined') options = {};
                options = $.extend({}, w2popup.defaults, options);
                if (options.embed) {
                    options.opacity = 0;
                    w2uiAlertLock.embed = true;
                }
                // show element
                $('body').append('<div id="w2ui-lock" ' +
                    '    onmousewheel="if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true; if (event.preventDefault) event.preventDefault(); else return false;"'+
                    '    style="position: ' + (w2utils.engine == 'IE5' ? 'absolute' : 'fixed') + '; z-Index: 1200; left: 0px; top: 0px; ' +
                    '           padding: 0px; margin: 0px; background-color: ' + options.color + '; width: 100%; height: 100%; opacity: 0;"></div>');

                // show transparent lock
                $('body').append('<div id="w2ui-lock-transparent" ' +
                    '    style="position: ' + (w2utils.engine == 'IE5' ? 'absolute' : 'fixed') + '; z-Index: 1400; left: 0px; top: 0px; ' +
                    '           padding: 0px; margin: 0px; background-color: ' + options.color + '; width: 100%; height: 100%; opacity: 0;"></div>');
                // lock screen
                setTimeout(function () {
                    $('#w2ui-lock').css({
                        '-webkit-transition': options.speed + 's opacity',
                        '-moz-transition': options.speed + 's opacity',
                        '-ms-transition': options.speed + 's opacity',
                        '-o-transition': options.speed + 's opacity',
                        'opacity': options.opacity
                    });
                }, 1);
                // add events
                if (options.modal == true) {
                    $('#w2ui-lock-transparent').on('mousedown', function () {
                        if (options.opacity === 0) return;
                        $('#w2ui-lock').css({
                            '-webkit-transition': '.1s',
                            '-moz-transition': '.1s',
                            '-ms-transition': '.1s',
                            '-o-transition': '.1s',
                            'opacity': '0.2'
                        });
                        // if (window.getSelection) window.getSelection().removeAllRanges();
                    });
                    $('#w2ui-lock-transparent').on('mouseup', function () {
                        setTimeout(function () {
                            $('#w2ui-lock').css({
                                '-webkit-transition': '.1s',
                                '-moz-transition': '.1s',
                                '-ms-transition': '.1s',
                                '-o-transition': '.1s',
                                'opacity': options.opacity
                            });
                        }, 100);
                        // if (window.getSelection) window.getSelection().removeAllRanges();
                    });
                } else {
                    $('#w2ui-lock').on('mouseup', function () { w2popup.close(); });
                }
                return true;
            },

            unlockScreen: function (options) {
                if ($('.w2ui-popup').length > 0) return false;
                if ($('#w2ui-lock').length == 0) return false;
                if (typeof options == 'undefined') options = $('#w2ui-popup'+_id+'').data('options');
                if (typeof options == 'undefined') options = {};
                options = $.extend({}, w2popup.defaults, options);
                $('#w2ui-lock').css({
                    '-webkit-transition': options.speed + 's opacity',
                    '-moz-transition': options.speed + 's opacity',
                    '-ms-transition': options.speed + 's opacity',
                    '-o-transition': options.speed + 's opacity',
                    'opacity': 0
                });
                setTimeout(function () {
                    $('#w2ui-lock').remove();
                    $('#w2ui-lock-transparent').remove();
                }, options.speed * 1000);
                return true;
            },

            resize: function (width, height, callBack) {
                var options = $('#w2ui-popup'+_id+'').data('options');
                // calculate new position
                if (parseInt($(window).width())  - 10 < parseInt(width))  width  = parseInt($(window).width())  - 10;
                if (parseInt($(window).height()) - 10 < parseInt(height)) height = parseInt($(window).height()) - 10;
                var top  = ((parseInt($(window).height()) - parseInt(height)) / 2) * 0.8;
                var left = (parseInt($(window).width()) - parseInt(width)) / 2;
                // resize there
                if(bowser.mobile === true) {
                    width = "100%";
                    height = "100%";
                    left="0px";
                    top="0px";
                }


                $('#w2ui-popup'+_id+'').css({
                    '-webkit-transition': options.speed + 's width, ' + options.speed + 's height, ' + options.speed + 's left, ' + options.speed + 's top',
                    '-moz-transition': options.speed + 's width, ' + options.speed + 's height, ' + options.speed + 's left, ' + options.speed + 's top',
                    '-ms-transition': options.speed + 's width, ' + options.speed + 's height, ' + options.speed + 's left, ' + options.speed + 's top',
                    '-o-transition': options.speed + 's width, ' + options.speed + 's height, ' + options.speed + 's left, ' + options.speed + 's top',
                    'top': top,
                    'left': left,
                    'width': width,
                    'height': height
                });
                setTimeout(function () {
                    options.width  = width;
                    options.height = height;
                    if (typeof callBack == 'function') callBack();
                }, (options.speed * 1000) + 50); // give extra 50 ms
            },

            resizeInWindow: function(evt) {
                var options = $('#w2ui-popup'+_id+'').data('options');
                if(options === undefined || options == null) return;
                var width = options.width;
                var height = options.height;
                var top  = ((parseInt($(window).height()) - parseInt(height)) / 2) * 0.8;
                var left = (parseInt($(window).width()) - parseInt(width)) / 2;
                if(bowser.mobile === true) {
                    width = "100%";
                    height = "100%";
                    left="0px";
                    top="0px";
                }

                $('#w2ui-popup'+_id+'').css({
                    '-webkit-transition': options.speed + 's width, ' + options.speed + 's height, ' + options.speed + 's left, ' + options.speed + 's top',
                    '-moz-transition': options.speed + 's width, ' + options.speed + 's height, ' + options.speed + 's left, ' + options.speed + 's top',
                    '-ms-transition': options.speed + 's width, ' + options.speed + 's height, ' + options.speed + 's left, ' + options.speed + 's top',
                    '-o-transition': options.speed + 's width, ' + options.speed + 's height, ' + options.speed + 's left, ' + options.speed + 's top',
                    'top': top,
                    'left': left,
                    'width': width,
                    'height': height
                });

                setTimeout(function () {
                    options.width  = width;
                    options.height = height;
                }, (options.speed * 1000) + 50); // give extra 50 ms
            }
        }
        // merge in event handling
        $.extend(w2popup, w2utils.event);
        w2popup.open(options);
        GLOBAL['w2popup'+_id] = w2popup;
        if(true || isBindedResizeWindow == false) {
            if(window.addEventListener) window.addEventListener('resize', w2popup.resizeInWindow, false);
            if(window.attachEvent) window.attachEvent('onresize',w2popup.resizeInWindow);
            isBindedResizeWindow = true;
        }
        id++;
        return w2popup;
    }
    var isBindedResizeWindow = false;

})(window,jQuery);

// ============================================
// --- Common dialogs

var w2alert = function (msg, title, callBack) {
    if (title == null) title = w2utils.lang('Notification');
    if ($('#w2ui-popup').length > 0 && w2popup.status != 'closing') {
        w2popup.message({
            width   : 400,
            height  : 170,
            html    : '<div style="position: absolute; top: 0px; left: 0px; right: 0px; bottom: 45px; overflow: auto">' +
                      '        <div class="w2ui-centered" style="font-size: 13px;">' + msg + '</div>' +
                      '</div>' +
                      '<div style="position: absolute; bottom: 7px; left: 0px; right: 0px; text-align: center; padding: 5px">' +
                      '        <button onclick="w2popup.message();" class="w2ui-popup-btn btn">' + w2utils.lang('Ok') + '</button>' +
                      '</div>',
            onClose : function () {
                if (typeof callBack == 'function') callBack();
            }
        });
    } else {
        w2popup.open({
            width     : 450,
            height    : 220,
            showMax   : false,
            showClose : false,
            title     : title,
            body      : '<div class="w2ui-centered" style="font-size: 13px;">' + msg + '</div>',
            buttons   : '<button onclick="w2popup.close();" class="w2ui-popup-btn btn">' + w2utils.lang('Ok') + '</button>',
            onClose   : function () {
                if (typeof callBack == 'function') callBack();
            }
        });
    }
};

var w2confirm = function (msg, title, callBack) {
    var options  = {};
    var defaults = {
        msg         : '',
        title       : w2utils.lang('Confirmation'),
        width       : ($('#w2ui-popup').length > 0 ? 400 : 450),
        height      : ($('#w2ui-popup').length > 0 ? 170 : 220),
        yes_text    : 'Yes',
        yes_class   : '',
        yes_style   : '',
        yes_callBack: null,
        no_text     : 'No',
        no_class    : '',
        no_style    : '',
        no_callBack : null,
        callBack    : null
    };
    if (arguments.length == 1 && typeof msg == 'object') {
        $.extend(options, defaults, msg);
    } else {
        if (typeof title == 'function') {
            $.extend(options, defaults, {
                msg     : msg,
                callBack: title
            })
        } else {
            $.extend(options, defaults, {
                msg     : msg,
                title   : title,
                callBack: callBack
            })
        }
    }
    if ($('#w2ui-popup').length > 0 && w2popup.status != 'closing') {
        if (options.width > w2popup.get().width) options.width = w2popup.get().width;
        if (options.height > (w2popup.get().height - 50)) options.height = w2popup.get().height - 50;
          w2popup.message({
            width   : options.width,
            height  : options.height,
            html    : '<div style="position: absolute; top: 0px; left: 0px; right: 0px; bottom: 40px; overflow: auto">' +
                      '        <div class="w2ui-centered" style="font-size: 13px;">' + options.msg + '</div>' +
                      '</div>' +
                      '<div style="position: absolute; bottom: 7px; left: 0px; right: 0px; text-align: center; padding: 5px">' +
                      '        <button id="Yes" class="w2ui-popup-btn btn '+ options.yes_class +'" style="'+ options.yes_style +'">' + w2utils.lang(options.yes_text) + '</button>' +
                      '        <button id="No" class="w2ui-popup-btn btn '+ options.no_class +'" style="'+ options.no_style +'">' + w2utils.lang(options.no_text) + '</button>' +
                      '</div>',
            onOpen: function () {
                $('#w2ui-popup .w2ui-popup-message .btn').on('click', function (event) {
                    w2popup.message();
                    if (typeof options.callBack == 'function') options.callBack(event.target.id);
                    if (event.target.id == 'Yes' && typeof options.yes_callBack == 'function') options.yes_callBack();
                    if (event.target.id == 'No'  && typeof options.no_callBack == 'function') options.no_callBack();
                });
            },
            onKeydown: function (event) {
                switch (event.originalEvent.keyCode) {
                    case 13: // enter
                        if (typeof options.callBack == 'function') options.callBack('Yes');
                        if (typeof options.yes_callBack == 'function') options.yes_callBack();
                        w2popup.message();
                        break
                    case 27: // esc
                        if (typeof options.callBack == 'function') options.callBack('No');
                        if (typeof options.no_callBack == 'function') options.no_callBack();
                        w2popup.message();
                        break
                }
            }
        });

    } else {

        if (!w2utils.isInt(options.height)) options.height = options.height + 50;
        w2popup.open({
            width      : options.width,
            height     : options.height,
            title      : options.title,
            modal      : true,
            showClose  : false,
            body       : '<div class="w2ui-centered" style="font-size: 13px;">' + options.msg + '</div>',
            buttons    : '<button id="Yes" class="w2ui-popup-btn btn '+ options.yes_class +'" style="'+ options.yes_style +'">'+ w2utils.lang(options.yes_text) +'</button>'+
                         '<button id="No" class="w2ui-popup-btn btn '+ options.no_class +'" style="'+ options.no_style +'">'+ w2utils.lang(options.no_text) +'</button>',
            onOpen: function (event) {
                event.onComplete = function () {
                    $('#w2ui-popup .w2ui-popup-btn').on('click', function (event) {
                        w2popup.close();
                        if (typeof options.callBack == 'function') options.callBack(event.target.id);
                        if (event.target.id == 'Yes' && typeof options.yes_callBack == 'function') options.yes_callBack();
                        if (event.target.id == 'No'  && typeof options.no_callBack == 'function') options.no_callBack();
                    });
                }
            },
            onKeydown: function (event) {
                switch (event.originalEvent.keyCode) {
                    case 13: // enter
                        if (typeof options.callBack == 'function') options.callBack('Yes');
                        if (typeof options.yes_callBack == 'function') options.yes_callBack();
                        w2popup.close();
                        break
                    case 27: // esc
                        if (typeof options.callBack == 'function') options.callBack('No');
                        if (typeof options.no_callBack == 'function') options.no_callBack();
                        w2popup.close();
                        break
                }
            }
        });
    }

    return {
        yes: function (fun) {
            options.yes_callBack = fun;
            return this;
        },
        no: function (fun) {
            options.no_callBack = fun;
            return this;
        }
    };
};

var w2uiAlertLock= {
    embed : undefined,
    start : '<div id="w2ui-alert-lock" onmousewheel="if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true; if (event.preventDefault) event.preventDefault(); else return false;" style="position: fixed; z-index: 2000; left: 0px; top: 0px; padding: 0px; margin: 0px; width: 100%; height: 100%; -webkit-transition: 0.1s; transition: 0.1s; background-color: rgb(0, 0, 0);',
    end : '"></div>',

    tag: function() {
        var opacity = this.embed ? 0 : 0.4;
        return this.start + "opacity:" + opacity + this.end;
    }
};

function w2uiAlertLockShow() {
    if ($('#w2ui-alert-lock').length > 0) return false;

    $('body').append(w2uiAlertLock.tag());
}

function w2uiAlertLockHide() {
    $('#w2ui-alert-lock').remove();
}

function w2uiConfirm(title, message, done) {
    w2uiAlertLockShow();
    w2uiDialog(title, message, { confirm: true } , done);

}
function w2uiAlert(title, message, isError, done) {
    w2uiAlertLockShow();
    w2uiDialog(title, message, { alert: true, error: isError }, done);
}

function w2uiDialogClose(ok) {
    $('#w2ui-alert-dialog').remove();
    w2uiAlertLockHide();
    w2uiDialogClose.done(ok);
}

function w2uiDialog(title, message, option, done) {
    done = done || function() {};
    w2uiDialogClose.done = done;

    if (window.innerHeight == undefined) {
        var width  = document.documentElement.offsetWidth;
        var height = document.documentElement.offsetHeight;
        if (w2utils.engine === 'IE7') { width += 21; height += 4; }
    } else {
        var width  = window.innerWidth;
        var height = window.innerHeight;
    }

    //dialogWidth = Math.max(Math.floor(width * 0.21), 100);
    dialogWidth = 385;
    dialogLeft = Math.floor((width - dialogWidth) / 2);
    if (w2uiAlertLock.embed) {
        dialogTop = Math.floor(height * 0.15);
    } else {
        dialogTop = Math.floor(height * 0.3);
    }
    message = message || "메시지 없음";
    message = message.replace(/\n/g, '<br/>');

    var alertDialog =
        '<div id="w2ui-alert-dialog" role="alertdialog" aria-labelledby="alertDialogTitle" class="w2ui-popup" style="z-index:2400; opacity: 1; margin:auto; ' + ' top:' + dialogTop + 'px; ' + '">' +
    '   <div class="w2ui-alert-dialog-title" style="text-align:center"><span id="alertDialogTitle">'+ title + '</span></div>' +
    '   <div class="w2ui-alert-dialog-title-bar"><span></div>' +
    '   <div class="w2ui-alert-dialog-body-block" role="document">'+
    '       <div class="'+ (option.isError ? 'w2ui-alert-icon-error' : 'w2ui-alert-icon-alert') + '" ' +
                'alt="'+ (option.isError ? '에러' : '경고') + '"></div>' +
    '       <p>' + message + '</p>'+
    '   </div>' +
    '   <div class="w2ui-alert-dialog-buttons">' +
        (option.alert? '<button onclick="w2uiDialogClose(true); return false;" tabindex="100">'+ PINsignResource.get('w2uiAlert.okStr') +'</button>' :
                    '<button onclick="w2uiDialogClose(false); return false;" tabindex="101">' + PINsignResource.get('w2uiAlert.noStr')  + '</button><button onclick="w2uiDialogClose(true); return false;" tabindex="100">' + PINsignResource.get('w2uiAlert.yesStr') + '</button>') +

    '   </div>' +
    '</div>';
    $('body').append(alertDialog);
    setTimeout(function() {
        $('#w2ui-alert-dialog button').focus();
    });
}


window.w2uiAlertLock = window.w2uiAlertLock || w2uiAlertLock;
window.w2uiAlertLockShow = window.w2uiAlertLockShow || w2uiAlertLockShow;
window.w2uiAlertLockHide = window.w2uiAlertLockHide || w2uiAlertLockHide;
window.w2uiConfirm = window.w2uiConfirm || w2uiConfirm;
window.w2uiAlert = window.w2uiAlert || w2uiAlert;
window.w2uiDialogClose = window.w2uiDialogClose || w2uiDialogClose;
window.w2uiDialog = window.w2uiDialog || w2uiDialog;
(function(){var isLoader="function"==typeof define&&define.amd,objectTypes={"function":!0,object:!0},freeExports=objectTypes[typeof exports]&&exports&&!exports.nodeType&&exports,root=objectTypes[typeof window]&&window||this,freeGlobal=freeExports&&objectTypes[typeof module]&&module&&!module.nodeType&&"object"==typeof global&&global;function runInContext(context,exports){context||(context=root.Object()),exports||(exports=root.Object());var Number=context.Number||root.Number,String=context.String||root.String,Object=context.Object||root.Object,Date=context.Date||root.Date,SyntaxError=context.SyntaxError||root.SyntaxError,TypeError=context.TypeError||root.TypeError,Math=context.Math||root.Math,nativeJSON=context.JSON||root.JSON;"object"==typeof nativeJSON&&nativeJSON&&(exports.stringify=nativeJSON.stringify,exports.parse=nativeJSON.parse);var isProperty,forEach,undef,objectProto=Object.prototype,getClass=objectProto.toString,isExtended=new Date(-0xc782b5b800cec);try{isExtended=-109252==isExtended.getUTCFullYear()&&0===isExtended.getUTCMonth()&&1===isExtended.getUTCDate()&&10==isExtended.getUTCHours()&&37==isExtended.getUTCMinutes()&&6==isExtended.getUTCSeconds()&&708==isExtended.getUTCMilliseconds()}catch(exception){}function has(name){if(has[name]!==undef)return has[name];var isSupported;if("bug-string-char-index"==name)isSupported="a"!="a"[0];else if("json"==name)isSupported=has("json-stringify")&&has("json-parse");else{var value,serialized='{"a":[1,true,false,null,"\\u0000\\b\\n\\f\\r\\t"]}';if("json-stringify"==name){var stringify=exports.stringify,stringifySupported="function"==typeof stringify&&isExtended;if(stringifySupported){(value=function(){return 1}).toJSON=value;try{stringifySupported="0"===stringify(0)&&"0"===stringify(new Number)&&'""'==stringify(new String)&&stringify(getClass)===undef&&stringify(undef)===undef&&stringify()===undef&&"1"===stringify(value)&&"[1]"==stringify([value])&&"[null]"==stringify([undef])&&"null"==stringify(null)&&"[null,null,null]"==stringify([undef,getClass,null])&&stringify({a:[value,!0,!1,null,"\0\b\n\f\r\t"]})==serialized&&"1"===stringify(null,value)&&"[\n 1,\n 2\n]"==stringify([1,2],null,1)&&'"-271821-04-20T00:00:00.000Z"'==stringify(new Date(-864e13))&&'"+275760-09-13T00:00:00.000Z"'==stringify(new Date(864e13))&&'"-000001-01-01T00:00:00.000Z"'==stringify(new Date(-621987552e5))&&'"1969-12-31T23:59:59.999Z"'==stringify(new Date(-1))}catch(exception){stringifySupported=!1}}isSupported=stringifySupported}if("json-parse"==name){var parse=exports.parse;if("function"==typeof parse)try{if(0===parse("0")&&!parse(!1)){var parseSupported=5==(value=parse(serialized)).a.length&&1===value.a[0];if(parseSupported){try{parseSupported=!parse('"\t"')}catch(exception){}if(parseSupported)try{parseSupported=1!==parse("01")}catch(exception){}if(parseSupported)try{parseSupported=1!==parse("1.")}catch(exception){}}}}catch(exception){parseSupported=!1}isSupported=parseSupported}}return has[name]=!!isSupported}if(!has("json")){var charIndexBuggy=has("bug-string-char-index");if(!isExtended)var floor=Math.floor,Months=[0,31,59,90,120,151,181,212,243,273,304,334],getDay=function(year,month){return Months[month]+365*(year-1970)+floor((year-1969+(month=+(1<month)))/4)-floor((year-1901+month)/100)+floor((year-1601+month)/400)};if((isProperty=objectProto.hasOwnProperty)||(isProperty=function(property){var constructor,members={};return isProperty=(members.__proto__=null,members.__proto__={toString:1},members).toString!=getClass?function(property){var original=this.__proto__,result=property in(this.__proto__=null,this);return this.__proto__=original,result}:(constructor=members.constructor,function(property){var parent=(this.constructor||constructor).prototype;return property in this&&!(property in parent&&this[property]===parent[property])}),members=null,isProperty.call(this,property)}),forEach=function(object,callback){var Properties,members,property,size=0;for(property in(Properties=function(){this.valueOf=0}).prototype.valueOf=0,members=new Properties)isProperty.call(members,property)&&size++;return Properties=members=null,(forEach=size?2==size?function(object,callback){var property,members={},isFunction="[object Function]"==getClass.call(object);for(property in object)isFunction&&"prototype"==property||isProperty.call(members,property)||!(members[property]=1)||!isProperty.call(object,property)||callback(property)}:function(object,callback){var property,isConstructor,isFunction="[object Function]"==getClass.call(object);for(property in object)isFunction&&"prototype"==property||!isProperty.call(object,property)||(isConstructor="constructor"===property)||callback(property);(isConstructor||isProperty.call(object,property="constructor"))&&callback(property)}:(members=["valueOf","toString","toLocaleString","propertyIsEnumerable","isPrototypeOf","hasOwnProperty","constructor"],function(object,callback){var property,length,isFunction="[object Function]"==getClass.call(object),hasProperty=!isFunction&&"function"!=typeof object.constructor&&objectTypes[typeof object.hasOwnProperty]&&object.hasOwnProperty||isProperty;for(property in object)isFunction&&"prototype"==property||!hasProperty.call(object,property)||callback(property);for(length=members.length;property=members[--length];hasProperty.call(object,property)&&callback(property));}))(object,callback)},!has("json-stringify")){var Escapes={92:"\\\\",34:'\\"',8:"\\b",12:"\\f",10:"\\n",13:"\\r",9:"\\t"},toPaddedString=function(width,value){return("000000"+(value||0)).slice(-width)},quote=function(value){for(var result='"',index=0,length=value.length,useCharIndex=!charIndexBuggy||10<length,symbols=useCharIndex&&(charIndexBuggy?value.split(""):value);index<length;index++){var charCode=value.charCodeAt(index);switch(charCode){case 8:case 9:case 10:case 12:case 13:case 34:case 92:result+=Escapes[charCode];break;default:if(charCode<32){result+="\\u00"+toPaddedString(2,charCode.toString(16));break}result+=useCharIndex?symbols[index]:value.charAt(index)}}return result+'"'},serialize=function(property,object,callback,properties,whitespace,indentation,stack){var value,className,year,month,date,time,hours,minutes,seconds,milliseconds,results,element,index,length,prefix,result;try{value=object[property]}catch(exception){}if("object"==typeof value&&value)if("[object Date]"!=(className=getClass.call(value))||isProperty.call(value,"toJSON"))"function"==typeof value.toJSON&&("[object Number]"!=className&&"[object String]"!=className&&"[object Array]"!=className||isProperty.call(value,"toJSON"))&&(value=value.toJSON(property));else if(-1/0<value&&value<1/0){if(getDay){for(date=floor(value/864e5),year=floor(date/365.2425)+1970-1;getDay(year+1,0)<=date;year++);for(month=floor((date-getDay(year,0))/30.42);getDay(year,month+1)<=date;month++);date=1+date-getDay(year,month),hours=floor((time=(value%864e5+864e5)%864e5)/36e5)%24,minutes=floor(time/6e4)%60,seconds=floor(time/1e3)%60,milliseconds=time%1e3}else year=value.getUTCFullYear(),month=value.getUTCMonth(),date=value.getUTCDate(),hours=value.getUTCHours(),minutes=value.getUTCMinutes(),seconds=value.getUTCSeconds(),milliseconds=value.getUTCMilliseconds();value=(year<=0||1e4<=year?(year<0?"-":"+")+toPaddedString(6,year<0?-year:year):toPaddedString(4,year))+"-"+toPaddedString(2,month+1)+"-"+toPaddedString(2,date)+"T"+toPaddedString(2,hours)+":"+toPaddedString(2,minutes)+":"+toPaddedString(2,seconds)+"."+toPaddedString(3,milliseconds)+"Z"}else value=null;if(callback&&(value=callback.call(object,property,value)),null===value)return"null";if("[object Boolean]"==(className=getClass.call(value)))return""+value;if("[object Number]"==className)return-1/0<value&&value<1/0?""+value:"null";if("[object String]"==className)return quote(""+value);if("object"==typeof value){for(length=stack.length;length--;)if(stack[length]===value)throw TypeError();if(stack.push(value),results=[],prefix=indentation,indentation+=whitespace,"[object Array]"==className){for(index=0,length=value.length;index<length;index++)element=serialize(index,value,callback,properties,whitespace,indentation,stack),results.push(element===undef?"null":element);result=results.length?whitespace?"[\n"+indentation+results.join(",\n"+indentation)+"\n"+prefix+"]":"["+results.join(",")+"]":"[]"}else forEach(properties||value,function(property){var element=serialize(property,value,callback,properties,whitespace,indentation,stack);element!==undef&&results.push(quote(property)+":"+(whitespace?" ":"")+element)}),result=results.length?whitespace?"{\n"+indentation+results.join(",\n"+indentation)+"\n"+prefix+"}":"{"+results.join(",")+"}":"{}";return stack.pop(),result}};exports.stringify=function(source,filter,width){var whitespace,callback,properties,className;if(objectTypes[typeof filter]&&filter)if("[object Function]"==(className=getClass.call(filter)))callback=filter;else if("[object Array]"==className){properties={};for(var value,index=0,length=filter.length;index<length;value=filter[index++],("[object String]"==(className=getClass.call(value))||"[object Number]"==className)&&(properties[value]=1));}if(width)if("[object Number]"==(className=getClass.call(width))){if(0<(width-=width%1))for(whitespace="",10<width&&(width=10);whitespace.length<width;whitespace+=" ");}else"[object String]"==className&&(whitespace=width.length<=10?width:width.slice(0,10));return serialize("",((value={})[""]=source,value),callback,properties,whitespace,"",[])}}if(!has("json-parse")){var Index,Source,fromCharCode=String.fromCharCode,Unescapes={92:"\\",34:'"',47:"/",98:"\b",116:"\t",110:"\n",102:"\f",114:"\r"},abort=function(){throw Index=Source=null,SyntaxError()},lex=function(){for(var value,begin,position,isSigned,charCode,source=Source,length=source.length;Index<length;)switch(charCode=source.charCodeAt(Index)){case 0:case 9:case 10:case 13:case 32:Index++;break;case 123:case 125:case 91:case 93:case 58:case 44:return value=charIndexBuggy?source.charAt(Index):source[Index],Index++,value;case 34:for(value="@",Index++;Index<length;)if((charCode=source.charCodeAt(Index))<32)abort();else if(92==charCode)switch(charCode=source.charCodeAt(++Index)){case 92:case 34:case 47:case 98:case 116:case 110:case 102:case 114:value+=Unescapes[charCode],Index++;break;case 117:for(begin=++Index,position=Index+4;Index<position;Index++)48<=(charCode=source.charCodeAt(Index))&&charCode<=57||97<=charCode&&charCode<=102||65<=charCode&&charCode<=70||abort();value+=fromCharCode("0x"+source.slice(begin,Index));break;default:abort()}else{if(34==charCode)break;for(charCode=source.charCodeAt(Index),begin=Index;32<=charCode&&92!=charCode&&34!=charCode;)charCode=source.charCodeAt(++Index);value+=source.slice(begin,Index)}if(34==source.charCodeAt(Index))return Index++,value;abort();default:if(begin=Index,45==charCode&&(isSigned=!0,charCode=source.charCodeAt(++Index)),48<=charCode&&charCode<=57){for(48==charCode&&(48<=(charCode=source.charCodeAt(Index+1))&&charCode<=57)&&abort(),isSigned=!1;Index<length&&(48<=(charCode=source.charCodeAt(Index))&&charCode<=57);Index++);if(46==source.charCodeAt(Index)){for(position=++Index;position<length&&(48<=(charCode=source.charCodeAt(position))&&charCode<=57);position++);position==Index&&abort(),Index=position}if(101==(charCode=source.charCodeAt(Index))||69==charCode){for(43!=(charCode=source.charCodeAt(++Index))&&45!=charCode||Index++,position=Index;position<length&&(48<=(charCode=source.charCodeAt(position))&&charCode<=57);position++);position==Index&&abort(),Index=position}return+source.slice(begin,Index)}if(isSigned&&abort(),"true"==source.slice(Index,Index+4))return Index+=4,!0;if("false"==source.slice(Index,Index+5))return Index+=5,!1;if("null"==source.slice(Index,Index+4))return Index+=4,null;abort()}return"$"},get=function(value){var results,hasMembers;if("$"==value&&abort(),"string"==typeof value){if("@"==(charIndexBuggy?value.charAt(0):value[0]))return value.slice(1);if("["==value){for(results=[];"]"!=(value=lex());hasMembers||(hasMembers=!0))hasMembers&&(","==value?"]"==(value=lex())&&abort():abort()),","==value&&abort(),results.push(get(value));return results}if("{"==value){for(results={};"}"!=(value=lex());hasMembers||(hasMembers=!0))hasMembers&&(","==value?"}"==(value=lex())&&abort():abort()),","!=value&&"string"==typeof value&&"@"==(charIndexBuggy?value.charAt(0):value[0])&&":"==lex()||abort(),results[value.slice(1)]=get(lex());return results}abort()}return value},update=function(source,property,callback){var element=walk(source,property,callback);element===undef?delete source[property]:source[property]=element},walk=function(source,property,callback){var length,value=source[property];if("object"==typeof value&&value)if("[object Array]"==getClass.call(value))for(length=value.length;length--;)update(value,length,callback);else forEach(value,function(property){update(value,property,callback)});return callback.call(source,property,value)};exports.parse=function(source,callback){var result,value;return Index=0,Source=""+source,result=get(lex()),"$"!=lex()&&abort(),Index=Source=null,callback&&"[object Function]"==getClass.call(callback)?walk(((value={})[""]=result,value),"",callback):result}}}return exports.runInContext=runInContext,exports}if(!freeGlobal||freeGlobal.global!==freeGlobal&&freeGlobal.window!==freeGlobal&&freeGlobal.self!==freeGlobal||(root=freeGlobal),freeExports&&!isLoader)runInContext(root,freeExports);else{var nativeJSON=root.JSON,previousJSON=root.JSON3,isRestored=!1,JSON3=runInContext(root,root.JSON3={noConflict:function(){return isRestored||(isRestored=!0,root.JSON=nativeJSON,root.JSON3=previousJSON,nativeJSON=previousJSON=null),JSON3}});root.JSON={parse:JSON3.parse,stringify:JSON3.stringify}}isLoader&&define(function(){return JSON3})}).call(this),function(global){"use strict";var MAX_ARRAY_LENGTH=1e5;function Type(v){switch(typeof v){case"undefined":return"undefined";case"boolean":return"boolean";case"number":return"number";case"string":return"string";default:return null===v?"null":"object"}}function Class(v){return Object.prototype.toString.call(v).replace(/^\[object *|\]$/g,"")}function IsCallable(o){return"function"==typeof o}function ToObject(v){if(null==v)throw TypeError();return Object(v)}function ToInt32(v){return v>>0}function ToUint32(v){return v>>>0}var orig,dom_only,LN2=Math.LN2,abs=Math.abs,floor=Math.floor,log=Math.log,max=Math.max,min=Math.min,pow=Math.pow,round=Math.round;function as_signed(value,bits){var s=32-bits;return value<<s>>s}function as_unsigned(value,bits){var s=32-bits;return value<<s>>>s}function packI8(n){return[255&n]}function unpackI8(bytes){return as_signed(bytes[0],8)}function packU8(n){return[255&n]}function unpackU8(bytes){return as_unsigned(bytes[0],8)}function packU8Clamped(n){return[(n=round(Number(n)))<0?0:255<n?255:255&n]}function packI16(n){return[255&n,n>>8&255]}function unpackI16(bytes){return as_signed(bytes[1]<<8|bytes[0],16)}function packU16(n){return[255&n,n>>8&255]}function unpackU16(bytes){return as_unsigned(bytes[1]<<8|bytes[0],16)}function packI32(n){return[255&n,n>>8&255,n>>16&255,n>>24&255]}function unpackI32(bytes){return as_signed(bytes[3]<<24|bytes[2]<<16|bytes[1]<<8|bytes[0],32)}function packU32(n){return[255&n,n>>8&255,n>>16&255,n>>24&255]}function unpackU32(bytes){return as_unsigned(bytes[3]<<24|bytes[2]<<16|bytes[1]<<8|bytes[0],32)}function packIEEE754(v,ebits,fbits){var s,e,f,bias=(1<<ebits-1)-1;function roundToEven(n){var w=floor(n),f=n-w;return f<.5?w:.5<f?w+1:w%2?w+1:w}if(v!=v)e=(1<<ebits)-1,f=pow(2,fbits-1),s=0;else if(v===Infinity||v===-Infinity)e=(1<<ebits)-1,s=v<(f=0)?1:0;else if(0===v)f=e=0,s=1/v==-Infinity?1:0;else if(s=v<0,(v=abs(v))>=pow(2,1-bias)){e=min(floor(log(v)/LN2),1023);var significand=v/pow(2,e);significand<1&&(e-=1,significand*=2),2<=significand&&(e+=1,significand/=2);var d=pow(2,fbits);e+=bias,1<=(f=roundToEven(significand*d)-d)/d&&(e+=1,f=0),2*bias<e&&(e=(1<<ebits)-1,f=0)}else e=0,f=roundToEven(v/pow(2,1-bias-fbits));var i,bits=[];for(i=fbits;i;i-=1)bits.push(f%2?1:0),f=floor(f/2);for(i=ebits;i;i-=1)bits.push(e%2?1:0),e=floor(e/2);bits.push(s?1:0),bits.reverse();for(var str=bits.join(""),bytes=[];str.length;)bytes.unshift(parseInt(str.substring(0,8),2)),str=str.substring(8);return bytes}function unpackIEEE754(bytes,ebits,fbits){var i,j,b,str,bias,s,e,f,bits=[];for(i=0;i<bytes.length;++i)for(b=bytes[i],j=8;j;j-=1)bits.push(b%2?1:0),b>>=1;return bits.reverse(),str=bits.join(""),bias=(1<<ebits-1)-1,s=parseInt(str.substring(0,1),2)?-1:1,e=parseInt(str.substring(1,1+ebits),2),f=parseInt(str.substring(1+ebits),2),e===(1<<ebits)-1?0!==f?NaN:s*Infinity:0<e?s*pow(2,e-bias)*(1+f/pow(2,fbits)):0!==f?s*pow(2,-(bias-1))*(f/pow(2,fbits)):s<0?-0:0}function unpackF64(b){return unpackIEEE754(b,11,52)}function packF64(v){return packIEEE754(v,11,52)}function unpackF32(b){return unpackIEEE754(b,8,23)}function packF32(v){return packIEEE754(v,8,23)}orig=Object.defineProperty,dom_only=!function(){try{return Object.defineProperty({},"x",{})}catch(_){return!1}}(),orig&&!dom_only||(Object.defineProperty=function(o,prop,desc){if(orig)try{return orig(o,prop,desc)}catch(_){}if(o!==Object(o))throw TypeError("Object.defineProperty called on non-object");return Object.prototype.__defineGetter__&&"get"in desc&&Object.prototype.__defineGetter__.call(o,prop,desc.get),Object.prototype.__defineSetter__&&"set"in desc&&Object.prototype.__defineSetter__.call(o,prop,desc.set),"value"in desc&&(o[prop]=desc.value),o}),function(){function ArrayBuffer(length){if((length=ToInt32(length))<0)throw RangeError("ArrayBuffer size is not a small enough positive integer.");Object.defineProperty(this,"byteLength",{value:length}),Object.defineProperty(this,"_bytes",{value:Array(length)});for(var i=0;i<length;i+=1)this._bytes[i]=0}function $TypedArray$(){if(!arguments.length||"object"!=typeof arguments[0])return function(length){if((length=ToInt32(length))<0)throw RangeError("length is not a small enough positive integer.");Object.defineProperty(this,"length",{value:length}),Object.defineProperty(this,"byteLength",{value:length*this.BYTES_PER_ELEMENT}),Object.defineProperty(this,"buffer",{value:new ArrayBuffer(this.byteLength)}),Object.defineProperty(this,"byteOffset",{value:0})}.apply(this,arguments);if(1<=arguments.length&&"object"===Type(arguments[0])&&arguments[0]instanceof $TypedArray$)return function(typedArray){if(this.constructor!==typedArray.constructor)throw TypeError();var byteLength=typedArray.length*this.BYTES_PER_ELEMENT;Object.defineProperty(this,"buffer",{value:new ArrayBuffer(byteLength)}),Object.defineProperty(this,"byteLength",{value:byteLength}),Object.defineProperty(this,"byteOffset",{value:0}),Object.defineProperty(this,"length",{value:typedArray.length});for(var i=0;i<this.length;i+=1)this._setter(i,typedArray._getter(i))}.apply(this,arguments);if(1<=arguments.length&&"object"===Type(arguments[0])&&!(arguments[0]instanceof $TypedArray$)&&!(arguments[0]instanceof ArrayBuffer||"ArrayBuffer"===Class(arguments[0])))return function(array){var byteLength=array.length*this.BYTES_PER_ELEMENT;Object.defineProperty(this,"buffer",{value:new ArrayBuffer(byteLength)}),Object.defineProperty(this,"byteLength",{value:byteLength}),Object.defineProperty(this,"byteOffset",{value:0}),Object.defineProperty(this,"length",{value:array.length});for(var i=0;i<this.length;i+=1){var s=array[i];this._setter(i,Number(s))}}.apply(this,arguments);if(1<=arguments.length&&"object"===Type(arguments[0])&&(arguments[0]instanceof ArrayBuffer||"ArrayBuffer"===Class(arguments[0])))return function(buffer,byteOffset,length){if((byteOffset=ToUint32(byteOffset))>buffer.byteLength)throw RangeError("byteOffset out of range");if(byteOffset%this.BYTES_PER_ELEMENT)throw RangeError("buffer length minus the byteOffset is not a multiple of the element size.");if(void 0===length){var byteLength=buffer.byteLength-byteOffset;if(byteLength%this.BYTES_PER_ELEMENT)throw RangeError("length of buffer minus byteOffset not a multiple of the element size");length=byteLength/this.BYTES_PER_ELEMENT}else byteLength=(length=ToUint32(length))*this.BYTES_PER_ELEMENT;if(byteOffset+byteLength>buffer.byteLength)throw RangeError("byteOffset and length reference an area beyond the end of the buffer");Object.defineProperty(this,"buffer",{value:buffer}),Object.defineProperty(this,"byteLength",{value:byteLength}),Object.defineProperty(this,"byteOffset",{value:byteOffset}),Object.defineProperty(this,"length",{value:length})}.apply(this,arguments);throw TypeError()}global.ArrayBuffer=global.ArrayBuffer||ArrayBuffer,Object.defineProperty($TypedArray$,"from",{value:function(iterable){return new this(iterable)}}),Object.defineProperty($TypedArray$,"of",{value:function(){return new this(arguments)}});var $TypedArrayPrototype$={};function makeTypedArray(elementSize,pack,unpack){var TypedArray=function(){Object.defineProperty(this,"constructor",{value:TypedArray}),$TypedArray$.apply(this,arguments),function makeArrayAccessors(obj){if(!("TYPED_ARRAY_POLYFILL_NO_ARRAY_ACCESSORS"in global)){if(obj.length>MAX_ARRAY_LENGTH)throw RangeError("Array too large for polyfill");var i;for(i=0;i<obj.length;i+=1)makeArrayAccessor(i)}function makeArrayAccessor(index){Object.defineProperty(obj,index,{get:function(){return obj._getter(index)},set:function(v){obj._setter(index,v)},enumerable:!0,configurable:!1})}}(this)};"__proto__"in TypedArray?TypedArray.__proto__=$TypedArray$:(TypedArray.from=$TypedArray$.from,TypedArray.of=$TypedArray$.of),TypedArray.BYTES_PER_ELEMENT=elementSize;var TypedArrayPrototype=function(){};return TypedArrayPrototype.prototype=$TypedArrayPrototype$,TypedArray.prototype=new TypedArrayPrototype,Object.defineProperty(TypedArray.prototype,"BYTES_PER_ELEMENT",{value:elementSize}),Object.defineProperty(TypedArray.prototype,"_pack",{value:pack}),Object.defineProperty(TypedArray.prototype,"_unpack",{value:unpack}),TypedArray}$TypedArray$.prototype=$TypedArrayPrototype$,Object.defineProperty($TypedArray$.prototype,"_getter",{value:function(index){if(arguments.length<1)throw SyntaxError("Not enough arguments");if(!((index=ToUint32(index))>=this.length)){var i,o,bytes=[];for(i=0,o=this.byteOffset+index*this.BYTES_PER_ELEMENT;i<this.BYTES_PER_ELEMENT;i+=1,o+=1)bytes.push(this.buffer._bytes[o]);return this._unpack(bytes)}}}),Object.defineProperty($TypedArray$.prototype,"get",{value:$TypedArray$.prototype._getter}),Object.defineProperty($TypedArray$.prototype,"_setter",{value:function(index,value){if(arguments.length<2)throw SyntaxError("Not enough arguments");if(!((index=ToUint32(index))>=this.length)){var i,o,bytes=this._pack(value);for(i=0,o=this.byteOffset+index*this.BYTES_PER_ELEMENT;i<this.BYTES_PER_ELEMENT;i+=1,o+=1)this.buffer._bytes[o]=bytes[i]}}}),Object.defineProperty($TypedArray$.prototype,"constructor",{value:$TypedArray$}),Object.defineProperty($TypedArray$.prototype,"copyWithin",{value:function(target,start){var end=arguments[2],o=ToObject(this),len=ToUint32(o.length);len=max(len,0);var to,relativeTarget=ToInt32(target);to=relativeTarget<0?max(len+relativeTarget,0):min(relativeTarget,len);var from,relativeEnd,vfinal,relativeStart=ToInt32(start);from=relativeStart<0?max(len+relativeStart,0):min(relativeStart,len),vfinal=(relativeEnd=void 0===end?len:ToInt32(end))<0?max(len+relativeEnd,0):min(relativeEnd,len);var direction,count=min(vfinal-from,len-to);for(from<to&&to<from+count?(direction=-1,from=from+count-1,to=to+count-1):direction=1;0<count;)o._setter(to,o._getter(from)),from+=direction,to+=direction,count-=1;return o}}),Object.defineProperty($TypedArray$.prototype,"every",{value:function(callbackfn){if(null==this)throw TypeError();var t=Object(this),len=ToUint32(t.length);if(!IsCallable(callbackfn))throw TypeError();for(var thisArg=arguments[1],i=0;i<len;i++)if(!callbackfn.call(thisArg,t._getter(i),i,t))return!1;return!0}}),Object.defineProperty($TypedArray$.prototype,"fill",{value:function(value){var start=arguments[1],end=arguments[2],o=ToObject(this),len=ToUint32(o.length);len=max(len,0);var k,relativeEnd,vfinal,relativeStart=ToInt32(start);for(k=relativeStart<0?max(len+relativeStart,0):min(relativeStart,len),vfinal=(relativeEnd=void 0===end?len:ToInt32(end))<0?max(len+relativeEnd,0):min(relativeEnd,len);k<vfinal;)o._setter(k,value),k+=1;return o}}),Object.defineProperty($TypedArray$.prototype,"filter",{value:function(callbackfn){if(null==this)throw TypeError();var t=Object(this),len=ToUint32(t.length);if(!IsCallable(callbackfn))throw TypeError();for(var res=[],thisp=arguments[1],i=0;i<len;i++){var val=t._getter(i);callbackfn.call(thisp,val,i,t)&&res.push(val)}return new this.constructor(res)}}),Object.defineProperty($TypedArray$.prototype,"find",{value:function(predicate){var o=ToObject(this),len=ToUint32(o.length);if(!IsCallable(predicate))throw TypeError();for(var t=1<arguments.length?arguments[1]:void 0,k=0;k<len;){var kValue=o._getter(k),testResult=predicate.call(t,kValue,k,o);if(Boolean(testResult))return kValue;++k}}}),Object.defineProperty($TypedArray$.prototype,"findIndex",{value:function(predicate){var o=ToObject(this),len=ToUint32(o.length);if(!IsCallable(predicate))throw TypeError();for(var t=1<arguments.length?arguments[1]:void 0,k=0;k<len;){var kValue=o._getter(k),testResult=predicate.call(t,kValue,k,o);if(Boolean(testResult))return k;++k}return-1}}),Object.defineProperty($TypedArray$.prototype,"forEach",{value:function(callbackfn){if(null==this)throw TypeError();var t=Object(this),len=ToUint32(t.length);if(!IsCallable(callbackfn))throw TypeError();for(var thisp=arguments[1],i=0;i<len;i++)callbackfn.call(thisp,t._getter(i),i,t)}}),Object.defineProperty($TypedArray$.prototype,"indexOf",{value:function(searchElement){if(null==this)throw TypeError();var t=Object(this),len=ToUint32(t.length);if(0===len)return-1;var n=0;if(0<arguments.length&&((n=Number(arguments[1]))!=n?n=0:0!==n&&n!==1/0&&n!==-1/0&&(n=(0<n||-1)*floor(abs(n)))),len<=n)return-1;for(var k=0<=n?n:max(len-abs(n),0);k<len;k++)if(t._getter(k)===searchElement)return k;return-1}}),Object.defineProperty($TypedArray$.prototype,"join",{value:function(separator){if(null==this)throw TypeError();for(var t=Object(this),len=ToUint32(t.length),tmp=Array(len),i=0;i<len;++i)tmp[i]=t._getter(i);return tmp.join(void 0===separator?",":separator)}}),Object.defineProperty($TypedArray$.prototype,"lastIndexOf",{value:function(searchElement){if(null==this)throw TypeError();var t=Object(this),len=ToUint32(t.length);if(0===len)return-1;var n=len;1<arguments.length&&((n=Number(arguments[1]))!=n?n=0:0!==n&&n!==1/0&&n!==-1/0&&(n=(0<n||-1)*floor(abs(n))));for(var k=0<=n?min(n,len-1):len-abs(n);0<=k;k--)if(t._getter(k)===searchElement)return k;return-1}}),Object.defineProperty($TypedArray$.prototype,"map",{value:function(callbackfn){if(null==this)throw TypeError();var t=Object(this),len=ToUint32(t.length);if(!IsCallable(callbackfn))throw TypeError();var res=[];res.length=len;for(var thisp=arguments[1],i=0;i<len;i++)res[i]=callbackfn.call(thisp,t._getter(i),i,t);return new this.constructor(res)}}),Object.defineProperty($TypedArray$.prototype,"reduce",{value:function(callbackfn){if(null==this)throw TypeError();var t=Object(this),len=ToUint32(t.length);if(!IsCallable(callbackfn))throw TypeError();if(0===len&&1===arguments.length)throw TypeError();var accumulator,k=0;for(accumulator=2<=arguments.length?arguments[1]:t._getter(k++);k<len;)accumulator=callbackfn.call(void 0,accumulator,t._getter(k),k,t),k++;return accumulator}}),Object.defineProperty($TypedArray$.prototype,"reduceRight",{value:function(callbackfn){if(null==this)throw TypeError();var t=Object(this),len=ToUint32(t.length);if(!IsCallable(callbackfn))throw TypeError();if(0===len&&1===arguments.length)throw TypeError();var accumulator,k=len-1;for(accumulator=2<=arguments.length?arguments[1]:t._getter(k--);0<=k;)accumulator=callbackfn.call(void 0,accumulator,t._getter(k),k,t),k--;return accumulator}}),Object.defineProperty($TypedArray$.prototype,"reverse",{value:function(){if(null==this)throw TypeError();for(var t=Object(this),len=ToUint32(t.length),half=floor(len/2),i=0,j=len-1;i<half;++i,--j){var tmp=t._getter(i);t._setter(i,t._getter(j)),t._setter(j,tmp)}return t}}),Object.defineProperty($TypedArray$.prototype,"set",{value:function(index,value){if(arguments.length<1)throw SyntaxError("Not enough arguments");var array,sequence,offset,len,i,s,d,byteOffset,byteLength,tmp;if("object"==typeof index&&index.constructor===this.constructor){if(array=index,(offset=ToUint32(value))+array.length>this.length)throw RangeError("Offset plus length of array is out of range");if(byteOffset=this.byteOffset+offset*this.BYTES_PER_ELEMENT,byteLength=array.length*this.BYTES_PER_ELEMENT,array.buffer===this.buffer){for(tmp=[],i=0,s=array.byteOffset;i<byteLength;i+=1,s+=1)tmp[i]=array.buffer._bytes[s];for(i=0,d=byteOffset;i<byteLength;i+=1,d+=1)this.buffer._bytes[d]=tmp[i]}else for(i=0,s=array.byteOffset,d=byteOffset;i<byteLength;i+=1,s+=1,d+=1)this.buffer._bytes[d]=array.buffer._bytes[s]}else{if("object"!=typeof index||"undefined"==typeof index.length)throw TypeError("Unexpected argument type(s)");if(len=ToUint32((sequence=index).length),(offset=ToUint32(value))+len>this.length)throw RangeError("Offset plus length of array is out of range");for(i=0;i<len;i+=1)s=sequence[i],this._setter(offset+i,Number(s))}}}),Object.defineProperty($TypedArray$.prototype,"slice",{value:function(start,end){for(var o=ToObject(this),len=ToUint32(o.length),relativeStart=ToInt32(start),k=relativeStart<0?max(len+relativeStart,0):min(relativeStart,len),relativeEnd=void 0===end?len:ToInt32(end),vfinal=relativeEnd<0?max(len+relativeEnd,0):min(relativeEnd,len),count=vfinal-k,a=new o.constructor(count),n=0;k<vfinal;){var kValue=o._getter(k);a._setter(n,kValue),++k,++n}return a}}),Object.defineProperty($TypedArray$.prototype,"some",{value:function(callbackfn){if(null==this)throw TypeError();var t=Object(this),len=ToUint32(t.length);if(!IsCallable(callbackfn))throw TypeError();for(var thisp=arguments[1],i=0;i<len;i++)if(callbackfn.call(thisp,t._getter(i),i,t))return!0;return!1}}),Object.defineProperty($TypedArray$.prototype,"sort",{value:function(comparefn){if(null==this)throw TypeError();for(var t=Object(this),len=ToUint32(t.length),tmp=Array(len),i=0;i<len;++i)tmp[i]=t._getter(i);for(comparefn?tmp.sort(comparefn):tmp.sort(),i=0;i<len;++i)t._setter(i,tmp[i]);return t}}),Object.defineProperty($TypedArray$.prototype,"subarray",{value:function(start,end){function clamp(v,min,max){return v<min?min:max<v?max:v}start=ToInt32(start),end=ToInt32(end),arguments.length<1&&(start=0),arguments.length<2&&(end=this.length),start<0&&(start=this.length+start),end<0&&(end=this.length+end),start=clamp(start,0,this.length);var len=(end=clamp(end,0,this.length))-start;return len<0&&(len=0),new this.constructor(this.buffer,this.byteOffset+start*this.BYTES_PER_ELEMENT,len)}});var Int8Array=makeTypedArray(1,packI8,unpackI8),Uint8Array=makeTypedArray(1,packU8,unpackU8),Uint8ClampedArray=makeTypedArray(1,packU8Clamped,unpackU8),Int16Array=makeTypedArray(2,packI16,unpackI16),Uint16Array=makeTypedArray(2,packU16,unpackU16),Int32Array=makeTypedArray(4,packI32,unpackI32),Uint32Array=makeTypedArray(4,packU32,unpackU32),Float32Array=makeTypedArray(4,packF32,unpackF32),Float64Array=makeTypedArray(8,packF64,unpackF64);global.Int8Array=global.Int8Array||Int8Array,global.Uint8Array=global.Uint8Array||Uint8Array,global.Uint8ClampedArray=global.Uint8ClampedArray||Uint8ClampedArray,global.Int16Array=global.Int16Array||Int16Array,global.Uint16Array=global.Uint16Array||Uint16Array,global.Int32Array=global.Int32Array||Int32Array,global.Uint32Array=global.Uint32Array||Uint32Array,global.Float32Array=global.Float32Array||Float32Array,global.Float64Array=global.Float64Array||Float64Array}(),function(){function r(array,index){return IsCallable(array.get)?array.get(index):array[index]}var u16array,IS_BIG_ENDIAN=(u16array=new Uint16Array([4660]),18===r(new Uint8Array(u16array.buffer),0));function DataView(buffer,byteOffset,byteLength){if(!(buffer instanceof ArrayBuffer||"ArrayBuffer"===Class(buffer)))throw TypeError();if((byteOffset=ToUint32(byteOffset))>buffer.byteLength)throw RangeError("byteOffset out of range");if(byteOffset+(byteLength=void 0===byteLength?buffer.byteLength-byteOffset:ToUint32(byteLength))>buffer.byteLength)throw RangeError("byteOffset and length reference an area beyond the end of the buffer");Object.defineProperty(this,"buffer",{value:buffer}),Object.defineProperty(this,"byteLength",{value:byteLength}),Object.defineProperty(this,"byteOffset",{value:byteOffset})}function makeGetter(arrayType){return function(byteOffset,littleEndian){if((byteOffset=ToUint32(byteOffset))+arrayType.BYTES_PER_ELEMENT>this.byteLength)throw RangeError("Array index out of range");byteOffset+=this.byteOffset;for(var uint8Array=new Uint8Array(this.buffer,byteOffset,arrayType.BYTES_PER_ELEMENT),bytes=[],i=0;i<arrayType.BYTES_PER_ELEMENT;i+=1)bytes.push(r(uint8Array,i));return Boolean(littleEndian)===Boolean(IS_BIG_ENDIAN)&&bytes.reverse(),r(new arrayType(new Uint8Array(bytes).buffer),0)}}function makeSetter(arrayType){return function(byteOffset,value,littleEndian){if((byteOffset=ToUint32(byteOffset))+arrayType.BYTES_PER_ELEMENT>this.byteLength)throw RangeError("Array index out of range");var i,typeArray=new arrayType([value]),byteArray=new Uint8Array(typeArray.buffer),bytes=[];for(i=0;i<arrayType.BYTES_PER_ELEMENT;i+=1)bytes.push(r(byteArray,i));Boolean(littleEndian)===Boolean(IS_BIG_ENDIAN)&&bytes.reverse(),new Uint8Array(this.buffer,byteOffset,arrayType.BYTES_PER_ELEMENT).set(bytes)}}Object.defineProperty(DataView.prototype,"getUint8",{value:makeGetter(Uint8Array)}),Object.defineProperty(DataView.prototype,"getInt8",{value:makeGetter(Int8Array)}),Object.defineProperty(DataView.prototype,"getUint16",{value:makeGetter(Uint16Array)}),Object.defineProperty(DataView.prototype,"getInt16",{value:makeGetter(Int16Array)}),Object.defineProperty(DataView.prototype,"getUint32",{value:makeGetter(Uint32Array)}),Object.defineProperty(DataView.prototype,"getInt32",{value:makeGetter(Int32Array)}),Object.defineProperty(DataView.prototype,"getFloat32",{value:makeGetter(Float32Array)}),Object.defineProperty(DataView.prototype,"getFloat64",{value:makeGetter(Float64Array)}),Object.defineProperty(DataView.prototype,"setUint8",{value:makeSetter(Uint8Array)}),Object.defineProperty(DataView.prototype,"setInt8",{value:makeSetter(Int8Array)}),Object.defineProperty(DataView.prototype,"setUint16",{value:makeSetter(Uint16Array)}),Object.defineProperty(DataView.prototype,"setInt16",{value:makeSetter(Int16Array)}),Object.defineProperty(DataView.prototype,"setUint32",{value:makeSetter(Uint32Array)}),Object.defineProperty(DataView.prototype,"setInt32",{value:makeSetter(Int32Array)}),Object.defineProperty(DataView.prototype,"setFloat32",{value:makeSetter(Float32Array)}),Object.defineProperty(DataView.prototype,"setFloat64",{value:makeSetter(Float64Array)}),global.DataView=global.DataView||DataView}()}(self);var CryptoJS=CryptoJS||function(Math,undefined){var create=Object.create||function(){function F(){}return function(obj){var subtype;return F.prototype=obj,subtype=new F,F.prototype=null,subtype}}(),C={},C_lib=C.lib={},Base=C_lib.Base={extend:function(overrides){var subtype=create(this);return overrides&&subtype.mixIn(overrides),subtype.hasOwnProperty("init")&&this.init!==subtype.init||(subtype.init=function(){subtype.$super.init.apply(this,arguments)}),(subtype.init.prototype=subtype).$super=this,subtype},create:function(){var instance=this.extend();return instance.init.apply(instance,arguments),instance},init:function(){},mixIn:function(properties){for(var propertyName in properties)properties.hasOwnProperty(propertyName)&&(this[propertyName]=properties[propertyName]);properties.hasOwnProperty("toString")&&(this.toString=properties.toString)},clone:function(){return this.init.prototype.extend(this)}},WordArray=C_lib.WordArray=Base.extend({init:function(words,sigBytes){words=this.words=words||[],this.sigBytes=null!=sigBytes?sigBytes:4*words.length},toString:function(encoder){return(encoder||Hex).stringify(this)},concat:function(wordArray){var thisWords=this.words,thatWords=wordArray.words,thisSigBytes=this.sigBytes,thatSigBytes=wordArray.sigBytes;if(this.clamp(),thisSigBytes%4)for(var i=0;i<thatSigBytes;i++){var thatByte=thatWords[i>>>2]>>>24-i%4*8&255;thisWords[thisSigBytes+i>>>2]|=thatByte<<24-(thisSigBytes+i)%4*8}else for(i=0;i<thatSigBytes;i+=4)thisWords[thisSigBytes+i>>>2]=thatWords[i>>>2];return this.sigBytes+=thatSigBytes,this},clamp:function(){var words=this.words,sigBytes=this.sigBytes;words[sigBytes>>>2]&=4294967295<<32-sigBytes%4*8,words.length=Math.ceil(sigBytes/4)},clone:function(){var clone=Base.clone.call(this);return clone.words=this.words.slice(0),clone},random:function(nBytes){for(var rcache,words=[],r=function(m_w){m_w=m_w;var m_z=987654321,mask=4294967295;return function(){var result=((m_z=36969*(65535&m_z)+(m_z>>16)&mask)<<16)+(m_w=18e3*(65535&m_w)+(m_w>>16)&mask)&mask;return result/=4294967296,(result+=.5)*(.5<Math.random()?1:-1)}},i=0;i<nBytes;i+=4){var _r=r(4294967296*(rcache||Math.random()));rcache=987654071*_r(),words.push(4294967296*_r()|0)}return new WordArray.init(words,nBytes)}}),C_enc=C.enc={},Hex=C_enc.Hex={stringify:function(wordArray){for(var words=wordArray.words,sigBytes=wordArray.sigBytes,hexChars=[],i=0;i<sigBytes;i++){var bite=words[i>>>2]>>>24-i%4*8&255;hexChars.push((bite>>>4).toString(16)),hexChars.push((15&bite).toString(16))}return hexChars.join("")},parse:function(hexStr){for(var hexStrLength=hexStr.length,words=[],i=0;i<hexStrLength;i+=2)words[i>>>3]|=parseInt(hexStr.substr(i,2),16)<<24-i%8*4;return new WordArray.init(words,hexStrLength/2)}},Latin1=C_enc.Latin1={stringify:function(wordArray){for(var words=wordArray.words,sigBytes=wordArray.sigBytes,latin1Chars=[],i=0;i<sigBytes;i++){var bite=words[i>>>2]>>>24-i%4*8&255;latin1Chars.push(String.fromCharCode(bite))}return latin1Chars.join("")},parse:function(latin1Str){for(var latin1StrLength=latin1Str.length,words=[],i=0;i<latin1StrLength;i++)words[i>>>2]|=(255&latin1Str.charCodeAt(i))<<24-i%4*8;return new WordArray.init(words,latin1StrLength)}},Utf8=C_enc.Utf8={stringify:function(wordArray){try{return decodeURIComponent(escape(Latin1.stringify(wordArray)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(utf8Str){return Latin1.parse(unescape(encodeURIComponent(utf8Str)))}},BufferedBlockAlgorithm=C_lib.BufferedBlockAlgorithm=Base.extend({reset:function(){this._data=new WordArray.init,this._nDataBytes=0},_append:function(data){"string"==typeof data&&(data=Utf8.parse(data)),this._data.concat(data),this._nDataBytes+=data.sigBytes},_process:function(doFlush){var data=this._data,dataWords=data.words,dataSigBytes=data.sigBytes,blockSize=this.blockSize,nBlocksReady=dataSigBytes/(4*blockSize),nWordsReady=(nBlocksReady=doFlush?Math.ceil(nBlocksReady):Math.max((0|nBlocksReady)-this._minBufferSize,0))*blockSize,nBytesReady=Math.min(4*nWordsReady,dataSigBytes);if(nWordsReady){for(var offset=0;offset<nWordsReady;offset+=blockSize)this._doProcessBlock(dataWords,offset);var processedWords=dataWords.splice(0,nWordsReady);data.sigBytes-=nBytesReady}return new WordArray.init(processedWords,nBytesReady)},clone:function(){var clone=Base.clone.call(this);return clone._data=this._data.clone(),clone},_minBufferSize:0}),C_algo=(C_lib.Hasher=BufferedBlockAlgorithm.extend({cfg:Base.extend(),init:function(cfg){this.cfg=this.cfg.extend(cfg),this.reset()},reset:function(){BufferedBlockAlgorithm.reset.call(this),this._doReset()},update:function(messageUpdate){return this._append(messageUpdate),this._process(),this},finalize:function(messageUpdate){return messageUpdate&&this._append(messageUpdate),this._doFinalize()},blockSize:16,_createHelper:function(hasher){return function(message,cfg){return new hasher.init(cfg).finalize(message)}},_createHmacHelper:function(hasher){return function(message,key){return new C_algo.HMAC.init(hasher,key).finalize(message)}}}),C.algo={});return C}(Math);!function(){var C=CryptoJS,WordArray=C.lib.WordArray;C.enc.Base64={stringify:function(wordArray){var words=wordArray.words,sigBytes=wordArray.sigBytes,map=this._map;wordArray.clamp();for(var base64Chars=[],i=0;i<sigBytes;i+=3)for(var triplet=(words[i>>>2]>>>24-i%4*8&255)<<16|(words[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|words[i+2>>>2]>>>24-(i+2)%4*8&255,j=0;j<4&&i+.75*j<sigBytes;j++)base64Chars.push(map.charAt(triplet>>>6*(3-j)&63));var paddingChar=map.charAt(64);if(paddingChar)for(;base64Chars.length%4;)base64Chars.push(paddingChar);return base64Chars.join("")},parse:function(base64Str){var base64StrLength=base64Str.length,map=this._map,reverseMap=this._reverseMap;if(!reverseMap){reverseMap=this._reverseMap=[];for(var j=0;j<map.length;j++)reverseMap[map.charCodeAt(j)]=j}var paddingChar=map.charAt(64);if(paddingChar){var paddingIndex=base64Str.indexOf(paddingChar);-1!==paddingIndex&&(base64StrLength=paddingIndex)}return function parseLoop(base64Str,base64StrLength,reverseMap){for(var words=[],nBytes=0,i=0;i<base64StrLength;i++)if(i%4){var bits1=reverseMap[base64Str.charCodeAt(i-1)]<<i%4*2,bits2=reverseMap[base64Str.charCodeAt(i)]>>>6-i%4*2;words[nBytes>>>2]|=(bits1|bits2)<<24-nBytes%4*8,nBytes++}return WordArray.create(words,nBytes)}(base64Str,base64StrLength,reverseMap)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),function(){var C=CryptoJS,Base=C.lib.Base,Utf8=C.enc.Utf8;C.algo.HMAC=Base.extend({init:function(hasher,key){hasher=this._hasher=new hasher.init,"string"==typeof key&&(key=Utf8.parse(key));var hasherBlockSize=hasher.blockSize,hasherBlockSizeBytes=4*hasherBlockSize;key.sigBytes>hasherBlockSizeBytes&&(key=hasher.finalize(key)),key.clamp();for(var oKey=this._oKey=key.clone(),iKey=this._iKey=key.clone(),oKeyWords=oKey.words,iKeyWords=iKey.words,i=0;i<hasherBlockSize;i++)oKeyWords[i]^=1549556828,iKeyWords[i]^=909522486;oKey.sigBytes=iKey.sigBytes=hasherBlockSizeBytes,this.reset()},reset:function(){var hasher=this._hasher;hasher.reset(),hasher.update(this._iKey)},update:function(messageUpdate){return this._hasher.update(messageUpdate),this},finalize:function(messageUpdate){var hasher=this._hasher,innerHash=hasher.finalize(messageUpdate);return hasher.reset(),hasher.finalize(this._oKey.clone().concat(innerHash))}})}(),CryptoJS.lib.Cipher||function(undefined){var C=CryptoJS,C_lib=C.lib,Base=C_lib.Base,WordArray=C_lib.WordArray,BufferedBlockAlgorithm=C_lib.BufferedBlockAlgorithm,C_enc=C.enc,Base64=(C_enc.Utf8,C_enc.Base64),EvpKDF=C.algo.EvpKDF,Cipher=C_lib.Cipher=BufferedBlockAlgorithm.extend({cfg:Base.extend(),createEncryptor:function(key,cfg){return this.create(this._ENC_XFORM_MODE,key,cfg)},createDecryptor:function(key,cfg){return this.create(this._DEC_XFORM_MODE,key,cfg)},init:function(xformMode,key,cfg){this.cfg=this.cfg.extend(cfg),this._xformMode=xformMode,this._key=key,this.reset()},reset:function(){BufferedBlockAlgorithm.reset.call(this),this._doReset()},process:function(dataUpdate){return this._append(dataUpdate),this._process()},finalize:function(dataUpdate){return dataUpdate&&this._append(dataUpdate),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function selectCipherStrategy(key){return"string"==typeof key?PasswordBasedCipher:SerializableCipher}return function(cipher){return{encrypt:function(message,key,cfg){return selectCipherStrategy(key).encrypt(cipher,message,key,cfg)},decrypt:function(ciphertext,key,cfg){return selectCipherStrategy(key).decrypt(cipher,ciphertext,key,cfg)}}}}()}),C_mode=(C_lib.StreamCipher=Cipher.extend({_doFinalize:function(){return this._process(!0)},blockSize:1}),C.mode={}),BlockCipherMode=C_lib.BlockCipherMode=Base.extend({createEncryptor:function(cipher,iv){return this.Encryptor.create(cipher,iv)},createDecryptor:function(cipher,iv){return this.Decryptor.create(cipher,iv)},init:function(cipher,iv){this._cipher=cipher,this._iv=iv}}),CBC=C_mode.CBC=function(){var CBC=BlockCipherMode.extend();function xorBlock(words,offset,blockSize){var iv=this._iv;if(iv){var block=iv;this._iv=void 0}else block=this._prevBlock;for(var i=0;i<blockSize;i++)words[offset+i]^=block[i]}return CBC.Encryptor=CBC.extend({processBlock:function(words,offset){var cipher=this._cipher,blockSize=cipher.blockSize;xorBlock.call(this,words,offset,blockSize),cipher.encryptBlock(words,offset),this._prevBlock=words.slice(offset,offset+blockSize)}}),CBC.Decryptor=CBC.extend({processBlock:function(words,offset){var cipher=this._cipher,blockSize=cipher.blockSize,thisBlock=words.slice(offset,offset+blockSize);cipher.decryptBlock(words,offset),xorBlock.call(this,words,offset,blockSize),this._prevBlock=thisBlock}}),CBC}(),Pkcs7=(C.pad={}).Pkcs7={pad:function(data,blockSize){for(var blockSizeBytes=4*blockSize,nPaddingBytes=blockSizeBytes-data.sigBytes%blockSizeBytes,paddingWord=nPaddingBytes<<24|nPaddingBytes<<16|nPaddingBytes<<8|nPaddingBytes,paddingWords=[],i=0;i<nPaddingBytes;i+=4)paddingWords.push(paddingWord);var padding=WordArray.create(paddingWords,nPaddingBytes);data.concat(padding)},unpad:function(data){var nPaddingBytes=255&data.words[data.sigBytes-1>>>2];data.sigBytes-=nPaddingBytes}},CipherParams=(C_lib.BlockCipher=Cipher.extend({cfg:Cipher.cfg.extend({mode:CBC,padding:Pkcs7}),reset:function(){Cipher.reset.call(this);var cfg=this.cfg,iv=cfg.iv,mode=cfg.mode;if(this._xformMode==this._ENC_XFORM_MODE)var modeCreator=mode.createEncryptor;else{modeCreator=mode.createDecryptor;this._minBufferSize=1}this._mode&&this._mode.__creator==modeCreator?this._mode.init(this,iv&&iv.words):(this._mode=modeCreator.call(mode,this,iv&&iv.words),this._mode.__creator=modeCreator)},_doProcessBlock:function(words,offset){this._mode.processBlock(words,offset)},_doFinalize:function(){var padding=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){padding.pad(this._data,this.blockSize);var finalProcessedBlocks=this._process(!0)}else{finalProcessedBlocks=this._process(!0);padding.unpad(finalProcessedBlocks)}return finalProcessedBlocks},blockSize:4}),C_lib.CipherParams=Base.extend({init:function(cipherParams){this.mixIn(cipherParams)},toString:function(formatter){return(formatter||this.formatter).stringify(this)}})),OpenSSLFormatter=(C.format={}).OpenSSL={stringify:function(cipherParams){var ciphertext=cipherParams.ciphertext,salt=cipherParams.salt;if(salt)var wordArray=WordArray.create([1398893684,1701076831]).concat(salt).concat(ciphertext);else wordArray=ciphertext;return wordArray.toString(Base64)},parse:function(openSSLStr){var ciphertext=Base64.parse(openSSLStr),ciphertextWords=ciphertext.words;if(1398893684==ciphertextWords[0]&&1701076831==ciphertextWords[1]){var salt=WordArray.create(ciphertextWords.slice(2,4));ciphertextWords.splice(0,4),ciphertext.sigBytes-=16}return CipherParams.create({ciphertext:ciphertext,salt:salt})}},SerializableCipher=C_lib.SerializableCipher=Base.extend({cfg:Base.extend({format:OpenSSLFormatter}),encrypt:function(cipher,message,key,cfg){cfg=this.cfg.extend(cfg);var encryptor=cipher.createEncryptor(key,cfg),ciphertext=encryptor.finalize(message),cipherCfg=encryptor.cfg;return CipherParams.create({ciphertext:ciphertext,key:key,iv:cipherCfg.iv,algorithm:cipher,mode:cipherCfg.mode,padding:cipherCfg.padding,blockSize:cipher.blockSize,formatter:cfg.format})},decrypt:function(cipher,ciphertext,key,cfg){return cfg=this.cfg.extend(cfg),ciphertext=this._parse(ciphertext,cfg.format),cipher.createDecryptor(key,cfg).finalize(ciphertext.ciphertext)},_parse:function(ciphertext,format){return"string"==typeof ciphertext?format.parse(ciphertext,this):ciphertext}}),OpenSSLKdf=(C.kdf={}).OpenSSL={execute:function(password,keySize,ivSize,salt){salt||(salt=WordArray.random(8));var key=EvpKDF.create({keySize:keySize+ivSize}).compute(password,salt),iv=WordArray.create(key.words.slice(keySize),4*ivSize);return key.sigBytes=4*keySize,CipherParams.create({key:key,iv:iv,salt:salt})}},PasswordBasedCipher=C_lib.PasswordBasedCipher=SerializableCipher.extend({cfg:SerializableCipher.cfg.extend({kdf:OpenSSLKdf}),encrypt:function(cipher,message,password,cfg){var derivedParams=(cfg=this.cfg.extend(cfg)).kdf.execute(password,cipher.keySize,cipher.ivSize);cfg.iv=derivedParams.iv;var ciphertext=SerializableCipher.encrypt.call(this,cipher,message,derivedParams.key,cfg);return ciphertext.mixIn(derivedParams),ciphertext},decrypt:function(cipher,ciphertext,password,cfg){cfg=this.cfg.extend(cfg),ciphertext=this._parse(ciphertext,cfg.format);var derivedParams=cfg.kdf.execute(password,cipher.keySize,cipher.ivSize,ciphertext.salt);return cfg.iv=derivedParams.iv,SerializableCipher.decrypt.call(this,cipher,ciphertext,derivedParams.key,cfg)}})}(),function(Math){var C=CryptoJS,C_lib=C.lib,WordArray=C_lib.WordArray,Hasher=C_lib.Hasher,C_algo=C.algo,H=[],K=[];!function(){function isPrime(n){for(var sqrtN=Math.sqrt(n),factor=2;factor<=sqrtN;factor++)if(!(n%factor))return!1;return!0}function getFractionalBits(n){return 4294967296*(n-(0|n))|0}for(var n=2,nPrime=0;nPrime<64;)isPrime(n)&&(nPrime<8&&(H[nPrime]=getFractionalBits(Math.pow(n,.5))),K[nPrime]=getFractionalBits(Math.pow(n,1/3)),nPrime++),n++}();var W=[],SHA256=C_algo.SHA256=Hasher.extend({_doReset:function(){this._hash=new WordArray.init(H.slice(0))},_doProcessBlock:function(M,offset){for(var H=this._hash.words,a=H[0],b=H[1],c=H[2],d=H[3],e=H[4],f=H[5],g=H[6],h=H[7],i=0;i<64;i++){if(i<16)W[i]=0|M[offset+i];else{var gamma0x=W[i-15],gamma0=(gamma0x<<25|gamma0x>>>7)^(gamma0x<<14|gamma0x>>>18)^gamma0x>>>3,gamma1x=W[i-2],gamma1=(gamma1x<<15|gamma1x>>>17)^(gamma1x<<13|gamma1x>>>19)^gamma1x>>>10;W[i]=gamma0+W[i-7]+gamma1+W[i-16]}var maj=a&b^a&c^b&c,sigma0=(a<<30|a>>>2)^(a<<19|a>>>13)^(a<<10|a>>>22),t1=h+((e<<26|e>>>6)^(e<<21|e>>>11)^(e<<7|e>>>25))+(e&f^~e&g)+K[i]+W[i];h=g,g=f,f=e,e=d+t1|0,d=c,c=b,b=a,a=t1+(sigma0+maj)|0}H[0]=H[0]+a|0,H[1]=H[1]+b|0,H[2]=H[2]+c|0,H[3]=H[3]+d|0,H[4]=H[4]+e|0,H[5]=H[5]+f|0,H[6]=H[6]+g|0,H[7]=H[7]+h|0},_doFinalize:function(){var data=this._data,dataWords=data.words,nBitsTotal=8*this._nDataBytes,nBitsLeft=8*data.sigBytes;return dataWords[nBitsLeft>>>5]|=128<<24-nBitsLeft%32,dataWords[14+(nBitsLeft+64>>>9<<4)]=Math.floor(nBitsTotal/4294967296),dataWords[15+(nBitsLeft+64>>>9<<4)]=nBitsTotal,data.sigBytes=4*dataWords.length,this._process(),this._hash},clone:function(){var clone=Hasher.clone.call(this);return clone._hash=this._hash.clone(),clone}});C.SHA256=Hasher._createHelper(SHA256),C.HmacSHA256=Hasher._createHmacHelper(SHA256)}(Math),function(){var C=CryptoJS,C_lib=C.lib,WordArray=C_lib.WordArray,Hasher=C_lib.Hasher,C_algo=C.algo,W=[],SHA1=C_algo.SHA1=Hasher.extend({_doReset:function(){this._hash=new WordArray.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(M,offset){for(var H=this._hash.words,a=H[0],b=H[1],c=H[2],d=H[3],e=H[4],i=0;i<80;i++){if(i<16)W[i]=0|M[offset+i];else{var n=W[i-3]^W[i-8]^W[i-14]^W[i-16];W[i]=n<<1|n>>>31}var t=(a<<5|a>>>27)+e+W[i];t+=i<20?1518500249+(b&c|~b&d):i<40?1859775393+(b^c^d):i<60?(b&c|b&d|c&d)-1894007588:(b^c^d)-899497514,e=d,d=c,c=b<<30|b>>>2,b=a,a=t}H[0]=H[0]+a|0,H[1]=H[1]+b|0,H[2]=H[2]+c|0,H[3]=H[3]+d|0,H[4]=H[4]+e|0},_doFinalize:function(){var data=this._data,dataWords=data.words,nBitsTotal=8*this._nDataBytes,nBitsLeft=8*data.sigBytes;return dataWords[nBitsLeft>>>5]|=128<<24-nBitsLeft%32,dataWords[14+(nBitsLeft+64>>>9<<4)]=Math.floor(nBitsTotal/4294967296),dataWords[15+(nBitsLeft+64>>>9<<4)]=nBitsTotal,data.sigBytes=4*dataWords.length,this._process(),this._hash},clone:function(){var clone=Hasher.clone.call(this);return clone._hash=this._hash.clone(),clone}});C.SHA1=Hasher._createHelper(SHA1),C.HmacSHA1=Hasher._createHmacHelper(SHA1)}(),function(){var C=CryptoJS,WordArray=C.lib.WordArray,C_enc=C.enc;C_enc.Utf16=C_enc.Utf16BE={stringify:function(wordArray){for(var words=wordArray.words,sigBytes=wordArray.sigBytes,utf16Chars=[],i=0;i<sigBytes;i+=2){var codePoint=words[i>>>2]>>>16-i%4*8&65535;utf16Chars.push(String.fromCharCode(codePoint))}return utf16Chars.join("")},parse:function(utf16Str){for(var utf16StrLength=utf16Str.length,words=[],i=0;i<utf16StrLength;i++)words[i>>>1]|=utf16Str.charCodeAt(i)<<16-i%2*16;return WordArray.create(words,2*utf16StrLength)}};function swapEndian(word){return word<<8&4278255360|word>>>8&16711935}C_enc.Utf16LE={stringify:function(wordArray){for(var words=wordArray.words,sigBytes=wordArray.sigBytes,utf16Chars=[],i=0;i<sigBytes;i+=2){var codePoint=swapEndian(words[i>>>2]>>>16-i%4*8&65535);utf16Chars.push(String.fromCharCode(codePoint))}return utf16Chars.join("")},parse:function(utf16Str){for(var utf16StrLength=utf16Str.length,words=[],i=0;i<utf16StrLength;i++)words[i>>>1]|=swapEndian(utf16Str.charCodeAt(i)<<16-i%2*16);return WordArray.create(words,2*utf16StrLength)}}}(),function(){var C=CryptoJS,BlockCipher=C.lib.BlockCipher,C_algo=C.algo,SBOX=[],INV_SBOX=[],SUB_MIX_0=[],SUB_MIX_1=[],SUB_MIX_2=[],SUB_MIX_3=[],INV_SUB_MIX_0=[],INV_SUB_MIX_1=[],INV_SUB_MIX_2=[],INV_SUB_MIX_3=[];!function(){for(var d=[],i=0;i<256;i++)d[i]=i<128?i<<1:i<<1^283;var x=0,xi=0;for(i=0;i<256;i++){var sx=xi^xi<<1^xi<<2^xi<<3^xi<<4;sx=sx>>>8^255&sx^99,SBOX[x]=sx;var x2=d[INV_SBOX[sx]=x],x4=d[x2],x8=d[x4],t=257*d[sx]^16843008*sx;SUB_MIX_0[x]=t<<24|t>>>8,SUB_MIX_1[x]=t<<16|t>>>16,SUB_MIX_2[x]=t<<8|t>>>24,SUB_MIX_3[x]=t;t=16843009*x8^65537*x4^257*x2^16843008*x;INV_SUB_MIX_0[sx]=t<<24|t>>>8,INV_SUB_MIX_1[sx]=t<<16|t>>>16,INV_SUB_MIX_2[sx]=t<<8|t>>>24,INV_SUB_MIX_3[sx]=t,x?(x=x2^d[d[d[x8^x2]]],xi^=d[d[xi]]):x=xi=1}}();var RCON=[0,1,2,4,8,16,32,64,128,27,54],AES=C_algo.AES=BlockCipher.extend({_doReset:function(){if(!this._nRounds||this._keyPriorReset!==this._key){for(var key=this._keyPriorReset=this._key,keyWords=key.words,keySize=key.sigBytes/4,ksRows=4*((this._nRounds=keySize+6)+1),keySchedule=this._keySchedule=[],ksRow=0;ksRow<ksRows;ksRow++)if(ksRow<keySize)keySchedule[ksRow]=keyWords[ksRow];else{var t=keySchedule[ksRow-1];ksRow%keySize?6<keySize&&ksRow%keySize==4&&(t=SBOX[t>>>24]<<24|SBOX[t>>>16&255]<<16|SBOX[t>>>8&255]<<8|SBOX[255&t]):(t=SBOX[(t=t<<8|t>>>24)>>>24]<<24|SBOX[t>>>16&255]<<16|SBOX[t>>>8&255]<<8|SBOX[255&t],t^=RCON[ksRow/keySize|0]<<24),keySchedule[ksRow]=keySchedule[ksRow-keySize]^t}for(var invKeySchedule=this._invKeySchedule=[],invKsRow=0;invKsRow<ksRows;invKsRow++){ksRow=ksRows-invKsRow;if(invKsRow%4)t=keySchedule[ksRow];else t=keySchedule[ksRow-4];invKeySchedule[invKsRow]=invKsRow<4||ksRow<=4?t:INV_SUB_MIX_0[SBOX[t>>>24]]^INV_SUB_MIX_1[SBOX[t>>>16&255]]^INV_SUB_MIX_2[SBOX[t>>>8&255]]^INV_SUB_MIX_3[SBOX[255&t]]}}},encryptBlock:function(M,offset){this._doCryptBlock(M,offset,this._keySchedule,SUB_MIX_0,SUB_MIX_1,SUB_MIX_2,SUB_MIX_3,SBOX)},decryptBlock:function(M,offset){var t=M[offset+1];M[offset+1]=M[offset+3],M[offset+3]=t,this._doCryptBlock(M,offset,this._invKeySchedule,INV_SUB_MIX_0,INV_SUB_MIX_1,INV_SUB_MIX_2,INV_SUB_MIX_3,INV_SBOX);t=M[offset+1];M[offset+1]=M[offset+3],M[offset+3]=t},_doCryptBlock:function(M,offset,keySchedule,SUB_MIX_0,SUB_MIX_1,SUB_MIX_2,SUB_MIX_3,SBOX){for(var nRounds=this._nRounds,s0=M[offset]^keySchedule[0],s1=M[offset+1]^keySchedule[1],s2=M[offset+2]^keySchedule[2],s3=M[offset+3]^keySchedule[3],ksRow=4,round=1;round<nRounds;round++){var t0=SUB_MIX_0[s0>>>24]^SUB_MIX_1[s1>>>16&255]^SUB_MIX_2[s2>>>8&255]^SUB_MIX_3[255&s3]^keySchedule[ksRow++],t1=SUB_MIX_0[s1>>>24]^SUB_MIX_1[s2>>>16&255]^SUB_MIX_2[s3>>>8&255]^SUB_MIX_3[255&s0]^keySchedule[ksRow++],t2=SUB_MIX_0[s2>>>24]^SUB_MIX_1[s3>>>16&255]^SUB_MIX_2[s0>>>8&255]^SUB_MIX_3[255&s1]^keySchedule[ksRow++],t3=SUB_MIX_0[s3>>>24]^SUB_MIX_1[s0>>>16&255]^SUB_MIX_2[s1>>>8&255]^SUB_MIX_3[255&s2]^keySchedule[ksRow++];s0=t0,s1=t1,s2=t2,s3=t3}t0=(SBOX[s0>>>24]<<24|SBOX[s1>>>16&255]<<16|SBOX[s2>>>8&255]<<8|SBOX[255&s3])^keySchedule[ksRow++],t1=(SBOX[s1>>>24]<<24|SBOX[s2>>>16&255]<<16|SBOX[s3>>>8&255]<<8|SBOX[255&s0])^keySchedule[ksRow++],t2=(SBOX[s2>>>24]<<24|SBOX[s3>>>16&255]<<16|SBOX[s0>>>8&255]<<8|SBOX[255&s1])^keySchedule[ksRow++],t3=(SBOX[s3>>>24]<<24|SBOX[s0>>>16&255]<<16|SBOX[s1>>>8&255]<<8|SBOX[255&s2])^keySchedule[ksRow++];M[offset]=t0,M[offset+1]=t1,M[offset+2]=t2,M[offset+3]=t3},keySize:8});C.AES=BlockCipher._createHelper(AES)}(),function(){var C=CryptoJS,C_lib=C.lib,Base=C_lib.Base,WordArray=C_lib.WordArray,C_algo=C.algo,SHA1=C_algo.SHA1,HMAC=C_algo.HMAC,PBKDF2=C_algo.PBKDF2=Base.extend({cfg:Base.extend({keySize:4,hasher:SHA1,iterations:1}),init:function(cfg){this.cfg=this.cfg.extend(cfg)},compute:function(password,salt){for(var cfg=this.cfg,hmac=HMAC.create(cfg.hasher,password),derivedKey=WordArray.create(),blockIndex=WordArray.create([1]),derivedKeyWords=derivedKey.words,blockIndexWords=blockIndex.words,keySize=cfg.keySize,iterations=cfg.iterations;derivedKeyWords.length<keySize;){var block=hmac.update(salt).finalize(blockIndex);hmac.reset();for(var blockWords=block.words,blockWordsLength=blockWords.length,intermediate=block,i=1;i<iterations;i++){intermediate=hmac.finalize(intermediate),hmac.reset();for(var intermediateWords=intermediate.words,j=0;j<blockWordsLength;j++)blockWords[j]^=intermediateWords[j]}derivedKey.concat(block),blockIndexWords[0]++}return derivedKey.sigBytes=4*keySize,derivedKey}});C.PBKDF2=function(password,salt,cfg){return PBKDF2.create(cfg).compute(password,salt)}}();var b64map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",b64pad="=";function hex2b64(h){var i,c,ret="";for(i=0;i+3<=h.length;i+=3)c=parseInt(h.substring(i,i+3),16),ret+=b64map.charAt(c>>6)+b64map.charAt(63&c);if(i+1==h.length?(c=parseInt(h.substring(i,i+1),16),ret+=b64map.charAt(c<<2)):i+2==h.length&&(c=parseInt(h.substring(i,i+2),16),ret+=b64map.charAt(c>>2)+b64map.charAt((3&c)<<4)),b64pad)for(;0<(3&ret.length);)ret+=b64pad;return ret}function b64tohex(s){var i,slop,v,ret="",k=0;for(i=0;i<s.length&&s.charAt(i)!=b64pad;++i)(v=b64map.indexOf(s.charAt(i)))<0||(k=0==k?(ret+=int2char(v>>2),slop=3&v,1):1==k?(ret+=int2char(slop<<2|v>>4),slop=15&v,2):2==k?(ret+=int2char(slop),ret+=int2char(v>>2),slop=3&v,3):(ret+=int2char(slop<<2|v>>4),ret+=int2char(15&v),0));return 1==k&&(ret+=int2char(slop<<2)),ret}function b64toBA(s){var i,h=b64tohex(s),a=new Array;for(i=0;2*i<h.length;++i)a[i]=parseInt(h.substring(2*i,2*i+2),16);return a}function Arcfour(){this.i=0,this.j=0,this.S=new Array}function ARC4init(key){var i,j,t;for(i=0;i<256;++i)this.S[i]=i;for(i=j=0;i<256;++i)j=j+this.S[i]+key[i%key.length]&255,t=this.S[i],this.S[i]=this.S[j],this.S[j]=t;this.i=0,this.j=0}function ARC4next(){var t;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,t=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=t,this.S[t+this.S[this.i]&255]}function prng_newstate(){return new Arcfour}Arcfour.prototype.init=ARC4init,Arcfour.prototype.next=ARC4next;var rng_state,rng_pool,rng_pptr,dbits,rng_psize=256;function rng_seed_int(x){rng_pool[rng_pptr++]^=255&x,rng_pool[rng_pptr++]^=x>>8&255,rng_pool[rng_pptr++]^=x>>16&255,rng_pool[rng_pptr++]^=x>>24&255,rng_psize<=rng_pptr&&(rng_pptr-=rng_psize)}function rng_seed_time(){rng_seed_int((new Date).getTime())}if(null==rng_pool){var t;if(rng_pool=new Array,rng_pptr=0,window!==undefined&&(window.crypto!==undefined||window.msCrypto!==undefined)){var crypto=window.crypto||window.msCrypto;if(crypto.getRandomValues){var ua=new Uint8Array(32);for(crypto.getRandomValues(ua),t=0;t<32;++t)rng_pool[rng_pptr++]=ua[t]}else if("Netscape"==navigator.appName&&navigator.appVersion<"5"){var z=window.crypto.random(32);for(t=0;t<z.length;++t)rng_pool[rng_pptr++]=255&z.charCodeAt(t)}}for(;rng_pptr<rng_psize;)t=Math.floor(65536*Math.random()),rng_pool[rng_pptr++]=t>>>8,rng_pool[rng_pptr++]=255&t;rng_pptr=0,rng_seed_time()}function rng_get_byte(){if(null==rng_state){for(rng_seed_time(),(rng_state=prng_newstate()).init(rng_pool),rng_pptr=0;rng_pptr<rng_pool.length;++rng_pptr)rng_pool[rng_pptr]=0;rng_pptr=0}return rng_state.next()}function rng_get_bytes(ba){var i;for(i=0;i<ba.length;++i)ba[i]=rng_get_byte()}function SecureRandom(){}SecureRandom.prototype.nextBytes=rng_get_bytes;var canary=0xdeadbeefcafe,j_lm=15715070==(16777215&canary);function BigInteger(a,b,c){null!=a&&("number"==typeof a?this.fromNumber(a,b,c):null==b&&"string"!=typeof a?this.fromString(a,256):this.fromString(a,b))}function nbi(){return new BigInteger(null)}function am1(i,x,w,j,c,n){for(;0<=--n;){var v=x*this[i++]+w[j]+c;c=Math.floor(v/67108864),w[j++]=67108863&v}return c}function am2(i,x,w,j,c,n){for(var xl=32767&x,xh=x>>15;0<=--n;){var l=32767&this[i],h=this[i++]>>15,m=xh*l+h*xl;c=((l=xl*l+((32767&m)<<15)+w[j]+(1073741823&c))>>>30)+(m>>>15)+xh*h+(c>>>30),w[j++]=1073741823&l}return c}function am3(i,x,w,j,c,n){for(var xl=16383&x,xh=x>>14;0<=--n;){var l=16383&this[i],h=this[i++]>>14,m=xh*l+h*xl;c=((l=xl*l+((16383&m)<<14)+w[j]+c)>>28)+(m>>14)+xh*h,w[j++]=268435455&l}return c}dbits=j_lm&&"Microsoft Internet Explorer"==navigator.appName?(BigInteger.prototype.am=am2,30):j_lm&&"Netscape"!=navigator.appName?(BigInteger.prototype.am=am1,26):(BigInteger.prototype.am=am3,28),BigInteger.prototype.DB=dbits,BigInteger.prototype.DM=(1<<dbits)-1,BigInteger.prototype.DV=1<<dbits;var BI_FP=52;BigInteger.prototype.FV=Math.pow(2,BI_FP),BigInteger.prototype.F1=BI_FP-dbits,BigInteger.prototype.F2=2*dbits-BI_FP;var rr,vv,BI_RM="0123456789abcdefghijklmnopqrstuvwxyz",BI_RC=new Array;for(rr="0".charCodeAt(0),vv=0;vv<=9;++vv)BI_RC[rr++]=vv;for(rr="a".charCodeAt(0),vv=10;vv<36;++vv)BI_RC[rr++]=vv;for(rr="A".charCodeAt(0),vv=10;vv<36;++vv)BI_RC[rr++]=vv;function int2char(n){return BI_RM.charAt(n)}function intAt(s,i){var c=BI_RC[s.charCodeAt(i)];return null==c?-1:c}function bnpCopyTo(r){for(var i=this.t-1;0<=i;--i)r[i]=this[i];r.t=this.t,r.s=this.s}function bnpFromInt(x){this.t=1,this.s=x<0?-1:0,0<x?this[0]=x:x<-1?this[0]=x+this.DV:this.t=0}function nbv(i){var r=nbi();return r.fromInt(i),r}function bnpFromString(s,b){var k;if(16==b)k=4;else if(8==b)k=3;else if(256==b)k=8;else if(2==b)k=1;else if(32==b)k=5;else{if(4!=b)return void this.fromRadix(s,b);k=2}this.t=0,this.s=0;for(var i=s.length,mi=!1,sh=0;0<=--i;){var x=8==k?255&s[i]:intAt(s,i);x<0?"-"==s.charAt(i)&&(mi=!0):(mi=!1,0==sh?this[this.t++]=x:sh+k>this.DB?(this[this.t-1]|=(x&(1<<this.DB-sh)-1)<<sh,this[this.t++]=x>>this.DB-sh):this[this.t-1]|=x<<sh,(sh+=k)>=this.DB&&(sh-=this.DB))}8==k&&0!=(128&s[0])&&(this.s=-1,0<sh&&(this[this.t-1]|=(1<<this.DB-sh)-1<<sh)),this.clamp(),mi&&BigInteger.ZERO.subTo(this,this)}function bnpClamp(){for(var c=this.s&this.DM;0<this.t&&this[this.t-1]==c;)--this.t}function bnToString(b){if(this.s<0)return"-"+this.negate().toString(b);var k;if(16==b)k=4;else if(8==b)k=3;else if(2==b)k=1;else if(32==b)k=5;else{if(4!=b)return this.toRadix(b);k=2}var d,km=(1<<k)-1,m=!1,r="",i=this.t,p=this.DB-i*this.DB%k;if(0<i--)for(p<this.DB&&0<(d=this[i]>>p)&&(m=!0,r=int2char(d));0<=i;)p<k?(d=(this[i]&(1<<p)-1)<<k-p,d|=this[--i]>>(p+=this.DB-k)):(d=this[i]>>(p-=k)&km,p<=0&&(p+=this.DB,--i)),0<d&&(m=!0),m&&(r+=int2char(d));return m?r:"0"}function bnNegate(){var r=nbi();return BigInteger.ZERO.subTo(this,r),r}function bnAbs(){return this.s<0?this.negate():this}function bnCompareTo(a){var r=this.s-a.s;if(0!=r)return r;var i=this.t;if(0!=(r=i-a.t))return this.s<0?-r:r;for(;0<=--i;)if(0!=(r=this[i]-a[i]))return r;return 0}function nbits(x){var t,r=1;return 0!=(t=x>>>16)&&(x=t,r+=16),0!=(t=x>>8)&&(x=t,r+=8),0!=(t=x>>4)&&(x=t,r+=4),0!=(t=x>>2)&&(x=t,r+=2),0!=(t=x>>1)&&(x=t,r+=1),r}function bnBitLength(){return this.t<=0?0:this.DB*(this.t-1)+nbits(this[this.t-1]^this.s&this.DM)}function bnpDLShiftTo(n,r){var i;for(i=this.t-1;0<=i;--i)r[i+n]=this[i];for(i=n-1;0<=i;--i)r[i]=0;r.t=this.t+n,r.s=this.s}function bnpDRShiftTo(n,r){for(var i=n;i<this.t;++i)r[i-n]=this[i];r.t=Math.max(this.t-n,0),r.s=this.s}function bnpLShiftTo(n,r){var i,bs=n%this.DB,cbs=this.DB-bs,bm=(1<<cbs)-1,ds=Math.floor(n/this.DB),c=this.s<<bs&this.DM;for(i=this.t-1;0<=i;--i)r[i+ds+1]=this[i]>>cbs|c,c=(this[i]&bm)<<bs;for(i=ds-1;0<=i;--i)r[i]=0;r[ds]=c,r.t=this.t+ds+1,r.s=this.s,r.clamp()}function bnpRShiftTo(n,r){r.s=this.s;var ds=Math.floor(n/this.DB);if(ds>=this.t)r.t=0;else{var bs=n%this.DB,cbs=this.DB-bs,bm=(1<<bs)-1;r[0]=this[ds]>>bs;for(var i=ds+1;i<this.t;++i)r[i-ds-1]|=(this[i]&bm)<<cbs,r[i-ds]=this[i]>>bs;0<bs&&(r[this.t-ds-1]|=(this.s&bm)<<cbs),r.t=this.t-ds,r.clamp()}}function bnpSubTo(a,r){for(var i=0,c=0,m=Math.min(a.t,this.t);i<m;)c+=this[i]-a[i],r[i++]=c&this.DM,c>>=this.DB;if(a.t<this.t){for(c-=a.s;i<this.t;)c+=this[i],r[i++]=c&this.DM,c>>=this.DB;c+=this.s}else{for(c+=this.s;i<a.t;)c-=a[i],r[i++]=c&this.DM,c>>=this.DB;c-=a.s}r.s=c<0?-1:0,c<-1?r[i++]=this.DV+c:0<c&&(r[i++]=c),r.t=i,r.clamp()}function bnpMultiplyTo(a,r){var x=this.abs(),y=a.abs(),i=x.t;for(r.t=i+y.t;0<=--i;)r[i]=0;for(i=0;i<y.t;++i)r[i+x.t]=x.am(0,y[i],r,i,0,x.t);r.s=0,r.clamp(),this.s!=a.s&&BigInteger.ZERO.subTo(r,r)}function bnpSquareTo(r){for(var x=this.abs(),i=r.t=2*x.t;0<=--i;)r[i]=0;for(i=0;i<x.t-1;++i){var c=x.am(i,x[i],r,2*i,0,1);(r[i+x.t]+=x.am(i+1,2*x[i],r,2*i+1,c,x.t-i-1))>=x.DV&&(r[i+x.t]-=x.DV,r[i+x.t+1]=1)}0<r.t&&(r[r.t-1]+=x.am(i,x[i],r,2*i,0,1)),r.s=0,r.clamp()}function bnpDivRemTo(m,q,r){var pm=m.abs();if(!(pm.t<=0)){var pt=this.abs();if(pt.t<pm.t)return null!=q&&q.fromInt(0),void(null!=r&&this.copyTo(r));null==r&&(r=nbi());var y=nbi(),ts=this.s,ms=m.s,nsh=this.DB-nbits(pm[pm.t-1]);0<nsh?(pm.lShiftTo(nsh,y),pt.lShiftTo(nsh,r)):(pm.copyTo(y),pt.copyTo(r));var ys=y.t,y0=y[ys-1];if(0!=y0){var yt=y0*(1<<this.F1)+(1<ys?y[ys-2]>>this.F2:0),d1=this.FV/yt,d2=(1<<this.F1)/yt,e=1<<this.F2,i=r.t,j=i-ys,t=null==q?nbi():q;for(y.dlShiftTo(j,t),0<=r.compareTo(t)&&(r[r.t++]=1,r.subTo(t,r)),BigInteger.ONE.dlShiftTo(ys,t),t.subTo(y,y);y.t<ys;)y[y.t++]=0;for(;0<=--j;){var qd=r[--i]==y0?this.DM:Math.floor(r[i]*d1+(r[i-1]+e)*d2);if((r[i]+=y.am(0,qd,r,j,0,ys))<qd)for(y.dlShiftTo(j,t),r.subTo(t,r);r[i]<--qd;)r.subTo(t,r)}null!=q&&(r.drShiftTo(ys,q),ts!=ms&&BigInteger.ZERO.subTo(q,q)),r.t=ys,r.clamp(),0<nsh&&r.rShiftTo(nsh,r),ts<0&&BigInteger.ZERO.subTo(r,r)}}}function bnMod(a){var r=nbi();return this.abs().divRemTo(a,null,r),this.s<0&&0<r.compareTo(BigInteger.ZERO)&&a.subTo(r,r),r}function Classic(m){this.m=m}function cConvert(x){return x.s<0||0<=x.compareTo(this.m)?x.mod(this.m):x}function cRevert(x){return x}function cReduce(x){x.divRemTo(this.m,null,x)}function cMulTo(x,y,r){x.multiplyTo(y,r),this.reduce(r)}function cSqrTo(x,r){x.squareTo(r),this.reduce(r)}function bnpInvDigit(){if(this.t<1)return 0;var x=this[0];if(0==(1&x))return 0;var y=3&x;return 0<(y=(y=(y=(y=y*(2-(15&x)*y)&15)*(2-(255&x)*y)&255)*(2-((65535&x)*y&65535))&65535)*(2-x*y%this.DV)%this.DV)?this.DV-y:-y}function Montgomery(m){this.m=m,this.mp=m.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<m.DB-15)-1,this.mt2=2*m.t}function montConvert(x){var r=nbi();return x.abs().dlShiftTo(this.m.t,r),r.divRemTo(this.m,null,r),x.s<0&&0<r.compareTo(BigInteger.ZERO)&&this.m.subTo(r,r),r}function montRevert(x){var r=nbi();return x.copyTo(r),this.reduce(r),r}function montReduce(x){for(;x.t<=this.mt2;)x[x.t++]=0;for(var i=0;i<this.m.t;++i){var j=32767&x[i],u0=j*this.mpl+((j*this.mph+(x[i]>>15)*this.mpl&this.um)<<15)&x.DM;for(x[j=i+this.m.t]+=this.m.am(0,u0,x,i,0,this.m.t);x[j]>=x.DV;)x[j]-=x.DV,x[++j]++}x.clamp(),x.drShiftTo(this.m.t,x),0<=x.compareTo(this.m)&&x.subTo(this.m,x)}function montSqrTo(x,r){x.squareTo(r),this.reduce(r)}function montMulTo(x,y,r){x.multiplyTo(y,r),this.reduce(r)}function bnpIsEven(){return 0==(0<this.t?1&this[0]:this.s)}function bnpExp(e,z){if(4294967295<e||e<1)return BigInteger.ONE;var r=nbi(),r2=nbi(),g=z.convert(this),i=nbits(e)-1;for(g.copyTo(r);0<=--i;)if(z.sqrTo(r,r2),0<(e&1<<i))z.mulTo(r2,g,r);else{var t=r;r=r2,r2=t}return z.revert(r)}function bnModPowInt(e,m){var z;return z=e<256||m.isEven()?new Classic(m):new Montgomery(m),this.exp(e,z)}function bnClone(){var r=nbi();return this.copyTo(r),r}function bnIntValue(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]}function bnByteValue(){return 0==this.t?this.s:this[0]<<24>>24}function bnShortValue(){return 0==this.t?this.s:this[0]<<16>>16}function bnpChunkSize(r){return Math.floor(Math.LN2*this.DB/Math.log(r))}function bnSigNum(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1}function bnpToRadix(b){if(null==b&&(b=10),0==this.signum()||b<2||36<b)return"0";var cs=this.chunkSize(b),a=Math.pow(b,cs),d=nbv(a),y=nbi(),z=nbi(),r="";for(this.divRemTo(d,y,z);0<y.signum();)r=(a+z.intValue()).toString(b).substr(1)+r,y.divRemTo(d,y,z);return z.intValue().toString(b)+r}function bnpFromRadix(s,b){this.fromInt(0),null==b&&(b=10);for(var cs=this.chunkSize(b),d=Math.pow(b,cs),mi=!1,j=0,w=0,i=0;i<s.length;++i){var x=intAt(s,i);x<0?"-"==s.charAt(i)&&0==this.signum()&&(mi=!0):(w=b*w+x,++j>=cs&&(this.dMultiply(d),this.dAddOffset(w,0),w=j=0))}0<j&&(this.dMultiply(Math.pow(b,j)),this.dAddOffset(w,0)),mi&&BigInteger.ZERO.subTo(this,this)}function bnpFromNumber(a,b,c){if("number"==typeof b)if(a<2)this.fromInt(1);else for(this.fromNumber(a,c),this.testBit(a-1)||this.bitwiseTo(BigInteger.ONE.shiftLeft(a-1),op_or,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(b);)this.dAddOffset(2,0),this.bitLength()>a&&this.subTo(BigInteger.ONE.shiftLeft(a-1),this);else{var x=new Array,t=7&a;x.length=1+(a>>3),b.nextBytes(x),0<t?x[0]&=(1<<t)-1:x[0]=0,this.fromString(x,256)}}function bnToByteArray(){var i=this.t,r=new Array;r[0]=this.s;var d,p=this.DB-i*this.DB%8,k=0;if(0<i--)for(p<this.DB&&(d=this[i]>>p)!=(this.s&this.DM)>>p&&(r[k++]=d|this.s<<this.DB-p);0<=i;)p<8?(d=(this[i]&(1<<p)-1)<<8-p,d|=this[--i]>>(p+=this.DB-8)):(d=this[i]>>(p-=8)&255,p<=0&&(p+=this.DB,--i)),0!=(128&d)&&(d|=-256),0==k&&(128&this.s)!=(128&d)&&++k,(0<k||d!=this.s)&&(r[k++]=d);return r}function bnEquals(a){return 0==this.compareTo(a)}function bnMin(a){return this.compareTo(a)<0?this:a}function bnMax(a){return 0<this.compareTo(a)?this:a}function bnpBitwiseTo(a,op,r){var i,f,m=Math.min(a.t,this.t);for(i=0;i<m;++i)r[i]=op(this[i],a[i]);if(a.t<this.t){for(f=a.s&this.DM,i=m;i<this.t;++i)r[i]=op(this[i],f);r.t=this.t}else{for(f=this.s&this.DM,i=m;i<a.t;++i)r[i]=op(f,a[i]);r.t=a.t}r.s=op(this.s,a.s),r.clamp()}function op_and(x,y){return x&y}function bnAnd(a){var r=nbi();return this.bitwiseTo(a,op_and,r),r}function op_or(x,y){return x|y}function bnOr(a){var r=nbi();return this.bitwiseTo(a,op_or,r),r}function op_xor(x,y){return x^y}function bnXor(a){var r=nbi();return this.bitwiseTo(a,op_xor,r),r}function op_andnot(x,y){return x&~y}function bnAndNot(a){var r=nbi();return this.bitwiseTo(a,op_andnot,r),r}function bnNot(){for(var r=nbi(),i=0;i<this.t;++i)r[i]=this.DM&~this[i];return r.t=this.t,r.s=~this.s,r}function bnShiftLeft(n){var r=nbi();return n<0?this.rShiftTo(-n,r):this.lShiftTo(n,r),r}function bnShiftRight(n){var r=nbi();return n<0?this.lShiftTo(-n,r):this.rShiftTo(n,r),r}function lbit(x){if(0==x)return-1;var r=0;return 0==(65535&x)&&(x>>=16,r+=16),0==(255&x)&&(x>>=8,r+=8),0==(15&x)&&(x>>=4,r+=4),0==(3&x)&&(x>>=2,r+=2),0==(1&x)&&++r,r}function bnGetLowestSetBit(){for(var i=0;i<this.t;++i)if(0!=this[i])return i*this.DB+lbit(this[i]);return this.s<0?this.t*this.DB:-1}function cbit(x){for(var r=0;0!=x;)x&=x-1,++r;return r}function bnBitCount(){for(var r=0,x=this.s&this.DM,i=0;i<this.t;++i)r+=cbit(this[i]^x);return r}function bnTestBit(n){var j=Math.floor(n/this.DB);return j>=this.t?0!=this.s:0!=(this[j]&1<<n%this.DB)}function bnpChangeBit(n,op){var r=BigInteger.ONE.shiftLeft(n);return this.bitwiseTo(r,op,r),r}function bnSetBit(n){return this.changeBit(n,op_or)}function bnClearBit(n){return this.changeBit(n,op_andnot)}function bnFlipBit(n){return this.changeBit(n,op_xor)}function bnpAddTo(a,r){for(var i=0,c=0,m=Math.min(a.t,this.t);i<m;)c+=this[i]+a[i],r[i++]=c&this.DM,c>>=this.DB;if(a.t<this.t){for(c+=a.s;i<this.t;)c+=this[i],r[i++]=c&this.DM,c>>=this.DB;c+=this.s}else{for(c+=this.s;i<a.t;)c+=a[i],r[i++]=c&this.DM,c>>=this.DB;c+=a.s}r.s=c<0?-1:0,0<c?r[i++]=c:c<-1&&(r[i++]=this.DV+c),r.t=i,r.clamp()}function bnAdd(a){var r=nbi();return this.addTo(a,r),r}function bnSubtract(a){var r=nbi();return this.subTo(a,r),r}function bnMultiply(a){var r=nbi();return this.multiplyTo(a,r),r}function bnSquare(){var r=nbi();return this.squareTo(r),r}function bnDivide(a){var r=nbi();return this.divRemTo(a,r,null),r}function bnRemainder(a){var r=nbi();return this.divRemTo(a,null,r),r}function bnDivideAndRemainder(a){var q=nbi(),r=nbi();return this.divRemTo(a,q,r),new Array(q,r)}function bnpDMultiply(n){this[this.t]=this.am(0,n-1,this,0,0,this.t),++this.t,this.clamp()}function bnpDAddOffset(n,w){if(0!=n){for(;this.t<=w;)this[this.t++]=0;for(this[w]+=n;this[w]>=this.DV;)this[w]-=this.DV,++w>=this.t&&(this[this.t++]=0),++this[w]}}function NullExp(){}function nNop(x){return x}function nMulTo(x,y,r){x.multiplyTo(y,r)}function nSqrTo(x,r){x.squareTo(r)}function bnPow(e){return this.exp(e,new NullExp)}function bnpMultiplyLowerTo(a,n,r){var j,i=Math.min(this.t+a.t,n);for(r.s=0,r.t=i;0<i;)r[--i]=0;for(j=r.t-this.t;i<j;++i)r[i+this.t]=this.am(0,a[i],r,i,0,this.t);for(j=Math.min(a.t,n);i<j;++i)this.am(0,a[i],r,i,0,n-i);r.clamp()}function bnpMultiplyUpperTo(a,n,r){--n;var i=r.t=this.t+a.t-n;for(r.s=0;0<=--i;)r[i]=0;for(i=Math.max(n-this.t,0);i<a.t;++i)r[this.t+i-n]=this.am(n-i,a[i],r,0,0,this.t+i-n);r.clamp(),r.drShiftTo(1,r)}function Barrett(m){this.r2=nbi(),this.q3=nbi(),BigInteger.ONE.dlShiftTo(2*m.t,this.r2),this.mu=this.r2.divide(m),this.m=m}function barrettConvert(x){if(x.s<0||x.t>2*this.m.t)return x.mod(this.m);if(x.compareTo(this.m)<0)return x;var r=nbi();return x.copyTo(r),this.reduce(r),r}function barrettRevert(x){return x}function barrettReduce(x){for(x.drShiftTo(this.m.t-1,this.r2),x.t>this.m.t+1&&(x.t=this.m.t+1,x.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);x.compareTo(this.r2)<0;)x.dAddOffset(1,this.m.t+1);for(x.subTo(this.r2,x);0<=x.compareTo(this.m);)x.subTo(this.m,x)}function barrettSqrTo(x,r){x.squareTo(r),this.reduce(r)}function barrettMulTo(x,y,r){x.multiplyTo(y,r),this.reduce(r)}function bnModPow(e,m){var k,z,i=e.bitLength(),r=nbv(1);if(i<=0)return r;k=i<18?1:i<48?3:i<144?4:i<768?5:6,z=i<8?new Classic(m):m.isEven()?new Barrett(m):new Montgomery(m);var g=new Array,n=3,k1=k-1,km=(1<<k)-1;if(g[1]=z.convert(this),1<k){var g2=nbi();for(z.sqrTo(g[1],g2);n<=km;)g[n]=nbi(),z.mulTo(g2,g[n-2],g[n]),n+=2}var w,t,j=e.t-1,is1=!0,r2=nbi();for(i=nbits(e[j])-1;0<=j;){for(k1<=i?w=e[j]>>i-k1&km:(w=(e[j]&(1<<i+1)-1)<<k1-i,0<j&&(w|=e[j-1]>>this.DB+i-k1)),n=k;0==(1&w);)w>>=1,--n;if((i-=n)<0&&(i+=this.DB,--j),is1)g[w].copyTo(r),is1=!1;else{for(;1<n;)z.sqrTo(r,r2),z.sqrTo(r2,r),n-=2;0<n?z.sqrTo(r,r2):(t=r,r=r2,r2=t),z.mulTo(r2,g[w],r)}for(;0<=j&&0==(e[j]&1<<i);)z.sqrTo(r,r2),t=r,r=r2,r2=t,--i<0&&(i=this.DB-1,--j)}return z.revert(r)}function bnGCD(a){var x=this.s<0?this.negate():this.clone(),y=a.s<0?a.negate():a.clone();if(x.compareTo(y)<0){var t=x;x=y,y=t}var i=x.getLowestSetBit(),g=y.getLowestSetBit();if(g<0)return x;for(i<g&&(g=i),0<g&&(x.rShiftTo(g,x),y.rShiftTo(g,y));0<x.signum();)0<(i=x.getLowestSetBit())&&x.rShiftTo(i,x),0<(i=y.getLowestSetBit())&&y.rShiftTo(i,y),0<=x.compareTo(y)?(x.subTo(y,x),x.rShiftTo(1,x)):(y.subTo(x,y),y.rShiftTo(1,y));return 0<g&&y.lShiftTo(g,y),y}function bnpModInt(n){if(n<=0)return 0;var d=this.DV%n,r=this.s<0?n-1:0;if(0<this.t)if(0==d)r=this[0]%n;else for(var i=this.t-1;0<=i;--i)r=(d*r+this[i])%n;return r}function bnModInverse(m){var ac=m.isEven();if(this.isEven()&&ac||0==m.signum())return BigInteger.ZERO;for(var u=m.clone(),v=this.clone(),a=nbv(1),b=nbv(0),c=nbv(0),d=nbv(1);0!=u.signum();){for(;u.isEven();)u.rShiftTo(1,u),ac?(a.isEven()&&b.isEven()||(a.addTo(this,a),b.subTo(m,b)),a.rShiftTo(1,a)):b.isEven()||b.subTo(m,b),b.rShiftTo(1,b);for(;v.isEven();)v.rShiftTo(1,v),ac?(c.isEven()&&d.isEven()||(c.addTo(this,c),d.subTo(m,d)),c.rShiftTo(1,c)):d.isEven()||d.subTo(m,d),d.rShiftTo(1,d);0<=u.compareTo(v)?(u.subTo(v,u),ac&&a.subTo(c,a),b.subTo(d,b)):(v.subTo(u,v),ac&&c.subTo(a,c),d.subTo(b,d))}return 0!=v.compareTo(BigInteger.ONE)?BigInteger.ZERO:0<=d.compareTo(m)?d.subtract(m):d.signum()<0?(d.addTo(m,d),d.signum()<0?d.add(m):d):d}Classic.prototype.convert=cConvert,Classic.prototype.revert=cRevert,Classic.prototype.reduce=cReduce,Classic.prototype.mulTo=cMulTo,Classic.prototype.sqrTo=cSqrTo,Montgomery.prototype.convert=montConvert,Montgomery.prototype.revert=montRevert,Montgomery.prototype.reduce=montReduce,Montgomery.prototype.mulTo=montMulTo,Montgomery.prototype.sqrTo=montSqrTo,BigInteger.prototype.copyTo=bnpCopyTo,BigInteger.prototype.fromInt=bnpFromInt,BigInteger.prototype.fromString=bnpFromString,BigInteger.prototype.clamp=bnpClamp,BigInteger.prototype.dlShiftTo=bnpDLShiftTo,BigInteger.prototype.drShiftTo=bnpDRShiftTo,BigInteger.prototype.lShiftTo=bnpLShiftTo,BigInteger.prototype.rShiftTo=bnpRShiftTo,BigInteger.prototype.subTo=bnpSubTo,BigInteger.prototype.multiplyTo=bnpMultiplyTo,BigInteger.prototype.squareTo=bnpSquareTo,BigInteger.prototype.divRemTo=bnpDivRemTo,BigInteger.prototype.invDigit=bnpInvDigit,BigInteger.prototype.isEven=bnpIsEven,BigInteger.prototype.exp=bnpExp,BigInteger.prototype.toString=bnToString,BigInteger.prototype.negate=bnNegate,BigInteger.prototype.abs=bnAbs,BigInteger.prototype.compareTo=bnCompareTo,BigInteger.prototype.bitLength=bnBitLength,BigInteger.prototype.mod=bnMod,BigInteger.prototype.modPowInt=bnModPowInt,BigInteger.ZERO=nbv(0),BigInteger.ONE=nbv(1),NullExp.prototype.convert=nNop,NullExp.prototype.revert=nNop,NullExp.prototype.mulTo=nMulTo,NullExp.prototype.sqrTo=nSqrTo,Barrett.prototype.convert=barrettConvert,Barrett.prototype.revert=barrettRevert,Barrett.prototype.reduce=barrettReduce,Barrett.prototype.mulTo=barrettMulTo,Barrett.prototype.sqrTo=barrettSqrTo;var lowprimes=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],lplim=(1<<26)/lowprimes[lowprimes.length-1];function bnIsProbablePrime(t){var i,x=this.abs();if(1==x.t&&x[0]<=lowprimes[lowprimes.length-1]){for(i=0;i<lowprimes.length;++i)if(x[0]==lowprimes[i])return!0;return!1}if(x.isEven())return!1;for(i=1;i<lowprimes.length;){for(var m=lowprimes[i],j=i+1;j<lowprimes.length&&m<lplim;)m*=lowprimes[j++];for(m=x.modInt(m);i<j;)if(m%lowprimes[i++]==0)return!1}return x.millerRabin(t)}function bnpMillerRabin(t){var n1=this.subtract(BigInteger.ONE),k=n1.getLowestSetBit();if(k<=0)return!1;var r=n1.shiftRight(k);(t=t+1>>1)>lowprimes.length&&(t=lowprimes.length);for(var a=nbi(),i=0;i<t;++i){a.fromInt(lowprimes[Math.floor(Math.random()*lowprimes.length)]);var y=a.modPow(r,this);if(0!=y.compareTo(BigInteger.ONE)&&0!=y.compareTo(n1)){for(var j=1;j++<k&&0!=y.compareTo(n1);)if(0==(y=y.modPowInt(2,this)).compareTo(BigInteger.ONE))return!1;if(0!=y.compareTo(n1))return!1}}return!0}function ECFieldElementFp(q,x){this.x=x,this.q=q}function feFpEquals(other){return other==this||this.q.equals(other.q)&&this.x.equals(other.x)}function feFpToBigInteger(){return this.x}function feFpNegate(){return new ECFieldElementFp(this.q,this.x.negate().mod(this.q))}function feFpAdd(b){return new ECFieldElementFp(this.q,this.x.add(b.toBigInteger()).mod(this.q))}function feFpSubtract(b){return new ECFieldElementFp(this.q,this.x.subtract(b.toBigInteger()).mod(this.q))}function feFpMultiply(b){return new ECFieldElementFp(this.q,this.x.multiply(b.toBigInteger()).mod(this.q))}function feFpSquare(){return new ECFieldElementFp(this.q,this.x.square().mod(this.q))}function feFpDivide(b){return new ECFieldElementFp(this.q,this.x.multiply(b.toBigInteger().modInverse(this.q)).mod(this.q))}function ECPointFp(curve,x,y,z){this.curve=curve,this.x=x,this.y=y,this.z=null==z?BigInteger.ONE:z,this.zinv=null}function pointFpGetX(){return null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.x.toBigInteger().multiply(this.zinv).mod(this.curve.q))}function pointFpGetY(){return null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.y.toBigInteger().multiply(this.zinv).mod(this.curve.q))}function pointFpEquals(other){return other==this||(this.isInfinity()?other.isInfinity():other.isInfinity()?this.isInfinity():!!other.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(other.z)).mod(this.curve.q).equals(BigInteger.ZERO)&&other.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(other.z)).mod(this.curve.q).equals(BigInteger.ZERO))}function pointFpIsInfinity(){return null==this.x&&null==this.y||this.z.equals(BigInteger.ZERO)&&!this.y.toBigInteger().equals(BigInteger.ZERO)}function pointFpNegate(){return new ECPointFp(this.curve,this.x,this.y.negate(),this.z)}function pointFpAdd(b){if(this.isInfinity())return b;if(b.isInfinity())return this;var u=b.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(b.z)).mod(this.curve.q),v=b.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(b.z)).mod(this.curve.q);if(BigInteger.ZERO.equals(v))return BigInteger.ZERO.equals(u)?this.twice():this.curve.getInfinity();var THREE=new BigInteger("3"),x1=this.x.toBigInteger(),y1=this.y.toBigInteger(),v2=(b.x.toBigInteger(),b.y.toBigInteger(),v.square()),v3=v2.multiply(v),x1v2=x1.multiply(v2),zu2=u.square().multiply(this.z),x3=zu2.subtract(x1v2.shiftLeft(1)).multiply(b.z).subtract(v3).multiply(v).mod(this.curve.q),y3=x1v2.multiply(THREE).multiply(u).subtract(y1.multiply(v3)).subtract(zu2.multiply(u)).multiply(b.z).add(u.multiply(v3)).mod(this.curve.q),z3=v3.multiply(this.z).multiply(b.z).mod(this.curve.q);return new ECPointFp(this.curve,this.curve.fromBigInteger(x3),this.curve.fromBigInteger(y3),z3)}function pointFpTwice(){if(this.isInfinity())return this;if(0==this.y.toBigInteger().signum())return this.curve.getInfinity();var THREE=new BigInteger("3"),x1=this.x.toBigInteger(),y1=this.y.toBigInteger(),y1z1=y1.multiply(this.z),y1sqz1=y1z1.multiply(y1).mod(this.curve.q),a=this.curve.a.toBigInteger(),w=x1.square().multiply(THREE);BigInteger.ZERO.equals(a)||(w=w.add(this.z.square().multiply(a)));var x3=(w=w.mod(this.curve.q)).square().subtract(x1.shiftLeft(3).multiply(y1sqz1)).shiftLeft(1).multiply(y1z1).mod(this.curve.q),y3=w.multiply(THREE).multiply(x1).subtract(y1sqz1.shiftLeft(1)).shiftLeft(2).multiply(y1sqz1).subtract(w.square().multiply(w)).mod(this.curve.q),z3=y1z1.square().multiply(y1z1).shiftLeft(3).mod(this.curve.q);return new ECPointFp(this.curve,this.curve.fromBigInteger(x3),this.curve.fromBigInteger(y3),z3)}function pointFpMultiply(k){if(this.isInfinity())return this;if(0==k.signum())return this.curve.getInfinity();var i,e=k,h=e.multiply(new BigInteger("3")),neg=this.negate(),R=this;for(i=h.bitLength()-2;0<i;--i){R=R.twice();var hBit=h.testBit(i);hBit!=e.testBit(i)&&(R=R.add(hBit?this:neg))}return R}function pointFpMultiplyTwo(j,x,k){var i;i=j.bitLength()>k.bitLength()?j.bitLength()-1:k.bitLength()-1;for(var R=this.curve.getInfinity(),both=this.add(x);0<=i;)R=R.twice(),j.testBit(i)?R=k.testBit(i)?R.add(both):R.add(this):k.testBit(i)&&(R=R.add(x)),--i;return R}function ECCurveFp(q,a,b){this.q=q,this.a=this.fromBigInteger(a),this.b=this.fromBigInteger(b),this.infinity=new ECPointFp(this,null,null)}function curveFpGetQ(){return this.q}function curveFpGetA(){return this.a}function curveFpGetB(){return this.b}function curveFpEquals(other){return other==this||this.q.equals(other.q)&&this.a.equals(other.a)&&this.b.equals(other.b)}function curveFpGetInfinity(){return this.infinity}function curveFpFromBigInteger(x){return new ECFieldElementFp(this.q,x)}function curveFpDecodePointHex(s){switch(parseInt(s.substr(0,2),16)){case 0:return this.infinity;case 2:case 3:return null;case 4:case 6:case 7:var len=(s.length-2)/2,xHex=s.substr(2,len),yHex=s.substr(len+2,len);return new ECPointFp(this,this.fromBigInteger(new BigInteger(xHex,16)),this.fromBigInteger(new BigInteger(yHex,16)));default:return null}}function parseBigInt(str,r){return new BigInteger(str,r)}function linebrk(s,n){for(var ret="",i=0;i+n<s.length;)ret+=s.substring(i,i+n)+"\n",i+=n;return ret+s.substring(i,s.length)}function byte2Hex(b){return b<16?"0"+b.toString(16):b.toString(16)}function pkcs1pad2(s,n){if(n<s.length+11)throw"Message too long for RSA";for(var ba=new Array,i=s.length-1;0<=i&&0<n;){var c=s.charCodeAt(i--);c<128?ba[--n]=c:127<c&&c<2048?(ba[--n]=63&c|128,ba[--n]=c>>6|192):(ba[--n]=63&c|128,ba[--n]=c>>6&63|128,ba[--n]=c>>12|224)}ba[--n]=0;for(var rng=new SecureRandom,x=new Array;2<n;){for(x[0]=0;0==x[0];)rng.nextBytes(x);ba[--n]=x[0]}return ba[--n]=2,ba[--n]=0,new BigInteger(ba)}function oaep_mgf1_arr(seed,len,hash){for(var mask="",i=0;mask.length<len;)mask+=hash(String.fromCharCode.apply(String,seed.concat([(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i]))),i+=1;return mask}function oaep_pad(s,n,hash,hashLen){var MD=KJUR.crypto.MessageDigest,Util=KJUR.crypto.Util,algName=null;if(hash||(hash="sha1"),"string"==typeof hash&&(algName=MD.getCanonicalAlgName(hash),hashLen=MD.getHashLength(algName),hash=function(s){return hextorstr(Util.hashHex(rstrtohex(s),algName))}),s.length+2*hashLen+2>n)throw"Message too long for RSA";var i,PS="";for(i=0;i<n-s.length-2*hashLen-2;i+=1)PS+="\0";var DB=hash("")+PS+""+s,seed=new Array(hashLen);(new SecureRandom).nextBytes(seed);var dbMask=oaep_mgf1_arr(seed,DB.length,hash),maskedDB=[];for(i=0;i<DB.length;i+=1)maskedDB[i]=DB.charCodeAt(i)^dbMask.charCodeAt(i);var seedMask=oaep_mgf1_arr(maskedDB,seed.length,hash),maskedSeed=[0];for(i=0;i<seed.length;i+=1)maskedSeed[i+1]=seed[i]^seedMask.charCodeAt(i);return new BigInteger(maskedSeed.concat(maskedDB))}function RSAKey(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}function RSASetPublic(N,E){if(this.isPublic=!0,this.isPrivate=!1,"string"!=typeof N)this.n=N,this.e=E;else{if(!(null!=N&&null!=E&&0<N.length&&0<E.length))throw"Invalid RSA public key";this.n=parseBigInt(N,16),this.e=parseInt(E,16)}}function RSADoPublic(x){return x.modPowInt(this.e,this.n)}function RSAEncrypt(text){var m=pkcs1pad2(text,this.n.bitLength()+7>>3);if(null==m)return null;var c=this.doPublic(m);if(null==c)return null;var h=c.toString(16);return 0==(1&h.length)?h:"0"+h}function RSAEncryptOAEP(text,hash,hashLen){var m=oaep_pad(text,this.n.bitLength()+7>>3,hash,hashLen);if(null==m)return null;var c=this.doPublic(m);if(null==c)return null;var h=c.toString(16);return 0==(1&h.length)?h:"0"+h}function pkcs1unpad2(d,n){for(var b=d.toByteArray(),i=0;i<b.length&&0==b[i];)++i;if(b.length-i!=n-1||2!=b[i])return null;for(++i;0!=b[i];)if(++i>=b.length)return null;for(var ret="";++i<b.length;){var c=255&b[i];c<128?ret+=String.fromCharCode(c):191<c&&c<224?(ret+=String.fromCharCode((31&c)<<6|63&b[i+1]),++i):(ret+=String.fromCharCode((15&c)<<12|(63&b[i+1])<<6|63&b[i+2]),i+=2)}return ret}function oaep_mgf1_str(seed,len,hash){for(var mask="",i=0;mask.length<len;)mask+=hash(seed+String.fromCharCode.apply(String,[(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i])),i+=1;return mask}function oaep_unpad(d,n,hash,hashLen){var MD=KJUR.crypto.MessageDigest,Util=KJUR.crypto.Util,algName=null;for(hash||(hash="sha1"),"string"==typeof hash&&(algName=MD.getCanonicalAlgName(hash),hashLen=MD.getHashLength(algName),hash=function(s){return hextorstr(Util.hashHex(rstrtohex(s),algName))}),d=d.toByteArray(),i=0;i<d.length;i+=1)d[i]&=255;for(;d.length<n;)d.unshift(0);if((d=String.fromCharCode.apply(String,d)).length<2*hashLen+2)throw"Cipher too short";var i,maskedSeed=d.substr(1,hashLen),maskedDB=d.substr(hashLen+1),seedMask=oaep_mgf1_str(maskedDB,hashLen,hash),seed=[];for(i=0;i<maskedSeed.length;i+=1)seed[i]=maskedSeed.charCodeAt(i)^seedMask.charCodeAt(i);var dbMask=oaep_mgf1_str(String.fromCharCode.apply(String,seed),d.length-hashLen,hash),DB=[];for(i=0;i<maskedDB.length;i+=1)DB[i]=maskedDB.charCodeAt(i)^dbMask.charCodeAt(i);if((DB=String.fromCharCode.apply(String,DB)).substr(0,hashLen)!==hash(""))throw"Hash mismatch";var first_one=(DB=DB.substr(hashLen)).indexOf("");if((-1!=first_one?DB.substr(0,first_one).lastIndexOf("\0"):-1)+1!=first_one)throw"Malformed data";return DB.substr(first_one+1)}function RSASetPrivate(N,E,D){if(this.isPrivate=!0,"string"!=typeof N)this.n=N,this.e=E,this.d=D;else{if(!(null!=N&&null!=E&&0<N.length&&0<E.length))throw"Invalid RSA private key";this.n=parseBigInt(N,16),this.e=parseInt(E,16),this.d=parseBigInt(D,16)}}function RSASetPrivateEx(N,E,D,P,Q,DP,DQ,C){if(this.isPrivate=!0,this.isPublic=!1,null==N)throw"RSASetPrivateEx N == null";if(null==E)throw"RSASetPrivateEx E == null";if(0==N.length)throw"RSASetPrivateEx N.length == 0";if(0==E.length)throw"RSASetPrivateEx E.length == 0";if(!(null!=N&&null!=E&&0<N.length&&0<E.length))throw"Invalid RSA private key in RSASetPrivateEx";this.n=parseBigInt(N,16),this.e=parseInt(E,16),this.d=parseBigInt(D,16),this.p=parseBigInt(P,16),this.q=parseBigInt(Q,16),this.dmp1=parseBigInt(DP,16),this.dmq1=parseBigInt(DQ,16),this.coeff=parseBigInt(C,16)}function RSAGenerate(B,E){var rng=new SecureRandom,qs=B>>1;this.e=parseInt(E,16);for(var ee=new BigInteger(E,16);;){for(;this.p=new BigInteger(B-qs,1,rng),0!=this.p.subtract(BigInteger.ONE).gcd(ee).compareTo(BigInteger.ONE)||!this.p.isProbablePrime(10););for(;this.q=new BigInteger(qs,1,rng),0!=this.q.subtract(BigInteger.ONE).gcd(ee).compareTo(BigInteger.ONE)||!this.q.isProbablePrime(10););if(this.p.compareTo(this.q)<=0){var t=this.p;this.p=this.q,this.q=t}var p1=this.p.subtract(BigInteger.ONE),q1=this.q.subtract(BigInteger.ONE),phi=p1.multiply(q1);if(0==phi.gcd(ee).compareTo(BigInteger.ONE)){this.n=this.p.multiply(this.q),this.d=ee.modInverse(phi),this.dmp1=this.d.mod(p1),this.dmq1=this.d.mod(q1),this.coeff=this.q.modInverse(this.p);break}}this.isPrivate=!0}function RSADoPrivate(x){if(null==this.p||null==this.q)return x.modPow(this.d,this.n);for(var xp=x.mod(this.p).modPow(this.dmp1,this.p),xq=x.mod(this.q).modPow(this.dmq1,this.q);xp.compareTo(xq)<0;)xp=xp.add(this.p);return xp.subtract(xq).multiply(this.coeff).mod(this.p).multiply(this.q).add(xq)}function RSADecrypt(ctext){var c=parseBigInt(ctext,16),m=this.doPrivate(c);return null==m?null:pkcs1unpad2(m,this.n.bitLength()+7>>3)}function RSADecryptOAEP(ctext,hash,hashLen){var c=parseBigInt(ctext,16),m=this.doPrivate(c);return null==m?null:oaep_unpad(m,this.n.bitLength()+7>>3,hash,hashLen)}if(BigInteger.prototype.chunkSize=bnpChunkSize,BigInteger.prototype.toRadix=bnpToRadix,BigInteger.prototype.fromRadix=bnpFromRadix,BigInteger.prototype.fromNumber=bnpFromNumber,BigInteger.prototype.bitwiseTo=bnpBitwiseTo,BigInteger.prototype.changeBit=bnpChangeBit,BigInteger.prototype.addTo=bnpAddTo,BigInteger.prototype.dMultiply=bnpDMultiply,BigInteger.prototype.dAddOffset=bnpDAddOffset,BigInteger.prototype.multiplyLowerTo=bnpMultiplyLowerTo,BigInteger.prototype.multiplyUpperTo=bnpMultiplyUpperTo,BigInteger.prototype.modInt=bnpModInt,BigInteger.prototype.millerRabin=bnpMillerRabin,BigInteger.prototype.clone=bnClone,BigInteger.prototype.intValue=bnIntValue,BigInteger.prototype.byteValue=bnByteValue,BigInteger.prototype.shortValue=bnShortValue,BigInteger.prototype.signum=bnSigNum,BigInteger.prototype.toByteArray=bnToByteArray,BigInteger.prototype.equals=bnEquals,BigInteger.prototype.min=bnMin,BigInteger.prototype.max=bnMax,BigInteger.prototype.and=bnAnd,BigInteger.prototype.or=bnOr,BigInteger.prototype.xor=bnXor,BigInteger.prototype.andNot=bnAndNot,BigInteger.prototype.not=bnNot,BigInteger.prototype.shiftLeft=bnShiftLeft,BigInteger.prototype.shiftRight=bnShiftRight,BigInteger.prototype.getLowestSetBit=bnGetLowestSetBit,BigInteger.prototype.bitCount=bnBitCount,BigInteger.prototype.testBit=bnTestBit,BigInteger.prototype.setBit=bnSetBit,BigInteger.prototype.clearBit=bnClearBit,BigInteger.prototype.flipBit=bnFlipBit,BigInteger.prototype.add=bnAdd,BigInteger.prototype.subtract=bnSubtract,BigInteger.prototype.multiply=bnMultiply,BigInteger.prototype.divide=bnDivide,BigInteger.prototype.remainder=bnRemainder,BigInteger.prototype.divideAndRemainder=bnDivideAndRemainder,BigInteger.prototype.modPow=bnModPow,BigInteger.prototype.modInverse=bnModInverse,BigInteger.prototype.pow=bnPow,BigInteger.prototype.gcd=bnGCD,BigInteger.prototype.isProbablePrime=bnIsProbablePrime,BigInteger.prototype.square=bnSquare,ECFieldElementFp.prototype.equals=feFpEquals,ECFieldElementFp.prototype.toBigInteger=feFpToBigInteger,ECFieldElementFp.prototype.negate=feFpNegate,ECFieldElementFp.prototype.add=feFpAdd,ECFieldElementFp.prototype.subtract=feFpSubtract,ECFieldElementFp.prototype.multiply=feFpMultiply,ECFieldElementFp.prototype.square=feFpSquare,ECFieldElementFp.prototype.divide=feFpDivide,ECPointFp.prototype.getX=pointFpGetX,ECPointFp.prototype.getY=pointFpGetY,ECPointFp.prototype.equals=pointFpEquals,ECPointFp.prototype.isInfinity=pointFpIsInfinity,ECPointFp.prototype.negate=pointFpNegate,ECPointFp.prototype.add=pointFpAdd,ECPointFp.prototype.twice=pointFpTwice,ECPointFp.prototype.multiply=pointFpMultiply,ECPointFp.prototype.multiplyTwo=pointFpMultiplyTwo,ECCurveFp.prototype.getQ=curveFpGetQ,ECCurveFp.prototype.getA=curveFpGetA,ECCurveFp.prototype.getB=curveFpGetB,ECCurveFp.prototype.equals=curveFpEquals,ECCurveFp.prototype.getInfinity=curveFpGetInfinity,ECCurveFp.prototype.fromBigInteger=curveFpFromBigInteger,ECCurveFp.prototype.decodePointHex=curveFpDecodePointHex,ECFieldElementFp.prototype.getByteLength=function(){return Math.floor((this.toBigInteger().bitLength()+7)/8)},ECPointFp.prototype.getEncoded=function(compressed){var integerToBytes=function(i,len){var bytes=i.toByteArrayUnsigned();if(len<bytes.length)bytes=bytes.slice(bytes.length-len);else for(;len>bytes.length;)bytes.unshift(0);return bytes},x=this.getX().toBigInteger(),y=this.getY().toBigInteger(),enc=integerToBytes(x,32);return compressed?y.isEven()?enc.unshift(2):enc.unshift(3):(enc.unshift(4),enc=enc.concat(integerToBytes(y,32))),enc},ECPointFp.decodeFrom=function(curve,enc){enc[0];var dataLen=enc.length-1,xBa=enc.slice(1,1+dataLen/2),yBa=enc.slice(1+dataLen/2,1+dataLen);xBa.unshift(0),yBa.unshift(0);var x=new BigInteger(xBa),y=new BigInteger(yBa);return new ECPointFp(curve,curve.fromBigInteger(x),curve.fromBigInteger(y))},ECPointFp.decodeFromHex=function(curve,encHex){encHex.substr(0,2);var dataLen=encHex.length-2,xHex=encHex.substr(2,dataLen/2),yHex=encHex.substr(2+dataLen/2,dataLen/2),x=new BigInteger(xHex,16),y=new BigInteger(yHex,16);return new ECPointFp(curve,curve.fromBigInteger(x),curve.fromBigInteger(y))},ECPointFp.prototype.add2D=function(b){if(this.isInfinity())return b;if(b.isInfinity())return this;if(this.x.equals(b.x))return this.y.equals(b.y)?this.twice():this.curve.getInfinity();var x_x=b.x.subtract(this.x),gamma=b.y.subtract(this.y).divide(x_x),x3=gamma.square().subtract(this.x).subtract(b.x),y3=gamma.multiply(this.x.subtract(x3)).subtract(this.y);return new ECPointFp(this.curve,x3,y3)},ECPointFp.prototype.twice2D=function(){if(this.isInfinity())return this;if(0==this.y.toBigInteger().signum())return this.curve.getInfinity();var TWO=this.curve.fromBigInteger(BigInteger.valueOf(2)),THREE=this.curve.fromBigInteger(BigInteger.valueOf(3)),gamma=this.x.square().multiply(THREE).add(this.curve.a).divide(this.y.multiply(TWO)),x3=gamma.square().subtract(this.x.multiply(TWO)),y3=gamma.multiply(this.x.subtract(x3)).subtract(this.y);return new ECPointFp(this.curve,x3,y3)},ECPointFp.prototype.multiply2D=function(k){if(this.isInfinity())return this;if(0==k.signum())return this.curve.getInfinity();var i,e=k,h=e.multiply(new BigInteger("3")),neg=this.negate(),R=this;for(i=h.bitLength()-2;0<i;--i){R=R.twice();var hBit=h.testBit(i);hBit!=e.testBit(i)&&(R=R.add2D(hBit?this:neg))}return R},ECPointFp.prototype.isOnCurve=function(){var x=this.getX().toBigInteger(),y=this.getY().toBigInteger(),a=this.curve.getA().toBigInteger(),b=this.curve.getB().toBigInteger(),n=this.curve.getQ(),lhs=y.multiply(y).mod(n),rhs=x.multiply(x).multiply(x).add(a.multiply(x)).add(b).mod(n);return lhs.equals(rhs)},ECPointFp.prototype.toString=function(){return"("+this.getX().toBigInteger().toString()+","+this.getY().toBigInteger().toString()+")"},ECPointFp.prototype.validate=function(){var n=this.curve.getQ();if(this.isInfinity())throw new Error("Point is at infinity.");var x=this.getX().toBigInteger(),y=this.getY().toBigInteger();if(x.compareTo(BigInteger.ONE)<0||0<x.compareTo(n.subtract(BigInteger.ONE)))throw new Error("x coordinate out of bounds");if(y.compareTo(BigInteger.ONE)<0||0<y.compareTo(n.subtract(BigInteger.ONE)))throw new Error("y coordinate out of bounds");if(!this.isOnCurve())throw new Error("Point is not on the curve.");if(this.multiply(n).isInfinity())throw new Error("Point is not a scalar multiple of G.");return!0},RSAKey.prototype.doPublic=RSADoPublic,RSAKey.prototype.setPublic=RSASetPublic,RSAKey.prototype.encrypt=RSAEncrypt,RSAKey.prototype.encryptOAEP=RSAEncryptOAEP,RSAKey.prototype.type="RSA",RSAKey.prototype.doPrivate=RSADoPrivate,RSAKey.prototype.setPrivate=RSASetPrivate,RSAKey.prototype.setPrivateEx=RSASetPrivateEx,RSAKey.prototype.generate=RSAGenerate,RSAKey.prototype.decrypt=RSADecrypt,RSAKey.prototype.decryptOAEP=RSADecryptOAEP,YAHOO===undefined)var YAHOO={};YAHOO.lang={extend:function(subc,superc,overrides){if(!superc||!subc)throw new Error("YAHOO.lang.extend failed, please check that all dependencies are included.");var F=function(){};if(F.prototype=superc.prototype,subc.prototype=new F,(subc.prototype.constructor=subc).superclass=superc.prototype,superc.prototype.constructor==Object.prototype.constructor&&(superc.prototype.constructor=superc),overrides){var i;for(i in overrides)subc.prototype[i]=overrides[i];var _IEEnumFix=function(){},ADD=["toString","valueOf"];try{/MSIE/.test(navigator.userAgent)&&(_IEEnumFix=function(r,s){for(i=0;i<ADD.length;i+=1){var fname=ADD[i],f=s[fname];"function"==typeof f&&f!=Object.prototype[fname]&&(r[fname]=f)}})}catch(ex){}_IEEnumFix(subc.prototype,overrides)}}};var KJUR,utf8tob64u,b64utoutf8,jsonParse=function(){var jsonToken=new RegExp('(?:false|true|null|[\\{\\}\\[\\]]|(?:-?\\b(?:0|[1-9][0-9]*)(?:\\.[0-9]+)?(?:[eE][+-]?[0-9]+)?\\b)|(?:"(?:[^\\0-\\x08\\x0a-\\x1f"\\\\]|\\\\(?:["/\\\\bfnrt]|u[0-9A-Fa-f]{4}))*"))',"g"),escapeSequence=new RegExp("\\\\(?:([^u])|u(.{4}))","g"),escapes={'"':'"',"/":"/","\\":"\\",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};function unescapeOne(_,ch,hex){return ch?escapes[ch]:String.fromCharCode(parseInt(hex,16))}var EMPTY_STRING=new String(""),hop=(Object,Array,Object.hasOwnProperty);return function(json,opt_reviver){var result,key,toks=json.match(jsonToken),tok=toks[0],topLevelPrimitive=!1;"{"===tok?result={}:"["===tok?result=[]:(result=[],topLevelPrimitive=!0);for(var stack=[result],i=1-topLevelPrimitive,n=toks.length;i<n;++i){var cont;switch((tok=toks[i]).charCodeAt(0)){default:(cont=stack[0])[key||cont.length]=+tok,key=void 0;break;case 34:if(-1!==(tok=tok.substring(1,tok.length-1)).indexOf("\\")&&(tok=tok.replace(escapeSequence,unescapeOne)),cont=stack[0],!key){if(!(cont instanceof Array)){key=tok||EMPTY_STRING;break}key=cont.length}cont[key]=tok,key=void 0;break;case 91:cont=stack[0],stack.unshift(cont[key||cont.length]=[]),key=void 0;break;case 93:stack.shift();break;case 102:(cont=stack[0])[key||cont.length]=!1,key=void 0;break;case 110:(cont=stack[0])[key||cont.length]=null,key=void 0;break;case 116:(cont=stack[0])[key||cont.length]=!0,key=void 0;break;case 123:cont=stack[0],stack.unshift(cont[key||cont.length]={}),key=void 0;break;case 125:stack.shift()}}if(topLevelPrimitive){if(1!==stack.length)throw new Error;result=result[0]}else if(stack.length)throw new Error;if(opt_reviver){var walk=function(holder,key){var value=holder[key];if(value&&"object"==typeof value){var toDelete=null;for(var k in value)if(hop.call(value,k)&&value!==holder){var v=walk(value,k);void 0!==v?value[k]=v:(toDelete||(toDelete=[]),toDelete.push(k))}if(toDelete)for(var i=toDelete.length;0<=--i;)delete value[toDelete[i]]}return opt_reviver.call(holder,key,value)};result=walk({"":result},"")}return result}}();CryptoJS=CryptoJS||function(Math,undefined){var C={},C_lib=C.lib={},Base=C_lib.Base=function(){function F(){}return{extend:function(overrides){F.prototype=this;var subtype=new F;return overrides&&subtype.mixIn(overrides),subtype.hasOwnProperty("init")||(subtype.init=function(){subtype.$super.init.apply(this,arguments)}),(subtype.init.prototype=subtype).$super=this,subtype},create:function(){var instance=this.extend();return instance.init.apply(instance,arguments),instance},init:function(){},mixIn:function(properties){for(var propertyName in properties)properties.hasOwnProperty(propertyName)&&(this[propertyName]=properties[propertyName]);properties.hasOwnProperty("toString")&&(this.toString=properties.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),WordArray=C_lib.WordArray=Base.extend({init:function(words,sigBytes){words=this.words=words||[],this.sigBytes=null!=sigBytes?sigBytes:4*words.length},toString:function(encoder){return(encoder||Hex).stringify(this)},concat:function(wordArray){var thisWords=this.words,thatWords=wordArray.words,thisSigBytes=this.sigBytes,thatSigBytes=wordArray.sigBytes;if(this.clamp(),thisSigBytes%4)for(var i=0;i<thatSigBytes;i++){var thatByte=thatWords[i>>>2]>>>24-i%4*8&255;thisWords[thisSigBytes+i>>>2]|=thatByte<<24-(thisSigBytes+i)%4*8}else for(i=0;i<thatSigBytes;i+=4)thisWords[thisSigBytes+i>>>2]=thatWords[i>>>2];return this.sigBytes+=thatSigBytes,this},clamp:function(){var words=this.words,sigBytes=this.sigBytes;words[sigBytes>>>2]&=4294967295<<32-sigBytes%4*8,words.length=Math.ceil(sigBytes/4)},clone:function(){var clone=Base.clone.call(this);return clone.words=this.words.slice(0),clone},random:function(nBytes){for(var words=[],i=0;i<nBytes;i+=4)words.push(4294967296*Math.random()|0);return new WordArray.init(words,nBytes)}}),C_enc=C.enc={},Hex=C_enc.Hex={stringify:function(wordArray){for(var words=wordArray.words,sigBytes=wordArray.sigBytes,hexChars=[],i=0;i<sigBytes;i++){var bite=words[i>>>2]>>>24-i%4*8&255;hexChars.push((bite>>>4).toString(16)),hexChars.push((15&bite).toString(16))}return hexChars.join("")},parse:function(hexStr){for(var hexStrLength=hexStr.length,words=[],i=0;i<hexStrLength;i+=2)words[i>>>3]|=parseInt(hexStr.substr(i,2),16)<<24-i%8*4;return new WordArray.init(words,hexStrLength/2)}},Latin1=C_enc.Latin1={stringify:function(wordArray){for(var words=wordArray.words,sigBytes=wordArray.sigBytes,latin1Chars=[],i=0;i<sigBytes;i++){var bite=words[i>>>2]>>>24-i%4*8&255;latin1Chars.push(String.fromCharCode(bite))}return latin1Chars.join("")},parse:function(latin1Str){for(var latin1StrLength=latin1Str.length,words=[],i=0;i<latin1StrLength;i++)words[i>>>2]|=(255&latin1Str.charCodeAt(i))<<24-i%4*8;return new WordArray.init(words,latin1StrLength)}},Utf8=C_enc.Utf8={stringify:function(wordArray){try{return decodeURIComponent(escape(Latin1.stringify(wordArray)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(utf8Str){return Latin1.parse(unescape(encodeURIComponent(utf8Str)))}},BufferedBlockAlgorithm=C_lib.BufferedBlockAlgorithm=Base.extend({reset:function(){this._data=new WordArray.init,this._nDataBytes=0},_append:function(data){"string"==typeof data&&(data=Utf8.parse(data)),this._data.concat(data),this._nDataBytes+=data.sigBytes},_process:function(doFlush){var data=this._data,dataWords=data.words,dataSigBytes=data.sigBytes,blockSize=this.blockSize,nBlocksReady=dataSigBytes/(4*blockSize),nWordsReady=(nBlocksReady=doFlush?Math.ceil(nBlocksReady):Math.max((0|nBlocksReady)-this._minBufferSize,0))*blockSize,nBytesReady=Math.min(4*nWordsReady,dataSigBytes);if(nWordsReady){for(var offset=0;offset<nWordsReady;offset+=blockSize)this._doProcessBlock(dataWords,offset);var processedWords=dataWords.splice(0,nWordsReady);data.sigBytes-=nBytesReady}return new WordArray.init(processedWords,nBytesReady)},clone:function(){var clone=Base.clone.call(this);return clone._data=this._data.clone(),clone},_minBufferSize:0}),C_algo=(C_lib.Hasher=BufferedBlockAlgorithm.extend({cfg:Base.extend(),init:function(cfg){this.cfg=this.cfg.extend(cfg),this.reset()},reset:function(){BufferedBlockAlgorithm.reset.call(this),this._doReset()},update:function(messageUpdate){return this._append(messageUpdate),this._process(),this},finalize:function(messageUpdate){return messageUpdate&&this._append(messageUpdate),this._doFinalize()},blockSize:16,_createHelper:function(hasher){return function(message,cfg){return new hasher.init(cfg).finalize(message)}},_createHmacHelper:function(hasher){return function(message,key){return new C_algo.HMAC.init(hasher,key).finalize(message)}}}),C.algo={});return C}(Math);function Base64x(){}function stoBA(s){for(var a=new Array,i=0;i<s.length;i++)a[i]=s.charCodeAt(i);return a}function BAtos(a){for(var s="",i=0;i<a.length;i++)s+=String.fromCharCode(a[i]);return s}function BAtohex(a){try{for(var s="",i=0;i<a.length;i++){var val=a[i];val==undefined&&(val=a.get(i));var hex1=val.toString(16);1==hex1.length&&(hex1="0"+hex1),s+=hex1}}catch(e){console.log(e)}return s}function stohex(s){return BAtohex(stoBA(s))}function stob64(s){return hex2b64(stohex(s))}function stob64u(s){return b64tob64u(hex2b64(stohex(s)))}function b64utos(s){return BAtos(b64toBA(b64utob64(s)))}function b64tob64u(s){return s=(s=(s=s.replace(/\=/g,"")).replace(/\+/g,"-")).replace(/\//g,"_")}function b64utob64(s){return s.length%4==2?s+="==":s.length%4==3&&(s+="="),s=(s=s.replace(/-/g,"+")).replace(/_/g,"/")}function hextob64u(s){return s.length%2==1&&(s="0"+s),b64tob64u(hex2b64(s))}function b64utohex(s){return b64tohex(b64utob64(s))}function utf8tob64(s){return hex2b64(uricmptohex(encodeURIComponentAll(s)))}function b64toutf8(s){return decodeURIComponent(hextouricmp(b64tohex(s)))}function utf8tohex(s){return uricmptohex(encodeURIComponentAll(s))}function hextoutf8(s){return decodeURIComponent(hextouricmp(s))}function hextorstr(sHex){for(var s="",i=0;i<sHex.length-1;i+=2)s+=String.fromCharCode(parseInt(sHex.substr(i,2),16));return s}function rstrtohex(s){for(var result="",i=0;i<s.length;i++)result+=("0"+s.charCodeAt(i).toString(16)).slice(-2);return result}function hextob64(s){return hex2b64(s)}function hextob64nl(s){var b64nl=hextob64(s).replace(/(.{64})/g,"$1\r\n");return b64nl=b64nl.replace(/\r\n$/,"")}function b64nltohex(s){return b64tohex(s.replace(/[^0-9A-Za-z\/+=]*/g,""))}function hextopem(dataHex,pemHeader){return"-----BEGIN "+pemHeader+"-----\r\n"+hextob64nl(dataHex)+"\r\n-----END "+pemHeader+"-----\r\n"}function pemtohex(s,sHead){if(-1==s.indexOf("-----BEGIN "))throw"can't find PEM header: "+sHead;return b64nltohex(s=sHead!==undefined?(s=s.replace("-----BEGIN "+sHead+"-----","")).replace("-----END "+sHead+"-----",""):(s=s.replace(/-----BEGIN [^-]+-----/,"")).replace(/-----END [^-]+-----/,""))}function hextoArrayBuffer(hex){if(hex.length%2!=0)throw"input is not even length";if(null==hex.match(/^[0-9A-Fa-f]+$/))throw"input is not hexadecimal";for(var buffer=new ArrayBuffer(hex.length/2),view=new DataView(buffer),i=0;i<hex.length/2;i++)view.setUint8(i,parseInt(hex.substr(2*i,2),16));return buffer}function ArrayBuffertohex(buffer){for(var hex="",view=new DataView(buffer),i=0;i<buffer.byteLength;i++)hex+=("00"+view.getUint8(i).toString(16)).slice(-2);return hex}function zulutomsec(s){var year,month,day,hour,min,sec,msec,sYear,sFrac,sMsec,matchResult;if(matchResult=s.match(/^(\d{2}|\d{4})(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)(|\.\d+)Z$/))return sYear=matchResult[1],year=parseInt(sYear),2===sYear.length&&(50<=year&&year<100?year=1900+year:0<=year&&year<50&&(year=2e3+year)),month=parseInt(matchResult[2])-1,day=parseInt(matchResult[3]),hour=parseInt(matchResult[4]),min=parseInt(matchResult[5]),sec=parseInt(matchResult[6]),msec=0,""!==(sFrac=matchResult[7])&&(sMsec=(sFrac.substr(1)+"00").substr(0,3),msec=parseInt(sMsec)),Date.UTC(year,month,day,hour,min,sec,msec);throw"unsupported zulu format: "+s}function zulutosec(s){return~~(zulutomsec(s)/1e3)}function zulutodate(s){return new Date(zulutomsec(s))}function datetozulu(d,flagUTCTime,flagMilli){var s,year=d.getUTCFullYear();if(flagUTCTime){if(year<1950||2049<year)throw"not proper year for UTCTime: "+year;s=(""+year).slice(-2)}else s=("000"+year).slice(-4);if(s+=("0"+(d.getUTCMonth()+1)).slice(-2),s+=("0"+d.getUTCDate()).slice(-2),s+=("0"+d.getUTCHours()).slice(-2),s+=("0"+d.getUTCMinutes()).slice(-2),s+=("0"+d.getUTCSeconds()).slice(-2),flagMilli){var milli=d.getUTCMilliseconds();0!==milli&&(s+="."+(milli=(milli=("00"+milli).slice(-3)).replace(/0+$/g,"")))}return s+="Z"}function uricmptohex(s){return s.replace(/%/g,"")}function hextouricmp(s){return s.replace(/(..)/g,"%$1")}function encodeURIComponentAll(u8){for(var s=encodeURIComponent(u8),s2="",i=0;i<s.length;i++)"%"==s.charAt(i)?(s2+=s.substr(i,3),i+=2):s2=s2+"%"+stohex(s.charAt(i));return s2}function newline_toUnix(s){return s=s.replace(/\r\n/gm,"\n")}function newline_toDos(s){return s=(s=s.replace(/\r\n/gm,"\n")).replace(/\n/gm,"\r\n")}function hextoposhex(s){return s.length%2==1?"0"+s:"7"<s.substr(0,1)?"00"+s:s}function intarystrtohex(s){s=(s=(s=s.replace(/^\s*\[\s*/,"")).replace(/\s*\]\s*$/,"")).replace(/\s*/g,"");try{return s.split(/,/).map(function(element,index,array){var i=parseInt(element);if(i<0||255<i)throw"integer not in range 0-255";return("00"+i.toString(16)).slice(-2)}).join("")}catch(ex){throw"malformed integer array string: "+ex}}void 0!==KJUR&&KJUR||(KJUR={}),"undefined"!=typeof KJUR.lang&&KJUR.lang||(KJUR.lang={}),KJUR.lang.String=function(){},b64utoutf8="function"==typeof Buffer?(utf8tob64u=function(s){return b64tob64u(new Buffer(s,"utf8").toString("base64"))},function(s){return new Buffer(b64utob64(s),"base64").toString("utf8")}):(utf8tob64u=function(s){return hextob64u(uricmptohex(encodeURIComponentAll(s)))},function(s){return decodeURIComponent(hextouricmp(b64utohex(s)))}),KJUR.lang.String.isInteger=function(s){return!!s.match(/^[0-9]+$/)||!!s.match(/^-[0-9]+$/)},KJUR.lang.String.isHex=function(s){return!(s.length%2!=0||!s.match(/^[0-9a-f]+$/)&&!s.match(/^[0-9A-F]+$/))},KJUR.lang.String.isBase64=function(s){return!(!(s=s.replace(/\s+/g,"")).match(/^[0-9A-Za-z+\/]+={0,3}$/)||s.length%4!=0)},KJUR.lang.String.isBase64URL=function(s){return!s.match(/[+/=]/)&&(s=b64utob64(s),KJUR.lang.String.isBase64(s))},KJUR.lang.String.isIntegerArray=function(s){return!!(s=s.replace(/\s+/g,"")).match(/^\[[0-9,]+\]$/)};var strdiffidx=function(s1,s2){var n=s1.length;s1.length>s2.length&&(n=s2.length);for(var i=0;i<n;i++)if(s1.charCodeAt(i)!=s2.charCodeAt(i))return i;return s1.length!=s2.length?n:-1};void 0!==KJUR&&KJUR||(KJUR={}),"undefined"!=typeof KJUR.jws&&KJUR.jws||(KJUR.jws={}),KJUR.jws.JWS=function(){var _isSafeJSONString=KJUR.jws.JWS.isSafeJSONString;this.parseJWS=function(sJWS,sigValNotNeeded){if(this.parsedJWS===undefined||!sigValNotNeeded&&this.parsedJWS.sigvalH===undefined){var matchResult=sJWS.match(/^([^.]+)\.([^.]+)\.([^.]+)$/);if(null==matchResult)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";var b6Head=matchResult[1],b6Payload=matchResult[2],b6SigVal=matchResult[3],sSI=b6Head+"."+b6Payload;if(this.parsedJWS={},this.parsedJWS.headB64U=b6Head,this.parsedJWS.payloadB64U=b6Payload,this.parsedJWS.sigvalB64U=b6SigVal,this.parsedJWS.si=sSI,!sigValNotNeeded){var hSigVal=b64utohex(b6SigVal),biSigVal=parseBigInt(hSigVal,16);this.parsedJWS.sigvalH=hSigVal,this.parsedJWS.sigvalBI=biSigVal}var sHead=b64utoutf8(b6Head),sPayload=b64utoutf8(b6Payload);if(this.parsedJWS.headS=sHead,this.parsedJWS.payloadS=sPayload,!_isSafeJSONString(sHead,this.parsedJWS,"headP"))throw"malformed JSON string for JWS Head: "+sHead}}},KJUR.jws.JWS.sign=function(alg,spHeader,spPayload,key,pass){var sHeader,pHeader,sPayload,_KJUR=KJUR,_KJUR_jws_JWS=_KJUR.jws.JWS,_readSafeJSONString=_KJUR_jws_JWS.readSafeJSONString,_isSafeJSONString=_KJUR_jws_JWS.isSafeJSONString,_KJUR_crypto=_KJUR.crypto,_Mac=(_KJUR_crypto.ECDSA,_KJUR_crypto.Mac),_Signature=_KJUR_crypto.Signature,_JSON=JSON;if("string"!=typeof spHeader&&"object"!=typeof spHeader)throw"spHeader must be JSON string or object: "+spHeader;if("object"==typeof spHeader&&(pHeader=spHeader,sHeader=_JSON.stringify(pHeader)),"string"==typeof spHeader){if(!_isSafeJSONString(sHeader=spHeader))throw"JWS Head is not safe JSON string: "+sHeader;pHeader=_readSafeJSONString(sHeader)}if("object"==typeof(sPayload=spPayload)&&(sPayload=_JSON.stringify(spPayload)),""!=alg&&null!=alg||pHeader.alg===undefined||(alg=pHeader.alg),""!=alg&&null!=alg&&pHeader.alg===undefined&&(pHeader.alg=alg,sHeader=_JSON.stringify(pHeader)),alg!==pHeader.alg)throw"alg and sHeader.alg doesn't match: "+alg+"!="+pHeader.alg;var sigAlg=null;if(_KJUR_jws_JWS.jwsalg2sigalg[alg]===undefined)throw"unsupported alg name: "+alg;sigAlg=_KJUR_jws_JWS.jwsalg2sigalg[alg];var uSignatureInput=utf8tob64u(sHeader)+"."+utf8tob64u(sPayload),hSig="";if("Hmac"==sigAlg.substr(0,4)){if(key===undefined)throw"mac key shall be specified for HS* alg";var mac=new _Mac({alg:sigAlg,prov:"cryptojs",pass:key});mac.updateString(uSignatureInput),hSig=mac.doFinal()}else if(-1!=sigAlg.indexOf("withECDSA")){(sig=new _Signature({alg:sigAlg})).init(key,pass),sig.updateString(uSignatureInput),hASN1Sig=sig.sign(),hSig=KJUR.crypto.ECDSA.asn1SigToConcatSig(hASN1Sig)}else if("none"!=sigAlg){var sig;(sig=new _Signature({alg:sigAlg})).init(key,pass),sig.updateString(uSignatureInput),hSig=sig.sign()}return uSignatureInput+"."+hextob64u(hSig)},KJUR.jws.JWS.verify=function(sJWS,key,acceptAlgs){var _RSAKey,_KJUR=KJUR,_KJUR_jws_JWS=_KJUR.jws.JWS,_readSafeJSONString=_KJUR_jws_JWS.readSafeJSONString,_KJUR_crypto=_KJUR.crypto,_ECDSA=_KJUR_crypto.ECDSA,_Mac=_KJUR_crypto.Mac,_Signature=_KJUR_crypto.Signature;typeof RSAKey!==undefined&&(_RSAKey=RSAKey);var a=sJWS.split("."),uSignatureInput=a[0]+"."+a[1],hSig=b64utohex(a[2]),pHeader=_readSafeJSONString(b64utoutf8(a[0])),alg=null,algType=null;if(pHeader.alg===undefined)throw"algorithm not specified in header";if((algType=(alg=pHeader.alg).substr(0,2),null!=acceptAlgs&&"[object Array]"===Object.prototype.toString.call(acceptAlgs)&&0<acceptAlgs.length)&&-1==(":"+acceptAlgs.join(":")+":").indexOf(":"+alg+":"))throw"algorithm '"+alg+"' not accepted in the list";if("none"!=alg&&null===key)throw"key shall be specified to verify.";if("string"==typeof key&&-1!=key.indexOf("-----BEGIN ")&&(key=KEYUTIL.getKey(key)),!("RS"!=algType&&"PS"!=algType||key instanceof _RSAKey))throw"key shall be a RSAKey obj for RS* and PS* algs";if("ES"==algType&&!(key instanceof _ECDSA))throw"key shall be a ECDSA obj for ES* algs";var sigAlg=null;if(_KJUR_jws_JWS.jwsalg2sigalg[pHeader.alg]===undefined)throw"unsupported alg name: "+alg;if("none"==(sigAlg=_KJUR_jws_JWS.jwsalg2sigalg[alg]))throw"not supported";if("Hmac"==sigAlg.substr(0,4)){if(key===undefined)throw"hexadecimal key shall be specified for HMAC";var mac=new _Mac({alg:sigAlg,pass:key});return mac.updateString(uSignatureInput),hSig==mac.doFinal()}if(-1==sigAlg.indexOf("withECDSA"))return(sig=new _Signature({alg:sigAlg})).init(key),sig.updateString(uSignatureInput),sig.verify(hSig);var sig,hASN1Sig=null;try{hASN1Sig=_ECDSA.concatSigToASN1Sig(hSig)}catch(ex){return!1}return(sig=new _Signature({alg:sigAlg})).init(key),sig.updateString(uSignatureInput),sig.verify(hASN1Sig)},KJUR.jws.JWS.parse=function(sJWS){var uHeader,uPayload,uSig,a=sJWS.split("."),result={};if(2!=a.length&&3!=a.length)throw"malformed sJWS: wrong number of '.' splitted elements";return uHeader=a[0],uPayload=a[1],3==a.length&&(uSig=a[2]),result.headerObj=KJUR.jws.JWS.readSafeJSONString(b64utoutf8(uHeader)),result.payloadObj=KJUR.jws.JWS.readSafeJSONString(b64utoutf8(uPayload)),result.headerPP=JSON.stringify(result.headerObj,null,"  "),null==result.payloadObj?result.payloadPP=b64utoutf8(uPayload):result.payloadPP=JSON.stringify(result.payloadObj,null,"  "),uSig!==undefined&&(result.sigHex=b64utohex(uSig)),result},KJUR.jws.JWS.verifyJWT=function(sJWT,key,acceptField){var _KJUR_jws=KJUR.jws,_KJUR_jws_JWS=_KJUR_jws.JWS,_readSafeJSONString=_KJUR_jws_JWS.readSafeJSONString,_inArray=_KJUR_jws_JWS.inArray,_includedArray=_KJUR_jws_JWS.includedArray,a=sJWT.split("."),uHeader=a[0],uPayload=a[1],pHeader=(b64utohex(a[2]),_readSafeJSONString(b64utoutf8(uHeader))),pPayload=_readSafeJSONString(b64utoutf8(uPayload));if(pHeader.alg===undefined)return!1;if(acceptField.alg===undefined)throw"acceptField.alg shall be specified";if(!_inArray(pHeader.alg,acceptField.alg))return!1;if(pPayload.iss!==undefined&&"object"==typeof acceptField.iss&&!_inArray(pPayload.iss,acceptField.iss))return!1;if(pPayload.sub!==undefined&&"object"==typeof acceptField.sub&&!_inArray(pPayload.sub,acceptField.sub))return!1;if(pPayload.aud!==undefined&&"object"==typeof acceptField.aud)if("string"==typeof pPayload.aud){if(!_inArray(pPayload.aud,acceptField.aud))return!1}else if("object"==typeof pPayload.aud&&!_includedArray(pPayload.aud,acceptField.aud))return!1;var now=_KJUR_jws.IntDate.getNow();return acceptField.verifyAt!==undefined&&"number"==typeof acceptField.verifyAt&&(now=acceptField.verifyAt),acceptField.gracePeriod!==undefined&&"number"==typeof acceptField.gracePeriod||(acceptField.gracePeriod=0),!(pPayload.exp!==undefined&&"number"==typeof pPayload.exp&&pPayload.exp+acceptField.gracePeriod<now)&&(!(pPayload.nbf!==undefined&&"number"==typeof pPayload.nbf&&now<pPayload.nbf-acceptField.gracePeriod)&&(!(pPayload.iat!==undefined&&"number"==typeof pPayload.iat&&now<pPayload.iat-acceptField.gracePeriod)&&((pPayload.jti===undefined||acceptField.jti===undefined||pPayload.jti===acceptField.jti)&&!!_KJUR_jws_JWS.verify(sJWT,key,acceptField.alg))))},KJUR.jws.JWS.includedArray=function(a1,a2){var _inArray=KJUR.jws.JWS.inArray;if(null===a1)return!1;if("object"!=typeof a1)return!1;if("number"!=typeof a1.length)return!1;for(var i=0;i<a1.length;i++)if(!_inArray(a1[i],a2))return!1;return!0},KJUR.jws.JWS.inArray=function(item,a){if(null===a)return!1;if("object"!=typeof a)return!1;if("number"!=typeof a.length)return!1;for(var i=0;i<a.length;i++)if(a[i]==item)return!0;return!1},KJUR.jws.JWS.jwsalg2sigalg={HS256:"HmacSHA256",HS384:"HmacSHA384",HS512:"HmacSHA512",RS256:"SHA256withRSA",RS384:"SHA384withRSA",RS512:"SHA512withRSA",ES256:"SHA256withECDSA",ES384:"SHA384withECDSA",PS256:"SHA256withRSAandMGF1",PS384:"SHA384withRSAandMGF1",PS512:"SHA512withRSAandMGF1",none:"none"},KJUR.jws.JWS.isSafeJSONString=function(s,h,p){var o=null;try{return"object"!=typeof(o=jsonParse(s))?0:o.constructor===Array?0:(h&&(h[p]=o),1)}catch(ex){return 0}},KJUR.jws.JWS.readSafeJSONString=function(s){var o=null;try{return"object"!=typeof(o=jsonParse(s))?null:o.constructor===Array?null:o}catch(ex){return null}},KJUR.jws.JWS.getEncodedSignatureValueFromJWS=function(sJWS){var matchResult=sJWS.match(/^[^.]+\.[^.]+\.([^.]+)$/);if(null==matchResult)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";return matchResult[1]},KJUR.jws.JWS.getJWKthumbprint=function(o){if("RSA"!==o.kty&&"EC"!==o.kty&&"oct"!==o.kty)throw"unsupported algorithm for JWK Thumprint";var s="{";if("RSA"===o.kty){if("string"!=typeof o.n||"string"!=typeof o.e)throw"wrong n and e value for RSA key";s+='"e":"'+o.e+'",',s+='"kty":"'+o.kty+'",',s+='"n":"'+o.n+'"}'}else if("EC"===o.kty){if("string"!=typeof o.crv||"string"!=typeof o.x||"string"!=typeof o.y)throw"wrong crv, x and y value for EC key";s+='"crv":"'+o.crv+'",',s+='"kty":"'+o.kty+'",',s+='"x":"'+o.x+'",',s+='"y":"'+o.y+'"}'}else if("oct"===o.kty){if("string"!=typeof o.k)throw"wrong k value for oct(symmetric) key";s+='"kty":"'+o.kty+'",',s+='"k":"'+o.k+'"}'}var hJWK=rstrtohex(s);return hextob64u(KJUR.crypto.Util.hashHex(hJWK,"sha256"))},KJUR.jws.IntDate={},KJUR.jws.IntDate.get=function(s){var _KJUR_jws_IntDate=KJUR.jws.IntDate,_getNow=_KJUR_jws_IntDate.getNow,_getZulu=_KJUR_jws_IntDate.getZulu;if("now"==s)return _getNow();if("now + 1hour"==s)return _getNow()+3600;if("now + 1day"==s)return _getNow()+86400;if("now + 1month"==s)return _getNow()+2592e3;if("now + 1year"==s)return _getNow()+31536e3;if(s.match(/Z$/))return _getZulu(s);if(s.match(/^[0-9]+$/))return parseInt(s);throw"unsupported format: "+s},KJUR.jws.IntDate.getZulu=function(s){return zulutosec(s)},KJUR.jws.IntDate.getNow=function(){return~~(new Date/1e3)},KJUR.jws.IntDate.intDate2UTCString=function(intDate){return new Date(1e3*intDate).toUTCString()},KJUR.jws.IntDate.intDate2Zulu=function(intDate){var d=new Date(1e3*intDate);return("0000"+d.getUTCFullYear()).slice(-4)+("00"+(d.getUTCMonth()+1)).slice(-2)+("00"+d.getUTCDate()).slice(-2)+("00"+d.getUTCHours()).slice(-2)+("00"+d.getUTCMinutes()).slice(-2)+("00"+d.getUTCSeconds()).slice(-2)+"Z"},void 0!==KJUR&&KJUR||(KJUR={}),"undefined"!=typeof KJUR.crypto&&KJUR.crypto||(KJUR.crypto={}),KJUR.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"},this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"},this.CRYPTOJSMESSAGEDIGESTNAME={md5:CryptoJS.algo.MD5,sha1:CryptoJS.algo.SHA1,sha224:CryptoJS.algo.SHA224,sha256:CryptoJS.algo.SHA256,sha384:CryptoJS.algo.SHA384,sha512:CryptoJS.algo.SHA512,ripemd160:CryptoJS.algo.RIPEMD160},this.getDigestInfoHex=function(hHash,alg){if("undefined"==typeof this.DIGESTINFOHEAD[alg])throw"alg not supported in Util.DIGESTINFOHEAD: "+alg;return this.DIGESTINFOHEAD[alg]+hHash},this.getPaddedDigestInfoHex=function(hHash,alg,keySize){var hDigestInfo=this.getDigestInfoHex(hHash,alg),pmStrLen=keySize/4;if(hDigestInfo.length+22>pmStrLen)throw"key is too short for SigAlg: keylen="+keySize+","+alg;for(var hTail="00"+hDigestInfo,hMid="",fLen=pmStrLen-"0001".length-hTail.length,i=0;i<fLen;i+=2)hMid+="ff";return"0001"+hMid+hTail},this.hashString=function(s,alg){return new KJUR.crypto.MessageDigest({alg:alg}).digestString(s)},this.hashHex=function(sHex,alg){return new KJUR.crypto.MessageDigest({alg:alg}).digestHex(sHex)},this.sha1=function(s){return new KJUR.crypto.MessageDigest({alg:"sha1",prov:"cryptojs"}).digestString(s)},this.sha256=function(s){return new KJUR.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"}).digestString(s)},this.sha256Hex=function(s){return new KJUR.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"}).digestHex(s)},this.sha512=function(s){return new KJUR.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"}).digestString(s)},this.sha512Hex=function(s){return new KJUR.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"}).digestHex(s)}},KJUR.crypto.Util.md5=function(s){return new KJUR.crypto.MessageDigest({alg:"md5",prov:"cryptojs"}).digestString(s)},KJUR.crypto.Util.ripemd160=function(s){return new KJUR.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"}).digestString(s)},KJUR.crypto.Util.SECURERANDOMGEN=new SecureRandom,KJUR.crypto.Util.getRandomHexOfNbytes=function(n){var ba=new Array(n);return KJUR.crypto.Util.SECURERANDOMGEN.nextBytes(ba),BAtohex(ba)},KJUR.crypto.Util.getRandomBigIntegerOfNbytes=function(n){return new BigInteger(KJUR.crypto.Util.getRandomHexOfNbytes(n),16)},KJUR.crypto.Util.getRandomHexOfNbits=function(n){var n_remainder=n%8,ba=new Array((n-n_remainder)/8+1);return KJUR.crypto.Util.SECURERANDOMGEN.nextBytes(ba),ba[0]=(255<<n_remainder&255^255)&ba[0],BAtohex(ba)},KJUR.crypto.Util.getRandomBigIntegerOfNbits=function(n){return new BigInteger(KJUR.crypto.Util.getRandomHexOfNbits(n),16)},KJUR.crypto.Util.getRandomBigIntegerZeroToMax=function(biMax){for(var bitLenMax=biMax.bitLength();;){var biRand=KJUR.crypto.Util.getRandomBigIntegerOfNbits(bitLenMax);if(-1!=biMax.compareTo(biRand))return biRand}},KJUR.crypto.Util.getRandomBigIntegerMinToMax=function(biMin,biMax){var flagCompare=biMin.compareTo(biMax);if(1==flagCompare)throw"biMin is greater than biMax";if(0==flagCompare)return biMin;var biDiff=biMax.subtract(biMin);return KJUR.crypto.Util.getRandomBigIntegerZeroToMax(biDiff).add(biMin)},KJUR.crypto.MessageDigest=function(params){this.setAlgAndProvider=function(alg,prov){if(null!==(alg=KJUR.crypto.MessageDigest.getCanonicalAlgName(alg))&&prov===undefined&&(prov=KJUR.crypto.Util.DEFAULTPROVIDER[alg]),-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(alg)&&"cryptojs"==prov){try{this.md=KJUR.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[alg].create()}catch(ex){throw"setAlgAndProvider hash alg set fail alg="+alg+"/"+ex}this.updateString=function(str){this.md.update(str)},this.updateHex=function(hex){var wHex=CryptoJS.enc.Hex.parse(hex);this.md.update(wHex)},this.digest=function(){return this.md.finalize().toString(CryptoJS.enc.Hex)},this.digestString=function(str){return this.updateString(str),this.digest()},this.digestHex=function(hex){return this.updateHex(hex),this.digest()}}if(-1!=":sha256:".indexOf(alg)&&"sjcl"==prov){try{this.md=new sjcl.hash.sha256}catch(ex){throw"setAlgAndProvider hash alg set fail alg="+alg+"/"+ex}this.updateString=function(str){this.md.update(str)},this.updateHex=function(hex){var baHex=sjcl.codec.hex.toBits(hex);this.md.update(baHex)},this.digest=function(){var hash=this.md.finalize();return sjcl.codec.hex.fromBits(hash)},this.digestString=function(str){return this.updateString(str),this.digest()},this.digestHex=function(hex){return this.updateHex(hex),this.digest()}}},this.updateString=function(str){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.updateHex=function(hex){throw"updateHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestString=function(str){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestHex=function(hex){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},params!==undefined&&params.alg!==undefined&&(this.algName=params.alg,params.prov===undefined&&(this.provName=KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName))},KJUR.crypto.MessageDigest.getCanonicalAlgName=function(alg){return"string"==typeof alg&&(alg=(alg=alg.toLowerCase()).replace(/-/,"")),alg},KJUR.crypto.MessageDigest.getHashLength=function(alg){var MD=KJUR.crypto.MessageDigest,alg2=MD.getCanonicalAlgName(alg);if(MD.HASHLENGTH[alg2]===undefined)throw"not supported algorithm: "+alg;return MD.HASHLENGTH[alg2]},KJUR.crypto.MessageDigest.HASHLENGTH={md5:16,sha1:20,sha224:28,sha256:32,sha384:48,sha512:64,ripemd160:20},KJUR.crypto.Mac=function(params){this.setAlgAndProvider=function(alg,prov){if(null==(alg=alg.toLowerCase())&&(alg="hmacsha1"),"hmac"!=(alg=alg.toLowerCase()).substr(0,4))throw"setAlgAndProvider unsupported HMAC alg: "+alg;prov===undefined&&(prov=KJUR.crypto.Util.DEFAULTPROVIDER[alg]),this.algProv=alg+"/"+prov;var hashAlg=alg.substr(4);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(hashAlg)&&"cryptojs"==prov){try{var mdObj=KJUR.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[hashAlg];this.mac=CryptoJS.algo.HMAC.create(mdObj,this.pass)}catch(ex){throw"setAlgAndProvider hash alg set fail hashAlg="+hashAlg+"/"+ex}this.updateString=function(str){this.mac.update(str)},this.updateHex=function(hex){var wHex=CryptoJS.enc.Hex.parse(hex);this.mac.update(wHex)},this.doFinal=function(){return this.mac.finalize().toString(CryptoJS.enc.Hex)},this.doFinalString=function(str){return this.updateString(str),this.doFinal()},this.doFinalHex=function(hex){return this.updateHex(hex),this.doFinal()}}},this.updateString=function(str){throw"updateString(str) not supported for this alg/prov: "+this.algProv},this.updateHex=function(hex){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv},this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv},this.doFinalString=function(str){throw"digestString(str) not supported for this alg/prov: "+this.algProv},this.doFinalHex=function(hex){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv},this.setPassword=function(pass){if("string"==typeof pass){var hPass=pass;return pass.length%2!=1&&pass.match(/^[0-9A-Fa-f]+$/)||(hPass=rstrtohex(pass)),void(this.pass=CryptoJS.enc.Hex.parse(hPass))}if("object"!=typeof pass)throw"KJUR.crypto.Mac unsupported password type: "+pass;hPass=null;if(pass.hex!==undefined){if(pass.hex.length%2!=0||!pass.hex.match(/^[0-9A-Fa-f]+$/))throw"Mac: wrong hex password: "+pass.hex;hPass=pass.hex}if(pass.utf8!==undefined&&(hPass=utf8tohex(pass.utf8)),pass.rstr!==undefined&&(hPass=rstrtohex(pass.rstr)),pass.b64!==undefined&&(hPass=b64tohex(pass.b64)),pass.b64u!==undefined&&(hPass=b64utohex(pass.b64u)),null==hPass)throw"KJUR.crypto.Mac unsupported password type: "+pass;this.pass=CryptoJS.enc.Hex.parse(hPass)},params!==undefined&&(params.pass!==undefined&&this.setPassword(params.pass),params.alg!==undefined&&(this.algName=params.alg,params.prov===undefined&&(this.provName=KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))},KJUR.crypto.Signature=function(params){var prvKey=null;if(this._setAlgNames=function(){var matchResult=this.algName.match(/^(.+)with(.+)$/);matchResult&&(this.mdAlgName=matchResult[1].toLowerCase(),this.pubkeyAlgName=matchResult[2].toLowerCase())},this._zeroPaddingOfSignature=function(hex,bitLength){for(var s="",nZero=bitLength/4-hex.length,i=0;i<nZero;i++)s+="0";return s+hex},this.setAlgAndProvider=function(alg,prov){if(this._setAlgNames(),"cryptojs/jsrsa"!=prov)throw"provider not supported: "+prov;if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)){try{this.md=new KJUR.crypto.MessageDigest({alg:this.mdAlgName})}catch(ex){throw"setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+ex}this.init=function(keyparam,pass){var keyObj=null;try{keyObj=pass===undefined?KEYUTIL.getKey(keyparam):KEYUTIL.getKey(keyparam,pass)}catch(ex){throw"init failed:"+ex}if(!0===keyObj.isPrivate)this.prvKey=keyObj,this.state="SIGN";else{if(!0!==keyObj.isPublic)throw"init failed.:"+keyObj;this.pubKey=keyObj,this.state="VERIFY"}},this.updateString=function(str){this.md.updateString(str)},this.updateHex=function(hex){this.md.updateHex(hex)},this.sign=function(){if(this.sHashHex=this.md.digest(),"undefined"!=typeof this.ecprvhex&&"undefined"!=typeof this.eccurvename){var ec=new KJUR.crypto.ECDSA({curve:this.eccurvename});this.hSign=ec.signHex(this.sHashHex,this.ecprvhex)}else if(this.prvKey instanceof RSAKey&&"rsaandmgf1"===this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,this.mdAlgName,this.pssSaltLen);else if(this.prvKey instanceof RSAKey&&"rsa"===this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof KJUR.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else{if(!(this.prvKey instanceof KJUR.crypto.DSA))throw"Signature: unsupported private key alg: "+this.pubkeyAlgName;this.hSign=this.prvKey.signWithMessageHash(this.sHashHex)}return this.hSign},this.signString=function(str){return this.updateString(str),this.sign()},this.signHex=function(hex){return this.updateHex(hex),this.sign()},this.verify=function(hSigVal){if(this.sHashHex=this.md.digest(),"undefined"!=typeof this.ecpubhex&&"undefined"!=typeof this.eccurvename)return new KJUR.crypto.ECDSA({curve:this.eccurvename}).verifyHex(this.sHashHex,hSigVal,this.ecpubhex);if(this.pubKey instanceof RSAKey&&"rsaandmgf1"===this.pubkeyAlgName)return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,hSigVal,this.mdAlgName,this.pssSaltLen);if(this.pubKey instanceof RSAKey&&"rsa"===this.pubkeyAlgName)return this.pubKey.verifyWithMessageHash(this.sHashHex,hSigVal);if(KJUR.crypto.ECDSA!==undefined&&this.pubKey instanceof KJUR.crypto.ECDSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,hSigVal);if(KJUR.crypto.DSA!==undefined&&this.pubKey instanceof KJUR.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,hSigVal);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName}}},this.init=function(key,pass){throw"init(key, pass) not supported for this alg:prov="+this.algProvName},this.updateString=function(str){throw"updateString(str) not supported for this alg:prov="+this.algProvName},this.updateHex=function(hex){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName},this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName},this.signString=function(str){throw"digestString(str) not supported for this alg:prov="+this.algProvName},this.signHex=function(hex){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName},this.verify=function(hSigVal){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName},(this.initParams=params)!==undefined&&(params.alg!==undefined&&(this.algName=params.alg,params.prov===undefined?this.provName=KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]:this.provName=params.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),params.psssaltlen!==undefined&&(this.pssSaltLen=params.psssaltlen),params.prvkeypem!==undefined)){if(params.prvkeypas!==undefined)throw"both prvkeypem and prvkeypas parameters not supported";try{prvKey=KEYUTIL.getKey(params.prvkeypem);this.init(prvKey)}catch(ex){throw"fatal error to load pem private key: "+ex}}},KJUR.crypto.Cipher=function(params){},KJUR.crypto.Cipher.encrypt=function(s,keyObj,algName){if(keyObj instanceof RSAKey&&keyObj.isPublic){var algName2=KJUR.crypto.Cipher.getAlgByKeyAndName(keyObj,algName);if("RSA"===algName2)return keyObj.encrypt(s);if("RSAOAEP"===algName2)return keyObj.encryptOAEP(s,"sha1");var a=algName2.match(/^RSAOAEP(\d+)$/);if(null!==a)return keyObj.encryptOAEP(s,"sha"+a[1]);throw"Cipher.encrypt: unsupported algorithm for RSAKey: "+algName}throw"Cipher.encrypt: unsupported key or algorithm"},KJUR.crypto.Cipher.decrypt=function(hex,keyObj,algName){if(keyObj instanceof RSAKey&&keyObj.isPrivate){var algName2=KJUR.crypto.Cipher.getAlgByKeyAndName(keyObj,algName);if("RSA"===algName2)return keyObj.decrypt(hex);if("RSAOAEP"===algName2)return keyObj.decryptOAEP(hex,"sha1");var a=algName2.match(/^RSAOAEP(\d+)$/);if(null!==a)return keyObj.decryptOAEP(hex,"sha"+a[1]);throw"Cipher.decrypt: unsupported algorithm for RSAKey: "+algName}throw"Cipher.decrypt: unsupported key or algorithm"},KJUR.crypto.Cipher.getAlgByKeyAndName=function(keyObj,algName){if(keyObj instanceof RSAKey){if(-1!=":RSA:RSAOAEP:RSAOAEP224:RSAOAEP256:RSAOAEP384:RSAOAEP512:".indexOf(algName))return algName;if(null===algName||algName===undefined)return"RSA";throw"getAlgByKeyAndName: not supported algorithm name for RSAKey: "+algName}throw"getAlgByKeyAndName: not supported algorithm name: "+algName},KJUR.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1","2b81040023":"secp521r1","2b81040022":"secp384r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}},void 0!==KJUR&&KJUR||(KJUR={}),"undefined"!=typeof KJUR.crypto&&KJUR.crypto||(KJUR.crypto={}),KJUR.crypto.ECDSA=function(params){var rng=new SecureRandom;this.type="EC",this.isPrivate=!1,this.isPublic=!1,this.getBigRandom=function(limit){return new BigInteger(limit.bitLength(),rng).mod(limit.subtract(BigInteger.ONE)).add(BigInteger.ONE)},this.setNamedCurve=function(curveName){this.ecparams=KJUR.crypto.ECParameterDB.getByName(curveName),this.prvKeyHex=null,this.pubKeyHex=null,this.curveName=curveName},this.setPrivateKeyHex=function(prvKeyHex){this.isPrivate=!0,this.prvKeyHex=prvKeyHex},this.setPublicKeyHex=function(pubKeyHex){this.isPublic=!0,this.pubKeyHex=pubKeyHex},this.getPublicKeyXYHex=function(){var h=this.pubKeyHex;if("04"!==h.substr(0,2))throw"this method supports uncompressed format(04) only";var charlen=this.ecparams.keylen/4;if(h.length!==2+2*charlen)throw"malformed public key hex length";var result={};return result.x=h.substr(2,charlen),result.y=h.substr(2+charlen),result},this.getShortNISTPCurveName=function(){var s=this.curveName;return"secp256r1"===s||"NIST P-256"===s||"P-256"===s||"prime256v1"===s?"P-256":"secp384r1"===s||"NIST P-384"===s||"P-384"===s?"P-384":null},this.generateKeyPairHex=function(){var biN=this.ecparams.n,biPrv=this.getBigRandom(biN),epPub=this.ecparams.G.multiply(biPrv),biX=epPub.getX().toBigInteger(),biY=epPub.getY().toBigInteger(),charlen=this.ecparams.keylen/4,hPrv=("0000000000"+biPrv.toString(16)).slice(-charlen),hPub="04"+("0000000000"+biX.toString(16)).slice(-charlen)+("0000000000"+biY.toString(16)).slice(-charlen);return this.setPrivateKeyHex(hPrv),this.setPublicKeyHex(hPub),{ecprvhex:hPrv,ecpubhex:hPub}},this.signWithMessageHash=function(hashHex){return this.signHex(hashHex,this.prvKeyHex)},this.signHex=function(hashHex,privHex){var d=new BigInteger(privHex,16),n=this.ecparams.n,e=new BigInteger(hashHex,16);do{var k=this.getBigRandom(n),r=this.ecparams.G.multiply(k).getX().toBigInteger().mod(n)}while(r.compareTo(BigInteger.ZERO)<=0);var s=k.modInverse(n).multiply(e.add(d.multiply(r))).mod(n);return KJUR.crypto.ECDSA.biRSSigToASN1Sig(r,s)},this.sign=function(hash,priv){var d=priv,n=this.ecparams.n,e=BigInteger.fromByteArrayUnsigned(hash);do{var k=this.getBigRandom(n),r=this.ecparams.G.multiply(k).getX().toBigInteger().mod(n)}while(r.compareTo(BigInteger.ZERO)<=0);var s=k.modInverse(n).multiply(e.add(d.multiply(r))).mod(n);return this.serializeSig(r,s)},this.verifyWithMessageHash=function(hashHex,sigHex){return this.verifyHex(hashHex,sigHex,this.pubKeyHex)},this.verifyHex=function(hashHex,sigHex,pubkeyHex){var r,s,Q,obj=KJUR.crypto.ECDSA.parseSigHex(sigHex);r=obj.r,s=obj.s,Q=ECPointFp.decodeFromHex(this.ecparams.curve,pubkeyHex);var e=new BigInteger(hashHex,16);return this.verifyRaw(e,r,s,Q)},this.verify=function(hash,sig,pubkey){var r,s,Q;if(Bitcoin.Util.isArray(sig)){var obj=this.parseSig(sig);r=obj.r,s=obj.s}else{if("object"!=typeof sig||!sig.r||!sig.s)throw"Invalid value for signature";r=sig.r,s=sig.s}if(pubkey instanceof ECPointFp)Q=pubkey;else{if(!Bitcoin.Util.isArray(pubkey))throw"Invalid format for pubkey value, must be byte array or ECPointFp";Q=ECPointFp.decodeFrom(this.ecparams.curve,pubkey)}var e=BigInteger.fromByteArrayUnsigned(hash);return this.verifyRaw(e,r,s,Q)},this.verifyRaw=function(e,r,s,Q){var n=this.ecparams.n,G=this.ecparams.G;if(r.compareTo(BigInteger.ONE)<0||0<=r.compareTo(n))return!1;if(s.compareTo(BigInteger.ONE)<0||0<=s.compareTo(n))return!1;var c=s.modInverse(n),u1=e.multiply(c).mod(n),u2=r.multiply(c).mod(n);return G.multiply(u1).add(Q.multiply(u2)).getX().toBigInteger().mod(n).equals(r)},this.serializeSig=function(r,s){var rBa=r.toByteArraySigned(),sBa=s.toByteArraySigned(),sequence=[];return sequence.push(2),sequence.push(rBa.length),(sequence=sequence.concat(rBa)).push(2),sequence.push(sBa.length),(sequence=sequence.concat(sBa)).unshift(sequence.length),sequence.unshift(48),sequence},this.parseSig=function(sig){var cursor;if(48!=sig[0])throw new Error("Signature not a valid DERSequence");if((cursor=2)!=sig[cursor])throw new Error("First element in signature must be a DERInteger");var rBa=sig.slice(cursor+2,cursor+2+sig[cursor+1]);if(2!=sig[cursor+=2+sig[cursor+1]])throw new Error("Second element in signature must be a DERInteger");var sBa=sig.slice(cursor+2,cursor+2+sig[cursor+1]);return cursor+=2+sig[cursor+1],{r:BigInteger.fromByteArrayUnsigned(rBa),s:BigInteger.fromByteArrayUnsigned(sBa)}},this.parseSigCompact=function(sig){if(65!==sig.length)throw"Signature has the wrong length";var i=sig[0]-27;if(i<0||7<i)throw"Invalid signature type";var n=this.ecparams.n;return{r:BigInteger.fromByteArrayUnsigned(sig.slice(1,33)).mod(n),s:BigInteger.fromByteArrayUnsigned(sig.slice(33,65)).mod(n),i:i}},this.readPKCS5PrvKeyHex=function(h){var hCurve,hPrv,hPub,_ASN1HEX=ASN1HEX,_getName=KJUR.crypto.ECDSA.getName,_getVbyList=_ASN1HEX.getVbyList;if(!1===_ASN1HEX.isASN1HEX(h))throw"not ASN.1 hex string";try{hCurve=_getVbyList(h,0,[2,0],"06"),hPrv=_getVbyList(h,0,[1],"04");try{hPub=_getVbyList(h,0,[3,0],"03").substr(2)}catch(ex){}}catch(ex){throw"malformed PKCS#1/5 plain ECC private key"}if(this.curveName=_getName(hCurve),this.curveName===undefined)throw"unsupported curve name";this.setNamedCurve(this.curveName),this.setPublicKeyHex(hPub),this.setPrivateKeyHex(hPrv),this.isPublic=!1},this.readPKCS8PrvKeyHex=function(h){var hCurve,hPrv,hPub,_ASN1HEX=ASN1HEX,_getName=KJUR.crypto.ECDSA.getName,_getVbyList=_ASN1HEX.getVbyList;if(!1===_ASN1HEX.isASN1HEX(h))throw"not ASN.1 hex string";try{_getVbyList(h,0,[1,0],"06"),hCurve=_getVbyList(h,0,[1,1],"06"),hPrv=_getVbyList(h,0,[2,0,1],"04");try{hPub=_getVbyList(h,0,[2,0,2,0],"03").substr(2)}catch(ex){}}catch(ex){throw"malformed PKCS#8 plain ECC private key"}if(this.curveName=_getName(hCurve),this.curveName===undefined)throw"unsupported curve name";this.setNamedCurve(this.curveName),this.setPublicKeyHex(hPub),this.setPrivateKeyHex(hPrv),this.isPublic=!1},this.readPKCS8PubKeyHex=function(h){var hCurve,hPub,_ASN1HEX=ASN1HEX,_getName=KJUR.crypto.ECDSA.getName,_getVbyList=_ASN1HEX.getVbyList;if(!1===_ASN1HEX.isASN1HEX(h))throw"not ASN.1 hex string";try{_getVbyList(h,0,[0,0],"06"),hCurve=_getVbyList(h,0,[0,1],"06"),hPub=_getVbyList(h,0,[1],"03").substr(2)}catch(ex){throw"malformed PKCS#8 ECC public key"}if(this.curveName=_getName(hCurve),null===this.curveName)throw"unsupported curve name";this.setNamedCurve(this.curveName),this.setPublicKeyHex(hPub)},this.readCertPubKeyHex=function(h,nthPKI){5!==nthPKI&&(nthPKI=6);var hCurve,hPub,_ASN1HEX=ASN1HEX,_getName=KJUR.crypto.ECDSA.getName,_getVbyList=_ASN1HEX.getVbyList;if(!1===_ASN1HEX.isASN1HEX(h))throw"not ASN.1 hex string";try{hCurve=_getVbyList(h,0,[0,nthPKI,0,1],"06"),hPub=_getVbyList(h,0,[0,nthPKI,1],"03").substr(2)}catch(ex){throw"malformed X.509 certificate ECC public key"}if(this.curveName=_getName(hCurve),null===this.curveName)throw"unsupported curve name";this.setNamedCurve(this.curveName),this.setPublicKeyHex(hPub)},params!==undefined&&params.curve!==undefined&&(this.curveName=params.curve),this.curveName===undefined&&(this.curveName="secp256r1"),this.setNamedCurve(this.curveName),params!==undefined&&(params.prv!==undefined&&this.setPrivateKeyHex(params.prv),params.pub!==undefined&&this.setPublicKeyHex(params.pub))},KJUR.crypto.ECDSA.parseSigHex=function(sigHex){var p=KJUR.crypto.ECDSA.parseSigHexInHexRS(sigHex);return{r:new BigInteger(p.r,16),s:new BigInteger(p.s,16)}},KJUR.crypto.ECDSA.parseSigHexInHexRS=function(sigHex){var _ASN1HEX=ASN1HEX,_getChildIdx=_ASN1HEX.getChildIdx,_getV=_ASN1HEX.getV;if("30"!=sigHex.substr(0,2))throw"signature is not a ASN.1 sequence";var a=_getChildIdx(sigHex,0);if(2!=a.length)throw"number of signature ASN.1 sequence elements seem wrong";var iTLV1=a[0],iTLV2=a[1];if("02"!=sigHex.substr(iTLV1,2))throw"1st item of sequene of signature is not ASN.1 integer";if("02"!=sigHex.substr(iTLV2,2))throw"2nd item of sequene of signature is not ASN.1 integer";return{r:_getV(sigHex,iTLV1),s:_getV(sigHex,iTLV2)}},KJUR.crypto.ECDSA.asn1SigToConcatSig=function(asn1Sig){var pSig=KJUR.crypto.ECDSA.parseSigHexInHexRS(asn1Sig),hR=pSig.r,hS=pSig.s;if("00"==hR.substr(0,2)&&hR.length%32==2&&(hR=hR.substr(2)),"00"==hS.substr(0,2)&&hS.length%32==2&&(hS=hS.substr(2)),hR.length%32==30&&(hR="00"+hR),hS.length%32==30&&(hS="00"+hS),hR.length%32!=0)throw"unknown ECDSA sig r length error";if(hS.length%32!=0)throw"unknown ECDSA sig s length error";return hR+hS},KJUR.crypto.ECDSA.concatSigToASN1Sig=function(concatSig){if(concatSig.length/2*8%128!=0)throw"unknown ECDSA concatinated r-s sig  length error";var hR=concatSig.substr(0,concatSig.length/2),hS=concatSig.substr(concatSig.length/2);return KJUR.crypto.ECDSA.hexRSSigToASN1Sig(hR,hS)},KJUR.crypto.ECDSA.hexRSSigToASN1Sig=function(hR,hS){var biR=new BigInteger(hR,16),biS=new BigInteger(hS,16);return KJUR.crypto.ECDSA.biRSSigToASN1Sig(biR,biS)},KJUR.crypto.ECDSA.biRSSigToASN1Sig=function(biR,biS){var _KJUR_asn1=KJUR.asn1,derR=new _KJUR_asn1.DERInteger({bigint:biR}),derS=new _KJUR_asn1.DERInteger({bigint:biS});return new _KJUR_asn1.DERSequence({array:[derR,derS]}).getEncodedHex()},KJUR.crypto.ECDSA.getName=function(s){return"2a8648ce3d030107"===s?"secp256r1":"2b8104000a"===s?"secp256k1":"2b81040022"===s?"secp384r1":-1!=="|secp256r1|NIST P-256|P-256|prime256v1|".indexOf(s)?"secp256r1":-1!=="|secp256k1|".indexOf(s)?"secp256k1":-1!=="|secp384r1|NIST P-384|P-384|".indexOf(s)?"secp384r1":null};var KEYUTIL=function(){var decryptAES=function(dataHex,keyHex,ivHex){return decryptGeneral(CryptoJS.AES,dataHex,keyHex,ivHex)},decryptGeneral=function(f,dataHex,keyHex,ivHex){var data=CryptoJS.enc.Hex.parse(dataHex),key=CryptoJS.enc.Hex.parse(keyHex),iv=CryptoJS.enc.Hex.parse(ivHex),encrypted={};encrypted.key=key,encrypted.iv=iv,encrypted.ciphertext=data;var decrypted=f.decrypt(encrypted,key,{iv:iv});return CryptoJS.enc.Hex.stringify(decrypted)},encryptAES=function(dataHex,keyHex,ivHex){return encryptGeneral(CryptoJS.AES,dataHex,keyHex,ivHex)},encryptGeneral=function(f,dataHex,keyHex,ivHex){var data=CryptoJS.enc.Hex.parse(dataHex),key=CryptoJS.enc.Hex.parse(keyHex),iv=CryptoJS.enc.Hex.parse(ivHex),encryptedHex=f.encrypt(data,key,{iv:iv}),encryptedWA=CryptoJS.enc.Hex.parse(encryptedHex.toString());return CryptoJS.enc.Base64.stringify(encryptedWA)},ALGLIST={"AES-256-CBC":{proc:decryptAES,eproc:encryptAES,keylen:32,ivlen:16},"AES-192-CBC":{proc:decryptAES,eproc:encryptAES,keylen:24,ivlen:16},"AES-128-CBC":{proc:decryptAES,eproc:encryptAES,keylen:16,ivlen:16},"DES-EDE3-CBC":{proc:function(dataHex,keyHex,ivHex){return decryptGeneral(CryptoJS.TripleDES,dataHex,keyHex,ivHex)},eproc:function(dataHex,keyHex,ivHex){return encryptGeneral(CryptoJS.TripleDES,dataHex,keyHex,ivHex)},keylen:24,ivlen:8},"DES-CBC":{proc:function(dataHex,keyHex,ivHex){return decryptGeneral(CryptoJS.DES,dataHex,keyHex,ivHex)},eproc:function(dataHex,keyHex,ivHex){return encryptGeneral(CryptoJS.DES,dataHex,keyHex,ivHex)},keylen:8,ivlen:8}},_parsePKCS5PEM=function(sPKCS5PEM){var info={},matchResult1=sPKCS5PEM.match(new RegExp("DEK-Info: ([^,]+),([0-9A-Fa-f]+)","m"));matchResult1&&(info.cipher=matchResult1[1],info.ivsalt=matchResult1[2]);var matchResult2=sPKCS5PEM.match(new RegExp("-----BEGIN ([A-Z]+) PRIVATE KEY-----"));matchResult2&&(info.type=matchResult2[1]);var i1=-1,lenNEWLINE=0;-1!=sPKCS5PEM.indexOf("\r\n\r\n")&&(i1=sPKCS5PEM.indexOf("\r\n\r\n"),lenNEWLINE=2),-1!=sPKCS5PEM.indexOf("\n\n")&&(i1=sPKCS5PEM.indexOf("\n\n"),lenNEWLINE=1);var i2=sPKCS5PEM.indexOf("-----END");if(-1!=i1&&-1!=i2){var s=sPKCS5PEM.substring(i1+2*lenNEWLINE,i2-lenNEWLINE);s=s.replace(/\s+/g,""),info.data=s}return info},_getKeyAndUnusedIvByPasscodeAndIvsalt=function(algName,passcode,ivsaltHex){for(var saltHex=ivsaltHex.substring(0,16),salt=CryptoJS.enc.Hex.parse(saltHex),data=CryptoJS.enc.Utf8.parse(passcode),nRequiredBytes=ALGLIST[algName].keylen+ALGLIST[algName].ivlen,hHexValueJoined="",hLastValue=null;;){var h=CryptoJS.algo.MD5.create();if(null!=hLastValue&&h.update(hLastValue),h.update(data),h.update(salt),hLastValue=h.finalize(),(hHexValueJoined+=CryptoJS.enc.Hex.stringify(hLastValue)).length>=2*nRequiredBytes)break}var result={};return result.keyhex=hHexValueJoined.substr(0,2*ALGLIST[algName].keylen),result.ivhex=hHexValueJoined.substr(2*ALGLIST[algName].keylen,2*ALGLIST[algName].ivlen),result},_decryptKeyB64=function(privateKeyB64,sharedKeyAlgName,sharedKeyHex,ivsaltHex){var privateKeyWA=CryptoJS.enc.Base64.parse(privateKeyB64),privateKeyHex=CryptoJS.enc.Hex.stringify(privateKeyWA);return(0,ALGLIST[sharedKeyAlgName].proc)(privateKeyHex,sharedKeyHex,ivsaltHex)};return{version:"1.0.0",parsePKCS5PEM:function(sPKCS5PEM){return _parsePKCS5PEM(sPKCS5PEM)},getKeyAndUnusedIvByPasscodeAndIvsalt:function(algName,passcode,ivsaltHex){return _getKeyAndUnusedIvByPasscodeAndIvsalt(algName,passcode,ivsaltHex)},decryptKeyB64:function(privateKeyB64,sharedKeyAlgName,sharedKeyHex,ivsaltHex){return _decryptKeyB64(privateKeyB64,sharedKeyAlgName,sharedKeyHex,ivsaltHex)},getDecryptedKeyHex:function(sEncryptedPEM,passcode){var info=_parsePKCS5PEM(sEncryptedPEM),sharedKeyAlgName=(info.type,info.cipher),ivsaltHex=info.ivsalt,privateKeyB64=info.data,sharedKeyHex=_getKeyAndUnusedIvByPasscodeAndIvsalt(sharedKeyAlgName,passcode,ivsaltHex).keyhex;return _decryptKeyB64(privateKeyB64,sharedKeyAlgName,sharedKeyHex,ivsaltHex)},getEncryptedPKCS5PEMFromPrvKeyHex:function(pemHeadAlg,hPrvKey,passcode,sharedKeyAlgName,ivsaltHex){var numBytes,wa,sPEM="";if(void 0!==sharedKeyAlgName&&null!=sharedKeyAlgName||(sharedKeyAlgName="AES-256-CBC"),"undefined"==typeof ALGLIST[sharedKeyAlgName])throw"KEYUTIL unsupported algorithm: "+sharedKeyAlgName;if(void 0===ivsaltHex||null==ivsaltHex){var ivlen=ALGLIST[sharedKeyAlgName].ivlen;ivsaltHex=(numBytes=ivlen,wa=CryptoJS.lib.WordArray.random(numBytes),CryptoJS.enc.Hex.stringify(wa)).toUpperCase()}sPEM="-----BEGIN "+pemHeadAlg+" PRIVATE KEY-----\r\n";return sPEM+="Proc-Type: 4,ENCRYPTED\r\n",sPEM+="DEK-Info: "+sharedKeyAlgName+","+ivsaltHex+"\r\n",sPEM+="\r\n",sPEM+=function(privateKeyHex,sharedKeyAlgName,sharedKeyHex,ivsaltHex){return(0,ALGLIST[sharedKeyAlgName].eproc)(privateKeyHex,sharedKeyHex,ivsaltHex)}(hPrvKey,sharedKeyAlgName,_getKeyAndUnusedIvByPasscodeAndIvsalt(sharedKeyAlgName,passcode,ivsaltHex).keyhex,ivsaltHex).replace(/(.{64})/g,"$1\r\n"),sPEM+="\r\n-----END "+pemHeadAlg+" PRIVATE KEY-----\r\n"},parseHexOfEncryptedPKCS8:function(sHEX){var _ASN1HEX=ASN1HEX,_getChildIdx=_ASN1HEX.getChildIdx,_getV=_ASN1HEX.getV,info={},a0=_getChildIdx(sHEX,0);if(2!=a0.length)throw"malformed format: SEQUENCE(0).items != 2: "+a0.length;info.ciphertext=_getV(sHEX,a0[1]);var a0_0=_getChildIdx(sHEX,a0[0]);if(2!=a0_0.length)throw"malformed format: SEQUENCE(0.0).items != 2: "+a0_0.length;if("2a864886f70d01050d"!=_getV(sHEX,a0_0[0]))throw"this only supports pkcs5PBES2";var a0_0_1=_getChildIdx(sHEX,a0_0[1]);if(2!=a0_0.length)throw"malformed format: SEQUENCE(0.0.1).items != 2: "+a0_0_1.length;var a0_0_1_1=_getChildIdx(sHEX,a0_0_1[1]);if(2!=a0_0_1_1.length)throw"malformed format: SEQUENCE(0.0.1.1).items != 2: "+a0_0_1_1.length;if("2a864886f70d0307"!=_getV(sHEX,a0_0_1_1[0]))throw"this only supports TripleDES";info.encryptionSchemeAlg="TripleDES",info.encryptionSchemeIV=_getV(sHEX,a0_0_1_1[1]);var a0_0_1_0=_getChildIdx(sHEX,a0_0_1[0]);if(2!=a0_0_1_0.length)throw"malformed format: SEQUENCE(0.0.1.0).items != 2: "+a0_0_1_0.length;if("2a864886f70d01050c"!=_getV(sHEX,a0_0_1_0[0]))throw"this only supports pkcs5PBKDF2";var a0_0_1_0_1=_getChildIdx(sHEX,a0_0_1_0[1]);if(a0_0_1_0_1.length<2)throw"malformed format: SEQUENCE(0.0.1.0.1).items < 2: "+a0_0_1_0_1.length;info.pbkdf2Salt=_getV(sHEX,a0_0_1_0_1[0]);var iterNumHex=_getV(sHEX,a0_0_1_0_1[1]);try{info.pbkdf2Iter=parseInt(iterNumHex,16)}catch(ex){throw"malformed format pbkdf2Iter: "+iterNumHex}return info},getPBKDF2KeyHexFromParam:function(info,passcode){var pbkdf2SaltWS=CryptoJS.enc.Hex.parse(info.pbkdf2Salt),pbkdf2Iter=info.pbkdf2Iter,pbkdf2KeyWS=CryptoJS.PBKDF2(passcode,pbkdf2SaltWS,{keySize:6,iterations:pbkdf2Iter});return CryptoJS.enc.Hex.stringify(pbkdf2KeyWS)},_getPlainPKCS8HexFromEncryptedPKCS8PEM:function(pkcs8PEM,passcode){var derHex=pemtohex(pkcs8PEM,"ENCRYPTED PRIVATE KEY"),info=this.parseHexOfEncryptedPKCS8(derHex),pbkdf2KeyHex=KEYUTIL.getPBKDF2KeyHexFromParam(info,passcode),encrypted={};encrypted.ciphertext=CryptoJS.enc.Hex.parse(info.ciphertext);var pbkdf2KeyWS=CryptoJS.enc.Hex.parse(pbkdf2KeyHex),des3IVWS=CryptoJS.enc.Hex.parse(info.encryptionSchemeIV),decWS=CryptoJS.TripleDES.decrypt(encrypted,pbkdf2KeyWS,{iv:des3IVWS});return CryptoJS.enc.Hex.stringify(decWS)},getKeyFromEncryptedPKCS8PEM:function(pkcs8PEM,passcode){var prvKeyHex=this._getPlainPKCS8HexFromEncryptedPKCS8PEM(pkcs8PEM,passcode);return this.getKeyFromPlainPrivatePKCS8Hex(prvKeyHex)},parsePlainPrivatePKCS8Hex:function(pkcs8PrvHex){var _ASN1HEX=ASN1HEX,_getChildIdx=_ASN1HEX.getChildIdx,_getV=_ASN1HEX.getV,result={algparam:null};if("30"!=pkcs8PrvHex.substr(0,2))throw"malformed plain PKCS8 private key(code:001)";var a1=_getChildIdx(pkcs8PrvHex,0);if(3!=a1.length)throw"malformed plain PKCS8 private key(code:002)";if("30"!=pkcs8PrvHex.substr(a1[1],2))throw"malformed PKCS8 private key(code:003)";var a2=_getChildIdx(pkcs8PrvHex,a1[1]);if(2!=a2.length)throw"malformed PKCS8 private key(code:004)";if("06"!=pkcs8PrvHex.substr(a2[0],2))throw"malformed PKCS8 private key(code:005)";if(result.algoid=_getV(pkcs8PrvHex,a2[0]),"06"==pkcs8PrvHex.substr(a2[1],2)&&(result.algparam=_getV(pkcs8PrvHex,a2[1])),"04"!=pkcs8PrvHex.substr(a1[2],2))throw"malformed PKCS8 private key(code:006)";return result.keyidx=_ASN1HEX.getVidx(pkcs8PrvHex,a1[2]),result},getKeyFromPlainPrivatePKCS8PEM:function(prvKeyPEM){var prvKeyHex=pemtohex(prvKeyPEM,"PRIVATE KEY");return this.getKeyFromPlainPrivatePKCS8Hex(prvKeyHex)},getKeyFromPlainPrivatePKCS8Hex:function(prvKeyHex){var key,p8=this.parsePlainPrivatePKCS8Hex(prvKeyHex);if("2a864886f70d010101"==p8.algoid)key=new RSAKey;else if("2a8648ce380401"==p8.algoid)key=new KJUR.crypto.DSA;else{if("2a8648ce3d0201"!=p8.algoid)throw"unsupported private key algorithm";key=new KJUR.crypto.ECDSA}return key.readPKCS8PrvKeyHex(prvKeyHex),key},_getKeyFromPublicPKCS8Hex:function(h){var key,hOID=ASN1HEX.getVbyList(h,0,[0,0],"06");if("2a864886f70d010101"===hOID)key=new RSAKey;else if("2a8648ce380401"===hOID)key=new KJUR.crypto.DSA;else{if("2a8648ce3d0201"!==hOID)throw"unsupported PKCS#8 public key hex";key=new KJUR.crypto.ECDSA}return key.readPKCS8PubKeyHex(h),key},parsePublicRawRSAKeyHex:function(pubRawRSAHex){var _ASN1HEX=ASN1HEX,_getChildIdx=_ASN1HEX.getChildIdx,_getV=_ASN1HEX.getV,result={};if("30"!=pubRawRSAHex.substr(0,2))throw"malformed RSA key(code:001)";var a1=_getChildIdx(pubRawRSAHex,0);if(2!=a1.length)throw"malformed RSA key(code:002)";if("02"!=pubRawRSAHex.substr(a1[0],2))throw"malformed RSA key(code:003)";if(result.n=_getV(pubRawRSAHex,a1[0]),"02"!=pubRawRSAHex.substr(a1[1],2))throw"malformed RSA key(code:004)";return result.e=_getV(pubRawRSAHex,a1[1]),result},parsePublicPKCS8Hex:function(pkcs8PubHex){var _ASN1HEX=ASN1HEX,_getChildIdx=_ASN1HEX.getChildIdx,_getV=_ASN1HEX.getV,result={algparam:null},a1=_getChildIdx(pkcs8PubHex,0);if(2!=a1.length)throw"outer DERSequence shall have 2 elements: "+a1.length;var idxAlgIdTLV=a1[0];if("30"!=pkcs8PubHex.substr(idxAlgIdTLV,2))throw"malformed PKCS8 public key(code:001)";var a2=_getChildIdx(pkcs8PubHex,idxAlgIdTLV);if(2!=a2.length)throw"malformed PKCS8 public key(code:002)";if("06"!=pkcs8PubHex.substr(a2[0],2))throw"malformed PKCS8 public key(code:003)";if(result.algoid=_getV(pkcs8PubHex,a2[0]),"06"==pkcs8PubHex.substr(a2[1],2)?result.algparam=_getV(pkcs8PubHex,a2[1]):"30"==pkcs8PubHex.substr(a2[1],2)&&(result.algparam={},result.algparam.p=_ASN1HEX.getVbyList(pkcs8PubHex,a2[1],[0],"02"),result.algparam.q=_ASN1HEX.getVbyList(pkcs8PubHex,a2[1],[1],"02"),result.algparam.g=_ASN1HEX.getVbyList(pkcs8PubHex,a2[1],[2],"02")),"03"!=pkcs8PubHex.substr(a1[1],2))throw"malformed PKCS8 public key(code:004)";return result.key=_getV(pkcs8PubHex,a1[1]).substr(2),result}}}();KEYUTIL.getKey=function(param,passcode,hextype){var _getChildIdx=(_ASN1HEX=ASN1HEX).getChildIdx,_getVbyList=(_ASN1HEX.getV,_ASN1HEX.getVbyList),_KJUR_crypto=KJUR.crypto,_KJUR_crypto_ECDSA=_KJUR_crypto.ECDSA,_KJUR_crypto_DSA=_KJUR_crypto.DSA,_RSAKey=RSAKey,_pemtohex=pemtohex,_KEYUTIL=KEYUTIL;if(void 0!==_RSAKey&&param instanceof _RSAKey)return param;if(void 0!==_KJUR_crypto_ECDSA&&param instanceof _KJUR_crypto_ECDSA)return param;if(void 0!==_KJUR_crypto_DSA&&param instanceof _KJUR_crypto_DSA)return param;if(param.curve!==undefined&&param.xy!==undefined&&param.d===undefined)return new _KJUR_crypto_ECDSA({pub:param.xy,curve:param.curve});if(param.curve!==undefined&&param.d!==undefined)return new _KJUR_crypto_ECDSA({prv:param.d,curve:param.curve});if(param.kty===undefined&&param.n!==undefined&&param.e!==undefined&&param.d===undefined)return(key=new _RSAKey).setPublic(param.n,param.e),key;if(param.kty===undefined&&param.n!==undefined&&param.e!==undefined&&param.d!==undefined&&param.p!==undefined&&param.q!==undefined&&param.dp!==undefined&&param.dq!==undefined&&param.co!==undefined&&param.qi===undefined)return(key=new _RSAKey).setPrivateEx(param.n,param.e,param.d,param.p,param.q,param.dp,param.dq,param.co),key;if(param.kty===undefined&&param.n!==undefined&&param.e!==undefined&&param.d!==undefined&&param.p===undefined)return(key=new _RSAKey).setPrivate(param.n,param.e,param.d),key;if(param.p!==undefined&&param.q!==undefined&&param.g!==undefined&&param.y!==undefined&&param.x===undefined)return(key=new _KJUR_crypto_DSA).setPublic(param.p,param.q,param.g,param.y),key;if(param.p!==undefined&&param.q!==undefined&&param.g!==undefined&&param.y!==undefined&&param.x!==undefined)return(key=new _KJUR_crypto_DSA).setPrivate(param.p,param.q,param.g,param.y,param.x),key;if("RSA"===param.kty&&param.n!==undefined&&param.e!==undefined&&param.d===undefined)return(key=new _RSAKey).setPublic(b64utohex(param.n),b64utohex(param.e)),key;if("RSA"===param.kty&&param.n!==undefined&&param.e!==undefined&&param.d!==undefined&&param.p!==undefined&&param.q!==undefined&&param.dp!==undefined&&param.dq!==undefined&&param.qi!==undefined)return(key=new _RSAKey).setPrivateEx(b64utohex(param.n),b64utohex(param.e),b64utohex(param.d),b64utohex(param.p),b64utohex(param.q),b64utohex(param.dp),b64utohex(param.dq),b64utohex(param.qi)),key;if("RSA"===param.kty&&param.n!==undefined&&param.e!==undefined&&param.d!==undefined)return(key=new _RSAKey).setPrivate(b64utohex(param.n),b64utohex(param.e),b64utohex(param.d)),key;if("EC"===param.kty&&param.crv!==undefined&&param.x!==undefined&&param.y!==undefined&&param.d===undefined){var charlen=(ec=new _KJUR_crypto_ECDSA({curve:param.crv})).ecparams.keylen/4,hPub="04"+("0000000000"+b64utohex(param.x)).slice(-charlen)+("0000000000"+b64utohex(param.y)).slice(-charlen);return ec.setPublicKeyHex(hPub),ec}if("EC"===param.kty&&param.crv!==undefined&&param.x!==undefined&&param.y!==undefined&&param.d!==undefined){charlen=(ec=new _KJUR_crypto_ECDSA({curve:param.crv})).ecparams.keylen/4,hPub="04"+("0000000000"+b64utohex(param.x)).slice(-charlen)+("0000000000"+b64utohex(param.y)).slice(-charlen);var hPrv=("0000000000"+b64utohex(param.d)).slice(-charlen);return ec.setPublicKeyHex(hPub),ec.setPrivateKeyHex(hPrv),ec}if("pkcs5prv"===hextype){var a,h=param,_ASN1HEX=ASN1HEX;if(9===(a=_getChildIdx(h,0)).length)(key=new _RSAKey).readPKCS5PrvKeyHex(h);else if(6===a.length)(key=new _KJUR_crypto_DSA).readPKCS5PrvKeyHex(h);else{if(!(2<a.length&&"04"===h.substr(a[1],2)))throw"unsupported PKCS#1/5 hexadecimal key";(key=new _KJUR_crypto_ECDSA).readPKCS5PrvKeyHex(h)}return key}if("pkcs8prv"===hextype)return key=_KEYUTIL.getKeyFromPlainPrivatePKCS8Hex(param);if("pkcs8pub"===hextype)return _KEYUTIL._getKeyFromPublicPKCS8Hex(param);if("x509pub"===hextype)return X509.getPublicKeyFromCertHex(param);if(-1!=param.indexOf("-END CERTIFICATE-",0)||-1!=param.indexOf("-END X509 CERTIFICATE-",0)||-1!=param.indexOf("-END TRUSTED CERTIFICATE-",0))return X509.getPublicKeyFromCertPEM(param);if(-1!=param.indexOf("-END PUBLIC KEY-")){var pubKeyHex=pemtohex(param,"PUBLIC KEY");return _KEYUTIL._getKeyFromPublicPKCS8Hex(pubKeyHex)}if(-1!=param.indexOf("-END RSA PRIVATE KEY-")&&-1==param.indexOf("4,ENCRYPTED")){var hex=_pemtohex(param,"RSA PRIVATE KEY");return _KEYUTIL.getKey(hex,null,"pkcs5prv")}if(-1!=param.indexOf("-END DSA PRIVATE KEY-")&&-1==param.indexOf("4,ENCRYPTED")){var p=_getVbyList(hKey=_pemtohex(param,"DSA PRIVATE KEY"),0,[1],"02"),q=_getVbyList(hKey,0,[2],"02"),g=_getVbyList(hKey,0,[3],"02"),y=_getVbyList(hKey,0,[4],"02"),x=_getVbyList(hKey,0,[5],"02");return(key=new _KJUR_crypto_DSA).setPrivate(new BigInteger(p,16),new BigInteger(q,16),new BigInteger(g,16),new BigInteger(y,16),new BigInteger(x,16)),key}if(-1!=param.indexOf("-END PRIVATE KEY-"))return _KEYUTIL.getKeyFromPlainPrivatePKCS8PEM(param);if(-1!=param.indexOf("-END RSA PRIVATE KEY-")&&-1!=param.indexOf("4,ENCRYPTED")){var hPKey=_KEYUTIL.getDecryptedKeyHex(param,passcode),rsaKey=new RSAKey;return rsaKey.readPKCS5PrvKeyHex(hPKey),rsaKey}if(-1!=param.indexOf("-END EC PRIVATE KEY-")&&-1!=param.indexOf("4,ENCRYPTED")){var ec,key=_getVbyList(hKey=_KEYUTIL.getDecryptedKeyHex(param,passcode),0,[1],"04"),curveNameOidHex=_getVbyList(hKey,0,[2,0],"06"),pubkey=_getVbyList(hKey,0,[3,0],"03").substr(2);if(KJUR.crypto.OID.oidhex2name[curveNameOidHex]===undefined)throw"undefined OID(hex) in KJUR.crypto.OID: "+curveNameOidHex;return(ec=new _KJUR_crypto_ECDSA({curve:KJUR.crypto.OID.oidhex2name[curveNameOidHex]})).setPublicKeyHex(pubkey),ec.setPrivateKeyHex(key),ec.isPublic=!1,ec}if(-1!=param.indexOf("-END DSA PRIVATE KEY-")&&-1!=param.indexOf("4,ENCRYPTED")){var hKey;p=_getVbyList(hKey=_KEYUTIL.getDecryptedKeyHex(param,passcode),0,[1],"02"),q=_getVbyList(hKey,0,[2],"02"),g=_getVbyList(hKey,0,[3],"02"),y=_getVbyList(hKey,0,[4],"02"),x=_getVbyList(hKey,0,[5],"02");return(key=new _KJUR_crypto_DSA).setPrivate(new BigInteger(p,16),new BigInteger(q,16),new BigInteger(g,16),new BigInteger(y,16),new BigInteger(x,16)),key}if(-1!=param.indexOf("-END ENCRYPTED PRIVATE KEY-"))return _KEYUTIL.getKeyFromEncryptedPKCS8PEM(param,passcode);throw"not supported argument"},KEYUTIL.generateKeypair=function(alg,keylenOrCurve){if("RSA"==alg){var keylen=keylenOrCurve;(prvKey=new RSAKey).generate(keylen,"10001"),prvKey.isPrivate=!0,prvKey.isPublic=!0;var pubKey=new RSAKey,hN=prvKey.n.toString(16),hE=prvKey.e.toString(16);return pubKey.setPublic(hN,hE),pubKey.isPrivate=!1,pubKey.isPublic=!0,(result={}).prvKeyObj=prvKey,result.pubKeyObj=pubKey,result}if("EC"!=alg)throw"unknown algorithm: "+alg;var prvKey,result,curve=keylenOrCurve,keypairHex=new KJUR.crypto.ECDSA({curve:curve}).generateKeyPairHex();return(prvKey=new KJUR.crypto.ECDSA({curve:curve})).setPublicKeyHex(keypairHex.ecpubhex),prvKey.setPrivateKeyHex(keypairHex.ecprvhex),prvKey.isPrivate=!0,prvKey.isPublic=!1,(pubKey=new KJUR.crypto.ECDSA({curve:curve})).setPublicKeyHex(keypairHex.ecpubhex),pubKey.isPrivate=!1,pubKey.isPublic=!0,(result={}).prvKeyObj=prvKey,result.pubKeyObj=pubKey,result},KEYUTIL.getPEM=function(keyObjOrHex,formatType,passwd,encAlg,hexType,ivsaltHex){var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DERObjectIdentifier=_KJUR_asn1.DERObjectIdentifier,_DERInteger=_KJUR_asn1.DERInteger,_newObject=_KJUR_asn1.ASN1Util.newObject,_SubjectPublicKeyInfo=_KJUR_asn1.x509.SubjectPublicKeyInfo,_KJUR_crypto=_KJUR.crypto,_DSA=_KJUR_crypto.DSA,_ECDSA=_KJUR_crypto.ECDSA,_RSAKey=RSAKey;function _rsaprv2asn1obj(keyObjOrHex){return _newObject({seq:[{"int":0},{"int":{bigint:keyObjOrHex.n}},{"int":keyObjOrHex.e},{"int":{bigint:keyObjOrHex.d}},{"int":{bigint:keyObjOrHex.p}},{"int":{bigint:keyObjOrHex.q}},{"int":{bigint:keyObjOrHex.dmp1}},{"int":{bigint:keyObjOrHex.dmq1}},{"int":{bigint:keyObjOrHex.coeff}}]})}function _ecdsaprv2asn1obj(keyObjOrHex){return _newObject({seq:[{"int":1},{octstr:{hex:keyObjOrHex.prvKeyHex}},{tag:["a0",!0,{oid:{name:keyObjOrHex.curveName}}]},{tag:["a1",!0,{bitstr:{hex:"00"+keyObjOrHex.pubKeyHex}}]}]})}function _dsaprv2asn1obj(keyObjOrHex){return _newObject({seq:[{"int":0},{"int":{bigint:keyObjOrHex.p}},{"int":{bigint:keyObjOrHex.q}},{"int":{bigint:keyObjOrHex.g}},{"int":{bigint:keyObjOrHex.y}},{"int":{bigint:keyObjOrHex.x}}]})}if((_RSAKey!==undefined&&keyObjOrHex instanceof _RSAKey||_DSA!==undefined&&keyObjOrHex instanceof _DSA||_ECDSA!==undefined&&keyObjOrHex instanceof _ECDSA)&&1==keyObjOrHex.isPublic&&(formatType===undefined||"PKCS8PUB"==formatType))return hextopem(asn1Hex=new _SubjectPublicKeyInfo(keyObjOrHex).getEncodedHex(),"PUBLIC KEY");if("PKCS1PRV"==formatType&&_RSAKey!==undefined&&keyObjOrHex instanceof _RSAKey&&(passwd===undefined||null==passwd)&&1==keyObjOrHex.isPrivate)return hextopem(asn1Hex=_rsaprv2asn1obj(keyObjOrHex).getEncodedHex(),"RSA PRIVATE KEY");if("PKCS1PRV"==formatType&&_ECDSA!==undefined&&keyObjOrHex instanceof _ECDSA&&(passwd===undefined||null==passwd)&&1==keyObjOrHex.isPrivate){var asn1Hex1=new _DERObjectIdentifier({name:keyObjOrHex.curveName}).getEncodedHex(),asn1Hex2=_ecdsaprv2asn1obj(keyObjOrHex).getEncodedHex(),s="";return s+=hextopem(asn1Hex1,"EC PARAMETERS"),s+=hextopem(asn1Hex2,"EC PRIVATE KEY")}if("PKCS1PRV"==formatType&&_DSA!==undefined&&keyObjOrHex instanceof _DSA&&(passwd===undefined||null==passwd)&&1==keyObjOrHex.isPrivate)return hextopem(asn1Hex=_dsaprv2asn1obj(keyObjOrHex).getEncodedHex(),"DSA PRIVATE KEY");if("PKCS5PRV"==formatType&&_RSAKey!==undefined&&keyObjOrHex instanceof _RSAKey&&passwd!==undefined&&null!=passwd&&1==keyObjOrHex.isPrivate){var asn1Hex=_rsaprv2asn1obj(keyObjOrHex).getEncodedHex();return encAlg===undefined&&(encAlg="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("RSA",asn1Hex,passwd,encAlg,ivsaltHex)}if("PKCS5PRV"==formatType&&_ECDSA!==undefined&&keyObjOrHex instanceof _ECDSA&&passwd!==undefined&&null!=passwd&&1==keyObjOrHex.isPrivate){asn1Hex=_ecdsaprv2asn1obj(keyObjOrHex).getEncodedHex();return encAlg===undefined&&(encAlg="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("EC",asn1Hex,passwd,encAlg,ivsaltHex)}if("PKCS5PRV"==formatType&&_DSA!==undefined&&keyObjOrHex instanceof _DSA&&passwd!==undefined&&null!=passwd&&1==keyObjOrHex.isPrivate){asn1Hex=_dsaprv2asn1obj(keyObjOrHex).getEncodedHex();return encAlg===undefined&&(encAlg="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("DSA",asn1Hex,passwd,encAlg,ivsaltHex)}var _getEncryptedPKCS8=function(plainKeyHex,passcode){var info=_getEencryptedPKCS8Info(plainKeyHex,passcode);return new _newObject({seq:[{seq:[{oid:{name:"pkcs5PBES2"}},{seq:[{seq:[{oid:{name:"pkcs5PBKDF2"}},{seq:[{octstr:{hex:info.pbkdf2Salt}},{"int":info.pbkdf2Iter}]}]},{seq:[{oid:{name:"des-EDE3-CBC"}},{octstr:{hex:info.encryptionSchemeIV}}]}]}]},{octstr:{hex:info.ciphertext}}]}).getEncodedHex()},_getEencryptedPKCS8Info=function(plainKeyHex,passcode){var pbkdf2SaltWS=CryptoJS.lib.WordArray.random(8),encryptionSchemeIVWS=CryptoJS.lib.WordArray.random(8),pbkdf2KeyWS=CryptoJS.PBKDF2(passcode,pbkdf2SaltWS,{keySize:6,iterations:100}),plainKeyWS=CryptoJS.enc.Hex.parse(plainKeyHex),encryptedKeyHex=CryptoJS.TripleDES.encrypt(plainKeyWS,pbkdf2KeyWS,{iv:encryptionSchemeIVWS})+"",info={};return info.ciphertext=encryptedKeyHex,info.pbkdf2Salt=CryptoJS.enc.Hex.stringify(pbkdf2SaltWS),info.pbkdf2Iter=100,info.encryptionSchemeAlg="DES-EDE3-CBC",info.encryptionSchemeIV=CryptoJS.enc.Hex.stringify(encryptionSchemeIVWS),info};if("PKCS8PRV"==formatType&&_RSAKey!=undefined&&keyObjOrHex instanceof _RSAKey&&1==keyObjOrHex.isPrivate){var keyHex=_rsaprv2asn1obj(keyObjOrHex).getEncodedHex();asn1Hex=_newObject({seq:[{"int":0},{seq:[{oid:{name:"rsaEncryption"}},{"null":!0}]},{octstr:{hex:keyHex}}]}).getEncodedHex();return passwd===undefined||null==passwd?hextopem(asn1Hex,"PRIVATE KEY"):hextopem(asn1Hex2=_getEncryptedPKCS8(asn1Hex,passwd),"ENCRYPTED PRIVATE KEY")}if("PKCS8PRV"==formatType&&_ECDSA!==undefined&&keyObjOrHex instanceof _ECDSA&&1==keyObjOrHex.isPrivate){keyHex=new _newObject({seq:[{"int":1},{octstr:{hex:keyObjOrHex.prvKeyHex}},{tag:["a1",!0,{bitstr:{hex:"00"+keyObjOrHex.pubKeyHex}}]}]}).getEncodedHex(),asn1Hex=_newObject({seq:[{"int":0},{seq:[{oid:{name:"ecPublicKey"}},{oid:{name:keyObjOrHex.curveName}}]},{octstr:{hex:keyHex}}]}).getEncodedHex();return passwd===undefined||null==passwd?hextopem(asn1Hex,"PRIVATE KEY"):hextopem(asn1Hex2=_getEncryptedPKCS8(asn1Hex,passwd),"ENCRYPTED PRIVATE KEY")}if("PKCS8PRV"==formatType&&_DSA!==undefined&&keyObjOrHex instanceof _DSA&&1==keyObjOrHex.isPrivate){keyHex=new _DERInteger({bigint:keyObjOrHex.x}).getEncodedHex(),asn1Hex=_newObject({seq:[{"int":0},{seq:[{oid:{name:"dsa"}},{seq:[{"int":{bigint:keyObjOrHex.p}},{"int":{bigint:keyObjOrHex.q}},{"int":{bigint:keyObjOrHex.g}}]}]},{octstr:{hex:keyHex}}]}).getEncodedHex();return passwd===undefined||null==passwd?hextopem(asn1Hex,"PRIVATE KEY"):hextopem(asn1Hex2=_getEncryptedPKCS8(asn1Hex,passwd),"ENCRYPTED PRIVATE KEY")}throw"unsupported object nor format"},KEYUTIL.getKeyFromCSRPEM=function(csrPEM){var csrHex=pemtohex(csrPEM,"CERTIFICATE REQUEST");return KEYUTIL.getKeyFromCSRHex(csrHex)},KEYUTIL.getKeyFromCSRHex=function(csrHex){var info=KEYUTIL.parseCSRHex(csrHex);return KEYUTIL.getKey(info.p8pubkeyhex,null,"pkcs8pub")},KEYUTIL.parseCSRHex=function(csrHex){var _ASN1HEX=ASN1HEX,_getChildIdx=_ASN1HEX.getChildIdx,_getTLV=_ASN1HEX.getTLV,result={},h=csrHex;if("30"!=h.substr(0,2))throw"malformed CSR(code:001)";var a1=_getChildIdx(h,0);if(a1.length<1)throw"malformed CSR(code:002)";if("30"!=h.substr(a1[0],2))throw"malformed CSR(code:003)";var a2=_getChildIdx(h,a1[0]);if(a2.length<3)throw"malformed CSR(code:004)";return result.p8pubkeyhex=_getTLV(h,a2[2]),result},KEYUTIL.getJWKFromKey=function(keyObj){var jwk={};if(keyObj instanceof RSAKey&&keyObj.isPrivate)return jwk.kty="RSA",jwk.n=hextob64u(keyObj.n.toString(16)),jwk.e=hextob64u(keyObj.e.toString(16)),jwk.d=hextob64u(keyObj.d.toString(16)),jwk.p=hextob64u(keyObj.p.toString(16)),jwk.q=hextob64u(keyObj.q.toString(16)),jwk.dp=hextob64u(keyObj.dmp1.toString(16)),jwk.dq=hextob64u(keyObj.dmq1.toString(16)),jwk.qi=hextob64u(keyObj.coeff.toString(16)),jwk;if(keyObj instanceof RSAKey&&keyObj.isPublic)return jwk.kty="RSA",jwk.n=hextob64u(keyObj.n.toString(16)),jwk.e=hextob64u(keyObj.e.toString(16)),jwk;if(keyObj instanceof KJUR.crypto.ECDSA&&keyObj.isPrivate){if("P-256"!==(name=keyObj.getShortNISTPCurveName())&&"P-384"!==name)throw"unsupported curve name for JWT: "+name;var xy=keyObj.getPublicKeyXYHex();return jwk.kty="EC",jwk.crv=name,jwk.x=hextob64u(xy.x),jwk.y=hextob64u(xy.y),jwk.d=hextob64u(keyObj.prvKeyHex),jwk}if(keyObj instanceof KJUR.crypto.ECDSA&&keyObj.isPublic){var name;if("P-256"!==(name=keyObj.getShortNISTPCurveName())&&"P-384"!==name)throw"unsupported curve name for JWT: "+name;xy=keyObj.getPublicKeyXYHex();return jwk.kty="EC",jwk.crv=name,jwk.x=hextob64u(xy.x),jwk.y=hextob64u(xy.y),jwk}throw"not supported key object"},void 0!==KJUR&&KJUR||(KJUR={}),"undefined"!=typeof KJUR.crypto&&KJUR.crypto||(KJUR.crypto={}),KJUR.crypto.ECParameterDB=new function(){var db={},aliasDB={};function hex2bi(hex){return new BigInteger(hex,16)}this.getByName=function(nameOrAlias){var name=nameOrAlias;if("undefined"!=typeof aliasDB[name]&&(name=aliasDB[nameOrAlias]),"undefined"!=typeof db[name])return db[name];throw"unregistered EC curve name: "+name},this.regist=function(name,keylen,pHex,aHex,bHex,nHex,hHex,gxHex,gyHex,aliasList,oid,info){db[name]={};var p=hex2bi(pHex),a=hex2bi(aHex),b=hex2bi(bHex),n=hex2bi(nHex),h=hex2bi(hHex),curve=new ECCurveFp(p,a,b),G=curve.decodePointHex("04"+gxHex+gyHex);db[name].name=name,db[name].keylen=keylen,db[name].curve=curve,db[name].G=G,db[name].n=n,db[name].h=h,db[name].oid=oid,db[name].info=info;for(var i=0;i<aliasList.length;i++)aliasDB[aliasList[i]]=name}},KJUR.crypto.ECParameterDB.regist("secp128r1",128,"FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFC","E87579C11079F43DD824993C2CEE5ED3","FFFFFFFE0000000075A30D1B9038A115","1","161FF7528B899B2D0C28607CA52C5B86","CF5AC8395BAFEB13C02DA292DDED7A83",[],"","secp128r1 : SECG curve over a 128 bit prime field"),KJUR.crypto.ECParameterDB.regist("secp160k1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFAC73","0","7","0100000000000000000001B8FA16DFAB9ACA16B6B3","1","3B4C382CE37AA192A4019E763036F4F5DD4D7EBB","938CF935318FDCED6BC28286531733C3F03C4FEE",[],"","secp160k1 : SECG curve over a 160 bit prime field"),KJUR.crypto.ECParameterDB.regist("secp160r1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFC","1C97BEFC54BD7A8B65ACF89F81D4D4ADC565FA45","0100000000000000000001F4C8F927AED3CA752257","1","4A96B5688EF573284664698968C38BB913CBFC82","23A628553168947D59DCC912042351377AC5FB32",[],"","secp160r1 : SECG curve over a 160 bit prime field"),KJUR.crypto.ECParameterDB.regist("secp192k1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFEE37","0","3","FFFFFFFFFFFFFFFFFFFFFFFE26F2FC170F69466A74DEFD8D","1","DB4FF10EC057E9AE26B07D0280B7F4341DA5D1B1EAE06C7D","9B2F2F6D9C5628A7844163D015BE86344082AA88D95E2F9D",[]),KJUR.crypto.ECParameterDB.regist("secp192r1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFC","64210519E59C80E70FA7E9AB72243049FEB8DEECC146B9B1","FFFFFFFFFFFFFFFFFFFFFFFF99DEF836146BC9B1B4D22831","1","188DA80EB03090F67CBF20EB43A18800F4FF0AFD82FF1012","07192B95FFC8DA78631011ED6B24CDD573F977A11E794811",[]),KJUR.crypto.ECParameterDB.regist("secp224r1",224,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000001","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFE","B4050A850C04B3ABF54132565044B0B7D7BFD8BA270B39432355FFB4","FFFFFFFFFFFFFFFFFFFFFFFFFFFF16A2E0B8F03E13DD29455C5C2A3D","1","B70E0CBD6BB4BF7F321390B94A03C1D356C21122343280D6115C1D21","BD376388B5F723FB4C22DFE6CD4375A05A07476444D5819985007E34",[]),KJUR.crypto.ECParameterDB.regist("secp256k1",256,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFC2F","0","7","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141","1","79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798","483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8",[]),KJUR.crypto.ECParameterDB.regist("secp256r1",256,"FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFC","5AC635D8AA3A93E7B3EBBD55769886BC651D06B0CC53B0F63BCE3C3E27D2604B","FFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC632551","1","6B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C296","4FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5",["NIST P-256","P-256","prime256v1"]),KJUR.crypto.ECParameterDB.regist("secp384r1",384,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFC","B3312FA7E23EE7E4988E056BE3F82D19181D9C6EFE8141120314088F5013875AC656398D8A2ED19D2A85C8EDD3EC2AEF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC7634D81F4372DDF581A0DB248B0A77AECEC196ACCC52973","1","AA87CA22BE8B05378EB1C71EF320AD746E1D3B628BA79B9859F741E082542A385502F25DBF55296C3A545E3872760AB7","3617de4a96262c6f5d9e98bf9292dc29f8f41dbd289a147ce9da3113b5f0b8c00a60b1ce1d7e819d7a431d7c90ea0e5f",["NIST P-384","P-384"]),KJUR.crypto.ECParameterDB.regist("secp521r1",521,"1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC","051953EB9618E1C9A1F929A21A0B68540EEA2DA725B99B315F3B8B489918EF109E156193951EC7E937B1652C0BD3BB1BF073573DF883D2C34F1EF451FD46B503F00","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA51868783BF2F966B7FCC0148F709A5D03BB5C9B8899C47AEBB6FB71E91386409","1","C6858E06B70404E9CD9E3ECB662395B4429C648139053FB521F828AF606B4D3DBAA14B5E77EFE75928FE1DC127A2FFA8DE3348B3C1856A429BF97E7E31C2E5BD66","011839296a789a3bc0045c8a5fb42c7d1bd998f54449579b446817afbd17273e662c97ee72995ef42640c550b9013fad0761353c7086a272c24088be94769fd16650",["NIST P-521","P-521"]),void 0!==KJUR&&KJUR||(KJUR={}),"undefined"!=typeof KJUR.asn1&&KJUR.asn1||(KJUR.asn1={}),KJUR.asn1.ASN1Util=new function(){this.integerToByteHex=function(i){var h=i.toString(16);return h.length%2==1&&(h="0"+h),h},this.bigIntToMinTwosComplementsHex=function(bigIntegerValue){var h=bigIntegerValue.toString(16);if("-"!=h.substr(0,1))h.length%2==1?h="0"+h:h.match(/^[0-7]/)||(h="00"+h);else{var xorLen=h.substr(1).length;xorLen%2==1?xorLen+=1:h.match(/^[0-7]/)||(xorLen+=2);for(var hMask="",i=0;i<xorLen;i++)hMask+="f";h=new BigInteger(hMask,16).xor(bigIntegerValue).add(BigInteger.ONE).toString(16).replace(/^-/,"")}return h},this.getPEMStringFromHex=function(dataHex,pemHeader){return hextopem(dataHex,pemHeader)},this.newObject=function(param){var _KJUR_asn1=KJUR.asn1,_DERBoolean=_KJUR_asn1.DERBoolean,_DERInteger=_KJUR_asn1.DERInteger,_DERBitString=_KJUR_asn1.DERBitString,_DEROctetString=_KJUR_asn1.DEROctetString,_DERNull=_KJUR_asn1.DERNull,_DERObjectIdentifier=_KJUR_asn1.DERObjectIdentifier,_DEREnumerated=_KJUR_asn1.DEREnumerated,_DERUTF8String=_KJUR_asn1.DERUTF8String,_DERNumericString=_KJUR_asn1.DERNumericString,_DERPrintableString=_KJUR_asn1.DERPrintableString,_DERTeletexString=_KJUR_asn1.DERTeletexString,_DERIA5String=_KJUR_asn1.DERIA5String,_DERUTCTime=_KJUR_asn1.DERUTCTime,_DERGeneralizedTime=_KJUR_asn1.DERGeneralizedTime,_DERSequence=_KJUR_asn1.DERSequence,_DERSet=_KJUR_asn1.DERSet,_DERTaggedObject=_KJUR_asn1.DERTaggedObject,_newObject=_KJUR_asn1.ASN1Util.newObject,keys=Object.keys(param);if(1!=keys.length)throw"key of param shall be only one.";var key=keys[0];if(-1==":bool:int:bitstr:octstr:null:oid:enum:utf8str:numstr:prnstr:telstr:ia5str:utctime:gentime:seq:set:tag:".indexOf(":"+key+":"))throw"undefined key: "+key;if("bool"==key)return new _DERBoolean(param[key]);if("int"==key)return new _DERInteger(param[key]);if("bitstr"==key)return new _DERBitString(param[key]);if("octstr"==key)return new _DEROctetString(param[key]);if("null"==key)return new _DERNull(param[key]);if("oid"==key)return new _DERObjectIdentifier(param[key]);if("enum"==key)return new _DEREnumerated(param[key]);if("utf8str"==key)return new _DERUTF8String(param[key]);if("numstr"==key)return new _DERNumericString(param[key]);if("prnstr"==key)return new _DERPrintableString(param[key]);if("telstr"==key)return new _DERTeletexString(param[key]);if("ia5str"==key)return new _DERIA5String(param[key]);if("utctime"==key)return new _DERUTCTime(param[key]);if("gentime"==key)return new _DERGeneralizedTime(param[key]);if("seq"==key){for(var paramList=param[key],a=[],i=0;i<paramList.length;i++){var asn1Obj=_newObject(paramList[i]);a.push(asn1Obj)}return new _DERSequence({array:a})}if("set"==key){for(paramList=param[key],a=[],i=0;i<paramList.length;i++){asn1Obj=_newObject(paramList[i]);a.push(asn1Obj)}return new _DERSet({array:a})}if("tag"==key){var tagParam=param[key];if("[object Array]"===Object.prototype.toString.call(tagParam)&&3==tagParam.length){var obj=_newObject(tagParam[2]);return new _DERTaggedObject({tag:tagParam[0],explicit:tagParam[1],obj:obj})}var newParam={};if(tagParam.explicit!==undefined&&(newParam.explicit=tagParam.explicit),tagParam.tag!==undefined&&(newParam.tag=tagParam.tag),tagParam.obj===undefined)throw"obj shall be specified for 'tag'.";return newParam.obj=_newObject(tagParam.obj),new _DERTaggedObject(newParam)}},this.jsonToASN1HEX=function(param){return this.newObject(param).getEncodedHex()}},KJUR.asn1.ASN1Util.oidHexToInt=function(hex){for(var s="",i01=parseInt(hex.substr(0,2),16),binbuf=(s=Math.floor(i01/40)+"."+i01%40,""),i=2;i<hex.length;i+=2){var bin=("00000000"+parseInt(hex.substr(i,2),16).toString(2)).slice(-8);if(binbuf+=bin.substr(1,7),"0"==bin.substr(0,1))s=s+"."+new BigInteger(binbuf,2).toString(10),binbuf=""}return s},KJUR.asn1.ASN1Util.oidIntToHex=function(oidString){var itox=function(i){var h=i.toString(16);return 1==h.length&&(h="0"+h),h},roidtox=function(roid){var h="",b=new BigInteger(roid,10).toString(2),padLen=7-b.length%7;7==padLen&&(padLen=0);for(var bPad="",i=0;i<padLen;i++)bPad+="0";b=bPad+b;for(i=0;i<b.length-1;i+=7){var b8=b.substr(i,7);i!=b.length-7&&(b8="1"+b8),h+=itox(parseInt(b8,2))}return h};if(!oidString.match(/^[0-9.]+$/))throw"malformed oid string: "+oidString;var h="",a=oidString.split("."),i0=40*parseInt(a[0])+parseInt(a[1]);h+=itox(i0),a.splice(0,2);for(var i=0;i<a.length;i++)h+=roidtox(a[i]);return h},KJUR.asn1.ASN1Object=function(){this.getLengthHexFromValue=function(){if("undefined"==typeof this.hV||null==this.hV)throw"this.hV is null or undefined.";if(this.hV.length%2==1)throw"value hex must be even length: n="+"".length+",v="+this.hV;var n=this.hV.length/2,hN=n.toString(16);if(hN.length%2==1&&(hN="0"+hN),n<128)return hN;var hNlen=hN.length/2;if(15<hNlen)throw"ASN.1 length too long to represent by 8x: n = "+n.toString(16);return(128+hNlen).toString(16)+hN},this.getEncodedHex=function(){return(null==this.hTLV||this.isModified)&&(this.hV=this.getFreshValueHex(),this.hL=this.getLengthHexFromValue(),this.hTLV=this.hT+this.hL+this.hV,this.isModified=!1),this.hTLV},this.getValueHex=function(){return this.getEncodedHex(),this.hV},this.getFreshValueHex=function(){return""}},KJUR.asn1.DERAbstractString=function(params){KJUR.asn1.DERAbstractString.superclass.constructor.call(this);this.getString=function(){return this.s},this.setString=function(newS){this.hTLV=null,this.isModified=!0,this.s=newS,this.hV=stohex(this.s)},this.setStringHex=function(newHexString){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=newHexString},this.getFreshValueHex=function(){return this.hV},void 0!==params&&("string"==typeof params?this.setString(params):"undefined"!=typeof params.str?this.setString(params.str):"undefined"!=typeof params.hex&&this.setStringHex(params.hex))},YAHOO.lang.extend(KJUR.asn1.DERAbstractString,KJUR.asn1.ASN1Object),KJUR.asn1.DERAbstractTime=function(params){KJUR.asn1.DERAbstractTime.superclass.constructor.call(this);this.localDateToUTC=function(d){return utc=d.getTime()+6e4*d.getTimezoneOffset(),new Date(utc)},this.formatDate=function(dateObject,type,withMillis){var pad=this.zeroPadding,d=this.localDateToUTC(dateObject),year=String(d.getFullYear());"utc"==type&&(year=year.substr(2,2));var s=year+pad(String(d.getMonth()+1),2)+pad(String(d.getDate()),2)+pad(String(d.getHours()),2)+pad(String(d.getMinutes()),2)+pad(String(d.getSeconds()),2);if(!0===withMillis){var millis=d.getMilliseconds();if(0!=millis){var sMillis=pad(String(millis),3);s=s+"."+(sMillis=sMillis.replace(/[0]+$/,""))}}return s+"Z"},this.zeroPadding=function(s,len){return s.length>=len?s:new Array(len-s.length+1).join("0")+s},this.getString=function(){return this.s},this.setString=function(newS){this.hTLV=null,this.isModified=!0,this.s=newS,this.hV=stohex(newS)},this.setByDateValue=function(year,month,day,hour,min,sec){var dateObject=new Date(Date.UTC(year,month-1,day,hour,min,sec,0));this.setByDate(dateObject)},this.getFreshValueHex=function(){return this.hV}},YAHOO.lang.extend(KJUR.asn1.DERAbstractTime,KJUR.asn1.ASN1Object),KJUR.asn1.DERAbstractStructured=function(params){KJUR.asn1.DERAbstractString.superclass.constructor.call(this);this.setByASN1ObjectArray=function(asn1ObjectArray){this.hTLV=null,this.isModified=!0,this.asn1Array=asn1ObjectArray},this.appendASN1Object=function(asn1Object){this.hTLV=null,this.isModified=!0,this.asn1Array.push(asn1Object)},this.asn1Array=new Array,void 0!==params&&"undefined"!=typeof params.array&&(this.asn1Array=params.array)},YAHOO.lang.extend(KJUR.asn1.DERAbstractStructured,KJUR.asn1.ASN1Object),KJUR.asn1.DERBoolean=function(){KJUR.asn1.DERBoolean.superclass.constructor.call(this),this.hT="01",this.hTLV="0101ff"},YAHOO.lang.extend(KJUR.asn1.DERBoolean,KJUR.asn1.ASN1Object),KJUR.asn1.DERInteger=function(params){KJUR.asn1.DERInteger.superclass.constructor.call(this),this.hT="02",this.setByBigInteger=function(bigIntegerValue){this.hTLV=null,this.isModified=!0,this.hV=KJUR.asn1.ASN1Util.bigIntToMinTwosComplementsHex(bigIntegerValue)},this.setByInteger=function(intValue){var bi=new BigInteger(String(intValue),10);this.setByBigInteger(bi)},this.setValueHex=function(newHexString){this.hV=newHexString},this.getFreshValueHex=function(){return this.hV},void 0!==params&&("undefined"!=typeof params.bigint?this.setByBigInteger(params.bigint):"undefined"!=typeof params["int"]?this.setByInteger(params["int"]):"number"==typeof params?this.setByInteger(params):"undefined"!=typeof params.hex&&this.setValueHex(params.hex))},YAHOO.lang.extend(KJUR.asn1.DERInteger,KJUR.asn1.ASN1Object),KJUR.asn1.DERBitString=function(params){if(params!==undefined&&"undefined"!=typeof params.obj){var o=KJUR.asn1.ASN1Util.newObject(params.obj);params.hex="00"+o.getEncodedHex()}KJUR.asn1.DERBitString.superclass.constructor.call(this),this.hT="03",this.setHexValueIncludingUnusedBits=function(newHexStringIncludingUnusedBits){this.hTLV=null,this.isModified=!0,this.hV=newHexStringIncludingUnusedBits},this.setUnusedBitsAndHexValue=function(unusedBits,hValue){if(unusedBits<0||7<unusedBits)throw"unused bits shall be from 0 to 7: u = "+unusedBits;var hUnusedBits="0"+unusedBits;this.hTLV=null,this.isModified=!0,this.hV=hUnusedBits+hValue},this.setByBinaryString=function(binaryString){var unusedBits=8-(binaryString=binaryString.replace(/0+$/,"")).length%8;8==unusedBits&&(unusedBits=0);for(var i=0;i<=unusedBits;i++)binaryString+="0";var h="";for(i=0;i<binaryString.length-1;i+=8){var b=binaryString.substr(i,8),x=parseInt(b,2).toString(16);1==x.length&&(x="0"+x),h+=x}this.hTLV=null,this.isModified=!0,this.hV="0"+unusedBits+h},this.setByBooleanArray=function(booleanArray){for(var s="",i=0;i<booleanArray.length;i++)1==booleanArray[i]?s+="1":s+="0";this.setByBinaryString(s)},this.newFalseArray=function(nLength){for(var a=new Array(nLength),i=0;i<nLength;i++)a[i]=!1;return a},this.getFreshValueHex=function(){return this.hV},void 0!==params&&("string"==typeof params&&params.toLowerCase().match(/^[0-9a-f]+$/)?this.setHexValueIncludingUnusedBits(params):"undefined"!=typeof params.hex?this.setHexValueIncludingUnusedBits(params.hex):"undefined"!=typeof params.bin?this.setByBinaryString(params.bin):"undefined"!=typeof params.array&&this.setByBooleanArray(params.array))},YAHOO.lang.extend(KJUR.asn1.DERBitString,KJUR.asn1.ASN1Object),KJUR.asn1.DEROctetString=function(params){if(params!==undefined&&"undefined"!=typeof params.obj){var o=KJUR.asn1.ASN1Util.newObject(params.obj);params.hex=o.getEncodedHex()}KJUR.asn1.DEROctetString.superclass.constructor.call(this,params),this.hT="04"},YAHOO.lang.extend(KJUR.asn1.DEROctetString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERNull=function(){KJUR.asn1.DERNull.superclass.constructor.call(this),this.hT="05",this.hTLV="0500"},YAHOO.lang.extend(KJUR.asn1.DERNull,KJUR.asn1.ASN1Object),KJUR.asn1.DERObjectIdentifier=function(params){var itox=function(i){var h=i.toString(16);return 1==h.length&&(h="0"+h),h},roidtox=function(roid){var h="",b=new BigInteger(roid,10).toString(2),padLen=7-b.length%7;7==padLen&&(padLen=0);for(var bPad="",i=0;i<padLen;i++)bPad+="0";b=bPad+b;for(i=0;i<b.length-1;i+=7){var b8=b.substr(i,7);i!=b.length-7&&(b8="1"+b8),h+=itox(parseInt(b8,2))}return h};KJUR.asn1.DERObjectIdentifier.superclass.constructor.call(this),this.hT="06",this.setValueHex=function(newHexString){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=newHexString},this.setValueOidString=function(oidString){if(!oidString.match(/^[0-9.]+$/))throw"malformed oid string: "+oidString;var h="",a=oidString.split("."),i0=40*parseInt(a[0])+parseInt(a[1]);h+=itox(i0),a.splice(0,2);for(var i=0;i<a.length;i++)h+=roidtox(a[i]);this.hTLV=null,this.isModified=!0,this.s=null,this.hV=h},this.setValueName=function(oidName){var oid=KJUR.asn1.x509.OID.name2oid(oidName);if(""===oid)throw"DERObjectIdentifier oidName undefined: "+oidName;this.setValueOidString(oid)},this.getFreshValueHex=function(){return this.hV},params!==undefined&&("string"==typeof params?params.match(/^[0-2].[0-9.]+$/)?this.setValueOidString(params):this.setValueName(params):params.oid!==undefined?this.setValueOidString(params.oid):params.hex!==undefined?this.setValueHex(params.hex):params.name!==undefined&&this.setValueName(params.name))},YAHOO.lang.extend(KJUR.asn1.DERObjectIdentifier,KJUR.asn1.ASN1Object),KJUR.asn1.DEREnumerated=function(params){KJUR.asn1.DEREnumerated.superclass.constructor.call(this),this.hT="0a",this.setByBigInteger=function(bigIntegerValue){this.hTLV=null,this.isModified=!0,this.hV=KJUR.asn1.ASN1Util.bigIntToMinTwosComplementsHex(bigIntegerValue)},this.setByInteger=function(intValue){var bi=new BigInteger(String(intValue),10);this.setByBigInteger(bi)},this.setValueHex=function(newHexString){this.hV=newHexString},this.getFreshValueHex=function(){return this.hV},void 0!==params&&("undefined"!=typeof params["int"]?this.setByInteger(params["int"]):"number"==typeof params?this.setByInteger(params):"undefined"!=typeof params.hex&&this.setValueHex(params.hex))},YAHOO.lang.extend(KJUR.asn1.DEREnumerated,KJUR.asn1.ASN1Object),KJUR.asn1.DERUTF8String=function(params){KJUR.asn1.DERUTF8String.superclass.constructor.call(this,params),this.hT="0c"},YAHOO.lang.extend(KJUR.asn1.DERUTF8String,KJUR.asn1.DERAbstractString),KJUR.asn1.DERNumericString=function(params){KJUR.asn1.DERNumericString.superclass.constructor.call(this,params),this.hT="12"},YAHOO.lang.extend(KJUR.asn1.DERNumericString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERPrintableString=function(params){KJUR.asn1.DERPrintableString.superclass.constructor.call(this,params),this.hT="13"},YAHOO.lang.extend(KJUR.asn1.DERPrintableString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERTeletexString=function(params){KJUR.asn1.DERTeletexString.superclass.constructor.call(this,params),this.hT="14"},YAHOO.lang.extend(KJUR.asn1.DERTeletexString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERIA5String=function(params){KJUR.asn1.DERIA5String.superclass.constructor.call(this,params),this.hT="16"},YAHOO.lang.extend(KJUR.asn1.DERIA5String,KJUR.asn1.DERAbstractString),KJUR.asn1.DERUTCTime=function(params){KJUR.asn1.DERUTCTime.superclass.constructor.call(this,params),this.hT="17",this.setByDate=function(dateObject){this.hTLV=null,this.isModified=!0,this.date=dateObject,this.s=this.formatDate(this.date,"utc"),this.hV=stohex(this.s)},this.getFreshValueHex=function(){return"undefined"==typeof this.date&&"undefined"==typeof this.s&&(this.date=new Date,this.s=this.formatDate(this.date,"utc"),this.hV=stohex(this.s)),this.hV},params!==undefined&&(params.str!==undefined?this.setString(params.str):"string"==typeof params&&params.match(/^[0-9]{12}Z$/)?this.setString(params):params.hex!==undefined?this.setStringHex(params.hex):params.date!==undefined&&this.setByDate(params.date))},YAHOO.lang.extend(KJUR.asn1.DERUTCTime,KJUR.asn1.DERAbstractTime),KJUR.asn1.DERGeneralizedTime=function(params){KJUR.asn1.DERGeneralizedTime.superclass.constructor.call(this,params),this.hT="18",this.withMillis=!1,this.setByDate=function(dateObject){this.hTLV=null,this.isModified=!0,this.date=dateObject,this.s=this.formatDate(this.date,"gen",this.withMillis),this.hV=stohex(this.s)},this.getFreshValueHex=function(){return this.date===undefined&&this.s===undefined&&(this.date=new Date,this.s=this.formatDate(this.date,"gen",this.withMillis),this.hV=stohex(this.s)),this.hV},params!==undefined&&(params.str!==undefined?this.setString(params.str):"string"==typeof params&&params.match(/^[0-9]{14}Z$/)?this.setString(params):params.hex!==undefined?this.setStringHex(params.hex):params.date!==undefined&&this.setByDate(params.date),!0===params.millis&&(this.withMillis=!0))},YAHOO.lang.extend(KJUR.asn1.DERGeneralizedTime,KJUR.asn1.DERAbstractTime),KJUR.asn1.DERSequence=function(params){KJUR.asn1.DERSequence.superclass.constructor.call(this,params),this.hT="30",this.getFreshValueHex=function(){for(var h="",i=0;i<this.asn1Array.length;i++){h+=this.asn1Array[i].getEncodedHex()}return this.hV=h,this.hV}},YAHOO.lang.extend(KJUR.asn1.DERSequence,KJUR.asn1.DERAbstractStructured),KJUR.asn1.DERSet=function(params){KJUR.asn1.DERSet.superclass.constructor.call(this,params),this.hT="31",this.sortFlag=!0,this.getFreshValueHex=function(){for(var a=new Array,i=0;i<this.asn1Array.length;i++){var asn1Obj=this.asn1Array[i];a.push(asn1Obj.getEncodedHex())}return 1==this.sortFlag&&a.sort(),this.hV=a.join(""),this.hV},void 0!==params&&"undefined"!=typeof params.sortflag&&0==params.sortflag&&(this.sortFlag=!1)},YAHOO.lang.extend(KJUR.asn1.DERSet,KJUR.asn1.DERAbstractStructured),KJUR.asn1.DERTaggedObject=function(params){KJUR.asn1.DERTaggedObject.superclass.constructor.call(this),this.hT="a0",this.hV="",this.isExplicit=!0,this.asn1Object=null,this.setASN1Object=function(isExplicitFlag,tagNoHex,asn1Object){this.hT=tagNoHex,this.isExplicit=isExplicitFlag,this.asn1Object=asn1Object,this.isExplicit?(this.hV=this.asn1Object.getEncodedHex(),this.hTLV=null,this.isModified=!0):(this.hV=null,this.hTLV=asn1Object.getEncodedHex(),this.hTLV=this.hTLV.replace(/^../,tagNoHex),this.isModified=!1)},this.getFreshValueHex=function(){return this.hV},void 0!==params&&("undefined"!=typeof params.tag&&(this.hT=params.tag),"undefined"!=typeof params.explicit&&(this.isExplicit=params.explicit),"undefined"!=typeof params.obj&&(this.asn1Object=params.obj,this.setASN1Object(this.isExplicit,this.hT,this.asn1Object)))},YAHOO.lang.extend(KJUR.asn1.DERTaggedObject,KJUR.asn1.ASN1Object),RSAKey.getPosArrayOfChildrenFromHex=function(hPrivateKey){return ASN1HEX.getChildIdx(hPrivateKey,0)},RSAKey.getHexValueArrayOfChildrenFromHex=function(hPrivateKey){var a,_getV=ASN1HEX.getV,h_v=_getV(hPrivateKey,(a=RSAKey.getPosArrayOfChildrenFromHex(hPrivateKey))[0]),h_n=_getV(hPrivateKey,a[1]),h_e=_getV(hPrivateKey,a[2]),h_d=_getV(hPrivateKey,a[3]),h_p=_getV(hPrivateKey,a[4]),h_q=_getV(hPrivateKey,a[5]),h_dp=_getV(hPrivateKey,a[6]),h_dq=_getV(hPrivateKey,a[7]),h_co=_getV(hPrivateKey,a[8]);return(a=new Array).push(h_v,h_n,h_e,h_d,h_p,h_q,h_dp,h_dq,h_co),a},RSAKey.prototype.readPrivateKeyFromPEMString=function(keyPEM){var keyHex=pemtohex(keyPEM),a=RSAKey.getHexValueArrayOfChildrenFromHex(keyHex);this.setPrivateEx(a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])},RSAKey.prototype.readPKCS5PrvKeyHex=function(h){var a=RSAKey.getHexValueArrayOfChildrenFromHex(h);this.setPrivateEx(a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])},RSAKey.prototype.readPKCS8PrvKeyHex=function(h){var hN,hE,hD,hP,hQ,hDP,hDQ,hCO,_ASN1HEX=ASN1HEX,_getVbyList=_ASN1HEX.getVbyList;if(!1===_ASN1HEX.isASN1HEX(h))throw"not ASN.1 hex string";try{hN=_getVbyList(h,0,[2,0,1],"02"),hE=_getVbyList(h,0,[2,0,2],"02"),hD=_getVbyList(h,0,[2,0,3],"02"),hP=_getVbyList(h,0,[2,0,4],"02"),hQ=_getVbyList(h,0,[2,0,5],"02"),hDP=_getVbyList(h,0,[2,0,6],"02"),hDQ=_getVbyList(h,0,[2,0,7],"02"),hCO=_getVbyList(h,0,[2,0,8],"02")}catch(ex){throw"malformed PKCS#8 plain RSA private key"}this.setPrivateEx(hN,hE,hD,hP,hQ,hDP,hDQ,hCO)},RSAKey.prototype.readPKCS5PubKeyHex=function(h){var _ASN1HEX=ASN1HEX,_getV=_ASN1HEX.getV;if(!1===_ASN1HEX.isASN1HEX(h))throw"keyHex is not ASN.1 hex string";var aIdx=_ASN1HEX.getChildIdx(h,0);if(2!==aIdx.length||"02"!==h.substr(aIdx[0],2)||"02"!==h.substr(aIdx[1],2))throw"wrong hex for PKCS#5 public key";var hN=_getV(h,aIdx[0]),hE=_getV(h,aIdx[1]);this.setPublic(hN,hE)},RSAKey.prototype.readPKCS8PubKeyHex=function(h){var _ASN1HEX=ASN1HEX;if(!1===_ASN1HEX.isASN1HEX(h))throw"not ASN.1 hex string";if("06092a864886f70d010101"!==_ASN1HEX.getTLVbyList(h,0,[0,0]))throw"not PKCS8 RSA public key";var p5hex=_ASN1HEX.getTLVbyList(h,0,[1,0]);this.readPKCS5PubKeyHex(p5hex)},RSAKey.prototype.readCertPubKeyHex=function(h,nthPKI){var x,hPub;(x=new X509).readCertHex(h),hPub=x.getPublicKeyHex(),this.readPKCS8PubKeyHex(hPub)};var _RE_HEXDECONLY=new RegExp("");function _rsasign_getHexPaddedDigestInfoForString(s,keySize,hashAlg){var sHashHex=function(s){return KJUR.crypto.Util.hashString(s,hashAlg)}(s);return KJUR.crypto.Util.getPaddedDigestInfoHex(sHashHex,hashAlg,keySize)}function _zeroPaddingOfSignature(hex,bitLength){for(var s="",nZero=bitLength/4-hex.length,i=0;i<nZero;i++)s+="0";return s+hex}function pss_mgf1_str(seed,len,hash){for(var mask="",i=0;mask.length<len;)mask+=hextorstr(hash(rstrtohex(seed+String.fromCharCode.apply(String,[(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i])))),i+=1;return mask}function _rsasign_getDecryptSignatureBI(biSig,hN,hE){var rsa=new RSAKey;return rsa.setPublic(hN,hE),rsa.doPublic(biSig)}function _rsasign_getHexDigestInfoFromSig(biSig,hN,hE){return _rsasign_getDecryptSignatureBI(biSig,hN,hE).toString(16).replace(/^1f+00/,"")}function _rsasign_getAlgNameAndHashFromHexDisgestInfo(hDigestInfo){for(var algName in KJUR.crypto.Util.DIGESTINFOHEAD){var head=KJUR.crypto.Util.DIGESTINFOHEAD[algName],len=head.length;if(hDigestInfo.substring(0,len)==head)return[algName,hDigestInfo.substring(len)]}return[]}_RE_HEXDECONLY.compile("[^0-9a-f]","gi"),RSAKey.prototype.sign=function(s,hashAlg){var sHashHex=function(s){return KJUR.crypto.Util.hashString(s,hashAlg)}(s);return this.signWithMessageHash(sHashHex,hashAlg)},RSAKey.prototype.signWithMessageHash=function(sHashHex,hashAlg){var biPaddedMessage=parseBigInt(KJUR.crypto.Util.getPaddedDigestInfoHex(sHashHex,hashAlg,this.n.bitLength()),16);return _zeroPaddingOfSignature(this.doPrivate(biPaddedMessage).toString(16),this.n.bitLength())},RSAKey.prototype.signPSS=function(s,hashAlg,sLen){var sHex,hHash=(sHex=rstrtohex(s),KJUR.crypto.Util.hashHex(sHex,hashAlg));return sLen===undefined&&(sLen=-1),this.signWithMessageHashPSS(hHash,hashAlg,sLen)},RSAKey.prototype.signWithMessageHashPSS=function(hHash,hashAlg,sLen){var i,mHash=hextorstr(hHash),hLen=mHash.length,emBits=this.n.bitLength()-1,emLen=Math.ceil(emBits/8),hashFunc=function(sHex){return KJUR.crypto.Util.hashHex(sHex,hashAlg)};if(-1===sLen||sLen===undefined)sLen=hLen;else if(-2===sLen)sLen=emLen-hLen-2;else if(sLen<-2)throw"invalid salt length";if(emLen<hLen+sLen+2)throw"data too long";var salt="";0<sLen&&(salt=new Array(sLen),(new SecureRandom).nextBytes(salt),salt=String.fromCharCode.apply(String,salt));var H=hextorstr(hashFunc(rstrtohex("\0\0\0\0\0\0\0\0"+mHash+salt))),PS=[];for(i=0;i<emLen-sLen-hLen-2;i+=1)PS[i]=0;var DB=String.fromCharCode.apply(String,PS)+""+salt,dbMask=pss_mgf1_str(H,DB.length,hashFunc),maskedDB=[];for(i=0;i<DB.length;i+=1)maskedDB[i]=DB.charCodeAt(i)^dbMask.charCodeAt(i);var mask=65280>>8*emLen-emBits&255;for(maskedDB[0]&=~mask,i=0;i<hLen;i++)maskedDB.push(H.charCodeAt(i));return maskedDB.push(188),_zeroPaddingOfSignature(this.doPrivate(new BigInteger(maskedDB)).toString(16),this.n.bitLength())},RSAKey.prototype.verify=function(sMsg,hSig){var biSig=parseBigInt(hSig=(hSig=hSig.replace(_RE_HEXDECONLY,"")).replace(/[ \n]+/g,""),16);if(biSig.bitLength()>this.n.bitLength())return 0;var digestInfoAry=_rsasign_getAlgNameAndHashFromHexDisgestInfo(this.doPublic(biSig).toString(16).replace(/^1f+00/,""));if(0==digestInfoAry.length)return!1;var s,algName=digestInfoAry[0];return digestInfoAry[1]==(s=sMsg,KJUR.crypto.Util.hashString(s,algName))},RSAKey.prototype.verifyWithMessageHash=function(sHashHex,hSig){var biSig=parseBigInt(hSig=(hSig=hSig.replace(_RE_HEXDECONLY,"")).replace(/[ \n]+/g,""),16);if(biSig.bitLength()>this.n.bitLength())return 0;var digestInfoAry=_rsasign_getAlgNameAndHashFromHexDisgestInfo(this.doPublic(biSig).toString(16).replace(/^1f+00/,""));if(0==digestInfoAry.length)return!1;digestInfoAry[0];return digestInfoAry[1]==sHashHex},RSAKey.prototype.verifyPSS=function(sMsg,hSig,hashAlg,sLen){var sHex,hHash=(sHex=rstrtohex(sMsg),KJUR.crypto.Util.hashHex(sHex,hashAlg));return sLen===undefined&&(sLen=-1),this.verifyWithMessageHashPSS(hHash,hSig,hashAlg,sLen)},RSAKey.prototype.verifyWithMessageHashPSS=function(hHash,hSig,hashAlg,sLen){var biSig=new BigInteger(hSig,16);if(biSig.bitLength()>this.n.bitLength())return!1;var i,hashFunc=function(sHex){return KJUR.crypto.Util.hashHex(sHex,hashAlg)},mHash=hextorstr(hHash),hLen=mHash.length,emBits=this.n.bitLength()-1,emLen=Math.ceil(emBits/8);if(-1===sLen||sLen===undefined)sLen=hLen;else if(-2===sLen)sLen=emLen-hLen-2;else if(sLen<-2)throw"invalid salt length";if(emLen<hLen+sLen+2)throw"data too long";var em=this.doPublic(biSig).toByteArray();for(i=0;i<em.length;i+=1)em[i]&=255;for(;em.length<emLen;)em.unshift(0);if(188!==em[emLen-1])throw"encoded message does not end in 0xbc";var maskedDB=(em=String.fromCharCode.apply(String,em)).substr(0,emLen-hLen-1),H=em.substr(maskedDB.length,hLen),mask=65280>>8*emLen-emBits&255;if(0!=(maskedDB.charCodeAt(0)&mask))throw"bits beyond keysize not zero";var dbMask=pss_mgf1_str(H,maskedDB.length,hashFunc),DB=[];for(i=0;i<maskedDB.length;i+=1)DB[i]=maskedDB.charCodeAt(i)^dbMask.charCodeAt(i);DB[0]&=~mask;var checkLen=emLen-hLen-sLen-2;for(i=0;i<checkLen;i+=1)if(0!==DB[i])throw"leftmost octets not zero";if(1!==DB[checkLen])throw"0x01 marker not found";return H===hextorstr(hashFunc(rstrtohex("\0\0\0\0\0\0\0\0"+mHash+String.fromCharCode.apply(String,DB.slice(-sLen)))))},RSAKey.SALT_LEN_HLEN=-1,RSAKey.SALT_LEN_MAX=-2,RSAKey.SALT_LEN_RECOVER=-2;var ASN1HEX=new function(){};ASN1HEX.getLblen=function(s,idx){if("8"!=s.substr(idx+2,1))return 1;var i=parseInt(s.substr(idx+3,1));return 0==i?-1:0<i&&i<10?i+1:-2},ASN1HEX.getL=function(s,idx){var len=ASN1HEX.getLblen(s,idx);return len<1?"":s.substr(idx+2,2*len)},ASN1HEX.getVblen=function(s,idx){var hLen;return""==(hLen=ASN1HEX.getL(s,idx))?-1:("8"===hLen.substr(0,1)?new BigInteger(hLen.substr(2),16):new BigInteger(hLen,16)).intValue()},ASN1HEX.getVidx=function(s,idx){var l_len=ASN1HEX.getLblen(s,idx);return l_len<0?l_len:idx+2*(l_len+1)},ASN1HEX.getV=function(s,idx){var idx1=ASN1HEX.getVidx(s,idx),blen=ASN1HEX.getVblen(s,idx);return s.substr(idx1,2*blen)},ASN1HEX.getTLV=function(s,idx){return s.substr(idx,2)+ASN1HEX.getL(s,idx)+ASN1HEX.getV(s,idx)},ASN1HEX.getNextSiblingIdx=function(s,idx){return ASN1HEX.getVidx(s,idx)+2*ASN1HEX.getVblen(s,idx)},ASN1HEX.getChildIdx=function(h,pos){var _ASN1HEX=ASN1HEX,a=new Array,p0=_ASN1HEX.getVidx(h,pos);"03"==h.substr(pos,2)?a.push(p0+2):a.push(p0);for(var blen=_ASN1HEX.getVblen(h,pos),p=p0,k=0;;){var pNext=_ASN1HEX.getNextSiblingIdx(h,p);if(null==pNext||2*blen<=pNext-p0)break;if(200<=k)break;a.push(pNext),p=pNext,k++}return a},ASN1HEX.getNthChildIdx=function(h,idx,nth){return ASN1HEX.getChildIdx(h,idx)[nth]},ASN1HEX.getIdxbyList=function(h,currentIndex,nthList,checkingTag){var firstNth,a,_ASN1HEX=ASN1HEX;if(0!=nthList.length)return firstNth=nthList.shift(),a=_ASN1HEX.getChildIdx(h,currentIndex),_ASN1HEX.getIdxbyList(h,a[firstNth],nthList,checkingTag);if(checkingTag!==undefined&&h.substr(currentIndex,2)!==checkingTag)throw"checking tag doesn't match: "+h.substr(currentIndex,2)+"!="+checkingTag;return currentIndex},ASN1HEX.getTLVbyList=function(h,currentIndex,nthList,checkingTag){var _ASN1HEX=ASN1HEX,idx=_ASN1HEX.getIdxbyList(h,currentIndex,nthList);if(idx===undefined)throw"can't find nthList object";if(checkingTag!==undefined&&h.substr(idx,2)!=checkingTag)throw"checking tag doesn't match: "+h.substr(idx,2)+"!="+checkingTag;return _ASN1HEX.getTLV(h,idx)},ASN1HEX.getVbyList=function(h,currentIndex,nthList,checkingTag,removeUnusedbits){var idx,v,_ASN1HEX=ASN1HEX;if((idx=_ASN1HEX.getIdxbyList(h,currentIndex,nthList,checkingTag))===undefined)throw"can't find nthList object";return v=_ASN1HEX.getV(h,idx),!0===removeUnusedbits&&(v=v.substr(2)),v},ASN1HEX.hextooidstr=function(hex){var zeroPadding=function(s,len){return s.length>=len?s:new Array(len-s.length+1).join("0")+s},a=[],hex0=hex.substr(0,2),i0=parseInt(hex0,16);a[0]=new String(Math.floor(i0/40)),a[1]=new String(i0%40);for(var hex1=hex.substr(2),b=[],i=0;i<hex1.length/2;i++)b.push(parseInt(hex1.substr(2*i,2),16));var c=[],cbin="";for(i=0;i<b.length;i++)128&b[i]?cbin+=zeroPadding((127&b[i]).toString(2),7):(cbin+=zeroPadding((127&b[i]).toString(2),7),c.push(new String(parseInt(cbin,2))),cbin="");var s=a.join(".");return 0<c.length&&(s=s+"."+c.join(".")),s},ASN1HEX.dump=function(hexOrObj,flags,idx,indent){var _ASN1HEX=ASN1HEX,_getV=_ASN1HEX.getV,_dump=_ASN1HEX.dump,_getChildIdx=_ASN1HEX.getChildIdx,hex=hexOrObj;hexOrObj instanceof KJUR.asn1.ASN1Object&&(hex=hexOrObj.getEncodedHex());var _skipLongHex=function(hex,limitNumOctet){return hex.length<=2*limitNumOctet?hex:hex.substr(0,limitNumOctet)+"..(total "+hex.length/2+"bytes).."+hex.substr(hex.length-limitNumOctet,limitNumOctet)};flags===undefined&&(flags={ommit_long_octet:32}),idx===undefined&&(idx=0),indent===undefined&&(indent="");var skipLongHex=flags.ommit_long_octet;if("01"==hex.substr(idx,2))return"00"==(v=_getV(hex,idx))?indent+"BOOLEAN FALSE\n":indent+"BOOLEAN TRUE\n";if("02"==hex.substr(idx,2))return indent+"INTEGER "+_skipLongHex(v=_getV(hex,idx),skipLongHex)+"\n";if("03"==hex.substr(idx,2))return indent+"BITSTRING "+_skipLongHex(v=_getV(hex,idx),skipLongHex)+"\n";if("04"==hex.substr(idx,2)){var v=_getV(hex,idx);if(_ASN1HEX.isASN1HEX(v)){var s=indent+"OCTETSTRING, encapsulates\n";return s+=_dump(v,flags,0,indent+"  ")}return indent+"OCTETSTRING "+_skipLongHex(v,skipLongHex)+"\n"}if("05"==hex.substr(idx,2))return indent+"NULL\n";if("06"==hex.substr(idx,2)){var hV=_getV(hex,idx),oidDot=KJUR.asn1.ASN1Util.oidHexToInt(hV),oidName=KJUR.asn1.x509.OID.oid2name(oidDot),oidSpc=oidDot.replace(/\./g," ");return""!=oidName?indent+"ObjectIdentifier "+oidName+" ("+oidSpc+")\n":indent+"ObjectIdentifier ("+oidSpc+")\n"}if("0c"==hex.substr(idx,2))return indent+"UTF8String '"+hextoutf8(_getV(hex,idx))+"'\n";if("13"==hex.substr(idx,2))return indent+"PrintableString '"+hextoutf8(_getV(hex,idx))+"'\n";if("14"==hex.substr(idx,2))return indent+"TeletexString '"+hextoutf8(_getV(hex,idx))+"'\n";if("16"==hex.substr(idx,2))return indent+"IA5String '"+hextoutf8(_getV(hex,idx))+"'\n";if("17"==hex.substr(idx,2))return indent+"UTCTime "+hextoutf8(_getV(hex,idx))+"\n";if("18"==hex.substr(idx,2))return indent+"GeneralizedTime "+hextoutf8(_getV(hex,idx))+"\n";if("30"==hex.substr(idx,2)){if("3000"==hex.substr(idx,4))return indent+"SEQUENCE {}\n";s=indent+"SEQUENCE\n";var flagsTemp=flags;if((2==(aIdx=_getChildIdx(hex,idx)).length||3==aIdx.length)&&"06"==hex.substr(aIdx[0],2)&&"04"==hex.substr(aIdx[aIdx.length-1],2)){oidName=_ASN1HEX.oidname(_getV(hex,aIdx[0]));var flagsClone=JSON.parse(JSON.stringify(flags));flagsClone.x509ExtName=oidName,flagsTemp=flagsClone}for(var i=0;i<aIdx.length;i++)s+=_dump(hex,flagsTemp,aIdx[i],indent+"  ");return s}if("31"==hex.substr(idx,2)){s=indent+"SET\n";var aIdx=_getChildIdx(hex,idx);for(i=0;i<aIdx.length;i++)s+=_dump(hex,flags,aIdx[i],indent+"  ");return s}var tag=parseInt(hex.substr(idx,2),16);if(0==(128&tag))return indent+"UNKNOWN("+hex.substr(idx,2)+") "+_getV(hex,idx)+"\n";var tagNumber=31&tag;if(0==(32&tag))return"68747470"==(v=_getV(hex,idx)).substr(0,8)&&(v=hextoutf8(v)),"subjectAltName"===flags.x509ExtName&&2==tagNumber&&(v=hextoutf8(v)),s=indent+"["+tagNumber+"] "+v+"\n";var s=indent+"["+tagNumber+"]\n";for(aIdx=_getChildIdx(hex,idx),i=0;i<aIdx.length;i++)s+=_dump(hex,flags,aIdx[i],indent+"  ");return s},ASN1HEX.isASN1HEX=function(hex){var _ASN1HEX=ASN1HEX;if(hex.length%2==1)return!1;var intL=_ASN1HEX.getVblen(hex,0),tV=hex.substr(0,2),lV=_ASN1HEX.getL(hex,0);return hex.length-tV.length-lV.length==2*intL},ASN1HEX.oidname=function(oidDotOrHex){var _KJUR_asn1=KJUR.asn1;KJUR.lang.String.isHex(oidDotOrHex)&&(oidDotOrHex=_KJUR_asn1.ASN1Util.oidHexToInt(oidDotOrHex));var name=_KJUR_asn1.x509.OID.oid2name(oidDotOrHex);return""===name&&(name=oidDotOrHex),name},void 0!==KJUR&&KJUR||(KJUR={}),"undefined"!=typeof KJUR.asn1&&KJUR.asn1||(KJUR.asn1={}),"undefined"!=typeof KJUR.asn1.x509&&KJUR.asn1.x509||(KJUR.asn1.x509={}),KJUR.asn1.x509.Certificate=function(params){KJUR.asn1.x509.Certificate.superclass.constructor.call(this);var _KJUR=KJUR,_KJUR_asn1=(_KJUR.crypto,_KJUR.asn1),_DERSequence=_KJUR_asn1.DERSequence,_DERBitString=_KJUR_asn1.DERBitString;this.sign=function(){this.asn1SignatureAlg=this.asn1TBSCert.asn1SignatureAlg;var sig=new KJUR.crypto.Signature({alg:this.asn1SignatureAlg.nameAlg});sig.init(this.prvKey),sig.updateHex(this.asn1TBSCert.getEncodedHex()),this.hexSig=sig.sign(),this.asn1Sig=new _DERBitString({hex:"00"+this.hexSig});var seq=new _DERSequence({array:[this.asn1TBSCert,this.asn1SignatureAlg,this.asn1Sig]});this.hTLV=seq.getEncodedHex(),this.isModified=!1},this.setSignatureHex=function(sigHex){this.asn1SignatureAlg=this.asn1TBSCert.asn1SignatureAlg,this.hexSig=sigHex,this.asn1Sig=new _DERBitString({hex:"00"+this.hexSig});var seq=new _DERSequence({array:[this.asn1TBSCert,this.asn1SignatureAlg,this.asn1Sig]});this.hTLV=seq.getEncodedHex(),this.isModified=!1},this.getEncodedHex=function(){if(0==this.isModified&&null!=this.hTLV)return this.hTLV;throw"not signed yet"},this.getPEMString=function(){return"-----BEGIN CERTIFICATE-----\r\n"+hextob64nl(this.getEncodedHex())+"\r\n-----END CERTIFICATE-----\r\n"},params!==undefined&&(params.tbscertobj!==undefined&&(this.asn1TBSCert=params.tbscertobj),params.prvkeyobj!==undefined&&(this.prvKey=params.prvkeyobj))},YAHOO.lang.extend(KJUR.asn1.x509.Certificate,KJUR.asn1.ASN1Object),KJUR.asn1.x509.TBSCertificate=function(params){KJUR.asn1.x509.TBSCertificate.superclass.constructor.call(this);var _KJUR_asn1=KJUR.asn1,_DERSequence=_KJUR_asn1.DERSequence,_DERInteger=_KJUR_asn1.DERInteger,_DERTaggedObject=_KJUR_asn1.DERTaggedObject,_KJUR_asn1_x509=_KJUR_asn1.x509,_Time=_KJUR_asn1_x509.Time,_X500Name=_KJUR_asn1_x509.X500Name,_SubjectPublicKeyInfo=_KJUR_asn1_x509.SubjectPublicKeyInfo;this._initialize=function(){this.asn1Array=new Array,this.asn1Version=new _DERTaggedObject({obj:new _DERInteger({"int":2})}),this.asn1SerialNumber=null,this.asn1SignatureAlg=null,this.asn1Issuer=null,this.asn1NotBefore=null,this.asn1NotAfter=null,this.asn1Subject=null,this.asn1SubjPKey=null,this.extensionsArray=new Array},this.setSerialNumberByParam=function(intParam){this.asn1SerialNumber=new _DERInteger(intParam)},this.setSignatureAlgByParam=function(algIdParam){this.asn1SignatureAlg=new _KJUR_asn1_x509.AlgorithmIdentifier(algIdParam)},this.setIssuerByParam=function(x500NameParam){this.asn1Issuer=new _X500Name(x500NameParam)},this.setNotBeforeByParam=function(timeParam){this.asn1NotBefore=new _Time(timeParam)},this.setNotAfterByParam=function(timeParam){this.asn1NotAfter=new _Time(timeParam)},this.setSubjectByParam=function(x500NameParam){this.asn1Subject=new _X500Name(x500NameParam)},this.setSubjectPublicKey=function(param){this.asn1SubjPKey=new _SubjectPublicKeyInfo(param)},this.setSubjectPublicKeyByGetKey=function(keyParam){var keyObj=KEYUTIL.getKey(keyParam);this.asn1SubjPKey=new _SubjectPublicKeyInfo(keyObj)},this.appendExtension=function(extObj){this.extensionsArray.push(extObj)},this.appendExtensionByName=function(name,extParams){KJUR.asn1.x509.Extension.appendByNameToArray(name,extParams,this.extensionsArray)},this.getEncodedHex=function(){if(null==this.asn1NotBefore||null==this.asn1NotAfter)throw"notBefore and/or notAfter not set";var asn1Validity=new _DERSequence({array:[this.asn1NotBefore,this.asn1NotAfter]});if(this.asn1Array=new Array,this.asn1Array.push(this.asn1Version),this.asn1Array.push(this.asn1SerialNumber),this.asn1Array.push(this.asn1SignatureAlg),this.asn1Array.push(this.asn1Issuer),this.asn1Array.push(asn1Validity),this.asn1Array.push(this.asn1Subject),this.asn1Array.push(this.asn1SubjPKey),0<this.extensionsArray.length){var extSeq=new _DERSequence({array:this.extensionsArray}),extTagObj=new _DERTaggedObject({explicit:!0,tag:"a3",obj:extSeq});this.asn1Array.push(extTagObj)}var o=new _DERSequence({array:this.asn1Array});return this.hTLV=o.getEncodedHex(),this.isModified=!1,this.hTLV},this._initialize()},YAHOO.lang.extend(KJUR.asn1.x509.TBSCertificate,KJUR.asn1.ASN1Object),KJUR.asn1.x509.Extension=function(params){KJUR.asn1.x509.Extension.superclass.constructor.call(this);var _KJUR_asn1=KJUR.asn1,_DERObjectIdentifier=_KJUR_asn1.DERObjectIdentifier,_DEROctetString=_KJUR_asn1.DEROctetString,_DERBoolean=(_KJUR_asn1.DERBitString,_KJUR_asn1.DERBoolean),_DERSequence=_KJUR_asn1.DERSequence;this.getEncodedHex=function(){var asn1Oid=new _DERObjectIdentifier({oid:this.oid}),asn1EncapExtnValue=new _DEROctetString({hex:this.getExtnValueHex()}),asn1Array=new Array;return asn1Array.push(asn1Oid),this.critical&&asn1Array.push(new _DERBoolean),asn1Array.push(asn1EncapExtnValue),new _DERSequence({array:asn1Array}).getEncodedHex()},this.critical=!1,void 0!==params&&"undefined"!=typeof params.critical&&(this.critical=params.critical)},YAHOO.lang.extend(KJUR.asn1.x509.Extension,KJUR.asn1.ASN1Object),KJUR.asn1.x509.Extension.appendByNameToArray=function(name,extParams,a){var _lowname=name.toLowerCase(),_KJUR_asn1_x509=KJUR.asn1.x509;if("basicconstraints"==_lowname){var extObj=new _KJUR_asn1_x509.BasicConstraints(extParams);a.push(extObj)}else if("keyusage"==_lowname){extObj=new _KJUR_asn1_x509.KeyUsage(extParams);a.push(extObj)}else if("crldistributionpoints"==_lowname){extObj=new _KJUR_asn1_x509.CRLDistributionPoints(extParams);a.push(extObj)}else if("extkeyusage"==_lowname){extObj=new _KJUR_asn1_x509.ExtKeyUsage(extParams);a.push(extObj)}else if("authoritykeyidentifier"==_lowname){extObj=new _KJUR_asn1_x509.AuthorityKeyIdentifier(extParams);a.push(extObj)}else if("authorityinfoaccess"==_lowname){extObj=new _KJUR_asn1_x509.AuthorityInfoAccess(extParams);a.push(extObj)}else if("subjectaltname"==_lowname){extObj=new _KJUR_asn1_x509.SubjectAltName(extParams);a.push(extObj)}else{if("issueraltname"!=_lowname)throw"unsupported extension name: "+name;extObj=new _KJUR_asn1_x509.IssuerAltName(extParams);a.push(extObj)}},KJUR.asn1.x509.KeyUsage=function(params){KJUR.asn1.x509.KeyUsage.superclass.constructor.call(this,params),this.getExtnValueHex=function(){return this.asn1ExtnValue.getEncodedHex()},this.oid="2.5.29.15",void 0!==params&&"undefined"!=typeof params.bin&&(this.asn1ExtnValue=new KJUR.asn1.DERBitString(params))},YAHOO.lang.extend(KJUR.asn1.x509.KeyUsage,KJUR.asn1.x509.Extension),KJUR.asn1.x509.BasicConstraints=function(params){KJUR.asn1.x509.BasicConstraints.superclass.constructor.call(this,params);this.getExtnValueHex=function(){var asn1Array=new Array;this.cA&&asn1Array.push(new KJUR.asn1.DERBoolean),-1<this.pathLen&&asn1Array.push(new KJUR.asn1.DERInteger({"int":this.pathLen}));var asn1Seq=new KJUR.asn1.DERSequence({array:asn1Array});return this.asn1ExtnValue=asn1Seq,this.asn1ExtnValue.getEncodedHex()},this.oid="2.5.29.19",this.cA=!1,this.pathLen=-1,void 0!==params&&("undefined"!=typeof params.cA&&(this.cA=params.cA),"undefined"!=typeof params.pathLen&&(this.pathLen=params.pathLen))},YAHOO.lang.extend(KJUR.asn1.x509.BasicConstraints,KJUR.asn1.x509.Extension),KJUR.asn1.x509.CRLDistributionPoints=function(params){KJUR.asn1.x509.CRLDistributionPoints.superclass.constructor.call(this,params);var _KJUR_asn1=KJUR.asn1,_KJUR_asn1_x509=_KJUR_asn1.x509;this.getExtnValueHex=function(){return this.asn1ExtnValue.getEncodedHex()},this.setByDPArray=function(dpArray){this.asn1ExtnValue=new _KJUR_asn1.DERSequence({array:dpArray})},this.setByOneURI=function(uri){var gn1=new _KJUR_asn1_x509.GeneralNames([{uri:uri}]),dpn1=new _KJUR_asn1_x509.DistributionPointName(gn1),dp1=new _KJUR_asn1_x509.DistributionPoint({dpobj:dpn1});this.setByDPArray([dp1])},this.oid="2.5.29.31",void 0!==params&&("undefined"!=typeof params.array?this.setByDPArray(params.array):"undefined"!=typeof params.uri&&this.setByOneURI(params.uri))},YAHOO.lang.extend(KJUR.asn1.x509.CRLDistributionPoints,KJUR.asn1.x509.Extension),KJUR.asn1.x509.ExtKeyUsage=function(params){KJUR.asn1.x509.ExtKeyUsage.superclass.constructor.call(this,params);var _KJUR_asn1=KJUR.asn1;this.setPurposeArray=function(purposeArray){this.asn1ExtnValue=new _KJUR_asn1.DERSequence;for(var i=0;i<purposeArray.length;i++){var o=new _KJUR_asn1.DERObjectIdentifier(purposeArray[i]);this.asn1ExtnValue.appendASN1Object(o)}},this.getExtnValueHex=function(){return this.asn1ExtnValue.getEncodedHex()},this.oid="2.5.29.37",void 0!==params&&"undefined"!=typeof params.array&&this.setPurposeArray(params.array)},YAHOO.lang.extend(KJUR.asn1.x509.ExtKeyUsage,KJUR.asn1.x509.Extension),KJUR.asn1.x509.AuthorityKeyIdentifier=function(params){KJUR.asn1.x509.AuthorityKeyIdentifier.superclass.constructor.call(this,params);var _KJUR_asn1=KJUR.asn1,_DERTaggedObject=_KJUR_asn1.DERTaggedObject;this.asn1KID=null,this.asn1CertIssuer=null,this.asn1CertSN=null,this.getExtnValueHex=function(){var a=new Array;this.asn1KID&&a.push(new _DERTaggedObject({explicit:!1,tag:"80",obj:this.asn1KID})),this.asn1CertIssuer&&a.push(new _DERTaggedObject({explicit:!1,tag:"a1",obj:this.asn1CertIssuer})),this.asn1CertSN&&a.push(new _DERTaggedObject({explicit:!1,tag:"82",obj:this.asn1CertSN}));var asn1Seq=new _KJUR_asn1.DERSequence({array:a});return this.asn1ExtnValue=asn1Seq,this.asn1ExtnValue.getEncodedHex()},this.setKIDByParam=function(param){this.asn1KID=new KJUR.asn1.DEROctetString(param)},this.setCertIssuerByParam=function(param){this.asn1CertIssuer=new KJUR.asn1.x509.X500Name(param)},this.setCertSNByParam=function(param){this.asn1CertSN=new KJUR.asn1.DERInteger(param)},this.oid="2.5.29.35",void 0!==params&&("undefined"!=typeof params.kid&&this.setKIDByParam(params.kid),"undefined"!=typeof params.issuer&&this.setCertIssuerByParam(params.issuer),"undefined"!=typeof params.sn&&this.setCertSNByParam(params.sn))},YAHOO.lang.extend(KJUR.asn1.x509.AuthorityKeyIdentifier,KJUR.asn1.x509.Extension),KJUR.asn1.x509.AuthorityInfoAccess=function(params){KJUR.asn1.x509.AuthorityInfoAccess.superclass.constructor.call(this,params),this.setAccessDescriptionArray=function(accessDescriptionArray){for(var array=new Array,_KJUR_asn1=KJUR.asn1,_DERSequence=_KJUR_asn1.DERSequence,i=0;i<accessDescriptionArray.length;i++){var accessDescription=new _DERSequence({array:[new _KJUR_asn1.DERObjectIdentifier(accessDescriptionArray[i].accessMethod),new _KJUR_asn1.x509.GeneralName(accessDescriptionArray[i].accessLocation)]});array.push(accessDescription)}this.asn1ExtnValue=new _DERSequence({array:array})},this.getExtnValueHex=function(){return this.asn1ExtnValue.getEncodedHex()},this.oid="1.3.6.1.5.5.7.1.1",void 0!==params&&"undefined"!=typeof params.array&&this.setAccessDescriptionArray(params.array)},YAHOO.lang.extend(KJUR.asn1.x509.AuthorityInfoAccess,KJUR.asn1.x509.Extension),KJUR.asn1.x509.SubjectAltName=function(params){KJUR.asn1.x509.SubjectAltName.superclass.constructor.call(this,params),this.setNameArray=function(paramsArray){this.asn1ExtnValue=new KJUR.asn1.x509.GeneralNames(paramsArray)},this.getExtnValueHex=function(){return this.asn1ExtnValue.getEncodedHex()},this.oid="2.5.29.17",params!==undefined&&params.array!==undefined&&this.setNameArray(params.array)},YAHOO.lang.extend(KJUR.asn1.x509.SubjectAltName,KJUR.asn1.x509.Extension),KJUR.asn1.x509.IssuerAltName=function(params){KJUR.asn1.x509.IssuerAltName.superclass.constructor.call(this,params),this.setNameArray=function(paramsArray){this.asn1ExtnValue=new KJUR.asn1.x509.GeneralNames(paramsArray)},this.getExtnValueHex=function(){return this.asn1ExtnValue.getEncodedHex()},this.oid="2.5.29.18",params!==undefined&&params.array!==undefined&&this.setNameArray(params.array)},YAHOO.lang.extend(KJUR.asn1.x509.IssuerAltName,KJUR.asn1.x509.Extension),KJUR.asn1.x509.CRL=function(params){KJUR.asn1.x509.CRL.superclass.constructor.call(this);this.sign=function(){this.asn1SignatureAlg=this.asn1TBSCertList.asn1SignatureAlg,sig=new KJUR.crypto.Signature({alg:"SHA1withRSA",prov:"cryptojs/jsrsa"}),sig.initSign(this.prvKey),sig.updateHex(this.asn1TBSCertList.getEncodedHex()),this.hexSig=sig.sign(),this.asn1Sig=new KJUR.asn1.DERBitString({hex:"00"+this.hexSig});var seq=new KJUR.asn1.DERSequence({array:[this.asn1TBSCertList,this.asn1SignatureAlg,this.asn1Sig]});this.hTLV=seq.getEncodedHex(),this.isModified=!1},this.getEncodedHex=function(){if(0==this.isModified&&null!=this.hTLV)return this.hTLV;throw"not signed yet"},this.getPEMString=function(){return"-----BEGIN X509 CRL-----\r\n"+hextob64nl(this.getEncodedHex())+"\r\n-----END X509 CRL-----\r\n"},params!==undefined&&(params.tbsobj!==undefined&&(this.asn1TBSCertList=params.tbsobj),params.prvkeyobj!==undefined&&(this.prvKey=params.prvkeyobj))},YAHOO.lang.extend(KJUR.asn1.x509.CRL,KJUR.asn1.ASN1Object),KJUR.asn1.x509.TBSCertList=function(params){KJUR.asn1.x509.TBSCertList.superclass.constructor.call(this);var _KJUR_asn1=KJUR.asn1,_DERSequence=_KJUR_asn1.DERSequence,_KJUR_asn1_x509=_KJUR_asn1.x509,_Time=_KJUR_asn1_x509.Time;this.setSignatureAlgByParam=function(algIdParam){this.asn1SignatureAlg=new _KJUR_asn1_x509.AlgorithmIdentifier(algIdParam)},this.setIssuerByParam=function(x500NameParam){this.asn1Issuer=new _KJUR_asn1_x509.X500Name(x500NameParam)},this.setThisUpdateByParam=function(timeParam){this.asn1ThisUpdate=new _Time(timeParam)},this.setNextUpdateByParam=function(timeParam){this.asn1NextUpdate=new _Time(timeParam)},this.addRevokedCert=function(snParam,timeParam){var param={};snParam!=undefined&&null!=snParam&&(param.sn=snParam),timeParam!=undefined&&null!=timeParam&&(param.time=timeParam);var o=new _KJUR_asn1_x509.CRLEntry(param);this.aRevokedCert.push(o)},this.getEncodedHex=function(){if(this.asn1Array=new Array,null!=this.asn1Version&&this.asn1Array.push(this.asn1Version),this.asn1Array.push(this.asn1SignatureAlg),this.asn1Array.push(this.asn1Issuer),this.asn1Array.push(this.asn1ThisUpdate),null!=this.asn1NextUpdate&&this.asn1Array.push(this.asn1NextUpdate),0<this.aRevokedCert.length){var seq=new _DERSequence({array:this.aRevokedCert});this.asn1Array.push(seq)}var o=new _DERSequence({array:this.asn1Array});return this.hTLV=o.getEncodedHex(),this.isModified=!1,this.hTLV},this._initialize=function(){this.asn1Version=null,this.asn1SignatureAlg=null,this.asn1Issuer=null,this.asn1ThisUpdate=null,this.asn1NextUpdate=null,this.aRevokedCert=new Array},this._initialize()},YAHOO.lang.extend(KJUR.asn1.x509.TBSCertList,KJUR.asn1.ASN1Object),KJUR.asn1.x509.CRLEntry=function(params){KJUR.asn1.x509.CRLEntry.superclass.constructor.call(this);var _KJUR_asn1=KJUR.asn1;this.setCertSerial=function(intParam){this.sn=new _KJUR_asn1.DERInteger(intParam)},this.setRevocationDate=function(timeParam){this.time=new _KJUR_asn1.x509.Time(timeParam)},this.getEncodedHex=function(){var o=new _KJUR_asn1.DERSequence({array:[this.sn,this.time]});return this.TLV=o.getEncodedHex(),this.TLV},params!==undefined&&(params.time!==undefined&&this.setRevocationDate(params.time),params.sn!==undefined&&this.setCertSerial(params.sn))},YAHOO.lang.extend(KJUR.asn1.x509.CRLEntry,KJUR.asn1.ASN1Object),KJUR.asn1.x509.X500Name=function(params){KJUR.asn1.x509.X500Name.superclass.constructor.call(this),this.asn1Array=new Array;var _KJUR_asn1=KJUR.asn1,_KJUR_asn1_x509=_KJUR_asn1.x509,_pemtohex=pemtohex;if(this.setByString=function(dnStr){var a=dnStr.split("/");a.shift();for(var i=0;i<a.length;i++)this.asn1Array.push(new _KJUR_asn1_x509.RDN({str:a[i]}))},this.setByLdapString=function(dnStr){var oneline=_KJUR_asn1_x509.X500Name.ldapToOneline(dnStr);this.setByString(oneline)},this.setByObject=function(dnObj){for(var x in dnObj)if(dnObj.hasOwnProperty(x)){var newRDN=new KJUR.asn1.x509.RDN({str:x+"="+dnObj[x]});this.asn1Array?this.asn1Array.push(newRDN):this.asn1Array=[newRDN]}},this.getEncodedHex=function(){if("string"==typeof this.hTLV)return this.hTLV;var o=new _KJUR_asn1.DERSequence({array:this.asn1Array});return this.hTLV=o.getEncodedHex(),this.hTLV},params!==undefined){var x;if(params.str!==undefined?this.setByString(params.str):params.ldapstr!==undefined?this.setByLdapString(params.ldapstr):"object"==typeof params&&this.setByObject(params),params.certissuer!==undefined)(x=new X509).hex=_pemtohex(params.certissuer),this.hTLV=x.getIssuerHex();if(params.certsubject!==undefined)(x=new X509).hex=_pemtohex(params.certsubject),this.hTLV=x.getSubjectHex()}},YAHOO.lang.extend(KJUR.asn1.x509.X500Name,KJUR.asn1.ASN1Object),KJUR.asn1.x509.X500Name.onelineToLDAP=function(s){if("/"!==s.substr(0,1))throw"malformed input";var a=(s=s.substr(1)).split("/");return a.reverse(),(a=a.map(function(s){return s.replace(/,/,"\\,")})).join(",")},KJUR.asn1.x509.X500Name.ldapToOneline=function(s){for(var a=s.split(","),isBSbefore=!1,a2=[],i=0;0<a.length;i++){var item=a.shift();if(!0===isBSbefore){var newitem=(a2.pop()+","+item).replace(/\\,/g,",");a2.push(newitem),isBSbefore=!1}else a2.push(item);"\\"===item.substr(-1,1)&&(isBSbefore=!0)}return(a2=a2.map(function(s){return s.replace("/","\\/")})).reverse(),"/"+a2.join("/")},KJUR.asn1.x509.RDN=function(params){KJUR.asn1.x509.RDN.superclass.constructor.call(this),this.asn1Array=new Array,this.addByString=function(s){this.asn1Array.push(new KJUR.asn1.x509.AttributeTypeAndValue({str:s}))},this.addByMultiValuedString=function(s){for(var a=KJUR.asn1.x509.RDN.parseString(s),i=0;i<a.length;i++)this.addByString(a[i])},this.getEncodedHex=function(){var o=new KJUR.asn1.DERSet({array:this.asn1Array});return this.TLV=o.getEncodedHex(),this.TLV},void 0!==params&&"undefined"!=typeof params.str&&this.addByMultiValuedString(params.str)},YAHOO.lang.extend(KJUR.asn1.x509.RDN,KJUR.asn1.ASN1Object),KJUR.asn1.x509.RDN.parseString=function(s){for(var a=s.split(/\+/),isBSbefore=!1,a2=[],i=0;0<a.length;i++){var item=a.shift();if(!0===isBSbefore){var newitem=(a2.pop()+"+"+item).replace(/\\\+/g,"+");a2.push(newitem),isBSbefore=!1}else a2.push(item);"\\"===item.substr(-1,1)&&(isBSbefore=!0)}var beginQuote=!1,a3=[];for(i=0;0<a2.length;i++){item=a2.shift();if(!0===beginQuote){var a3last=a3.pop();if(item.match(/"$/)){newitem=(a3last+"+"+item).replace(/^([^=]+)="(.*)"$/,"$1=$2");a3.push(newitem),beginQuote=!1}else a3.push(a3last+"+"+item)}else a3.push(item);item.match(/^[^=]+="/)&&(beginQuote=!0)}return a3},KJUR.asn1.x509.AttributeTypeAndValue=function(params){KJUR.asn1.x509.AttributeTypeAndValue.superclass.constructor.call(this);var _KJUR_asn1=KJUR.asn1;this.setByString=function(attrTypeAndValueStr){var matchResult=attrTypeAndValueStr.match(/^([^=]+)=(.+)$/);if(!matchResult)throw"malformed attrTypeAndValueStr: "+attrTypeAndValueStr;this.setByAttrTypeAndValueStr(matchResult[1],matchResult[2])},this.setByAttrTypeAndValueStr=function(shortAttrType,valueStr){this.typeObj=KJUR.asn1.x509.OID.atype2obj(shortAttrType);var dsType="utf8";"C"==shortAttrType&&(dsType="prn"),this.valueObj=this.getValueObj(dsType,valueStr)},this.getValueObj=function(dsType,valueStr){if("utf8"==dsType)return new _KJUR_asn1.DERUTF8String({str:valueStr});if("prn"==dsType)return new _KJUR_asn1.DERPrintableString({str:valueStr});if("tel"==dsType)return new _KJUR_asn1.DERTeletexString({str:valueStr});if("ia5"==dsType)return new _KJUR_asn1.DERIA5String({str:valueStr});throw"unsupported directory string type: type="+dsType+" value="+valueStr},this.getEncodedHex=function(){var o=new _KJUR_asn1.DERSequence({array:[this.typeObj,this.valueObj]});return this.TLV=o.getEncodedHex(),this.TLV},void 0!==params&&"undefined"!=typeof params.str&&this.setByString(params.str)},YAHOO.lang.extend(KJUR.asn1.x509.AttributeTypeAndValue,KJUR.asn1.ASN1Object),KJUR.asn1.x509.SubjectPublicKeyInfo=function(params){KJUR.asn1.x509.SubjectPublicKeyInfo.superclass.constructor.call(this);var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DERInteger=_KJUR_asn1.DERInteger,_DERBitString=_KJUR_asn1.DERBitString,_DERObjectIdentifier=_KJUR_asn1.DERObjectIdentifier,_DERSequence=_KJUR_asn1.DERSequence,_newObject=_KJUR_asn1.ASN1Util.newObject,_AlgorithmIdentifier=_KJUR_asn1.x509.AlgorithmIdentifier,_KJUR_crypto=_KJUR.crypto;_KJUR_crypto.ECDSA,_KJUR_crypto.DSA;this.getASN1Object=function(){if(null==this.asn1AlgId||null==this.asn1SubjPKey)throw"algId and/or subjPubKey not set";return new _DERSequence({array:[this.asn1AlgId,this.asn1SubjPKey]})},this.getEncodedHex=function(){var o=this.getASN1Object();return this.hTLV=o.getEncodedHex(),this.hTLV},this.setPubKey=function(key){try{if(key instanceof RSAKey){var rsaKeyHex=_newObject({seq:[{"int":{bigint:key.n}},{"int":{"int":key.e}}]}).getEncodedHex();this.asn1AlgId=new _AlgorithmIdentifier({name:"rsaEncryption"}),this.asn1SubjPKey=new _DERBitString({hex:"00"+rsaKeyHex})}}catch(ex){}try{if(key instanceof KJUR.crypto.ECDSA){var asn1Params=new _DERObjectIdentifier({name:key.curveName});this.asn1AlgId=new _AlgorithmIdentifier({name:"ecPublicKey",asn1params:asn1Params}),this.asn1SubjPKey=new _DERBitString({hex:"00"+key.pubKeyHex})}}catch(ex){}try{if(key instanceof KJUR.crypto.DSA){asn1Params=new _newObject({seq:[{"int":{bigint:key.p}},{"int":{bigint:key.q}},{"int":{bigint:key.g}}]});this.asn1AlgId=new _AlgorithmIdentifier({name:"dsa",asn1params:asn1Params});var pubInt=new _DERInteger({bigint:key.y});this.asn1SubjPKey=new _DERBitString({hex:"00"+pubInt.getEncodedHex()})}}catch(ex){}},params!==undefined&&this.setPubKey(params)},YAHOO.lang.extend(KJUR.asn1.x509.SubjectPublicKeyInfo,KJUR.asn1.ASN1Object),KJUR.asn1.x509.Time=function(params){KJUR.asn1.x509.Time.superclass.constructor.call(this);var _KJUR_asn1=KJUR.asn1,_DERUTCTime=_KJUR_asn1.DERUTCTime,_DERGeneralizedTime=_KJUR_asn1.DERGeneralizedTime;this.setTimeParams=function(timeParams){this.timeParams=timeParams},this.getEncodedHex=function(){var o=null;return o=null!=this.timeParams?"utc"==this.type?new _DERUTCTime(this.timeParams):new _DERGeneralizedTime(this.timeParams):"utc"==this.type?new _DERUTCTime:new _DERGeneralizedTime,this.TLV=o.getEncodedHex(),this.TLV},this.type="utc",params!==undefined&&(params.type!==undefined?this.type=params.type:params.str!==undefined&&(params.str.match(/^[0-9]{12}Z$/)&&(this.type="utc"),params.str.match(/^[0-9]{14}Z$/)&&(this.type="gen")),this.timeParams=params)},YAHOO.lang.extend(KJUR.asn1.x509.Time,KJUR.asn1.ASN1Object),KJUR.asn1.x509.AlgorithmIdentifier=function(params){KJUR.asn1.x509.AlgorithmIdentifier.superclass.constructor.call(this),this.nameAlg=null,this.asn1Alg=null,this.asn1Params=null,this.paramEmpty=!1;var _KJUR_asn1=KJUR.asn1;if(this.getEncodedHex=function(){if(null===this.nameAlg&&null===this.asn1Alg)throw"algorithm not specified";null!==this.nameAlg&&null===this.asn1Alg&&(this.asn1Alg=_KJUR_asn1.x509.OID.name2obj(this.nameAlg));var a=[this.asn1Alg];null!==this.asn1Params&&a.push(this.asn1Params);var o=new _KJUR_asn1.DERSequence({array:a});return this.hTLV=o.getEncodedHex(),this.hTLV},params!==undefined&&(params.name!==undefined&&(this.nameAlg=params.name),params.asn1params!==undefined&&(this.asn1Params=params.asn1params),params.paramempty!==undefined&&(this.paramEmpty=params.paramempty)),null===this.asn1Params&&!1===this.paramEmpty&&null!==this.nameAlg){var lcNameAlg=this.nameAlg.toLowerCase();"withdsa"!==lcNameAlg.substr(-7,7)&&"withecdsa"!==lcNameAlg.substr(-9,9)&&(this.asn1Params=new _KJUR_asn1.DERNull)}},YAHOO.lang.extend(KJUR.asn1.x509.AlgorithmIdentifier,KJUR.asn1.ASN1Object),KJUR.asn1.x509.GeneralName=function(params){KJUR.asn1.x509.GeneralName.superclass.constructor.call(this);var pTag={rfc822:"81",dns:"82",dn:"a4",uri:"86"},_KJUR_asn1=KJUR.asn1,_DERIA5String=_KJUR_asn1.DERIA5String,_DERTaggedObject=_KJUR_asn1.DERTaggedObject,_ASN1Object=_KJUR_asn1.ASN1Object,_X500Name=_KJUR_asn1.x509.X500Name,_pemtohex=pemtohex;this.explicit=!1,this.setByParam=function(params){var v=null;if(params!==undefined){if(params.rfc822!==undefined&&(this.type="rfc822",v=new _DERIA5String({str:params[this.type]})),params.dns!==undefined&&(this.type="dns",v=new _DERIA5String({str:params[this.type]})),params.uri!==undefined&&(this.type="uri",v=new _DERIA5String({str:params[this.type]})),params.dn!==undefined&&(this.type="dn",v=new _X500Name({str:params.dn})),params.ldapdn!==undefined&&(this.type="dn",v=new _X500Name({ldapstr:params.ldapdn})),params.certissuer!==undefined){this.type="dn",this.explicit=!0;var certHex=null;if((certStr=params.certissuer).match(/^[0-9A-Fa-f]+$/),-1!=certStr.indexOf("-----BEGIN ")&&(certHex=_pemtohex(certStr)),null==certHex)throw"certissuer param not cert";(x=new X509).hex=certHex;var dnHex=x.getIssuerHex();(v=new _ASN1Object).hTLV=dnHex}if(params.certsubj!==undefined){this.type="dn",this.explicit=!0;var certStr,x;certHex=null;if((certStr=params.certsubj).match(/^[0-9A-Fa-f]+$/),-1!=certStr.indexOf("-----BEGIN ")&&(certHex=_pemtohex(certStr)),null==certHex)throw"certsubj param not cert";(x=new X509).hex=certHex;dnHex=x.getSubjectHex();(v=new _ASN1Object).hTLV=dnHex}if(null==this.type)throw"unsupported type in params="+params;this.asn1Obj=new _DERTaggedObject({explicit:this.explicit,tag:pTag[this.type],obj:v})}},this.getEncodedHex=function(){return this.asn1Obj.getEncodedHex()},params!==undefined&&this.setByParam(params)},YAHOO.lang.extend(KJUR.asn1.x509.GeneralName,KJUR.asn1.ASN1Object),KJUR.asn1.x509.GeneralNames=function(paramsArray){KJUR.asn1.x509.GeneralNames.superclass.constructor.call(this);var _KJUR_asn1=KJUR.asn1;this.setByParamArray=function(paramsArray){for(var i=0;i<paramsArray.length;i++){var o=new _KJUR_asn1.x509.GeneralName(paramsArray[i]);this.asn1Array.push(o)}},this.getEncodedHex=function(){return new _KJUR_asn1.DERSequence({array:this.asn1Array}).getEncodedHex()},this.asn1Array=new Array,void 0!==paramsArray&&this.setByParamArray(paramsArray)},YAHOO.lang.extend(KJUR.asn1.x509.GeneralNames,KJUR.asn1.ASN1Object),KJUR.asn1.x509.DistributionPointName=function(gnOrRdn){KJUR.asn1.x509.DistributionPointName.superclass.constructor.call(this);var _KJUR_asn1=KJUR.asn1,_DERTaggedObject=_KJUR_asn1.DERTaggedObject;if(this.getEncodedHex=function(){if("full"!=this.type)throw"currently type shall be 'full': "+this.type;return this.asn1Obj=new _DERTaggedObject({explicit:!1,tag:this.tag,obj:this.asn1V}),this.hTLV=this.asn1Obj.getEncodedHex(),this.hTLV},gnOrRdn!==undefined){if(!_KJUR_asn1.x509.GeneralNames.prototype.isPrototypeOf(gnOrRdn))throw"This class supports GeneralNames only as argument";this.type="full",this.tag="a0",this.asn1V=gnOrRdn}},YAHOO.lang.extend(KJUR.asn1.x509.DistributionPointName,KJUR.asn1.ASN1Object),KJUR.asn1.x509.DistributionPoint=function(params){KJUR.asn1.x509.DistributionPoint.superclass.constructor.call(this);var _KJUR_asn1=KJUR.asn1;this.getEncodedHex=function(){var seq=new _KJUR_asn1.DERSequence;if(null!=this.asn1DP){var o1=new _KJUR_asn1.DERTaggedObject({explicit:!0,tag:"a0",obj:this.asn1DP});seq.appendASN1Object(o1)}return this.hTLV=seq.getEncodedHex(),this.hTLV},params!==undefined&&params.dpobj!==undefined&&(this.asn1DP=params.dpobj)},YAHOO.lang.extend(KJUR.asn1.x509.DistributionPoint,KJUR.asn1.ASN1Object),KJUR.asn1.x509.OID=new function(params){this.atype2oidList={CN:"2.5.4.3",L:"2.5.4.7",ST:"2.5.4.8",O:"2.5.4.10",OU:"2.5.4.11",C:"2.5.4.6",STREET:"2.5.4.9",DC:"0.9.2342.19200300.100.1.25",UID:"0.9.2342.19200300.100.1.1",SN:"2.5.4.4",DN:"2.5.4.49",E:"1.2.840.113549.1.9.1",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",serialNumber:"2.5.4.5",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3"},this.name2oidList={sha1:"1.3.14.3.2.26",sha256:"2.16.840.1.101.3.4.2.1",sha384:"2.16.840.1.101.3.4.2.2",sha512:"2.16.840.1.101.3.4.2.3",sha224:"2.16.840.1.101.3.4.2.4",md5:"1.2.840.113549.2.5",md2:"1.3.14.7.2.2.1",ripemd160:"1.3.36.3.2.1",MD2withRSA:"1.2.840.113549.1.1.2",MD4withRSA:"1.2.840.113549.1.1.3",MD5withRSA:"1.2.840.113549.1.1.4",SHA1withRSA:"1.2.840.113549.1.1.5",SHA224withRSA:"1.2.840.113549.1.1.14",SHA256withRSA:"1.2.840.113549.1.1.11",SHA384withRSA:"1.2.840.113549.1.1.12",SHA512withRSA:"1.2.840.113549.1.1.13",SHA1withECDSA:"1.2.840.10045.4.1",SHA224withECDSA:"1.2.840.10045.4.3.1",SHA256withECDSA:"1.2.840.10045.4.3.2",SHA384withECDSA:"1.2.840.10045.4.3.3",SHA512withECDSA:"1.2.840.10045.4.3.4",dsa:"1.2.840.10040.4.1",SHA1withDSA:"1.2.840.10040.4.3",SHA224withDSA:"2.16.840.1.101.3.4.3.1",SHA256withDSA:"2.16.840.1.101.3.4.3.2",rsaEncryption:"1.2.840.113549.1.1.1",commonName:"2.5.4.3",localityName:"2.5.4.7",stateOrProvinceName:"2.5.4.8",organizationName:"2.5.4.10",organizationalUnitName:"2.5.4.11",countryName:"2.5.4.6",streetAddress:"2.5.4.9",domainComponent:"0.9.2342.19200300.100.1.25",userId:"0.9.2342.19200300.100.1.1",surname:"2.5.4.4",distinguishedName:"2.5.4.49",emailAddress:"1.2.840.113549.1.9.1",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3",subjectKeyIdentifier:"2.5.29.14",keyUsage:"2.5.29.15",subjectAltName:"2.5.29.17",issuerAltName:"2.5.29.18",basicConstraints:"2.5.29.19",nameConstraints:"2.5.29.30",cRLDistributionPoints:"2.5.29.31",certificatePolicies:"2.5.29.32",authorityKeyIdentifier:"2.5.29.35",policyConstraints:"2.5.29.36",extKeyUsage:"2.5.29.37",authorityInfoAccess:"1.3.6.1.5.5.7.1.1",ocsp:"1.3.6.1.5.5.7.48.1",caIssuers:"1.3.6.1.5.5.7.48.2",anyExtendedKeyUsage:"2.5.29.37.0",serverAuth:"1.3.6.1.5.5.7.3.1",clientAuth:"1.3.6.1.5.5.7.3.2",codeSigning:"1.3.6.1.5.5.7.3.3",emailProtection:"1.3.6.1.5.5.7.3.4",timeStamping:"1.3.6.1.5.5.7.3.8",ocspSigning:"1.3.6.1.5.5.7.3.9",ecPublicKey:"1.2.840.10045.2.1",secp256r1:"1.2.840.10045.3.1.7",secp256k1:"1.3.132.0.10",secp384r1:"1.3.132.0.34",pkcs5PBES2:"1.2.840.113549.1.5.13",pkcs5PBKDF2:"1.2.840.113549.1.5.12","des-EDE3-CBC":"1.2.840.113549.3.7",data:"1.2.840.113549.1.7.1","signed-data":"1.2.840.113549.1.7.2","enveloped-data":"1.2.840.113549.1.7.3","digested-data":"1.2.840.113549.1.7.5","encrypted-data":"1.2.840.113549.1.7.6","authenticated-data":"1.2.840.113549.1.9.16.1.2",tstinfo:"1.2.840.113549.1.9.16.1.4",extensionRequest:"1.2.840.113549.1.9.14"},this.objCache={},this.name2obj=function(name){if("undefined"!=typeof this.objCache[name])return this.objCache[name];if("undefined"==typeof this.name2oidList[name])throw"Name of ObjectIdentifier not defined: "+name;var oid=this.name2oidList[name],obj=new KJUR.asn1.DERObjectIdentifier({oid:oid});return this.objCache[name]=obj},this.atype2obj=function(atype){if("undefined"!=typeof this.objCache[atype])return this.objCache[atype];if("undefined"==typeof this.atype2oidList[atype])throw"AttributeType name undefined: "+atype;var oid=this.atype2oidList[atype],obj=new KJUR.asn1.DERObjectIdentifier({oid:oid});return this.objCache[atype]=obj}},KJUR.asn1.x509.OID.oid2name=function(oid){var list=KJUR.asn1.x509.OID.name2oidList;for(var name in list)if(list[name]==oid)return name;return""},KJUR.asn1.x509.OID.oid2atype=function(oid){var list=KJUR.asn1.x509.OID.atype2oidList;for(var atype in list)if(list[atype]==oid)return atype;return oid},KJUR.asn1.x509.OID.name2oid=function(name){var list=KJUR.asn1.x509.OID.name2oidList;return list[name]===undefined?"":list[name]},KJUR.asn1.x509.X509Util={},KJUR.asn1.x509.X509Util.newCertPEM=function(param){var _KJUR_asn1_x509=KJUR.asn1.x509,_TBSCertificate=_KJUR_asn1_x509.TBSCertificate,_Certificate=_KJUR_asn1_x509.Certificate,o=new _TBSCertificate;if(param.serial===undefined)throw"serial number undefined.";if(o.setSerialNumberByParam(param.serial),"string"!=typeof param.sigalg.name)throw"unproper signature algorithm name";if(o.setSignatureAlgByParam(param.sigalg),param.issuer===undefined)throw"issuer name undefined.";if(o.setIssuerByParam(param.issuer),param.notbefore===undefined)throw"notbefore undefined.";if(o.setNotBeforeByParam(param.notbefore),param.notafter===undefined)throw"notafter undefined.";if(o.setNotAfterByParam(param.notafter),param.subject===undefined)throw"subject name undefined.";if(o.setSubjectByParam(param.subject),param.sbjpubkey===undefined)throw"subject public key undefined.";if(o.setSubjectPublicKeyByGetKey(param.sbjpubkey),param.ext!==undefined&&param.ext.length!==undefined)for(var i=0;i<param.ext.length;i++)for(key in param.ext[i])o.appendExtensionByName(key,param.ext[i][key]);if(param.cakey===undefined&&param.sighex===undefined)throw"param cakey and sighex undefined.";var cert=null;return param.cakey&&(cert=new _Certificate({tbscertobj:o,prvkeyobj:!0===param.cakey.isPrivate?param.cakey:KEYUTIL.getKey.apply(null,param.cakey)})).sign(),param.sighex&&(cert=new _Certificate({tbscertobj:o})).setSignatureHex(param.sighex),cert.getPEMString()};
!function(){Array.prototype.fill||(Array.prototype.fill=function(e){if(null==this)throw new TypeError("this is null or not defined");for(var r=Object(this),t=r.length>>>0,n=arguments[1]>>0,i=n<0?Math.max(t+n,0):Math.min(n,t),o=arguments[2],c=o===undefined?t:o>>0,u=c<0?Math.max(t+c,0):Math.min(c,t);i<u;)r[i]=e,i++;return r}),Uint8Array.prototype.fill||(Uint8Array.prototype.fill=function(e){if(null==this)throw new TypeError("this is null or not defined");for(var r=Object(this),t=r.length>>>0,n=arguments[1]>>0,i=n<0?Math.max(t+n,0):Math.min(n,t),o=arguments[2],c=o===undefined?t:o>>0,u=c<0?Math.max(t+c,0):Math.min(c,t);i<u;)r[i]=e,i++;return r});var oe={};oe.util=oe.util||{},oe.util.cookie=oe.util.cookie||function(){"use strict";var e={get:function(e){try{for(var r=e+"=",t=document.cookie.split(";"),n=0;n<t.length;n++){for(var i=t[n];" "===i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(r))return decodeURI(i.substring(r.length,i.length))}}catch(o){}return""},set:function(e,r,t,n){var i="";if(t!==undefined&&""!==t&&(i+="; domain="+t),n!==undefined){var o=new Date;i="; expires="+new Date(o.getTime()+24*n*60*60*1e3).toGMTString()}document.cookie=e+"="+encodeURI(r)+"; path=/"+i}};return e}(),function(e,r,t,n){"use strict";var d=r,f=t;e.PINsign={};var o={subtle:{}};n!==undefined&&(o.subtle=n.subtle||n.webkitSubtle||{});var i,c,u,a,y=(i={},c=window,i.log=function(){try{var e=localStorage.getItem("PINsign.LogLevel");if(null===e)return;e=parseInt(e),console.log!==undefined&&100<e&&console.log.apply(c,arguments)}catch(r){}},i.debug=function(){try{var e=localStorage.getItem("PINsign.LogLevel");if(null===e)return;e=parseInt(e),console.trace!==undefined&&200<e&&console.trace.apply(c),console.log!==undefined&&100<e&&console.log.apply(c,arguments)}catch(r){}},i),g=((u={SERVER_ERROR_BASE:1e4,PINFAIL:4,PINLOCK:18,SUCCESS:0,CANCEL:1,ISSUE:2,WEB_ERROR_BASE:1e3}).COMMON_ERROR=u.WEB_ERROR_BASE,u.AJAX_FAIL=u.WEB_ERROR_BASE++,u.IFRAME_POSTMESSAGE_FAIL=u.WEB_ERROR_BASE++,u.POSTMESSAGE_INVALID_ORIGIN=u.WEB_ERROR_BASE++,u.BERRY_NOT_EXIST=u.WEB_ERROR_BASE++,u.ENCKEY_DECRYPT_FAIL=u.WEB_ERROR_BASE++,u.SECRET_DECRYPT_FAIL=u.WEB_ERROR_BASE++,u.SECRET_DATA_DECRYPT_FAIL=u.WEB_ERROR_BASE++,u.SECRET_DATA_ENCRYPT_FAIL=u.WEB_ERROR_BASE++,u.AES_KEYGEN_FAIL=u.WEB_ERROR_BASE++,u.AES_ENC_FAIL=u.WEB_ERROR_BASE++,u.AES_DEC_FAIL=u.WEB_ERROR_BASE++,u.RSA_KEYGEN_FAIL=u.WEB_ERROR_BASE++,u.INDEXEDDB_EXEC_FAIL=u.WEB_ERROR_BASE++,u.INDEXEDDB_INVALID_CMD=u.WEB_ERROR_BASE++,u.INDEXEDDB_RETURN_ERROR=u.WEB_ERROR_BASE++,u.INDEXEDDB_OPEN_FAIL=u.WEB_ERROR_BASE++,u.INDEXEDDB_FP_SAVE_FAIL=u.WEB_ERROR_BASE++,u.IFRAME_RECEIVE_FAIL=u.WEB_ERROR_BASE++,u.REQUEST_NONCE_FAIL=u.WEB_ERROR_BASE++,u.JWS_PARSE_ERROR=u.WEB_ERROR_BASE++,u.REVOKE_FAIL=u.WEB_ERROR_BASE++,u.MAKE_CHANGE_PIN_DATA_FAIL=u.WEB_ERROR_BASE++,u.INVALID_PARAM=u.WEB_ERROR_BASE++,u.CHANGEPIN_FAIL=u.WEB_ERROR_BASE++,u.CONNECTED_ERROR=u.WEB_ERROR_BASE++,u.PIN_VALITITY_FAIL=u.WEB_ERROR_BASE++,u.UNKNOWN_ERROR=u.COMMON_ERROR+999,u),l=a={JWS_KEYTYPE:"EC",JWS_KEYPARAM:"secp256r1",JWS_ALG:"ES256",KEYSTORENAME:"ID2KeyStore",PREFIX_HASHPIN:"WIZVERA ID2",PREFIX_SECRET_KEY:"WIZVERA ID2 key",PREFIX_SECRET_IV:"WIZVERA ID2 iv",PREFIX_SHARED:"WIZVERA ID2",CRYPTO_SYM_ALG:"AES-CBC",KEYSTORE_VER:5,POSTMESSAGE_TIMEOUT:1e4,ENC_LOCALSTORAGE:!0,isEncryptLocalStorage:function(){return a.ENC_LOCALSTORAGE}};function S(e){if(y.debug(e),this.e=e,this.code=e.code||(e.error||{}).code||g.COMMON_ERROR,this.message=e.message||(e.error||{}).message||JSON.stringify(e),this.code<=g.UNKNOWN_ERROR&&(this.message=this.message||Y.getErrorMsg(this.code)),e.error!==undefined)for(var r in e.error)"code"!==r&&"message"!==r&&(this[r]=e.error[r]);this.toString=function(){return"code : "+this.code+", message : "+this.message+"\n"+JSON.stringify(e)}}S.isServerError=function(e){return 1e4<=e},S.createByCode=function(e,r){var t;return r!==undefined&&(t=r.error||JSON.stringify(r)),new S({code:e,message:Y.getErrorMsg(e,t)})},S.checkAndCreate=function(e,r){return S.isID2Error(e)?e:new S(S.createByCode(r))},S.isID2Error=function(e){return"object"==typeof e&&(e.code!==undefined&&e.message!==undefined||e.constructor.name!==undefined&&"ID2Error"===e.constructor.name)},S.toID2Error=function(e){return!0===S.isID2Error(e)?e:S.createByCode(g.UNKNOWN_ERROR,e)};var p,E,s,h,I,P,v,C,R,m=function(){var c={};function r(e,t,i,o){return o=o||function(e,r,t){return S.createByCode(g.AJAX_FAIL,"Secret : "+r)},new Promise(function(r,n){d.ajax({url:e,data:i,method:t,async:!0,success:function(e){c.isSuccess(e)?r(e):n(c.toID2Error(e))},error:function(e,r,t){n(o(e,r,t))}})})}return c.isSuccess=function(e){return e.error===undefined&&(e.resultCode===undefined||e.resultCode!==undefined&&0===e.resultCode)},c.toID2Error=function(e){return c.isSuccess(e)?new S(S.createByCode(g.SUCCESS)):new S({code:e.resultCode,message:e.errMsg,error:e})},c.getNonce=function(){var r="";return d.ajax({url:PINsignConfig.SERVICE_URL,data:{action:"nonce"},method:"POST",async:!1,success:function(e){r=K.isString(e)?JSON.parse(e.trim()).nonce:e.nonce},error:function(e,r){y.debug("PINsignRequestNonce error : "+e.toString())}}),r},c.serverTime=function(){var r=parseInt((new Date).getTime()/1e3);return d.ajax({url:PINsignConfig.SERVICE_URL,data:{action:"time"},method:"GET",async:!1,success:function(e){c.isSuccess(e)&&(r=e.time||r,K.isString(r)&&(r=parseInt(r)))},error:function(e,r,t){y.debug("server time request fail "+t)}}),r},c.berryList=function(e){return r(PINsignConfig.SERVICE_URL,"POST",e)},c.changePin=function(e){return r(PINsignConfig.SERVICE_URL,"POST",e)},c.berrySecret=function(e){return r(PINsignConfig.SERVICE_URL,"POST",e)},c.revoke=function(e){return r(PINsignConfig.SERVICE_URL,"POST",e)},c.renew=function(e){return r(PINsignConfig.SERVICE_URL,"POST",e)},c.issue=function(e){return r(PINsignConfig.SERVICE_URL,"POST",e)},c}(),_=(E={},(p={}).issuedBerryList=function(e){return m.berryList({action:"berryList",jws:e})},p.changePin=function(e,r,t,n){var i={};return i.hashPin=te.Crypto.Util.getHashPin(r),i.newHashPin=te.Crypto.Util.getHashPin(t),i.berry=e.berry,te.SecretDecrypto.decryptPinSecretByPin(n.pinSecret,r).then(function(e){return te.SecretDecrypto.encryptPinSecretByPin(e,t)}).then(function(e){i.newPinSecret=e;var r={action:"changePin",berry:i.berry,hashPin:i.hashPin,newHashPin:i.newHashPin,newPinSecret:i.newPinSecret};return te.Requester.changePin(r)})["catch"](function(e){return Promise.reject(S.checkAndCreate(e,g.CHANGEPIN_FAIL))})},p.revokeBerry=function(e){try{var r=O.expandCompactJwx(e).payload;T.payloadToBerryInfo(JSON.parse(r))}catch(t){te.Logger.log("retrive id from payload fail",t)}return te.KeyStore.load().then(function(){return m.revoke({action:"revoke",berry:e})})["catch"](function(e){return Promise.reject(S.checkAndCreate(e,g.REVOKE_FAIL))})},p.replaceBerry=function(n,r,t){var i=n;return te.KeyStore.load().then(function(){return te.KeyStore.getBerry(n)}).then(function(e){return p.storeBerry(e.subject,r,t)}).then(function(e){if(n===e.id2key)return"";i=e.id2key;var r=te.KeyStore.delBerry(n),t=te.KeyStore.delKey(n);return Promise.all([r,t])}).then(function(){return{id2key:i}})},p.updateBerry=function(n,e,i){var o={};return o.hashPin=te.Crypto.Util.getHashPin(e),o.secretPin=te.Crypto.Util.getSecretPin(e),o.sharedPin=te.Crypto.Util.getSharedPin(e),o.encryptedBerrySecret=i.berrySecret||i.secret,o.encryptedPinSecret=i.pinSecret,te.KeyStore.load().then(function(){var e=N.decrypt(o.encryptedBerrySecret,o.encryptedPinSecret,o.sharedPin,o.secretPin),r=te.KeyStore.getKey(n),t=te.KeyStore.getBerry(n);return Promise.all([e,r,t])}).then(function(e){return o.decryptedSecret=e[0],o.keyInfo=e[1],o.berry=e[2],te.Crypto.Util.decryptSecretData(o.berry.encryptedKey,o.keyInfo.cryptoKey,o.decryptedSecret)}).then(function(e){e=b64toutf8(e),(e=JSON.parse(e)).berry=i.berry,e.vidRandom=i.vidRandom||"",e.svidRandom=i.svidRandom||"";var r=O.expandCompactJwx(e.berry),t=JSON.parse(r.payload),n=T.payloadToBerryInfo(t);return n.berry=o.berry,o.berryInfo=n,te.Crypto.Util.encryptSecretData(JSON.stringify(e),o.keyInfo.cryptoKey,o.decryptedSecret)}).then(function(e){return o.berryInfo.encryptedKey=e,te.KeyStore.setBerry(o.berryInfo)}).then(function(){return{id2key:o.berryInfo.id}})},p.storeBerry=function(e,r,t){var n=E[e];return delete E[e],p._storeBerry(e,r,n,t)},p._storeBerry=function(e,r,t,n){if(n.error!==undefined)return Promise.reject(new S(n.error));var i=O.expandCompactJwx(n.berry),o={};return o.berry=n.berry,o.vidRandom=n.vidRandom||"",o.svidRandom=n.svidRandom||"",o.encryptedBerrySecret=n.berrySecret||n.secret,o.encryptedPinSecret=n.pinSecret,o.payload=JSON.parse(i.payload),o.hashPin=te.Crypto.Util.getHashPin(r),o.secretPin=te.Crypto.Util.getSecretPin(r),o.sharedPin=te.Crypto.Util.getSharedPin(r),o.keyPair=t,te.KeyStore.load().then(function(){return N.decrypt(o.encryptedBerrySecret,o.encryptedPinSecret,o.sharedPin,o.secretPin)}).then(function(e){o.decryptedBerrySecret=e;var r=T.payloadToBerryInfo(o.payload);return r.berry=o.berry,te.KeyStore.getKey(r.id).then(function(e){return K.isValidValue(e)?e.cryptoKey:te.Crypto.genKeyAES256()})}).then(function(e){return o.cryptoKey=e,Promise.resolve("")}).then(function(){var e={vidRandom:o.vidRandom,svidRandom:o.svidRandom,keyPair:o.keyPair},r=JSON.stringify(e);return te.Crypto.Util.encryptSecretData(r,o.cryptoKey,o.decryptedBerrySecret)}).then(function(e){var r=T.payloadToBerryInfo(o.payload);return r.berry=o.berry,r.encryptedKey=e,o.id=r.id,te.KeyStore.setBerry(r)}).then(function(){var e={id:o.id,cryptoKey:o.cryptoKey};return te.KeyStore.setKey(e)}).then(function(){return{id2key:o.id}})},p._genBerryRequest=function(i,o){var c={issueReqData:null};return c.randomNonce=te.Crypto.Util.getRandom(32),c.sharedPin=te.Crypto.Util.getSharedPin(o),c.secretPin=te.Crypto.Util.getSecretPin(o),te.Crypto.genKeyECDSAKeyPairJWK().then(function(e){E[i]=e,c.keyPair=e;var r=te.Crypto.Util.getHashPin(o),t={jwk:JSON.stringify(e.pub)};i!==undefined&&""!==i&&(t.sub=i);var n={cty:"BERRY REQ",typ:"JWT",sat:te.Requester.serverTime()};return{berryReq:te.Crypto.JWS.simpleSignJWS(e.prv,n,t),keyPair:e,hashPin:r}})},p.genRenewReq=function(r,t){var n=te.Crypto.Util.getHashPin(t),i={};return te.KeyStore.load().then(function(){return te.KeyStore.getBerry(r)}).then(function(e){return null===e?Promise.reject(S.create(g.BERRY_NOT_EXIST,r)):(i.fromBerry=e,p._genBerryRequest(i.fromBerry.subject,t))}).then(function(e){var r=JSON.stringify({req:e.berryReq});return te.Service.sign(i.fromBerry,t,r,{cty:"BERRY RENEW"})}).then(function(e){return{action:"renew",berryRenew:e.signedData,hashPin:n}})},p.genBerryReq=function(c,u,a,s,d){if(te.Logger.log(", name : ",c,", pin : ","",", ref : ",u,", auth : ",a,", exist  : ",s),!K.isValidValue(c)||!K.isValidValue(u)||!K.isValidValue(a))return new Promise.reject(new te.ID2Error({code:g.INVALID_PARAM,message:Y.getErrorMsg(g.INVALID_PARAM)}));var f={issueReqData:null};return f.randomNonce=te.Crypto.Util.getRandom(32),f.sharedPin=te.Crypto.Util.getSharedPin(d),f.secretPin=te.Crypto.Util.getSecretPin(d),p._genBerryRequest(c,d).then(function(e){E[c]=e.keyPair,f.keyPair=e.keyPair;var r=te.Crypto.Util.getHashPin(d),t={req:e.berryReq},n={cty:"BERRY ISSUE",kid:u,sat:te.Requester.serverTime()},i=te.Crypto.JWS.makeHS256(n,t,a),o={action:s?"issueAdd":"issueNew",berryReq:i,hashPin:r};return f.issueReqData=o,te.SecretDecrypto.encryptPinSecret(f.randomNonce,f.sharedPin,f.secretPin)}).then(function(e){return f.issueReqData.pinSecret=e,{name:c,data:f.issueReqData}})},p.requestEncryptedSecret=function(e,r,t){var n=te.Crypto.Util.getSharedPin(r),i=te.Crypto.Util.createMAC(t,n),o={action:"secret",berryId:e.serialNumber,nonceMac:i,berry:e.berry};return m.berrySecret(o)},p.decryptSecret=function(e,r){return N.decrypt(e.berrySecret,e.pinSecret,te.Crypto.Util.getSharedPin(r),te.Crypto.Util.getSecretPin(r))},p.renewBerry=function(e,r,t,n){var i={id2key:e,secretPin:te.Crypto.Util.getSecretPin(r),hashPin:te.Crypto.Util.getHashPin(r),sharedPin:te.Crypto.Util.getSharedPin(r),securePin:r};return te.KeyStore.load().then(function(){return p.sign(e,pin,t,n,JSON.stringify({data:"myData"}),{cty:"BERRY RENEW"})}).then(function(e){var r={action:"renew",berryRenew:e.signedData,hashPin:i.hashPin};return m.renew(r)}).then(function(e){return i.newBerry=e.berry,N.decrypt(e.berrySecret,e.pinSecret,i.sharedPin,i.secretPin)}).then(function(e){return i.decryptedSecret=e,te.KeyStore.getKey(i.id2key)}).then(function(e){return i.keyInfo=e.key||e,te.KeyStore.getBerry(i.id2key)}).then(function(e){return i.berryInfo=e,te.Crypto.Util.decryptSecretData(e.encryptedKey,i.keyInfo.cryptoKey,i.decryptedSecret)}).then(function(e){e=b64toutf8(e),(e=JSON.parse(e)).berry=i.newBerry;var r=O.expandCompactJwx(e.berry),t=JSON.parse(r.payload);return i.berryInfo=T.payloadToBerryInfo(t),i.berryInfo.berry=e.berry,te.Crypto.Util.encryptSecretData(JSON.stringify(e),i.keyInfo.cryptoKey,i.decryptedSecret)}).then(function(e){return i.berryInfo.encryptedKey=e,te.KeyStore.setBerry(i.berryInfo)})},p.sign=function(r,e,t,o,c){c=c||{};var n=te.Crypto.Util.getHashPin(e),i=te.Crypto.Util.getSharedPin(e),u={data:o,id2key:r,securePin:e,encSecret:t,sharedPin:i,hashPin:n};return te.KeyStore.load().then(function(){return te.KeyStore.getBerry(r)}).then(function(e){return K.isValidValue(e)?(u.berry=e,te.KeyStore.getKey(r)):Promise.reject(S.createByCode(g.BERRY_NOT_EXIST,r))}).then(function(e){return u.keyInfo=e.key||e,_.decryptSecret(u.encSecret,u.securePin)}).then(function(e){return te.Crypto.Util.getSecretIVFromKey(u.sharedPin),te.Crypto.Util.decryptSecretData(u.berry.encryptedKey,u.keyInfo.cryptoKey,e)}).then(function(i){return new Promise(function(e,r){try{i=b64toutf8(i);var t=JSON.parse(i);e(b.makeLoginData(o,c,t,u.berry))}catch(n){r(new S({code:g.ENCKEY_DECRYPT_FAIL,message:Y.getErrorMsg(g.ENCKEY_DECRYPT_FAIL,n.toString())}))}})})["catch"](function(e){return!1===S.isID2Error(e)&&(e=S.toID2Error(e)),e.berry=e.berry||u.berry,Promise.reject(e)})},p),N=s={makeChangePinData:function(e,r,t){return this.decryptPinSecretByPin(t,e).then(function(e){return s.encryptPinSecretByPin(e,r)})["catch"](function(e){Promise.reject(S.checkAndCreate(e,g.MAKE_CHANGE_PIN_DATA_FAIL))})},decryptByPin:function(e,r,t){var n=te.Crypto.Util.getSharedPin(t),i=te.Crypto.Util.getSecretPin(t);return this.decrypt(e,r,n,i)},decrypt:function(e,r,t,n){var i=this.decryptSecret(e,t),o=this.decryptPinSecret(r,t,n);return Promise.all([i,o]).then(function(e){var r=b64utob64(e[0]),t=b64utob64(e[1]),n=stob64(te.Config.PREFIX_SHARED+t+r);return n=CryptoJS.SHA256(n).toString(),Promise.resolve(n)})["catch"](function(e){return Promise.reject(S.checkAndCreate(e,g.SECRET_DECRYPT_FAIL))})},encryptPinSecretByPin:function(e,r){var t=te.Crypto.Util.getSharedPin(r),n=te.Crypto.Util.getSecretPin(r);return this.encryptPinSecret(e,t,n)},encryptPinSecret:function(e,r,t){return te.Logger.debug("Encrypt Pin Secret : ",{secret:e,sharedPin:r,secretPin:t}),N.encryptSecret(e,t).then(function(e){return te.Logger.debug("First Encrypt Result 1: ",{encPinSecret:e}),e=utf8tob64u(e),te.Logger.debug("First Encrypt Result 2: ",{encPinSecret:e}),N.encryptSecret(e,r)}).then(function(e){return te.Logger.debug("Second Encrypt Result : ",{pinSecret:e}),Promise.resolve(e)})["catch"](function(e){return Promise.reject("encryptPinSecret Fail"+e.toString())})},decryptPinSecretByPin:function(e,r){var t=te.Crypto.Util.getSharedPin(r),n=te.Crypto.Util.getSecretPin(r);return this.decryptPinSecret(e,t,n)},decryptPinSecret:function(e,r,t){return te.Logger.debug("Decrypt Pin Secret : ",{secret:e,sharedPin:r,secretPin:t}),N.decryptSecret(e,r).then(function(e){return te.Logger.debug("First Decrypt Result 1: ",{encPinSecret:e}),e=b64utoutf8(e),te.Logger.debug("First Decrypt Result 2: ",{encPinSecret:e}),N.decryptSecret(e,t)}).then(function(e){return te.Logger.debug("Second Decrypt Result : ",{encPinSecret:e}),Promise.resolve(e)})["catch"](function(e){return Promise.reject("decryptPinSecret Fail"+e.toString())})},decryptSecretByPin:function(e,r){var t=te.Crypto.Util.getSharedPin(r);return this.decryptSecret(e,t)},decryptSecret:function(e,r){var t=s.getShared(r),n=s.splitSecretData(b64utohex(e)),i=s.getKey(t,n.iv),o=n.encryptedBerrySecret;return te.Crypto.keyObjectFromString(hextob64(i)).then(function(e){return te.Crypto.decryptAES(hextob64(o),e,n.iv)}).then(function(e){return b64tob64u(e)})["catch"](function(e){return Promise.reject("decryptSecret Fail + "+e.toString())})},encryptSecret:function(e,r){var t=b64utohex(e),n=s.getShared(r),i="c0a227ada01ea423ccc312ad53ae1e0f",o=s.getKey(n,i);return te.Crypto.keyObjectFromString(hextob64(o)).then(function(e){return te.Crypto.encryptAES(hextob64(t),e,i)}).then(function(e){var r=s.combinSecretData(i,b64tohex(e));return hextob64u(r)})},getShared:function(e){return CryptoJS.SHA256(l.PREFIX_SHARED+e).toString()},combinSecretData:function(e,r){return e+r},splitSecretData:function(e){var r=new Uint8Array(hextoArrayBuffer(e)),t=r.subarray(0,16),n=r.subarray(16);return{iv:te.Encoder.BAtoHex(t),encryptedBerrySecret:te.Encoder.BAtoHex(n)}},makeSecretData:function(e,r){return hextob64u(e+r)},getKey:function(e,r){var t=new Uint8Array(4);t[0]=0,t[1]=0,t[2]=0,t[3]=1;var n=new Uint8Array(hextoArrayBuffer(e)),i=new Uint8Array(hextoArrayBuffer(r)),o=new Uint8Array(n.length+i.length+t.length);o.set(n,0),o.set([0,0,0,1],n.length),o.set(i,n.length+t.length);var c=CryptoJS.enc.Hex.parse(te.Encoder.BAtoHex(o));return CryptoJS.SHA256(c).toString()}},A={makeHS256:function(e,r,t){return e=d.extend({alg:"HS256"},e),KJUR.jws.JWS.sign("HS256",JSON.stringify(e),JSON.stringify(r),{hex:b64utohex(t)})},simpleSignJWS:function(e,r,t){var n=KEYUTIL.getKey(e);return r=d.extend({alg:"ES256"},r),KJUR.jws.JWS.sign("ES256",JSON.stringify(r),t,n)},signJWSWithBerry:function(e,r,t,n){var i=KEYUTIL.getKey(e);r.sat===undefined&&(r.sat=te.Requester.serverTime());var o={alg:"ES256",BERRY:n};return o=d.extend({},o,r),KJUR.jws.JWS.sign("ES256",JSON.stringify(o),t,i)}},b=h={getSignature:function(e){},makeLoginData:function(e,r,t,n){var i=n.berry,o=t.keyPair,c=te.Crypto.JWS.signJWSWithBerry(o.prv,r,e,i||t.berry),u={},a=te.PublicUtil.jwsToBerryInfo(i);return u.id2key=a.id,u.berry=i,u.signedData=c,"vid"===PINsignConfig.INCLUDE_VID_RANDOM&&(u.vidRandom=t.vidRandom||""),"svid"===PINsignConfig.INCLUDE_VID_RANDOM&&(u.svidRandom=t.svidRandom||""),"both"===PINsignConfig.INCLUDE_VID_RANDOM&&(u.vidRandom=t.vidRandom||"",u.svidRandom=t.svidRandom||""),u},AES256KeyFromString:function(e){var r=te.Crypto.Util.sha256(l.PREFIX_SECRET_IV+e,512),t=te.Crypto.Util.sha256(l.PREFIX_SECRET_IV+r,512);return{hexKey:r=r.substr(0,64),hexIv:t=t.substr(0,32)}},getSecretIVFromKey:function(e){return CryptoJS.SHA256(l.PREFIX_SECRET_IV+e).toString()},getSecretPin:function(e){return e.getHashedPIN(l.PREFIX_HASHPIN,512)},getHashPin:function(e){return e.getHashedPIN(l.PREFIX_HASHPIN,1024)},getSharedPin:function(e){var r=h.getHashPin(e);return h.getHashPin((new M).setPIN(r))},getRandom:function(e){return hextob64u(this.getRandomHex(e))},getRandomHex:function(e){return CryptoJS.lib.WordArray.random(e).toString()},createMAC:function(e,r){return hextob64u(CryptoJS.HmacSHA256(e,r).toString())},sha256:function(e,r){for(var t=0;t<r;t++)e=CryptoJS.SHA256(e);return e.toString()},decryptSecretData:function(r,t,e){var n,i=te.Crypto.Util.getSecretIVFromKey(e);return te.Crypto.keyObjectFromString(e).then(function(e){return n=e,te.Crypto.decryptAES(r,t,i)}).then(function(e){return te.Crypto.decryptAES(e,n,i)}).then(function(e){return te.Crypto.decryptAES(e,t,i)}).then(function(e){return e})["catch"](function(e){return Promise.reject(S.checkAndCreate(e,g.SECRET_DATA_DECRYPT_FAIL))})},encryptSecretData:function(r,t,e){var n,i=te.Crypto.Util.getSecretIVFromKey(e);return te.Crypto.keyObjectFromString(e).then(function(e){return n=e,te.Crypto.encryptAES(stob64(r),t,i)}).then(function(e){return te.Crypto.encryptAES(e,n,i)}).then(function(e){return te.Crypto.encryptAES(e,t,i)}).then(function(e){return e})["catch"](function(e){return Promise.reject(S.checkAndCreate(e,g.SECRET_DATA_ENCRYPT_FAIL))})}},w=I={keyObjectFromString:function(e){var n=o.subtle.importKey("raw",new Uint8Array(b64toBA(e)).subarray(0,32),{name:"AES-CBC"},!1,["encrypt","decrypt"]);return window.msCrypto===undefined?n:new Promise(function(r,t){n.oncomplete=function(e){r(e.currentTarget.result)},n.onerror=function(e){t(e)}})},genKeyECDSAKeyPairJWK:function(){return I.genKeyECDSAKeyPair().then(function(e){var r=o.subtle.exportKey("jwk",e.privateKey),t=o.subtle.exportKey("jwk",e.publicKey);return Promise.all([r,t])}).then(function(e){return{prv:e[0],pub:e[1]}})["catch"](function(e){return B.genKeyECDSAKeyPairJWK()})},genKeyECDSAKeyPair:function(){return o.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"])["catch"](function(e){return Promise.reject(S.checkAndCreate(e,g.RSA_KEYGEN_FAIL))}).then(function(e){return e})},genKeyAES256:function(){return o.subtle.generateKey({name:"AES-CBC",length:256},!1,["encrypt","decrypt"]).then(function(e){return e})["catch"](function(e){return Promise.reject(S.checkAndCreate(e,g.AES_KEYGEN_FAIL))})},encryptAES:function(e,r,t){var n,i;return n=(n=new Uint8Array(hextoArrayBuffer(t))).subarray(0,16),i=new Uint8Array(b64toBA(e)),o.subtle.encrypt({name:"AES-CBC",iv:n},r,i).then(function(e){return hextob64(te.Encoder.BAtoHex(new Uint8Array(e)))})["catch"](function(e){return Promise.reject(S.checkAndCreate(e,g.AES_ENC_FAIL))})},decryptAES:function(e,r,t){var n,i;return n=(n=new Uint8Array(hextoArrayBuffer(t))).subarray(0,16),i=new Uint8Array(b64toBA(e)),o.subtle.decrypt({name:"AES-CBC",iv:n},r,i).then(function(e){var r=hextob64(te.Encoder.BAtoHex(new Uint8Array(e)));return Promise.resolve(r)})["catch"](function(e){return Promise.reject(S.checkAndCreate(e,g.AES_DEC_FAIL))})}},B={keyObjectFromString:function(e){return Promise.resolve(e)},genKeyECDSAKeyPair:function(){throw new Error("not implement")},genKeyECDSAKeyPairJWK:function(){return new Promise(function(e,r){if(KEYUTIL!==undefined){var t=KEYUTIL.generateKeypair(l.JWS_KEYTYPE,l.JWS_KEYPARAM);if(!K.isValidValue(t))return y.error("[KeyData] key generate fail "),{};e({prv:KEYUTIL.getJWKFromKey(t.prvKeyObj),pub:KEYUTIL.getJWKFromKey(t.pubKeyObj)})}else r(S.createByCode(g.RSA_KEYGEN_FAIL))})},genKeyAES256:function(){return new Promise(function(e,r){var t=CryptoJS.lib.WordArray.random(16),n=CryptoJS.enc.Hex.stringify(CryptoJS.lib.WordArray.random(16)),i=CryptoJS.enc.Hex.stringify(CryptoJS.lib.WordArray.random(32));e({hexKey:CryptoJS.enc.Hex.stringify(CryptoJS.PBKDF2(i,t,{keySize:8,iterations:10})),hexIv:n})})},encryptAES:function(u,a,s){return new Promise(function(e,r){try{var t;t=a.hexKey||b64tohex(a),s=a.hexIv||s;var n=CryptoJS.enc.Hex.parse(s),i=CryptoJS.enc.Hex.parse(t),o=CryptoJS.enc.Base64.parse(u);e(CryptoJS.enc.Base64.stringify(CryptoJS.AES.encrypt(o,i,{iv:n}).ciphertext))}catch(c){r(S.createByCode(g.AES_ENC_FAIL))}})},decryptAES:function(c,u,a){return new Promise(function(e,r){try{var t;t=u.hexKey||b64tohex(u),a=u.hexIv||a;var n=CryptoJS.enc.Hex.parse(a),i=CryptoJS.enc.Hex.parse(t);CryptoJS.enc.Base64.parse(c);e(CryptoJS.enc.Base64.stringify(CryptoJS.AES.decrypt(c,i,{iv:n})))}catch(o){r(S.createByCode(g.AES_DEC_FAIL))}})}},D=function(){var e={};function r(e){var t=e;return function(e,r){return K.isEmptyString(r)?e:(K.isString(r)&&(r=[r]),0===r.length?e:f.filter(e,function(e){return-1!==f.indexOf(r,t(e))}))}}var c=r(function(e){return e.issuer.uid}),u=r(function(e){return e.issuer.issuerSubject}),a=r(function(e){return e.subject}),s=r(function(e){return e.id}),d=r(function(e){return e.issuer.profile||""});return e.filter=function(e,r){var t;r=r||{};var n,i=[],o=[];return PINsignConfig!==undefined&&PINsignConfig.filter!==undefined&&PINsignConfig.filter.issuer!==undefined&&(i=PINsignConfig.filter.issuer),PINsignConfig!==undefined&&PINsignConfig.filter!==undefined&&PINsignConfig.filter.profile!==undefined&&(o=PINsignConfig.filter.profile),t=c(e,r.uid||r.uidFilter),t=a(t,r.subject||r.subjectFilter),t=u(t,r.issuer||r.issuerFilter||i),t=d(t,r.profile||r.profileFilter||o),r.id2key!==undefined&&(t=s(t,r.id2key)),r.hideExpire===undefined&&(PINsignConfig.hideExpire===undefined&&(PINsignConfig.hideExpire=!0),r.hideExpire=PINsignConfig.hideExpire),!0===r.hideExpire&&(n=t,t=f.filter(n,function(e){return!(1e3*e.expireDate<(new Date).getTime())})),t=this.sortByIssuer(t)},e.sortByIssuer=function(e){if(e===undefined||e.length<=1)return e;var r=function(e,r){if(e.issuer.issuerSubject<r.issuer.issuerSubject)return-1;if(e.issuer.issuerSubject>r.issuer.issuerSubject)return 1;if(e.issuer.issuerSubject===r.issuer.issuerSubject){if(e.subject<r.subject)return-1;if(e.subject>r.subject)return 1}return 0};return PINsignConfig!==undefined&&PINsignConfig.sortCompare!==undefined&&(r=PINsignConfig.sortCompare),2<=e.length&&(e=e.sort(r)),e},e}(),x=x||(P=null,v={exec:function(e,r,t,n){var i=P.transaction([r],t),o=i.objectStore(r),c=null;if("getAll"===e&&o.getAll===undefined)return new Promise(function(t,r){var e=o.openCursor(),n=[];e.onsuccess=function(e){var r=e.target.result;r?(n.push(r.value),r["continue"]()):t(n)},e.onerror=function(e){r(S.createByCode(g.INDEXEDDB_EXEC_FAIL))}});if("getAll"===e)c=o.getAll();else if("get"===e)c=o.get(n);else if("put"===e)c=o.put(n);else if("clear"===e)c=o.clear();else{if("delete"!==e)return Promise.reject(S.createByCode(g.INDEXEDDB_INVALID_CMD));c=o["delete"](n)}return new Promise(function(r,t){var n=null;i.oncomplete=function(e){r(n)},i.onerror=function(e){y.debug(e.toString()),t(S.createByCode(g.INDEXEDDB_RETURN_ERROR))},c.onsuccess=function(e){!0,n=e.target.result}})}},C={load:function(){return new Promise(function(i,o){var e=indexedDB.open(l.KEYSTORENAME,l.KEYSTORE_VER),c=!1;e.onupgradeneeded=function(e){if(P=e.target.result,1<=e.oldVersion){try{P.deleteObjectStore("Key")}catch(r){}try{P.deleteObjectStore("Berry")}catch(r){}try{P.deleteObjectStore("Info")}catch(r){}}P.createObjectStore("Key",{keyPath:"id"}),P.createObjectStore("Berry",{keyPath:"id"}),P.createObjectStore("Info",{keyPath:"id"}),c=!0},e.onerror=function(e){return y.debug("error:"+e.toString()),o(S.createByCode(g.INDEXEDDB_OPEN_FAIL))},e.onsuccess=function(e){P=e.target.result;var r=null;if(c){var t=P.transaction(["Info"],"readwrite"),n=t.objectStore("Info").put({id:"0",fp:O.getFingerPrint2()});t.oncomplete=function(e){i(r)},n.onsuccess=function(e){r=e.target.result,!0},n.onerror=function(e){y.debug(e.toString()),o(S.checkAndCreate(e,g.INDEXEDDB_FP_SAVE_FAIL))}}return i()}}).then(function(e){return v.exec("get","Info","readwrite","0")}).then(function(e){if(e!==undefined&&!1!==O.isValidFingerPrint(e.fp))return"";var r="Error : fingerprint mismatch : res = "+JSON.stringify(e)+", calc = "+O.getFingerPrint()+", ts = "+O.getID2CreateTimestamp();return y.log(r),console.log("저장된 정보가 삭제됩니다. >> "+r),v.exec("put","Info","readwrite",{id:"0",fp:O.getFingerPrint2()}).then(function(){return v.exec("clear","Berry","readwrite")}).then(function(){return v.exec("clear","Key","readwrite")})})},exec:function(e,r,t,n,i){return v.exec(e,r,t,n)},getBerryList:function(r){return C.exec("getAll","Berry","readwrite").then(function(e){return te.BerryFilter.filter(e,r)})},getKey:function(e){return C.exec("get","Key","readwrite",e)},getBerry:function(r){return C.exec("get","Berry","readwrite",r).then(function(e){return e===undefined||null===e?Promise.reject(S.createByCode(g.BERRY_NOT_EXIST,r)):e})},setKey:function(e){return C.exec("put","Key","readwrite",e)},delBerry:function(r){"string"==typeof r&&(r=[r]);var t=0;return C.exec("delete","Berry","readwrite",r[t]).then(function(e){return++t>=r.length?"":C.exec("delete","Berry","readwrite",r[t])})},delKey:function(r){"string"==typeof r&&(r=[r]);var t=0;return C.exec("delete","Key","readwrite",r[t]).then(function(e){return++t>=r.length?"":C.exec("delete","Key","readwrite",r[t])})},setBerry:function(e){return C.exec("put","Berry","readwrite",e)}}),L=L||function(){for(var e="wizvera geravera",r=0;r<16;r++)e=CryptoJS.SHA256(e).toString();var n={v:CryptoJS.enc.Hex.parse(e&&e.substr(16,32)||"a78ef5afc0032c8f858a9f7c6a9f9b81"),k:CryptoJS.enc.Hex.parse(e||"f0b2d48a93ec016402952e315489e935a247d24d1011f3ef7a385c3cde727941")},t={};function i(){var e={fp:O.getFingerPrint2(),ver:l.KEYSTORE_VER,Berry:[],Key:[]},r=localStorage.getItem(l.KEYSTORENAME);if(""===r||null===r||r===undefined)return e;try{l.isEncryptLocalStorage()&&(r=hextoutf8(CryptoJS.AES.decrypt(r,n.k,{iv:n.v}).toString())),r=JSON.parse(r)}catch(t){r=""}return r.ver===undefined?e:!1===O.isValidFingerPrint(r.fp)?(y.log("fingerprint mismatch"),e):r.ver!==l.KEYSTORE_VER?(alert("DB 변경으로 데이터가 초기화 됩니다."),e):r}function o(e){var r=JSON.stringify(e);l.isEncryptLocalStorage()&&(r=CryptoJS.AES.encrypt(r,n.k,{iv:n.v}).toString()),localStorage.setItem(l.KEYSTORENAME,r)}return t.load=function(){return Promise.resolve(!0)},t.getBerryList=function(e){var r=i(),t=te.BerryFilter.filter(r.Berry,e);return Promise.resolve(t||[])},t.getBerry=function(r){var e=i().Berry||[],t=f.find(e,function(e){return e.id===r});return t===undefined?Promise.reject(S.createByCode(g.BERRY_NOT_EXIST,r)):Promise.resolve(t)},t.setBerry=function(r){var e=i(),t=e.Berry||[];0<t.length?(t=f.map(t,function(e){return e.id===r.id?r:e}),f.find(t,function(e){return e.id===r.id})===undefined&&t.push(r)):t.push(r);return e.Berry=t,o(e),Promise.resolve()},t.getKey=function(r){var e=i().Key||[];if(e.length<=0)return Promise.resolve(null);var t=f.find(e,function(e){return e.id===r});if(t===undefined)return Promise.resolve(null);if(t.cryptoKey.encKeyInfo===undefined)return Promise.resolve(t);var n=te.SecretDecrypto.splitSecretData(b64utohex(t.cryptoKey.encKeyInfo));return t.cryptoKey.hexIv=n.iv,t.cryptoKey.hexKey=n.encryptedBerrySecret,Promise.resolve(t)},t.setKey=function(r){var e=i(),t=e.Key||[],n=te.SecretDecrypto.makeSecretData(r.cryptoKey.hexIv,r.cryptoKey.hexKey);(r.cryptoKey={encKeyInfo:n},0<t.length)?(f.map(t,function(e){return e.id===r.id?r:e}),f.find(t,function(e){return e.id===r.id})===undefined&&t.push(r)):t.push(r);return e.Key=t,o(e),Promise.resolve()},t.delBerry=function(e){var r=i();if(0===r.Berry.length)return Promise.resolve();K.isString(e)&&(e=[e]);var t=f.filter(r.Berry,function(r){return f.find(e,function(e){return e===r.id})===undefined});return r.Berry=t,o(r),Promise.resolve()},t.delKey=function(e){var r=i();if(0===r.Key.length)return Promise.resolve();K.isString(e)&&(e=[e]);var t=f.filter(r.Key,function(r){return f.find(e,function(e){return e===r.id})===undefined});return r.Key=t,o(r),Promise.resolve()},t}(),O=function(){var n={};function r(e,r){var t=r;return e!==undefined&&(t=e[r]||r),t}return n.toReadableIssuerSubject=function(e){return PINsignConfig.str===undefined?e:r(PINsignConfig.str.issuerSubjectAltName,e)},n.toReadableProfileName=function(e){return PINsignConfig.str===undefined?e:r(PINsignConfig.str.profileAltName,e)},n.timestampToString=function(e){var r=new Date(1e3*e),t=r.getYear()-100,n=r.getMonth()+1,i=r.getDate();return r=t+"."+(n=n<=9?"0"+n:n)+"."+(i=i<=9?"0"+i:i)},n.isMobile=function(){return!0===bowser.mobile},n.needRenew=function(e){if(PINsignConfig.BERRY_AUTO_RENEW_TIME<=0)return!0;var r=new Date(1e3*e);r.setTime(r.getTime()+36e5*(PINsignConfig.BERRY_AUTO_RENEW_TIME||24));var t=parseInt(r.getTime()/1e3);return!(parseInt((new Date).getTime()/1e3)<t)},n.getTimeStamp=function(){return Date.now===undefined?(new Date).getTime():Date.now()},n.makeAddHeader=function(e,r){return r=r||{addNonceToJws:!1},(e=e||{}).sat===undefined&&(e.sat=PINsign.Requester.serverTime()),e.nonce===undefined&&(PINsignConfig.ADD_NONCE_TO_JWS!==undefined&&!0===PINsignConfig.ADD_NONCE_TO_JWS?e.nonce=PINsignRequestNonce():!0===r.addNonceToJws&&(e.nonce=PINsignRequestNonce())),e},n.getServiceFrame=function(){return document.getElementById("id2-service-frame")},n.b64utos=function(e){return b64utos(e)},n.b64utoutf8=function(e){return b64utoutf8(e)},n.markLastUsedPINsign=function(e){var r=n.getLastUsedPINsignInfo();return f.map(e,function(e){return e.storeType=e.storeType||"browser",e.id===r.id&&e.storeType===r.type&&(e.lastUsed=!0),e})},n.raiseLastUsedPINsign=function(e){var r=O.getLastUsedPINsignInfo();if(""!==r&&1<e.length)for(var t=1;t<e.length;t++){var n=e[t];if(n.id===r){var i=e[0];e[0]=n,e[t]=i;break}}return e},n.setLastUsedPINsignInfo=function(e,r){r=r||"browser";var t=new te.WebStorageHelper("PINsign.lastUsedInfo");t.setData("id",e),t.setData("type",r)},n.getLastUsedPINsignInfo=function(){var e=new te.WebStorageHelper("PINsign.lastUsedInfo");return{id:e.getData("id"),type:e.getData("type")}},n.expandCompactJwx=function(e){var r=[];try{r=e.split(".")}catch(t){throw y.debug(t),new S({code:g.JWS_PARSE_ERROR,message:Y.getErrorMsg(g.JWS_PARSE_ERROR,e.toString())})}return{header:n.b64utoutf8(r[0]),payload:n.b64utoutf8(r[1]),signature:r[2]}},n.updateCreateTimestamp=function(){var e=oe.util.cookie.get("id2create");return""===e&&(e=this.getTimeStamp(),oe.util.cookie.set("id2create",e,"",9999)),e},n.getID2CreateTimestamp=function(){return n.updateCreateTimestamp()},n.isValidFingerPrint=function(e){return!K.isEmptyString(e)&&(e===this.getFingerPrint()||e===this.getFingerPrint2())},n.getFingerPrint=function(e){var r=e||n.getID2CreateTimestamp();return r+=navigator.platform||"",r+=navigator.vendor||"",r+=window.screen.availHeight||"",r+=window.screen.availWidth||"",CryptoJS.SHA256(r).toString()},n.getFingerPrint2=function(e){var r=e||n.getID2CreateTimestamp();return r+=navigator.platform||"",r+=navigator.vendor||"",CryptoJS.SHA256(r).toString()},n.updateCreateTimestamp(),n}(),T=((R={}).toReadableIssuerSubject=O.toReadableIssuerSubject,R.toReadableProfileName=O.toReadableProfileName,R.setLastUsedPINsignInfo=O.setLastUsedPINsignInfo,R.getLastUsedPINsignInfo=O.getLastUsedPINsignInfo,R.makeAddHeader=O.makeAddHeader,R.getTimeStamp=O.getTimeStamp,R.timestampToString=O.timestampToString,R.needRenew=O.needRenew,R.isMobile=O.isMobile,R.checkPinValidity=function(e,r){r=r||!1;var t=!0;if(!0!==(PINsignConfig.disableDefaultPinPatternCheck||!1)&&(t=e.defaultValidityCheck(r)),PINsignConfig.invalidPinPatternList===undefined)return y.debug("default pin validity result = ",t),t;try{var n=PINsignConfig.invalidPinPatternList()||[],i=e.customValidityCheck(n,r);return y.debug("custom pin validity result = ",i),t&&i}catch(o){return y.debug("pin check exception = ",o),t}},R.isConnectedStoreType=function(e){return(e=e||"").toLowerCase()===PINsign.STORETYPE_CONNECTED},R.appendQueryString=function(e,r){return""===r?e:(e+=-1!==e.indexOf("?")?"&":"?",e+=r)},R.jwsToBerryInfo=function(e){try{return this.payloadToBerryInfo(JSON.parse(this.expandCompactJwx(e).payload))}catch(r){console.log(r)}return null},R.payloadToBerryInfo=function(e){var r={};r.id=e.sn.toString(),r.subject=e.sub||"no name",r.serialNumber=e.sn||"",r.expireDate=e.exp||"",r.issueDate=e.iat||"";var t=null;try{t=JSON.parse(O.expandCompactJwx(e.iss).payload)}catch(i){return r}var n={};return n.subject=t.sub||"",n.uid=t.uid||"",n.expireDate=t.exp||"",n.issueDate=t.iat||"",n.serialNumber=t.sn||"",n.issuerSubject=t.iss||"",n.profile=t.profile||"",r.issuer=n,r.id=function o(e){return CryptoJS.SHA256(e).toString()}(n.issuerSubject+n.uid+n.profile+O.getID2CreateTimestamp()),r},R.isSupport=function(){try{return!(bowser.windows!==undefined&&bowser.msie!==undefined&&!0===bowser.msie&&!0===bowser.windows&&parseInt(bowser.version)<9)}catch(e){}return!0},R.isAlreadyInsideUIFrame=function(){var e=!1;try{null!==window.frameElement&&"iframe"===window.frameElement.nodeName.toLowerCase()&&"pinsign-ui-frame"===window.frameElement.id.toLowerCase()&&(e=!0)}catch(r){}return e},R.expandCompactJwx=function(e){return O.expandCompactJwx(e)},R),K={isEmptyArray:function(e){return!this.isValidValue(e)||!(0<e.length)},isEmptyString:function(e){return null===e||e===undefined||""===e},isValidValue:function(e){return null!==e&&e!==undefined},isObject:function(e){return!1!==this.isValidValue(e)&&"object"==typeof e},isString:function(e){return!1!==this.isValidValue(e)&&"string"==typeof e}},U=function(e){var r={},t=e,n=0,i=0;function o(e){var r=i-n;console.log(e,"  >> ",t," elapsed time : ",r/1e3," sec")}return r.start=function(){try{i=n=performance.now()}catch(e){}},r.check=function(){try{i=performance.now(),o("!!Check")}catch(e){}},r.finish=function(){try{i=performance.now(),o("!!Finish")}catch(e){}},r};function k(e,r){return a={_targetUrl:e,name:r},t=0,y.log("RequestStore URL : ",a._targetUrl),a.invoke=function(o,c,u){return u=u||l.POSTMESSAGE_TIMEOUT,c.handle=this.getNextHandle(),new Promise(function(e,r){try{o.postMessage(JSON.stringify(c),function n(){if(K.isEmptyString(a._targetUrl))return"*";var e=document.createElement("a"),r=a._targetUrl;return e.href=r,e.href=e.href,e.origin||e.protocol+"//"+e.host}());var t={};t.resolve=e,t.reject=r,t.message=c,a.setData(c.handle,t,u)}catch(i){Promise.reject(S.checkAndCreate(i,g.POSTMESSAGE_INVALID_ORIGIN))}})},a.sendResponse=function(e,r){e.postMessage(JSON.stringify(r),"*")},a.processResult=function(e,r,t,n){var i=this.getData(e);if(this.setData(e,null),i===undefined)return y.log("request data not exist : "+e),!1;var o=i.reject||function(e){},c=i.resolve||function(e){};return t!==undefined&&0!==t.code?o(t):c(r),n!==undefined&&n(),!0},a.getNextHandle=function(){return t+=1},a.getData=function(e){return a[e]},a.setData=function(e,r,t){var n;t=t||l.POSTMESSAGE_TIMEOUT,null!==r?(a[e]=r,t!==undefined&&t<=0||(n=e,setTimeout(function(){var e=a.getData(n);e!==undefined&&(a.setData(n,null),e.reject(S.createByCode(g.IFRAME_POSTMESSAGE_FAIL)))},t))):delete a[e]},a;var a,t}var J,F={init:function(){},berryList:function(){PINsign.Logger.log("ServiceInterface : ")},issueList:function(){PINsign.Logger.log("ServiceInterface : ")},sign:function(){PINsign.Logger.log("ServiceInterface : ")},issueBerry:function(){PINsign.Logger.log("ServiceInterface : ")},renewBerry:function(){PINsign.Logger.log("ServiceInterface : ")},genBerryReq:function(){PINsign.Logger.log("ServiceInterface : ")},genRenewReq:function(){PINsign.Logger.log("ServiceInterface : ")},revokeBerry:function(){PINsign.Logger.log("ServiceInterface : ")},storeBerry:function(){PINsign.Logger.log("ServiceInterface : ")},updateBerry:function(){PINsign.Logger.log("ServiceInterface : ")},delBerry:function(){PINsign.Logger.log("ServiceInterface : ")},getBerry:function(){PINsign.Logger.log("ServiceInterface : ")},replaceBerry:function(){PINsign.Logger.log("ServiceInterface : ")},berryToConnectedData:function(){PINsign.Logger.log("ServiceInterface : ")},changePIN:function(){PINsign.Logger.log("ServiceInterface : ")},reloadServiceFrame:function(e){var r=O.getServiceFrame();null!==r&&r!==undefined?(r.onload=function(){e()},this._invoker=new j(PINsignConfig.OPEN_PINSIGN_SERVICE_URL),r.src=PINsignConfig.OPEN_PINSIGN_SERVICE_URL):e()}},H=((J=d.extend(f.create(F),{})).init=function(){F.init(),PINsignOnInitComplete()},J.issueList=function(e,r,t){var n=e.id,i=null;if(K.isEmptyString(t)){var o=te.Requester.getNonce();i=te.Client.requestEncryptedSecret(e,r,o)}else i=Promise.resolve(t);return i.then(function(e){return te.Client.sign(n,r,e,"for issued list",{})}).then(function(e){var r=e.signedData;return te.Client.issuedBerryList(r)})},J.berryToConnectedData=function(i,o,e){var r=i.id,t=te.Crypto.Util.getHashPin(o),n=te.Crypto.Util.getSharedPin(o),c={securePin:o,id2key:r,hashPin:t,sharedPin:n},u=null;if(K.isEmptyString(e)){var a=te.Requester.getNonce();u=te.Client.requestEncryptedSecret(i,o,a)}else u=Promise.resolve(e);return u.then(function(e){return c.encSecret=e,Promise.all([te.KeyStore.getKey(r),te.KeyStore.getBerry(r)])}).then(function(e){return c.keyInfo=e[0].key||e[0],c.berryInfo=e[1],_.decryptSecret(c.encSecret,c.securePin)}).then(function(e){return te.Crypto.Util.decryptSecretData(c.berryInfo.encryptedKey,c.keyInfo.cryptoKey,e)}).then(function(e){e=b64toutf8(e);var r=JSON.parse(e),t={berryInfo:i,keyInfo:r};c.rhex=te.Crypto.Util.getRandomHex(32);var n=z(c.rhex,o);return te.CryptoExternalCryptoJS.encryptAES(utf8tob64(JSON.stringify(t)),n)}).then(function(e){return c.rhex+e})},J.changePin=function(r,t,n,e){var i=null;if(K.isEmptyString(e)){var o=te.Requester.getNonce();i=te.Client.requestEncryptedSecret(r,t,o)}else i=Promise.resolve(e);return i.then(function(e){return te.Client.changePin(r,t,n,e)})},J.sign=function(e,r,t,n,i){var o=e.id,c=e.serialNumber,u=null;if(K.isEmptyString(i)){var a=te.Requester.getNonce();u=te.Client.requestEncryptedSecret(e,r,a)}else u=Promise.resolve(i);return u.then(function(e){return te.Client.sign(o,r,e,t,n)}).then(function(e){return O.setLastUsedPINsignInfo(o),e})["catch"](function(e){return!1===S.isID2Error(e)&&(e=S.toID2Error(e)),e.berry=e.berry||{id:o,serialNumber:c},Promise.reject(e)})},J.genBerryReq=function(e,r,t,n,i){return te.Client.genBerryReq(e,r,t,n,i)},J.genRenewReq=function(e,r){return te.Client.genRenewReq(e,r)},J.revokeBerry=function(e){return te.Client.revokeBerry(e)},J.updateBerry=function(e,r,t){return te.Client.updateBerry(e,r,t)},J.storeBerry=function(e,r,t){return te.Client.storeBerry(e,r,t).then(function(e){return e.id2key!==undefined&&O.setLastUsedPINsignInfo(e.id2key),e})},J.replaceBerry=function(e,r,t){return te.Client.replaceBerry(e,r,t)},J.getBerry=function(e){return te.KeyStore.load().then(function(){return te.KeyStore.getBerry(e)})},J.berryList=function(e){var t=(e=e||{detail:!0}).detail;return te.KeyStore.load().then(function(){return te.KeyStore.getBerryList(e)}).then(function(e){return e=O.markLastUsedPINsign(e),f.each(e,function(e){e.storeType=PINsign.STORETYPE_BROWSER})}).then(function(e){if(!0!==t)for(var r=0;r<e.length;r++)delete e[r].encryptedKey,delete e[r].issuer.iss;return e})["catch"](function(e){return Promise.reject(e)})},J.delBerry=function(r){return te.KeyStore.load().then(function(){return Promise.all([te.KeyStore.delBerry(r),te.KeyStore.delKey(r)]).then(function(e){return{code:g.SUCCESS,message:Y.getErrorMsg(g.SUCCESS,r)}})})},J.issueBerry=function(e){return te.Requester.issue(e)},J.renewBerry=function(e){return te.Requester.renew(e)},J),j=function(e){var a={};return a._reqStore=k(e,"service"),a._url=e,a.invoke=function(e,r){var t=O.getServiceFrame(),n={module:"PINService",cmd:e,data:r};return this._reqStore.invoke(t.contentWindow,n,-1)},a.processSuccess=function(e,r,t){this._reqStore.sendResponse(e,{handle:r,cmd:"result",data:t})},a.processError=function(e,r,t){this._reqStore.sendResponse(e,{handle:r,cmd:"result",error:{code:g.IFRAME_RECEIVE_FAIL,message:Y.getErrorMsg(g.IFRAME_RECEIVE_FAIL,t.toString())}})},a.processResult=function(e,r,t){return this._reqStore.processResult(e,r,t,function(){})},a.handleMessage=function(r){var e={};try{e="object"==typeof r.data?r.data:JSON.parse(r.data)}catch(u){y.debug("handleMessage : data parse error")}e.module;var t=e.cmd,n=e.handle,i=e.data,o=e.error;r.origin;if("result"!==t){if("function"==typeof H[t]){var c=[];return f.each(i,function(e,r,t){"securePin"!==r&&"newSecurePin"!==r||(e=new M(e)),c.push(e)}),H[t].apply(null,c).then(function(e){a.processSuccess(r.source,n,e)})["catch"](function(e){a.processError(r.source,n,e)})}}else a.processResult(n,i,o)},a},V=function(){var a=d.extend(f.create(F),{});function e(e){return a._invoker.handleMessage(e)}return a._url=PINsignConfig.OPEN_PINSIGN_SERVICE_URL,a._invoker=new j(a._url),a.init=function(){F.init();var e=document.createElement("iframe");e.onload=PINsignOnInitComplete||function(){},e.src=a._url,e.id="id2-service-frame",e.allowtransparency=!0,e.style.position="fixed",e.style.zIndex=100010,e.style.top="-10px",e.style.left="-10px",e.style.width="1px",e.style.height="1px",document.body.appendChild(e)},a.berryList=function(e){var t=(e=e||{detail:!0}).detail;return this._invoker.invoke("berryList",{options:e}).then(function(e){if(!0!==t)for(var r=0;r<e.length;r++)delete e[r].encryptedKey,delete e[r].issuer.iss;return e})["catch"](function(e){return Promise.reject(e)})},a.issueList=function(r,t,e){var n=te.Requester.getNonce();return te.Client.requestEncryptedSecret(r,t,n).then(function(e){return a._invoker.invoke("issueList",{berryInfo:r,securePin:t.exportData(),encSecret:e})})},a.berryToConnectedData=function(r,t,e){var n=te.Requester.getNonce(),i=r.id,o=r.serialNumber;return te.Client.requestEncryptedSecret(r,t,n).then(function(e){return a._invoker.invoke("berryToConnectedData",{berryInfo:r,securePin:t.exportData(),encSecret:e})}).then(function(e){return O.setLastUsedPINsignInfo(i),e})["catch"](function(e){return!1===S.isID2Error(e)&&(e=S.toID2Error(e)),e.berry=e.berry||{id:i,serialNumber:o},Promise.reject(e)})},a.sign=function(r,t,n,i,e){var o=te.Requester.getNonce(),c=r.id,u=r.serialNumber;return te.Client.requestEncryptedSecret(r,t,o).then(function(e){return a._invoker.invoke("sign",{berryInfo:r,securePin:t.exportData(),data:n,addHeader:i,encSecret:e})}).then(function(e){return O.setLastUsedPINsignInfo(c),e})["catch"](function(e){return!1===S.isID2Error(e)&&(e=S.toID2Error(e)),e.berry=e.berry||{id:c,serialNumber:u},Promise.reject(e)})},a.issueBerry=function(e){return te.Requester.issue(e)},a.renewBerry=function(e){return te.Requester.renew(e)},a.genBerryReq=function(e,r,t,n,i){return a._invoker.invoke("genBerryReq",{name:e,refValue:r,authCode:t,existSeed:n,securePin:i.exportData()})},a.genRenewReq=function(e,r){return a._invoker.invoke("genRenewReq",{id2key:e,securePin:r.exportData()})},a.revokeBerry=function(e){return a._invoker.invoke("revokeBerry",{berry:e})},a.storeBerry=function(e,r,t){return a._invoker.invoke("storeBerry",{name:e,securePin:r.exportData(),berry:t}).then(function(e){return e.id2key!==undefined&&O.setLastUsedPINsignInfo(e.id2key),e})},a.updateBerry=function(e,r,t){return a._invoker.invoke("updateBerry",{id2key:e,securePin:r.exportData(),berry:t})},a.delBerry=function(e){return a._invoker.invoke("delBerry",{id2key:e})},a.getBerry=function(e){return a._invoker.invoke("getBerry",{id2key:e})},a.replaceBerry=function(e,r,t){return a._invoker.invoke("replaceBerry",{id2key:e,securePin:r.exportData(),berry:t})},a.changePin=function(r,t,n,e){var i=te.Requester.getNonce();te.Client.requestEncryptedSecret(r,t,i).then(function(e){return a._invoker.invoke("changePin",{berryInfo:r,securePin:t.exportData(),newSecurePin:n.exportData(),encSecret:e})})},window.addEventListener?window.addEventListener("message",e,!1):window.attachEvent("onmessage",e),a}();window.PINsign.RemoteService=V;var W={BAtoHex:function(e){return BAtohex(e)}},M=function(e){var i={},a=null,s="";function o(){var e=CryptoJS.lib.WordArray.random(16),r=CryptoJS.enc.Hex.stringify(CryptoJS.lib.WordArray.random(16)),t=CryptoJS.enc.Hex.stringify(CryptoJS.PBKDF2("wizvera secure pin",e,{keySize:8,iterations:1024})),n=CryptoJS.enc.Hex.stringify(e);a={hexKey:t,hexIv:r,hexSalt:n}}var u=function(e){for(var r=[],t=0;t<e.sigBytes;t++){var n=e.words[t>>>2]>>>24-t%4*8&255;r.push(10*(n>>>4)+(15&n))}return r};function d(){if(s===undefined||""===s)return CryptoJS.enc.Utf8.parse("");try{var e=CryptoJS.enc.Hex.parse(a.hexIv),r=CryptoJS.enc.Hex.parse(a.hexKey);return CryptoJS.AES.decrypt(s,r,{iv:e})}catch(t){console.log("pin dec error : ",t)}return CryptoJS.enc.Utf8.parse("")}function n(e,r,t,n){for(var i=0;i<n;i++)if(e[t+i]!==r[i])return!1;return!0}function f(e,r){if(e!==undefined&&e.length<=0)return!1;if(r!==undefined&&r.length<=0)return!1;if(e.length<r.length)return!1;for(var t=0;t<=e.length-r.length;t++)if(!0===n(e,r,t,r.length))return!0;return!1}return i.getPrependData=function(e){var r=CryptoJS.enc.Utf8.parse(e),t=d();r.concat(t);var n=r.toString();return r.init(),t.init(),n},i.getAppendData=function(e){var r=CryptoJS.enc.Utf8.parse(e),t=d();t.concat(r);var n=r.toString();return r.init(),t.init(),n},i.setDataPIN=function(e){try{null===a&&o();var r=CryptoJS.enc.Hex.parse(a.hexIv),t=CryptoJS.enc.Hex.parse(a.hexKey);s=CryptoJS.AES.encrypt(e,t,{iv:r}).toString(),e.init()}catch(n){s=""}return this},i.setPIN=function(e){return i.setDataPIN(CryptoJS.enc.Utf8.parse(e))},i.getHashedPIN=function(e,r){e=e||l.PREFIX_HASHPIN,r=r||128;var t=d(),n=CryptoJS.enc.Utf8.parse(e);n.concat(t);for(var i=n,o=0;o<r;o++)i=CryptoJS.SHA256(i);var c=i.toString();return t.init(),n.init(),hextob64u(c)},i.customValidityCheck=function(e,r){r&&y.debug("check pattern list : ",e);for(var t=d(),n=u(t),i=!0,o=0;o<e.length;o++){var c=CryptoJS.enc.Utf8.parse(e[o]);if(!0===f(n,u(c))){i=!1,r&&y.debug("find invalid pattern  : ",e[o]);break}}return t.init(),n.fill(0,0,n.length),i},i.defaultValidityCheck=function(e){var r,t,n=[];for(t=0;t<10;t++)r=Array(4).join(t.toString()),n.push(r);for(t=1;t<8;t++)r=[t%10,(t+1)%10,(t+2)%10].join(""),n.push(r);return e&&y.debug("check list : ",n),i.customValidityCheck(n,e)},i.exportData=function(){var e=JSON.stringify({i:a.hexIv,s:a.hexSalt,d:s}),r=CryptoJS.lib.WordArray.random(32),t=CryptoJS.enc.Hex.stringify(r),n=CryptoJS.AES.encrypt(e,r,{iv:r}).toString();return utf8tob64(t+n)},i.importData=function(e){var r=(e=b64toutf8(e)).substring(0,64),t=e.substring(r.length,e.length),n=CryptoJS.enc.Hex.parse(r),i=CryptoJS.AES.decrypt(t,n,{iv:n}).toString();i=hextoutf8(i);var o=(i=JSON.parse(i)).i,c=i.s;s=i.d;var u=CryptoJS.enc.Hex.stringify(CryptoJS.PBKDF2("wizvera secure pin",CryptoJS.enc.Hex.parse(c),{keySize:8,iterations:1024}));return a={hexIv:o,hexSalt:c,hexKey:u},this},i.isEqualPIN=function(e){try{return i.getHashedPIN(l.PREFIX_HASHPIN,128)===e.getHashedPIN(l.PREFIX_HASHPIN,128)}catch(r){}return!1},i.getLength=function(){var e=d(),r=e.sigBytes;return e.init(),r},e!==undefined?i.importData(e):o(),i},q=function(){var e=CryptoJS.lib.WordArray.random(16),r=CryptoJS.enc.Hex.stringify(CryptoJS.lib.WordArray.random(16)),o={hexKey:CryptoJS.enc.Hex.stringify(CryptoJS.PBKDF2("wizvera secure store",e,{keySize:8,iterations:512})),hexIv:r},c="",t={};function u(){if(""===c)return"";var e=CryptoJS.enc.Hex.parse(o.hexIv),r=CryptoJS.enc.Hex.parse(o.hexKey);return CryptoJS.AES.decrypt(c,r,{iv:e})}return t.clearData=function(){c=""},t.deleteLastOne=function(){if(""===c)return this;var e=u(),r=e.toString(CryptoJS.enc.Hex);if(0===r.length)return this;r=r.substring(0,r.length-2);var t=CryptoJS.enc.Hex.parse(r),n=CryptoJS.enc.Hex.parse(o.hexIv),i=CryptoJS.enc.Hex.parse(o.hexKey);return c=CryptoJS.AES.encrypt(t,i,{iv:n}).toString(),t.init(),e.init(),this},t.appendData=function(e){var r=CryptoJS.enc.Utf8.parse("");""!==c&&(r=u());var t=CryptoJS.enc.Utf8.parse(e);r.concat(t);var n=CryptoJS.enc.Hex.parse(o.hexIv),i=CryptoJS.enc.Hex.parse(o.hexKey);return c=CryptoJS.AES.encrypt(r,i,{iv:n}).toString(),t.init(),r.init(),this},t.getLength=function(){return""===c?0:u().sigBytes},t.getSecurePIN=function(){var e=new M;return e.setDataPIN(u()),e},t},Y=function(){var e={},c={},u={};c["default"]={},u["default"]={};var n=PINsignConfig.DETAIL_ERROR_MESSAGE===undefined||PINsignConfig.DETAIL_ERROR_MESSAGE;c["default"][g.SUCCESS]="성공",c["default"][g.CANCEL]="취소",c["default"][g.AJAX_FAIL]="Ajax통신중 오류가 발생 했습니다.",c["default"][g.IFRAME_POSTMESSAGE_FAIL]="PostMessage 오류 발생",c["default"][g.BERRY_NOT_EXIST]="BERRY가 존재하지 않습니다.",c["default"][g.ENCKEY_DECRYPT_FAIL]="암호화 키를 복호화 하는데 실패했습니다.",c["default"][g.SECRET_DECRYPT_FAIL]="Secret을 복호화 하는데 실패했습니다.",c["default"][g.SECRET_DATA_DECRYPT_FAIL]="Secret 데이터 복호화 중 오류가 발생했습니다.",c["default"][g.SECRET_DATA_ENCRYPT_FAIL]="Secret 데이터 암호화 중 오류가 발생했습니다.",c["default"][g.AES_KEYGEN_FAIL]="AES키 생성중 오류가 발생했습니다.",c["default"][g.AES_ENC_FAIL]="AES 암호화 중 오류가 발생했습니다.",c["default"][g.AES_DEC_FAIL]="AES 복호화 중 오류가 발생했습니다.",c["default"][g.RSA_KEYGEN_FAIL]="RSA키 생성중 오류가 발생했습니다.",c["default"][g.INDEXEDDB_EXEC_FAIL]="IndexedDB 명령 실행 오류.",c["default"][g.INDEXEDDB_INVALID_CMD]="잘못된 IndexedDB 실행 명령을 실행했습니다.",c["default"][g.INDEXEDDB_RETURN_ERROR]="IndexedDB로 부터 잘못된 데이터를 받았습니다.",c["default"][g.INDEXEDDB_OPEN_FAIL]="IndexedDB를 열수 없습니다.",c["default"][g.INDEXEDDB_FP_SAVE_FAIL]="IndexedDB에 클라이언트 고유정보를 저장할수 없습니다.",c["default"][g.IFRAME_RECEIVE_FAIL]="서비스 Frame으로부터 데이터를 받을 받지 못했습니다.",c["default"][g.REQUEST_NONCE_FAIL]="Nonec 요청중 오류가 발생했습니다.",c["default"][g.JWS_PARSE_ERROR]="JWS 파싱중 오류가 발생했습니다.",c["default"][g.REVOKE_FAIL]="폐기중 오류가 발생했습니다.",c["default"][g.POSTMESSAGE_INVALID_ORIGIN]="설정되지 않은 도메인으로 postMessage가 요청되었습니다.",c["default"][g.UNKNOWN_ERROR]="알수 없는 오류가 발생했습니다.",c["default"][g.PIN_VALITITY_FAIL]="동일한 숫자가 3자리 이상 되거나, 연속된 숫자가 3자리 이상되는 PIN은 사용할수 없습니다.",c["default"][g.SERVER_ERROR_BASE]="서버에서 오류 응답을 받았습니다.",c["default"][13188]=c["default"][13174]=c["default"][10864]=c["default"][10417]="PIN번호가 일치하지 않습니다 (남은 회수 <%= pinRetryCount %>회)",u["default"][13188]=u["default"][13174]=u["default"][10864]=u["default"][10417]="PIN번호가 일치하지 않습니다 (남은 회수 <%= pinRetryCount %>회) \n남은 회수가 0이 되면 현재 PINsing인증서는 사용할수 없습니다.",c["default"][13187]=c["default"][13184]=c["default"][13185]=c["default"][13186]=c["default"][10438]="브라우저에 저장된 PIN인증서는 삭제되며 본인인증 및 PIN초기화 후 신규발급을 하시기 바랍니다.",c["default"][10438]="PIN인증서가 잠겼습니다. 잠김 해제 또는 재등록또는 재발급 하시기 바랍니다.",c.kor=d.extend({},c["default"],{}),u.kor=d.extend({},u["default"],{});var a="kor";function s(e){return c[a]!==undefined?c[a][e]:c["default"][e]}return e.addLang=function(e,r,t){r!==undefined&&(c[e]=d.extend({},c["default"],r)),u!==undefined&&(u[e]=d.extend({},c["default"],t))},e.setLang=function(e){c[e]!==undefined&&(a=e)},e.getServerErrorMsg=function(e,r){var t="";try{if(e===undefined)return s(g.SERVER_ERROR_BASE);var n=e.code;t=s(n);try{r!==undefined&&r(e)&&(t=function i(e){return c[a]!==undefined?u[a][e]:c["default"][e]}(n))}catch(o){console.log("warn message not exist : ",e)}if(t===undefined)t=e.message||"no message";else t=f.template(t)(e)}catch(o){t=t||JSON.stringify(e)}return e.pinRetryCount!==undefined&&(t=t.replace("#pinRetryCount#",e.pinRetryCount)),e.maxPinRetryCount!==undefined&&(t=t.replace("#maxPinRetryCount#",e.maxPinRetryCount)),t},e.getErrorMsg=function(e,r){"string"!=typeof r&&(r=JSON.stringify(r));var t=s(e)||"no message";return t+="[PINsign-"+e+"]",r!==undefined&&!0===n&&(t+="\r\n",t+=r),t},e}(),X=function(){var t=[];t["default"]={"w2uiAlert.yesStr":"네","w2uiAlert.noStr":"아니오","w2uiAlert.okStr":"확인","msg.ok":"확인","msg.name":"이름","msg.phone":"전화번호","msg.issue_date":"최종 발급일","msg.issue_pinsign":"발급 받기","msg.pin_number":"PIN 번호","msg.input_pin_number":"PIN 번호 입력","msg.use_pinsign_cert":"사용하기 편리한 PINsign인증서를 사용하세요.","msg.connected":"커넥티드","msg.date":"날짜","msg.show_more":"더보기","msg.delete":"삭제","msg.change_pin":"핀변경","msg.issue_status":"발급현황","msg.connect_connected":"커넥티드 연결","msg.select_user":"사용자를 선택해 주세요","msg.issue_new_pinsign":"신규 PINsign 인증서 발급","msg.connected_safe":"커넥티드는 인증서 이동없이 어디서나 안전하게 사용 할 수 있습니다.","msg.show_detail":"자세히 보기","msg.start_connected":"커넥티드를 시작해주세요.","msg.authcode":"확인코드","msg.connected_connected":"커넥티드에 연결되었습니다.","msg.when_login_save_connected":"인증서 제출시 제출된 인증서가 커넥티드에 저장됩니다.","msg.can_save_to_connected":"* 커넥티드 저장 이이콘","msg.can_save_to_connected2":")을 이용하여 커넥티드에 저장 할 수 있습니다.","msg.check_authcode":"* 문자를 받으면 링크를 눌러 모바일 웹 화면에서 확인코드를 입력하세요","msg.input_6_length_new_pin":"사용할 6자리 신규 PIN번호를 입력하세요","msg.input_pin":"PIN번호 입력","msg.input_pin_please":"PIN번호를 입력하세요.","msg.input_pin_retry":"PIN번호 재입력","msg.input_change_pin":"변경할 PIN을 입력하세요.","msg.input_cur_pin":"현재 PIN","msg.input_new_pin":"새로운 PIN","msg.input_new_pin2":"새로운 PIN 확인","msg.revoke":"폐기","msg.stop_connected":"커넥티드 사용중지","msg.pinpad_reset":"재배열","msg.pinpad_clear":"지우기","msg.issue_new":"신규 발급","msg.issue_add":"추가 발급"},t.kor=d.extend({},t["default"]);var n={_lang:"kor",_str:t.kor,setLang:function(e){t[e]!==undefined&&(this._lang=e,this._str=t[e])},addLang:function(e,r){t[e]=d.extend({},t["default"],r),n._lang===e&&(n._str=t[e])},get:function(e){try{return n._str[e]}catch(r){return"none"}}};return n}(),G=function(e){var r={},o=e;function c(){var e=localStorage.getItem(o);return null===e||""===e?{}:JSON.parse(e)}return r.getData=function(e,r){return c()[e]||r},r.setData=function(e,r){var t=c(),n=t[e];return t[e]=r,function i(e){localStorage.setItem(o,JSON.stringify(e))}(t),n},r};function z(e,r){r.getPrependData(e);var t=te.Crypto.Util.getHashPin(r),n=te.Crypto.Util.getSharedPin(r);return te.Crypto.Util.AES256KeyFromString(t+n)}var Q,Z,$,ee=(Q=window,Z={},$=new G("PINsign.Connected.Props"),Z.setCurrentStatus=function(e){return $.setData("currentStatusOn",e)},Z.getCurrentStatus=function(){return!1===this.isRegistered()?(this.setCurrentStatus(!1),!1):$.getData("currentStatusOn",!1)},Z.isRemember=function(){return $.getData("isRemember",!1)},Z.setRemember=function(){return $.setData("isRemember",!0)},Z.clearRemember=function(){return $.setData("isRemember",!1)},Z.unRegister=function(){var e="CONNECTEDID";localStorage.setItem(e,""),sessionStorage.setItem(e,"")},Z.isRegistered=function(){try{if(!this.check())throw Error("not exist connected");var e=wizvera.cloudUtil.getPubkId();return!K.isEmptyString(e)}catch(r){return PINsign.Logger.log("Connected Adapter Exception : ",r),!1}},Z.connect=function(e,r){return Promise.resolve(!0)},Z.connInfoToBerryInfo=function(e){return Promise.resolve(!0)},Z.getInfo=function(){return Promise.resolve(!0)},Z.getData=function(e){return Promise.resolve(!0)},Z.isEnable=function(){return!1},Z.decryptConnectedData=function(e,r){var t=e.substr(0,64),n=e.substr(64),i=z(t,r);return te.CryptoExternalCryptoJS.decryptAES(n,i)},Z.uploadBerry=function(t,n){try{if(!this.check())throw Error("not exist connected");var r=te.Requester.getNonce(),i={};return i.nonce=r,PINsign.Service.getBerry(t).then(function(e){return i.berryInfo=e,te.Client.requestEncryptedSecret(e,n,r)}).then(function(e){return i.encSecret=e,te.Client.decryptSecret(e,n)}).then(function(e){return i.decSecret=e,PINsign.Service.berryToConnectedData(i.berryInfo,n,i.encSecret)}).then(function(e){return i.encData=e,Z.connectedLogin()}).then(function(){var e={},r=i.berryInfo;e.fingerprint=PINsign.Crypto.Util.sha256((r.issuer.profile||"")+r.issuer.issuerSubject+r.issuer.uid,128).substr(0,40),e.berry=r.berry;var t=(new M).setPIN(n.getAppendData(i.decSecret));return wizvera.mainServer.upload(PINsignConfig.CONNECTED_SERVER_LIST,e,i.encData,te.Crypto.Util.getHashPin(t))}).then(function(e){return te.Logger.log("upload result : ",e),e.error===undefined?new Promise(function(r,e){PINsign.remove(t,function(e){e.error,undefined,r(e)})}):e})}catch(e){return PINsign.Logger.log("Connected Adapter Exception : ",e),Promise.resolve(!0)}},Z.download=function(e,t,n){try{if(!this.check())throw Error("not exist connected");var r=te.Requester.getNonce(),i={};return te.Client.requestEncryptedSecret(e,t,r).then(function(e){return i.encSecret=e,te.Client.decryptSecret(e,t)}).then(function(e){i.decSecret=e;var r=(new M).setPIN(t.getAppendData(i.decSecret));return wizvera.mainServer.download(PINsignConfig.CONNECTED_SERVER_LIST,n,te.Crypto.Util.getHashPin(r))}).then(function(e){return te.Logger.debug("receive data : ",e),Z.decryptConnectedData(e,t)}).then(function(e){return te.Logger.debug("decrypted data : ",e),e})["catch"](function(e){return te.Logger.log("error : ",e),Promise.reject(e)})}catch(o){return PINsign.Logger.log("Connected Adapter Exception : ",o),Promise.resolve("")}},Z.remove=function(r){try{if(!this.check())throw Error("not exist connected");return wizvera.mainServer.deleteCertInfo("server1,server2",r).then(function(e){return console.log("delete success "+r,e),!0})["catch"](function(e){console.log("delete failed",e)})}catch(e){return PINsign.Logger.log("Connected Adapter Exception : ",e),Promise.resolve("")}},Z.registerRequest=function(e,r,t,n){try{if(!this.check())throw Error("not exist connected");return!0===t?($.setData("name",r),$.setData("phone",e)):($.setData("name",""),$.setData("phone","")),wizvera.mainServer.registerRequest(e,r,t,n)}catch(i){return Promise.resolve(!0)}},Z.registerStatus=function(e,r){try{if(!this.check())throw Error("not exist connected");return wizvera.mainServer.registerStatus(e,r)}catch(t){return PINsign.Logger.log("Connected Adapter Exception : ",t),Promise.resolve(!0)}},Z.renew=function(e,c){var u={};return u.berryInfo=e.berryInfo,u.keyInfo=e.keyInfo,te.Client._genBerryRequest(u.berryInfo.subject,c,!0).then(function(e){if(e.error!==undefined)return Promise.reject(e);var r=e.berryReq,t=JSON.stringify({req:r});return u.newKeyInfo={keyPair:e.keyPair},te.Crypto.Util.makeLoginData(t,{cty:"BERRY RENEW"},u.keyInfo,u.berryInfo)}).then(function(e){var r=te.Crypto.Util.getHashPin(c),t={action:"renew",berryRenew:e.signedData,hashPin:r};return PINsign.Service.renewBerry(t)}).then(function(e){return{pinSecret:(u.newBerryResult=e).pinSecret,berrySecret:e.berrySecret}}).then(function(e){return u.encSecret=e,te.Client.decryptSecret(e,c)}).then(function(e){u.decSecret=e;var r=u.newBerryResult.berry,t=PINsign.Util.jwsToBerryInfo(r);t.berry=r,t.storeType=PINsign.STORETYPE_CONNECTED,u.newBerryInfo=t,u.newKeyInfo.vidRandom=u.newBerryResult.vidRandom||"",u.newKeyInfo.svidRandom=u.newBerryResult.svidRandom||"";var n={berryInfo:t,keyInfo:u.newKeyInfo};u.rhex=te.Crypto.Util.getRandomHex(32);var i=z(u.rhex,c),o=utf8tob64(JSON.stringify(n));return u.connRawData=o,te.CryptoExternalCryptoJS.encryptAES(o,i)}).then(function(e){return u.connDataForUpload=u.rhex+e,Z.connectedLogin()}).then(function(){var e={},r=u.newBerryInfo;e.fingerprint=PINsign.Crypto.Util.sha256(r.issuer.issuerSubject+r.issuer.uid,128).substr(0,40),e.berry=r.berry,r.fingerprint=e.fingerprint,u.newBerryInfo=r;var t=(new M).setPIN(c.getAppendData(u.decSecret));return wizvera.mainServer.upload(PINsignConfig.CONNECTED_SERVER_LIST,e,u.connDataForUpload,te.Crypto.Util.getHashPin(t))}).then(function(e){return te.Logger.log("upload result : ",e),{connData:u.connRawData}})},Z.login=function(e,r,t,n,i){(i=i||{}).autoRenew=!0,Z.sign(e,r,t,n,i)},Z.sign=function(r,n,i,t,o){o.autoRenew===undefined&&(o.autoRenew=!1);var c=new U("sign");c.start(),PINsign.list({}).then(function(e){return f.find(e,function(e){return!(e.id!==r||!PINsign.Util.isConnectedStoreType(e.storeType))})}).then(function(e){var r=e.fingerprint;return PINsign.Util.setLastUsedPINsignInfo(e.id,PINsign.STORETYPE_CONNECTED),PINsign.ConnAdapter.download(e,n,r)}).then(function(e){var r=JSON.parse(b64toutf8(e)),t=r.berryInfo.issueDate;return!0===o.autoRenew&&!0===PINsign.Util.needRenew(t)?Z.renew(r,n).then(function(e){return e.connData}):e}).then(function(e){var r=JSON.parse(b64toutf8(e)),t=r.keyInfo,n=te.Util.makeAddHeader();return PINsign.Crypto.Util.makeLoginData(i,n,t,r.berryInfo)}).then(function(e){return c.finish(),t({data:e})})["catch"](function(e){var r=te.ID2Error.checkAndCreate(e,g.CONNECTED_ERROR);return t({error:r}),Promise.resolve(!0)})},Z.connectedLogin=function(){try{if(!this.check())throw Error("not exist connected");var t={};return wizvera.connectedHelper.generateServerInfo(PINsignConfig.CONNECTED_SERVER_LIST),wizvera.mainServer.loginRequest().then(function(e){te.Logger.log("mainserver login Success",e),t.certInfos=e.certInfos;var r=f.map(wizvera.saveServer,function(e){return e.loginRequest().then(function(e,r){te.Logger.log("server-"+r+" login Success",e)})});return Promise.all(r).then(function(e){return PINsign.Logger.log("all server login success : ",t),t})["catch"](function(e){return Promise.reject("Connected Login Fail : "+e.message||JSON.stringify(e))})})["catch"](function(e){return alert(e.message||JSON.stringify(e)),Promise.reject(e)})}catch(e){return Promise.resolve(!0)}},Z.getLastRegisterData=function(){return{name:$.getData("name",""),phone:$.getData("phone","")}},Z.check=function(){return!1!==PINsignConfig.USE_CONNECTED&&(Q.wizvera!==undefined&&wizvera.cloudUtil!==undefined&&wizvera.mainServer!==undefined||(console.log("connected not defined"),PINsignConfig.USE_CONNECTED=!1),PINsignConfig.USE_CONNECTED)},Z.berryList=function(e){return PINsign.ConnAdapter.isRegistered()&&!0===PINsign.ConnAdapter.getCurrentStatus()&&!0===PINsignConfig.USE_CONNECTED?PINsign.ConnAdapter.connectedLogin().then(function(e){return f.map(e.certInfos,function(e){var r=e.certInfo.berry,t=PINsign.Util.jwsToBerryInfo(r);return t.berry=r,t.storeType=PINsign.STORETYPE_CONNECTED,t.fingerprint=e.certInfo.fingerprint,t})})["catch"](function(e){return PINsign.Logger.log("Connected login fail : ",e),PINsign.ConnAdapter.setCurrentStatus(!1),Promise.resolve([])}):Promise.resolve([])},bowser.msie!==undefined&&!0===bowser.msie&&parseInt(bowser.version)<11&&(PINsignConfig.USE_CONNECTED=!1),Z),re={hexToArrayBuffer:function(e){return new Uint8Array(hextoArrayBuffer(e))},base64UrlEncode:function(e){return b64tob64u(e)},base64UrlDecode:function(e){return b64utob64(e)},TextEncoder:function(e){return new Uint8Array(hextoArrayBuffer(utf8tohex(e)))},textDecode:function(e){var r=BAtohex(new Uint8Array(e));return hextoutf8(r)},textEncode:function(e){var r=hextoArrayBuffer(utf8tohex(e));return new Uint8Array(r)},base64ToArrayBuffer:function(e){return new Uint8Array(b64toBA(e))},arrayBufferToBase64:function(e){var r=new Uint8Array(e);return hextob64(BAtohex(r))},removeJwk:function(e){var r={};return r.kty=e.kty,r.n=e.n,r.e=e.e,r}};e.wizvera=e.wizvera||{},e.wizvera.kryptos=e.wizvera.kryptos||{},e.wizvera.kryptos.pinsign_connected_util=re;var te={};function ne(r){if(!0!==PINsignConfig.USE_UI_SERVICE&&!(0<d("#pinsign-ui-main",d(r)).length)){var t=window.id2_build_version||function(){return"0.0.0"},e=PINsignConfig.UI_SERVICE_URL;!0===PINsign.Util.isMobile()&&(e=PINsign.Util.appendQueryString(e,"uiType=mobile")),d.ajax({url:e,async:!1,method:"GET",success:function(e){d(r).append(e),d(".pinsign-product-version").text("PINsign Ver "+t())},error:function(e){y.debug("pinsignui contents load fail "+e.toString())}})}}!function ie(e){(te={}).Util=O,te.Config=l,te.Requester=m,te.Client=_,te.ErrorCode=g,te.ID2Error=S,te.Service=PINsignConfig.useOpenService()?V:H,te.BerryFilter=D,te.Encoder=W,te.SecureString=q,te.SecurePIN=M,te.ErrorMsg=Y,te.ResourceString=X,te.ErrorCode=g,te.Logger=y,te.PublicUtil=T,te.getRequestStore=k,te.ValueUtil=K,te.ConnAdapter=ee,te.WebStorageHelper=G,te.CryptoExternalCryptoJS=te.CryptoExternalCryptoJS||B,te.CryptoWebCrypto=w,te.SecretDecrypto=N,te.Crypto=te.Crypto||w,te.KeyStore=te.KeyStore||x,(bowser===undefined||!0!==bowser.ios&&!0!==bowser.safari&&!0!==bowser.msie)&&"https:"===location.protocol||(te.Crypto=B,te.KeyStore=L),n!==undefined&&n.subtle!==undefined&&n.subtle.generateKey!==undefined||(te.Crypto=B,te.KeyStore=L),te.Crypto.Util=b,te.Crypto.JWS=A,te.LocalService=H,e.PINsign=(r={},r._=f,r.Service=te.Service,r.SecureString=te.SecureString,r.SecurePIN=te.SecurePIN,r.getRequestStore=te.getRequestStore,r.ID2Error=te.ID2Error,r.ErrorCode=te.ErrorCode,r.Util=te.PublicUtil,r.ValueUtil=te.ValueUtil,r.Logger={},r.Logger.log=te.Logger.log,r.ConnAdapter=te.ConnAdapter,r.BerryFilter=te.BerryFilter,r.Requester=te.Requester,r.Crypto={},r.Crypto.Util=b,r.Crypto.Util.sha256=te.Crypto.Util.sha256,r.STORETYPE_CONNECTED="connected",r.STORETYPE_BROWSER="browser",r),e.PINsignMsg=te.ErrorMsg,e.PINsignResource=te.ResourceString,e.ID2=e.PINsign;var r}(e),e.PINsign.loadUI=ne,e.PINsign.init=function(){ne("body"),window.addEventListener!==undefined&&(window.PINsignStorageTimeStamp=PINsign.Util.getTimeStamp(),window.addEventListener("storage",function(e){try{e.key===ID2Config.KEYSTORENAME&&e.srcElement.PINsignStorageTimeStamp!==window.PINsignStorageTimeStamp&&y.log("PINsign localStorage updated")}catch(r){}}),localStorage.setItem("pinsign_timestamp",window.PINsignStorageTimeStamp)),PINsign.Service.init()}}(window,jQuery,window.pinsignus||_,window.crypto||window.msCrypto),window.PINsignProgressFinish=window.PINsignProgressFinish||function e(){jQuery("#id2_overlay").remove()},window.PINsignProgressStart=window.PINsignProgressStart||function i(e){if(!(null!==jQuery("#id2_overlay")&&0<jQuery("#id2_overlay").length)){var r=PINsignConfig.PROGRESS_IMAGE_URL,t=document,n='<div id="id2_overlay" style="z-index:100000;position:fixed; width:100%; height:100%; top:0px; left:0px; background-color: #000000; opacity: 0.3; filter: alpha(opacity=30);">';e&&r?n+='<div style="z-index:100001;position:fixed;top:50%; height:100%;width:100%;"><div style="margin: 0 auto; padding: 5px; width:150px; background-color:#fff; vertical-align:middle; font-weight:bold; text-align: center; color:#555;  border-radius:5px;">'+e+' <img src="'+r+'" style="vertical-align:middle"/></div></div>':r&&(n+='<div style="z-index:100001;position:fixed;top:50%; height:100%;width:100%;"><div style="margin: 0 auto; padding: 5px; width:26px; height:26px;  background-color:#fff; vertical-align:middle; font-weight:bold; text-align: center; color:#555;  border-radius:5px;"> <img src="'+r+'" style="vertical-align:middle"/></div></div>'),n+="</div>",jQuery("body",t).append(n)}},window.PINsignOnInitComplete=window.PINsignOnInitComplete||function r(){PINsign.Logger.log("default oninit callback")},window.Promise=window.Promise||Promise;try{window.console===undefined&&(window.console=window.console||{},window.console.log=window.console.log||function(){}),window.localStorage===undefined&&(window.localStorage=window.localStorage||{},window.localStorage.getItem=window.localStorage.getItem||function(){},window.localStorage.setItem=window.localStorage.setItem||function(){})}catch(t){}}();
!function(n,i){"use strict";jQuery;n.PINsignUI={},n.PINsignUI.getDummyData=function e(){return{data:[{id:"67c12127b1f3056182e5639ad41c44b9f6fe2cbd561df2cbd6e8e33253428a5c",subject:"soohyun-001",serialNumber:160,expireDate:1522853999,issueDate:1522714358,lastUsed:!0,issuer:{subject:"김수현",uid:"test",expireDate:1553612399,issueDate:1522058966,serialNumber:74,issuerSubject:"ROK_BANK1"}},{id:"9ae0054115733a411eeece8ef93f7deac59e9beb52c586326c2dc2896ff9b7eb",subject:"테스3-test3-test",serialNumber:161,expireDate:1522853999,issueDate:1522714396,issuer:{subject:"테스3",uid:"test3",expireDate:1553353199,issueDate:1521787635,serialNumber:66,issuerSubject:"ROK_BANK1"}},{id:"306538c886198b44e2174525087251a3a5bd6d6ab2a88eab613951af42cba82d",subject:"테스트1-test1-test",serialNumber:162,expireDate:1522853999,issueDate:1522714413,issuer:{subject:"테스트1",uid:"test1",expireDate:1553612399,issueDate:1522058831,serialNumber:73,issuerSubject:"ROK_BANK1"}},{id:"306538c886198b44e2174525087251a3a5bd6d6ab2a88eab613951af42cba822",subject:"테스트1-test1-test",serialNumber:162,expireDate:1522853999,issueDate:1522714413,issuer:{subject:"테스트1",uid:"test1",expireDate:1553612399,issueDate:1522058831,serialNumber:73,issuerSubject:"ROK_BANK1"}}]}},n.PINsignUI.isDummyTest=function(){return-1!=location.search.indexOf("dummy_test")}}(window),function(n,i,e){"use strict";var t,o,a,s,c,r,l,d,u,p,g,f,_,m=i,h=e,I={_context$:undefined,_selector:undefined,_w2popup:undefined,_w2popup$:undefined,_html:undefined,_options:{popup:!1},updateTextResource:function(n,i){var e=this._$();m(n,e).text(PINsignResource.get(i))},updateAttrResource:function(n,i,e){var t=this._$();m(n,t).attr(e,PINsignResource.get(i))},connectDefaultCloseEvent:function(i){var e=this,n=e._$(),t=m(".pinsign-close-button",n);m(".w2ui-msg-close",n).unbind("click").on("click",function(n){i(n,e)}),t.unbind("click").on("click",function(n){i(n,e)})},getCancelResult:function(){return{error:{code:PINsign.ErrorCode.CANCEL,message:"cancel"}}},getOkResult:function(){return{code:PINsign.ErrorCode.SUCCESS}},getIssueResult:function(){return{error:{code:PINsign.ErrorCode.ISSUE,message:"issue"}}},_$:function(n){var i=this._w2popup$;return this._w2popup$===undefined&&(i=this._context$),n!==undefined&&(i=m(n,i)),i},switchPage:function(n){this._pages.length<=0||n>=this._pages.length||(m.each(this._pages$,function(n,i){i.hide()}),this.v_pageChanged(n),this._pages$[n].fadeIn())},v_pageChanged:function(n){},initPage:function(){if(0===m(".pinsign-page",this._$()).length)return this._pages=[],void(this._pages$=[]);var n=m(".pinsign-page",this._$()),e=[];m.each(n,function(n,i){e.push(m(i))}),this._pages=n,this._pages$=e,this._pages$[0].show();for(var i=1;i<this._pages$.length;i++)this._pages$[i].hide()},isPopup:function(){return this._options.popup},init:function(n,i){this.clearPopup(),this._context$===undefined&&(this._context$=m(this._selector),this._context$.detach(),this._options=m.extend(this._options,n),this._complete_cb=i||this._complete_cb||function(){PINsign.Logger.log("default complete callback")}),this._context$.show()},getOptions:function(){var n={};return n.body=this._context$.wrap("<div/>").parent().html(),n.width=550,n.height=410,n.title="",n.modal=!0,n.embed=!1,n.opacity=.4,n},makePopup:function(n,i,e){n.onOpen=i,this._w2popup=this._context$.w2popup(n),e!==undefined&&this._w2popup.on({type:"open",execute:"after",target:null,onComplete:null},e),this._w2popup$=m("#w2ui-popup"+this._w2popup._id)},clearPopup:function(n){this._w2popup!==undefined&&(this._w2popup.on({type:"close",execute:"after",target:null,onComplete:null},n||function(){}),this._w2popup.close(),this._w2popup=undefined,this._w2popup$=undefined)},hideDialog:function(n){this.v_BeforeClose(n),this.clearPopup(this.v_AfterClose,n)},showDialog:function(){this.v_Init.apply(this,arguments),this.init(this._options,this._complete_cb),this._context$.show(),m(".pinsign-body",this._context$).show();var n=window.id2_build_version||function(){return"0.0.0"};m(".pinsign-product-version",this._context$).text("PINsign Ver "+n()),this.v_InitState();var i=this.v_GetPopupOptions(this.getOptions()),e=this;this.makePopup.call(this,i,function t(){e.v_BeforeOpen()},function o(){e.v_InitEvent(),e.v_InitPINPad(),e.v_InitData(),e.v_SetResource(),e.v_AfterOpen()})},v_Init:function(){PINsign.Logger.log("call BaseDialog v_Init")},v_SetResource:function(){PINsign.Logger.log("call BaseDialog v_SetResource")},v_GetPopupOptions:function(n){return PINsign.Logger.log("call BaseDialog v_GetPopupOptions"),n},v_InitEvent:function(){PINsign.Logger.log("call BaseDialog v_InitEvent")},v_InitState:function(){PINsign.Logger.log("call BaseDialog v_InitState")},v_InitPINPad:function(){PINsign.Logger.log("call BaseDialog v_InitPINPad")},v_InitData:function(){PINsign.Logger.log("call BaseDialog v_InitData")},v_AfterOpen:function(){PINsign.Logger.log("call BaseDialog v_AfterOpen")},v_BeforeOpen:function(){PINsign.Logger.log("call BaseDialog v_BeforeOpen")},v_BeforeClose:function(n){PINsign.Logger.log("call BaseDialog v_BeforeClose"),n!==undefined&&this._complete_cb!==undefined&&this._complete_cb(n)},v_AfterClose:function(){PINsign.Logger.log("call BaseDialog v_AfterClose")}},P={createItem:function(n,i){var e=(i=i||m(".pinsign-select-item-template")).clone(),t=m(e);t.removeClass("pinsign-select-item-template");var o=PINsign.Util.timestampToString(n.issueDate);m(".pinsign-item-info-name",t).data("pinsign-id",n.id),m(".pinsign-item-info-name",t).text(n.issuer.subject),m(".pinsign-item-info-detail",t).text(n.subject),m(".pinsign-item-date-issue",t).text(o);var s=n.issuer.profile||"0",a=PINsign.Util.toReadableProfileName(s),c=PINsign.Util.toReadableIssuerSubject(n.issuer.issuerSubject);return m(".pinsign-item-profile",t).text(a),m(".pinsign-item-issuer",t).text(c),PINsign.Util.isConnectedStoreType(n.storeType)&&m(".pinsign-item-icon",t).addClass("pinsign-icon-connected-type").removeClass("pinsign-icon-pinsign-type"),n.lastUsed!==undefined&&!0===n.lastUsed&&m(".pinsign-item-info-name",t).addClass("pinsign-select-item-last-used"),t.show(),t}},v=function(){PINsignUI;var a=m.extend(h.create(I),{_selector:"#pinsign-select-dialog"}),c={};function t(n){n.data("visible",!n.data("visible")),!0===PINsign.Util.isMobile()&&m(".pinsign-item-date",n.parent()).fadeToggle(),m(".pinsign-item-delete , .pinsign-item-change-pin, .pinsign-item-list ",n).each(function(n,i){m(i).toggleClass("pinsign-hide")})}function o(){var n=a._$(),s=m(".pinsign-select-contents",n);s.empty(),PINsign.list(a._options.filter).then(function(n){!0===PINsignUI.isDummyTest()&&(n=PINsignUI.getDummyData().data),0!==n.length&&(m.each(n,function(n,i){var e=P.createItem(i),t="click",o="mouseleave";m(".pinsign-item-menu-container",e).unbind(o).on(o,function(n){c.menuHandler.onMenuMouseleave(n,this,a)}),e.unbind(t).on(t,function(n){c.menuHandler.onClickItem(i,n,this,a)}),m(".pinsign-item-menu",e).unbind(t).on(t,function(n){c.menuHandler.onClickMenu(n,this,a)}),m(".pinsign-item-delete",e).unbind(t).on(t,function(n){c.menuHandler.onClickDelete(i,n,this,a)}),m(".pinsign-item-change-pin",e).unbind(t).on(t,function(n){c.menuHandler.onClickChangePin(i,n,this,a)}),m(".pinsign-item-list",e).unbind(t).on(t,function(n){c.menuHandler.onClickList(i,n,this,a)}),(!1===PINsign.ConnAdapter.getCurrentStatus()||PINsign.Util.isConnectedStoreType(i.storeType))&&m(".pinsign-item-connected",e).removeClass("pinsign-icon-connected").addClass("pinsign-icon-connected-disable"),m(".pinsign-item-connected",e).unbind(t).on(t,function(n){c.menuHandler.onClickConnected(i,n,this,a)}),s.append(e)}),a.v_SetResource())})}return c.onClickClose=function(n){n.hideDialog()},c.menuHandler={},c.menuHandler.onClickChangePin=function(i,n,e,t){n.stopPropagation(),D.showDialog(function(n){n.code!==PINsign.ErrorCode.CANCEL&&PINsign.changePin(i.id,n.oldPin,n.newPin,function(n){n.error!==undefined?w2uiAlert("오류",n.error.message):w2uiAlert("정보","PIN이 변경되었습니다.")})})},c.menuHandler.onClickList=function(i,n,e,t){if(n.stopPropagation(),PINsign.Util.isConnectedStoreType(i.storeType))w2uiAlert("정보","커넥티드 인증서는 발급 현황을 확인할수 없습니다.");else new Promise(function(i,n){w.showDialog("발급 목록확인을위해 PIN을 입력하세요.",{},function(n){i(n)})}).then(function(n){return new Promise(function(e,t){PINsign.issueList(i.id,n,function(n){if(PINsign.ValueUtil.isValidValue(n.error)){var i=n.error;w2uiAlert("오류",PINsignMsg.getServerErrorMsg(i),function(){t(!1)})}else e(n.data)})})}).then(function(e){return new Promise(function(i,n){y.showDialog(e.berryList,{},function(n){i(n)})})}).then(function(n){return new Promise(function(i,n){PINsign.list(a._options.filter||{},function(n){i(n.data)})})}).then(function(n){0===n.length?(t._complete_cb(I.getOkResult()),t.hideDialog()):o()})["catch"](function(){})},c.menuHandler.onClickConnected=function(i,n,e,t){n.stopPropagation(),!1!==PINsign.ConnAdapter.isRegistered()?!1!==PINsign.ConnAdapter.getCurrentStatus()?PINsign.Util.isConnectedStoreType(i.storeType)||w.showDialog("커넥티드에 업로드 하기위해 PIN을 입력하세요.",{},function(n){PINsign.ConnAdapter.uploadBerry(i.id,n).then(function(n){PINsign.Logger.log("Connected Upload Complete : ",n),t.updateList()})}):w2uiAlert("정보","커넥티드 OFF 상태입니다.."):w2uiAlert("정보","커넥티드에 등록후 사용할수 있습니다.")},c.menuHandler.onClickMenu=function(n,i,e){n.stopPropagation(),t(m(i).parent())},c.menuHandler.onMenuMouseleave=function(n,i,e){n.stopPropagation(),m(i).data("visible")&&t(m(i))},c.menuHandler.onClickDelete=function(n,i,e,t){i.stopPropagation();var o=m(e).parent().parent().parent();!0===confirm(n.subject+"를 삭제 하시겠습니까?")&&(PINsign.Util.isConnectedStoreType(n.storeType)?PINsign.ConnAdapter.remove(n.fingerprint).then(function(n){PINsign.Logger.log("Connected remove Complete : ",n),o.hide("fast",function(){o.remove()})}):PINsign.remove(n.id,function(n){o.hide("fast",function(){o.remove()})}))},c.onClickIssue=function(n){n._complete_cb(n.getIssueResult()),n._w2popup.close()},c.menuHandler.onClickItem=function(n,i,e,t){t._complete_cb({data:{id:n.id,type:n.storeType}}),t._w2popup.close()},a.updateList=function(){o()},a.v_Init=function(n,i){this._options=m.extend(this._options,n),this._complete_cb=i},a.v_AfterOpen=function(){o()},a.v_InitEvent=function(){var n=a._$(),i=m(".pinsign-select-action-go-issue",n),e=m(".pinsign-close-button",n);m(".w2ui-msg-close",n).unbind("click").on("click",function(n){c.onClickClose(a)}),e.unbind("click").on("click",function(n){c.onClickClose(a)}),i.unbind("click").on("click",function(n){c.onClickIssue(a)})},a.v_AfterClose=function(n){a._complete_cb(n)},a.v_SetResource=function(){a.updateTextResource(".pinsign-item-date-title","msg.issue_date"),a.updateTextResource(".pinsign-common-message","msg.select_user"),a.updateTextResource(".pinsign-select-action-go-issue","msg.issue_new_pinsign"),a.updateAttrResource(".pinsign-item-menu","msg.show_more","title"),a.updateAttrResource(".pinsign-item-delete","msg.delete","title"),a.updateAttrResource(".pinsign-item-change-pin","msg.change_pin","title"),a.updateAttrResource(".pinsign-item-list","msg.issue_status","title")},a.update=function(){o(this._w2popup$)},a}(),b=function(){var c=m.extend(h.create(I),{_selector:"#pinsign-login-dialog",_pinpad:undefined,_options:{}}),a={};function r(n){var i=c._$();0<n?(m(".pinsign-login-body",i).show(),m(".pinsign-suggest-body",i).hide(),m(".pinsign-action-ok",i).unbind("click").on("click",function(n){a.onClickOk(c)}),c.updateTextResource(".pinsign-action-ok","msg.ok")):(m(".pinsign-login-body",i).hide(),m(".pinsign-suggest-body",i).show(),m(".pinsign-action-ok",i).unbind("click").on("click",function(n){a.onClickIssue(c)}),c.updateTextResource(".pinsign-action-ok","msg.issue_pinsign")),m(".pinsign-body",i).show()}function l(){var n=c._w2popup$;!1!==PINsign.ConnAdapter.check()&&!0===PINsignConfig.USE_CONNECTED&&m(".pinsign-connected-onoff-container",n).css("visibility","visible"),m("#pinsign-connected-onff",n).prop("checked",!0===PINsign.ConnAdapter.getCurrentStatus()?"checked":"")}function o(s,t){s=s||{},PINsign.list(c._options.filter||{}).then(function(n){l();try{!0===PINsignUI.isDummyTest()&&(n=PINsignUI.getDummyData().data)}catch(e){}var i=n;if(r(i.length),i.length<=0)t(0);else{var o=null;h.each(i,function(n,i,e){var t=PINsign.Util.getLastUsedPINsignInfo();s.id===n.id&&s.type===n.storeType?o=n:null===o&&t.id===n.id&&t.type===n.storeType&&(o=n)}),null==o&&(o=i[0]),function a(n){if(n!==undefined){var i=c._$(),e=PINsign.Util.timestampToString(n.issueDate),t=n.issuer.profile||"0",o=PINsign.Util.toReadableProfileName(t),s=PINsign.Util.toReadableIssuerSubject(n.issuer.issuerSubject);m(".pinsign-item-profile",i).text(o),m(".pinsign-item-issuer",i).text(s),m(".pinsign-item-info-name",i).data("pinsign-id",n.id),m(".pinsign-item-info-name",i).data("pinsign-storeType",n.storeType),m(".pinsign-item-info-name",i).text(n.issuer.subject),m(".pinsign-item-info-name",i).attr("title",n.issuer.subject),m(".pinsign-item-info-detail",i).text(n.subject),m(".pinsign-item-info-detail",i).attr("title",n.subject),m(".pinsign-item-date-issue",i).text(e),PINsign.Util.isConnectedStoreType(n.storeType)?m(".pinsign-item-icon",i).addClass("pinsign-icon-connected-type").removeClass("pinsign-icon-pinsign-type"):m(".pinsign-item-icon",i).removeClass("pinsign-icon-connected-type").addClass("pinsign-icon-pinsign-type")}}(o),t!==undefined&&t(i.length)}})["catch"](function(n){function i(){t(0)}n.error!==undefined?w2uiAlert("오류",n.error.message,i):n.message!==undefined?w2uiAlert("오류",n.message,i):w2uiAlert("오류",JSON.stringify(n),i)})}return a.onClickMore=function(i){PINsignUI.PINPad.hidePINPad(),i._w2popup!==undefined&&(i._w2popup.close(),i._w2popup=undefined),v.showDialog({filter:i._options.filter||{}},function(n){n.error===undefined?b.showDialog(n.data):i._complete_cb(n)})},a.onClickPINInput=function(n){var i=n._$();m(".pinsign-connected-onoff-container",i).hide(),m(".pinsign-item-container",i).addClass("pinsign-item-container-small-mode"),m(".pinsign-body",i).removeClass("pinsign-body-pulldown"),m(".pinpad-container-fake",i).hide(),m(".pinpad-container",i).fadeIn(400)},a.onClickClose=function(n){n._complete_cb(I.getCancelResult.call(n)),n.hideDialog()},a.onClickConnected=function(n,i,e){var t=m(e).prop("checked");PINsign.ConnAdapter.setCurrentStatus(!0),!0===t?!1===PINsign.ConnAdapter.isRegistered()?N.showDialog({},function(n){0!==(n=n||{code:1}).code&&(PINsign.ConnAdapter.setCurrentStatus(!1),PINsign.Logger.log("start connected cancel")),o(c._options.selectedPINsignInfo,function(n){}),l(),r()}):o(c._options.selectedPINsignInfo,function(n){}):(n.preventDefault(),n.stopPropagation(),w2uiConfirm("알림","커넥티드 사용을 중지 하시겠습니까?",function(n){!1===n?m(e).prop("checked",!0):(m(e).prop("checked",!1),PINsign.ConnAdapter.setCurrentStatus(!1),PINsign.ConnAdapter.unRegister(),o(c._options.selectedPINsignInfo,function(n){})),l()}))},a.onClickIssue=function(n){n._complete_cb(n.getIssueResult()),n._w2popup.close()},a.onClickOk=function(i,n){var e=m(".pinsign-item-info-name",i._$()).data("pinsign-id"),t=m(".pinsign-item-info-name",i._$()).data("pinsign-storeType");if(n===undefined&&(n=i._pinpad.getSecurePIN()),null!==n&&0!==n.getLength()){PINsignProgressStart(),c._options.signActionType=c._options.signActionType||"login";var o=null;PINsign.Util.isConnectedStoreType(t)?(o=PINsign.ConnAdapter.login,"sign"===c._options.signActionType?(o=PINsign.ConnAdapter.sign,PINsign.Logger.log("connected sign")):PINsign.Logger.log("connected login")):(o=PINsign.login,"sign"===c._options.signActionType?(o=PINsign.sign,PINsign.Logger.log("pinsign sign")):PINsign.Logger.log("pinsign login")),o(e,n,i.getTbsData(),function(n){i._pinpad.clearData(),!1!==i._complete_cb(n)&&i.hideDialog(),PINsignProgressFinish()},i.getSignOptions())}else w2uiAlert("정보","PIN을 입력하세요")},c.getTbsData=function(){return this._tbsData},c.getSignOptions=function(){return this._signOptions||{}},c.v_SetResource=function(){c.updateTextResource(".pinsign-item-date-title","msg.issue_date"),c.updateTextResource(".pinsign-color-text-placeholder","msg.input_pin_number"),c.updateTextResource(".pinsign-connected-onoff-text","msg.connected"),c.updateTextResource(".pinsign-action-ok","msg.ok"),c.updateTextResource(".pinpad-mask-label","msg.pin_number")},c.v_InitEvent=function(){PINsign.Logger.log("LoginDialog v_InitEvent");var n=c._w2popup$,i=m(".pinsign-action-ok",n),e=m(".pinsign-close-button",n),t=m(".w2ui-msg-close",n),o=m(".pinsign-item-more",n),s=m(".pinpad-container-fake",n);t.unbind("click").on("click",function(n){a.onClickClose(c)}),e.unbind("click").on("click",function(n){a.onClickClose(c)}),i.unbind("click").on("click",function(n){a.onClickOk(c)}),s.unbind("click").on("click",function(n){a.onClickPINInput(c)}),o.unbind("click").on("click",function(n){a.onClickMore(c)}),m("#pinsign-connected-onff").unbind("click").on("click",function(n){a.onClickConnected(n,c,this)}),l()},c.v_InitPINPad=function(){PINsign.Logger.log("LoginDialog v_InitPINPad");c._pinpad===undefined&&(c._pinpad=new PINsignUI.MaskInputEmbed);var n={disableClose:!1,defaultVisible:!1};c._options.deleteOneAtOnce!==undefined&&(n.deleteOneAtOnce=c._options.deleteOneAtOnce),c._pinpad.init(c._selector+" .pinpad-mask-target",c._selector+" .pinpad-input-embed-target",function(n){a.onClickOk(c,n)},n)},c.v_Init=function(n,i,e,t){PINsign.Logger.log("login dialog v_init");var o={id:"",type:""};1===arguments.length&&(o=arguments[0],n=undefined),this._tbsData=n||this._tbsData,this._signOptions=i||this._signOptions,this._options=m.extend(this._options,e),this._options.selectedPINsignInfo=o,this._complete_cb=t||this._complete_cb},c.v_GetPopupOptions=function(n){return PINsign.Logger.log("LoginDialog v_getPopupOptions"),n.title="",n.width=540,n.height=405,n},c.v_AfterOpen=function(){PINsign.Logger.log("LoginDialog v_AfterOpen"),o(c._options.selectedPINsignInfo,function(n){m("#pinsign-login-dialog",c._$()).removeClass("pinsign-hide")})},c.v_AfterClose=function(){PINsignUI.PINPad.hidePINPad()},c}(),k=(t=m.extend(h.create(I),{_selector:"#pinsign-confirm-dialog",_complete_cb:function(){}}),o={onClickCancel:function(n){n._complete_cb({code:1}),n.hideDialog()},onClickOk:function(n){n._complete_cb({code:0}),n.hideDialog()}},t.v_Init=function(n,i){this._message=n,this._complete_cb=i},t.v_AfterOpen=function(){},t.v_InitEvent=function(){var n=t._$();m(".pinsign-confirm-contents",n).text(t._message);var i=m(".pinsign-close-button",n);m(".w2ui-msg-close",n).unbind("click").on("click",function(n){o.onClickCancel(t)}),i.unbind("click").on("click",function(n){o.onClickCancel(t)}),m(".pinsign-action-yes",n).on("click",function(n){o.onClickOk(t)}),m(".pinsign-action-no",n).on("click",function(n){o.onClickCancel(t)})},t.v_AfterClose=function(n){t._complete_cb(n)},t),N=(a=m.extend(h.create(I),{_selector:"#start-connected-dialog",_complete_cb:function(){}}),s={onClickClose:function(n){n._complete_cb({code:1}),n.hideDialog()},onClickConnect:function(i){var n=m('input[name="name"]').val(),e=m('input[name="phone"]').val();if(""!==n)if(""!==e){var t=m("#pinsign-connected-check-agreement",i._$()).prop("checked"),o=m("#pinsign-connected-check-privacy",i._$()).prop("checked");if(!0===t)if(!0===o){var s=m("#pinsign-connected-check-remember",i._$()).prop("checked");PINsign.ConnAdapter.registerRequest(e,n,s,function(n){PINsign.Logger.log(n),i._authData={confirmCode:n},i.switchPage(1)}).then(function(n){return 0===n.code||Promise.reject(n)}).then(function(){return PINsign.ConnAdapter.connectedLogin()}).then(function(n){return!0===s&&PINsign.ConnAdapter.setRemember(),a.switchPage(2),!0})["catch"](function(n){w2uiAlert("오류",JSON.stringify(n),function(){i.hideDialog(I.getCancelResult())})})}else w2uiAlert("경고","개인정보 보호정책에 동의해야 합니다.");else w2uiAlert("경고","이용 약관에 동의해야 합니다.")}else w2uiAlert("경고","전화번호를 입력하세요.");else w2uiAlert("경고","이름을 입력하세요.")},onClickSMSAuth:function(n){w2uiAlert("정보","sms auth")},onClickAgreement:function(n,i){PINsign.Logger.log("agreement : "+m(i).prop("checked"))},onClickRemember:function(n,i){PINsign.Logger.log("remember : "+m(i).prop("checked"))},onClickAuthCodeCancel:function(n,i){n.hideDialog(I.getCancelResult())},onClickCompleteOk:function(n,i){n.hideDialog(I.getOkResult())}},a.v_Init=function(n,i){PINsign.Logger.log("StartConnected v_Init"),this._complete_cb=i,this._options=m.extend(this._options,n)},a.v_InitData=function(){PINsign.Logger.log("StartConnected v_InitData"),this.initPage()},a.v_GetPopupOptions=function(n){return PINsign.Logger.log("StartConnected v_GetPopupOptions"),n.embed=!0,n.height+=20,n},a.v_InitEvent=function(){PINsign.Logger.log("StartConnected v_InitEvent");var i=a._$(),n=m(".pinsign-close-button",i);m(".w2ui-msg-close",i).unbind("click").on("click",function(n){s.onClickClose(a)}),n.unbind("click").on("click",function(n){s.onClickClose(a)}),m(".pinsign-action-connect",i).unbind("click").on("click",function(n){s.onClickConnect(a)}),m(".pinsign-action-sms-auth",i).unbind("click").on("click",function(n){s.onClickSMSAuth(a)}),m("#pinsign-connected-check-agreement",i).unbind("click").on("click",function(n){s.onClickAgreement(a,this)}),m("#pinsign-connected-check-remember",i).unbind("click").on("click",function(n){s.onClickRemember(a,this)}),m(".pinsign-action-authcode-cancel ",i).unbind("click").on("click",function(n){s.onClickAuthCodeCancel(a,this)}),m(m(".pinsign-label",i)[0]).on("click",function(n){m('input[name="name"]',i).focus()}),m(m(".pinsign-label",i)[1]).on("click",function(n){m('input[name="phone"]',i).focus()}),m(".pinsign-action-authcode-cancel",i).unbind("click").on("click",function(n){s.onClickAuthCodeCancel(a,this)}),m(".pinsign-action-connected-complete-ok",i).unbind("click").on("click",function(n){s.onClickCompleteOk(a,this)});var e=PINsign.ConnAdapter.getLastRegisterData();m('input[name="name"]').val(e.name),m('input[name="phone"]').val(e.phone)},a.v_pageChanged=function(n){var i=this._$();1===n&&m(".pinsign-authcode-authcode",i).text(this._authData.confirmCode||"-1")},a),C=function(){var c=m.extend(h.create(I),{_selector:"#pinsign-issue-dialog",_complete_cb:function(){PINsign.Logger.log("loginui complete callback is not defined")}}),r={};function l(n){return m(".pinpad-container-fake1",n||c._$())}function d(n){return m(".pinpad-container-fake2",n||c._$())}function t(n){return m(".pinpad-container",n||c._$())}function u(n){return m(".pinpad-mask-container1",n||c._$())}function p(n){return m(".pinpad-mask-container2",n||c._$())}return r.onCancelClose=function(n){n._complete_cb(I.getCancelResult.call(n)),n.hideDialog()},r.onClickPin=function(n,i){var e=i._$();l().fadeOut(0),d().fadeOut(0),t().fadeIn(400),u().show(400),!1===i.data.existSeed&&(p().show(400),m(".pinsign-h-line",e).show()),m(".pinsign-issue-info-container",e).addClass("pinsign-issue-info-container-scale-down"),m(".pinsign-common-message",e).addClass("pinsign-common-message-pullup"),m(".pinsign-issue-action-container",e).addClass("pinsign-issue-action-container-pulldown"),this.onClickMask(n,i)},r.onClickMask=function(n,i){var e=".pinsign-pinpad-mask-container",t="pinsign-scale-down";0===n?(m(e,u()).removeClass(t),m(e,p()).addClass(t),c._mask_input1.attach()):(m(e,u()).addClass(t),m(e,p()).removeClass(t),c._mask_input2.attach())},r.onClickIssue=function(i){var n=function o(){var n=c._$(),i=c._mask_input1.getSecurePIN(),e=null;!1===c.data.existSeed&&(e=c._mask_input2.getSecurePIN());var t=m('input[name="berry-name"]',n).val();if(""===t)return w2uiAlert("정보","PINsign이름을 입력하세요"),{code:-1};if(null===i||0===i.getLength())return w2uiAlert("정보","PIN을 입력하세요."),{code:-1};if(null!==e&&0===e.getLength())return w2uiAlert("정보","PIN을 입력하세요."),{code:-1};if(null!==e&&!0!==i.isEqualPIN(e))return w2uiAlert("정보","PIN이 동일하지 않습니다."),{code:-1};if(null!==e&&!1===PINsign.Util.checkPinValidity(i))return w2uiAlert("경고","동일한 숫자가 3자리 이상 되거나, 연속된 숫자가 3자리 이상되는 PIN은 사용할수 없습니다."),{code:-1};c.data.berryPrefix.join("-");return"-",m('input[name="berry-name"]',n).val(),{code:0,berryName:t,securePin:i,existSeed:c.data.existSeed||!1,refValue:c.data.refValue,authCode:c.data.authCode}}();0===n.code&&PINsign.issue(n.berryName,n.refValue,n.authCode,n.existSeed,n.securePin,function(n){i._mask_input1.clearData(),i._mask_input2!==undefined&&i._mask_input2.clearData(),PINsign.ValueUtil.isValidValue(n.error)?w2uiAlert("오류",PINsignMsg.getServerErrorMsg(n.error,function(n){try{return n.pinRetryCount<=3}catch(i){}return!1})):(r.onClickPin(0,i),!1!==c._complete_cb(n)&&i.hideDialog())})},c.v_InitEvent=function(){var n=c._$(),i=m(".pinsign-action-cancel",n),e=m(".pinsign-close-button",n),t=l(),o=d(),s=m(".pinpad-mask-target",u()),a=m(".pinpad-mask-target",p());e.unbind("click").on("click",function(n){r.onCancelClose(c)}),i.unbind("click").on("click",function(n){r.onCancelClose(c)}),t.unbind("click").on("click",function(n){r.onClickPin(0,c)}),o.unbind("click").on("click",function(n){r.onClickPin(1,c)}),s.unbind("click").on("click",function(n){r.onClickMask(0,c)}),a.unbind("click").on("click",function(n){r.onClickMask(1,c)}),m(".pinsign-action-issue",n).unbind("click").click(function(n){r.onClickIssue(c)})},c.v_InitPINPad=function(){c._mask_input2===undefined&&(c._mask_input2=new PINsignUI.MaskInputEmbed),c._mask_input1===undefined&&(c._mask_input1=new PINsignUI.MaskInputEmbed),c._pinpad=new PINsignUI.PINPadEmbedded;var n={disableClose:!1,defaultVisible:!1,allowGetPIN:!0,injectPINPad:c._pinpad};c._mask_input1.init(c._selector+" .pinpad-mask-target1",c._selector+" .pinpad-input-embed-target",function(n){c.data.existSeed!==undefined&&!1===c.data.existSeed&&r.onClickPin(1,c)},n),c._mask_input2.init(c._selector+" .pinpad-mask-target2",c._selector+" .pinpad-input-embed-target",function(n){},n)},c.v_InitData=function(){PINsign.Logger.log("IssueDialog v_InitData"),m(".pinsign-issue-info-prefix",c._$()).each(function(n,i){try{var e=c.data.berryPrefix[n]||"";m(i).text(e)}catch(t){PINsign.Logger.log("not enought berryPrefix")}}),m(".pinsign-issue-info-name input",c._$()).val(c.data.berryName)},c.v_InitState=function(){PINsign.Logger.log("IssueDialog v_InitState");var n=c._$();!0===c.data.existSeed?(d(n).css("display","none"),m(".pinsign-issue-action-container",n).removeClass("pinsign-issue-action-container-pulldown"),m(".pinsign-common-message",n).text("PIN번호를 입력하세요")):(m(".pinsign-issue-action-container",n).addClass("pinsign-issue-action-container-pulldown"),d(n).css("display","")),t(n).css("display","none"),p(n).css("display","none")},c.v_Init=function(n,i,e){PINsign.Logger.log("IssueDialog v_Init"),c._options=m.extend(this._options,i),c._complete_cb=e||c._complete_cb,c.data=n||c.data||{existSeed:!1}},c.v_GetPopupOptions=function(n){return!1===c.data.existSeed&&(n.height+=40),n},c.v_SetResource=function(){c.updateTextResource(".pinpad-mask-label","msg.pin_number"),!0===c.data.existSeed?(c.updateTextResource(".pinsign-common-message","msg.input_pin_please"),c.updateTextResource(".pinsign-action-issue","msg.issue_add")):(c.updateTextResource(".pinsign-common-message","msg.input_6_length_new_pin"),c.updateTextResource(".pinsign-action-issue","msg.issue_new"))},c}(),w=(c=m.extend(h.create(I),{_selector:"#pinsign-input-pin-dialog",_complete_cb:function(){PINsign.Logger.log("loginui complete callback is not defined")}}),r={onClickClose:function(n){n.hideDialog()},onClickOk:function(n){n._complete_cb(n._pinpad.getSecurePIN()),n.hideDialog()}},c.v_InitData=function(){PINsign.ValueUtil.isEmptyString(c._data)||m(".pinsign-common-message",c._$()).text(c._data)},c.v_InitEvent=function(){var n=c._$(),i=m(".pinsign-close-button",n);m(".w2ui-msg-close",n).unbind("click").on("click",function(n){r.onClickClose(c)}),i.unbind("click").on("click",function(n){r.onClickClose(c)})},c.v_InitPINPad=function(){c._pinpad===undefined&&(c._pinpad=new PINsignUI.MaskInputEmbed);var n={disableClose:!1,defaultVisible:!1};c._options.deleteOneAtOnce!==undefined&&(n.deleteOneAtOnce=c._options.deleteOneAtOnce),c._pinpad.init(c._selector+" .pinpad-mask-target",c._selector+" .pinpad-input-embed-target",function(n){r.onClickOk(c,n)},n)},c.v_InitEvent=function(){var n=c._$(),i=m(".pinsign-close-button",n);m(".w2ui-msg-close",n).unbind("click").on("click",function(n){r.onClickClose(c)}),i.unbind("click").on("click",function(n){r.onClickClose(c)})},c.v_Init=function(n,i,e){PINsign.Logger.log("InputPINDialog v_Init"),c._options=m.extend(this._options,i),c._data=n||{},c._complete_cb=e||c._complete_cb},c.v_GetPopupOptions=function(n){return n.width=500,n.height=280,n},c),D=(l=m.extend(h.create(I),{_selector:"#pinsign-change-pin-dialog",_complete_cb:function(){PINsign.Logger.log("loginui complete callback is not defined")}}),d={onClickClose:function(n,i){n.stopPropagation(),l._complete_cb({code:PINsign.ErrorCode.CANCEL}),i.hideDialog()},onClickOk:function(n,i){n.stopPropagation();var e=l._mask_input1.getSecurePIN();if(null===e||0===e.getLength())return l._mask_input1.attach(),void w2uiAlert("정보","현재의 PIN을 입력하세요");var t=l._mask_input2.getSecurePIN(),o=l._mask_input3.getSecurePIN();if(null===t||null===o||0===t.getLength()||0===o.getLength()||!0!==t.isEqualPIN(o))return w2uiAlert("정보","새로운 PIN이 동일하지 않습니다."),void l._mask_input2.attach();l._complete_cb({code:PINsign.ErrorCode.SUCCESS,oldPin:e,newPin:t}),i.hideDialog()},onClickMask:function(n,i){var t=".pinsign-pinpad-mask-container",o="pinsign-scale-down";h.each([1,2,3],function(n,i,e){m(".pinpad-mask-container"+n+" "+t,l._$()).addClass(o)}),[l._mask_input1,l._mask_input2,l._mask_input3][n].attach(),m(".pinpad-mask-container"+(n+1)+" "+t,l._$()).removeClass(o),m(".pinsign-h-line",l._$()).show()}},l.v_InitEvent=function(){I.connectDefaultCloseEvent.call(l,d.onClickClose);var n=l._$();m(".pinpad-mask-container1 .pinpad-mask-target",n).unbind("click").on("click",function(n){d.onClickMask(0,l)}),m(".pinpad-mask-container2 .pinpad-mask-target",n).unbind("click").on("click",function(n){d.onClickMask(1,l)}),m(".pinpad-mask-container3 .pinpad-mask-target",n).unbind("click").on("click",function(n){d.onClickMask(2,l)}),m(".pinsign-action-ok",n).unbind("click").on("click",function(n){d.onClickOk(n,l)})},l.v_GetPopupOptions=function(n){return n.width=500,n},l.v_Init=function(n){PINsign.Logger.log("ChangePINDialog v_Init"),l._complete_cb=n||l._complete_cb},l.v_InitPINPad=function(){function n(n){var i=l;return function(){d.onClickMask(n,i)}}l._mask_input1=new PINsignUI.MaskInputEmbed,l._mask_input2=new PINsignUI.MaskInputEmbed,l._mask_input3=new PINsignUI.MaskInputEmbed,l._pinpad=new PINsignUI.PINPadEmbedded;var i={disableClose:!1,defaultVisible:!1,allowGetPIN:!0,injectPINPad:l._pinpad};l._mask_input1.init(l._selector+" .pinpad-mask-target1",l._selector+" .pinpad-input-embed-target",n(1),i),l._mask_input2.init(l._selector+" .pinpad-mask-target2",l._selector+" .pinpad-input-embed-target",n(2),i),l._mask_input3.init(l._selector+" .pinpad-mask-target3",l._selector+" .pinpad-input-embed-target",function(){},i),d.onClickMask(0,l)},l),y=(u=m.extend(h.create(I),{_selector:"#pinsign-issue-list-dialog",_complete_cb:function(){PINsign.Logger.log("loginui complete callback is not defined")}}),p={onClickClose:function(n){n._complete_cb(I.getCancelResult.call(n)),n.hideDialog()},onClickRevoke:function(n,i,e,t){i.stopPropagation();var o=m(e).parent().parent(),s=n.info;!0===confirm(s.subject+"를 폐기 하시겠습니까?")&&PINsign.revokeBerry(n.berry,function(n){PINsign.ValueUtil.isValidValue(n.error)?w2uiAlert("오류",n.error.message):o.hide("fast",function(){o.remove(),0===m(".pinsign-issue-list-item-container",t._$()).length&&(t._complete_cb(I.getOkResult()),t.hideDialog())})})}},u.v_InitEvent=function(){var n=u._$(),i=m(".pinsign-close-button",n);m(".w2ui-msg-close",n).unbind("click").on("click",function(n){p.onClickClose(u)}),i.unbind("click").on("click",function(n){p.onClickClose(u)})},u.v_Init=function(n,i,e){PINsign.Logger.log("IssueListDialog v_Init"),u._options=m.extend(this._options,i),u._data=n||{},u._complete_cb=e||u._complete_cb},u.v_InitData=function(){var n=u._$(),s=m(".pinsign-issue-list-item-template > .pinsign-issue-list-item-container"),a=m(".pinsign-issue-list-contents",n);h.each(u._data,function(i,n,e){var t=PINsign.Util.jwsToBerryInfo(i);if(null!=t){var o=P.createItem(t,s);m(".pinsign-item-delete",o).unbind("click").on("click",function(n){p.onClickRevoke({berry:i,info:t},n,this,u)}),a.append(o)}})},u.v_GetPopupOptions=function(n){return n},u),x=(g=m.extend(h.create(I),{_selector:"#pinsign-authcode-dialog",_complete_cb:function(){PINsign.Logger.log("loginui complete callback is not defined")}}),f={onClickClose:function(n,i){n.stopPropagation(),i.hideDialog(I.getCancelResult())},onClickCancel:function(n,i){n.stopPropagation(),i.hideDialog(I.getCancelResult())}},g.v_InitEvent=function(){var n=g._$(),i=m(".pinsign-close-button",n);m(".w2ui-msg-close",n).unbind("click").on("click",function(n){f.onClickClose(n,g)}),i.unbind("click").on("click",function(n){f.onClickClose(n,g)}),m(".pinsign-action-button",n).unbind("click").on("click",function(n){f.onClickCancel(n,g)})},g.v_Init=function(n,i,e){PINsign.Logger.log("IssueListDialog v_Init"),g._options=m.extend(this._options,i),g._authData=n||{},g._complete_cb=e||g._complete_cb},g.v_InitData=function(){var n=g._$();m(".pinsign-authcode-authcode",n).text(this._authData)},g.v_GetPopupOptions=function(n){return n},g),U=((_=m.extend(h.create(I),{_selector:"#test-form-dialog"})).v_InitData=function(){this.initPage(),this._pages$[0].show(),m(".pinsign-common-message",this._pages[0]).on("click",function(n){m(_._pages[0]).hide(),m(_._pages[1]).fadeIn()}),m(".pinsign-common-message",this._pages[1]).on("click",function(n){m(_._pages[1]).hide(),m(_._pages[0]).fadeIn()})},_);PINsignUI.load=function(n){PINsign.loadUI(n)},n.PINsignUI.IssueDialog=C,n.PINsignUI.SelectDialog=v,n.PINsignUI.LoginDialog=b,n.PINsignUI.StartConnectedDialog=N,n.PINsignUI.InputPINDialog=w,n.PINsignUI.ChangePINDialog=D,n.PINsignUI.IssueListDialog=y,n.PINsignUI.AuthCodeDialog=x,n.PINsignUI.TestFormDialog=U,n.PINsignUI.ConfirmDialog=k}(window,jQuery,window.pinsignus||_),function(n,i){"use strict";var u,p=jQuery,e=((u={_options:{enableToggle:!0,speed:100},_container:undefined,_container$:undefined}).init=function(n,i){this._options=p.extend(this._options,i),this._container=n,this._container$=p(n);var e=this._container$;this._options.width!==undefined&&e.css({width:this._options.width}),this._options.height!==undefined&&e.css({height:this._options.height});var t=function o(){var n='<div id="id2-list-container" >    <div style="display:none;" class="id2-item-container-template">        <div class="id2-id"></div>    <div>    <div class="id2-delete">x</div>    <div class="id2-lock-icon">';return n+='<img src="'+PINsignConfig.LOCK_ICON_URL+'">',n+='</div>        </div>        <div>        <div class="id2-date-label">사용날짜</div>        <div class="id2-last-use-date"></div>        </div>        </div>        <div class="id2-selected">        </div>        <div class="id2-list">        </div>    </div>'}();e.append(p(t)),p(".id2-list",e).hide(),p(".id2-selected",e).click(function(n){n.stopPropagation(),p(".id2-list",e).slideToggle(u._options.speed)}),p(document).click(function(){p(".id2-list",e).slideUp(u._options.speed)})},u.getSelectedInfo=function(){var n={},i=p(".id2-selected .id2-id",this._container$);return n.serialNumber=i.attr("serial"),n.subject=i.attr("subject"),n.key=i.attr("id2key"),n},u.isVisible=function(){return p("#id2-list-container",this._container$).is(":visible")},u.updateList=function(l,n){this._options=p.extend(this._options,n),l=l||function(){};var d=this._container$;p(".id2-selected",d).empty(),p(".id2-list",d).empty(),ID2List(this._options,function(n){1==PINsignUI.isDummyTest()&&(n=PINsignUI.getDummyData());var i=p("#id2-list-container",d),e=u._options.width||d.outerWidth(),t=u._options.height||d.outerHeight();if(i.css("width",e+"px"),i.css("height",t+"px"),n.error||0==n.data.length)l({count:0,code:-1});else{var o=n.data;if(0<o.length){i.show(),i.css("display","inline-block");var a=PINsign.Util.getLastUsedPINsignInfo();if(o.forEach(function(n,i){var e=new Date(1e3*n.issueDate),t=e.getYear()-100+"."+(e.getMonth()+1)+"."+e.getDay(),o=p(".id2-item-container-template").clone();o.attr("class","id2-item-container"),o.attr("title",n.issuer.issuerSubject),o.show();var s=p(".id2-id",o);s.text(n.subject||n.sub),s.attr("subject",n.subject),s.attr("id2key",n.id),s.css("width",u._container$.outerWidth()-90),a.id===n.id&&"browser"===a.type&&s.attr("lastUsed","true"),s.attr("serial",n.serialNumber||n.sn),p(".id2-last-use-date",o).html(t),p(".id2-list").append(o),o.click(function(){p(".id2-selected").empty(),p(".id2-selected").append(p(this).clone()),p(".id2-list").toggle(u._options.speed)}),p(".id2-delete",o).click(function(){if(confirm(p(".id2-id",o).text()+"를 지우시겠습니까?")){var n=p(".id2-id",o).attr("id2key");PINsign.remove(n,function(){u.updateList(l)})}})}),u._options.enableToggle){var s=p(".id2-item-container-template").clone();p(s).attr("class","id2-item-container"),p(s).show();var c=p(".id2-id",s);c.text("다른 아이디 로그인"),c.attr("subject","id2-change"),c.attr("sn","id2-change"),c.css({width:"100%","float":"right","text-align":"right","margin-right":"10px"}),p(".id2-last-use-date",s).parent().hide(),p(".id2-delete",s).parent().hide(),p(".id2-list").append(s),p(s).click(function(){u._options.onUseID!=undefined&&u._options.onUseID()})}var r=null;p(".id2-item-container").each(function(n,i){""!=(p(".id2-id",i).attr("lastUsed")||"")&&(r=p(i).clone())}),null==r&&(r=p(p(".id2-item-container")[0]).clone()),p(".id2-selected").append(r)}l({count:o.length,code:0})}})},u);n.ID2UI=e,n.PINsignUI.SelectList=e}(window),function(n,i){"use strict";var d=jQuery,a={disableClose:!1,allowGetPIN:!1,defaultVisible:!1,closeOnComplete:!1,position:{fillContainer:!1,zIndex:1601}},e=function(){var n={},e=new PINsign.SecureString;return n._complete_cb=function(){PINsign.Logger.log("mask input complete callback is undefined")},n._context$=undefined,n._container="",n._options=a,n.onPINPadClose=function(){return!0!==this._options.disableClose},n.deleteLastOne=function(){e.deleteLastOne(),this._updateInputMask()},n.clearData=function(){e.clearData(),this._updateInputMask()},n.isDisableClose=function(){return!0},n.isVisible=function(){return!0},n.appendData=function(n){e.getLength()>=PINsignUI.Const.PINPAD_MAX_LENGTH||(e.appendData(n),this._updateInputMask(),e.getLength()>=PINsignUI.Const.PINPAD_MAX_LENGTH&&!0===this._options.closeOnComplete&&(this._pinpad!=undefined?this._pinpad.onClickComplete():c.onClickComplete()))},n._getPINPadMaskHtml=function(){for(var n='<div class="pinsign-pinpad-mask-container">',i=0;i<PINsignUI.Const.PINPAD_MAX_LENGTH;i++)n+='<div class="pinsign-pinpad-mask" />';return n+="</div>"},n._updateInputMask=function(){d(".pinsign-pinpad-mask",d(this._container)).each(function(n,i){n<e.getLength()?d(i).addClass("mask-number"):d(i).removeClass("mask-number")})},n.getSecurePIN=function(){return e.getSecurePIN()},n.getLength=function(){return e.getLength()},n},t=t||function(){var t=d.extend(Object.create(new e),{});function o(n){n!==undefined&&!0!==n||c.init(t._container,t,t._complete_cb),c.showPINPad(n)}return t.init=function(n,i,e){e=e||{},d.extend(this._options,e),this._container=n,this._context$=d(this._getPINPadMaskHtml()),this._complete_cb=function(){return i(t.getSecurePIN())},d(".pinsign-pinpad-mask",this._context$).css("background-image",'url("'+PINsignConfig.PINPAD_MASK_URL+'")'),d(this._container).empty(),d(this._container).append(this._context$),this._options.disableClose||this._context$.click(function(){o()}),this._options.defaultVisible?o():c.init(t._container,t,t._complete_cb)},t.isDisableClose=function(){return this._options.disableClose},t.isVisible=function(){return d(this._container).is(":visible")},t.showPINPad=function(n){o(n)},t.hidePINPad=function(){c.hidePINPad()},t},o=o||function(){var s=d.extend(Object.create(new e),{_detached:!0,_pinpad:undefined,_options:{closeOnComplete:!0,largeType:!0}});return s.detach=function(){},s.attach=function(){s._pinpad.init(s._pinpad_container_sel,s,s._complete_cb)},s._updateInputMask=function(){var e=this;d(".pinsign-pinpad-mask-large",d(this._container)).each(function(n,i){n<e.getLength()?d(i).addClass("mask-number-large"):d(i).removeClass("mask-number-large")})},s._getPINPadMaskHtml=function(){for(var n='<div class="pinsign-pinpad-mask-container pinsign-pinpad-mask-container-large">',i=0;i<PINsignUI.Const.PINPAD_MAX_LENGTH;i++)n+='<div class="pinsign-pinpad-mask pinsign-pinpad-mask-large" />';return n+="</div>"},s.init=function(n,i,e,t){t=t||{},e=e||function(){PINsign.Logger.log("default complete callback")},d.extend(this._options,t),this._container=n,this._pinpad_container_sel=i,this._context$=d(this._getPINPadMaskHtml()),this._complete_cb=function(){return e(s.getSecurePIN())},d(this._container).empty(),d(this._container).append(this._context$),function o(n){if(s._options.injectPINPad!==undefined)return s._pinpad=s._options.injectPINPad,void s._pinpad.init(s._pinpad_container_sel,s,s._complete_cb);n!==undefined&&!0!==n||(s._pinpad=new r,s._pinpad.init(s._pinpad_container_sel,s,s._complete_cb)),s._pinpad.showPINPad(n)}()},s},s=s||function(n){n=d.extend(a,{pinpadUIType:"float",pinpadContainerSel:""},n);var t=d.extend(Object.create(new e),{_detached:!1,_options:n});function o(){var n=t._context$;n.prop("readonly",!0),n.val(""),t._options.disableClose||n.unbind("click").click(function(){s()})}function s(n){n!==undefined&&!0!==n||c.init(t._container,t,t._complete_cb),c.showPINPad(!1)}return"mobile"===t._options.pinpadUIType&&t._options.pinpadContainerSel===undefined&&(t._options.pinpadUIType="float"),t.getUITypeInfo=function(){return this._options},t.setOnLengthChanged=function(n){t._onLengthChangeHandler=n},t._updateInputMask=function(){var n="**********************************";n=n.substr(0,this.getLength()),this._context$.val(n),t._onLengthChangeHandler!==undefined&&t._onLengthChangeHandler(t.getLength())},t.detach=function(n){n=!1!==n,this._container!==undefined&&this._context$!==undefined&&(PINsignUI.PINPad.getTarget()==this._container&&!0===n&&(PINsignUI.PINPad.hidePINPad(),function i(){var n=t._context$;n.unbind("touchstart mousedown"),n.prop("readonly",!1),n.val("")}()),this._detached=!0)},t.attach=function(){this._detached=!1,o(),s(!0)},t.init=function(n,i,e){return e=e||{},d.extend(this._options,e),this._container=n,this._context$=d(this._container),"password"===this._context$.attr("type").toLowerCase()&&"input"===this._context$.prop("tagName").toLowerCase()||PINsign.Logger.log("target is not input"),this._complete_cb=function(){return i(t.getSecurePIN())},this._options.defaultVisible&&s(),o(),t},t.isDisableClose=function(){return this._options.disableClose},t.isVisible=function(){return d(this._container).is(":visible")},t.showPINPad=function(n){!0!==this._detached?s(n):c.showPINPad(!1)},t.hidePINPad=function(){!0!==this._detached&&c.hidePINPad()},t},c=c||function(){var r={_numbers:[],_input_ui:undefined,_container:undefined,_container$:undefined,_selector:{body:".pinsign-pinpad-body",number:"pinsign-pinpad-number",container:"#pinsign-pinpad-container"},_options:{largeType:!1,embed:!1,embed_sel:undefined,deleteOneAtOnce:!0},_complete_cb:function(){}};function l(n){return n!==undefined&&n.pinpadUIType!==undefined&&"mobile"===n.pinpadUIType}return r.getAttached=function(){return this._container},r._$=function(){return d(this._selector.container)},r._getPINPadHtml=function(){return l(this._options)?'<div id="pinsign-pinpad-mobile-container" class=""><div class="pinsign-pinpad-body"><div class="pinsign-pinpad-number pinpad-number">-</div></div><div class="pinsign-pinpad-command-bar"><div class="pinpad-clear pinsign-pinpad-command-button pinsign-color-text-transparent">삭제</div><div class="pinpad-complete pinsign-pinpad-command-button pinsign-color-text-white pinsign-color-bg-lightblue">확인</div></div></div>':'<div id="pinsign-pinpad-container" class="pinsign-border-gray" style="display:none;">                    <div class="pinsign-pinpad-title-bar">                        <div class="pinpad-title pinsign-color-text-gray1">가상키보드</div>                        <div class="pinpad-close pinsign-color-text-gray2">닫기</div>                    </div>                    <div class="pinsign-pinpad-body">                    </div>                    <div class="pinsign-pinpad-command-bar">                        <div class="pinpad-clear pinsign-pinpad-command-button pinsign-color-link">지우기</div>                        <div class="pinpad-reset pinsign-pinpad-command-button pinsign-color-link">재배열</div>                        <div class="pinpad-complete pinsign-pinpad-command-button pinsign-color-button-default">입력완료</div>                    </div>                </div>'},r._initNumbers=function(){var n=0;for(n=0;n<10;n++)this._numbers[n]=n;for(this._numbers[10]=-1,this._numbers[11]=-1,n=0;n<100;n++){var i=Math.floor(12*Math.random()),e=Math.floor(12*Math.random());if(i!==e){var t=this._numbers[e];this._numbers[e]=this._numbers[i],this._numbers[i]=t}}},r._initNumberElement=function(n){return l(this._options)?this._initNumberElementMobile(n):this._initNumberElementFloat(n)},r._initNumberElementMobile=function(n){var i=d(this._selector.body,this._$());i.empty();for(var e=0;e<n.length;e++){var t=d("<div></div>");t.addClass(this._selector.number),-1==n[e]?t.addClass("pinpad-empty"):(t.addClass("pinpad-number"),t.text(n[e]));var o=n[e];t.bind("touchstart mousedown",function(i,e){return function(n){return n.preventDefault(),n.stopPropagation(),i.onClickNum(n,e),!1}}(this,o)),i.append(t)}},r._initNumberElementFloat=function(n){var i=d(this._selector.body,this._$());i.empty();for(var e=0;e<n.length;e++){var t=d("<div></div>");t.addClass(this._selector.number),1==this._options.largeType&&t.css("background-image",'url("'+PINsignConfig.PINPAD_NUMBER_LARGE_URL+'")'),-1==n[e]?(t.addClass("pinpad-empty"),t.css("background-position","-360px 0px")):(t.addClass("pinpad-number"),t.css("background-position",-36*n[e]+"px 0px"));var o=n[e];t.bind("touchstart mousedown",function(i,e){return function(n){return n.preventDefault(),n.stopPropagation(),i.onClickNum(n,e),!1}}(this,o)),i.append(t)}},r._initPINPad=function(){this._clearPINPad(),this._initNumbers(),this._initNumberElement(this._numbers)},r._clearPINPad=function(){this._input_ui.clearData()},r._initEvent=function(){var e=this,n=this._$();d(".pinpad-clear",n).unbind("mousedown").bind("mousedown",function(n){console.log(n);var i=r._options.deleteOneAtOnce;PINsignConfig.PINPAD_DELETE_ONE_AT_ONCE!==undefined&&(i=PINsignConfig.PINPAD_DELETE_ONE_AT_ONCE),i?e.onClickDelete():e.onClickClear()}),d(".pinpad-reset",n).unbind("mousedown").bind("mousedown",function(){e.onClickReset()}),d(".pinpad-complete",n).unbind("mousedown").bind("mousedown",function(){e.onClickComplete()}),d(".pinpad-close",n).unbind("mousedown").bind("mousedown",function(){e.onClickClose()}),e._input_ui.isDisableClose()&&d(".pinpad-close",n).css("visibility","hidden")},r._updatePosition=function(){var n=r;if(!1!==n.isVisible()){var i=n._$();if(n._input_ui.isVisible()){if(i.show(),i.css("z-index",n._options.position.zIndex),!0===n._options.position.fillContainer)return;if(!0===l(n._options))return;i.css("position","absolute");var e=d(n._container),t=e.offset(),o=e.outerWidth(),s=e.outerHeight(),a=t.left+o/2-i.outerWidth()/2;a<=0&&(a=0);var c=t.top+s;i.css("left",a+"px"),i.css("top",c+"px")}else i.hide()}},r.isVisible=function(){return this._$().is(":visible")},r.updateSelector=function(){l(this._options)&&(this._selector.container="#pinsign-pinpad-mobile-container")},r.init=function(n,i,e,t){var o=i.getUITypeInfo();if(this._options=d.extend(this._options,o,t),this.updateSelector(),this._input_ui=i,this._container=n,this._container$=d(n),this._complete_cb=e,d(this._selector.container).remove(),0==this._$().length){var s=this._getPINPadHtml();d(this._options.pinpadContainerSel).empty(),d(this._options.pinpadContainerSel).append(d(s))}this._initPINPad(),this._initEvent(),this._updatePosition(),window.removeEventListener&&window.removeEventListener("resize",r._updatePosition,!1),window.addEventListener&&window.addEventListener("resize",r._updatePosition,!1),window.detachEvent&&window.detachEvent("onresize",r._updatePosition),window.attachEvent&&window.attachEvent("onresize",r._updatePosition)},r.onClickNum=function(n,i){n.stopPropagation(),-1!==i&&this._input_ui.appendData(i)},r.onClickDelete=function(){this._input_ui.deleteLastOne()},r.onClickClear=function(){this._input_ui.clearData()},r.onClickReset=function(){this._initPINPad()},r.onClickComplete=function(){var n=this._complete_cb();n!==undefined&&!1===n||this._input_ui.isDisableClose()||r.onClickClose()},r.onClickClose=function(){!0===this._input_ui.onPINPadClose()&&this.hidePINPad()},r.hidePINPad=function(){this._$().fadeOut(100)},r.getContainer=function(){return this._container},r.getTarget=function(){return this._container},r.showPINPad=function(n){var i=this._$();!0!==i.is(":visible")&&i.fadeIn(100),!1!==n&&this._initPINPad(),this._updatePosition()},r}(),r=r||function(){var s=d.extend(Object.create(c),{_selector:{body:".pinsign-pinpad-embed-body",number:"pinsign-pinpad-embed-number",container:".pinsign-pinpad-embed-container"},_options:{largeType:!0}});return s._$=function(){return d(this._selector.container,this._container$)},s._getPINPadHtml=function(){return'<div class="pinsign-pinpad-embed-container pinsign-color-bg-pinpad-large">                <div class="pinsign-pinpad-embed-body">                </div>                <div class="pinsign-pinpad-embed-command-bar" >                <div class="pinpad-reset pinsign-pinpad-embed-command-button pinsign-color-text-gray3">재배열</div>                <div class="pinpad-clear pinsign-pinpad-embed-command-button pinsign-color-text-gray3">지우기</div>                </div>                </div>'},s.showPINPad=function(){this._initPINPad()},s.init=function(n,i,e,t){if(this._input_ui=i,this._container=n,this._container$=d(n),this._options=d.extend(this._options,t),this._complete_cb=e,0==this._$().length){var o=this._getPINPadHtml();this._container$.append(d(o))}d(".pinpad-reset",this._container$).text(PINsignResource.get("msg.pinpad_reset")),d(".pinpad-clear",this._container$).text(PINsignResource.get("msg.pinpad_clear")),this._initPINPad(),this._initEvent(),window.removeEventListener&&window.removeEventListener("resize",s._updatePosition,!1),window.addEventListener&&window.addEventListener("resize",s._updatePosition,!1),window.detachEvent&&window.detachEvent("onresize",s._updatePosition),window.attachEvent&&window.attachEvent("onresize",s._updatePosition)},s};PINsignUI.Const=PINsignUI.Const||{PINPAD_MAX_LENGTH:6},n.PINsignUI.MaskInputBase=e,n.PINsignUI.MaskInput=t,n.PINsignUI.MaskInputEmbed=o,n.PINsignUI.PasswordInput=s,n.PINsignUI.PINPad=c,n.PINsignUI.PINPadEmbedded=r}(window),function(e,n){"use strict";var a,l,t,o,d=jQuery,i={list:function(n){return PINsign.list(n||{}).then(function(n){return n})["catch"](function(n){return Promise.resolve([])})},info:function(n){return PINsign.info(n).then(function(n){return n})["catch"](function(n){return Promise.resolve({error:n})})},remove:function(n){return PINsign.remove(n).then(function(n){return n})["catch"](function(n){return Promise.resolve({error:n})})},issue:function(n,i){return PINsign.issue(n,i).then(function(n){return n})["catch"](function(n){return Promise.resolve({error:n})})},issueList:function(n,i){},revoke:function(n){}},s={iframe:undefined,iframeDiv:undefined,done:undefined,inited:!1,config:undefined,markerDiv:undefined,embedIframe:undefined,init:function(){if(!this.inited){e.addEventListener?e.addEventListener("message",this.handleMessage,!1):e.attachEvent("onmessage",this.handleMessage);var n=window;!0===PINsign.Util.isAlreadyInsideUIFrame()&&(n=top.window);var i=n.document||document;a=n.innerWidth||i.documentElement.clientWidth||i.body.clientWidth,n.innerHeight||i.documentElement.clientHeight||i.body.clientHeight,this.inited=!0}},preload:function(){return"off"!=wiz.util.cookie.get("preload")&&(this.init(),this.preloadIframe(),!0)},preloadOff:function(){document.cookie="preload=off"},insertMetaTag:function(){},removeMetaTag:function(){this.viewportTag&&(this.viewportTag.content="width="+a+", user-scalable=yes",setTimeout(function(){this.viewportTag.parentNode.removeChild(this.viewportTag),this.viewportTag=undefined}.bind(this),1))},preloadIframe:function(){this.loadIframe(),this.preloaded=!0,this.inProgress=!1},loadIframe:function(){function e(){}this.init();var n=new Promise(function(n,i){e=function(){return n()}});if(this.inProgress=!0,!this.preloaded){var i,t,o;o=PINsign.Util.isAlreadyInsideUIFrame()?top.window.document:window.document;var s=PINsignConfig.UI_SERVICE_URL;return-1!==location.search.indexOf("dummy_test")&&(s=PINsign.Util.appendQueryString(s,"dummy_test")),s=1==PINsign.Util.isMobile()?PINsign.Util.appendQueryString(s,"uiType=mobile"):PINsign.Util.appendQueryString(s,"uiType=desktop"),(t=o.createElement("iframe")).onload=e,t.src=s,t.allowtransparency=!0,t.style.position="fixed",t.style.zIndex=100010,t.style.top="0px",t.style.border="none",t.style.left="-"+a+"px",t.style.width="100%",t.style.height="100%",o.body.appendChild(t),this.iframeDiv=i||t,this.iframe=t,this.iframe.setAttribute("id","pinsign-ui-frame"),this.iframe.setAttribute("name","pinsign-ui-frame"),this.iframe.setAttribute("title","PINSign"),n}},showIframe:function(){if(!1!==this.inProgress){window;PINsign.Util.isAlreadyInsideUIFrame()&&top.window,this.iframeDiv.style.left="0px"}},hideIframe:function(){this.iframeDiv&&(this.iframeDiv.style.left="-"+a+"px",this.close())},unloadIframe:function(){this.inProgress=!1;var n=window,i=document;PINsign.Util.isAlreadyInsideUIFrame()&&(n=top.window,i=top.window.document),this.iframeDiv&&(this.preloaded?this.hideIframe():1==d(i).has(this.iframeDiv).length&&(i.body.removeChild(this.iframeDiv),this.removeMetaTag())),this.scrollBackup&&n.scroll(this.scrollBackup.X,this.scrollBackup.Y)},handleMessage:function(n){var i;try{i=JSON.parse(n.data)}catch(e){return void console.log("Message Ignored because Not Permitted data : "+n.data)}if(i.profile)i.profile;else;},postMessage:function(n,i){n.contentWindow.postMessage(i,"*")},service:function(t,o,n){this.init(),n!==undefined&&(this.done=n),(o=o||{}).config={};JSON.stringify({service:t,param:o});if(!this.inProgress||this.preloaded){"closeInIframe"!=t&&PINsignProgressStart();var i=function(n){var i=s;"closeInIframe"!=t&&i.showIframe();var e=JSON.stringify({service:t,param:o});(new Date).getTime();i.postMessage(i.iframe,e)};this.preloaded?("closeInIframe"!=t&&(this.inProgress=!0),i()):"closeInIframe"===t||(this.loadIframe(),this.iframe.onload=i)}},setConfig:function(n,i){},setProperty:function(n,i,e){"logoImage"!=n&&"delfino.logoimage"!=n&&(this.config[n]=i)},close:function(){this.service("closeInIframe",{})}},c=(l={_config:{}},t=PINsign.getRequestStore(PINsignConfig.UI_SERVICE_URL,"ui"),o=s,l.setOverrideConfig=function(n){this._config=n},l.invoke=function(n){return o.showIframe(),t.invoke(o.iframe.contentWindow,n,-1)},l.login=function(n,i,e,t){o.loadIframe().then(function(){return l.invoke({module:"UIService",cmd:"showLoginDialog",data:{tbsData:n,signOptions:i,options:e},config:l._config})}).then(function(n){(t=t||function(n){console.log(n)})(n)})},l.issue=function(n,i,e){o.loadIframe().then(function(){return l.invoke({module:"UIService",cmd:"showIssueDialog",data:{data:n,options:i},config:l._config})}).then(function(n){(e=e||function(n){console.log(n)})(n)})},l.select=function(n,i){o.loadIframe().then(function(){return l.invoke({module:"UIService",cmd:"showSelectDialog",data:{options:n},config:l._config})}).then(function(n){(i=i||function(n){console.log(n)})(n)})},l.processResult=function(n,i,e){return t.processResult(n,i,e,function(){o.hideIframe(),o.unloadIframe(),PINsignProgressFinish()})},l.messageHandler=function(n){if(""!==n.data){var t={};try{t=JSON.parse(n.data)}catch(r){return void console.log("unknown data ",n.data)}if(t.module!==undefined&&"UIService"===t.module){PINsign.Logger.log("recv message = "+n.data);var i=t.data,e=t.handle;if("result"!=t.cmd){var o,s=n.source,a=(o=s,function(n){o.postMessage(JSON.stringify({module:"UIService",handle:e,cmd:"result",data:n}),"*")});t.config!=undefined?(PINsignConfig=d.extend(PINsignConfig,t.config),PINsign.Service.reloadServiceFrame(function(){PINsign.Logger.log("reload frame : "+JSON.stringify(t.config)),c(t.cmd,i,a)})):c(t.cmd,i,a)}else l.processResult(t.handle,t.data,t.error)}}function c(n,i,e){"showLoginDialog"==t.cmd?PINsignUI.LoginDialog.showDialog(i.tbsData,i.signOptions,i.options,e):"showIssueDialog"==t.cmd?PINsignUI.IssueDialog.showDialog(i.data,i.options,e):"showSelectDialog"==t.cmd&&PINsignUI.SelectDialog.showDialog(i.options,e)}},window.addEventListener?window.addEventListener("message",l.messageHandler,!1):window.attachEvent("onmessage",l.messageHandler),l);e.PINsignUI.Service=i,e.PINsignUI.UIService=c,e.PINsignUI.ServiceFrame=s,e.PINsignUI.login=function(n,i,e,t){PINsignConfig.USE_UI_SERVICE?PINsignUI.UIService.login(n,i,e,t):PINsignUI.LoginDialog.showDialog(n,i,e,t)},e.PINsignUI.sign=function(n,i,e,t){(e=e||{}).signActionType="sign",PINsignConfig.USE_UI_SERVICE?PINsignUI.UIService.login(n,i,e,t):PINsignUI.LoginDialog.showDialog(n,i,e,t)},e.PINsignUI.select=function(n,i){PINsignConfig.USE_UI_SERVICE?PINsignUI.UIService.select(n,i):PINsignUI.SelectDialog.showDialog(n,i)},e.PINsignUI.issue=function(n,i,e){PINsignConfig.USE_UI_SERVICE?PINsignUI.UIService.issue(n,i,e):PINsignUI.IssueDialog.showDialog(n,i,e)}}(window);
 window.pinsignus = _.noConflict(); 
})();
function id2_build_version(){ return "2.3.10";}
function id2_build_date()	{ return "2020-2-17 11:16:44 AM";}